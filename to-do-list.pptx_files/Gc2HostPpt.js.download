/*! For license information please see Gc2HostPpt.js.LICENSE.txt */
var Gc2HostPpt;(()=>{"use strict";var e,t,i={2082:(e,t,i)=>{var r;i.d(t,{O:()=>r}),function(e){e[e.SmartArt=0]="SmartArt",e[e.Chart=1]="Chart",e[e.Video=2]="Video",e[e.Picture=3]="Picture"}(r||(r={}))},4016:(e,t,i)=>{var r;i.d(t,{r:()=>r}),function(e){e[e.General=0]="General",e[e.GraphicHost=1]="GraphicHost",e[e.Operation=2]="Operation"}(r||(r={}))},3331:(e,t,i)=>{var r;i.d(t,{G:()=>r}),function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Spam=4]="Spam",e[e.ShiftFactor=5]="ShiftFactor"}(r||(r={}))},3774:(e,t,i)=>{i.d(t,{J:()=>l,$:()=>a});var r=i(2661),s=i(4591);class n extends r.B{getGeometry(e){switch(e.type){case 0:const t=this.get(e.preset);if(void 0===t)throw new Error(`Unregistered geometry for type:${e.preset}`);return t;case 1:return e.custom;default:(0,s.t)(e)}}}var o=i(2489);const a=new n([]);function l(e,t){i.e(835).then(i.bind(i,5402)).then((i=>{(0,o.PN)(0,"Loaded GC2Video.js"),i.ensureSharedGeometriesRegistered(),i.setGeometry(e,t)})).catch((()=>{(0,o.H)(0,"Failed to load GC2Video.js")}))}},943:(e,t,i)=>{function r(e){if(null===e)return"";let t=e.toString().toUpperCase();return t.startsWith("{")||(t=`{${t}`),t.endsWith("}")||(t=`${t}}`),t}i.d(t,{n:()=>r})},5163:(e,t,i)=>{i.d(t,{XA:()=>a,ZT:()=>s,mG:()=>o,pi:()=>n});var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},r(e,t)};function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var n=function(){return n=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},n.apply(this,arguments)};function o(e,t,i,r){return new(i||(i=Promise))((function(s,n){function o(e){try{l(r.next(e))}catch(e){n(e)}}function a(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((r=r.apply(e,t||[])).next())}))}function a(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}Object.create,Object.create},5735:(e,t,i)=>{i.d(t,{D:()=>s});var r=i(1459);const s={p:[{s:[[0,"l","t"],[1,"r","t"],[1,"r","b"],[1,"l","b"],[5]]}],i:["l","t","r","b"],c:[[r.eh,"hc","t"],[r.PI,"l","vc"],[r._b,"hc","b"],[0,"r","vc"]],u:!0}},4874:(e,t,i)=>{i.d(t,{A:()=>r});class r{constructor(){this.extendedProperties=new Map}}},2489:(e,t,i)=>{i.d(t,{H:()=>o,KE:()=>a,MP:()=>n,PN:()=>l,WD:()=>s,_v:()=>h});let r={logOperation(e){},logTrace(e){}};function s(e){r=e}function n(e,t,i){r.logOperation({name:e,durationMs:t,props:i})}function o(e,t){r.logTrace({level:0,id:e,message:t})}function a(e,t){r.logTrace({level:1,id:e,message:t})}function l(e,t){r.logTrace({level:2,id:e,message:t})}function h(e,t){r.logTrace({level:3,id:e,message:t})}},3849:(e,t,i)=>{i.d(t,{C:()=>s,R:()=>n});let r={logVeto(){}};function s(e){r=e}function n(e,t,i){r.logVeto(e,t,i)}},6487:(e,t,i)=>{i.d(t,{LW:()=>n,Yr:()=>s});var r=i(1459);function s(e){return e*r.PI/180}function n(e){const t=e%360;return t<0?t+360:t}},1459:(e,t,i)=>{i.d(t,{AF:()=>f,KK:()=>d,PI:()=>r,W0:()=>u,_E:()=>o,_b:()=>l,av:()=>n,eh:()=>a,oP:()=>h,ql:()=>c,uo:()=>s});const r=Math.PI,s=2*Math.PI,n=s/3,o=3*Math.PI,a=1.5*Math.PI,l=Math.PI/2,h=Math.PI/3,c=Math.PI/4,d=Math.PI/6,u=Math.PI/12,f=12700},2661:(e,t,i)=>{i.d(t,{B:()=>r,o:()=>s});class r{constructor(e){this.registry=new Map(e)}register(e,t){return this.registry.set(e,t),this}get(e){return this.registry.get(e)}}class s extends r{constructor(e){super(e),this.values=new Set(e.map((e=>e[1])))}register(e,t){return super.register(e,t),this.values.add(t),this}[Symbol.iterator](){return this.values[Symbol.iterator]()}}},4814:(e,t,i)=>{i.d(t,{H:()=>a,_:()=>o});var r=i(2489),s=i(4874),n=i(3849);function o(e,t){throw(0,r.H)(e,t),new Error(`Error: ${t}`)}function a(e,t,i){const r=new s.A;throw r.extendedProperties.set("message",i),(0,n.R)(e,t,r),new Error(`Veto: ${e}, Error: ${t}`)}},4591:(e,t,i)=>{i.d(t,{t:()=>s});var r=i(4814);function s(e){(0,r._)(0,`Unreachable ${e}`)}}},r={};function s(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={exports:{}};return i[e].call(n.exports,n,n.exports,s),n.exports}s.m=i,s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,i)=>(s.f[i](e,t),t)),[])),s.u=e=>({357:"Gc2Chart",835:"Gc2Video"}[e]+".js"),s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="@gc2/host-ppt:",s.l=(i,r,n,o)=>{if(e[i])e[i].push(r);else{var a,l;if(void 0!==n)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var d=h[c];if(d.getAttribute("src")==i||d.getAttribute("data-webpack")==t+n){a=d;break}}a||(l=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,s.nc&&a.setAttribute("nonce",s.nc),a.setAttribute("data-webpack",t+n),a.src=i),e[i]=[r];var u=(t,r)=>{a.onerror=a.onload=null,clearTimeout(f);var s=e[i];if(delete e[i],a.parentNode&&a.parentNode.removeChild(a),s&&s.forEach((e=>e(r))),t)return t(r)},f=setTimeout(u.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=u.bind(null,a.onerror),a.onload=u.bind(null,a.onload),l&&document.head.appendChild(a)}},s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");i.length&&(e=i[i.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e})(),(()=>{var e={649:0};s.f.j=(t,i)=>{var r=s.o(e,t)?e[t]:void 0;if(0!==r)if(r)i.push(r[2]);else{var n=new Promise(((i,s)=>r=e[t]=[i,s]));i.push(r[2]=n);var o=s.p+s.u(t),a=new Error;s.l(o,(i=>{if(s.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var n=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",a.name="ChunkLoadError",a.type=n,a.request=o,r[1](a)}}),"chunk-"+t,t)}};var t=(t,i)=>{var r,n,[o,a,l]=i,h=0;if(o.some((t=>0!==e[t]))){for(r in a)s.o(a,r)&&(s.m[r]=a[r]);l&&l(s)}for(t&&t(i);h<o.length;h++)n=o[h],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0},i=self.webpackChunk_gc2_host_ppt=self.webpackChunk_gc2_host_ppt||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n={};(()=>{let e;function t(){return e}var i;s.r(n),s.d(n,{pptGraphicFactoryGlobal:()=>Fm}),function(e){e[e.Uninitialized=0]="Uninitialized",e[e.Started=1]="Started",e[e.Succeeded=2]="Succeeded",e[e.Failed=3]="Failed"}(i||(i={}));class r{constructor(e){this.health=e}logKpiUsage(e,t,i,r){this.health.recordKpiUsage(e,t,r,i)}logKpiFailure(e,t,i,r,s){this.health.recordKpiFailure(e,t,i,r,s)}logKpiSuccess(e,t){this.health.recordKpiSuccess(e,t)}}class o{constructor(e){this.health=e}logVeto(e,t,i){i.extendedProperties.set("internalVetoName",e),this.health.recordQosError(t,["GraphicsExperienceDegraded"],!1,!1,!1,!1,i)}}let a=()=>!1;function l(e){return a(e)}class h{constructor(e){this.initializer=e}get value(){return void 0===this.instance&&(this.instance=this.initializer()),this.instance}get valid(){return void 0!==this.instance}}class c{constructor(){this.listeners=[]}on(e){this.listeners.push(e)}off(e){const t=this.listeners.indexOf(e);-1!==t&&this.listeners.splice(t,1)}use(e){return this.on(e),()=>{this.off(e)}}emit(...e){this.listeners.forEach((t=>{t(...e)}))}}function d(){const e=()=>new c;return{pointerdown:new h(e),pointermove:new h(e),pointerup:new h(e),pointercancel:new h(e),pointerover:new h(e),pointerout:new h(e)}}var u=s(6487);class f{constructor(e,t){this.x=e,this.y=t}normalize(){const e=Math.sqrt(this.x*this.x+this.y*this.y);this.x=this.x/e,this.y=this.y/e}multiply(e){const t=this.x*e.m11+this.y*e.m21+e.m31,i=this.x*e.m12+this.y*e.m22+e.m32;this.x=t,this.y=i}add(e){return this.x+=e.x,this.y+=e.y,this}rotate(e,t=new f(0,0)){const i=(0,u.Yr)(e),r=Math.cos(i),s=Math.sin(i),n=this.x-t.x,o=this.y-t.y;this.x=n*r-o*s+t.x,this.y=n*s+o*r+t.y}transform(e){const t=new f(this.x,this.y);return t.multiply(e),t}distanceTo(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}}class p{constructor(e,t,i,r){this.left=e,this.top=t,this.right=i,this.bottom=r}width(){return this.right-this.left}height(){return this.bottom-this.top}isEmpty(){return 0===this.width()||0===this.height()}center(){return new f((this.left+this.right)/2,(this.top+this.bottom)/2)}clone(){return new p(this.left,this.top,this.right,this.bottom)}equals(e){return this.left===e.left&&this.top===e.top&&this.right===e.right&&this.bottom===e.bottom}scale(e,t){this.left*=e,this.top*=t,this.right*=e,this.bottom*=t}}class m{constructor(e=!1,t=!1){this.x=e,this.y=t}clone(){return new m(this.x,this.y)}equals(e){return this.x===e.x&&this.y===e.y}}class g{constructor(e=0,t=0){this.x=e,this.y=t}clone(){return new g(this.x,this.y)}equals(e){return this.x===e.x&&this.y===e.y}multiply(e){const t=this.x*e.m11+this.y*e.m21+e.m31,i=this.x*e.m12+this.y*e.m22+e.m32;return this.x=t,this.y=i,this}add(e){return this.x+=e.x,this.y+=e.y,this}subtract(e){return this.x-=e.x,this.y-=e.y,this}scale(e,t){return this.x*=e,this.y*=t,this}set(e){return this.x=e.x,this.y=e.y,this}}class v{constructor(e=0,t=0){this.width=e,this.height=t}clone(){return new v(this.width,this.height)}equals(e){return this.width===e.width&&this.height===e.height}subtract(e){return this.width-=e.width,this.height-=e.height,this}scale(e,t){return this.width*=e,this.height*=t,this}}class _{constructor(e=new g,t=new v,i=new m,r=0){this.pos=e,this.size=t,this.flip=i,this.rot=r}clone(){return new _(this.pos.clone(),this.size.clone(),this.flip.clone(),this.rot)}equals(e){return this.pos.equals(e.pos)&&this.size.equals(e.size)&&this.flip.equals(e.flip)&&this.rot===e.rot}getCenter(){return new f(this.pos.x+this.size.width/2,this.pos.y+this.size.height/2)}}var y=s(4814);const b=function(e){if(void 0!==window.FinalizationRegistry)return new window.FinalizationRegistry((e=>{const t=`Failed to teardown TeardownTracker ${e}`;(0,y._)(0,t)}))}();class w{constructor(e){this._tornDown=!1,this.inFinalizationRegistry=!1,this.handlers=[],this.name=e}get tornDown(){return this._tornDown}onTeardown(e){this.handlers.push(e)}teardown(){this._tornDown;for(let e=this.handlers.length-1;e>=0;e-=1)this.handlers[e]();this.inFinalizationRegistry&&void 0!==b&&(b.unregister(this),this.inFinalizationRegistry=!1),this._tornDown=!0}}var T=s(2489);class x{constructor(e){this.props=new Map,this.name=e,this.id=x.opCount,x.opCount+=1,performance.mark(this.getStartMarker())}setProp(e,t){return this.props.set(e,t.toString()),this}complete(){performance.mark(this.getEndMarker()),performance.measure(this.name,this.getStartMarker(),this.getEndMarker());const e=performance.getEntriesByName(this.name,"measure");e.length>0&&(0,T.MP)(this.name,e[e.length-1].duration,this.props.size>0?this.props:void 0),performance.clearMarks(this.getStartMarker()),performance.clearMarks(this.getEndMarker()),performance.clearMeasures(this.name)}getStartMarker(){return`${this.name}.${this.id}.Start`}getEndMarker(){return`${this.name}.${this.id}.End`}}x.opCount=0;const C=.001;class P{constructor(e,t){this.x=e,this.y=t}static Flip(e,t){return new P(e?-1:1,t?-1:1)}negate(){return new P(-this.x,-this.y)}inverse(){return new P(1/this.x,1/this.y)}normalized(){const e=this.length();return e?this.scale(1/e):void 0}abs(){return new P(Math.abs(this.x),Math.abs(this.y))}floor(){return new P(Math.floor(this.x),Math.floor(this.y))}ceil(){return new P(Math.ceil(this.x),Math.ceil(this.y))}sign(){return new P(this.x<0?-1:1,this.y<0?-1:1)}isZero(){return 0==this.x&&0==this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}static Distance(e,t){return e.subtract(t).length()}equals(e){return this.x==e.x&&this.y==e.y}equalsWithEpsilon(e,t=.001){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}add(e){return new P(this.x+e.x,this.y+e.y)}subtract(e){return new P(this.x-e.x,this.y-e.y)}multiply(e){return new P(this.x*e.x,this.y*e.y)}divide(e){return new P(this.x/e.x,this.y/e.y)}dot(e){return this.x*e.x+this.y*e.y}scale(e){return new P(this.x*e,this.y*e)}rotate(e){return e?new P(this.x*Math.cos(e)-this.y*Math.sin(e),this.x*Math.sin(e)+this.y*Math.cos(e)):this}transformVector(e){return e.transformVector(this)}transformPoint(e){return e.transformPoint(this)}static InterpolateLinear(e,t,i){return e.add(t.subtract(e).scale(i))}static InterpolateQuadratic(e,t,i,r){return P.InterpolateLinear(P.InterpolateLinear(e,t,r),P.InterpolateLinear(t,i,r),r)}static QuadraticTangent(e,t,i,r){return P.InterpolateLinear(t,i,r).subtract(P.InterpolateLinear(e,t,r)).normalized()}static CalculateLineIntersection(e,t,i,r,s=.001){const n=(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x),o=(r.y-i.y)*(t.x-e.x)-(r.x-i.x)*(t.y-e.y);if(Math.abs(o)>s)return P.InterpolateLinear(e,t,n/o)}static MeasureQuadraticLength(e,t,i){return D(e.x,e.y,t.x,t.y,i.x,i.y)}}P.Zero=new P(0,0),P.One=new P(1,1);class S{constructor(e,t,i){this.x=e,this.y=t,this.z=i}}S.Zero=new S(0,0,0),S.One=new S(1,1,1);class E{constructor(e,t,i,r,s,n,o,a,l){this.m=new Float32Array([e,t,i,r,s,n,o,a,l])}toMatrix3(){return this}isIdentity(){return this==E.Identity||this.equals(E.Identity)}multiply(e){const t=this.m,i=e.m;return new E(t[0]*i[0]+t[1]*i[3]+t[2]*i[6],t[0]*i[1]+t[1]*i[4]+t[2]*i[7],t[0]*i[2]+t[1]*i[5]+t[2]*i[8],t[3]*i[0]+t[4]*i[3]+t[5]*i[6],t[3]*i[1]+t[4]*i[4]+t[5]*i[7],t[3]*i[2]+t[4]*i[5]+t[5]*i[8],t[6]*i[0]+t[7]*i[3]+t[8]*i[6],t[6]*i[1]+t[7]*i[4]+t[8]*i[7],t[6]*i[2]+t[7]*i[5]+t[8]*i[8])}inverse(){const e=this.m,t=e[0]*e[4]-e[1]*e[3];return 0==t?void 0:new E(e[4]/t,-e[1]/t,0,-e[3]/t,e[0]/t,0,(e[3]*e[7]-e[4]*e[6])/t,(-e[0]*e[7]+e[1]*e[6])/t,1)}transformVector(e){return new P(e.x*this.m[0]+e.y*this.m[3],e.x*this.m[1]+e.y*this.m[4])}transformPoint(e){return new P(e.x*this.m[0]+e.y*this.m[3]+this.m[6],e.x*this.m[1]+e.y*this.m[4]+this.m[7])}isSimpleScaleTranslationOnly(){return 0==this.m[1]&&0==this.m[2]&&0==this.m[3]&&0==this.m[5]&&1==this.m[8]}getSimpleScale(){return new P(this.m[0],this.m[4])}getSimpleTranslation(){return new P(this.m[6],this.m[7])}equals(e){for(let t=0;t<9;t++)if(this.m[t]!=e.m[t])return!1;return!0}tryGetTransform(e){const t=this.transformVector(new P(1,0)),i=this.transformVector(new P(0,1));if(Math.abs(t.x*i.x+t.y*i.y)>C)return;const r=t.x*i.y-t.y*i.x>0?new P(t.length(),i.length()):new P(t.length(),-i.length()),s=t.y>0?Math.acos(t.x/r.x):-Math.acos(t.x/r.x),n=this.transformPoint(e.negate());return new M(e,r,s,n)}static Translation2D(e){return new E(1,0,0,0,1,0,e.x,e.y,1)}static Scale2D(e){return new E(e.x,0,0,0,e.y,0,0,0,1)}static ScaleTranslation2D(e,t){return new E(e.x,0,0,0,e.y,0,t.x,t.y,1)}static RotationZ(e){const t=Math.cos(e),i=Math.sin(e);return new E(t,i,0,-i,t,0,0,0,1)}static RotationAroundPoint(e,t){return new M(t.negate(),P.One,e,t).toMatrix3()}static FromTransforms(...e){if(0==e.length)return E.Identity;let t=e[0].toMatrix3();for(let i=1;i<e.length;i++)t=t.multiply(e[i].toMatrix3());return t}}E.Identity=new E(1,0,0,0,1,0,0,0,1);class M{constructor(e,t,i,r){this.preTranslation=e||P.Zero,this.scale=t||P.One,this.rotation=null!=i?i:0,this.translation=r||P.Zero}toMatrix3(){const e=Math.cos(this.rotation),t=Math.sin(this.rotation),i=this.scale.x*e,r=this.scale.x*t,s=this.scale.y*-t,n=this.scale.y*e;return new E(i,r,0,s,n,0,this.preTranslation.x*i+this.preTranslation.y*s+this.translation.x,this.preTranslation.y*n+this.preTranslation.x*r+this.translation.y,1)}isIdentity(){return this==M.Identity||this.equals(M.Identity)}toInverseMatrix3(){const e=Math.cos(-this.rotation),t=Math.sin(-this.rotation),i=e/this.scale.x,r=t/this.scale.y,s=-t/this.scale.x,n=e/this.scale.y;return new E(i,r,0,s,n,0,-this.translation.x*i-this.translation.y*s-this.preTranslation.x,-this.translation.y*n-this.translation.x*r-this.preTranslation.y,1)}transformVector(e){return e.multiply(this.scale).rotate(this.rotation)}transformPoint(e){return e.add(this.preTranslation).multiply(this.scale).rotate(this.rotation).add(this.translation)}applyScaleAndTranslationBefore(e,t){return new M(this.preTranslation.add(t).divide(e),this.scale.multiply(e),this.rotation,this.translation)}applyTranslationAfter(e){return new M(this.preTranslation,this.scale,this.rotation,this.translation.add(e))}equals(e){return this.preTranslation.equals(e.preTranslation)&&this.scale.equals(e.scale)&&this.rotation==e.rotation&&this.translation.equals(e.translation)}static fromScaleAndTranslation(e,t){return new M(void 0,e,void 0,t)}static fromTransformAndPretranslation(e,t){return new M(t,e.scale,e.rotation,e.translation)}static fromTransformAndScale(e,t){return new M(e.preTranslation,t,e.rotation,e.translation)}static fromTransformAndRotation(e,t){return new M(e.preTranslation,e.scale,t,e.translation)}static fromTransformAndTranslation(e,t){return new M(e.preTranslation,e.scale,e.rotation,t)}}M.Identity=new M;class R{constructor(e=0,t=0,i=0,r=0){this.left=e,this.top=t,this.right=i,this.bottom=r}static FromSize(e){return new R(0,0,e.x,e.y)}static FromSizeAndCenter(e,t){return new R(t.x-.5*e.x,t.y-.5*e.y,t.x+.5*e.x,t.y+.5*e.y)}static FromPoints(e,t){return new R(Math.min(e.x,t.x),Math.min(e.y,t.y),Math.max(e.x,t.x),Math.max(e.y,t.y))}isEmpty(){return this.left==this.right&&this.top==this.bottom}isValid(){return this.left<=this.right&&this.top<=this.bottom}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get size(){return new P(this.right-this.left,this.bottom-this.top)}get center(){return new P((this.left+this.right)/2,(this.top+this.bottom)/2)}get leftTop(){return new P(this.left,this.top)}get rightBottom(){return new P(this.right,this.bottom)}isPointInRect(e){return this.left<=e.x&&e.x<=this.right&&this.top<=e.y&&e.y<=this.bottom}equals(e){return this.left==e.left&&this.top==e.top&&this.right==e.right&&this.bottom==e.bottom}inflate(e){return new R(this.left-e,this.top-e,this.right+e,this.bottom+e)}inflateToInteger(){return new R(Math.floor(this.left),Math.floor(this.top),Math.ceil(this.right),Math.ceil(this.bottom))}multiply(e){return R.FromPoints(this.leftTop.multiply(e),this.rightBottom.multiply(e))}divide(e){return R.FromPoints(this.leftTop.divide(e),this.rightBottom.divide(e))}translate(e){return new R(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}transformedBounds(e){let t,i=[new P(this.left,this.top),new P(this.right,this.top),new P(this.right,this.bottom),new P(this.left,this.bottom)];for(let r=0;r<4;r++)t=R.UnionPoint(t,i[r].transformPoint(e));return t}relativeToAbsolute(e){return new P(k(this.left,this.right,e.x),k(this.top,this.bottom,e.y))}static UnionPoint(e,t){return e&&e.isValid()?new R(Math.min(e.left,t.x),Math.min(e.top,t.y),Math.max(e.right,t.x),Math.max(e.bottom,t.y)):new R(t.x,t.y,t.x,t.y)}static UnionRect(e,t){return e&&t&&e.isValid()&&t.isValid()?new R(Math.min(e.left,t.left),Math.min(e.top,t.top),Math.max(e.right,t.right),Math.max(e.bottom,t.bottom)):e&&e.isValid()?e:t&&t.isValid()?t:void 0}static IntersectRect(e,t){if(e&&t&&e.isValid()&&t.isValid()){const i=new R(Math.max(e.left,t.left),Math.max(e.top,t.top),Math.min(e.right,t.right),Math.min(e.bottom,t.bottom));return i.isValid()?i:void 0}}static SegmentBounds(e,t){return new R(Math.min(e.x,t.x),Math.min(e.y,t.y),Math.max(e.x,t.x),Math.max(e.y,t.y))}static QuadraticBezierBounds(e,t,i){let r;r=R.SegmentBounds(e,i);const s=(e.x-t.x)/(e.x+i.x-2*t.x);0<s&&s<1&&(r=R.UnionPoint(r,P.InterpolateQuadratic(e,t,i,s)));const n=(e.y-t.y)/(e.y+i.y-2*t.y);return 0<n&&n<1&&(r=R.UnionPoint(r,P.InterpolateQuadratic(e,t,i,n))),r}static InterpolateLinear(e,t,i){return new R(k(e.left,t.left,i),k(e.top,t.top,i),k(e.right,t.right,i),k(e.bottom,t.bottom,i))}}R.Zero=new R(0,0,0,0);class B{constructor(e,t,i,r){this.xMin=e,this.yMin=t,this.xMax=i,this.yMax=r}equals(e){return this.xMin===e.xMin&&this.yMin===e.yMin&&this.xMax===e.xMax&&this.yMax===e.yMax}clip(e){const t=new R(void 0===this.xMin?e.left:this.xMin,void 0===this.yMin?e.top:this.yMin,void 0===this.xMax?e.right:this.xMax,void 0===this.yMax?e.bottom:this.yMax);return R.IntersectRect(e,t)}static CreateFromRect(e){return new B(e.left,e.top,e.right,e.bottom)}}function I(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))}function A(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))}function F(e,t,i){return Math.min(i,Math.max(t,e))}function k(e,t,i){return e+(t-e)*i}function D(e,t,i,r,s,n){const o=s-e,a=n-t;if(Math.abs(o*(r-t)-a*(i-e))<C)return Math.sqrt(o*o+a*a);const l=s-2*i+e,h=n-2*r+t,c=2*i-2*s,d=2*r-2*n,u=4*(l*l+h*h),f=4*(l*c+h*d),p=c*c+d*d,m=2*Math.sqrt(u+f+p),g=Math.sqrt(u),v=2*Math.sqrt(p),_=f/g;return(g*(2*u*m+f*(m-v))+(4*p*u-f*f)*Math.log((2*g+_+m)/(_+v)))/(8*u*g)}function L(e,t){return e==t||null!=e&&null!=t&&e.equals(t)}class O{static Error(e,t){return O.s_logger.sendTraceTag(e,306,10,t),new Error(t+" "+e)}static Message(e,t){O.s_logger.sendTraceTag(e,306,50,t)}static setLogger(e){e&&(O.s_logger=e)}}O.s_logger={sendTraceTag:(e,t,i,r)=>{console.log(e,r)},shipAssertTag:()=>{},debugAssertTag:()=>{}};const U="undefined"!=typeof FinalizationRegistry?new FinalizationRegistry((e=>{const t=e;for(let e in t)t[e].onFinalization()})):void 0;class V{constructor(e,t){if(e instanceof V)this.m_sharedPathStorage=e.m_sharedPathStorage,this.m_transform=t||e.transform;else{const i=[];for(const t of e.figures)i.push(t instanceof H?t.createFigure():t);this.m_sharedPathStorage={figures:i,fillMode:null==e.fillMode?1:e.fillMode,lineEnabled:null==e.lineEnabled||e.lineEnabled,extrusionEnabled:null==e.extrusionEnabled||e.extrusionEnabled,glyphCacheId:e.glyphCacheId?{fontId:e.glyphCacheId.fontId,glyphId:e.glyphCacheId.glyphId}:void 0,isUntransformedRect:q(i),untransformedBounds:$(i),renderDataMap:{}},this.m_transform=t||(e.transform?e.transform:M.Identity)}null==U||U.register(this,this.renderDataMap)}static CreateFromFigure(e){return new V({figures:[e]})}static CreateFromRect(e){return new V({figures:[z.CreateFromRect(e)]})}get figures(){return this.m_sharedPathStorage.figures}get transform(){return this.m_transform}get fillMode(){return this.m_sharedPathStorage.fillMode}get lineEnabled(){return this.m_sharedPathStorage.lineEnabled}get extrusionEnabled(){return this.m_sharedPathStorage.extrusionEnabled}get glyphCacheId(){return this.m_sharedPathStorage.glyphCacheId}get maxPressure(){return 4096}get renderDataMap(){return this.m_sharedPathStorage.renderDataMap}get hasPressureInfo(){return this.figures.some((e=>!!(8&e.format)))}get isUntransformedRect(){return this.m_sharedPathStorage.isUntransformedRect}get untransformedBounds(){return this.m_sharedPathStorage.untransformedBounds}measureLength(e=M.Identity){let t=0;for(const i of this.figures)t+=i.measureLength(e);return t}equals(e){return this.m_sharedPathStorage==e.m_sharedPathStorage&&this.m_transform.equals(e.m_transform)}}const N=.1;function G(e){let t=(1&e?2:0)+(2&e?1:0)+(4&e?1:0)+(8&e?1:0)+(16&e?2:0);return 32&e&&(t=4*Math.ceil(t/4)),t}class z{constructor(e,t=!1,i=3){if(this.m_points=e,this.m_isClosed=t,this.m_format=i,this.m_pointDataSize=G(i),this.m_points.length%this.m_pointDataSize!=0)throw O.Error(592520776,"list of points invalid")}static CreateFromRect(e){return new z([e.left,e.top,1,e.right,e.top,1,e.right,e.bottom,1,e.left,e.bottom,1],!0)}static CreateFromRoundedRect(e,t){const i=Math.min(t,Math.min(e.width,e.height)/2),r=new H;return r.moveTo(e.center.x-e.width/2,e.center.y-(e.height/2-i)),r.arcTo(i,i,-Math.PI,Math.PI/2),r.lineTo(e.right-i,e.top),r.arcTo(i,i,-Math.PI/2,Math.PI/2),r.lineTo(e.right,e.bottom-i),r.arcTo(i,i,0,Math.PI/2),r.lineTo(e.left+i,e.bottom),r.arcTo(i,i,Math.PI/2,Math.PI/2),r.lineTo(e.left,e.top+i),r.close(),r.createFigure()}get points(){return this.m_points}get format(){return this.m_format}get pointDataSize(){return this.m_pointDataSize}get isClosed(){return this.m_isClosed}isLastPointDuplicated(){return this.getPoint(0).equalsWithEpsilon(this.getPoint(-1),N)}getPointCount(){return this.m_points.length/this.m_pointDataSize}getPoint(e){const t=this.getPointCount(),i=e<0?e%t+t:e%t;return new P(this.m_points[i*this.m_pointDataSize],this.m_points[i*this.m_pointDataSize+1])}getPointType(e){if(!(2&this.m_format))return 1;const t=this.getPointCount(),i=e<0?e%t+t:e%t;return this.m_points[i*this.m_pointDataSize+2]}toPolygon(){const e=this.getPointCount(),t=new H([],this.m_isClosed,1);for(let i=0;i<e;i++){const e=this.getPoint(i);if(2!=this.getPointType(i))t.pushPoint(e.x,e.y);else{const r=this.getPoint(i-1),s=this.getPoint(i+1),n=8;for(let i=1;i<n;i++){const o=P.InterpolateQuadratic(r,e,s,i/n);t.pushPoint(o.x,o.y)}}}return t.createFigure()}transform(e){const t=this.points.slice(0),i=this.pointDataSize;for(let r=0;r<this.getPointCount();r++){const s=this.getPoint(r).transformPoint(e);t[r*i]=s.x,t[r*i+1]=s.y}return new z(t,this.isClosed,this.format)}measureLength(e=M.Identity){let t=0;return this.forEachSegment(((e,i,r)=>(t+=i?P.MeasureQuadraticLength(e,i,r):P.Distance(e,r),!0)),e),t}getPointFromDist(e,t=M.Identity,i=!1){let r,s=0;return this.forEachSegment(((t,i,n)=>{const o=i?P.MeasureQuadraticLength(t,i,n):P.Distance(t,n);if(s+o>e){const a=(e-s)/o;r=i?P.InterpolateQuadratic(t,i,n,a):P.InterpolateLinear(t,n,a)}return s+=o,s<=e}),t,i),r||this.getPoint(i?0:this.getPointCount()-1).transformPoint(t)}getTangentFromDist(e,t=M.Identity,i=!1){let r=0,s=P.Zero;return this.forEachSegment(((t,i,n)=>{const o=i?P.MeasureQuadraticLength(t,i,n):P.Distance(t,n);return s=i?P.QuadraticTangent(t,i,n,(e-r)/o):n.subtract(t).scale(1/o),r+=o,r<e}),t,i),s}forEachSegment(e,t=M.Identity,i=!1){const r=this.getPointCount(),s=i?0:r-1,n=i?-1:1;for(let o=i?r-1:0;o!=s;o+=n){const i=o+n,s=i+n,a=2==this.getPointType(i);if(2!=this.getPointType(o)&&(this.m_isClosed||i==i%r)&&(!a||this.m_isClosed||s==s%r)&&!e(this.getPoint(o).transformPoint(t),a?this.getPoint(i).transformPoint(t):void 0,this.getPoint(a?s:i).transformPoint(t)))return}}}class H{constructor(e=[],t=!1,i=3){if(this._points=e,this.isClosed=t,this.format=i,this.pointDataSize=G(i),this.lastPointX=0,this.lastPointY=0,this._points.length%this.pointDataSize!=0)throw O.Error(592520777,"list of points invalid")}createFigure(){return new z(this._points,this.isClosed,this.format)}pushPoint(e,t,i=1,r){switch(this.lastPointX=e,this.lastPointY=t,this.pointDataSize){case 2:return void this._points.push(e,t);case 3:return void this._points.push(e,t,i);case 4:return void this._points.push(e,t,i,r?r[0]:0);case 5:return void this._points.push(e,t,i,r?r[0]:0,r?r[1]:0);case 6:return void this._points.push(e,t,i,r?r[0]:0,r?r[1]:0,r?r[2]:0);case 7:return void this._points.push(e,t,i,r?r[0]:0,r?r[1]:0,r?r[2]:0,r?r[3]:0)}throw O.Error(592520778,"Unsupported data size")}moveTo(e,t,i){if(0!=this._points.length)throw O.Error(592520779,"Figures should have only one MoveTo");this.pushPoint(e,t,1,i)}moveToPoint(e,t){this.moveTo(e.x,e.y,t)}lineTo(e,t,i){if(this._points.length<this.pointDataSize)throw O.Error(592520780,"All figures should start with a MoveTo");(Math.abs(e-this.lastPointX)>N||Math.abs(t-this.lastPointY)>N)&&this.pushPoint(e,t,1,i)}lineToPoint(e,t){this.lineTo(e.x,e.y,t)}quadBezierTo(e,t,i,r,s){if(this._points.length<this.pointDataSize)throw O.Error(592520781,"All figures should start with a MoveTo");const n=this.lastPointX,o=this.lastPointY;if(Math.abs(i-n)>N||Math.abs(r-o)>N){const a=Math.sqrt((e-n)*(e-n)+(t-o)*(t-o)),l=Math.sqrt((i-e)*(i-e)+(r-t)*(r-t)),h=Math.abs(e-n)<N&&Math.abs(t-o)<N,c=Math.abs(i-e)<N&&Math.abs(r-t)<N;!h&&!c&&Math.abs(a/l)>N&&Math.abs(l/a)>N?(this.pushPoint(e,t,2),this.pushPoint(i,r,1,s)):this.pushPoint(i,r,1,s)}}quadBezierToPoint(e,t,i){this.quadBezierTo(e.x,e.y,t.x,t.y,i)}cubicBezierTo(e,t,i,r,s,n){this.cubicBezierToPoint(new P(e,t),new P(i,r),new P(s,n))}cubicBezierToPoint(e,t,i){if(this._points.length<this.pointDataSize)throw O.Error(592520782,"All figures should start with a MoveTo");const r=new P(this.lastPointX,this.lastPointY),s=Math.abs(e.x-r.x)<N&&Math.abs(e.y-r.y)<N,n=Math.abs(t.x-e.x)<N&&Math.abs(t.y-e.y)<N,o=Math.abs(i.x-t.x)<N&&Math.abs(i.y-t.y)<N;if(n&&(s||o))s!=o&&this.lineToPoint(i);else{const s=4;let n=r,o=r,a=e;for(let l=0;l<s;l++){const h=(l+1)/s,c=P.InterpolateQuadratic(r,e,t,h),d=P.InterpolateQuadratic(e,t,i,h),u=P.InterpolateLinear(c,d,h),f=a.subtract(o).normalized(),p=d.subtract(c).normalized();let m;if(f&&p&&Math.abs(f.dot(p))<Math.sqrt(2)/2)m=P.CalculateLineIntersection(o,a,c,d,C);else{const o=(l+.5)/s,a=P.InterpolateLinear(P.InterpolateQuadratic(r,e,t,o),P.InterpolateQuadratic(e,t,i,o),o),h=n.add(u).scale(.5);m=h.add(a.subtract(h).scale(2))}m?this.quadBezierTo(m.x,m.y,u.x,u.y):this.lineTo(u.x,u.y),n=u,o=c,a=d}}}arcTo(e,t,i,r){if(this._points.length<this.pointDataSize)throw O.Error(592520783,"All figures should start with a MoveTo");const s=2*Math.PI,n=e<C||t<C,o=n?i:Math.atan2(e*Math.sin(i),t*Math.cos(i)),a=r<0?-1:1;let l=Math.abs(r);if(l>=s)l=s;else{let r=i+l*a;r=n?r:Math.atan2(e*Math.sin(r),t*Math.cos(r)),l=(r-o)*a,l<0&&(l+=s)}const h=this.lastPointX,c=this.lastPointY,d=h-Math.cos(o)*e,u=c-Math.sin(o)*t,f=Math.ceil(8*Math.abs(l)/s);for(let i=0;i<f;i++){const r=a*s/8,n=o+i*r,h=i==f-1?a*l-i*r:r,c=n+h,p=n+h/2,m=1/Math.cos(h/2),g=new P(d+Math.cos(p)*m*e,u+Math.sin(p)*m*t),v=new P(d+Math.cos(c)*e,u+Math.sin(c)*t);Math.abs(h)>C?this.quadBezierTo(g.x,g.y,v.x,v.y):this.lineTo(v.x,v.y)}}close(){if(this._points.length<this.pointDataSize)throw O.Error(592520784,"All figures should start with a MoveTo");this.isClosed=!0}isLastPointDuplicated(){return this.getPoint(0).equalsWithEpsilon(this.getPoint(-1),N)}getPointCount(){return this._points.length/this.pointDataSize}getPoint(e){const t=this.getPointCount(),i=e<0?e%t+t:e%t;return new P(this._points[i*this.pointDataSize],this._points[i*this.pointDataSize+1])}get data(){return this._points}}function W(e){const t="["+e.replace(/(M|L|Q|C|A|E|;)/g,(e=>"M"==e?"0":"L"==e?"1":"Q"==e?"2":"C"==e?"3":"A"==e?"4":"E"==e?"5":","))+"]",i=new Float32Array(JSON.parse(t)),r=[];let s,n=0;const o=2*Math.PI/216e5;for(;n<i.length;)switch(i[n++]){case 0:if(n+1>=i.length)throw O.Error(592520785,"Invalid LineTo");s&&r.push(s),s=new H,s.moveTo(i[n++],i[n++]);break;case 1:if(!s||n+1>=i.length)throw O.Error(592520786,"Invalid LineTo");s.lineTo(i[n++],i[n++]);break;case 2:if(!s||n+3>=i.length)throw O.Error(592520787,"Invalid MoveTo");s.quadBezierTo(i[n++],i[n++],i[n++],i[n++]);break;case 3:if(!s||n+5>=i.length)throw O.Error(592520788,"Invalid CubicBezierTo");s.cubicBezierTo(i[n++],i[n++],i[n++],i[n++],i[n++],i[n++]);break;case 4:if(!s||n+3>=i.length)throw O.Error(592520789,"Invalid Arc of ellipse");s.arcTo(i[n++],i[n++],i[n++]*o,i[n++]*o);break;case 5:if(!s)throw O.Error(592520790,"All paths should start with a MoveTo");s.close(),r.push(s),s=void 0}return s&&r.push(s),r}function $(e){let t;for(const i of e){if(!i.cachedBounds){const e=i.points.length/i.pointDataSize;if(e<1)return;let t=i.points[0],r=t,s=i.points[1],n=s;for(let o=0;o<e;o++){const a=o*i.pointDataSize,l=(o-1+e)%e*i.pointDataSize,h=(o+1)%e*i.pointDataSize;let c,d,u;2&i.format?(c=i.points[a+2],d=i.points[l+2],u=i.points[h+2]):c=d=u=1;const f=i.points[a],p=i.points[a+1];if(1==c&&1==u)t=f<t?f:t,r=f>r?f:r,s=p<s?p:s,n=p>n?p:n;else if(1==d&&2==c&&1==u){const e=i.points[l],o=i.points[l+1],a=i.points[h],c=i.points[h+1];t=e<t?e:t,r=e>r?e:r,s=o<s?o:s,n=o>n?o:n,t=a<t?a:t,r=a>r?a:r,s=c<s?c:s,n=c>n?c:n;const d=(e-f)/(e+a-2*f);if(0<d&&d<1){const i=d*d,l=e*(i-2*d+1)+a*i+2*f*(d-i),h=o*(i-2*d+1)+c*i+2*p*(d-i);t=l<t?l:t,r=l>r?l:r,s=h<s?h:s,n=h>n?h:n}const u=(o-p)/(o+c-2*p);if(0<u&&u<1){const i=u*u,l=e*(i-2*u+1)+a*i+2*f*(u-i),h=o*(i-2*u+1)+c*i+2*p*(u-i);t=l<t?l:t,r=l>r?l:r,s=h<s?h:s,n=h>n?h:n}}}i.cachedBounds=new R(t,s,r,n)}t=R.UnionRect(t,i.cachedBounds)}return t}function q(e){if(1!=e.length)return!1;const t=e[0];if((4!=t.getPointCount()||!t.isClosed||t.isLastPointDuplicated())&&(5!=t.getPointCount()||!t.isClosed||!t.isLastPointDuplicated()))return!1;const i=[t.getPoint(0),t.getPoint(1),t.getPoint(2),t.getPoint(3)],r=new R(Math.min(i[0].x,i[1].x,i[2].x,i[3].x),Math.min(i[0].y,i[1].y,i[2].y,i[3].y),Math.max(i[0].x,i[1].x,i[2].x,i[3].x),Math.max(i[0].y,i[1].y,i[2].y,i[3].y));for(let e=0;e<4;e++){const t=i[e],s=i[(e+1)%4];if(t.x!=r.left&&t.x!=r.right||t.y!=r.top&&t.y!=r.bottom||t.x!=s.x&&t.y!=s.y)return!1}return!0}function j(e,t){const i=new P(t*X(e.width,e.end),t*Y(e.length,e.end));let r;if(1==e.end||5==e.end)r=new z([-.5*i.x,-1*i.y,1,0,0,1,.5*i.x,-1*i.y,1],1==e.end);else if(2==e.end)r=new z([-.5*i.x,-1*i.y,1,0,0,1,.5*i.x,-1*i.y,1,0,-.5*i.y,1],!0);else if(3==e.end)r=new z([0,.5*i.y,1,.5*i.x,0,1,0,-.5*i.y,1,-.5*i.x,0,1],!0);else if(4==e.end){const e=new H;e.moveTo(.5*i.x,0),e.arcTo(.5*i.x,.5*i.y,0,2*Math.PI),e.close(),r=e.createFigure()}return r||O.Error(572867280,"bad arrow head"),r}function X(e,t){return 0==e?5==t?2.5:2:1==e?5==t?3.5:3:2==e?5:(O.Error(572867281,"bad arrow head"),0)}function Y(e,t){return 0==e?2:1==e?3:2==e?5==t?4.5:5:(O.Error(572867282,"bad arrow head"),0)}function K(e,t,i,r,s){const n=(3==i.end||4==i.end?.5:1)*Y(i.length,i.end)*r,o=(t?e.getPoint(e.getPointCount()-1):e.getPoint(0)).transformPoint(s),a=e.getPointFromDist(n,s,t),l=o.subtract(a).normalized();if(!l)return;const h=new P(-l.y,l.x);return new E(h.x,h.y,0,l.x,l.y,0,0,0,1).multiply(E.Translation2D(o))}function Z(e,t){return e?0==e.end||4==e.end||3==e.end?0:5==e.end||2==e.end?t*Y(e.length,e.end)/X(e.width,e.end):2*t:0}function J(e,t,i,r,s){if(0==i&&e.cachedBoundsContributor)return{points:e.cachedBoundsContributor.points,curves:e.cachedBoundsContributor.curves,transform:t};const n=0!=i,o={points:new Array,curves:new Array,transform:n?void 0:t},a=e.getPointCount();for(let l=0;l<a;l++){let a=e.getPoint(l-1),h=e.getPoint(l),c=e.getPoint(l+1);if(n&&(a=t.transformPoint(a),h=t.transformPoint(h),c=t.transformPoint(c)),2==e.getPointType(l))i?(o.curves.push([a.add(new P(-i,0)),h.add(new P(-i,0)),c.add(new P(-i,0))]),o.curves.push([a.add(new P(i,0)),h.add(new P(i,0)),c.add(new P(i,0))]),o.curves.push([a.add(new P(0,-i)),h.add(new P(0,-i)),c.add(new P(0,-i))]),o.curves.push([a.add(new P(0,i)),h.add(new P(0,i)),c.add(new P(0,i))])):o.curves.push([a,h,c]);else if(o.points.push(h),i)if(2==r)i?(o.points.push(h.add(new P(-i,0))),o.points.push(h.add(new P(i,0))),o.points.push(h.add(new P(0,-i))),o.points.push(h.add(new P(0,i)))):o.points.push(h);else{let e=h.subtract(a).normalized(),t=c.subtract(h).normalized();if(e&&t){e=e.scale(i),t=t.scale(i);let n=new P(-e.y,e.x),a=new P(-t.y,t.x);e.dot(a)<0&&(n=n.negate(),a=a.negate());const l=h.add(n),c=h.add(a);if(o.points.push(l),o.points.push(c),1==r||3==r){const n=P.CalculateLineIntersection(l,l.add(e),c,c.subtract(t));n&&(P.Distance(n,h)<s*i?o.points.push(n):1==r&&(o.points.push(l.add(e.scale(s))),o.points.push(c.subtract(t.scale(s)))))}}}}return 0!=i||e.cachedBoundsContributor||(e.cachedBoundsContributor={points:o.points,curves:o.curves,transform:void 0}),o}function Q(e,t){let i=!0,r=0,s=0,n=0,o=0;const a=e.transform&&t?e.transform.multiply(t):t||e.transform,l=!a||a.isSimpleScaleTranslationOnly(),h=l?void 0:a,c=e.points,d=e.curves,u=c&&c.length>0?c[0]:d&&d.length>0?d[0][0]:void 0;if(u){let e=0,t=0,f=0,p=0,m=0,g=0;if(h&&(e=h.m[0],t=h.m[1],f=h.m[3],p=h.m[4],m=h.m[6],g=h.m[7]),i&&(r=h?u.x*e+u.y*f+m:u.x,n=h?u.x*t+u.y*p+g:u.y,s=r,o=n,i=!1),c&&c.length>0)for(let i=1;i<c.length;i++){const a=c[i],l=h?a.x*e+a.y*f+m:a.x,d=h?a.x*t+a.y*p+g:a.y;r=l<r?l:r,s=l>s?l:s,n=d<n?d:n,o=d>o?d:o}for(const i of d||[]){const a=i[0],l=i[1],c=i[2],d=h?a.x*e+a.y*f+m:a.x,u=h?a.x*t+a.y*p+g:a.y,v=h?l.x*e+l.y*f+m:l.x,_=h?l.x*t+l.y*p+g:l.y,y=h?c.x*e+c.y*f+m:c.x,b=h?c.x*t+c.y*p+g:c.y;r=d<r?d:r,s=d>s?d:s,n=u<n?u:n,o=u>o?u:o,r=y<r?y:r,s=y>s?y:s,n=b<n?b:n,o=b>o?b:o;const w=(d-v)/(d+y-2*v);if(0<w&&w<1){const e=w*w,t=d*(e-2*w+1)+y*e+2*v*(w-e),i=u*(e-2*w+1)+b*e+2*_*(w-e);r=t<r?t:r,s=t>s?t:s,n=i<n?i:n,o=i>o?i:o}const T=(u-_)/(u+b-2*_);if(0<T&&T<1){const e=T*T,t=d*(e-2*T+1)+y*e+2*v*(T-e),i=u*(e-2*T+1)+b*e+2*_*(T-e);r=t<r?t:r,s=t>s?t:s,n=i<n?i:n,o=i>o?i:o}}let v=new R(r,n,s,o);return l&&(v=a?v.multiply(a.getSimpleScale()).translate(a.getSimpleTranslation()):v),v}}function ee(e){let t;for(const i of e){if(0!=i.transform.rotation)return;const e=i.untransformedBounds;e&&(t=R.UnionRect(t,e.transformedBounds(i.transform)))}return t}let te=1,ie=8,re=16,se=0;function ne(e,t){te=e,ie=t}let oe=!0,ae=!0,le=!0,he=0,ce=!1;let de=1040,ue=0;class fe{constructor(e,t=!1){this.m_changeTracker=new pe,this.deferTracking=t,this.m_changeTracker=new pe(t?this.getHash:void 0),this.m_elements=[],e&&(this.elements=e)}getHash(){return this.m_elements.map((e=>e.changeTracker.currentUniqueId)).join(",")}get changeTracker(){return this.m_changeTracker}get length(){return this.m_elements.length}get elements(){return this.m_elements}set elements(e){this.removeAll();for(let t of e)this.push(t)}getAt(e){if(e<0||e>=this.elements.length)throw O.Error(592520775,"Out of range");return this.m_elements[e]}setAt(e,t){this.deferTracking||(pe.RemoveListener(this.getAt(e).changeTracker,this.m_changeTracker),pe.AddListener(t.changeTracker,this.m_changeTracker)),this.m_elements[e]=t}push(e){this.deferTracking||pe.AddListener(e.changeTracker,this.m_changeTracker),this.m_elements.push(e)}insertAt(e,t){this.deferTracking||pe.AddListener(t.changeTracker,this.m_changeTracker),this.m_elements.splice(e,0,t)}removeAll(){if(!this.deferTracking)for(let e of this.m_elements)pe.RemoveListener(e.changeTracker,this.m_changeTracker);this.m_elements=[]}removeAt(e){this.deferTracking||pe.RemoveListener(this.getAt(e).changeTracker,this.m_changeTracker),this.m_elements.splice(e,1)}}class pe{constructor(e){this.trackerId=pe.s_nextUniqueId++,this.m_version=0,this.m_getDeferedHashFunction=e,this.m_currentUniqueId=this.trackerId+"v0",this.m_listeners=[]}get version(){return this.m_getDeferedHashFunction&&this.verifyDeferedHash(),this.m_version}get currentUniqueId(){return this.m_getDeferedHashFunction&&this.verifyDeferedHash(),this.m_currentUniqueId}get listenerCount(){var e,t;return(null===(e=this.m_weakListeners)||void 0===e?void 0:e.length)||(null===(t=this.m_listeners)||void 0===t?void 0:t.length)||0}verifyDeferedHash(){if(this.m_getDeferedHashFunction){const e=this.m_getDeferedHashFunction();e!=this.m_deferedHash&&(this.notifyChange(),this.m_deferedHash=e)}}notifyChange(){var e;if(this.m_version++,this.m_currentUniqueId=this.trackerId+"v"+this.m_version,this.m_weakListeners){this.m_weakListeners.length;this.m_weakListeners=this.m_weakListeners.filter((e=>null!=e.deref()));for(const t of this.m_weakListeners)null===(e=t.deref())||void 0===e||e.notifyChange()}else if(this.m_listeners)for(const e of this.m_listeners)e.notifyChange()}replaceListener(e,t){e!=t&&(e&&pe.RemoveListener(e.changeTracker,this),t&&pe.AddListener(t.changeTracker,this))}static AddListener(e,t){if(e)if(e.m_weakListeners){if(void 0===e.m_weakListeners.find((e=>e.deref()===t))){if("undefined"==typeof WeakRef)throw O.Error(525337749,"WeakRef not supported");e.m_weakListeners.push(new WeakRef(t)),t.notifyChange()}}else{if(!e.m_listeners)throw O.Error(525337750,"No dependency array");-1==e.m_listeners.indexOf(t)&&(e.m_listeners.push(t),t.notifyChange())}}static RemoveListener(e,t){if(e)if(e.m_weakListeners)e.m_weakListeners=e.m_weakListeners.filter((e=>e.deref()!=t)),t.notifyChange();else if(e.m_listeners){const i=e.m_listeners.indexOf(t);-1!=i&&(e.m_listeners.splice(i,1),t.notifyChange())}}}function me(e,t,i){t!=i&&e.notifyChange()}function ge(e,t,i){t==i||t&&i&&t.equals(i)||e.notifyChange()}function ve(e,t,i){if(t!=i)if(t&&i&&t.length==i.length){for(let r=0;r<t.length;r++)if(!t[r].equals(i[r]))return void e.notifyChange()}else e.notifyChange()}pe.s_nextUniqueId=1;class _e{constructor(e,t,i,r=1){this.r=e,this.g=t,this.b=i,this.a=r}equals(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}modulateOpacity(e){return new _e(this.r,this.g,this.b,this.a*e)}add(e){return new _e(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new _e(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}multiply(e){return new _e(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}divide(e){return new _e(this.r/e.r,this.g/e.g,this.b/e.b,this.a/e.a)}scale(e){return new _e(this.r*e,this.g*e,this.b*e,this.a*e)}static Gray(e){return new _e(e,e,e,1)}static FromRGBA(e){return new _e(e.r,e.g,e.b,e.a)}static FromHSL(e,t,i,r){const s=i<=.5?i+i*t:i+t-i*t,n=2*i-s,[o,a,l]=[1/3,0,-1/3].map((t=>{const i=(e+t)%1;return 6*i<1?n+(s-n)*i*6:2*i<1?s:3*i<2?n+(s-n)*(4-6*i):n}));return new _e(o,a,l,r)}static InterpolateLinear(e,t,i){return new _e(F(k(e.r,t.r,i),0,1),F(k(e.g,t.g,i),0,1),F(k(e.b,t.b,i),0,1),F(k(e.a,t.a,i),0,1))}}_e.Transparent=new _e(0,0,0,0),_e.Black=new _e(0,0,0,1),_e.White=new _e(1,1,1,1),_e.Red=new _e(1,0,0,1),_e.Orange=new _e(1,.5,0,1),_e.Yellow=new _e(1,1,0,1),_e.Green=new _e(0,1,0,1),_e.Cyan=new _e(0,1,1,1),_e.Blue=new _e(0,0,1,1),_e.Magenta=new _e(1,0,1,1);class ye{constructor(){this.renderDataMap={},this.m_changeTracker=new pe}get changeTracker(){return this.m_changeTracker}get id(){return this.m_id}set id(e){this.m_id!=e&&(this.m_changeTracker.notifyChange(),this.m_id=e)}releaseGeneratedResources(){for(const e in this.renderDataMap)this.renderDataMap[e].releaseGeneratedResources()}}class be{constructor(){this.m_changeTrackers={colorChangeTracker:new pe,alphaChangeTracker:new pe}}get changeTracker(){return this.m_changeTrackers.colorChangeTracker}get version(){return this.m_changeTrackers.colorChangeTracker.version}get alphaChangeTracker(){return this.m_changeTrackers.alphaChangeTracker}get rotateWithShape(){return!0}static IsGradient(e){return 2<=e&&e<=5}}class we extends be{constructor(e){super(),this.m_color=e}clone(){return new we(this.m_color)}get color(){return this.m_color}set color(e){ge(this.changeTracker,this.m_color,e),me(this.alphaChangeTracker,this.m_color.a,e.a),this.m_color=e}getType(){return 1}}class Te{constructor(e,t){this.position=e,this.color=t}equals(e){return this.position==e.position&&this.color.equals(e.color)}}class xe extends be{constructor(e,t){super(),this.m_type=e,this.m_angle=0,this.m_fillFromRect=new R(0,0,1,1),this.m_fillToRect=new R(.5,.5,.5,.5),this.m_rotateWithShape=!0,this.m_isStretched=!1,this.m_shadeFromTitle=!1,this.m_gradientStops=t?t.slice(0):[],this.m_isGammaCorrected=!0,this.m_alphaGamma=1,pe.AddListener(this.changeTracker,this.alphaChangeTracker)}clone(){const e=new xe(this.m_type,this.m_gradientStops);return e.m_angle=this.m_angle,e.m_fillFromRect=this.m_fillFromRect,e.m_fillToRect=this.m_fillToRect,e.m_rotateWithShape=this.m_rotateWithShape,e.m_isStretched=this.m_isStretched,e.m_shadeFromTitle=this.m_shadeFromTitle,e.m_isGammaCorrected=this.m_isGammaCorrected,e.m_alphaGamma=this.m_alphaGamma,e}get gradientStops(){return this.m_gradientStops}get angle(){return this.m_angle}get fillFromRect(){return this.m_fillFromRect}get fillToRect(){return this.m_fillToRect}get isStretched(){return this.m_isStretched}get shadeFromTitle(){return this.m_shadeFromTitle}get rotateWithShape(){return 5==this.m_type||this.m_rotateWithShape}get isGammaCorrected(){return this.m_isGammaCorrected}get blendBellShape(){return this.m_blendBellShape}get alphaGamma(){return this.m_alphaGamma}set gradientStops(e){ve(this.changeTracker,this.m_gradientStops,e),this.m_gradientStops=e.slice(0)}set angle(e){me(this.changeTracker,this.m_angle,e),this.m_angle=e}set fillFromRect(e){ge(this.changeTracker,this.m_fillFromRect,e),this.m_fillFromRect=e}set fillToRect(e){ge(this.changeTracker,this.m_fillToRect,e),this.m_fillToRect=e}set rotateWithShape(e){me(this.changeTracker,this.m_rotateWithShape,e),this.m_rotateWithShape=e}set isStretched(e){me(this.changeTracker,this.m_isStretched,e),this.m_isStretched=e}set shadeFromTitle(e){me(this.changeTracker,this.m_shadeFromTitle,e),this.m_shadeFromTitle=e}set isGammaCorrected(e){me(this.changeTracker,this.m_isGammaCorrected,e),this.m_isGammaCorrected=e}set blendBellShape(e){ge(this.changeTracker,this.m_blendBellShape,e),this.m_blendBellShape=e}set alphaGamma(e){me(this.changeTracker,this.m_alphaGamma,e),this.m_alphaGamma=e}getType(){return this.m_type}}class Ce extends be{constructor(e,t){super(),this.m_fillToPreserveAspectRatio=!1,this.m_isAlphaInvariant=!!t,this.changeTracker.replaceListener(void 0,e),this.m_isAlphaInvariant||this.alphaChangeTracker.replaceListener(void 0,e),this.m_image=e,this.m_isStretched=!0,this.m_scale=P.One,this.m_offset=P.Zero,this.m_rotation=0,this.m_rotationCenter=new P(.5,.5),this.m_alignment=4,this.m_opacity=1,this.m_rotateWithShape=!0}clone(){const e=new Ce(this.m_image);return e.m_isStretched=this.m_isStretched,e.m_scale=this.m_scale,e.m_offset=this.m_offset,e.m_rotation=this.m_rotation,e.m_rotationCenter=this.m_rotationCenter,e.m_alignment=this.m_alignment,e.m_opacity=this.m_opacity,e.m_rotateWithShape=this.m_rotateWithShape,e}get image(){return this.m_image}get wrapMode(){return this.m_wrapMode}get isStretched(){return this.m_isStretched}get scale(){return this.m_scale}get offset(){return this.m_offset}get rotation(){return this.m_rotation}get rotationCenter(){return this.m_rotationCenter}get alignment(){return this.m_alignment}get opacity(){return this.m_opacity}get rotateWithShape(){return this.m_rotateWithShape}get pictureEffects(){return this.m_pictureEffects}get isAlphaInvariant(){return this.m_isAlphaInvariant}get fillToPreserveAspectRatio(){return this.m_fillToPreserveAspectRatio}set image(e){this.changeTracker.replaceListener(this.m_image,e),this.m_isAlphaInvariant||this.alphaChangeTracker.replaceListener(this.m_image,e),this.m_image=e}set wrapMode(e){me(this.changeTracker,this.m_wrapMode,e),me(this.alphaChangeTracker,this.m_wrapMode,e),this.m_wrapMode=e}set isStretched(e){me(this.changeTracker,this.m_isStretched,e),me(this.alphaChangeTracker,this.m_isStretched,e),this.m_isStretched=e}set scale(e){ge(this.changeTracker,this.m_scale,e),ge(this.alphaChangeTracker,this.m_scale,e),this.m_scale=e}set offset(e){ge(this.changeTracker,this.m_offset,e),ge(this.alphaChangeTracker,this.m_offset,e),this.m_offset=e}set rotation(e){me(this.changeTracker,this.m_rotation,e),me(this.alphaChangeTracker,this.m_rotation,e),this.m_rotation=e}set rotationCenter(e){ge(this.changeTracker,this.m_rotationCenter,e),ge(this.alphaChangeTracker,this.m_rotationCenter,e),this.m_rotationCenter=e}set alignment(e){me(this.changeTracker,this.m_alignment,e),me(this.alphaChangeTracker,this.m_alignment,e),this.m_alignment=e}set opacity(e){me(this.changeTracker,this.m_opacity,e),me(this.alphaChangeTracker,this.m_opacity,e),this.m_opacity=e}set rotateWithShape(e){me(this.changeTracker,this.m_rotateWithShape,e),me(this.alphaChangeTracker,this.m_rotateWithShape,e),this.m_rotateWithShape=e}set pictureEffects(e){this.m_pictureEffects!=e&&(this.changeTracker.replaceListener(this.m_pictureEffects,e),this.alphaChangeTracker.replaceListener(this.m_pictureEffects,e),this.m_pictureEffects=e)}set isAlphaInvariant(e){this.m_isAlphaInvariant!=e&&(e?this.alphaChangeTracker.replaceListener(this.m_image,void 0):this.alphaChangeTracker.replaceListener(void 0,this.m_image),this.m_isAlphaInvariant=e)}set fillToPreserveAspectRatio(e){me(this.changeTracker,this.m_fillToPreserveAspectRatio,e),me(this.alphaChangeTracker,this.m_fillToPreserveAspectRatio,e),this.m_fillToPreserveAspectRatio=e}getType(){return 6}}class Pe extends be{constructor(e,t,i){super(),this.m_pattern=e,this.m_foregroundColor=t,this.m_backgroundColor=i}clone(){return new Pe(this.m_pattern,this.m_foregroundColor,this.m_backgroundColor)}get pattern(){return this.m_pattern}get foregroundColor(){return this.m_foregroundColor}get backgroundColor(){return this.m_backgroundColor}get rotateWithShape(){return!1}set pattern(e){me(this.changeTracker,this.m_pattern,e),me(this.alphaChangeTracker,this.m_pattern,e),this.m_pattern=e}set foregroundColor(e){ge(this.changeTracker,this.m_foregroundColor,e),me(this.changeTracker,this.m_foregroundColor.a,e.a),this.m_foregroundColor=e}set backgroundColor(e){ge(this.changeTracker,this.m_backgroundColor,e),me(this.changeTracker,this.m_backgroundColor.a,e.a),this.m_backgroundColor=e}getType(){return 7}}class Se{constructor(e,t,i,r,s){this.widthMin=e,this.end=t,this.cap=i,this.width=r,this.length=s}}class Ee{constructor(e=0,t=2,i=8){this.headEnd=new Se(0,0,0,1,1),this.tailEnd=new Se(0,0,0,1,1),this.m_changeTracker=new pe,this.m_lineWidth=e,this.m_lineJoin=t,this.m_miterLimit=i,this.m_dashType=0,this.m_compoundType=0,this.m_alignment=0,this.m_useRoundDash=!1}clone(){const e=new Ee(this.m_lineWidth);return e.m_lineJoin=this.m_lineJoin,e.m_miterLimit=this.m_miterLimit,e.m_dashType=this.m_dashType,e.m_compoundType=this.m_compoundType,e.m_alignment=this.m_alignment,e.m_useRoundDash=this.m_useRoundDash,e}get changeTracker(){return this.m_changeTracker}get version(){return this.m_changeTracker.version}get lineWidth(){return this.m_lineWidth?this.m_lineWidth:this.m_lineHeight?this.m_lineHeight:0}get adjustedLineWidth(){return Math.max(te,this.lineWidth)}get adjustedLineWidthForArrowHead(){return Math.max(ie,this.lineWidth)}get lineHeight(){return this.m_lineHeight?this.m_lineHeight:this.m_lineWidth?this.m_lineWidth:0}get tipScale(){return this.m_lineWidth&&this.m_lineHeight?new P(1,this.m_lineHeight/this.m_lineWidth):P.One}get lineJoin(){return this.m_lineJoin}get miterLimit(){return this.m_miterLimit}get dashType(){return this.m_dashType}get useRoundDash(){return this.m_useRoundDash}get dashOffset(){return null==this.m_dashOffset?0:this.m_dashOffset}get compoundType(){return this.m_compoundType}get alignment(){return this.m_alignment}get tipType(){return null==this.m_tipType?0:this.m_tipType}set lineWidth(e){me(this.changeTracker,this.m_lineWidth,e),this.m_lineWidth=e}set lineHeight(e){me(this.changeTracker,this.m_lineHeight,e),this.m_lineHeight=e}set lineJoin(e){me(this.changeTracker,this.m_lineJoin,e),this.m_lineJoin=e}set miterLimit(e){me(this.changeTracker,this.m_miterLimit,e),this.m_miterLimit=e}set dashType(e){me(this.changeTracker,this.m_dashType,e),this.m_dashType=e}set useRoundDash(e){me(this.changeTracker,this.m_useRoundDash,e),this.m_useRoundDash=e}set dashOffset(e){me(this.changeTracker,this.m_dashOffset,e),this.m_dashOffset=e}set compoundType(e){me(this.changeTracker,this.m_compoundType,e),this.m_compoundType=e}set alignment(e){me(this.changeTracker,this.m_alignment,e),this.m_alignment=e}set tipType(e){me(this.changeTracker,this.m_tipType,e),this.m_tipType=e}}class Me{constructor(e,t,i=new Ee,r=0){this.m_changeTracker=new pe,this.m_alphaChangeTracker=new pe,this.m_penChangeTracker=new pe,this.m_fillChangeTrackers={colorChangeTracker:new pe,alphaChangeTracker:new pe},this.m_lineChangeTrackers={colorChangeTracker:new pe,alphaChangeTracker:new pe},this.m_pictureChangeTrackers={colorChangeTracker:new pe,alphaChangeTracker:new pe},pe.AddListener(this.m_fillChangeTrackers.colorChangeTracker,this.m_changeTracker),pe.AddListener(this.m_lineChangeTrackers.colorChangeTracker,this.m_changeTracker),pe.AddListener(this.m_pictureChangeTrackers.colorChangeTracker,this.m_changeTracker),pe.AddListener(this.m_fillChangeTrackers.alphaChangeTracker,this.m_alphaChangeTracker),pe.AddListener(this.m_lineChangeTrackers.alphaChangeTracker,this.m_alphaChangeTracker),pe.AddListener(this.m_pictureChangeTrackers.alphaChangeTracker,this.m_alphaChangeTracker),pe.AddListener(this.m_penChangeTracker,this.m_changeTracker),this.m_pen=i,this.fillBrush=e,this.lineBrush=t,this.m_blendingMode=r,this.m_penChangeTracker.replaceListener(void 0,i)}clone(){const e=new Me;return e.fillBrush=this.m_fillBrush?this.m_fillBrush.clone():void 0,e.lineBrush=this.m_lineBrush?this.m_lineBrush.clone():void 0,e.pictureBrush=this.m_pictureBrush?this.m_pictureBrush.clone():void 0,e.pictureEffects=this.m_pictureEffects?this.m_pictureEffects.clone():void 0,e.m_pictureOverflow=this.m_pictureOverflow,e.pen=this.m_pen.clone(),e.blendingMode=this.m_blendingMode,e.m_hitTransparentFill=this.m_hitTransparentFill,e}get changeTracker(){return this.m_changeTracker}get alphaChangeTracker(){return this.m_alphaChangeTracker}get penChangeTracker(){return this.m_penChangeTracker}get version(){return this.m_changeTracker.version}get fillBrush(){return this.m_fillBrush}get lineBrush(){return this.m_lineBrush}get pictureBrush(){return this.m_pictureBrush}get pictureEffects(){return this.m_pictureEffects}get pictureOverflow(){return this.m_pictureOverflow||0}get pen(){return this.m_pen}get hasLine(){return null!=this.m_lineBrush}get blendingMode(){return this.m_blendingMode}get hitTransparentFill(){return!!this.m_hitTransparentFill}get hitTestSlop(){return this.m_hitTestSlop}set fillBrush(e){Re(this.m_fillChangeTrackers.colorChangeTracker,this.m_fillChangeTrackers.alphaChangeTracker,this.m_fillBrush,e),this.m_fillBrush=e}set lineBrush(e){Re(this.m_lineChangeTrackers.colorChangeTracker,this.m_lineChangeTrackers.alphaChangeTracker,this.m_lineBrush,e),this.m_lineBrush=e}set pictureBrush(e){Re(this.m_pictureChangeTrackers.colorChangeTracker,this.m_pictureChangeTrackers.alphaChangeTracker,this.m_pictureBrush,e),this.m_pictureBrush=e}set pictureEffects(e){this.m_pictureEffects!=e&&(this.changeTracker.replaceListener(this.m_pictureEffects,e),this.m_pictureEffects=e)}set pictureOverflow(e){me(this.changeTracker,this.m_pictureOverflow,e),this.m_pictureOverflow=e}set pen(e){this.m_penChangeTracker.replaceListener(this.m_pen,e),this.m_pen=e}set blendingMode(e){me(this.changeTracker,this.m_blendingMode,e),this.m_blendingMode=e}set hitTransparentFill(e){me(this.changeTracker,this.m_hitTransparentFill,e),this.m_hitTransparentFill=e}set hitTestSlop(e){this.m_hitTestSlop!=e&&this.changeTracker.notifyChange(),this.m_hitTestSlop=e}getBrushImages(){const e=Be(this.fillBrush);return e.push(...Be(this.lineBrush)),e.push(...Be(this.pictureBrush)),e}}function Re(e,t,i,r){i!=r&&(i&&(pe.RemoveListener(i.changeTracker,e),pe.RemoveListener(i.alphaChangeTracker,t)),r&&(pe.AddListener(r.changeTracker,e),pe.AddListener(r.alphaChangeTracker,t)))}function Be(e){const t=[];if(e&&6==e.getType()){const i=e;i.image&&t.push(i.image)}return t}class Ie{constructor(e=_e.Transparent,t=0,i=!1){this.m_changeTracker=new pe,this.m_color=e,this.m_radius=t,this.m_isSharp=i}get changeTracker(){return this.m_changeTracker}get color(){return this.m_color}get radius(){return this.m_radius}get isSharp(){return this.m_isSharp}set color(e){ge(this.m_changeTracker,this.m_color,e),this.m_color=e}set radius(e){me(this.m_changeTracker,this.m_radius,e),this.m_radius=e}set isSharp(e){me(this.m_changeTracker,this.m_isSharp,e),this.m_isSharp=e}clone(){return new Ie(this.m_color,this.m_radius,this.m_isSharp)}}class Ae{constructor(e=_e.Transparent,t=0,i=0,r=0,s=P.One,n=P.Zero,o=4,a=!1,l=0){this.m_changeTracker=new pe,this.m_color=e,this.m_radius=t,this.m_angle=i,this.m_distance=r,this.m_scale=s,this.m_skew=n,this.m_alignment=o,this.m_rotateWithShape=a,this.m_shadowType=l}get changeTracker(){return this.m_changeTracker}get color(){return this.m_color}get radius(){return this.m_radius}get angle(){return this.m_angle}get distance(){return this.m_distance}get scale(){return this.m_scale}get skew(){return this.m_skew}get alignment(){return this.m_alignment}get rotateWithShape(){return this.m_rotateWithShape}get shadowType(){return this.m_shadowType}set color(e){ge(this.m_changeTracker,this.m_color,e),this.m_color=e}set radius(e){me(this.m_changeTracker,this.m_radius,e),this.m_radius=e}set angle(e){me(this.m_changeTracker,this.m_angle,e),this.m_angle=e}set distance(e){me(this.m_changeTracker,this.m_distance,e),this.m_distance=e}set scale(e){ge(this.m_changeTracker,this.m_scale,e),this.m_scale=e}set skew(e){ge(this.m_changeTracker,this.m_skew,e),this.m_skew=e}set alignment(e){me(this.m_changeTracker,this.m_alignment,e),this.m_alignment=e}set rotateWithShape(e){me(this.m_changeTracker,this.m_rotateWithShape,e),this.m_rotateWithShape=e}set shadowType(e){me(this.m_changeTracker,this.m_shadowType,e),this.m_shadowType=e}clone(){return new Ae(this.m_color,this.m_radius,this.m_angle,this.m_distance,this.m_scale,this.m_skew,this.m_alignment,this.m_rotateWithShape,this.m_shadowType)}}class Fe{constructor(e=_e.Transparent,t=0,i=0,r=0){this.m_changeTracker=new pe,this.m_color=e,this.m_radius=t,this.m_angle=i,this.m_distance=r}get changeTracker(){return this.m_changeTracker}get color(){return this.m_color}get radius(){return this.m_radius}get angle(){return this.m_angle}get distance(){return this.m_distance}set color(e){ge(this.m_changeTracker,this.m_color,e),this.m_color=e}set radius(e){me(this.m_changeTracker,this.m_radius,e),this.m_radius=e}set angle(e){me(this.m_changeTracker,this.m_angle,e),this.m_angle=e}set distance(e){me(this.m_changeTracker,this.m_distance,e),this.m_distance=e}clone(){return new Fe(this.m_color,this.m_radius,this.m_angle,this.m_distance)}}class ke{constructor(e=0,t=1,i=0,r=0,s=1,n=0){this.m_changeTracker=new pe,this.m_radius=e,this.m_startAlpha=t,this.m_startPosition=i,this.m_endAlpha=r,this.m_endPosition=s,this.m_distance=n}get changeTracker(){return this.m_changeTracker}get radius(){return this.m_radius}get startAlpha(){return this.m_startAlpha}get startPosition(){return this.m_startPosition}get endAlpha(){return this.m_endAlpha}get endPosition(){return this.m_endPosition}get distance(){return this.m_distance}set radius(e){me(this.m_changeTracker,this.m_radius,e),this.m_radius=e}set startAlpha(e){me(this.m_changeTracker,this.m_startAlpha,e),this.m_startAlpha=e}set startPosition(e){me(this.m_changeTracker,this.m_startPosition,e),this.m_startPosition=e}set endAlpha(e){me(this.m_changeTracker,this.m_endAlpha,e),this.m_endAlpha=e}set endPosition(e){me(this.m_changeTracker,this.m_endPosition,e),this.m_endPosition=e}set distance(e){me(this.m_changeTracker,this.m_distance,e),this.m_distance=e}clone(){return new ke(this.m_radius,this.m_startAlpha,this.m_startPosition,this.m_endAlpha,this.m_endPosition,this.m_distance)}}class De{constructor(e=0){this.m_changeTracker=new pe,this.m_radius=e}get changeTracker(){return this.m_changeTracker}notifyChange(){this.m_changeTracker.notifyChange()}get radius(){return this.m_radius}set radius(e){this.m_radius!=e&&(this.notifyChange(),this.m_radius=e)}clone(){return new De(this.m_radius)}}class Le{constructor(e,t,i,r,s){this.m_changeTracker=new pe,this.glow=e,this.shadow=t,this.innerShadow=i,this.reflection=r,this.softEdges=s}get changeTracker(){return this.m_changeTracker}notifyChange(){this.m_changeTracker.notifyChange()}get glow(){return this.m_glow}get shadow(){return this.m_shadow}get innerShadow(){return this.m_innerShadow}get reflection(){return this.m_reflection}get softEdges(){return this.m_softEdges}get direction(){return this.m_direction||0}get hasEffects(){return!!(this.m_glow||this.m_shadow||this.m_innerShadow||this.m_reflection||this.m_softEdges)}set glow(e){this.m_changeTracker.replaceListener(this.m_glow,e),this.m_glow=e}set shadow(e){this.m_changeTracker.replaceListener(this.m_shadow,e),this.m_shadow=e}set innerShadow(e){this.m_changeTracker.replaceListener(this.m_innerShadow,e),this.m_innerShadow=e}set reflection(e){this.m_changeTracker.replaceListener(this.m_reflection,e),this.m_reflection=e}set softEdges(e){this.m_changeTracker.replaceListener(this.m_softEdges,e),this.m_softEdges=e}set direction(e){me(this.m_changeTracker,this.m_direction,e),this.m_direction=e}clone(){return new Le(this.m_glow?this.m_glow.clone():void 0,this.m_shadow?this.m_shadow.clone():void 0,this.m_innerShadow?this.m_innerShadow.clone():void 0,this.m_reflection?this.m_reflection.clone():void 0,this.m_softEdges?this.m_softEdges.clone():void 0)}}const Oe=256;class Ue{constructor(e,t){this.start=e,this.length=t}get last(){return this.start+this.length-1}equals(e){return this.start==e.start&&this.length==e.length}includes(e){return e>=this.start&&e<=this.last}intersects(e){return this.start<=e.last&&this.last>=e.start}contains(e){return this.start<=e.start&&e.last<=this.last}getIntersection(e){const t=Ue.FromFirstLast(Math.max(this.start,e.start),Math.min(this.last,e.last));return t.length>=0?t:void 0}move(e){return new Ue(this.start+e,this.length)}static FromFirstLast(e,t){return new Ue(e,t+1-e)}}class Ve{constructor(e){this.m_defaultData=e}onDataChange(){}onRangeChange(){}onDataRemoved(e){}onDataAdded(e){}get defaultData(){return this.m_defaultData}get ranges(){const e=[];for(let t of this.m_dataPerRange||[])e.push(t.range);return e}get allData(){const e=[this.m_defaultData];for(let t of this.m_dataPerRange||[])e.push(t.data);return e}get dataPerRange(){return this.m_dataPerRange||[]}set defaultData(e){this.m_defaultData=e}set(e,t){if(this.onDataChange(),t){for(let i of this.m_dataPerRange||[])if(i.range.start==t.start&&i.range.last==t.last)return this.onDataRemoved(i.data),i.data=e,void this.onDataAdded(i.data);for(let e of this.m_dataPerRange||[])this.onDataRemoved(e.data);this.onRangeChange();const i=[];let r=!1;for(let s of this.m_dataPerRange||[])s.range.start<t.start&&i.push({range:Ue.FromFirstLast(s.range.start,Math.min(s.range.last,t.start-1)),data:s.data}),t.last<s.range.last&&(r||(i.push({range:t,data:e}),r=!0),i.push({range:Ue.FromFirstLast(Math.max(s.range.start,t.last+1),s.range.last),data:s.data}));r||i.push({range:t,data:e}),this.m_dataPerRange=i;for(let e of this.m_dataPerRange||[])this.onDataAdded(e.data)}else{for(let e of this.m_dataPerRange||[])this.onDataRemoved(e.data);this.m_defaultData=e,this.m_dataPerRange=void 0}}getAt(e){for(let t of this.m_dataPerRange||[])if(t.range.start<=e&&e<=t.range.last)return t.data;return this.m_defaultData}shiftIndices(e,t){if(this.m_dataPerRange){const i=[],r=t-e.length;for(let s of this.m_dataPerRange)if(e.contains(s.range)&&e.start!=s.range.start)this.onDataRemoved(s.data);else if(s.range.includes(e.start)){const r=Math.min(e.length,s.range.last+1-e.start);i.push({range:new Ue(s.range.start,s.range.length+t-r),data:s.data})}else s.range.start<=e.last&&e.last<=s.range.last?i.push({range:Ue.FromFirstLast(e.start+t,s.range.last+r),data:s.data}):e.last<s.range.start?i.push({range:s.range.move(r),data:s.data}):i.push(s);this.m_dataPerRange=i}}}class Ne extends Ve{constructor(e){super(e),this.m_changeTracker=new pe,this.m_rangeChangeTracker=new pe,this.m_changeTracker.replaceListener(void 0,e)}get changeTracker(){return this.m_changeTracker}get rangeChangeTracker(){return this.m_rangeChangeTracker}onDataChange(){this.m_changeTracker.notifyChange()}onRangeChange(){this.rangeChangeTracker.notifyChange()}onDataRemoved(e){pe.RemoveListener(e.changeTracker,this.m_changeTracker)}onDataAdded(e){pe.AddListener(e.changeTracker,this.m_changeTracker)}}class Ge{constructor(e,t,i,r){this.m_changeTracker=new pe,this.m_type=e,this.m_verticalCenter=t,this.m_thickness=i,this.style=r}clone(){return new Ge(this.m_type,this.m_verticalCenter,this.m_thickness,this.m_style?this.m_style.clone():void 0)}get type(){return this.m_type}get verticalCenter(){return this.m_verticalCenter}get thickness(){return this.m_thickness}get style(){return this.m_style}get changeTracker(){return this.m_changeTracker}set type(e){me(this.changeTracker,this.m_type,e),this.m_type=e}set verticalCenter(e){me(this.changeTracker,this.m_verticalCenter,e),this.m_verticalCenter=e}set thickness(e){me(this.changeTracker,this.m_thickness,e),this.m_thickness=e}set style(e){this.changeTracker.replaceListener(this.m_style,e),this.m_style=e}}class ze{constructor(e,t,i=!1){this.m_changeTracker=new pe,this.m_animationTransform=t,this.m_isHidden=i,this.fade=e}clone(){return new ze(this.m_fade?this.m_fade.clone():void 0,this.m_animationTransform)}equals(e){return(this.m_fade==e.m_fade||null!=this.m_fade&&null!=e.m_fade&&this.m_fade.equals(e.m_fade))&&(this.m_animationTransform==e.m_animationTransform||null!=this.m_animationTransform&&null!=e.m_animationTransform&&this.m_animationTransform.equals(e.m_animationTransform))&&this.m_isHidden==e.m_isHidden}get fade(){return this.m_fade}get animationTransform(){return this.m_animationTransform}get isHidden(){return!!this.m_isHidden}get changeTracker(){return this.m_changeTracker}set fade(e){this.m_changeTracker.replaceListener(this.m_fade,e),this.m_fade=e}set animationTransform(e){ge(this.m_changeTracker,this.m_animationTransform,e),this.m_animationTransform=e}set isHidden(e){e!=this.isHidden&&(this.m_changeTracker.notifyChange(),this.m_isHidden=e)}}const He=new E(0,-1,0,1,0,0,0,0,1);class We{constructor(e,t,i,r,s,n){this.lineRect=e,this.path=t,this.alignment=i,this.scale=r,this.pivot=s,this.isVerticalLayout=n,this.pathLength=t.measureLength(),this.equivalentWarpingEnvelope=this.calculateEquivalentWarpingEnvelope()}equals(e){return this.lineRect.equals(e.lineRect)&&this.path==e.path&&this.alignment==e.alignment&&this.scale==e.scale&&this.pivot==e.pivot&&this.isVerticalLayout==e.isVerticalLayout}getPathPosition(e){const t=this.isVerticalLayout?e.transformedBounds(He):e,i=this.isVerticalLayout?this.lineRect.transformedBounds(He):this.lineRect;if(!t||!i)return;const r=i.width;let s=0;if(r*this.scale<this.pathLength){const e=this.pathLength-r*this.scale;s=this.alignment*(e/this.pathLength)}const n=(t.left-i.left)*this.scale/this.pathLength+s;return(n+(n+t.width/this.pathLength*this.scale))/2}getTransform(e){const t=this.getPathPosition(e),i=this.isVerticalLayout?e.transformedBounds(He):e;if(!t||!i)return;const r=F(t,0,1)*this.pathLength,s=this.path.getPointFromDist(r),n=this.path.getTangentFromDist(r);if(!n)return;const o=(i.left+i.right)/2,a=i.top+i.height*this.pivot;let l=E.Translation2D(new P(-o,-a));l=l.multiply(E.Scale2D(new P(this.scale,this.scale)));const h=n.x,c=n.y;return l=l.multiply(new E(h,c,0,-c,h,0,0,0,1)),l=l.multiply(E.Translation2D(s)),this.isVerticalLayout&&(l=He.multiply(l)),l}calculateEquivalentWarpingEnvelope(){const e=new H,t=new H,i=this.isVerticalLayout?0:this.lineRect.height/2,r=this.isVerticalLayout?this.lineRect.top:this.lineRect.left,s=this.isVerticalLayout?this.lineRect.bottom:this.lineRect.right;let n=this.lineRect;for(let o=0;o<=1;o+=.00390625){const a=r+(s-r)*o,l=this.isVerticalLayout?new R(this.lineRect.right,a-i,this.lineRect.left,a+i):new R(a-i,this.lineRect.top,a+i,this.lineRect.bottom),h=this.getPathPosition(l);if(null!=h&&h>=0&&h<=1){const r=a+(2*o-1)*i,s=this.getTransform(l);if(s){const i=s.transformPoint(this.isVerticalLayout?new P(l.left,r):new P(r,l.top)),o=s.transformPoint(this.isVerticalLayout?new P(l.right,r):new P(r,l.bottom));0==e.getPointCount()?(e.moveToPoint(i),t.moveToPoint(o),n=new R(this.isVerticalLayout?n.left:r,this.isVerticalLayout?r:n.top,n.right,n.bottom)):(e.lineToPoint(i),t.lineToPoint(o),n=new R(n.left,n.top,this.isVerticalLayout?n.right:r,this.isVerticalLayout?r:n.bottom))}}}return new qe(n,e.createFigure(),t.createFigure(),this.isVerticalLayout)}}class $e{constructor(e){this.currentX=0,this.currentY=0,this.m_samplesX=new Float32Array(257),this.m_samplesY=new Float32Array(257);const t=e.measureLength();for(let i=0;i<=Oe;i++){const r=e.getPointFromDist(t*i/Oe);this.m_samplesX[i]=r.x,this.m_samplesY[i]=r.y}}moveTo(e){const t=Math.floor(e*Oe),i=Math.min(t+1,Oe),r=e*Oe-t;this.currentX=this.m_samplesX[t]*(1-r)+this.m_samplesX[i]*r,this.currentY=this.m_samplesY[t]*(1-r)+this.m_samplesY[i]*r}equals(e){for(let t=0;t<=Oe;t++)if(this.m_samplesX[t]!=e.m_samplesX[t]||this.m_samplesY[t]!=e.m_samplesY[t])return!1;return!0}}class qe{constructor(e,t,i,r=!1){this.sourceRect=e,this.topPath=t,this.bottomPath=i,this.isVerticalLayout=r,this.topCurve=new $e(t),this.bottomCurve=new $e(i)}equals(e){return this.sourceRect.equals(e.sourceRect)&&this.topCurve.equals(e.topCurve)&&this.bottomCurve.equals(e.bottomCurve)&&this.isVerticalLayout==e.isVerticalLayout}warpPoint(e){const t=F(this.isVerticalLayout?(e.y-this.sourceRect.top)/this.sourceRect.height:(e.x-this.sourceRect.left)/this.sourceRect.width,0,1),i=F(this.isVerticalLayout?1-(e.x-this.sourceRect.left)/this.sourceRect.width:(e.y-this.sourceRect.top)/this.sourceRect.height,0,1);return this.topCurve.moveTo(t),this.bottomCurve.moveTo(t),new P(k(this.topCurve.currentX,this.bottomCurve.currentX,i),k(this.topCurve.currentY,this.bottomCurve.currentY,i))}warpPath(e){const t=[],i=Math.max(this.sourceRect.width)/4,r=E.FromTransforms(e.transform);for(let s of e.figures)if(s.getPointCount()>0){const e=new H;e.moveToPoint(this.warpPoint(s.getPoint(0).transformPoint(r))),s.forEachSegment(((t,s,n)=>{const o=s||P.InterpolateLinear(t,n,.5),a=i>0?Math.max(1,Math.ceil(Math.abs(n.x-t.x)/i)):1;for(let i=0;i<a;i++){const s=this.warpPoint(P.InterpolateQuadratic(t,o,n,i/a).transformPoint(r)),l=this.warpPoint(P.InterpolateQuadratic(t,o,n,(i+.5)/a).transformPoint(r)),h=this.warpPoint(P.InterpolateQuadratic(t,o,n,(i+1)/a).transformPoint(r)),c=l.add(l.subtract(P.InterpolateLinear(s,h,.5)));e.quadBezierToPoint(c,h)}return!0})),s.isClosed&&e.close(),t.push(e.createFigure())}return new V({figures:t,fillMode:e.fillMode,lineEnabled:e.lineEnabled,extrusionEnabled:e.extrusionEnabled,transform:void 0})}}class je{constructor(e,t,i,r){this.image=e,this.rect=t,this.transform=i,this.useLocalCordinates=!!r}equals(e){return this.image==e.image&&this.rect==e.rect}}class Xe{constructor(e,t,i,r,s,n){this.layoutBounds=e,this.paths=t instanceof Array?t.slice(0):t,this.outlinePath=n instanceof Array?n.slice(0):n,this.forceWarping=i,this.isWhiteSpace=r,this.textImage=s}equals(e){if(!this.layoutBounds.equals(e.layoutBounds))return!1;if(!this.paths&&!e.paths)return!0;if(this.paths instanceof V&&e.paths instanceof V)return this.paths.equals(e.paths);if(this.paths instanceof Array&&e.paths instanceof Array){if(this.paths.length!=e.paths.length)return!1;for(let t=0;t<this.paths.length;t++)if(!this.paths[t].equals(e.paths[t]))return!1;return!0}return!this.paths&&!e.paths}getTranslatedCopy(e){let t;if(this.paths instanceof V)t=new V(this.paths,this.paths.transform.applyTranslationAfter(e));else if(this.paths){t=new Array(this.paths.length);for(let i=0;i<this.paths.length;i++)t[i]=new V(this.paths[i],this.paths[i].transform.applyTranslationAfter(e))}return new Xe(this.layoutBounds.translate(e),t,this.forceWarping)}}class Ye{constructor(e,t,i,r){this.m_changeTracker=new pe,this.m_character=e,this.style=t,this.effects=i,this.strokes=r}clone(){const e=new Ye(this.m_character,this.m_style?this.m_style.clone():void 0,this.m_effects?this.m_effects.clone():void 0);if(this.m_strokes){e.m_strokes=new fe;for(let t of this.m_strokes.elements)e.m_strokes.push(t.clone())}return e}get character(){return this.m_character}get style(){return this.m_style}get effects(){return this.m_effects}get strokes(){return this.m_strokes}get changeTracker(){return this.m_changeTracker}set character(e){this.m_character.equals(e)||(this.m_changeTracker.notifyChange(),this.m_character=e)}set style(e){this.m_changeTracker.replaceListener(this.m_style,e),this.m_style=e}set effects(e){this.m_changeTracker.replaceListener(this.m_effects,e),this.m_effects=e}set strokes(e){this.m_changeTracker.replaceListener(this.m_strokes,e),this.m_strokes=e}equals(e){return!!this.m_character.equals(e.m_character)&&this.m_style==e.m_style&&this.m_effects==e.effects&&this.m_strokes==e.m_strokes}}class Ke{constructor(e,t,i){this.ascent=e,this.descent=t,this.fontHeightInPoints=i}equals(e){return this.ascent==e.ascent&&this.descent==e.descent&&this.fontHeightInPoints==e.fontHeightInPoints}}class Ze{constructor(e,t){this.m_changeTracker=new pe,this.m_characters=[],this.m_localRange=e,this.m_layoutBounds=t,this.m_fillBounds=t,this.m_offset=P.Zero}clone(){const e=new Ze(this.m_localRange,this.m_layoutBounds);for(let t of this.m_characters)e.addCharacter(t);return e.m_offset=this.m_offset,e.m_fillBounds=this.m_fillBounds,e.m_textEffectMetrics=this.m_textEffectMetrics,e.bender=this.m_bender,e}get characters(){return this.m_characters}get localRange(){return this.m_localRange}get offset(){return this.m_offset}get layoutBounds(){return this.m_layoutBounds}get fillBounds(){return this.m_fillBounds}get textEffectMetrics(){return this.m_textEffectMetrics}get bender(){return this.m_bender}get changeTracker(){return this.m_changeTracker}get flowDirection(){return 0==this.m_characters.length?0:Math.sign(this.m_characters[this.m_characters.length-1].layoutBounds.left-this.m_characters[0].layoutBounds.left)}set localRange(e){ge(this.m_changeTracker,this.m_localRange,e),this.m_localRange=e}set offset(e){ge(this.m_changeTracker,this.m_offset,e),this.m_offset=e}set layoutBounds(e){ge(this.m_changeTracker,this.m_layoutBounds,e),this.m_layoutBounds=e}set fillBounds(e){ge(this.m_changeTracker,this.m_fillBounds,e),this.m_fillBounds=e}set textEffectMetrics(e){ge(this.m_changeTracker,this.m_textEffectMetrics,e),this.m_textEffectMetrics=e}set bender(e){this.bender==e||this.bender instanceof We&&e instanceof We&&this.bender.equals(e)||this.bender instanceof qe&&e instanceof qe&&this.bender.equals(e)||(this.m_changeTracker.notifyChange(),this.m_bender=e)}set characters(e){ve(this.m_changeTracker,this.m_characters,e),this.m_characters=e.slice(0)}removeAllCharacters(){this.characters=[]}addCharacter(e){this.m_changeTracker.notifyChange(),this.m_characters.push(e)}}class Je{constructor(e,t){this.m_lines=[],this.m_localWordRanges=[],this.m_changeTracker=new pe,this.m_globalRange=e,this.m_stylePerLocalRange=new Ne(t),this.m_effectsPerLocalRange=new Ne(new Le),this.m_strokesPerLocalRange=new Ne(new fe),this.m_changeTracker.replaceListener(void 0,this.m_stylePerLocalRange),this.m_offset=P.Zero}clone(){const e=new Je(this.m_globalRange,this.m_stylePerLocalRange.defaultData);for(let t of this.m_lines)e.addLine(t.clone());e.m_offset=this.m_offset,e.bullet=this.m_bullet?this.m_bullet.clone():void 0;for(let t of this.m_stylePerLocalRange.ranges)e.m_stylePerLocalRange.set(this.m_stylePerLocalRange.getAt(t.start).clone(),t);e.m_effectsPerLocalRange.defaultData=this.m_effectsPerLocalRange.defaultData;for(let t of this.m_effectsPerLocalRange.ranges)e.m_effectsPerLocalRange.set(this.m_effectsPerLocalRange.getAt(t.start).clone(),t);e.m_strokesPerLocalRange.defaultData=this.m_strokesPerLocalRange.defaultData;for(let t of this.m_strokesPerLocalRange.ranges){const i=this.m_strokesPerLocalRange.getAt(t.start),r=new fe;for(let e of i.elements)r.push(e.clone());e.m_strokesPerLocalRange.set(r,t)}return e.m_localWordRanges=this.m_localWordRanges.slice(0),e}get lines(){return this.m_lines}get stylePerLocalRange(){return this.m_stylePerLocalRange}get effectsPerLocalRange(){return this.m_effectsPerLocalRange}get strokesPerLocalRange(){return this.m_strokesPerLocalRange}get globalRange(){return this.m_globalRange}get offset(){return this.m_offset}get bullet(){return this.m_bullet}get localWordRanges(){return this.m_localWordRanges}get changeTracker(){return this.m_changeTracker}set stylePerLocalRange(e){this.m_changeTracker.replaceListener(this.m_stylePerLocalRange,e),this.m_stylePerLocalRange=e}set effectsPerLocalRange(e){this.m_changeTracker.replaceListener(this.m_effectsPerLocalRange,e),this.m_effectsPerLocalRange=e}set strokesPerLocalRange(e){this.m_changeTracker.replaceListener(this.m_strokesPerLocalRange,e),this.m_strokesPerLocalRange=e}set globalRange(e){this.m_globalRange.equals(e)||(this.m_changeTracker.notifyChange(),this.m_globalRange=e)}set offset(e){ge(this.m_changeTracker,this.m_offset,e),this.m_offset=e}set bullet(e){this.m_changeTracker.replaceListener(this.m_bullet,e),this.m_bullet=e}set localWordRanges(e){ve(this.m_changeTracker,this.m_localWordRanges,e),this.m_localWordRanges=e.slice(0)}removeAllLocalWordRanges(){this.localWordRanges=[]}addLocalWordRange(e){this.m_changeTracker.notifyChange(),this.m_localWordRanges.push(e)}set lines(e){this.removeAllLines();for(let t of e)this.addLine(t)}removeAllLines(){for(let e of this.m_lines)pe.RemoveListener(e.changeTracker,this.m_changeTracker);this.m_lines=[]}addLine(e){pe.AddListener(e.changeTracker,this.m_changeTracker),this.m_lines.push(e)}}class Qe{constructor(){this.m_paragraphs=[],this.m_changeTracker=new pe,this.m_animationChangeTracker=new pe,this.m_selectionChangeTracker=new pe,this.m_layoutToFrame=M.Identity,this.m_frameToShape=M.Identity,this.m_renderMode=0}clone(){const e=new Qe;for(let t of this.m_paragraphs)e.addParagraph(t.clone());if(e.m_layoutToFrame=this.m_layoutToFrame,e.m_frameToShape=this.m_frameToShape,this.m_animationProps){e.m_animationProps=new Ne(new ze),e.m_animationProps.defaultData=this.m_animationProps.defaultData;for(let t of this.m_animationProps.ranges)e.m_animationProps.set(this.m_animationProps.getAt(t.start).clone(),t)}if(this.m_selectionHighlights){e.m_selectionHighlights=[];for(let t of this.m_selectionHighlights)e.m_selectionHighlights.push(t.clone())}return e}createAnimationProps(){this.animationProps=new Ne(new ze)}hasAnimationProps(){return!!this.animationProps}get paragraphs(){return this.m_paragraphs}get layoutToFrame(){return this.m_layoutToFrame}get frameToShape(){return this.m_frameToShape}get animationProps(){return this.m_animationProps}get selectionHighlights(){return this.m_selectionHighlights}get clipBounds(){return this.m_clipBounds}get applyEffectsPerCharacter(){return!!this.m_applyEffectsPerCharacter}get changeTracker(){return this.m_changeTracker}get animationChangeTracker(){return this.m_animationChangeTracker}get textVersion(){return this.m_changeTracker.version}get selectionVersion(){return this.m_selectionChangeTracker.version}get renderMode(){return this.m_renderMode}get linesCutoutMargin(){return this.m_linesCutoutMargin||P.Zero}get spreadFill(){return!!this.m_spreadFill}set layoutToFrame(e){ge(this.m_changeTracker,this.m_layoutToFrame,e),this.m_layoutToFrame=e}set frameToShape(e){ge(this.m_changeTracker,this.m_frameToShape,e),this.m_frameToShape=e}set selectionHighlights(e){!function(e,t,i){if(t!=i)if(t&&i&&t.length==i.length){for(let r=0;r<t.length;r++)if(t[r]!=i[r])return void e.notifyChange()}else e.notifyChange()}(this.m_selectionChangeTracker,this.m_selectionHighlights,e),this.m_selectionHighlights=e?e.slice(0):void 0}set clipBounds(e){ge(this.m_changeTracker,this.m_clipBounds,e),this.m_clipBounds=e}set applyEffectsPerCharacter(e){me(this.m_changeTracker,!!this.m_applyEffectsPerCharacter,e),this.m_applyEffectsPerCharacter=e}set animationProps(e){this.m_animationProps!=e&&(this.m_animationProps&&(pe.RemoveListener(this.m_animationProps.changeTracker,this.m_animationChangeTracker),pe.RemoveListener(this.m_animationProps.rangeChangeTracker,this.m_changeTracker)),e&&(pe.AddListener(e.changeTracker,this.m_animationChangeTracker),pe.AddListener(e.rangeChangeTracker,this.m_changeTracker)),this.m_animationProps=e)}set paragraphs(e){if(this.m_paragraphs!=e){this.removeAllParagraphs();for(let t of e)this.addParagraph(t)}}set renderMode(e){me(this.m_changeTracker,this.m_renderMode,e),this.m_renderMode=e}set linesCutoutMargin(e){ge(this.m_changeTracker,this.m_linesCutoutMargin,e),this.m_linesCutoutMargin=e}set spreadFill(e){me(this.m_changeTracker,!!this.m_spreadFill,e),this.m_spreadFill=e}forceSplit(e){(!this.m_explicitTextSplit||e>this.m_explicitTextSplit)&&(this.m_changeTracker.notifyChange(),this.m_explicitTextSplit=e)}removeAllParagraphs(){for(let e of this.m_paragraphs)pe.RemoveListener(e.changeTracker,this.m_changeTracker);this.m_paragraphs=[]}addParagraph(e){pe.AddListener(e.changeTracker,this.m_changeTracker),this.m_paragraphs.push(e)}removeParagraph(e){pe.RemoveListener(this.m_paragraphs[e].changeTracker,this.m_changeTracker),this.m_paragraphs.splice(e)}getFullRange(){return this.paragraphs.length<1?void 0:Ue.FromFirstLast(this.paragraphs[0].globalRange.start,this.paragraphs[this.paragraphs.length-1].globalRange.last)}getRunRanges(){const e=this.getFullRange();if(e){let t=[];for(const e of this.paragraphs)if(2==this.m_explicitTextSplit||this.applyEffectsPerCharacter)for(let i=e.globalRange.start;i<=e.globalRange.last;i++)et(t,i);else{const i=e.globalRange.start;for(let r of e.lines)et(t,i+r.localRange.start),et(t,i+r.localRange.last+1);for(let r of e.stylePerLocalRange.ranges)et(t,i+r.start),et(t,i+r.last+1);for(let r of e.effectsPerLocalRange.ranges)et(t,i+r.start),et(t,i+r.last+1);for(let r of e.strokesPerLocalRange.ranges)et(t,i+r.start),et(t,i+r.last+1);if(1==this.m_explicitTextSplit)for(let r of e.localWordRanges)et(t,i+r.start),et(t,i+r.last+1)}if(this.animationProps)for(let e of this.animationProps.ranges)t.some((t=>t==e.start))||t.push(e.start),t.some((t=>t==e.last+1))||t.push(e.last+1);return tt(t,e)}return[]}getAnimatablePartRanges(e,t,i){let r=t||this.getFullRange();if(!r||0==r.length)return;if(t&&i){if(t.start<0||t.start>=this.paragraphs.length||t.last<0||t.last>=this.paragraphs.length)return void O.Error(592525336,"bad paragraph range");r=Ue.FromFirstLast(this.paragraphs[t.start].globalRange.start,this.paragraphs[t.last].globalRange.last)}if(0==e)return r?[r]:void 0;let s=[];for(let t of this.paragraphs){const i=t.globalRange.start;for(let r of t.lines)if(et(s,i+r.localRange.start),et(s,i+r.localRange.last+1),2==e){const e=i+r.localRange.start;let t=!1;for(let i=0;i<r.characters.length;i++)t||et(s,e+i),t=1==r.characters[i].isWhiteSpace}if(1==e)for(let e of t.localWordRanges)et(s,i+e.start)}return tt(s,r)}getTextPathsForCharacter(e,t,i,r){const s=[],n=r&&e.outlinePath?e.outlinePath:e.paths,o=n instanceof V?[n]:null!=n?n:[];for(let r of o)if(r.figures.length>0){const n=E.Translation2D(t).multiply(this.layoutToFrame.toMatrix3());let o=r.transform.toMatrix3().multiply(n).tryGetTransform(r.transform.preTranslation);if(!o)throw O.Error(592525337,"unexpected transform");{let t=new V(r,o),a=i instanceof qe?i:void 0;if(i instanceof We){const s=e.layoutBounds.isEmpty()?void 0:e.layoutBounds.transformedBounds(n);if(e.forceWarping||!s)a=i.equivalentWarpingEnvelope;else{const e=i.getTransform(s);e&&(o=o.toMatrix3().multiply(e.toMatrix3()).tryGetTransform(r.transform.preTranslation),t=o?new V(r,o):void 0)}}a&&t&&(t=a.warpPath(t)),t&&s.push(t)}}return s}getTextPathsForRange(e,t){const i=[];for(let r of this.paragraphs)if(r.globalRange.intersects(e))for(let s of r.lines){const n=new Ue(0,s.characters.length).getIntersection(e.move(-r.globalRange.start-s.localRange.start));if(n)for(let e=n.start;e<=n.last;e++){const n=this.getTextPathsForCharacter(s.characters[e],s.offset.add(r.offset),s.bender,t);i.push(...n)}}return i}getLineAndParagraphAt(e){for(let t of this.paragraphs)if(t.globalRange.includes(e)){const i=e-t.globalRange.start;for(let e of t.lines)if(e.localRange.includes(i))return{line:e,paragraph:t}}}getStyleAt(e){for(let t of this.paragraphs)if(t.globalRange.includes(e))return t.stylePerLocalRange.getAt(e-t.globalRange.start)}getEffetcsAt(e){for(let t of this.paragraphs)if(t.globalRange.includes(e))return t.effectsPerLocalRange.getAt(e-t.globalRange.start)}getStrokesAt(e){for(let t of this.paragraphs)if(t.globalRange.includes(e))return t.strokesPerLocalRange.getAt(e-t.globalRange.start)}getPathFromLayoutRect(e,t,i){const r=E.Translation2D(i).multiply(this.layoutToFrame.toMatrix3()).tryGetTransform(P.Zero);if(r){let i=new V({figures:[z.CreateFromRect(e)],transform:r});const s=t.bender instanceof We?t.bender.equivalentWarpingEnvelope:t.bender;return s&&(i=s.warpPath(i)),i}}getSelectionRectPaths(e){let t;for(let i of this.paragraphs){const r=e?e.move(-i.globalRange.start):void 0;for(let e of i.lines){let s;if(!r||e.characters&&r.intersects(e.localRange))for(let t=0;t<e.characters.length;t++){const i=e.localRange.start+t;(!r||r.start<=i&&i<=r.last)&&(s=R.UnionRect(s,e.characters[t].layoutBounds))}if(s){const r=this.getPathFromLayoutRect(s,e,e.offset.add(i.offset));r&&(t||(t=[]),t.push(r))}}}return t}getCutoutLinePath(e,t){let i;const r=[];for(let i of this.paragraphs){const s=e?e.move(-i.globalRange.start):void 0;for(let e of i.lines){let n;if(!s||e.characters&&s.intersects(e.localRange))for(let t=0;t<e.characters.length;t++){const i=e.localRange.start+t;(!s||s.start<=i&&i<=s.last)&&(n=R.UnionRect(n,e.characters[t].layoutBounds))}if(n){const t=e.offset.add(i.offset),r=E.Translation2D(t).multiply(this.layoutToFrame.toMatrix3());n=n.transformedBounds(r)}e.bender&&O.Error(528320162,"LinesCutout currently not supported with Benders."),n&&r.push(new R(n.left-t.x,n.top-t.y,n.right+t.x,n.bottom+t.y))}}if(r.length>0){const e=new H;e.moveTo(r[0].left,r[0].top),e.lineTo(r[0].right,r[0].top);for(let t=0;t<r.length-1;t++){const i=r[t].right,s=r[t+1].right,n=i>s?r[t].bottom:r[t+1].top;e.lineTo(i,n),e.lineTo(s,n)}e.lineTo(r[r.length-1].right,r[r.length-1].bottom),e.lineTo(r[r.length-1].left,r[r.length-1].bottom);for(let t=r.length-1;t>0;t--){const i=r[t].left,s=r[t-1].left,n=i<s?r[t].top:r[t-1].bottom;e.lineTo(i,n),e.lineTo(s,n)}e.close(),i=[V.CreateFromFigure(e.createFigure())]}return i}getBoundsOfRange(e,t,i=!1){if(!i||!this.animationProps)return this.getBoundsOfRangeStatic(e,t);let r=this.getFullRange();if(!r)return;let s=[];for(let e of this.animationProps.ranges)et(s,e.start),et(s,e.last+1);const n=tt(s,r);let o;for(let e of n){const i=this.animationProps.getAt(e.start).animationTransform,r=t&&i?t.toMatrix3().multiply(i):t||i;o=R.UnionRect(o,this.getBoundsOfRangeStatic(e,r))}return o}getBoundsOfRangeStatic(e,t){let i;const r=t?this.frameToShape.toMatrix3().multiply(t.toMatrix3()):this.frameToShape;let s=this.getSelectionRectPaths(e);for(let t of this.paragraphs)if(t.bullet&&t.lines.length>0&&(!e||e.includes(t.globalRange.start))){const e=this.getPathFromLayoutRect(t.bullet.character.layoutBounds,t.lines[0],t.offset);e&&(s=s?s.concat(e):[e])}for(let e of s||[])e.untransformedBounds&&(i=R.UnionRect(i,e.untransformedBounds.transformedBounds(e.transform.toMatrix3().multiply(r.toMatrix3()))));return i}getSelectionLayoutCaretPath(e,t,i){for(let r of this.paragraphs){const s=e-r.globalRange.start;for(let e of r.lines){e.localRange.length!=e.characters.length&&O.Error(592525338,"character count mismatch");const n=s-e.localRange.start;let o;if(0<=n&&n<e.characters.length){const i=e.characters[n].layoutBounds,r=e.flowDirection>0?i.left:i.right;o=new R(r-.5*t,i.top,r+.5*t,i.bottom)}else if(0==n&&0==e.characters.length){const i=e.flowDirection>0?e.layoutBounds.left:e.layoutBounds.right;o=new R(i-.5*t,e.layoutBounds.top,i+.5*t,e.layoutBounds.bottom)}else if(i&&s==e.localRange.last+1){const i=e.characters[e.characters.length-1].layoutBounds,r=e.flowDirection>0?i.right:i.left;o=new R(r-.5*t,i.top,r+.5*t,i.bottom)}if(o)return this.getPathFromLayoutRect(o,e,e.offset.add(r.offset))}}}getLineAndParagraphFromLayoutPosition(e){let t,i;for(let r of this.paragraphs)for(let s of r.lines){if(e.subtract(r.offset).subtract(s.offset).y<s.layoutBounds.bottom)return{paragraph:r,line:s};t=s,i=r}return{paragraph:i,line:t}}getSelectionFromLayoutPosition(e){const t=this.getLineAndParagraphFromLayoutPosition(e);if(!t.paragraph||!t.line||!t.line.characters)return;const i=e.subtract(t.paragraph.offset).subtract(t.line.offset);for(let e=0;e<t.line.characters.length;e++)if(i.x<(t.line.characters[e].layoutBounds.right+t.line.characters[e].layoutBounds.left)/2)return{characterIndex:t.paragraph.globalRange.start+t.line.localRange.start+e,isAnchoredToPrevious:!1};return{characterIndex:t.paragraph.globalRange.start+t.line.localRange.last+1,isAnchoredToPrevious:!0}}hitTest(e){for(let t of this.paragraphs)for(let i of t.lines||[]){const r=e.subtract(t.offset).subtract(i.offset);if(i.layoutBounds.isPointInRect(r))return!0}return!1}getBrushImages(){const e=[];for(let t of this.paragraphs){t.bullet&&t.bullet.style&&e.push(...t.bullet.style.getBrushImages()),t.stylePerLocalRange.allData.forEach((t=>{e.push(...t.getBrushImages())})),t.strokesPerLocalRange.allData.forEach((t=>{for(let i of t.elements)i.style&&e.push(...i.style.getBrushImages())}));for(let i of t.lines)for(let t of i.characters)t.textImage&&e.push(t.textImage.image)}return e}}function et(e,t){e.some((e=>e==t))||e.push(t)}function tt(e,t){et(e,t.start),et(e,t.last+1),e.sort(((e,t)=>e-t));const i=[];for(let r=0;r<e.length-1;r++){const s=Ue.FromFirstLast(e[r],e[r+1]-1).getIntersection(t);s&&s.length>0&&i.push(s)}return i}class it{constructor(){this.textShapes=[],this.hitTestLineShapes=[]}clearCache(){for(let e of this.textShapes)e.clearCache();for(let e of this.hitTestLineShapes)e.clearCache();for(let e of this.selectionShapes||[])e.clearCache()}getTextShapes(){return this.textShapes}getSelectionShapes(){return this.selectionShapes||[]}initShapeEffectsAndBoundsOverrides(e,t,i,r,s,n){if(t.effects=function(e,t,i){if(!e)return;const r=t?t.fontHeightInPoints:0,s=e.clone(),n=0==r?1:r/gt;return s.glow&&(s.glow.radius=ot(s.glow.radius,r,at,lt,ht)/2),s.shadow&&(s.shadow.radius=ot(s.shadow.radius,r,ct,dt,ut),s.shadow.distance=ot(s.shadow.distance,r,ct,dt,ut)),s.innerShadow&&(s.innerShadow.radius=ot(s.innerShadow.radius,r,ft,pt,mt),s.innerShadow.distance=ot(s.innerShadow.distance,r,ft,pt,mt)),s.reflection&&(s.reflection.radius*=n,t&&(s.reflection.distance*=0!=t.ascent&&0!=t.descent?r*t.descent/t.ascent/vt:n)),s.softEdges&&(s.softEdges.radius*=n),s.direction=i,s}(e.getEffetcsAt(s),i?i.textEffectMetrics:void 0,-e.frameToShape.rotation)||new Le,!i.bender){if(e.applyEffectsPerCharacter||n){const i=e.getBoundsOfRange(new Ue(s,1));t.effectsBoundsOverride=i,n&&t.style.fillBrush instanceof Ce||(t.fillBoundsOverride=i)}else{const s=i.fillBounds.translate(r).transformedBounds(E.FromTransforms(e.layoutToFrame,e.frameToShape));t.effectsBoundsOverride=s,t.fillBoundsOverride=e.spreadFill?e.getBoundsOfRange(void 0):s}t.textEffectMetrics=i.textEffectMetrics}}getTextShape(e,t){const i=e.getStyleAt(t.start),r=e.getTextPathsForRange(t,null==i?void 0:i.hasLine),s=new bt(r,i),n=e.getLineAndParagraphAt(t.start);return n&&this.initShapeEffectsAndBoundsOverrides(e,s,n.line,n.line.offset.add(n.paragraph.offset),t.start,!1),s.role=3,s.textRange=t,s.overlapMode=1,s.transform=e.frameToShape,s}getStrokeShape(e,t,i){const r=new bt(this.getStrokePaths(e,t,i),i.style?i.style:e.getStyleAt(t.start)),s=e.getLineAndParagraphAt(t.start);return s&&this.initShapeEffectsAndBoundsOverrides(e,r,s.line,s.line.offset.add(s.paragraph.offset),t.start,!1),r.role=3,r.textRange=t,r.overlapMode=1,r.transform=e.frameToShape,r}getSelectionHighlightShapes(e){if(!e.selectionHighlights)return;const t=[];for(let i of e.selectionHighlights)if(i.range.length>0){let r=e.getSelectionRectPaths(i.range);r&&t.push(new bt(r,i.style))}else{let r=e.getSelectionLayoutCaretPath(i.range.start,i.caretWidth,i.isAnchoredToPrevious);r&&t.push(new bt([r],i.style))}return t}update(e){if(e.textVersion!=this.lastKnownTextVersion){this.lastKnownTextVersion=e.textVersion,this.clearCache(),this.textShapes=[],this.hitTestLineShapes=[];const t=[],i=[];0!=e.renderMode&&(this.cutoutLayerPaths=void 0);for(let r of e.paragraphs)if(r.bullet){const s=e.getLineAndParagraphAt(r.globalRange.start);if(s){const n=new Ue(r.globalRange.start,0);for(let s of r.bullet.strokes?r.bullet.strokes.elements:[])0==s.type?t.push(this.getStrokeShape(e,n,s)):i.push(this.getStrokeShape(e,n,s));const o=e.getTextPathsForCharacter(r.bullet.character,r.offset,r.lines.length>0?r.lines[0].bender:void 0),a=new bt(o,r.bullet.style?r.bullet.style:e.getStyleAt(n.start));this.initShapeEffectsAndBoundsOverrides(e,a,s.line,s.paragraph.offset,n.start,!0),a.role=3,a.textRange=new Ue(r.globalRange.start,0),a.transform=e.frameToShape,i.push(a)}}const r=e.getSelectionRectPaths(void 0);for(let t of r||[]){const i=new bt([t],new Me(new we(_e.Black)));i.transform=e.frameToShape,this.hitTestLineShapes.push(i)}const s=e.getRunRanges(),n=[];for(let t of s){const i=e.getBoundsOfRange(t);if(i&&i.width>2048){const e=Math.ceil(i.width/2048);for(let i=0;i<e;i++){const r=Math.floor(t.start+i*t.length/e),s=i==e-1?t.last+1:Math.floor(t.start+(i+1)*t.length/e);r<s&&n.push(Ue.FromFirstLast(r,s-1))}}else n.push(t)}for(let t of n)i.push(this.getTextShape(e,t));for(let r of n){const s=e.getStrokesAt(r.start);for(let n of s?s.elements:[])0==n.type?t.push(this.getStrokeShape(e,r,n)):i.push(this.getStrokeShape(e,r,n))}for(let t of e.paragraphs)for(let r of t.lines)for(let s=0;s<r.characters.length;s++){const n=r.characters[s];if(n.textImage){let o=z.CreateFromRect(n.textImage.rect);n.textImage.useLocalCordinates&&(o=o.transform(E.FromTransforms(n.textImage.transform,E.Translation2D(r.offset.add(t.offset)),e.layoutToFrame)));const a=new bt([new V({figures:[o]})],new Me(new Ce(n.textImage.image)));a.role=n.textImage.useLocalCordinates?3:4,a.textRange=new Ue(s+r.localRange.start+t.globalRange.start,1),a.transform=n.textImage.useLocalCordinates?e.frameToShape:n.textImage.transform,i.push(a)}}if(ce){for(let t of e.paragraphs)for(let r of t.lines)if(r.bender instanceof qe){const s=new bt([V.CreateFromFigure(r.bender.topPath)],new Me(void 0,new we(_e.Cyan),new Ee(1))),n=new bt([V.CreateFromFigure(r.bender.bottomPath)],new Me(void 0,new we(_e.Magenta),new Ee(1)));s.textRange=n.textRange=r.localRange.move(t.globalRange.start),s.transform=e.frameToShape,n.transform=e.frameToShape,i.push(s),i.push(n)}else if(r.bender instanceof We){const s=new bt([V.CreateFromFigure(r.bender.path)],new Me(void 0,new we(_e.Yellow),new Ee(1)));s.textRange=r.localRange.move(t.globalRange.start),s.transform=e.frameToShape,i.push(s)}const t=e.getAnimatablePartRanges(2,void 0,!0);for(let r of t||[]){const t=e.getBoundsOfRange(r);if(t){const e=new bt([V.CreateFromRect(t)],new Me(void 0,new we(_e.Blue),new Ee(1)));e.textRange=r,i.push(e)}}for(let t of e.paragraphs)for(let r of t.lines){const s=r.fillBounds.translate(r.offset.add(t.offset)).transformedBounds(E.FromTransforms(e.layoutToFrame,e.frameToShape));if(s&&r.textEffectMetrics){const e=new R(s.left,s.top,s.right,s.top+r.textEffectMetrics.ascent),n=new R(s.left,s.bottom-r.textEffectMetrics.descent,s.right,s.bottom),o=new bt([V.CreateFromRect(e)],new Me(void 0,new we(_e.Red),new Ee(1))),a=new bt([V.CreateFromRect(n)],new Me(void 0,new we(_e.Green),new Ee(1)));o.textRange=r.localRange.move(t.globalRange.start),a.textRange=r.localRange.move(t.globalRange.start),i.push(o),i.push(a)}}}this.textShapes.push(...t),this.textShapes.push(...i);for(let t of this.textShapes)if(4==t.role){if(e.clipBounds){const i=t.getBounds(!1,!1,!0),r=null==i?void 0:i.transformedBounds(e.frameToShape.toInverseMatrix3()),s=r?e.clipBounds.clip(r):void 0,n=null==s?void 0:s.transformedBounds(e.frameToShape.toMatrix3().multiply(t.transform.toInverseMatrix3()));t.clipBounds=n?B.CreateFromRect(n):void 0,n||(t.paths=[])}}else t.clipBounds=e.clipBounds;if(0!=e.renderMode){if(this.cutoutLayerPaths=[],3==e.renderMode){const t=e.getCutoutLinePath(void 0,e.linesCutoutMargin);for(let e of t||[])this.cutoutLayerPaths.push(e)}for(let e of t)this.cutoutLayerPaths.push(...e.paths||[]);for(let e of i)this.cutoutLayerPaths.push(...e.paths||[])}}if(e.selectionVersion!=this.lastKnownSelectionVersion){this.lastKnownSelectionVersion=e.selectionVersion;const t=this.getSelectionHighlightShapes(e);if(t){if(this.selectionShapes=[],new Me(new we(_e.White)).blendingMode=2,t){this.selectionShapes.push(...t);for(let t of this.selectionShapes)t.transform=e.frameToShape}}else{for(let e of this.selectionShapes||[])e.clearCache();this.selectionShapes=void 0}}}getStrokePaths(e,t,i){const r=[];for(let s of e.paragraphs)if(s.globalRange.intersects(t))for(let n of s.lines){let o,a;const l=new Ue(0,n.characters.length).getIntersection(t.move(-s.globalRange.start-n.localRange.start));if(l)for(let e=l.start;e<=l.last;e++){const t=n.characters[e].layoutBounds;t.isEmpty()||(o=null==o?t.left:Math.min(o,t.left),a=null==a?t.right:Math.max(a,t.right))}if(null!=o&&null!=a&&o<a){const t=E.Translation2D(n.offset.add(s.offset)).multiply(e.layoutToFrame.toMatrix3()).tryGetTransform(P.Zero);if(t){let e=new V({figures:nt(i,o,a),transform:t});const s=n.bender instanceof We?n.bender.equivalentWarpingEnvelope:n.bender;s&&(e=s.warpPath(e)),r.push(e)}}}return r}}function rt(e,t,i){const r=t.y-i,s=Math.ceil(t.x/(2*r));let n=e.x;const o=new H;o.moveTo(n,e.y),o.lineTo(n,e.y+i);for(let a=0;a<s;a++)n+=r,o.lineTo(n,e.y+t.y),n+=r,o.lineTo(n,e.y+i);o.lineTo(n,e.y);for(let a=0;a<s;a++)n-=r,o.lineTo(n,e.y+t.y-i),n-=r,o.lineTo(n,e.y);return o.close(),o.createFigure()}function st(e,t,i,r,s,n){const o=[];let a=e.x;const l=t.y,h=t.y*i,c=t.y*r,d=n?e.y-t.y:e.y,u=n?e.y+t.y/2:e.y+t.y;let f=0;for(;a<e.x+t.x;){const i=s&&f%(s+1)!=0?l:h,r=Math.min(a+i,t.x+e.x);o.push(z.CreateFromRect(new R(a,d,r,u))),a+=c+i,f++}return o}function nt(e,t,i){const r=new P(t,e.verticalCenter-.5*e.thickness),s=new P(i-t,e.thickness),n=[],o=3==e.type||5==e.type||7==e.type||9==e.type||11==e.type||13==e.type||15==e.type;switch(e.type){case 3:case 1:case 0:o?n.push(z.CreateFromRect(new R(r.x,r.y-s.y,r.x+s.x,r.y+Math.ceil(s.y/2)))):n.push(z.CreateFromRect(new R(r.x,r.y,r.x+s.x,r.y+s.y)));break;case 2:{const e=!1;n.push(...function(e,t,i){const r=[];return i?(r.push(z.CreateFromRect(new R(e.x,e.y,e.x+t.x,e.y+t.y/2))),r.push(z.CreateFromRect(new R(e.x,e.y+t.y,e.x+t.x,e.y+3*t.y/2)))):(r.push(z.CreateFromRect(new R(e.x,e.y-t.y,e.x+t.x,e.y-t.y/2))),r.push(z.CreateFromRect(new R(e.x,e.y+t.y/2,e.x+t.x,e.y+t.y)))),r}(r,s,e));break}case 5:case 4:n.push(...st(r,s,1,1,1,o));break;case 7:case 6:n.push(...st(r,s,3,2,0,o));break;case 9:case 8:n.push(...st(r,s,7,4,0,o));break;case 10:case 11:n.push(...st(r,s,3,2,1,o));break;case 12:case 13:n.push(...st(r,s,3,2,2,o));break;case 14:case 15:{let t=2*s.y,i=1;15==e.type&&(t=Math.floor(Math.max(3,2*s.y)),i=Math.max(2,Math.floor(s.y/2))),n.push(rt(new P(r.x,r.y-Math.ceil(s.y/2)),new P(s.x,t),i))}break;case 16:{const e=1,t=Math.max(2,s.y),i=r.y-t;n.push(rt(new P(r.x,i),new P(s.x,t),e)),n.push(rt(r,new P(s.x,t),e))}break;default:O.Error(591525085,"Unknown stroke type")}return n}function ot(e,t,i,r,s){return 0!=t&&s<e?(e-s)*Math.pow(t,r)/Math.pow(i,r)+s:0==t?e:0}const at=72,lt=.7,ht=1,ct=72,dt=.7,ut=.4,ft=108,pt=1,mt=.001,gt=72,vt=4;class _t{constructor(e,t){this.transform=e,this.opacity=null==t?void 0:t.opacity,this.colorMatrix=null==t?void 0:t.colorMatrix,this.colorOffset=null==t?void 0:t.colorOffset,this.colorize=null==t?void 0:t.colorize,this.groupIndex=null==t?void 0:t.groupIndex}}_t.DefaultArray=[new _t(E.Identity)];class yt{constructor(e=new Le,t=M.Identity,i){this.m_animationChangeTracker=new pe,this.renderDataMap={},this.m_changeTracker=new pe(i),this.m_alphaTracker=new pe(i),this.m_changeTracker.replaceListener(void 0,e),this.m_alphaTracker.replaceListener(void 0,e),this.m_effects=e,this.m_isHidden=!1,this.m_transform=t,null==U||U.register(this,this.renderDataMap)}cloneItemData(e){var t,i;e.effects=this.m_effects.clone(),e.m_transform=this.m_transform,e.fade=this.m_fade?this.m_fade.clone():void 0,e.m_animationTransform=this.m_animationTransform,e.m_fillBoundsOverride=this.m_fillBoundsOverride,e.m_effectsBoundsOverride=this.m_effectsBoundsOverride,e.m_scene3D=this.m_scene3D,e.m_isHidden=this.m_isHidden,e.m_instanceOffsets=null===(t=this.m_instanceOffsets)||void 0===t?void 0:t.slice(0),e.m_instances=null===(i=this.m_instances)||void 0===i?void 0:i.slice(0),e.m_clipBounds=this.m_clipBounds,e.clientData=this.clientData}get changeTracker(){return this.m_changeTracker}get animationChangeTracker(){return this.m_animationChangeTracker}get alphaTracker(){return this.m_alphaTracker}notifyChange(){this.m_changeTracker.notifyChange()}get version(){return this.m_changeTracker.version}get effects(){return this.m_effects}get transform(){return this.m_transform}get isHidden(){return this.m_isHidden}get instanceOffsets(){return this.m_instanceOffsets}get instances(){return this.m_instances}get fade(){return this.m_fade}get animationTransform(){return this.m_animationTransform}get fillBoundsOverride(){return this.m_fillBoundsOverride}get effectsBoundsOverride(){return this.m_effectsBoundsOverride}get scene3D(){return this.m_scene3D}get clipBounds(){return this.m_clipBounds}set effects(e){this.m_changeTracker.replaceListener(this.m_effects,e),this.m_effects=e}set transform(e){this.m_transform.equals(e)||(this.onTransformChanged(this.m_transform,e),this.notifyChange(),this.m_transform=e)}set isHidden(e){me(this.m_changeTracker,this.m_isHidden,e),this.m_isHidden=e}set instanceOffsets(e){this.m_instanceOffsets=e?e.slice(0):void 0,this.m_instances=e?e.map((e=>new _t(E.Translation2D(e)))):void 0}set instances(e){this.m_instances=e?e.slice(0):void 0}set fade(e){this.m_animationChangeTracker.replaceListener(this.m_fade,e),this.m_fade=e}set animationTransform(e){ge(this.m_animationChangeTracker,this.m_animationTransform,e),this.m_animationTransform=e}set fillBoundsOverride(e){ge(this.m_changeTracker,this.m_fillBoundsOverride,e),this.m_fillBoundsOverride=e}set effectsBoundsOverride(e){ge(this.m_changeTracker,this.m_effectsBoundsOverride,e),this.m_effectsBoundsOverride=e}set scene3D(e){this.m_scene3D!=e&&(this.notifyChange(),this.m_scene3D=e,this.clearCache())}set clipBounds(e){ge(this.changeTracker,this.m_clipBounds,e),ge(this.alphaTracker,this.m_clipBounds,e),this.m_clipBounds=e}getBounds(e=!0,t=!0,i=!0,r){return Pt(this,t,i?31:0,i?31:0,null==r?void 0:r.toMatrix3(),!0,void 0,e)}onTransformChanged(e,t){}clearCache(){for(const e in this.renderDataMap)this.renderDataMap[e].releaseGeneratedResources()}releaseGeneratedResources(){this.clearCache();const e=this.getBrushImages();for(let t of e)t.releaseGeneratedResources()}}class bt extends yt{constructor(e,t=new Me,i=new Le,r=M.Identity){super(i,r),this.m_role=0,this.m_geometryTracker=new pe,this.m_paths=e,this.m_overlapMode=0,this.m_mergeMode=0,this.changeTracker.replaceListener(void 0,t),pe.AddListener(t.penChangeTracker,this.m_geometryTracker),pe.AddListener(t.alphaChangeTracker,this.alphaTracker),pe.AddListener(this.m_geometryTracker,this.alphaTracker),this.m_style=t}clone(){let e=new bt;return e.paths=this.m_paths?this.m_paths.slice(0):void 0,e.m_overlapMode=this.m_overlapMode,e.m_mergeMode=this.m_mergeMode,e.style=this.m_style.clone(),e.m_shape3D=this.m_shape3D,e.text=this.m_text?this.m_text.clone():void 0,e.m_textEffectMetrics=this.m_textEffectMetrics,e.m_role=this.m_role,this.cloneItemData(e),e}static CreateRectangle(e,t=new Me,i=new Le,r=M.Identity){return new bt([V.CreateFromRect(e)],t,i,r)}get paths(){return this.m_paths}get incrementalPath(){return this.m_incrementalPath}get overlapMode(){return this.m_overlapMode}get mergeMode(){return this.m_mergeMode}get style(){return this.m_style}get shape3D(){return this.m_shape3D}get text(){return this.m_text}get textEffectMetrics(){return this.m_textEffectMetrics}get role(){return this.m_role}set paths(e){this.m_paths!=e&&(this.clearPathCache(),this.notifyGeometryChange(),this.m_paths=e)}set incrementalPath(e){this.changeTracker.replaceListener(this.m_incrementalPath,e),this.alphaTracker.replaceListener(this.m_incrementalPath,e),this.m_incrementalPath=e}set overlapMode(e){this.m_overlapMode!=e&&(this.notifyGeometryChange(),this.m_overlapMode=e)}set mergeMode(e){this.m_mergeMode!=e&&(this.notifyGeometryChange(),this.m_mergeMode=e)}set style(e){this.m_style!=e&&(pe.RemoveListener(this.m_style.penChangeTracker,this.m_geometryTracker),pe.AddListener(e.penChangeTracker,this.m_geometryTracker),pe.RemoveListener(this.m_style.alphaChangeTracker,this.alphaTracker),pe.AddListener(e.alphaChangeTracker,this.alphaTracker),this.changeTracker.replaceListener(this.m_style,e),this.m_style=e)}set shape3D(e){this.m_shape3D!=e&&(this.notifyGeometryChange(),this.m_shape3D=e)}set role(e){this.m_role!=e&&(this.notifyChange(),this.m_geometryTracker.notifyChange(),this.m_role=e)}set text(e){this.m_text!=e&&(this.m_text&&(this.m_text.cache&&this.m_text.cache.clearCache(),pe.RemoveListener(this.m_text.changeTracker,this.changeTracker),pe.RemoveListener(this.m_text.changeTracker,this.alphaTracker),pe.RemoveListener(this.m_text.animationChangeTracker,this.animationChangeTracker)),this.m_text=e,this.m_text&&(pe.AddListener(this.m_text.changeTracker,this.changeTracker),pe.AddListener(this.m_text.changeTracker,this.alphaTracker),pe.AddListener(this.m_text.animationChangeTracker,this.animationChangeTracker)))}set textEffectMetrics(e){ge(this.changeTracker,this.m_textEffectMetrics,e),ge(this.alphaTracker,this.m_textEffectMetrics,e),this.m_textEffectMetrics=e}onTransformChanged(e,t){e.scale.equals(t.scale)||this.m_geometryTracker.notifyChange()}clearCache(){super.clearCache(),this.text&&this.text.cache&&(this.text.cache.clearCache(),this.text.cache=void 0),this.clearPathCache(),this.clearBoundsCache()}clearPathCache(){for(let e of this.paths||[])for(let t in e.renderDataMap)e.renderDataMap[t].releaseGeneratedResources()}clearBoundsCache(){this.shapeBoundsCache=void 0}get geometryTracker(){return this.m_geometryTracker}notifyGeometryChange(){this.notifyChange(),this.m_geometryTracker.notifyChange(),this.clearBoundsCache()}getBrushImages(){const e=this.style.getBrushImages();return this.text&&e.push(...this.text.getBrushImages()),e}isSolidRectGeometry(){return!(!this.m_paths||1!=this.m_paths.length||!this.m_paths[0].isUntransformedRect||1!=this.m_paths[0].fillMode||this.m_paths[0].transform instanceof E||this.m_paths[0].transform instanceof M&&0!=this.m_paths[0].transform.rotation)}isSolidRect(){return!(!this.isSolidRectGeometry()||this.style.hasLine||this.style.pictureOverflow>0||this.text&&0!=this.text.renderMode)}hasSmallDetails(){return 3==this.role||this.style.hasLine&&this.style.pen.lineWidth<3||this.m_paths&&this.m_paths.some((e=>e.hasPressureInfo))}getType(){return 1}}class wt extends yt{constructor(e,t=new Le,i=M.Identity){const r=e instanceof fe?e:new fe(e,false);super(t,i,r.deferTracking?()=>r.getHash():void 0),this.changeTracker.replaceListener(void 0,r),this.alphaTracker.replaceListener(void 0,r),this.m_items=r,this.m_opacity=1}clone(){const e=new wt;for(const t of this.m_items.elements)e.items.push(t.clone());return e.groupFillBrush=this.m_groupFillBrush?this.m_groupFillBrush.clone():void 0,e.m_isDocumentShape=this.m_isDocumentShape,this.cloneItemData(e),e}get items(){return this.m_items}get groupFillBrush(){return this.m_groupFillBrush}get isDocumentShape(){return this.m_isDocumentShape}get opacity(){return this.m_opacity}set groupFillBrush(e){this.m_groupFillBrush=e}set isDocumentShape(e){this.m_isDocumentShape=e}set items(e){this.setItems(e)}set opacity(e){this.m_opacity!=e&&(this.notifyChange(),this.m_opacity=e)}setItems(e){const t=e instanceof fe?e:new fe(e);this.changeTracker.replaceListener(this.m_items,t),this.alphaTracker.replaceListener(this.m_items,t),this.m_items=t}clearCache(){super.clearCache();for(let e=0;e<this.m_items.length;e++)this.m_items.getAt(e).clearCache()}getBrushImages(){const e=Be(this.groupFillBrush);for(const t of this.m_items.elements)e.push(...t.getBrushImages());return e}getType(){return 2}}function Tt(e,t){if(!e)return!0;if(1==e.getType()){const i=e;if(t(i),i.text&&i.text.cache){for(const e of i.text.cache.getTextShapes())if(!Tt(e,t))return!1;for(const e of i.text.cache.getSelectionShapes()||[])if(!Tt(e,t))return!1}}else{if(2!=e.getType())throw O.Error(591525086,"Unknown Item type");{const i=e;for(const e of i.items.elements)if(!Tt(e,t))return!1}}return!0}function xt(e){return 1==e.alignment?-1:2==e.alignment?1:0}function Ct(e,t,i){if(e.incrementalPath)return i?e.incrementalPath.bounds.transformedBounds(i):e.incrementalPath.bounds;e.shapeBoundsCache&&e.shapeBoundsCache.geometryVersion==e.geometryTracker.version||(e.shapeBoundsCache={geometryVersion:e.geometryTracker.version});let r=0;t&&e.style.hasLine&&(r=e.style.pen.adjustedLineWidth*(.5+Math.abs(Math.max(xt(e.style.pen))))),t&&e.shape3D&&e.shape3D.adjustedContourWidth>0&&(r+=.5*e.shape3D.adjustedContourWidth);const s=!i||i.isSimpleScaleTranslationOnly();let n=r?e.shapeBoundsCache.pathsBoundsWithLine:e.shapeBoundsCache.pathsBounds;if(!n&&!r&&s&&e.paths&&(n=e.shapeBoundsCache.pathsBounds=ee(e.paths)),n){if(!i)return n;if(s)return n.multiply(i.getSimpleScale()).translate(i.getSimpleTranslation())}let o=r?e.shapeBoundsCache.pathsBoundsContributorsWithLine:e.shapeBoundsCache.pathsBoundsContributors;if(!o){const t=E.Scale2D(e.transform.scale);o=[],e.paths&&function(e,t,i,r,s,n){for(const o of e){const e=o.transform.toMatrix3().multiply(r);for(const r of o.figures)if(n.push(J(r,e,t,s?1:i.pen.lineJoin,i.pen.miterLimit)),t&&!r.isClosed&&i.pen){if(i.pen.headEnd&&0!=i.pen.headEnd.end){const s=j(i.pen.headEnd,i.pen.adjustedLineWidthForArrowHead);if(s){const o=K(r,!1,i.pen.headEnd,2*t,e);o&&n.push(J(s,o,t,1,i.pen.miterLimit))}}if(i.pen.tailEnd&&0!=i.pen.tailEnd.end){const s=j(i.pen.tailEnd,i.pen.adjustedLineWidthForArrowHead);if(s){const o=K(r,!0,i.pen.tailEnd,2*t,e);o&&n.push(J(s,o,t,1,i.pen.miterLimit))}}}}}(e.paths,r,e.style,t,null!=e.shape3D,o),r?e.shapeBoundsCache.pathsBoundsContributorsWithLine=o:e.shapeBoundsCache.pathsBoundsContributors=o}const a=E.Scale2D(e.transform.scale.inverse()),l=i?a.multiply(i):a;let h;for(const e of o||[]){const t=Q(e,l);h=R.UnionRect(h,t)}if(h&&s){const r=null==i?void 0:i.getSimpleScale();if(!i||r&&Math.abs(r.x)>C&&Math.abs(r.y)>C){const r=i?h.translate(i.getSimpleTranslation().negate()).multiply(i.getSimpleScale().inverse()):h;t?e.shapeBoundsCache.pathsBoundsWithLine=r:e.shapeBoundsCache.pathsBounds=r}}return h}function Pt(e,t,i,r,s,n=!0,o,a=!1){let l=a?e.animationTransform:void 0,h=s&&l?s.multiply(l):s||l;const c=h?e.transform.toMatrix3().multiply(h):e.transform.toMatrix3();let d;if(1==e.getType()){const i=e;if(o||(d=Ct(i,!0,c)),i.text&&t&&(n||o)){const r=new M(P.Zero,P.One,e.transform.rotation,e.transform.translation),n=i.text.hasAnimationProps()?s:h,l=n?r.toMatrix3().multiply(n):r.toMatrix3(),c=Rt(i);if(c)for(let e of c.textShapes)o&&e.textRange&&!o.intersects(e.textRange)||(d=R.UnionRect(d,e.getBounds(a,t,!0,l)))}}else if(2==e.getType()&&!o&&n){const i=e;for(let e=0;e<i.items.length;e++){const s=i.items.getAt(e),n=s instanceof bt&&3==s.role;!t&&n||(d=R.UnionRect(d,Pt(s,t,r,r,c)))}}if(!o){let s,n;const o=1&i&&e.effects&&e.effects.glow&&e.effects.glow.radius,a=2&i&&e.effects&&e.effects.shadow,l=4&i&&e.effects&&e.effects.reflection;if((o||a||l)&&(n=h?Pt(e,t,i,r):d),(a||l)&&(s=e.effectsBoundsOverride?e.effectsBoundsOverride:Pt(e,!1,0,1)),d&&n&&1&i&&e.effects&&e.effects.glow&&e.effects.glow.radius&&(n=n.inflate(2*e.effects.glow.radius),d=d.inflate(2*e.effects.glow.radius)),(a||l)&&!t&&e instanceof bt&&e.text){const t=Pt(e,!0,i,r);t&&(n=R.UnionRect(n,t))}if(d&&n&&s&&2&i&&e.effects&&e.effects.shadow){const t=Et(e.effects.shadow.alignment,s),i=Mt(e.effects.shadow.angle,e.effects.shadow.distance,e.effects.shadow.scale,e.effects.shadow.skew,t),r=(e.effects.shadow.radius?n.inflate(e.effects.shadow.radius):n).transformedBounds(h?i.multiply(h):i),o=(e.effects.shadow.radius?n.inflate(e.effects.shadow.radius):n).transformedBounds(h?i.multiply(h):i);n=R.UnionRect(n,r),d=R.UnionRect(d,o)}if(d&&n&&s&&4&i&&e.effects&&e.effects.reflection){let t=e.effects.reflection,i=s.bottom+e.effects.reflection.distance/2;e instanceof bt&&e.textEffectMetrics&&(i-=e.textEffectMetrics.descent);const r=E.Translation2D(new P(0,-i)).multiply(E.Scale2D(new P(1,-1))).multiply(E.Translation2D(new P(0,i))),o=(t.radius?n.inflate(t.radius):n).transformedBounds(r),a=h?(t.radius?n.inflate(t.radius):n).transformedBounds(r.multiply(h)):o;d=R.UnionRect(d,a)}}return d}const St=[new P(0,0),new P(.5,0),new P(1,0),new P(0,.5),new P(.5,.5),new P(1,.5),new P(0,1),new P(.5,1),new P(1,1)];function Et(e,t){return t?St[e].multiply(t.size).add(t.leftTop):St[e]}function Mt(e,t,i,r,s){const n=E.Translation2D(s.negate()),o=new P(t,0).rotate(e).add(s),a=new E(i.x,r.y,0,r.x,i.y,0,o.x,o.y,1);return n.multiply(a)}function Rt(e){if(e.text)return e.text.cache||(e.text.cache=new it),e.text.cache.update(e.text),e.text.cache}function Bt(e){e.items.removeAll(),e.clearCache()}class It{}class At{constructor(){this.type=It,this.pointerEventNotifiers=d(),this.hitTestSlop=0,this.scene=new wt,this.sourceAnchorBounds=new p(0,0,0,0),this.scaleFactor=At.defaultScaleFactor,this.transform=new _,this.emuToSourceScale=1,this.isHitTestOnly=!1,this.teardownTracker=new w("ShapeBuilderViewModel"),this.itemTeardowns=[]}static setDefaultScaleFactor(e){At.defaultScaleFactor=e}addItem(e){this.scene.items.push(e)}addTeardown(e){this.itemTeardowns.push(e)}setItems(e){e.length>0&&function(e){const t=new x("ShapeBuilderViewModel.clearTextures");try{t.setProp("renderDataMapSize",Object.keys(e.renderDataMap).length).setProp("sceneSize",e.items.length),e.releaseGeneratedResources()}finally{t.complete()}}(this.scene),this.scene.setItems(e)}removeItem(e){const t=this.scene.items.elements.indexOf(e);-1!==t&&this.scene.items.removeAt(t)}clear(){this.itemTeardowns.forEach((e=>{e()})),this.itemTeardowns=[],this.scene.items.removeAll()}teardown(){Bt(this.scene),this.itemTeardowns.forEach((e=>{e()})),this.teardownTracker.teardown()}}function Ft(e){return e.type===It}At.defaultScaleFactor=1;var kt=s(5163);class Dt{constructor(){this.elements=[]}clearCache(){this.elements.forEach((e=>e.clearCache()))}}const Lt=[0,1,2,0,3,4];class Ot{constructor(){this.totalCostMs=0,this.shapeRenderCostMs=0,this.distanceFieldForTextCostMs=0,this.distanceFieldForGlyphTableCostMs=0,this.distanceFieldForShapeCostMs=0,this.patternTextureCostMs=0,this.pathGradientTextureCostMs=0,this.gradientTextureCostMs=0,this.fadeTextureCostMs=0,this.effectsCostMs=0,this.cacheToSpriteCostMs=0,this.drawTapeCostMs=0,this.glResetCostMs=0,this.glRestoreCostMs=0,this.pathCount=0,this.glyphCount=0,this.glyphCountAddedToCache=0,this.glyphCountReadFromCache=0,this.glyphCountRenderedAsPath=0,this.glyphCountLargeText=0,this.glyphCountTextOutline=0,this.pixelCountDistanceField=0,this.pixelCountShapeRender=0,this.shapeLayerCount=0,this.shapeLayerCountText=0,this.dynamicTextureAlloc=0,this.beginTime=0,this.endTime=0}add(e){this.totalCostMs+=e.totalCostMs,this.shapeRenderCostMs+=e.shapeRenderCostMs,this.distanceFieldForTextCostMs+=e.distanceFieldForTextCostMs,this.distanceFieldForGlyphTableCostMs+=e.distanceFieldForGlyphTableCostMs,this.distanceFieldForShapeCostMs+=e.distanceFieldForShapeCostMs,this.patternTextureCostMs+=e.patternTextureCostMs,this.pathGradientTextureCostMs+=e.pathGradientTextureCostMs,this.gradientTextureCostMs+=e.gradientTextureCostMs,this.fadeTextureCostMs+=e.fadeTextureCostMs,this.effectsCostMs+=e.effectsCostMs,this.cacheToSpriteCostMs+=e.cacheToSpriteCostMs,this.drawTapeCostMs+=e.drawTapeCostMs,this.glResetCostMs+=e.glResetCostMs,this.glRestoreCostMs+=e.glRestoreCostMs,this.pathCount+=e.pathCount,this.glyphCount+=e.glyphCount,this.glyphCountAddedToCache+=e.glyphCountAddedToCache,this.glyphCountReadFromCache+=e.glyphCountReadFromCache,this.glyphCountRenderedAsPath+=e.glyphCountRenderedAsPath,this.glyphCountLargeText+=e.glyphCountLargeText,this.glyphCountTextOutline+=e.glyphCountTextOutline,this.pixelCountDistanceField+=e.pixelCountDistanceField,this.pixelCountShapeRender+=e.pixelCountShapeRender,this.shapeLayerCount+=e.shapeLayerCount,this.shapeLayerCountText+=e.shapeLayerCountText,this.dynamicTextureAlloc+=e.dynamicTextureAlloc,this.beginTime=0,this.endTime=0}}class Ut{constructor(){this.frameCount=0}}class Vt{constructor(){this.recreatingSprites=0,this.pictureCropBWTextures=0}}var Nt,Gt=function(){function e(e,t,i,r){void 0===t&&(t=!1),this.initalize(e,t,i,r)}return e.prototype.initalize=function(e,t,i,r){return void 0===t&&(t=!1),this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this},e}(),zt=function(e,t,i){void 0===i&&(i=null),this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1},Ht=(function(){function e(){}e.prototype.dispose=function(){if(this._observers&&this._observables)for(var e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null},e.Watch=function(t,i,r,s){void 0===r&&(r=-1),void 0===s&&(s=null);var n=new e;n._observers=new Array,n._observables=t;for(var o=0,a=t;o<a.length;o++){var l=a[o].add(i,r,!1,s);l&&n._observers.push(l)}return n}}(),function(){function e(e){this._observers=new Array,this._eventState=new Gt(0),e&&(this._onObserverAdded=e)}return Object.defineProperty(e.prototype,"observers",{get:function(){return this._observers},enumerable:!1,configurable:!0}),e.prototype.add=function(e,t,i,r,s){if(void 0===t&&(t=-1),void 0===i&&(i=!1),void 0===r&&(r=null),void 0===s&&(s=!1),!e)return null;var n=new zt(e,t,r);return n.unregisterOnNextCall=s,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),n},e.prototype.addOnce=function(e){return this.add(e,void 0,void 0,void 0,!0)},e.prototype.remove=function(e){return!!e&&-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0)},e.prototype.removeCallback=function(e,t){for(var i=0;i<this._observers.length;i++){var r=this._observers[i];if(!(r._willBeUnregistered||r.callback!==e||t&&t!==r.scope))return this._deferUnregister(r),!0}return!1},e.prototype._deferUnregister=function(e){var t=this;e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((function(){t._remove(e)}),0)},e.prototype._remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return-1!==t&&(this._observers.splice(t,1),!0)},e.prototype.makeObserverTopPriority=function(e){this._remove(e),this._observers.unshift(e)},e.prototype.makeObserverBottomPriority=function(e){this._remove(e),this._observers.push(e)},e.prototype.notifyObservers=function(e,t,i,r,s){if(void 0===t&&(t=-1),!this._observers.length)return!0;var n=this._eventState;n.mask=t,n.target=i,n.currentTarget=r,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=s;for(var o=0,a=this._observers;o<a.length;o++){var l=a[o];if(!l._willBeUnregistered&&(l.mask&t&&(l.scope?n.lastReturnValue=l.callback.apply(l.scope,[e,n]):n.lastReturnValue=l.callback(e,n),l.unregisterOnNextCall&&this._deferUnregister(l)),n.skipNextObservers))return!1}return!0},e.prototype.notifyObserversWithPromise=function(e,t,i,r,s){var n=this;void 0===t&&(t=-1);var o=Promise.resolve(e);if(!this._observers.length)return o;var a=this._eventState;return a.mask=t,a.target=i,a.currentTarget=r,a.skipNextObservers=!1,a.userInfo=s,this._observers.forEach((function(i){a.skipNextObservers||i._willBeUnregistered||i.mask&t&&(o=i.scope?o.then((function(t){return a.lastReturnValue=t,i.callback.apply(i.scope,[e,a])})):o.then((function(t){return a.lastReturnValue=t,i.callback(e,a)})),i.unregisterOnNextCall&&n._deferUnregister(i))})),o.then((function(){return e}))},e.prototype.notifyObserver=function(e,t,i){void 0===i&&(i=-1);var r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.callback(t,r)},e.prototype.hasObservers=function(){return this._observers.length>0},e.prototype.clear=function(){this._observers=new Array,this._onObserverAdded=null},e.prototype.clone=function(){var t=new e;return t._observers=this._observers.slice(0),t},e.prototype.hasSpecificMask=function(e){void 0===e&&(e=-1);for(var t=0,i=this._observers;t<i.length;t++){var r=i[t];if(r.mask&e||r.mask===e)return!0}return!1},e}()),Wt=function(){},$t=function(){function e(){}return e.WarnImport=function(e){return e+" needs to be imported before as it contains a side-effect required by your code."},e}();!function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.Depth=12]="Depth",e[e.CubeRawRGBD=13]="CubeRawRGBD"}(Nt||(Nt={}));var qt=function(){function e(e,t,i){void 0===i&&(i=!1),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.samplingMode=-1,this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new Ht,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=Nt.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._MSAARenderBuffer=null,this._attachments=null,this._textureArray=null,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._isDisabled=!1,this._compression=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._comparisonFunction=0,this._sphericalPolynomial=null,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._webGLTexture=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=t,i||(this._webGLTexture=e._createTexture())}return e.prototype.getEngine=function(){return this._engine},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),e.prototype.incrementReferences=function(){this._references++},e.prototype.updateSize=function(e,t,i){void 0===i&&(i=1),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i},e.prototype._rebuild=function(){var t,i,r=this;switch(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedAnisotropicFilteringLevel=null,this.source){case Nt.Temp:return;case Nt.Url:return void(i=this._engine.createTexture(null!==(t=this._originalUrl)&&void 0!==t?t:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(function(){i._swapAndDie(r),r.isReady=!0}),null,this._buffer,void 0,this.format));case Nt.Raw:return(i=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case Nt.Raw3D:return(i=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case Nt.Raw2DArray:return(i=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case Nt.Dynamic:return(i=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode))._swapAndDie(this),void this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);case Nt.RenderTarget:var s=new Wt;if(s.generateDepthBuffer=this._generateDepthBuffer,s.generateMipMaps=this.generateMipMaps,s.generateStencilBuffer=this._generateStencilBuffer,s.samplingMode=this.samplingMode,s.type=this.type,this.isCube)i=this._engine.createRenderTargetCubeTexture(this.width,s);else{var n={width:this.width,height:this.height,layers:this.is2DArray?this.depth:void 0};i=this._engine.createRenderTargetTexture(n,s)}return i._swapAndDie(this),void(this.isReady=!0);case Nt.Depth:var o={bilinearFiltering:2!==this.samplingMode,comparisonFunction:this._comparisonFunction,generateStencil:this._generateStencilBuffer,isCube:this.isCube},a={width:this.width,height:this.height,layers:this.is2DArray?this.depth:void 0};return(i=this._engine.createDepthStencilTexture(a,o))._swapAndDie(this),void(this.isReady=!0);case Nt.Cube:return void(i=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(function(){i._swapAndDie(r),r.isReady=!0}),null,this.format,this._extension));case Nt.CubeRaw:return(i=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case Nt.CubeRawRGBD:return i=this._engine.createRawCubeTexture(null,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),void e._UpdateRGBDAsync(i,this._bufferViewArrayArray,this._sphericalPolynomial,this._lodGenerationScale,this._lodGenerationOffset).then((function(){i._swapAndDie(r),r.isReady=!0}));case Nt.CubePrefiltered:return void((i=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(function(e){e&&e._swapAndDie(r),r.isReady=!0}),null,this.format,this._extension))._sphericalPolynomial=this._sphericalPolynomial)}},e.prototype._swapAndDie=function(e){e._webGLTexture=this._webGLTexture,e._isRGBD=this._isRGBD,this._framebuffer&&(e._framebuffer=this._framebuffer),this._depthStencilBuffer&&(e._depthStencilBuffer=this._depthStencilBuffer),e._depthStencilTexture=this._depthStencilTexture,this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);var t,i=this._engine.getLoadedTexturesCache();-1!==(t=i.indexOf(this))&&i.splice(t,1),-1===(t=i.indexOf(e))&&i.push(e)},e.prototype.dispose=function(){this._webGLTexture&&(this._references--,0===this._references&&(this._engine._releaseTexture(this),this._webGLTexture=null))},e._UpdateRGBDAsync=function(e,t,i,r,s){throw $t.WarnImport("environmentTextureTools")},e}();class jt{static load(e){jt.m_settings=e}static readBooleanOrDefault(e,t){const i=void 0===jt.m_settings?"":typeof jt.m_settings[e];return"string"===i?"true"===jt.m_settings[e].toLowerCase():"boolean"===i?jt.m_settings[e]:t}static readNumberOrDefault(e,t){const i=void 0===jt.m_settings?"":typeof jt.m_settings[e];return"string"===i||"number"===i?Number(jt.m_settings[e]):t}static readStringOrDefault(e,t){return void 0===jt.m_settings||"string"!=typeof jt.m_settings[e]?t:jt.m_settings[e]}}let Xt=1,Yt=1;const Kt=4096,Zt=2048;class Jt{constructor(){this.textureMemoryAllocated=0,this.allocatedTextures=[]}register(e){this.textureMemoryAllocated+=e.memoryUsage,this.allocatedTextures.push(e)}unregister(e){this.textureMemoryAllocated-=e.memoryUsage,this.allocatedTextures=this.allocatedTextures.filter((t=>t!==e))}}function Qt(e){Xt=Yt=e}let ei=!0;function ti(e){ei=e}function ii(e,t){return{center:e.center.add(t.preTranslation).multiply(t.scale).rotate(t.rotation).add(t.translation),size:e.size.multiply(t.scale.abs()),rotation:t.rotation,flipX:t.scale.x<0,flipY:t.scale.y<0}}class ri{constructor(e,t,i,r,s,n,o){if(this.m_originalSize=P.Zero,this.m_changeTracker=new pe,this.m_compatibleGraphicsProcessorId=0,this.m_isMipMapped=!1,this.m_usageRecord=[],!t.isValid())throw O.Message(512297123,"Unable to create texture on invalid renderer");if(ci(s),this.wrapMode=n,this.releasePolicy=o,this.scenario=e,this.creationTime=performance.now(),this.m_lastRenderTime=i?performance.now():void 0,!isFinite(r.x)||!isFinite(r.y)||r.x<=0||r.y<=0){const t=jt.readBooleanOrDefault("throwOnInvalidTextureSize",!1),i=O.Error(572319067,`Invalid texture size: ${r.x} x ${r.y}, scenario: ${e}`);if(t)throw i}else{const o=r.ceil();if(o.equals(r)||O.Error(572319068,`Bad texture size. Should be positive integers: ${r.x} x ${r.y}, scenario: ${e}`),this.m_graphicsProcessor=t.getGraphicsProcessor(),!this.m_graphicsProcessor)throw O.Error(592525214,"Unable to set texture if processor not initialized");if(this.m_originalSize=o,this.m_babylonTexture=i instanceof qt?i:i?this.m_graphicsProcessor.createTextureGraphicsResourceFromExternalWebGLTexture(o,s,i,void 0):void 0,this.m_compatibleGraphicsProcessorId=this.m_graphicsProcessor.getUniqueGraphicsProcessorId(),this.m_babylonTexture){const i=ri.GetRequiredSizeForWrapMode(this.m_graphicsProcessor,o,n);if(4!=n&&!i.equals(o)){if(jt.readBooleanOrDefault("noResample",!1))throw O.Error(572303306,"Invalid texture size for non-clamp scenario: ${scenario}");O.Error(572867283,`Texture size not supported for this wrap mode. The texture will be resampled and the copy will be managed by ShapeBuilder. Please conside resampling explicitely using WrapMode.clamp and cloneWithNewWrapMode when necessary. Scenario: ${e}`);const r=ri.ResampleBabylonTexture(t,this.m_babylonTexture,this.originalSize,4,i,n,s);2==this.releasePolicy?this.releasePolicy=0:this.m_babylonTexture.dispose(),this.m_babylonTexture=r}}}const a=t;this.m_textureManager=a.getTextureManager(),this.m_textureManager.register(this)}static CreateFromByteBuffer(e,t,i,r,s,n,o,a,l,h,c){return ri.CreateOrUpdateFromByteBuffer(e,void 0,t,i,r,s,n,o,a,l,h,c)}static CreateOrUpdateFromByteBuffer(e,t,i,r,s,n,o,a,l,h,c,d){var u,f;if(!i.isValid())throw O.Message(512297122,"Unable to create/update texture on invalid renderer");let p=t;const m=i.getGraphicsProcessor();if(!m)throw O.Error(592525215,"No Graphics Processor");const g=-1==n||-3==n?4:-2==n?5:n;if(!p||p.isValidForGraphicsProcessor(m)&&p.size.equals(r)&&p.m_babylonTexture&&p.format==g&&p.wrapMode==o&&p.m_babylonTexture.invertY==!!l||(p.release(),p=void 0),4==n||5==n||1==n||2==n){if(p&&p.m_babylonTexture)return m.updateTextureGraphicsResourceFromByteBuffer(p.m_babylonTexture,s,s instanceof Float32Array,d||4),p.changeTracker.notifyChange(),p.m_lastRenderTime=performance.now(),p;{const t=m.createTextureGraphicsResource(r,s,n,s instanceof Float32Array,!1,!1,o,a,!!l,d);return new ri(e,i,t,r,n,o,null==h?0:h)}}if(-1==n||-2==n||-3==n){const t=(null==p?void 0:p.m_textureConverterCache)||{},h=-3==n?1:g,m=-1==n||-2==n;let v;if(t.primary=ri.CreateOrUpdateFromByteBuffer(e+"/primary",t.primary,i,r,s,h,o,a,l,0,c,d),t.secondary=-3==n?ri.CreateOrUpdateFromByteBuffer(e+"/secondary",t.secondary,i,new P(Math.ceil(.5*r.x),Math.ceil(.5*r.y)),s.slice(r.x*Math.ceil(r.y/(d||4))*(d||4)),2,o,a,l,0,c,d):void 0,t.primary.m_babylonTexture&&(v=ri.ConvertTexture(e,i,p instanceof si?p:void 0,t.primary,m,t.secondary,g),v&&c?v.m_textureConverterCache=t:(null===(u=t.primary)||void 0===u||u.release(),null===(f=t.secondary)||void 0===f||f.release()),v))return v.m_lastRenderTime=performance.now(),v}throw O.Error(507910019,"Unsupported texture format")}static CreateFromHTMLElement(e,t,i,r=4,s=!0){if(!t.isValid())throw O.Message(512297121,"Unable to create texture on invalid renderer");const n=t.getGraphicsProcessor();if(!n)throw O.Error(592525216,"No Graphics Processor");const o=new P(i.width,i.height),a=n.createTextureGraphicsResource(o,i,5,!1,!1,!1,r,s,!0);return new ri(e,t,a,o,5,r,0)}static CreateFromHTMLImageElement(e,t,i,r=4,s=!0){return ri.CreateFromHTMLElement(e,t,i,r,s)}static CreateOrUpdateFromHTMLElement(e,t,i,r,s=4,n=!0){if(!i.isValid())throw O.Message(512297120,"Unable to create/update texture on invalid renderer");const o=i.getGraphicsProcessor();if(!o)throw O.Error(507910018,"No Graphics Processor");const a=new P(r.width,r.height);if(t){if(t.isValidForGraphicsProcessor(o)&&t.m_babylonTexture&&t.size.equals(a)&&t.wrapMode==s)return o.updateTextureGraphicsResourceFromHTMLElement(t.m_babylonTexture,r,!0),t.changeTracker.notifyChange(),t.m_lastRenderTime=performance.now(),t;t.release()}return ri.CreateFromHTMLElement(e,i,r,s,n)}static CreateFromTextureAndMask(e,t,i,r,s,n=4,o=!0){const a=t,l=new si(e,t,s,0,{disableFiltering:!o,wrapMode:n});return a.drawTextureToTexture(l,i,4,{secondaryTexture:r}),l}get graphicsProcessor(){return this.m_graphicsProcessor}get size(){return this.m_babylonTexture?new P(this.m_babylonTexture.width,this.m_babylonTexture.height):P.Zero}get originalSize(){return this.m_originalSize}get changeTracker(){return this.m_changeTracker}get lastUsage(){return this.m_usageRecord.length>0?Math.max(...this.m_usageRecord.map((e=>e.lastUsage))):0}get format(){return this.m_babylonTexture?this.m_babylonTexture.format:(O.Error(572073351,"No texture, no format"),5)}get memoryUsage(){if(!this.graphicsProcessor)return 0;let e=Lt[this.format],t=0,i=0;if(this.m_babylonTexture){switch(this.m_babylonTexture.type){case 0:t=1;break;case 1:t=4;break;case 2:t=2;break;default:O.Error(572867285,"Unknown texture type")}i=this.m_babylonTexture._generateStencilBuffer?1:0}return Math.ceil(this.size.x*this.size.y*(e*t+i)*(this.m_isMipMapped?4/3:1))}get usageRecord(){return this.m_usageRecord}get lastRenderTime(){return this.m_lastRenderTime}tryUseBabylonTexture(e,t,i){const r=this.m_usageRecord.find((e=>e.clientObject==t));return r?(r.lastScenario=i,r.lastUsage=performance.now(),r.usageCount++):this.m_usageRecord.push({clientObject:t,lastScenario:i,lastUsage:performance.now(),usageCount:1}),this.isValidForGraphicsProcessor(e)?this.m_babylonTexture:void 0}set originalSize(e){this.m_changeTracker.notifyChange(),this.m_originalSize=e}set contentLocation(e){this.m_changeTracker.notifyChange(),this.m_contentLocation=e}generateMipMap(){const e=this.graphicsProcessor;e&&this.m_babylonTexture?(e.generateMipMap(this.m_babylonTexture),this.m_textureManager&&(this.m_textureManager.textureMemoryAllocated-=this.memoryUsage),this.m_isMipMapped=!0,this.m_textureManager&&(this.m_textureManager.textureMemoryAllocated+=this.memoryUsage)):O.Error(592525218,"Cannot generate mipmaps")}isValidForGraphicsProcessor(e){return this.m_babylonTexture&&this.m_graphicsProcessor==e&&this.m_compatibleGraphicsProcessorId==e.getUniqueGraphicsProcessorId()}isValid(e){const t=e.getGraphicsProcessor();return t&&this.isValidForGraphicsProcessor(t)}getState(e){const t=e.getGraphicsProcessor();return this.m_babylonTexture?t&&this.m_graphicsProcessor==t?this.isValidForGraphicsProcessor(t)?0==this.m_babylonTexture._references?2:0:4:3:1}tryGetWebGLTexture(){return this.m_babylonTexture&&this.m_babylonTexture._webGLTexture||void 0}unregisterFromTextureManager(){this.m_textureManager&&(this.m_textureManager.unregister(this),this.m_textureManager=void 0)}release(){var e,t,i,r;this.unregisterFromTextureManager(),this.m_babylonTexture&&2!=this.releasePolicy&&this.m_babylonTexture.dispose(),this.m_babylonTexture=void 0,null===(t=null===(e=this.m_textureConverterCache)||void 0===e?void 0:e.primary)||void 0===t||t.release(),null===(r=null===(i=this.m_textureConverterCache)||void 0===i?void 0:i.secondary)||void 0===r||r.release(),this.m_changeTracker.notifyChange()}get contentLocation(){const e=this.size;return this.m_contentLocation?this.m_contentLocation:{logicalCenter:e.scale(.5),logicalSize:e,physicalCenter:e.scale(.5),physicalSize:e,rotation:0,flipX:!1,flipY:!1}}get isMipMapped(){return this.m_isMipMapped}cloneWithNewWrapMode(e,t,i,r){const s=this.m_graphicsProcessor;if(!s||!this.m_babylonTexture||!this.isValidForGraphicsProcessor(s))return void O.Error(592472278,"Failed to get graphicsProcessor or valid texture");this.wrapMode==i&&O.Error(592472277,"Why cloning if the wrapmode is the same?");const n=ri.GetRequiredSizeForWrapMode(s,this.size,i),o=ri.ResampleBabylonTexture(t,this.m_babylonTexture,this.originalSize,this.wrapMode,n,i,this.format);if(!o)return;const a=new ri(e,t,o,n,this.m_babylonTexture.format,i,r);return a.originalSize=this.originalSize,a}static GetRequiredSizeForWrapMode(e,t,i){return e.needPowerOf2TexturesForTilingOrMipMap()&&4!=i?new P(F(I((r=t).x),1,2048),F(I(r.y),1,2048)):t;var r}static ResampleBabylonTexture(e,t,i,r,s,n,o){const a=e,l=a.getGraphicsProcessor();if(!l)return void O.Error(572867286,"Failed to get graphicsProcessor");const h=new ri("TMP/ResampleSrc",e,t,i,t.format,r,2),c=new si("TMP/ResampleDst",e,s,0,{disableFiltering:1==t.samplingMode,format:o});a.drawTextureToTexture(c,h,0);const d=c.m_babylonTexture;return c.unregisterFromTextureManager(),c.m_babylonTexture=void 0,c.release(),d&&l.setWrapMode(d,n),h.release(),d}static ConvertTexture(e,t,i,r,s,n,o){var a;const l=t;if(!l.getGraphicsProcessor())return void O.Error(526714142,"Failed to get graphicsProcessor");const h=1==(null===(a=r.m_babylonTexture)||void 0===a?void 0:a.samplingMode),c=si.RecycleOrReplace(e,i,t,r.size,!1,o,!1,0,r.wrapMode,h);return l.drawTextureToTexture(c,r,s?2:n?3:0,{secondaryTexture:n}),c}}class si extends ri{constructor(e,t,i=P.Zero,r,s){if(!t.isValid())throw O.Message(512297119,"Unable to create TargetTexture on invalid renderer");const n=i.ceil(),o=s&&void 0!==s.wrapMode?s.wrapMode:4,a=t,l=a.getGraphicsProcessor();if(!l)return void O.Error(592525217,"Graphics processor not initialized");if(n.isZero())return void O.Error(572867287,"Creating TargetTexture of size 0x0");const h=s&&s.format?s.format:5;let c;ci(h),c=s&&s.externalTexture?l.createTextureGraphicsResourceFromExternalWebGLTexture(n,h,s.externalTexture,s?s.externalFrameBuffer:void 0):l.createTextureGraphicsResource(n,void 0,h,!(!s||!s.useFloat),!0,!!s&&!!s.needsRenderBuffer,o,!s||!s.disableFiltering,!1),super(e,t,c,n,h,o,r),2!=r&&(a.getCurrentFramePerformanceSummary().dynamicTextureAlloc+=this.memoryUsage)}tryGetBabylonTextureForRenderToTexture(e){return this.m_lastRenderTime=performance.now(),this.isValidForGraphicsProcessor(e)?this.m_babylonTexture:void 0}tryConvertToBufferRGBA(){if(this.m_graphicsProcessor&&this.m_babylonTexture)return this.m_graphicsProcessor.copyTexturePixelsToArray(this.m_babylonTexture,R.FromSize(this.size),!0)}tryConvertToCanvas(){if(!this.m_graphicsProcessor||!this.m_babylonTexture)return;const e=document.createElement("canvas");e.width=this.m_babylonTexture.width,e.height=this.m_babylonTexture.height;var t=e.getContext("2d");if(t){const i=this.tryConvertToBufferRGBA();if(i){const r=this.size,s=t.createImageData(r.x,r.y);return s.data.set(i),t.putImageData(s,0,0),t.globalCompositeOperation="copy",t.setTransform(1,0,0,-1,0,r.y),t.drawImage(e,0,0),e}}}tryConvertToDataURL(){const e=this.tryConvertToCanvas();if(e)return e.toDataURL()}static RecycleOrReplace(e,t,i,r,s,n,o,a,l,h){ci(n);const c=i.getGraphicsProcessor();if(t){if(c&&t.isValidForGraphicsProcessor(c)&&t.size.equals(r)&&t.m_babylonTexture&&t.m_babylonTexture.format==n)return t.releasePolicy!=a&&O.Error(572867288,"RecycleOrReplace with different releasePolicy"),t;t.release()}return new si(e,i,r,a,{format:n,needsRenderBuffer:o,useFloat:s,wrapMode:l,disableFiltering:h})}}const ni=[{attributeName:"a_0",attributeSize:4,offset:0}],oi=[{attributeName:"a_1",attributeSize:4,offset:0}];function ai(e,t,i){0==e.length&&O.Error(509634196,"Cannot create vertex buffer array from empty rectangle array.");const r=new Float32Array(4*i);for(let s=0;s<i;s++){const i=e[Math.min(s,e.length-1)];r[4*s+0]=i.left/t.x,r[4*s+1]=i.top/t.y,r[4*s+2]=i.right/t.x,r[4*s+3]=i.bottom/t.y}return r}function li(e,t,i,r,s,n,o,a,l,h){const c=e.getGraphicsProcessor();if(!c||!c.isValid())return void O.Error(509634336,"Invalid Graphics Processor for Sharpness Filter");if(!i.isValidForGraphicsProcessor(c))return void O.Error(509634335,"Invalid Texture for Sharpness Filter");const d=Math.max(o.length,a.length);if(0==d)return;const u=ai(o,i.size,d),f=ai(a,l,d),p=c.activateShaderProgram(9);p.begin(r.tryGetBabylonTextureForRenderToTexture(c),_e.Transparent,!0);const m=c.getBabylonEngine(),g=m.createVertexBuffer(u),v=m.createVertexBuffer(f);m.bindInstancesBuffer(g,ni,!1),m.bindInstancesBuffer(v,oi,!1),p.setTexture("t_0",i.tryUseBabylonTexture(c,void 0,"sharpnessFilterPass")),p.setTexture("t_1",t.tryUseBabylonTexture(c,void 0,"sharpnessFilterPass"));const _=h.sharpness,y=_<0?10.5*-_:1.25*_,b=_<0?1+.8*-_:1,w=1==s&&_>0;p.getBabylonEffect().setFloat("ufrag_0",y),p.getBabylonEffect().setFloat("ufrag_1",b),p.getBabylonEffect().setFloat("ufrag_2",n),p.getBabylonEffect().setInt("ufrag_3",s),p.getBabylonEffect().setBool("ufrag_4",w),p.drawQuadInstances(d),p.disableInstanceAttribute("a_0"),p.disableInstanceAttribute("a_1"),m._releaseBuffer(g),m._releaseBuffer(v),p.end()}function hi(e,t,i,r,s,n,o,a=1,l,h){var c,d,u,f,p,m,g,v,_,y;if(!i.isValidForGraphicsProcessor(e))return void O.Error(591192838,"Invalid Texture");const b=Math.max(r.length,s.length);if(0==b)return;const w=ai(r,i.size,b),T=ai(s,n,b),x=e.getBabylonEngine(),C=x.createVertexBuffer(w),S=x.createVertexBuffer(T);if(x.bindInstancesBuffer(C,ni,!1),x.bindInstancesBuffer(S,oi,!1),t.setTexture("t_0",i.tryUseBabylonTexture(e,void 0,"drawTextureRects")),8!=t.programId&&t.getBabylonEffect().setFloat("ufrag_0",a),6==t.programId){const r=null==h?void 0:h.secondaryTexture;t.setTexture("t_1",null==r?void 0:r.tryUseBabylonTexture(e,void 0,"drawTextureRects/Secondary")),t.getBabylonEffect().setInt("ufrag_1",o),function(e,t){const i=null==t?void 0:t.brightnessContrast;if(i){let t,r;oe?(t=1,r=i.brightness):i.brightness>=1?(t=0,r=1):(t=i.brightness>0?1/(1-i.brightness):Math.max(0,1+i.brightness),r=0),e.getBabylonEffect().setInt("ufrag_3",1),e.getBabylonEffect().setArray2("ufrag_4",[t,r]),e.getBabylonEffect().setArray4("ufrag_5",function(e){if(ae)return[0,0,e,(1-e)/2];const t=Math.min(Math.abs(e/4),1/4-1/65025),i=64*t*t*t-48*t*t-4*t+3,r=-64*t/i,s=96*t/i,n=(i-32*t)/i;if(e>=0)return[r,s,n,0];const o=Math.max(0,(-s+Math.sqrt(s*s-4*r*n))/(2*r));return[(64*t-32*o)/3,-32*t+16*o,(32*t-22*o+3)/3,o]}(i.contrast))}else e.getBabylonEffect().setInt("ufrag_3",0);const r=null==t?void 0:t.hueSaturationLuminance;r?(e.getBabylonEffect().setInt("ufrag_6",1),e.getBabylonEffect().setFloat("ufrag_7",r.hueRotation),e.getBabylonEffect().setFloat("ufrag_8",r.saturationFactor),e.getBabylonEffect().setFloat("ufrag_9",r.luminanceFactor)):e.getBabylonEffect().setInt("ufrag_6",0);const s=null==t?void 0:t.recolor;if(s){const t=void 0===s.threshold?1:255,i=void 0===s.threshold?0:.5-t*s.threshold;e.getBabylonEffect().setInt("ufrag_10",1),e.getBabylonEffect().setFloat("ufrag_11",t),e.getBabylonEffect().setFloat("ufrag_12",i),e.getBabylonEffect().setVector3("ufrag_13",{x:s.darkColor.r,y:s.darkColor.g,z:s.darkColor.b}),e.getBabylonEffect().setVector3("ufrag_14",{x:s.brightColor.r,y:s.brightColor.g,z:s.brightColor.b})}else e.getBabylonEffect().setInt("ufrag_10",0);const n=null==t?void 0:t.colorTemperature;n?(e.getBabylonEffect().setInt("ufrag_15",1),e.getBabylonEffect().setFloat("ufrag_16",n.redGain),e.getBabylonEffect().setFloat("ufrag_17",n.blueGain),e.getBabylonEffect().setFloat("ufrag_18",n.greenGain)):e.getBabylonEffect().setInt("ufrag_15",0);const o=null==t?void 0:t.sharpness;le&&o?(e.getBabylonEffect().setInt("ufrag_20",1),e.getBabylonEffect().setFloat("ufrag_21",o.sharpness)):e.getBabylonEffect().setInt("ufrag_20",0);const a=null==t?void 0:t.highlightsShadows;a?(e.getBabylonEffect().setInt("ufrag_25",1),e.getBabylonEffect().setDirectColor4("ufrag_26",a.neutral),e.getBabylonEffect().setDirectColor4("ufrag_27",a.positive),e.getBabylonEffect().setDirectColor4("ufrag_28",a.negative)):e.getBabylonEffect().setInt("ufrag_25",0)}(t,null==h?void 0:h.pictureEffects),t.getBabylonEffect().setDirectColor4("ufrag_19",l||_e.Transparent),t.getBabylonEffect().setVector2("ufrag_22",i.size);const s=null==h?void 0:h.lookupTableTexture;if((null===(c=null==h?void 0:h.pictureEffects)||void 0===c?void 0:c.lookupTable)&&s){const i=null==h?void 0:h.pictureEffects.lookupTable;t.getBabylonEffect().setFloat4("ufrag_23",i.dimensionR,i.dimensionG,i.dimensionB,i.blocksPerRow),t.setTexture("t_2",s.tryUseBabylonTexture(e,void 0,"drawTextureRects/lookupTableTexture"))}else t.getBabylonEffect().setFloat4("ufrag_23",0,0,0,0),t.setTexture("t_2",void 0);const n=null==h?void 0:h.ditherPalette256;n?(t.getBabylonEffect().setInt("ufrag_24",1),t.setTexture("t_3",n.tryUseBabylonTexture(e,void 0,"drawTextureRects/ditherPalette256"))):(t.getBabylonEffect().setInt("ufrag_24",0),t.setTexture("t_3",void 0))}else 8==t.programId&&(null==h?void 0:h.textureTransform)&&(t.getBabylonEffect().setVector2("ufrag_22",i.size),t.getBabylonEffect().setMatrix3x3("u_1",null==h?void 0:h.textureTransform.m),t.getBabylonEffect().setInt("ufrag_1",null!==(u=null===(d=null==h?void 0:h.drawMaskParams)||void 0===d?void 0:d.drawMaskMode)&&void 0!==u?u:0),t.getBabylonEffect().setFloat("ufrag_2",null!==(p=null===(f=null==h?void 0:h.drawMaskParams)||void 0===f?void 0:f.drawMaskParam)&&void 0!==p?p:0),t.getBabylonEffect().setVector2("ufrag_3",null!==(g=null===(m=null==h?void 0:h.drawMaskParams)||void 0===m?void 0:m.drawMaskFlipXY)&&void 0!==g?g:P.One),t.getBabylonEffect().setInt("ufrag_4",null!==(_=null===(v=null==h?void 0:h.drawMaskParams)||void 0===v?void 0:v.drawMaskOrder)&&void 0!==_?_:0),t.getBabylonEffect().setInt("ufrag_5",(null===(y=null==h?void 0:h.drawMaskParams)||void 0===y?void 0:y.drawMaskTransposeXY)?1:0));t.drawQuadInstances(b),t.disableInstanceAttribute("a_0"),t.disableInstanceAttribute("a_1"),x._releaseBuffer(C),x._releaseBuffer(S)}function ci(e){switch(e){case 4:case 5:case 1:case 2:break;default:throw O.Error(507910017,"Unsupported texture format")}}function di(e){return 0==(e&e-1)}class ui{constructor(e,t,i,r){this.triangleCount=t,this.vertexBuffer=i,this.indexBuffer=r,this.m_engine=e.getBabylonEngine(),this.m_compatibleGraphicsProcessorId=e.getUniqueGraphicsProcessorId()}isValid(e){return this.m_compatibleGraphicsProcessorId==e.getUniqueGraphicsProcessorId()}discard(){this.m_engine._releaseBuffer(this.vertexBuffer),this.m_engine._releaseBuffer(this.indexBuffer)}static CreateGridXY(e,t,i,r){const s=new Float32Array(t*i*2);for(let e=0;e<i;e++){const n=k(r.top,r.bottom,e/(i-1));for(let i=0;i<t;i++){const o=2*(i+e*t);s[o]=k(r.left,r.right,i/(t-1)),s[o+1]=n}}const n=new Uint16Array((t-1)*(i-1)*2*3);for(let e=0;e<i-1;e++)for(let i=0;i<t-1;i++)n.set([i+e*t,i+1+e*t,i+(e+1)*t,i+1+(e+1)*t,i+(e+1)*t,i+1+e*t],6*(i+e*(t-1)));const o=e.getBabylonEngine();return new ui(e,(t-1)*(i-1)*2,o.createVertexBuffer(s),o.createIndexBuffer(n))}}class fi{constructor(e,t){this.mode=e,this.order=t}clone(){return new fi(this.mode,this.order)}equals(e){return this.mode==e.mode&&this.order==e.order}}fi.Default=new fi(1,1);const pi=[{attributeName:"a_0",attributeSize:2,offset:0,divisor:0}],mi=[{attributeName:"a_1",attributeSize:2,offset:0,divisor:0}];function gi(e,t,i,r,s,n,o,a,l,h){const c=i.tryUseBabylonTexture(e,h,"blurSrc");if(!c)return void O.Error(592525250,"Invalid Texture");const d=r.tryGetBabylonTextureForRenderToTexture(e);if(!d)return void O.Error(572867298,"Invalid Texture");const u=e.activateShaderProgram(3);u.begin(d,_e.Transparent,!1);const f=u.getBabylonEffect();f.setFloat("u_0",n),f.setVector2("u_1",t),f.setVector2("u_2",a),f.setVector2("u_3",i.size),f.setInt("u_4",l?1:2),u.setTexture("tex_0",c),f.setDirectColor4("ufrag_0",s||_e.Transparent),f.setFloat("ufrag_2",Math.log(n/4)/Math.log(2)),f.setInt("ufrag_3",o),f.setInt("ufrag_4",l?1:2),u.drawQuads(1),u.end(),r.generateMipMap()}function vi(e,t){const i=Ci(t,e.contentLocation.logicalSize);let r=E.Scale2D(i.multiply(P.Flip(e.contentLocation.flipX,e.contentLocation.flipY)));return r=r.multiply(E.RotationZ(e.contentLocation.rotation)),r=r.multiply(E.Translation2D(e.contentLocation.logicalCenter)),r=r.multiply(E.Scale2D(e.size.inverse())),r=r.multiply(E.Translation2D(new P(-.5,-.5))),r}function _i(e){return e?e.size.x+"x"+e.size.y:"undefined"}class yi{constructor(e,t){this.contentRotation=0,this.depth=0,this.depthFar=0,this.depthNear=0,this.blendingMode=0,this.overallOpacity=1,this.contentCenter=e?e.center:P.Zero,this.contentSize=e?e.size:P.One,this.contentFlip=e?P.Flip(e.flipX,e.flipY):P.One,this.contentRotation=e?e.rotation:0,this.customMesh=t}getDebugStringInfo(){return["Layer"]}}class bi extends yi{constructor(e,t,i){super(t,i),this.texture=e}getDebugStringInfo(){return["Texture: "+_i(this.texture),(this.fadeInfo?" +Fade ":"")+(this.reflectionGradient?" + Reflection ":"")+(this.customMesh?" + CustomMesh ":"")]}}class wi extends yi{constructor(e,t,i,r,s,n){super({center:P.Zero,size:P.One,rotation:0,flipX:!1,flipY:!1},s),this.progress=0,this.textureA=e,this.textureB=t,this.panVector=n,i&&r&&(this.morphingGrid=[i,r])}getDebugStringInfo(){return["Textures: "+_i(this.textureA)+" ➡️ "+_i(this.textureB),(this.fadeInfo?" +Fade ":"")+(this.customMesh?" + CustomMesh ":"")+(this.morphingGrid?" + MorphingGrid ":"")]}}class Ti extends wi{constructor(e,t,i,r,s,n,o,a,l,h){super(e,t,o,a,l,h),this.textureDeltaWhiteA=i,this.textureDeltaWhiteB=r,this.texturePictureA=s,this.texturePictureB=n}getDebugStringInfo(){return["Textures: "+_i(this.textureA)+" ➡️ "+_i(this.textureB),"TexturesW: "+_i(this.textureDeltaWhiteA)+" ➡️ "+_i(this.textureDeltaWhiteB),"TextureP: "+_i(this.texturePictureA)+" ➡️ "+_i(this.texturePictureB),(this.fadeInfo?" +Fade ":"")+(this.customMesh?" + CustomMesh ":"")+(this.morphingGrid?" + MorphingGrid ":"")]}}class xi extends bi{constructor(e,t,i,r){super(e,t,r),this.fillBrightness=0,this.distanceFieldMode=2,this.style=i}getDebugStringInfo(){return["Texture: "+_i(this.texture),(this.fadeInfo?" +Fade ":"")+(this.reflectionGradient?" + Reflection ":"")+(this.customMesh?" + CustomMesh ":"")]}}function Ci(e,t){return 0!=e.x&&0!=e.y?t.divide(e):0!=e.x?P.One.scale(t.x/e.x):0!=e.y?P.One.scale(t.y/e.y):P.Zero}function Pi(e,t,i){const r=Ci(t,e.logicalSize),s=R.FromSizeAndCenter(e.physicalSize,e.physicalCenter.subtract(e.logicalCenter)),n=E.RotationZ(-e.rotation),o=E.ScaleTranslation2D(P.Flip(e.flipX,e.flipY).divide(r),i);return s.transformedBounds(n.multiply(o))}function Si(e,t,i,r){const s=Et(t.alignment,e),n=t.isStretched?e:e.transformedBounds(new M(s.negate(),i.originalSize.divide(e.size),0,s));if(n){const o=t.isStretched?t.offset.multiply(n.size):t.offset;let a=t.scale;if(t.isStretched&&t.fillToPreserveAspectRatio){const t=i.originalSize.x/i.originalSize.y,r=e.size.x/e.size.y;a=a.multiply(new P(t>r?t/r:1,t<r?r/t:1))}const l=t.rotation?E.RotationAroundPoint(t.rotation,n.relativeToAbsolute(t.rotationCenter)):M.Identity,h=new M(s.negate(),a,0,s.add(o)),c=n.transformedBounds(E.FromTransforms(l,h));return c&&r?c.transformedBounds(r):c}}function Ei(e,t,i,r,s,n,o){var a,l,h,c;const d=t instanceof bi?t:void 0,u=t instanceof wi?t:void 0,f=t instanceof Ti?t:void 0,p=u?u.textureA:d?d.texture:void 0,m=u?u.textureB:void 0,g=u&&u.panVector&&(!p||!m);let v=0;u&&(v=g?p?0:1:u.progress);const _=d?d.reflectionGradient:void 0,y=t instanceof xi&&!p;if(!y&&!(p&&p.isValidForGraphicsProcessor(e)||m&&m.isValidForGraphicsProcessor(e)))return void O.Error(592525252,"No Texture");const b=t.contentCenter;let w=E.Identity,T=E.Identity;const x=i.getBabylonEffect(),C=i.getBabylonEngine();if(u&&u.morphingGrid&&2==u.morphingGrid.length)x.setInt("u_16",1),x.setFloat("u_17",u.progress),C.bindInstancesBuffer(u.morphingGrid[0],pi),C.bindInstancesBuffer(u.morphingGrid[1],mi),w=E.Scale2D(t.contentSize),T=E.Scale2D(t.contentSize);else{x.setInt("u_16",0),x.setFloat("u_17",0),i.setDummyPointerAttribute("a_0"),i.setDummyPointerAttribute("a_1");const e=p?Pi(p.contentLocation,t.contentSize,t.contentCenter):y?R.FromSizeAndCenter(t.contentSize,t.contentCenter):void 0,r=m?Pi(m.contentLocation,t.contentSize,t.contentCenter):void 0;let s=e&&r?R.UnionRect(e,r):e||r;if(t instanceof xi&&t.style.pictureOverflow>0&&t.style.pictureBrush&&t.pictureTexture){const e=Si(t.fillBoundsOverride?t.fillBoundsOverride:R.FromSizeAndCenter(t.contentSize,t.contentCenter),t.style.pictureBrush,t.pictureTexture);e&&(s=R.UnionRect(s,e))}if(!s)return void O.Error(592525253,"Undefined physical bounds");if(s=s.translate(t.contentCenter.negate()),s=t.effectTransform?s.transformedBounds(t.effectTransform):s,s=s&&t.localClipRect?R.IntersectRect(s,t.localClipRect):s,!s)return;s=s.translate(t.contentCenter),w=E.ScaleTranslation2D(s.size,s.center.subtract(b));const n=t.effectTransform?t.effectTransform.inverse():void 0;T=n?w.multiply(n):w}const M=p?T.multiply(vi(p,t.contentSize)):E.Identity,B=m?T.multiply(vi(m,t.contentSize)):E.Identity;let I=E.Identity;if(t instanceof xi&&t.textCutoutTexture&&p){const e=t.textCutoutTransform||E.Identity;I=T.multiply(e).multiply(vi(t.textCutoutTexture,t.contentSize))}let A=b;g&&u&&u.panVector&&(A=b.add(u.panVector.scale(u.progress-(m?1:0))));let k=E.RotationZ(t.contentRotation).multiply(E.Translation2D(A));s&&(k=k.multiply(s)),x.setMatrix3x3("u_0",w.m),x.setVector2("u_15",t.contentFlip),x.setMatrix3x3("u_1",k.m),x.setVector2("u_2",r),x.setMatrix3x3("u_3",M.m),x.setMatrix3x3("u_11",I.m),x.setMatrix3x3("u_4",B.m),x.setFloat2("ufrag_12",_?_.opacity0:1,_?_.opacity1:1),x.setVector2("u_20",_?_.pos0:P.Zero),x.setVector2("u_21",_?_.pos1:P.Zero),x.setDirectColor4("ufrag_13",n||_e.Transparent),x.setFloat("ufrag_36",v);const D=t.fadeInfo?t.fadeInfo.fadeTexture:void 0;i.setTexture("t_3",D?D.tryUseBabylonTexture(e,t.clientObject,"fadeTexture"):void 0);let L=0;if(t.fadeInfo&&t.fadeInfo.fade){L=t.fadeInfo.fadeMode;const i=t.fadeInfo.fade,r=i.reverse?1-i.progress:i.progress;x.setVector2("ufrag_17",function(e,t,i){var r;let s=10;if(0==e.preset)s=1;else if(13==e.preset){const t=null!==(r=e.drawFadeOptions)&&void 0!==r?r:fi.Default;s=i&&0==t.mode?1:Math.max(10,30)}return e.reverse?new P(s-1,1-t*s):new P(1-s,t*s)}(i,r,t instanceof xi&&void 0!==t.pictureTexture)),0!=i.preset&&(t.fadeInfo.fadeTexture&&t.fadeInfo.fadeTexture.isValidForGraphicsProcessor(e)?x.setMatrix3x3("u_10",13==i.preset?T.multiply(vi(t.fadeInfo.fadeTexture,t.contentSize)).m:M.multiply(i.getFadeTransform()).m):O.Error(592525254,"fade texture missing"))}if(x.setInt("ufrag_16",L),x.setFloat("u_18",t.depthFar),x.setFloat("u_19",t.depthNear),x.setFloat("ufrag_41",t.overallOpacity),x.setMatrix3x3("ufrag_42",null!==(l=null===(a=t.colorMatrix)||void 0===a?void 0:a.m)&&void 0!==l?l:E.Identity.m),x.setVector3("ufrag_43",null!==(h=t.colorOffset)&&void 0!==h?h:S.Zero),x.setDirectColor4("ufrag_44",null!==(c=t.colorize)&&void 0!==c?c:_e.Transparent),t instanceof xi){let r;!function(e,t,i,r,s,n){var o;const a=i.texture,l=i.style;t.setFloat("ufrag_0",i.distRangeSize?.5/i.distRangeSize:1),t.setInt("ufrag_34",a?0:1);const h=7==n&&l.hitTransparentFill,c=l.fillBrush;let d=h?1:c?c.getType():0;const u=6==d?i.fillTexture:void 0;6!=d||u||(d=0);const f=c instanceof we?!c.color.equals(_e.Transparent):0!=d;if(t.setInt("ufrag_10",d),4==d)t.setFloatArray4("ufrag_3",Mi(c));else{const e=h?_e.White:1==d?c.color:7==d?c.foregroundColor:_e.Transparent;t.setDirectColor4("ufrag_3",e)}t.setInt("ufrag_18",6==d&&u&&4==u.wrapMode?1:0),t.setFloat("ufrag_20",6==d?c.opacity:1),t.setInt("u_13",7==d?1:0),t.setMatrix3x3("u_4",i.fillTransformUV?7==d?i.fillTransformUV.m:r.multiply(i.fillTransformUV).m:r.m),t.setDirectColor4("ufrag_22",7==d?c.backgroundColor:_e.Transparent),t.setFloat("ufrag_28",i.fillBrightness);const p=i.pictureTexture;if(t.setInt("ufrag_30",p?1:0),p){const e=l.pictureBrush;t.setInt("ufrag_31",p&&4==p.wrapMode?1:0),t.setFloat("ufrag_32",e.opacity),t.setMatrix3x3("u_5",i.pictureTransformUV?r.multiply(i.pictureTransformUV).m:E.Identity.m)}let m=0;7==he?m=3:7!=n||!l.hasLine||f||p||(m=null!==(o=l.hitTestSlop)&&void 0!==o?o:re);let g=l.lineBrush&&2!=n?l.lineBrush.getType():0;const v=6==g?i.lineTexture:void 0;6!=g||v||(g=0),m&&(g=1);const _=7==he?m:Math.max(m,l.hasLine?l.pen.adjustedLineWidth:0);if(t.setFloat("ufrag_1",_),t.setInt("ufrag_11",g),4==g)t.setFloatArray4("ufrag_4",Mi(l.lineBrush));else{let e=_e.Transparent;m?e=7==he?_e.Red:_e.White:1==g?e=l.lineBrush.color:7==g&&(e=l.lineBrush.foregroundColor),t.setDirectColor4("ufrag_4",e)}t.setInt("ufrag_19",6==g&&v&&4==v.wrapMode?1:0),t.setFloat("ufrag_21",6==g?l.lineBrush.opacity:1),t.setInt("u_14",7==g?1:0),t.setMatrix3x3("u_6",i.lineTransformUV?7==g?i.lineTransformUV.m:r.multiply(i.lineTransformUV).m:r.m),t.setDirectColor4("ufrag_23",7==g?l.lineBrush.backgroundColor:_e.Transparent),t.setFloat("ufrag_29",1==i.mergeMode?1:0),t.setFloat("ufrag_6",l.pen&&0!=l.pen.dashType&&l.pen.useRoundDash?1:0);const y=m?Ri[0]:!(b=l.pen).compoundType||b.tipType?Ri[0]:b.compoundType>=0&&b.compoundType<Ri.length?Ri[b.compoundType]:(O.Error(587220940,"unsupported compoundType"),Ri[0]);var b;t.setFloatArray3("ufrag_8",y.centers),t.setFloatArray3("ufrag_9",y.slopes);const w=Math.sqrt(2)/2,T=new P(w,w),x=s?s.transformVector(T).length():1;if(t.setFloat("ufrag_2",1/x),t.setFloat("ufrag_27",F(xt(l.pen),-1,1)*_/2),t.setInt("ufrag_37",a&&2==i.distanceFieldMode?1:0),t.setInt("ufrag_38",0==l.pen.dashType&&0==l.pen.compoundType||7==n?1:0),i.softEdges&&i.softEdges.radius>0&&i.softEdgesTexture&&i.softEdgesTexture.isValidForGraphicsProcessor(e)?(t.setInt("ufrag_24",1),t.setMatrix3x3("u_7",r.multiply(vi(i.softEdgesTexture,i.contentSize)).m)):(t.setInt("ufrag_24",0),i.softEdges&&i.softEdges.radius>0&&O.Error(588006213,"soft edges texture not ready")),i.innerShadow&&i.innerShadow.color.a>0&&i.innerShadowTexture&&i.innerShadowTexture.isValidForGraphicsProcessor(e)){const e=new P(i.innerShadow.distance,0).rotate(i.innerShadow.angle),s=r.multiply(E.Translation2D(e)).multiply(vi(i.innerShadowTexture,i.contentSize));t.setInt("ufrag_25",1),t.setMatrix3x3("u_8",s.m),t.setDirectColor4("ufrag_26",i.innerShadow.color)}else t.setInt("ufrag_25",0),i.innerShadow&&i.innerShadow.color.a>0&&O.Error(588006214,"inner shadow  exture not ready");t.setInt("ufrag_39",i.textRenderMode||0),t.setFloat("ufrag_40",l.pictureOverflow),t.setInt("ufrag_15",7==n||5==n?1:5==he?10:0!=he&&7!=he?he+10:0),7==he&&(t.setInt("ufrag_10",0),t.setInt("ufrag_11",1)),0==n&&3==i.blendingMode&&t.setDirectColor4("ufrag_13",_e.White)}(e,x,t,T,s,o),i.setTexture("t_0",p?p.tryUseBabylonTexture(e,t.clientObject,"distanceField"):void 0),i.setTexture("t_1",t.fillTexture?t.fillTexture.tryUseBabylonTexture(e,t.clientObject,"fillTexture"):void 0),i.setTexture("t_2",t.lineTexture?t.lineTexture.tryUseBabylonTexture(e,t.clientObject,"lineTexture"):void 0),i.setTexture("t_4",t.softEdgesTexture?t.softEdgesTexture.tryUseBabylonTexture(e,t.clientObject,"softEdgesTexture"):void 0),i.setTexture("t_5",t.innerShadowTexture?t.innerShadowTexture.tryUseBabylonTexture(e,t.clientObject,"innerShadowTexture"):void 0),t.pictureTexture&&7==o&&t.style.hitTransparentFill?r=e.whiteTexture:t.pictureTexture&&(r=t.pictureTexture.tryUseBabylonTexture(e,t.clientObject,"pictureTexture")),i.setTexture("t_6",r),i.setTexture("t_7",t.textCutoutTexture?t.textCutoutTexture.tryUseBabylonTexture(e,t.clientObject,"textCutoutTexture"):void 0)}else!function(e){e.setFloat("ufrag_0",0),e.setFloat("ufrag_1",0),e.setFloat("ufrag_2",0),e.setDirectColor4("ufrag_3",_e.Transparent),e.setDirectColor4("ufrag_4",_e.Transparent),e.setFloat("ufrag_6",0),e.setFloatArray3("ufrag_8",new Float32Array([0,0,0])),e.setFloatArray3("ufrag_9",new Float32Array([0,0,0])),e.setInt("ufrag_10",0),e.setInt("ufrag_11",0),e.setInt("ufrag_18",0),e.setInt("ufrag_19",0),e.setFloat("ufrag_20",1),e.setFloat("ufrag_21",1),e.setDirectColor4("ufrag_22",_e.Transparent),e.setDirectColor4("ufrag_23",_e.Transparent),e.setInt("ufrag_24",0),e.setInt("ufrag_25",0),e.setDirectColor4("ufrag_26",_e.Transparent),e.setFloat("ufrag_27",0),e.setFloat("ufrag_28",0),e.setFloat("ufrag_29",0),e.setInt("ufrag_30",0),e.setInt("ufrag_31",0),e.setFloat("ufrag_32",0),e.setInt("ufrag_34",0),e.setInt("u_13",0),e.setInt("u_14",0),e.setInt("ufrag_39",0),e.setFloat("ufrag_40",0)}(x),x.setInt("ufrag_15",f?3:2),i.setTexture("t_0",p?p.tryUseBabylonTexture(e,t.clientObject,t instanceof wi?"morphA":"sprite"):void 0),i.setTexture("t_1",m?m.tryUseBabylonTexture(e,t.clientObject,"morphB"):void 0),i.setTexture("t_2",f?f.textureDeltaWhiteA.tryUseBabylonTexture(e,t.clientObject,"morphAW"):void 0),i.setTexture("t_4",f?f.textureDeltaWhiteB.tryUseBabylonTexture(e,t.clientObject,"morphBW"):void 0),i.setTexture("t_5",f?f.texturePictureA.tryUseBabylonTexture(e,t.clientObject,"morphAP"):void 0),i.setTexture("t_6",f?f.texturePictureB.tryUseBabylonTexture(e,t.clientObject,"morphBP"):void 0),i.setTexture("t_7",void 0),f&&x.setMatrix3x3("u_5",f.pictureTransformUV?T.multiply(f.pictureTransformUV).m:E.Identity.m);const U=0==o,V=1==t.blendingMode||5==t.blendingMode;x.setInt("ufrag_35",U&&V?1:0),i.setBlendingMode(U?t.blendingMode:0),t.customMesh?i.drawMesh(t.customMesh):i.drawQuads(1)}function Mi(e){const t=e.fillToRect?e.fillToRect:new R(.5,.5,.5,.5),i=e.fillFromRect?e.fillFromRect:new R(0,0,1,1),r=t.translate(i.leftTop.negate()).multiply(i.size.inverse());return new Float32Array([1/r.left,1/r.top,1/(1-r.right),1/(1-r.bottom)])}const Ri=[{centers:new Float32Array([0,0,0]),slopes:new Float32Array([1,1,1])},{centers:new Float32Array([-2/3,2/3,2/3]),slopes:new Float32Array([3,3,3])},{centers:new Float32Array([-.4,.8,.8]),slopes:new Float32Array([5/3,5,5])},{centers:new Float32Array([-.8,.4,.4]),slopes:new Float32Array([5,5/3,5/3])},{centers:new Float32Array([-5/6,0,5/6]),slopes:new Float32Array([6,3,6])}],Bi=[1,1,2,4,8,16,16];function Ii(e,t,i=!1,r=!1,s){const n=[],o=r?[]:void 0;if(!e.figures||0==e.figures.length)return{buffers:n,endDistance:0};let a=0;for(let l=0;l<e.figures.length;l++){const h=i?e.figures[l].toPolygon():e.figures[l],c=G(43),d=h.isLastPointDuplicated(),u=h.isClosed||d,f=Ai(h.points,h.format,43,0,d?h.points.length-h.pointDataSize:h.points.length,1,3,u,e.maxPressure),p=f.length/c;let m;if(r){const e=Fi(f,43,u,a,s,1,3);m=e.distanceArray,a=e.endDistance}const g=f.length;if(g>t){const e=t/c-4,i=Math.ceil((p-4)/e),r=e+4;let s=0;for(let e=0;e<i;e++){const e=Math.min(r,p-s),t=e-4;n.push(f.subarray(s*c,(s+e)*c)),o&&m&&o.push(m.subarray(s,s+e)),s+=t}}else{const e=new Float32Array(4*Math.ceil(g/4));e.set(f,0),n.push(e),o&&m&&o.push(m)}}return o&&o.length!=n.length&&O.Error(592525388,"Invalid distance array"),{buffers:n,distanceBuffers:o,endDistance:a}}function Ai(e,t,i,r=0,s=e.length,n=0,o=0,a=!0,l=1){let h=G(t),c=s-r;if(!(c%h==0&&1&t&&1&i))throw O.Error(592525389,"list of source points invalid");let d=e,u=c/h;1==u&&(d=new Float32Array(2*e.length),d.set(e,0),d.set(e,e.length),u=2);const f=h;h=G(i);const p=new Float32Array((n+u+o)*h);for(let e=0;e<u;e++){let s=r+e*f,o=(n+e)*h;for(const e of Bi)e&i&&(p[o]=8==e?e&t?d[s]/l:1:e&t?d[s]:2==e?1:0,o++),e&t&&s++}if((n||o)&&(n>0&&p.copyWithin(0,p.length-(n+o)*h,p.length-o*h),o>0&&p.copyWithin(p.length-o*h,n*h,(n+o)*h),!a&&2&i)){for(let e=0;e<n;e++)p[e*h+2]=0;for(let e=0;e<o;e++)p[p.length-(e+1)*h+2]=0}return p}function Fi(e,t,i,r=0,s,n=0,o=0){const a=s?function(e,t,i){const r=G(t);if(0==r||e.length%r!=0||!(1&t))throw O.Error(592525390,"list of points for invalid for measuring distance");const s=i.m,n=new Float32Array(e);for(let t=0;t<e.length;t+=r){const i=e[t],r=e[t+1];n[t]=i*s[0]+r*s[3]+s[6],n[t+1]=i*s[1]+r*s[4]+s[7]}return n}(e,t,s):e,l=G(t);if(0==l||a.length%l!=0||a.length/l<n+o+1||!(1&t))throw O.Error(587534800,"list of points for invalid for measuring distance");const h=new Float32Array(a.length/l),c=n*l,d=(a.length-o*l-c)/l,u=2&t;let f=r||0;for(let e=0;e<d;e++){const t=c+e*l;if(2!=(u?a[t+2]:1)&&(h[n+e]=f,i||e<d-1)){const r=c+(e+1)%d*l,s=u?a[r+2]:1;if(2!=s){let e=a[r]-a[t],i=a[r+1]-a[t+1];f+=Math.sqrt(e*e+i*i)}else if(2==s&&(i||e<d-2)){const i=c+(e+2)%d*l;f+=D(a[t],a[t+1],a[r],a[r+1],a[i],a[i+1])}}}const p=f-r;for(let e=0;e<n;e++)h[e]=h[n+d-n+e]-p;for(let e=n+d;e<a.length/l;e++)h[e]=h[e+n-(n+d)]+p;for(let e=0;e<d;e++){const t=c+e*l;if(u&&2==a[t+2]){const t=0==n&&0==e?d-1:n+e-1,i=0==o&&e==d-1?n:n+e+1;h[n+e]=.5*(h[t]+h[i])}}return{distanceArray:h,endDistance:f}}class ki{constructor(e,t,i,r,s,n,o,a){this.m_renderer=t,this.pathIndexRange=i,this.fillMode=r,this.distRangeSize=0,this.contentQuality=0,this.enableMipMap=!1,this.mergeMode=0,this.distanceFieldMode=n,this.scenario=e,this.releasePolicy=o,this.isDisplacementMap=a}get size(){return this.texture?this.texture.size:P.Zero}refresh(e,t,i){const r=e,s=r.getGraphicsProcessor();if(!s)throw O.Error(591524387,"Graphics processor not initialized");const n=jt.readBooleanOrDefault("forceRefreshDistanceField",!1);if(!i&&!n&&this.geometryUniqueId==t.geometryTracker.currentUniqueId&&this.texture&&this.texture.isValidForGraphicsProcessor(s))return!0;const o=this.getContentBounds(t);if(!o)return O.Error(570959637,"Shape has no bounds"),this.texture&&this.texture.release(),!1;const a=this.getQualityToUse(t),l=this.getPixelPaddingInShapeUnits(t),h=o.size.scale(a).add(new P(2*l*a,2*l*a)),c=this.enableMipMap?new P(A(h.x),A(h.y)):h.ceil(),d=c.scale(Math.min(1,Kt/c.x,Kt/c.y)).ceil(),u=new P(F(d.x,16,Kt),F(d.y,16,Kt)),f=this.texture;if(this.texture=si.RecycleOrReplace(this.scenario,f,e,u,this.isDisplacementMap,5,!0,this.releasePolicy),!this.texture||!this.texture.graphicsProcessor)return!1;if(i&&f!=this.texture)return O.Error(591524416,"Cannot update incrementally: texture had to be recreated"),!1;const p=a*Math.min(u.x/h.x,u.y/h.y),m=R.FromSizeAndCenter(u.scale(1/p),o.center),g=l*p/a;return this.rasterize(t,i,m,p,g,r.getCurrentFramePerformanceSummary()),!0}getQualityToUse(e){return this.qualityOverride?this.qualityOverride:e.hasSmallDetails()?2*Xt:Xt}getContentBounds(e){if(this.contentBoundsOverride)return this.contentBoundsOverride;const t=e.incrementalPath?e.incrementalPath.bounds:Ct(e,1!=this.distanceFieldMode);if(!t)return;const i=t.size;if(!isFinite(i.x)||!isFinite(i.y))return void O.Error(562151697,`Invalid shape bounds for SDF: ${i.x} x ${i.y}, scenario: ${this.scenario}`);const r=e.transform.scale;if(isFinite(r.x)&&isFinite(r.y))return t.multiply(r.abs());O.Error(562151698,`Invalid shape scale for SDF: ${r.x} x ${r.y}, scenario: ${this.scenario}`)}getFillBrightness(){return 2==this.fillMode?.4:3==this.fillMode?.2:4==this.fillMode?-.4:5==this.fillMode?-.2:0}getPixelPaddingInShapeUnits(e){var t;if(null!=this.paddingOverride)return this.paddingOverride;const i=jt.readNumberOrDefault("maxReasonableZoomOut",10);if(e.style.hasLine){const r=null!==(t=e.style.hitTestSlop)&&void 0!==t?t:re;return Math.ceil(Math.max(r/2,i))}return i}rasterize(e,t,i,r,s,n){if(!this.texture||!this.texture.graphicsProcessor)return O.Error(591524418,"No gl texture or context"),!1;const o=e.transform.scale.abs();let a=Ct(e,!1,E.Scale2D(o).multiply(new M(i.center.negate(),e.transform.scale.sign(),0,i.center).toMatrix3()));if(!a)return O.Error(591524420,"Nothing to render"),!1;const l=new P(r,r),h=i.size,c=this.size.scale(.5),d=new M(i.center.negate(),l,0,c),u=i.transformedBounds(d),f=a.transformedBounds(d);if(!u||!f)return O.Error(588006216,"Nothing to render"),!1;if(this.contentQuality=r,this.localBounds=i?i.multiply(o.inverse()):void 0,this.renderScale=l.divide(this.size),this.uvScale=h.multiply(this.renderScale).multiply(e.transform.scale.sign()),this.texture.contentLocation={logicalCenter:f.center,logicalSize:f.size,physicalCenter:u.center,physicalSize:u.size,rotation:0,flipX:e.transform.scale.x<0,flipY:e.transform.scale.y<0},!this.localBounds||!this.renderScale)return O.Error(591524421,"no bounds or renderScale"),!1;n.pixelCountDistanceField+=Math.floor(this.size.x*this.size.y);const p=5==he;let m=.5*(e.style.pen?e.style.pen.adjustedLineWidth*(1+Math.min(Math.abs(xt(e.style.pen)),1)):0);if(this.isDisplacementMap&&e.shape3D){let t=.5*Math.max(e.shape3D.topBevel?e.shape3D.topBevel.size.x:0,e.shape3D.bottomBevel?e.shape3D.bottomBevel.size.x:0,e.shape3D?.5*e.shape3D.adjustedContourWidth:0);m=Math.max(m,2*t-m)}return this.distRangeSize=p?Math.max(h.x/2,h.y/2):Math.max(m,s),function(e,t,i,r,s,n,o,a,l,h,c,d,u){const f=performance.now(),p=i.texture;if(!p)return O.Error(572842049,"DistanceFieldTexture not initialized"),!1;let m,g=c?void 0:_e.Transparent;if(r.paths&&!r.incrementalPath)m=Ki(e,t,r.paths,r.style.hasLine?r.style.pen:void 0,!1,1!=l,2==l,r.transform.scale,s,d,u,!!i.isGlyphCache,!!i.isGlyphCacheDisabled);else if(r.incrementalPath){const n=p.tag,o=n&&n.incrementalPathTrackerId==r.incrementalPath.changeTracker.trackerId;(!o||n&&(0==n.figureCount||1==n.figureCount&&0==n.lastFigurePointCount))&&(g=_e.Transparent);const a=o&&n.figureCount>0?n.figureCount-1:0,h=[];for(let e=a;e<r.incrementalPath.figures.length;e++){const t=r.incrementalPath.figures[e],i=o&&e==a&&n.lastFigurePointCount>0?n.lastFigurePointCount-1:0,s=t.getPointCount();h.push(new z(t.data.slice(i*r.incrementalPath.pointDataSize,s*r.incrementalPath.pointDataSize),!1,r.incrementalPath.format))}p.tag={incrementalPathTrackerId:r.incrementalPath.changeTracker.trackerId,figureCount:r.incrementalPath.figures.length,lastFigurePointCount:r.incrementalPath.figures.length>0?r.incrementalPath.figures[r.incrementalPath.figures.length-1].getPointCount():0},m=Ki(e,t,[new V({figures:h,fillMode:0})],r.style.hasLine?r.style.pen:void 0,!1,1!=l,2==l,r.transform.scale,s,d,u,!!i.isGlyphCache,!!i.isGlyphCacheDisabled)}if(!m)return O.Error(592525084,"Nothing to render"),!1;const v=e.activateShaderProgram(0);v.begin(p.tryGetBabylonTextureForRenderToTexture(e),g,!1);const _=v.getBabylonEffect();_.setVector2("u_0",n.center.multiply(r.transform.scale)),_.setVector2("u_1",r.transform.scale),_.setVector2("u_2",o),_.setFloat("u_3",h),_.setFloat("ufrag_10",r.style&&r.style.pen?2*h/(r.style.pen.adjustedLineWidthForArrowHead+1):0),_.setFloat("ufrag_11",r.transform.scale.x*r.transform.scale.y),_.setInt("ufrag_7",he),_.setInt("u_13",he),_.setInt("u_15",0==r.style.pen.compoundType?0:1),_.setVector2("u_17",r.style.pen.tipScale?r.style.pen.tipScale:P.One),_.setInt("u_18",r.style.pen.tipType?r.style.pen.tipType:0);const y=(r.style.pen.adjustedLineWidth/2+1/i.contentQuality)/(2*h);_.setFloat("ufrag_15",0==r.style.pen.alignment?y:2*y);for(const e of m.transformedPaths){const i=Xi(a);if(i)for(let s=i.start;s<=i.last;s++)Yi(s,!0,e,a,d)&&(Ji(v,s,!0,r),2==s?v.drawQuads(1):Qi(v,s,!0,r,[e],a,l,d,t.getCurrentFramePerformanceSummary(),h,null!=r.shape3D))}const b=function(e){return 1==e?Ue.FromFirstLast(0,0):Ue.FromFirstLast(0,1==he||2==he?0:2)}(a);if(b)for(let e=b.start;e<=b.last;e++)Ji(v,e,!1,r),2==e?v.drawQuads(1):Qi(v,e,!1,r,m.transformedPaths,a,l,d,t.getCurrentFramePerformanceSummary(),h,null!=r.shape3D);if(v.end(),ei&&Li&&m.cachedGlyphsPages.length>0){const t=e.activateShaderProgram(5);if(t.begin(p.tryGetBabylonTextureForRenderToTexture(e),void 0,!1),Zi(t,0,0),i.localBounds&&i.uvScale)for(const r of m.cachedGlyphsPages)if(r.cachedGlyphInstances.length>0){const s=new Array(r.cachedGlyphInstances.length),n=new Array(r.cachedGlyphInstances.length);for(let e=0;e<r.cachedGlyphInstances.length;e++){const t=r.cachedGlyphInstances[e];s[e]=t.srcRect,n[e]=t.dstRect.translate(i.localBounds.center.negate()).multiply(p.size.multiply(i.uvScale).multiply(i.localBounds.size.inverse())).translate(p.size.scale(.5))}const o=Li[r.page].texture;o?hi(e,t,o,s,n,p.size,0,Li[r.page].distRangeSize/i.distRangeSize*(r.cachedGlyphInstances[0].dstRect.size.y/r.cachedGlyphInstances[0].srcRect.size.y)):O.Error(572867297,"glyphPageTexture missing")}t.end()}return p.renderCost=performance.now()-f,!0}(this.texture.graphicsProcessor,this.m_renderer,this,e,this.pathIndexRange,this.localBounds,this.renderScale,this.mergeMode,this.distanceFieldMode,this.distRangeSize,t,1==this.generateDrawFadeMask,this.isDisplacementMap)&&(this.geometryUniqueId=e.geometryTracker.currentUniqueId,this.lastKnownQualitySetting=Xt,this.lastKnownLineWidth=e.style.pen.adjustedLineWidth,this.lastKnownLineWidthForArrowHead=e.style.pen.adjustedLineWidthForArrowHead,this.lastKnownHitTestSlop=re,this.enableMipMap&&this.texture.generateMipMap()),!1}}function Di(e){return e?e.fontId+":"+e.glyphId:void 0}let Li,Oi={},Ui=[],Vi=0;function Ni(){for(let e of Li||[])e.texture&&e.texture.release();Li=void 0,Oi={},Ui=[]}const Gi=4096;function zi(){return Vi-16}function Hi(){return zi()/16}function Wi(){return 7*Hi()/8}function $i(){return Hi()/16}const qi=[{attributeName:"a_p0",attributeSize:4,offset:0},{attributeName:"a_p1",attributeSize:4,offset:16},{attributeName:"a_p2",attributeSize:4,offset:32},{attributeName:"a_p3",attributeSize:4,offset:48},{attributeName:"a_p4",attributeSize:4,offset:64}],ji=[{attributeName:"a_d1",attributeSize:1,offset:4},{attributeName:"a_d2",attributeSize:1,offset:8}];function Xi(e){if(1==e)return Ue.FromFirstLast(0,3)}function Yi(e,t,i,r,s){return!(s&&0!=e||1!=r&&t||0!=e&&0==i.fillMode)}function Ki(e,t,i,r,s,n,o,a,l,h,c,d,u){const f=4096,p=[],m=[];if(0==i.length)return{transformedPaths:p,cachedGlyphsPages:m};l&&(l.start<0||l.last>=i.length)&&O.Error(592525078,"pathIndexRange out of range");const g=l?Math.max(l.start,0):0,v=l?Math.min(l.last,i.length-1):i.length-1,_=r&&(Z(r.headEnd,r.adjustedLineWidthForArrowHead)>0||Z(r.tailEnd,r.adjustedLineWidthForArrowHead)>0),y=h||!!r&&0!=r.dashType||_,b=ei&&!r;for(let l=g;l<=v;l++){const h=i[l];if(c&&!h.extrusionEnabled)continue;const g=h.transform.scale.x>=Wi()/Gi;h.glyphCacheId?d?t.getCurrentFramePerformanceSummary().glyphCountAddedToCache++:(t.getCurrentFramePerformanceSummary().glyphCount++,g&&t.getCurrentFramePerformanceSummary().glyphCountLargeText++,null!=r&&t.getCurrentFramePerformanceSummary().glyphCountTextOutline++):t.getCurrentFramePerformanceSummary().pathCount++;let v=!1;const _=Di(h.glyphCacheId);if(!u&&_&&b&&Li&&0==h.transform.rotation&&Math.abs(h.transform.scale.x-h.transform.scale.y)<C&&!g&&Oi[_]){const e=Oi[_];if(e.page<0||e.page>=Li.length)O.Error(592525079,"Invalid glyph page");else{const i=Li[e.page];if(i.texture){const r=i.localBounds?i.localBounds.center:void 0,s=i.localBounds&&r&&i.uvScale?i.localBounds.translate(r.negate()).multiply(i.uvScale.inverse()).translate(r):void 0,n=i.localBounds&&s&&i.uvScale?e.bounds.multiply(i.uvScale).translate(s.leftTop.negate()):void 0,o=e.bounds.translate(e.offset.negate()).multiply(new P(1/e.scale,1/e.scale)).transformedBounds(h.transform);if(n)if(o)if(n.right<0||n.bottom<0||n.left>=zi()||n.top>=zi())O.Error(592525082,"Cached glyph src rect out of bounds");else{const i={srcRect:n,dstRect:o,distanceScale:1};let r;for(let t=0;t<m.length&&!r;t++)m[t].page==e.page&&(r=m[t]);r||(r={page:e.page,cachedGlyphInstances:[]},m.push(r)),r.cachedGlyphInstances.push(i),v=!0,t.getCurrentFramePerformanceSummary().glyphCountReadFromCache++}else O.Error(592525081,"Cached glyph dst rect undefined");else O.Error(592525080,"Cached glyph src rect undefined")}else O.Error(572867295,"Glyph page texure missing")}}if(!v){h.glyphCacheId&&!d&&t.getCurrentFramePerformanceSummary().glyphCountRenderedAsPath++;const i=t.ensurePathRenderData(h);i.refreshCachedHwTapeBuffers(h,e);let l,u=i.tapeBuffers,m=0;if(!u||y||s)if(y||s){const e=Ii(h,f,s,y,y?E.FromTransforms(h.transform,E.Scale2D(a)):void 0);u=e.buffers,l=e.distanceBuffers,m=e.endDistance}else u=i.refreshCachedTapeBuffers(h);const g=e.getBabylonEngine();let v,_=i.hwTapeBuffers;_||(_=u.map((e=>g.createVertexBuffer(e)))),l&&(v=l.map((e=>g.createVertexBuffer(e))));const b=h.transform.toMatrix3(),w={tapeBuffers:u,hwTapeBuffers:_,hwDistanceBuffers:v,fillMode:c?1:o?0:h.fillMode,lineEnabled:n&&h.lineEnabled,isArrowHead:!1,transform:b,startDistance:0,endDistance:m};if(p.push(w),o&&r&&(0!=r.headEnd.end||0!=r.tailEnd.end)){const e=r.adjustedLineWidthForArrowHead,t=b.multiply(E.Scale2D(a)),i=E.Scale2D(a.inverse());for(const s of h.figures){const n=s.isClosed||s.isLastPointDuplicated();if(r.headEnd&&0!=r.headEnd.end&&!n){const n=j(r.headEnd,e);if(n){const o=K(s,!1,r.headEnd,e,t),a=Ii(V.CreateFromFigure(n),f).buffers;p.push({tapeBuffers:a,hwTapeBuffers:a.map((e=>g.createVertexBuffer(e))),hwDistanceBuffers:void 0,fillMode:5==r.headEnd.end?0:1,lineEnabled:!0,isArrowHead:!0,transform:o?o.multiply(i):void 0,startDistance:0,endDistance:0})}}if(r.tailEnd&&0!=r.tailEnd.end&&!n){const n=j(r.tailEnd,e);if(n){const o=K(s,!0,r.tailEnd,e,t),a=Ii(V.CreateFromFigure(n),f).buffers;p.push({tapeBuffers:a,hwTapeBuffers:a.map((e=>g.createVertexBuffer(e))),hwDistanceBuffers:void 0,fillMode:5==r.tailEnd.end?0:1,lineEnabled:!0,isArrowHead:!0,transform:o?o.multiply(i):void 0,startDistance:0,endDistance:0})}}}}}}return{transformedPaths:p,cachedGlyphsPages:m}}function Zi(e,t,i){const r=e.getBabylonEngine();0==t?(r.setColorWrite(!0),r.depthCullingState.depthMask=!0,r.stencilState.stencilTest=!1,r.stencilState.stencilMask=255,r.stencilState.stencilFunc=519,r.stencilState.stencilFuncRef=0,r.stencilState.stencilFuncMask=3,r.alphaState.alphaBlend=!0,r.alphaState.setAlphaBlendFunctionParameters(1,1,1,1),r.alphaState.setAlphaEquationParameters(32776,32776),r.clear(null,!1,!1,!0)):1==t?(r.setColorWrite(!1),r.depthCullingState.depthMask=!1,r.stencilState.stencilTest=!0,r.stencilState.stencilMask=255,r.stencilState.stencilFunc=519,r.stencilState.stencilFuncRef=1,r.stencilState.stencilFuncMask=255):(r.setColorWrite(!0),r.depthCullingState.depthMask=!0,r.stencilState.stencilMask=0,2==t?(r.stencilState.stencilTest=!0,r.stencilState.stencilFunc=517,r.stencilState.stencilFuncRef=0,r.stencilState.stencilFuncMask=1==i?255:3,r.alphaState.alphaBlend=!0,r.alphaState.setAlphaBlendFunctionParameters(775,769,773,771),r.alphaState.setAlphaEquationParameters(32774,32774)):3==t&&(r.stencilState.stencilTest=!1,r.alphaState.alphaBlend=!0,r.alphaState.setAlphaBlendFunctionParameters(772,1,0,0),r.alphaState.setAlphaEquationParameters(32774,32774)))}function Ji(e,t,i,r){let s=i&&!(3==t);Zi(e,t,r.overlapMode);const n=e.getBabylonEffect();n.setInt("u_7",t),n.setInt("ufrag_0",t),n.setFloat("ufrag_8",s?1:0);let o=0;const a=tr(r.style.pen);if(a&&a.length>0)for(let e=0;e<a.length;e++)o+=a[e];0==o&&(o=1);const l=0==r.style.pen.headEnd.cap?1:0;n.setFloat("ufrag_5",a&&a.length>0?.5-(a[0]-l)/(2*o):0),n.setFloat("ufrag_4",a&&a.length>0?1/(o*r.style.pen.adjustedLineWidth):0)}function Qi(e,t,i,r,s,n,o,a,l,h,c){if(0==t&&3==he)return;let d=-performance.now();const u=e.getBabylonEffect(),f=e.getBabylonEngine();u.setFloat("u_12",r.style.pen.adjustedLineWidth),u.setFloat("u_5",r.style.pen.miterLimit);let p=0;const m=tr(r.style.pen),g=m?m.length:0;if(r.style.pen&&m){for(let e=0;e<g;e++)p+=m[e];p=p>0?p:1,u.setFloat("ufrag_12",p/2),u.setFloat4("ufrag_13",g>=2?m[0]/2:p,g>=3?m[0]/2+m[1]:p,g>=4?m[0]/2+m[1]+m[2]:p,g>=5?m[0]/2+m[1]+m[2]+m[3]:p)}else u.setFloat("ufrag_12",.5),u.setFloat4("ufrag_13",1,1,1,1);u.setFloat("u_14",s.length>0&&s[0].isArrowHead||0==r.style.pen.headEnd.cap?1:0);for(const l of s){if(!Yi(t,i,l,n,a))continue;const d=(0!=l.fillMode||2==o)&&2==o==l.isArrowHead&&(0==n||1==n&&i),p=l.lineEnabled&&!l.isArrowHead,m=l.isArrowHead&&0==l.fillMode,g=m?p:d,v=m?d:p;u.setMatrix3x3("u_8",l.transform?l.transform.m:E.Identity.m),u.setInt("ufrag_17",a?1:0),a&&u.setFloat("ufrag_12",1/l.endDistance),u.setFloat("ufrag_19",l.isArrowHead&&0==l.fillMode&&h?r.style.pen.adjustedLineWidth/4/h:0);const _=s.length>0&&l.isArrowHead||c?1:r.style.pen?r.style.pen.lineJoin:0;u.setInt("u_4",_),u.setInt("ufrag_1",_);for(let i=0;i<l.tapeBuffers.length;i++){const s=l.tapeBuffers[i],n=l.hwTapeBuffers[i],o=l.hwDistanceBuffers?l.hwDistanceBuffers[i]:void 0,a=s.length/4-4;if(f.bindInstancesBuffer(n,qi,!1),o?(u.setInt("u_19",0),f.bindInstancesBuffer(o,ji,!1)):(u.setInt("u_19",1),e.setDummyPointerAttribute("a_d1"),e.setDummyPointerAttribute("a_d2")),0==s[2]&&l.startDistance!=l.endDistance){const e=Z(r.style.pen.headEnd,r.style.pen.adjustedLineWidthForArrowHead),t=Z(r.style.pen.tailEnd,r.style.pen.adjustedLineWidthForArrowHead);u.setFloat2("ufrag_16",l.startDistance+e,l.endDistance-t)}else u.setFloat2("ufrag_16",0,0);u.setFloat("ufrag_2",g?1:0),u.setFloat("ufrag_3",v?1:0),u.setFloat("ufrag_18",m?1:0),1==t?(u.setFloat("ufrag_6",1),e.setDistanceFieldStencilSumIncrement(!0),e.drawQuadInstances(a),u.setFloat("ufrag_6",-1),e.setDistanceFieldStencilSumIncrement(!1),e.drawQuadInstances(a)):e.drawQuadInstances(a)}}e.disableInstanceAttribute("a_p0"),e.disableInstanceAttribute("a_p1"),e.disableInstanceAttribute("a_p2"),e.disableInstanceAttribute("a_p3"),e.disableInstanceAttribute("a_p4"),e.disableInstanceAttribute("a_d1"),e.disableInstanceAttribute("a_d2"),d+=performance.now(),l.drawTapeCostMs+=d}function er(e,t,i,r){const s=Ui[t],n=[];for(const e of s)r&&e.ready||(n.push(e.path),e.ready=!0);if(n.length>0){const t=new bt(n);return t.style.pen.lineWidth=$i(),t.overlapMode=1,i.refresh(e,t,r)}return!0}function tr(e){if(1!=e.tipType)return e.dashType>=0&&e.dashType<ir.length?ir[e.dashType]:void O.Error(591192836,"unsupported dashType")}const ir=[null,new Float32Array([3,1]),new Float32Array([1,1]),new Float32Array([3,1,1,1]),new Float32Array([3,1,1,1,1,1]),new Float32Array([1,3]),new Float32Array([4,3]),new Float32Array([8,3]),new Float32Array([4,3,1,3]),new Float32Array([8,3,1,3]),new Float32Array([8,3,1,3,1,3])];class rr{constructor(){this.m_compatibleGraphicsProcessorId=0}get tapeBuffers(){return this.m_tapeBuffers}get hwTapeBuffers(){return this.m_hwTapeBuffers}releaseGeneratedResources(){if(this.m_hwTapeBuffers&&this.m_engine)for(const e of this.m_hwTapeBuffers)this.m_engine._releaseBuffer(e);this.m_hwTapeBuffers=void 0}onFinalization(){}refreshCachedTapeBuffers(e){return this.m_tapeBuffers||(this.m_tapeBuffers=Ii(e,4096).buffers),this.m_tapeBuffers}refreshCachedHwTapeBuffers(e,t){if(!this.m_hwTapeBuffers||!this.m_engine||this.m_compatibleGraphicsProcessorId!=t.getUniqueGraphicsProcessorId()){const i=Ii(e,4096,!1,!1,void 0),r=t.getBabylonEngine();this.m_hwTapeBuffers=i.buffers.map((e=>r.createVertexBuffer(e))),this.m_compatibleGraphicsProcessorId=t.getUniqueGraphicsProcessorId(),this.m_engine=t.getBabylonEngine()}return this.m_hwTapeBuffers}}class sr{constructor(e,t){this.m_state=e,this.m_texture=t}getState(){return this.m_state}getSize(){return this.m_texture?this.m_texture.size:void 0}getLogicalCenter(){return this.m_texture&&this.m_texture.contentLocation?this.m_texture.contentLocation.logicalCenter:void 0}tryConvertToBufferRGBA(){return this.m_texture instanceof si?this.m_texture.tryConvertToBufferRGBA():void 0}}class nr{constructor(){this.m_state=0}releaseGeneratedResources(){this.m_texture&&(this.m_texture.release(),this.m_state=2)}onFinalization(){}get texture(){return this.m_texture}get loader(){return this.m_loader}set texture(e){this.m_loader&&(this.m_loader.release(),this.m_loader=void 0),this.m_texture=e,this.m_state=1}set loader(e){this.m_texture&&(this.m_texture=void 0),this.m_loader&&this.m_loader!=e&&this.m_loader.release(),this.m_loader=e,this.m_state=1}get state(){return this.m_state}}const or=new P(1024,1024);function ar(e){const t=e.gradientStops.length,i=new Float32Array(t+2),r=new Float32Array(4*(t+2));for(let s=0;s<t+2;s++){const n=Math.min(Math.max(s-1,0),t-1),o=e.gradientStops[n].color;i[s]=0==s?0:s==t+1?1:e.gradientStops[n].position,r[4*s+0]=o.r,r[4*s+1]=o.g,r[4*s+2]=o.b,r[4*s+3]=o.a}return{stops:i,colors:r}}const lr=[{attributeName:"a_p1",attributeSize:4,offset:16},{attributeName:"a_p2",attributeSize:4,offset:32}],hr=new P(8,8),cr=[[255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0],[7,64,29,0,116,0,208,1,64,7,0,29,0,116,1,208],[1,208,0,116,0,29,64,7,208,1,116,0,29,0,7,64],[255,255,3,0,3,0,3,0,3,0,3,0,3,0,3,0],[7,208,29,116,116,29,208,7,208,7,116,29,29,116,7,208],[3,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0],[3,0,0,0,0,3,0,0,3,0,0,0,0,3,0,0],[3,3,0,0,48,48,0,0,3,3,0,0,48,48,0,0],[3,3,48,48,3,3,48,48,3,3,48,48,3,3,48,48],[51,51,12,12,51,51,192,192,51,51,12,12,51,51,192,192],[51,51,204,204,51,51,204,192,51,51,204,204,51,51,192,204],[51,51,204,204,51,51,204,204,51,51,204,204,51,51,204,204],[63,63,204,204,243,243,204,204,63,63,204,204,243,243,204,204],[252,252,207,207,252,252,207,207,252,252,207,207,252,252,207,207],[252,252,255,255,207,207,255,255,252,252,255,255,207,207,255,255],[63,255,255,255,255,63,255,255,63,255,255,255,255,63,255,255],[255,255,255,255,255,255,255,252,255,255,255,255,255,255,252,255],[3,3,12,12,48,48,192,192,3,3,12,12,48,48,192,192],[192,192,48,48,12,12,3,3,192,192,48,48,12,12,3,3],[15,15,60,60,240,240,195,195,15,15,60,60,240,240,195,195],[240,240,60,60,15,15,195,195,240,240,60,60,15,15,195,195],[15,192,63,0,252,0,240,3,192,15,0,63,0,252,3,240],[3,240,0,252,0,63,192,15,240,3,252,0,63,0,15,192],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0],[204,204,204,204,204,204,204,204,204,204,204,204,204,204,204,204],[255,255,0,0,255,255,0,0,255,255,0,0,255,255,0,0],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[255,255,255,255,0,0,0,0,255,255,255,255,0,0,0,0],[0,0,0,0,3,3,12,12,48,48,192,192,0,0,0,0],[0,0,0,0,192,192,48,48,12,12,3,3,0,0,0,0],[255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0],[3,0,3,0,3,0,3,0,0,3,0,3,0,3,0,3],[3,0,0,3,12,0,0,48,192,0,0,192,48,0,0,12],[243,192,240,0,0,240,192,243,207,3,15,0,0,15,3,207],[3,192,12,48,48,12,192,3,3,192,12,48,48,12,192,3],[0,0,192,3,48,204,15,0,0,0,192,3,48,204,15,0],[0,192,0,48,0,12,0,3,192,3,48,12,12,48,3,192],[255,255,3,0,3,0,3,0,255,255,0,3,0,3,0,3],[3,3,204,12,48,48,12,204,3,3,192,12,48,48,204,192],[51,51,204,204,51,51,204,204,255,0,255,0,255,0,255,0],[0,0,192,0,0,3,192,0,0,0,3,0,0,192,3,0],[51,51,0,0,3,0,0,0,3,0,0,0,3,0,0,0],[3,0,0,0,48,48,0,0,0,3,0,0,48,48,0,0],[0,240,3,12,12,3,240,0,0,15,0,48,0,192,0,192],[255,255,60,60,255,255,195,195,255,255,60,60,255,255,195,195],[252,252,3,195,3,255,3,255,252,252,195,3,255,3,255,3],[255,255,3,3,3,3,3,3,255,255,3,3,3,3,3,3],[195,195,60,60,60,60,195,195,195,195,60,60,60,60,195,195],[255,0,255,0,255,0,255,0,0,255,0,255,0,255,0,255],[3,48,12,12,48,3,192,0,48,3,12,12,3,48,0,192],[192,0,240,3,252,15,255,63,252,15,240,3,192,0,0,0]];var dr;!function(e){e[e.fromBegining=0]="fromBegining",e[e.distanceFieldsReady=1]="distanceFieldsReady",e[e.brushTexturesReady=2]="brushTexturesReady",e[e.fadeReady=3]="fadeReady",e[e.effectsReady=4]="effectsReady"}(dr||(dr={}));class ur{constructor(){this.initTextureStage=dr.fromBegining,this.fadeMode=0,this.spriteQuality=0,this.spriteHitTest=!1,this.isBlankSlate=!1}get resolvedFillTexture(){var e;return this.fillTexture instanceof ri?this.fillTexture:null===(e=this.fillTexture)||void 0===e?void 0:e.loader.getTexture(this.fillTexture.wrapMode)}get resolvedLineTexture(){var e;return this.lineTexture instanceof ri?this.lineTexture:null===(e=this.lineTexture)||void 0===e?void 0:e.loader.getTexture(this.lineTexture.wrapMode)}get resolvedPictureTexture(){var e;return this.pictureTexture instanceof ri?this.pictureTexture:null===(e=this.pictureTexture)||void 0===e?void 0:e.loader.getTexture(this.pictureTexture.wrapMode)}beforeInitTextures(e,t){if(this.isBlankSlate=!1,this.clientData=e.clientData,this.hasInvalidTexture(t)&&this.clearTextures(),this.checkDistanceFields(e),this.lastKnownShapeVersion==e.version&&e.alphaTracker.version==this.lastKnownAlphaVersion||(this.clearEffectsTextures(this.lastKnownShapeVersion!=e.version,e.alphaTracker.version!=this.lastKnownAlphaVersion),this.drawDistribution=void 0),this.lastKnownShapeVersion=e.version,this.lastKnownAlphaVersion=e.alphaTracker.version,1==e.getType()){const t=e;t.geometryTracker.version!=this.lastKnownGeometryVersion&&(this.initTextureStage=dr.fromBegining,this.lastKnownGeometryVersion=t.geometryTracker.version)}}getFulltextureList(){const e=[this.resolvedFillTexture,this.resolvedLineTexture,this.resolvedPictureTexture,this.innerShadowTexture,this.softEdgesTexture,this.glowTexture,this.shadowTexture,this.reflectionTexture,this.fadeTexture,this.spriteTexture];for(let t of this.distanceFields||[])e.push(t.texture);return this.coutoutLayer&&e.push(this.coutoutLayer.texture),e}getBevelDistanceField(){for(let e of this.distanceFields||[])if(e.isDisplacementMap)return e}hasInvalidTexture(e){const t=this.getFulltextureList();for(let e of this.distanceFields||[])t.push(e.texture);for(let i of t)if(i&&!i.isValidForGraphicsProcessor(e))return!0;return!1}checkDistanceFields(e){if(1==e.getType()){const t=e;for(let e of this.distanceFields||[])if(e.geometryUniqueId!=t.geometryTracker.currentUniqueId||e.lastKnownQualitySetting!=Xt||e.lastKnownLineWidth!=t.style.pen.adjustedLineWidth||e.lastKnownLineWidthForArrowHead!=t.style.pen.adjustedLineWidthForArrowHead||e.lastKnownHitTestSlop!=re)return void this.clearTextures()}}clearBounds(){this.initTextureStage=dr.fromBegining}clearEffectsTextures(e,t){this.initTextureStage=dr.fromBegining,e&&(this.reflectionTexture&&this.reflectionTexture.release(),this.fadeTexture&&this.fadeTexture.release(),this.spriteTexture&&this.spriteTexture.release(),this.reflectionTexture=this.fadeTexture=this.spriteTexture=void 0),t&&(this.innerShadowTexture&&this.innerShadowTexture.release(),this.softEdgesTexture&&this.softEdgesTexture.release(),this.glowTexture&&this.glowTexture.release(),this.shadowTexture&&this.shadowTexture.release(),this.innerShadowTexture=this.softEdgesTexture=this.glowTexture=this.shadowTexture=void 0)}clearBrushTextures(){var e,t,i,r,s,n;this.fillTexture instanceof ri&&1==this.fillTexture.releasePolicy&&(this.fillTexture.release(),this.fillTexture=void 0),this.lineTexture instanceof ri&&1==this.lineTexture.releasePolicy&&(this.lineTexture.release(),this.lineTexture=void 0),this.pictureTexture instanceof ri&&1==this.pictureTexture.releasePolicy&&(this.pictureTexture.release(),this.pictureTexture=void 0),(null===(e=this.fillLookupTableCache)||void 0===e?void 0:e.texture)&&(null===(t=this.fillLookupTableCache)||void 0===t||t.texture.release(),this.fillLookupTableCache=void 0),(null===(i=this.lineLookupTableCache)||void 0===i?void 0:i.texture)&&(null===(r=this.lineLookupTableCache)||void 0===r||r.texture.release(),this.lineLookupTableCache=void 0),(null===(s=this.pictureLookupTableCache)||void 0===s?void 0:s.texture)&&(null===(n=this.pictureLookupTableCache)||void 0===n||n.texture.release(),this.pictureLookupTableCache=void 0)}clearTextures(){this.initTextureStage=dr.fromBegining;for(let e of this.distanceFields||[])e&&e.texture&&e.texture.release();this.clearBrushTextures(),this.clearEffectsTextures(!0,!0),this.distanceFields=void 0}releaseGeneratedResources(){var e;this.clearBounds(),this.clearTextures(),this.isBlankSlate=!0,this.coutoutLayer&&(null===(e=this.coutoutLayer.texture)||void 0===e||e.release(),this.coutoutLayer=void 0)}initFadeTexture(e,t,i){var r,s,n,o;if(!e.getGraphicsProcessor())return;const a=i?13==i.preset?t.changeTracker.currentUniqueId:i.param+":"+i.preset:"";if(!this.fadeTexture||i&&0!=i.preset&&this.fadeTexture.isValid(e)&&this.fadeTexture.tag==a||(this.fadeTexture.release(),this.fadeTexture=void 0),!this.fadeTexture)if(1==t.getType()&&i&&13==i.preset){const a=t,l=a.style.pictureBrush,h=l?e.getTextureFromImageBrush(l):void 0;if(l&&h){const t=si.RecycleOrReplace("PictureDrawFade",void 0,e,h.size,!0,5,!1,1,4);t.originalSize=h.originalSize;const a=Et(l.alignment),c=new M(a.negate(),l.scale,0,a.add(l.offset)),d=new M(new P(0,-1),new P(1,-1)),u=E.FromTransforms(d,c.toInverseMatrix3(),d),f=null!==(s=null===(r=i.drawFadeOptions)||void 0===r?void 0:r.mode)&&void 0!==s?s:0,p=null!==(o=null===(n=i.drawFadeOptions)||void 0===n?void 0:n.order)&&void 0!==o?o:0,m=i.param,g=P.Flip(i.flipX,i.flipY),v=i.transposeXY;e.drawTextureToTexture(t,h,5,{textureTransform:u,drawMaskParams:{drawMaskMode:f,drawMaskOrder:p,drawMaskParam:m,drawMaskFlipXY:g,drawMaskTransposeXY:v}}),this.fadeTexture=t,this.fadeMode=3}else if(a.paths&&a.paths.length>0){const t=new ki("FadeMask/Draw",e,void 0,1,a.mergeMode,0,1,!1);t.generateDrawFadeMask=!0,t.refresh(e,a,!1),this.fadeTexture=t.texture,this.fadeMode=2}}else i&&0!=i.preset&&13!=i.preset?(this.fadeTexture=function(e,t,i,r,s){const n=e.getGraphicsProcessor();if(!n)throw O.Error(592525321,"Graphics processor not initialized");const o=si.RecycleOrReplace("FadeMask/Standard",t,e,or,!1,5,!1,1);return o.tag=s,function(e,t,i,r){const s=performance.now(),n=e.activateShaderProgram(4);n.begin(t.tryGetBabylonTextureForRenderToTexture(e),_e.Black,!1);const o=n.getBabylonEffect();o.setInt("ufrag_0",i),o.setFloat("ufrag_1",r),n.drawQuads(1),n.end(),t.renderCost=performance.now()-s}(n,o,i,r),o}(e,this.fadeTexture,i.preset,i.param,a),this.fadeMode=2):this.fadeMode=i?1:0}getBrushTexture(e){switch(e){case 0:return this.fillTexture;case 1:return this.lineTexture;case 2:return this.pictureTexture}O.Error(591192833,"Invalid brush source")}setBrushTexture(e,t){switch(e){case 0:this.fillTexture=t;break;case 1:this.lineTexture=t;break;case 2:this.pictureTexture=t;break;default:O.Error(591192834,"Invalid brush source")}}initBrushTexture(e,t,i){const r=this.getBrushTexture(i),s=function(e,t,i,r){var s,n,o,a;const l=e.getGraphicsProcessor();if(!l)return;const h=t instanceof ri&&!t.isValidForGraphicsProcessor(l);let c=t;const d=function(e,t){const i=e.getType();if(1==i){const i=e.style;switch(t){case 0:return i.fillBrush;case 1:return i.lineBrush;case 2:return i.pictureBrush}}if(2==i&&0==t)return e.groupFillBrush;O.Error(591192835,"Invalid item or brush")}(i,r);if(d){const l=d.getType();if(6==l){const l=d;if(l.image){const u=d.wrapMode,f=void 0!==u?u:4,p=e.ensureImageRenderData(l.image);2==p.state?O.Error(592472275,`Trying to use deleted texture id:${l.image.id}`):0==p.state&&O.Error(592472276,`Trying to use uninitialized texture id:${l.image.id}`);const m=p.texture,g=l.pictureEffects||(i instanceof bt&&2==r?i.style.pictureEffects:void 0);if(p.loader&&i instanceof bt){const e=Ct(i,!1,E.Scale2D(i.transform.scale.abs()));let t=null!==(s=null==e?void 0:e.size.x)&&void 0!==s?s:0,r=null!==(n=null==e?void 0:e.size.y)&&void 0!==n?n:0;for(const e of i.instances||[]){const s=Ct(i,!1,e.transform.toMatrix3());t=Math.max(t,null!==(o=null==s?void 0:s.width)&&void 0!==o?o:0),r=Math.max(t,null!==(a=null==s?void 0:s.height)&&void 0!==a?a:0)}t>0&&r>0&&p.loader.prepareForRenderSize(new P(t,r)),c={loader:p.loader,wrapMode:f}}else!h&&t instanceof ri&&(t==m||m&&t.tag==m.changeTracker.currentUniqueId)||(c=!(null==g?void 0:g.hasImpact)&&m&&m.wrapMode!=f?m.cloneWithNewWrapMode("ImageWrapResample",e,f,1):m);if(null==g?void 0:g.hasImpact){const s=c instanceof ri?c:null==c?void 0:c.loader.getTexture(c.wrapMode);if(s){const n=s.changeTracker.currentUniqueId+"/"+g.changeTracker.currentUniqueId+"/"+f;if(t instanceof ri&&!h&&t.tag==n)c=t;else{const o=e.ensureRenderNode(i).cache.ensureLookupTableTexture(e,r,g.lookupTable);c=function(e,t,i,r,s,n){var o,a;if(!e.getGraphicsProcessor())return;const l=si.RecycleOrReplace("PictureEffects",t,e,i.size,!1,i.format,!1,1,s);if(l.originalSize=i.originalSize,!(null===(o=null==r?void 0:r.sharpness)||void 0===o?void 0:o.hasImpact)||le)e.drawTextureToTexture(l,i,1,{pictureEffects:r,lookupTableTexture:n});else{const t=new si("PictureEffects/Sharpness/BlurIntermediateTexture",e,i.size,1);t.originalSize=i.originalSize,function(e,t,i,r,s){const n=t.originalSize.x/t.originalSize.y;li(e,t,t,s,0,n,[new R(0,0,t.size.x,t.size.y)],[new R(0,0,s.size.x,s.size.y)],s.size,r),li(e,t,s,i,1,n,[new R(0,0,s.size.x,s.size.y)],[new R(0,0,i.size.x,i.size.y)],i.size,r)}(e,i,t,r.sharpness,l),e.drawTextureToTexture(l,t,1,{pictureEffects:r,lookupTableTexture:n}),t.release()}return(2===(null===(a=e.getBabylonEngine())||void 0===a?void 0:a.webGLVersion)||di(l.size.x)&&di(l.size.y))&&l.generateMipMap(),l}(e,t!=m&&t instanceof si?t:void 0,s,g,f,o),c&&(c.tag=n)}}}}else c=void 0}else if(7==l){let i=-performance.now();t&&!h&&t instanceof ri&&t.tag==d.pattern||(c=function(e,t,i){if(!e.getGraphicsProcessor())throw O.Error(592525326,"Graphics processor not initialized");if(t<0||t>53)return void O.Error(592525327,"pattern out of range");const r=new Uint8Array(64),s=cr[t];for(let e=0;e<16;e++){const t=s[e];for(let i=0;i<4;i++){const s=(t&3<<2*i)>>2*i,n=0==s?255:1==s?127:0;r[4*e+i]=n}}const n=ri.CreateFromByteBuffer("Pattern",e,hr,r,1,0,!1,!1,1);return n.tag=t,n}(e,d.pattern)),i+=performance.now(),e.getCurrentFramePerformanceSummary().patternTextureCostMs+=i}else if(be.IsGradient(l)){let r=-performance.now();if(5==l){const s=t instanceof si?t:void 0;s&&!h&&s.tag==i.changeTracker.currentUniqueId||(i instanceof bt?c=function(e,t,i,r,s){const n=e.getGraphicsProcessor();if(!n)throw O.Error(592525324,"Graphics processor not initialized");if(5!=r.getType())throw O.Error(592525325,"This is not a path gradient");const o=Ct(i,!1);if(!o||o.isEmpty()||!i.paths)return;const a=o.size.multiply(i.transform.scale.abs()),l=a.scale(Math.min(1,Kt/a.x,Kt/a.y)),h=new P(Math.floor(l.x+1),Math.floor(l.y+1)),c=si.RecycleOrReplace("PathGradient",t,e,h,!1,5,!1,1);return c.tag=i.changeTracker.currentUniqueId,function(e,t,i,r,s,n){const o=performance.now(),a=ar(i),l=a.colors,h=a.colors.length<4?_e.Transparent:new _e(l[l.length-4],l[l.length-3],l[l.length-2],l[l.length-1]),c=e.activateShaderProgram(2);c.begin(t.tryGetBabylonTextureForRenderToTexture(e),h,!1);const d=c.getBabylonEffect(),u=c.getBabylonEngine();if(d.setInt("u_0",1),d.setVector2("u_1",s),d.setVector2("u_2",n),d.setFloatArray("bfrag_0",a.stops),d.setFloatArray4("bfrag_1",a.colors),d.setInt("ufrag_0",0),d.setInt("ufrag_3",i&&i.isGammaCorrected?1:0),d.setInt("ufrag_4",i.blendBellShape?1:0),d.setVector2("ufrag_5",i.blendBellShape||P.Zero),r){const e=4096;for(const t of r){const i=t.transform.toMatrix3(),r=Ii(t,e,!0).buffers,s=r.map((e=>u.createVertexBuffer(e)));for(let e=0;e<r.length;e++){const t=r[e].length/4-4;u.bindInstancesBuffer(s[e],lr,!1),d.setMatrix3x3("u_3",i.m),c.drawQuadInstances(t),u._releaseBuffer(s[e])}}c.disableInstanceAttribute("a_p1"),c.disableInstanceAttribute("a_p2")}c.end(),t.renderCost=performance.now()-o}(n,c,r,i.paths,o.center,o.size.inverse()),c}(e,s,i,d):O.Error(592525320,"Path gradient only supported on Shape items")),r+=performance.now(),e.getCurrentFramePerformanceSummary().pathGradientTextureCostMs+=r}else{const i=t instanceof si?t:void 0;i&&!h&&i.tag==d.changeTracker.currentUniqueId||(c=function(e,t,i,r){const s=e.getGraphicsProcessor();if(!s)throw O.Error(592525322,"Graphics processor not initialized");const n=i.getType();if(2!=n&&4!=n&&3!=n)throw O.Error(592525323,"Unsupported Gradient type");const o=new P(256,2==n||4==n?1:256),a=2==n?"LinearGradient":4==n?"RectangularGradient":"RadialGradient",l=si.RecycleOrReplace(a,t,e,o,!1,5,!1,1);return l.tag=i.changeTracker.currentUniqueId,function(e,t,i){const r=performance.now(),s=ar(i),n=e.activateShaderProgram(2);n.begin(t.tryGetBabylonTextureForRenderToTexture(e),_e.Black,!1);const o=n.getBabylonEffect();n.setDummyPointerAttribute("a_p1"),n.setDummyPointerAttribute("a_p2"),o.setFloatArray("bfrag_0",s.stops),o.setFloatArray4("bfrag_1",s.colors),o.setInt("u_0",0);const a=i&&3==i.getType();if(o.setInt("ufrag_0",a?1:0),o.setFloat("ufrag_6",i&&i.isGammaCorrected?2.2:1),o.setFloat("ufrag_7",i&&i.alphaGamma),i&&a){const e=i.fillToRect?i.fillToRect.center:new P(.5,.5),t=i.fillFromRect?e.subtract(i.fillFromRect.leftTop).divide(i.fillFromRect.size):e;o.setVector2("ufrag_2",t)}o.setInt("ufrag_4",i.blendBellShape?1:0),o.setVector2("ufrag_5",i.blendBellShape||P.Zero),n.drawQuads(1),n.end(),t.renderCost=performance.now()-r}(s,l,i),l}(e,i,d)),r+=performance.now(),e.getCurrentFramePerformanceSummary().gradientTextureCostMs+=r}}}else c=void 0;return t&&t!=c&&t instanceof ri&&1==t.releasePolicy&&t.release(),c}(e,r,t,i);r!=s&&this.setBrushTexture(i,s)}initTextCutoutLayer(e,t,i){var r;if(t){this.coutoutLayer=new ki("TextCutoutLayer",e,void 0,1,0,0,1,!1),this.coutoutLayer.isGlyphCacheDisabled=!0;const r=new bt(t,i.style);this.coutoutLayer.refresh(e,r,!1);const s=Ct(r,!1);this.coutoutLayerCenter=null==s?void 0:s.center}else this.coutoutLayer&&(null===(r=this.coutoutLayer.texture)||void 0===r||r.release(),this.coutoutLayer=void 0)}updateLookupTableCache(e,t,i){let r=t;return t?t.texture&&(!i||!t.texture.isValid(e)||i&&t.lookupTable&&i!=t.lookupTable&&!i.equals(t.lookupTable))&&(t.texture.release(),t.texture=void 0):i&&(r={lookupTable:i}),r&&!r.texture&&i&&(r.texture=function(e,t,i){return ri.CreateFromByteBuffer("LookupTable",e,t.resolution,t.table,4,4,!0,!1,1,!1,1)}(e,i)),r}ensureLookupTableTexture(e,t,i){var r,s,n;switch(t){case 0:return this.fillLookupTableCache=this.updateLookupTableCache(e,this.fillLookupTableCache,i),null===(r=this.fillLookupTableCache)||void 0===r?void 0:r.texture;case 1:return this.lineLookupTableCache=this.updateLookupTableCache(e,this.lineLookupTableCache,i),null===(s=this.lineLookupTableCache)||void 0===s?void 0:s.texture;case 2:return this.pictureLookupTableCache=this.updateLookupTableCache(e,this.pictureLookupTableCache,i),null===(n=this.pictureLookupTableCache)||void 0===n?void 0:n.texture}O.Error(509728260,"Invalid brush source")}}class fr{constructor(){}releaseGeneratedResources(){this.texture&&1==this.texture.releasePolicy&&this.texture.release(),this.textureDeltaWhite&&1==this.textureDeltaWhite.releasePolicy&&this.textureDeltaWhite.release(),this.texturePicture&&1==this.texturePicture.releasePolicy&&this.texturePicture.release()}onFinalization(){}}class pr{constructor(){}releaseGeneratedResources(){var e;null===(e=this.interpolatedShapeSprite)||void 0===e||e.release()}onFinalization(){}}class mr{constructor(){this.renderers=[]}dumpLastScene(){console.log(this.lastRenderer&&this.lastScene?this.lastRenderer.getDebugString(this.lastScene):void 0)}static OnRender(e,t){if(!jt.readBooleanOrDefault("debugTool",!1))return;const i=window;i.shapeBuilderDebugTool||(i.shapeBuilderDebugTool=new mr);const r=i.shapeBuilderDebugTool;if(r.lastRenderer=e,r.lastScene=1==t.length?t[0].item:void 0,t.length>1){const e=new wt;for(let i of t)e.items.push(i.item);r.lastScene=e}r.renderers.includes(e)||r.renderers.push(e)}}function gr(e,t,i,r,s){if(!i)return E.Identity;const n=i.getType();if(7==n)return E.Scale2D(s.scale(1/16));const o=be.IsGradient(n);if(6!=n&&!o)return E.Identity;const a=i.rotateWithShape;let l=0;const h=a?E.Scale2D(t.transform.scale):t.transform.toMatrix3(),c=Ct(t,r,h);let d=t.fillBoundsOverride?t.fillBoundsOverride:c;if(t.fillBoundsOverride&&d&&a&&(d=d.transformedBounds(E.FromTransforms(t.transform.toInverseMatrix3(),h))),!c||!d)return E.Identity;const u=d.size;let f=P.One,p=P.Zero,m=!0,g=4;if(6==n){const t=i;if(p=t.offset,f=t.scale.abs(),l=t.rotation,m=t.isStretched,g=t.alignment,m){if(f=f.multiply(u),t.fillToPreserveAspectRatio){const i=e.getTextureFromImageBrush(t);if(i){const e=i.originalSize.x/i.originalSize.y,t=u.x/u.y;f=f.multiply(new P(e>t?e/t:1,e<t?t/e:1))}else O.Error(524026452,"No texture")}p=p.multiply(u)}else{const i=e.getTextureFromImageBrush(t);i?f=f.multiply(i.originalSize):O.Error(590960595,"No texture")}}else if(5==n)f=u;else if(o){const e=i;if(f=e.fillFromRect?e.fillFromRect.size:P.One,p=(e.fillFromRect?e.fillFromRect.center:P.Zero).subtract(new P(.5,.5)).multiply(u),m=e.isStretched||4==n,2==n){f=f.multiply(u);const t=m?R.FromSize(P.One):R.FromSize(f),i=t.transformedBounds(E.RotationZ(e.angle));f=i?f.scale(i.width/t.width):f,l=e.angle}else m?f=f.multiply(u):(f=f.scale(Math.max(u.x,u.y)),3==n&&(f=f.scale(Math.sqrt(u.x*u.x+u.y*u.y)/Math.max(u.x,u.y))))}else f=f.multiply(u);const v=new R(-u.x/2+f.x/2,-u.y/2+f.y/2,u.x/2-f.x/2,u.y/2-f.y/2);p=p.add(Et(g,v)).multiply(new P(1,-1));let _=E.Identity;if(_=_.multiply(E.Translation2D(c.center.subtract(d.center))),_=_.multiply(E.Scale2D(new P(1,-1))),a||(_=_.multiply(E.Scale2D(t.transform.scale.sign())),_=_.multiply(E.RotationZ(-t.transform.rotation))),_=_.multiply(E.Translation2D(p.negate())),l)if(o)_=_.multiply(E.Translation2D(d.center.subtract(c.center))),m&&(_=_.multiply(E.Scale2D(u.inverse()))),_=_.multiply(E.RotationZ(l)),m&&(_=_.multiply(E.Scale2D(u))),_=_.multiply(E.Translation2D(c.center.subtract(d.center)));else if(6==n){const e=i.rotationCenter.add(new P(-.5,-.5)).multiply(new P(f.x,-f.y));_=_.multiply(E.RotationAroundPoint(l,e))}return _=_.multiply(E.Scale2D(f.inverse())),_=_.multiply(E.Scale2D(new P(1,-1))),_}function vr(e,t,i,r,s,n,o,a,l,h,c,d,u,f,p){const m=e.getGraphicsProcessor();if(!m)return void O.Error(572867293,"Unable to get graphicsProcessor");const g=Ct(n,!1);if(!g)return void O.Error(588006215,"Unable to get bounds");const v=new xi(i?i.texture:void 0,ii(g,n.transform),n.style);if(v.fillTexture=t.resolvedFillTexture||void 0,v.lineTexture=t.resolvedLineTexture||void 0,v.pictureTexture=t.resolvedPictureTexture||void 0,v.innerShadowTexture=t.innerShadowTexture||void 0,v.softEdgesTexture=t.softEdgesTexture||void 0,v.fillTransformUV=gr(e,n,n.style.fillBrush,!1,o),v.pictureTransformUV=gr(e,n,n.style.pictureBrush,!1,o),v.lineTransformUV=gr(e,n,n.style.lineBrush,!0,o),v.localClipRect=c,v.fillBrightness=i?i.getFillBrightness():0,v.mergeMode=n.mergeMode,v.distanceFieldMode=i?i.distanceFieldMode:2,v.distRangeSize=i?i.distRangeSize:0,v.softEdges=n.effects&&16&r?n.effects.softEdges:void 0,v.innerShadow=n.effects&&8&r?n.effects.innerShadow:void 0,v.blendingMode=n.style.blendingMode,v.fillBoundsOverride=n.fillBoundsOverride,(0==l||7==l)&&t.fade&&(v.fadeInfo={fade:t.fade,fadeTexture:t.fadeTexture,fadeMode:t.fadeMode}),v.clientObject=t,n.text&&0!=n.text.renderMode)if(n.text&&n.text.cache instanceof it&&t.coutoutLayer&&t.coutoutLayer.texture&&t.coutoutLayerCenter){v.textRenderMode=n.text.renderMode;const e=t.coutoutLayer.texture.contentLocation.logicalSize.scale(1/t.coutoutLayer.contentQuality),i=g.multiply(n.transform.scale.abs()),r=t.coutoutLayerCenter;v.textCutoutTransform=E.Scale2D(n.transform.scale.sign()),v.textCutoutTransform=v.textCutoutTransform.multiply(E.Translation2D(i.center)),v.textCutoutTransform=v.textCutoutTransform.multiply(n.text.frameToShape.toInverseMatrix3()),v.textCutoutTransform=v.textCutoutTransform.multiply(E.Translation2D(n.transform.preTranslation.multiply(n.transform.scale.abs()).subtract(r))),v.textCutoutTransform=v.textCutoutTransform.multiply(E.Scale2D(i.size.divide(e))),v.textCutoutTexture=t.coutoutLayer.texture}else if(2!=n.text.renderMode)return;v.overallOpacity=d,v.colorMatrix=u,v.colorOffset=f,v.colorize=p;const _=performance.now();Ei(m,v,s,o,a,5==l?_e.White:h,l),e.onLayerRendered(3==n.role?"text":"shape","SDF",_,v)}var _r=function(){function e(){}return e._AddLogEntry=function(t){e._LogCache=t+e._LogCache,e.OnNewCacheEntry&&e.OnNewCacheEntry(t)},e._FormatMessage=function(e){var t=function(e){return e<10?"0"+e:""+e},i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e},e._LogDisabled=function(e){},e._LogEnabled=function(t){var i=e._FormatMessage(t);console.log("BJS - "+i);var r="<div style='color:white'>"+i+"</div><br>";e._AddLogEntry(r)},e._WarnDisabled=function(e){},e._WarnEnabled=function(t){var i=e._FormatMessage(t);console.warn("BJS - "+i);var r="<div style='color:orange'>"+i+"</div><br>";e._AddLogEntry(r)},e._ErrorDisabled=function(e){},e._ErrorEnabled=function(t){e.errorsCount++;var i=e._FormatMessage(t);console.error("BJS - "+i);var r="<div style='color:red'>"+i+"</div><br>";e._AddLogEntry(r)},Object.defineProperty(e,"LogCache",{get:function(){return e._LogCache},enumerable:!1,configurable:!0}),e.ClearLogCache=function(){e._LogCache="",e.errorsCount=0},Object.defineProperty(e,"LogLevels",{set:function(t){(t&e.MessageLogLevel)===e.MessageLogLevel?e.Log=e._LogEnabled:e.Log=e._LogDisabled,(t&e.WarningLogLevel)===e.WarningLogLevel?e.Warn=e._WarnEnabled:e.Warn=e._WarnDisabled,(t&e.ErrorLogLevel)===e.ErrorLogLevel?e.Error=e._ErrorEnabled:e.Error=e._ErrorDisabled},enumerable:!1,configurable:!0}),e.NoneLogLevel=0,e.MessageLogLevel=1,e.WarningLogLevel=2,e.ErrorLogLevel=4,e.AllLogLevel=7,e._LogCache="",e.errorsCount=0,e.Log=e._LogEnabled,e.Warn=e._WarnEnabled,e.Error=e._ErrorEnabled,e}(),yr=function(){function e(){}return Object.defineProperty(e,"LastCreatedEngine",{get:function(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return this._LastCreatedScene},enumerable:!1,configurable:!0}),e.Instances=new Array,e._LastCreatedScene=null,e.UseFallbackTexture=!0,e.FallbackTexture="",e}(),br=function(){function e(){}return e.IsWindowObjectExist=function(){return"undefined"!=typeof window},e.IsNavigatorAvailable=function(){return"undefined"!=typeof navigator},e.IsDocumentAvailable=function(){return"undefined"!=typeof document},e.GetDOMTextContent=function(e){for(var t="",i=e.firstChild;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t},e}(),wr=function(){function e(){}return e.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},e.StartsWith=function(e,t){return!!e&&0===e.indexOf(t)},e.Decode=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},e.EncodeArrayBufferToBase64=function(e){for(var t,i,r,s,n,o,a,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h="",c=0,d=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);c<d.length;)s=(t=d[c++])>>2,n=(3&t)<<4|(i=c<d.length?d[c++]:Number.NaN)>>4,o=(15&i)<<2|(r=c<d.length?d[c++]:Number.NaN)>>6,a=63&r,isNaN(i)?o=a=64:isNaN(r)&&(a=64),h+=l.charAt(s)+l.charAt(n)+l.charAt(o)+l.charAt(a);return h},e.PadNumber=function(e,t){for(var i=String(e);i.length<t;)i="0"+i;return i},e}(),Tr=function(){function e(){this.children=[]}return e.prototype.isValid=function(e){return!0},e.prototype.process=function(e,t){var i="";if(this.line){var r=this.line,s=t.processor;s&&(s.lineProcessor&&(r=s.lineProcessor(r,t.isFragment)),s.attributeProcessor&&wr.StartsWith(this.line,"attribute")?r=s.attributeProcessor(this.line):s.varyingProcessor&&wr.StartsWith(this.line,"varying")?r=s.varyingProcessor(this.line,t.isFragment):(s.uniformProcessor||s.uniformBufferProcessor)&&wr.StartsWith(this.line,"uniform")&&(/uniform (.+) (.+)/.test(this.line)?s.uniformProcessor&&(r=s.uniformProcessor(this.line,t.isFragment)):s.uniformBufferProcessor&&(r=s.uniformBufferProcessor(this.line,t.isFragment),t.lookForClosingBracketForUniformBuffer=!0)),s.endOfUniformBufferProcessor&&t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,r=s.endOfUniformBufferProcessor(this.line,t.isFragment))),i+=r+"\r\n"}return this.children.forEach((function(r){i+=r.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i},e}(),xr=function(){function e(){}return Object.defineProperty(e.prototype,"currentLine",{get:function(){return this._lines[this.lineIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canRead",{get:function(){return this.lineIndex<this._lines.length-1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lines",{set:function(e){this._lines=[];for(var t=0,i=e;t<i.length;t++){var r=i[t];if("#"!==r[0])for(var s=r.split(";"),n=0;n<s.length;n++){var o=s[n];(o=o.trim())&&this._lines.push(o+(n!==s.length-1?";":""))}else this._lines.push(r)}},enumerable:!1,configurable:!0}),e}(),Cr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,kt.ZT)(t,e),t.prototype.process=function(e,t){for(var i=0;i<this.children.length;i++){var r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""},t}(Tr),Pr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,kt.ZT)(t,e),t.prototype.isValid=function(e){return this.testExpression.isTrue(e)},t}(Tr),Sr=function(){function e(){}return e.prototype.isTrue=function(e){return!0},e.postfixToInfix=function(t){for(var i=[],r=0,s=t;r<s.length;r++){var n=s[r];if(void 0===e._OperatorPriority[n])i.push(n);else{var o=i[i.length-1],a=i[i.length-2];i.length-=2,i.push("("+a+n+o+")")}}return i[i.length-1]},e.infixToPostfix=function(t){for(var i=[],r=-1,s=function(){""!==(h=h.trim())&&(i.push(h),h="")},n=function(t){r<e._Stack.length-1&&(e._Stack[++r]=t)},o=function(){return e._Stack[r]},a=function(){return-1===r?"!!INVALID EXPRESSION!!":e._Stack[r--]},l=0,h="";l<t.length;){var c=t.charAt(l),d=l<t.length-1?t.substr(l,2):"";if("("===c)h="",n(c);else if(")"===c){for(s();-1!==r&&"("!==o();)i.push(a());a()}else if(e._OperatorPriority[d]>1){for(s();-1!==r&&e._OperatorPriority[o()]>=e._OperatorPriority[d];)i.push(a());n(d),l++}else h+=c;l++}for(s();-1!==r;)"("===o()?a():i.push(a());return i},e._OperatorPriority={")":0,"(":1,"||":2,"&&":3},e._Stack=["","","","","","","","","","","","","","","","","","","",""],e}(),Er=function(e){function t(t,i){void 0===i&&(i=!1);var r=e.call(this)||this;return r.define=t,r.not=i,r}return(0,kt.ZT)(t,e),t.prototype.isTrue=function(e){var t=void 0!==e[this.define];return this.not&&(t=!t),t},t}(Sr),Mr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,kt.ZT)(t,e),t.prototype.isTrue=function(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)},t}(Sr),Rr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,kt.ZT)(t,e),t.prototype.isTrue=function(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)},t}(Sr),Br=function(e){function t(t,i,r){var s=e.call(this)||this;return s.define=t,s.operand=i,s.testValue=r,s}return(0,kt.ZT)(t,e),t.prototype.isTrue=function(e){var t=e[this.define];void 0===t&&(t=this.define);var i=!1,r=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":i=r>s;break;case"<":i=r<s;break;case"<=":i=r<=s;break;case">=":i=r>=s;break;case"==":i=r===s}return i},t}(Sr),Ir=/defined\s*?\((.+?)\)/g,Ar=/defined\s*?\[(.+?)\]/g,Fr=function(){function e(){}return e.Process=function(e,t,i,r){var s=this;this._ProcessIncludes(e,t,(function(e){var n=s._ProcessShaderConversion(e,t,r);i(n)}))},e._ProcessPrecision=function(e,t){var i=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=i?"precision highp float;\n"+e:"precision mediump float;\n"+e:i||(e=e.replace("precision highp float","precision mediump float")),e},e._ExtractOperation=function(e){var t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new Er(t[1].trim(),"!"===e[0]);for(var i="",r=0,s=0,n=["==",">=","<=","<",">"];s<n.length&&(i=n[s],!((r=e.indexOf(i))>-1));s++);if(-1===r)return new Er(e);var o=e.substring(0,r).trim(),a=e.substring(r+i.length).trim();return new Br(o,i,a)},e._BuildSubExpression=function(e){e=e.replace(Ir,"defined[$1]");for(var t=[],i=0,r=Sr.infixToPostfix(e);i<r.length;i++){var s=r[i];if("||"!==s&&"&&"!==s)t.push(s);else if(t.length>=2){var n=t[t.length-1],o=t[t.length-2];t.length-=2;var a="&&"==s?new Rr:new Mr;"string"==typeof n&&(n=n.replace(Ar,"defined($1)")),"string"==typeof o&&(o=o.replace(Ar,"defined($1)")),a.leftOperand="string"==typeof o?this._ExtractOperation(o):o,a.rightOperand="string"==typeof n?this._ExtractOperation(n):n,t.push(a)}}var l=t[t.length-1];return"string"==typeof l&&(l=l.replace(Ar,"defined($1)")),"string"==typeof l?this._ExtractOperation(l):l},e._BuildExpression=function(e,t){var i=new Pr,r=e.substring(0,t),s=e.substring(t);return s=s.substring(0,(s.indexOf("//")+1||s.length+1)-1).trim(),i.testExpression="#ifdef"===r?new Er(s):"#ifndef"===r?new Er(s,!0):this._BuildSubExpression(s),i},e._MoveCursorWithinIf=function(e,t,i){for(var r=e.currentLine;this._MoveCursor(e,i);){var s=(r=e.currentLine).substring(0,5).toLowerCase();if("#else"===s){var n=new Tr;return t.children.push(n),void this._MoveCursor(e,n)}if("#elif"===s){var o=this._BuildExpression(r,5);t.children.push(o),i=o}}},e._MoveCursor=function(e,t){for(;e.canRead;){e.lineIndex++;var i=e.currentLine,r=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(r&&r.length)switch(r[0]){case"#ifdef":var s=new Cr;t.children.push(s);var n=this._BuildExpression(i,6);s.children.push(n),this._MoveCursorWithinIf(e,s,n);break;case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":s=new Cr,t.children.push(s),n=this._BuildExpression(i,7),s.children.push(n),this._MoveCursorWithinIf(e,s,n);break;case"#if":s=new Cr,n=this._BuildExpression(i,3),t.children.push(s),s.children.push(n),this._MoveCursorWithinIf(e,s,n)}else{var o=new Tr;if(o.line=i,t.children.push(o),"#"===i[0]&&"d"===i[1]){var a=i.replace(";","").split(" ");o.additionalDefineKey=a[1],3===a.length&&(o.additionalDefineValue=a[2])}}}return!1},e._EvaluatePreProcessors=function(e,t,i){var r=new Tr,s=new xr;return s.lineIndex=-1,s.lines=e.split("\n"),this._MoveCursor(s,r),r.process(t,i)},e._PreparePreProcessors=function(e){for(var t={},i=0,r=e.defines;i<r.length;i++){var s=r[i].replace("#define","").replace(";","").trim().split(" ");t[s[0]]=s.length>1?s[1]:""}return t.GL_ES="true",t.__VERSION__=e.version,t[e.platformName]="true",t},e._ProcessShaderConversion=function(e,t,i){var r=this._ProcessPrecision(e,t);if(!t.processor)return r;if(-1!==r.indexOf("#version 3"))return r.replace("#version 300 es","");var s=t.defines,n=this._PreparePreProcessors(t);return t.processor.preProcessor&&(r=t.processor.preProcessor(r,s,t.isFragment)),r=this._EvaluatePreProcessors(r,n,t),t.processor.postProcessor&&(r=t.processor.postProcessor(r,s,t.isFragment,i)),r},e._ProcessIncludes=function(t,i,r){for(var s=this,n=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,o=n.exec(t),a=new String(t),l=!1;null!=o;){var h=o[1];if(-1!==h.indexOf("__decl__")&&(h=h.replace(/__decl__/,""),i.supportsUniformBuffers&&(h=(h=h.replace(/Vertex/,"Ubo")).replace(/Fragment/,"Ubo")),h+="Declaration"),!i.includesShadersStore[h]){var c=i.shadersRepository+"ShadersInclude/"+h+".fx";return void e._FileToolsLoadFile(c,(function(e){i.includesShadersStore[h]=e,s._ProcessIncludes(a,i,r)}))}var d=i.includesShadersStore[h];if(o[2])for(var u=o[3].split(","),f=0;f<u.length;f+=2){var p=new RegExp(u[f],"g"),m=u[f+1];d=d.replace(p,m)}if(o[4]){var g=o[5];if(-1!==g.indexOf("..")){var v=g.split(".."),_=parseInt(v[0]),y=parseInt(v[1]),b=d.slice(0);d="",isNaN(y)&&(y=i.indexParameters[v[1]]);for(var w=_;w<y;w++)i.supportsUniformBuffers||(b=b.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),d+=b.replace(/\{X\}/g,w.toString())+"\n"}else i.supportsUniformBuffers||(d=d.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),d=d.replace(/\{X\}/g,g)}a=a.replace(o[0],d),l=l||d.indexOf("#include<")>=0,o=n.exec(t)}l?this._ProcessIncludes(a.toString(),i,r):r(a)},e._FileToolsLoadFile=function(e,t,i,r,s,n){throw $t.WarnImport("FileTools")},e}(),kr=function(){function e(t,i,r,s,n,o,a,l,h,c){var d,u=this;void 0===s&&(s=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===l&&(l=null),void 0===h&&(h=null),this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new Ht,this.onErrorObservable=new Ht,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._bonesComputationForcedToCPU=!1,this._multiTarget=!1,this._uniformBuffersNames={},this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._pipelineContext=null,this._valueCache={},this.name=t;var f,p,m=null;if(i.attributes){var g=i;if(this._engine=r,this._attributesNames=g.attributes,this._uniformsNames=g.uniformsNames.concat(g.samplers),this._samplerList=g.samplers.slice(),this.defines=g.defines,this.onError=g.onError,this.onCompiled=g.onCompiled,this._fallbacks=g.fallbacks,this._indexParameters=g.indexParameters,this._transformFeedbackVaryings=g.transformFeedbackVaryings||null,this._multiTarget=!!g.multiTarget,g.uniformBuffersNames){this._uniformBuffersNamesList=g.uniformBuffersNames.slice();for(var v=0;v<g.uniformBuffersNames.length;v++)this._uniformBuffersNames[g.uniformBuffersNames[v]]=v}m=null!==(d=g.processFinalCode)&&void 0!==d?d:null}else this._engine=n,this.defines=null==o?"":o,this._uniformsNames=r.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=i,this._uniformBuffersNamesList=[],this.onError=h,this.onCompiled=l,this._indexParameters=c,this._fallbacks=a;this._attributeLocationByName={},this.uniqueId=e._uniqueIdSeed++;var _=br.IsWindowObjectExist()?this._engine.getHostDocument():null;t.vertexSource?f="source:"+t.vertexSource:t.vertexElement?(f=_?_.getElementById(t.vertexElement):null)||(f=t.vertexElement):f=t.vertex||t,t.fragmentSource?p="source:"+t.fragmentSource:t.fragmentElement?(p=_?_.getElementById(t.fragmentElement):null)||(p=t.fragmentElement):p=t.fragment||t;var y={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._shaderProcessor,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:e.ShadersRepository,includesShadersStore:e.IncludesShadersStore,version:(100*this._engine.webGLVersion).toString(),platformName:this._engine.webGLVersion>=2?"WEBGL2":"WEBGL1"};this._loadShader(f,"Vertex","",(function(e){u._rawVertexSourceCode=e,u._loadShader(p,"Fragment","Pixel",(function(i){u._rawFragmentSourceCode=i,Fr.Process(e,y,(function(e){m&&(e=m("vertex",e)),y.isFragment=!0,Fr.Process(i,y,(function(i){m&&(i=m("fragment",i)),u._useFinalCode(e,i,t)}),u._engine)}),u._engine)}))}))}return Object.defineProperty(e.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new Ht),this._onBindObservable},enumerable:!1,configurable:!0}),e.prototype._useFinalCode=function(e,t,i){if(i){var r=i.vertexElement||i.vertex||i.spectorName||i,s=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode="#define SHADER_NAME vertex:"+r+"\n"+e,this._fragmentSourceCode="#define SHADER_NAME fragment:"+s+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()},Object.defineProperty(e.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),e.prototype.isReady=function(){try{return this._isReadyInternal()}catch(e){return!1}},e.prototype._isReadyInternal=function(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady},e.prototype.getEngine=function(){return this._engine},e.prototype.getPipelineContext=function(){return this._pipelineContext},e.prototype.getAttributesNames=function(){return this._attributesNames},e.prototype.getAttributeLocation=function(e){return this._attributes[e]},e.prototype.getAttributeLocationByName=function(e){return this._attributeLocationByName[e]},e.prototype.getAttributesCount=function(){return this._attributes.length},e.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},e.prototype.getUniform=function(e){return this._uniforms[e]},e.prototype.getSamplers=function(){return this._samplerList},e.prototype.getUniformNames=function(){return this._uniformsNames},e.prototype.getUniformBuffersNames=function(){return this._uniformBuffersNamesList},e.prototype.getIndexParameters=function(){return this._indexParameters},e.prototype.getCompilationError=function(){return this._compilationError},e.prototype.allFallbacksProcessed=function(){return this._allFallbacksProcessed},e.prototype.executeWhenCompiled=function(e){var t=this;this.isReady()?e(this):(this.onCompileObservable.add((function(t){e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((function(){t._checkIsReady(null)}),16))},e.prototype._checkIsReady=function(e){var t=this;try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}setTimeout((function(){t._checkIsReady(e)}),16)},e.prototype._loadShader=function(t,i,r,s){var n;"undefined"!=typeof HTMLElement&&t instanceof HTMLElement?s(br.GetDOMTextContent(t)):"source:"!==t.substr(0,7)?"base64:"!==t.substr(0,7)?e.ShadersStore[t+i+"Shader"]?s(e.ShadersStore[t+i+"Shader"]):r&&e.ShadersStore[t+r+"Shader"]?s(e.ShadersStore[t+r+"Shader"]):(n="."===t[0]||"/"===t[0]||t.indexOf("http")>-1?t:e.ShadersRepository+t,this._engine._loadFile(n+"."+i.toLowerCase()+".fx",s)):s(window.atob(t.substr(7))):s(t.substr(7))},Object.defineProperty(e.prototype,"vertexSourceCode",{get:function(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._vertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fragmentSourceCode",{get:function(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._fragmentSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rawVertexSourceCode",{get:function(){return this._rawVertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rawFragmentSourceCode",{get:function(){return this._rawFragmentSourceCode},enumerable:!1,configurable:!0}),e.prototype._rebuildProgram=function(e,t,i,r){var s=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(e,t){r&&r(t)},this.onCompiled=function(){var e=s.getEngine().scenes;if(e)for(var t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);s._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()},e.prototype._prepareEffect=function(){var e=this,t=this._attributesNames,i=this.defines;this._valueCache={};var r=this._pipelineContext;try{var s=this._engine;this._pipelineContext=s.createPipelineContext();var n=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?s._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,n,null,this._transformFeedbackVaryings):s._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,n,i,this._transformFeedbackVaryings),s._executeWhenRenderingStateIsCompiled(this._pipelineContext,(function(){if(s.supportsUniformBuffers)for(var i in e._uniformBuffersNames)e.bindUniformBlock(i,e._uniformBuffersNames[i]);var n;if(s.getUniforms(e._pipelineContext,e._uniformsNames).forEach((function(t,i){e._uniforms[e._uniformsNames[i]]=t})),e._attributes=s.getAttributes(e._pipelineContext,t),t)for(var o=0;o<t.length;o++){var a=t[o];e._attributeLocationByName[a]=e._attributes[o]}for(n=0;n<e._samplerList.length;n++)null==e.getUniform(e._samplerList[n])&&(e._samplerList.splice(n,1),n--);e._samplerList.forEach((function(t,i){e._samplers[t]=i})),s.bindSamplers(e),e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),e._fallbacks&&e._fallbacks.unBindMesh(),r&&e.getEngine()._deletePipelineContext(r)})),this._pipelineContext.isAsync&&this._checkIsReady(r)}catch(e){this._processCompilationErrors(e,r)}},e.prototype._getShaderCodeAndErrorLine=function(e,t,i){var r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,s=null;if(t&&e){var n=t.match(r);if(n&&2===n.length){var o=parseInt(n[1]),a=e.split("\n",-1);a.length>=o&&(s="Offending line ["+o+"] in "+(i?"fragment":"vertex")+" code: "+a[o-1])}}return[e,s]},e.prototype._processCompilationErrors=function(t,i){var r,s,n,o,a;void 0===i&&(i=null),this._compilationError=t.message;var l=this._attributesNames,h=this._fallbacks;if(_r.Error("Unable to compile effect:"),_r.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),_r.Error("Attributes: "+l.map((function(e){return" "+e}))),_r.Error("Defines:\r\n"+this.defines),e.LogShaderCodeOnCompilationError){var c=null,d=null,u=null;(null===(n=this._pipelineContext)||void 0===n?void 0:n._getVertexShaderCode())&&(u=(r=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1))[0],c=r[1],u&&(_r.Error("Vertex code:"),_r.Error(u))),(null===(o=this._pipelineContext)||void 0===o?void 0:o._getFragmentShaderCode())&&(u=(s=this._getShaderCodeAndErrorLine(null===(a=this._pipelineContext)||void 0===a?void 0:a._getFragmentShaderCode(),this._compilationError,!0))[0],d=s[1],u&&(_r.Error("Fragment code:"),_r.Error(u))),c&&_r.Error(c),d&&_r.Error(d)}_r.Error("Error: "+this._compilationError),i&&(this._pipelineContext=i,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),h?(this._pipelineContext=null,h.hasMoreFallbacks?(this._allFallbacksProcessed=!1,_r.Error("Trying next fallback."),this.defines=h.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):this._allFallbacksProcessed=!0},Object.defineProperty(e.prototype,"isSupported",{get:function(){return""===this._compilationError},enumerable:!1,configurable:!0}),e.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers[e],t)},e.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t)},e.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t)},e.prototype.setTextureArray=function(e,t){var i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){for(var r=this._samplerList.indexOf(e),s=1;s<t.length;s++){var n=i+(s-1).toString();this._samplerList.splice(r+s,0,n)}for(var o=0,a=0,l=this._samplerList;a<l.length;a++){var h=l[a];this._samplers[h]=o,o+=1}}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t)},e.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t)},e.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t)},e.prototype._cacheMatrix=function(e,t){var i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)},e.prototype._cacheFloat2=function(e,t,i){var r=this._valueCache[e];if(!r||2!==r.length)return r=[t,i],this._valueCache[e]=r,!0;var s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s},e.prototype._cacheFloat3=function(e,t,i,r){var s=this._valueCache[e];if(!s||3!==s.length)return s=[t,i,r],this._valueCache[e]=s,!0;var n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n},e.prototype._cacheFloat4=function(e,t,i,r,s){var n=this._valueCache[e];if(!n||4!==n.length)return n=[t,i,r,s],this._valueCache[e]=n,!0;var o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==r&&(n[2]=r,o=!0),n[3]!==s&&(n[3]=s,o=!0),o},e.prototype.bindUniformBuffer=function(t,i){var r=this._uniformBuffersNames[i];void 0!==r&&e._baseCache[r]!==t&&(e._baseCache[r]=t,this._engine.bindUniformBufferBase(t,r))},e.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)},e.prototype.setInt=function(e,t){var i=this._valueCache[e];return void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t),this},e.prototype.setIntArray=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t),this},e.prototype.setIntArray2=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t),this},e.prototype.setIntArray3=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t),this},e.prototype.setIntArray4=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t),this},e.prototype.setFloatArray=function(e,t){return this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t),this},e.prototype.setFloatArray2=function(e,t){return this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t),this},e.prototype.setFloatArray3=function(e,t){return this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t),this},e.prototype.setFloatArray4=function(e,t){return this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t),this},e.prototype.setArray=function(e,t){return this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t),this},e.prototype.setArray2=function(e,t){return this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t),this},e.prototype.setArray3=function(e,t){return this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t),this},e.prototype.setArray4=function(e,t){return this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t),this},e.prototype.setMatrices=function(e,t){return t?(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t),this):this},e.prototype.setMatrix=function(e,t){return this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null)),this},e.prototype.setMatrix3x3=function(e,t){return this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t),this},e.prototype.setMatrix2x2=function(e,t){return this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t),this},e.prototype.setFloat=function(e,t){var i=this._valueCache[e];return void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t),this},e.prototype.setBool=function(e,t){var i=this._valueCache[e];return void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t),this},e.prototype.setVector2=function(e,t){return this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null)),this},e.prototype.setFloat2=function(e,t,i){return this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null)),this},e.prototype.setVector3=function(e,t){return this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null)),this},e.prototype.setFloat3=function(e,t,i,r){return this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null)),this},e.prototype.setVector4=function(e,t){return this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null)),this},e.prototype.setFloat4=function(e,t,i,r,s){return this._cacheFloat4(e,t,i,r,s)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null)),this},e.prototype.setColor3=function(e,t){return this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null)),this},e.prototype.setColor4=function(e,t,i){return this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null)),this},e.prototype.setDirectColor4=function(e,t){return this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null)),this},e.prototype.dispose=function(){this._engine._releaseEffect(this)},e.RegisterShader=function(t,i,r){i&&(e.ShadersStore[t+"PixelShader"]=i),r&&(e.ShadersStore[t+"VertexShader"]=r)},e.ResetCache=function(){e._baseCache={}},e.ShadersRepository="src/Shaders/",e.LogShaderCodeOnCompilationError=!0,e._uniqueIdSeed=0,e._baseCache={},e.ShadersStore={},e.IncludesShadersStore={},e}(),Dr=function(){function e(){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,0)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},e}(),Lr=function(){function e(){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(e){this._stencilFunc!==e&&(this._stencilFunc=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(e){this._stencilFuncRef!==e&&(this._stencilFuncRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(e){this._stencilFuncMask!==e&&(this._stencilFuncMask=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(e){this._stencilOpStencilFail!==e&&(this._stencilOpStencilFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(e){this._stencilOpDepthFail!==e&&(this._stencilOpDepthFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(e){this._stencilOpStencilDepthPass!==e&&(this._stencilOpStencilDepthPass=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(e){this._stencilMask!==e&&(this._stencilMask=e,this._isStencilMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(e){this._stencilTest!==e&&(this._stencilTest=e,this._isStencilTestDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=e.ALWAYS,this._stencilFuncRef=1,this._stencilFuncMask=255,this._stencilOpStencilFail=e.KEEP,this._stencilOpDepthFail=e.KEEP,this._stencilOpStencilDepthPass=e.REPLACE,this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},e.prototype.apply=function(e){this.isDirty&&(this._isStencilTestDirty&&(this.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.stencilMask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass),this._isStencilOpDirty=!1))},e.ALWAYS=519,e.KEEP=7680,e.REPLACE=7681,e}(),Or=function(){function e(){this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.setAlphaBlendConstants=function(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)},e.prototype.setAlphaBlendFunctionParameters=function(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)},e.prototype.setAlphaEquationParameters=function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)},e.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},e}(),Ur=function(){function e(){}return e.prototype.postProcessor=function(e,t,i,r){return r.getCaps().drawBuffersExtension||(e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")),e},e}(),Vr=function(){function e(){}return e.prototype.attributeProcessor=function(e){return e.replace("attribute","in")},e.prototype.varyingProcessor=function(e,t){return e.replace("varying",t?"in":"out")},e.prototype.postProcessor=function(e,t,i){var r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r?"":"out vec4 glFragColor;\n")+"void main(");else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e},e}(),Nr=function(e){function t(t){var i=e.call(this)||this;return i._buffer=t,i}return(0,kt.ZT)(t,e),Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(function(){function e(){this.references=0,this.capacity=0,this.is32Bits=!1}return Object.defineProperty(e.prototype,"underlyingResource",{get:function(){return null},enumerable:!1,configurable:!0}),e}()),Gr=function(){function e(){this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}return Object.defineProperty(e.prototype,"isAsync",{get:function(){return this.isParallelCompiled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isReady",{get:function(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))},enumerable:!1,configurable:!0}),e.prototype._handlesSpectorRebuildCallback=function(e){e&&this.program&&e(this.program)},e.prototype._getVertexShaderCode=function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null},e.prototype._getFragmentShaderCode=function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null},e}(),zr=function(){function e(){}return e.CreateCanvas=function(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);var i=document.createElement("canvas");return i.width=e,i.height=t,i},e}(),Hr=function(){function e(){}return e.SetMatrixPrecision=function(t){if(e.MatrixTrackPrecisionChange=!1,t&&!e.MatrixUse64Bits&&e.MatrixTrackedMatrices)for(var i=0;i<e.MatrixTrackedMatrices.length;++i){var r=e.MatrixTrackedMatrices[i],s=r._m;r._m=new Array(16);for(var n=0;n<16;++n)r._m[n]=s[n]}e.MatrixUse64Bits=t,e.MatrixCurrentType=e.MatrixUse64Bits?Array:Float32Array,e.MatrixTrackedMatrices=null},e.MatrixUse64Bits=!1,e.MatrixTrackPrecisionChange=!0,e.MatrixCurrentType=Float32Array,e.MatrixTrackedMatrices=[],e}(),Wr=function(){},$r=function(){function e(t,i,r,s){var n=this;void 0===s&&(s=!1),this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this.useReverseDepthBuffer=!1,this.disableUniformBuffers=!1,this._uniformBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new Ht,this.onContextRestoredObservable=new Ht,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Dr,this._stencilState=new Lr,this._alphaState=new Or,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._activeRequests=new Array,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new Ht,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._getDepthStencilBuffer=function(e,t,i,r,s,o){var a=n._gl,l=a.createRenderbuffer();return a.bindRenderbuffer(a.RENDERBUFFER,l),i>1&&a.renderbufferStorageMultisample?a.renderbufferStorageMultisample(a.RENDERBUFFER,i,s,e,t):a.renderbufferStorage(a.RENDERBUFFER,r,e,t),a.framebufferRenderbuffer(a.FRAMEBUFFER,o,a.RENDERBUFFER,l),a.bindRenderbuffer(a.RENDERBUFFER,null),l},this._boundUniforms={};var o=null;if(t){if(r=r||{},Hr.SetMatrixPrecision(!!r.useHighPrecisionMatrix),t.getContext){if(o=t,this._renderingCanvas=o,null!=i&&(r.antialias=i),void 0===r.deterministicLockstep&&(r.deterministicLockstep=!1),void 0===r.lockstepMaxSteps&&(r.lockstepMaxSteps=4),void 0===r.timeStep&&(r.timeStep=1/60),void 0===r.preserveDrawingBuffer&&(r.preserveDrawingBuffer=!1),void 0===r.audioEngine&&(r.audioEngine=!0),void 0===r.stencil&&(r.stencil=!0),!1===r.premultipliedAlpha&&(this.premultipliedAlpha=!1),void 0===r.xrCompatible&&(r.xrCompatible=!0),this._doNotHandleContextLost=!!r.doNotHandleContextLost,navigator&&navigator.userAgent){var a=navigator.userAgent;this.hostInformation.isMobile=-1!==a.indexOf("Mobile");for(var l=0,h=e.ExceptionList;l<h.length;l++){var c=h[l],d=c.key,u=c.targets;if(new RegExp(d).test(a)){if(c.capture&&c.captureConstraint){var f=c.capture,p=c.captureConstraint,m=new RegExp(f).exec(a);if(m&&m.length>0&&parseInt(m[m.length-1])>=p)continue}for(var g=0,v=u;g<v.length;g++)switch(v[g]){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0}}}}if(this._doNotHandleContextLost||(this._onContextLost=function(e){e.preventDefault(),n._contextWasLost=!0,_r.Warn("WebGL context lost."),n.onContextLostObservable.notifyObservers(n)},this._onContextRestored=function(){setTimeout((function(){n._initGLContext(),n._rebuildEffects(),n._rebuildInternalTextures(),n._rebuildBuffers(),n.wipeCaches(!0),_r.Warn("WebGL context successfully restored."),n.onContextRestoredObservable.notifyObservers(n),n._contextWasLost=!1}),0)},o.addEventListener("webglcontextlost",this._onContextLost,!1),o.addEventListener("webglcontextrestored",this._onContextRestored,!1),r.powerPreference="high-performance"),!r.disableWebGL2Support)try{this._gl=o.getContext("webgl2",r)||o.getContext("experimental-webgl2",r),this._gl&&(this._webGLVersion=2,this._gl.deleteQuery||(this._webGLVersion=1))}catch(e){}if(!this._gl){if(!o)throw new Error("The provided canvas is null or undefined.");try{this._gl=o.getContext("webgl",r)||o.getContext("experimental-webgl",r)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample&&(this._webGLVersion=2);var _=this._gl.getContextAttributes();_&&(r.stencil=_.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==r.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats);var y=br.IsWindowObjectExist()&&window.devicePixelRatio||1,b=r.limitDeviceRatio||y;this._hardwareScalingLevel=s?1/Math.min(b,y):1,this.resize(),this._isStencilEnable=!!r.stencil,this._initGLContext();for(var w=0;w<this._caps.maxVertexAttribs;w++)this._currentBufferPointers[w]=new Wr;this.webGLVersion>1?this._shaderProcessor=new Vr:this._shaderProcessor=new Ur,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._creationOptions=r,console.log("Babylon.js v"+e.Version+" - "+this.description)}}return Object.defineProperty(e,"NpmPackage",{get:function(){return"babylonjs@4.2.2"},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return"4.2.2"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){var e="WebGL"+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ShadersRepository",{get:function(){return kr.ShadersRepository},set:function(e){kr.ShadersRepository=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_shouldUseHighPrecisionShader",{get:function(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framebufferDimensionsObject",{set:function(e){this._framebufferDimensionsObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture2DArray",{get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture},enumerable:!1,configurable:!0}),e.prototype._rebuildInternalTextures=function(){for(var e=0,t=this._internalTexturesCache.slice();e<t.length;e++)t[e]._rebuild()},e.prototype._rebuildEffects=function(){for(var e in this._compiledEffects)this._compiledEffects[e]._prepareEffect();kr.ResetCache()},e.prototype.areAllEffectsReady=function(){for(var e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0},e.prototype._rebuildBuffers=function(){for(var e=0,t=this._uniformBuffers;e<t.length;e++)t[e]._rebuild()},e.prototype._initGLContext=function(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile"),standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float"),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);var e=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=e&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor="Unknown vendor"),this._glRenderer||(this._glRenderer="Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._gl.getParameter(this._gl.MAX_SAMPLES);else{var t=this._gl.getExtension("WEBGL_draw_buffers");if(null!==t){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var i=0;i<16;i++)this._gl["COLOR_ATTACHMENT"+i+"_WEBGL"]=t["COLOR_ATTACHMENT"+i+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var r=this._gl.getExtension("WEBGL_depth_texture");null!=r&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=r.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var s=this._gl.getExtension("OES_vertex_array_object");null!=s&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var n=this._gl.getExtension("ANGLE_instanced_arrays");null!=n?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=n.drawArraysInstancedANGLE.bind(n),this._gl.drawElementsInstanced=n.drawElementsInstancedANGLE.bind(n),this._gl.vertexAttribDivisor=n.vertexAttribDivisorANGLE.bind(n)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){var o=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),a=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);o&&a&&(this._caps.highPrecisionShaderSupported=0!==o.precision&&0!==a.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{var l=this._gl.getExtension("EXT_blend_minmax");null!=l&&(this._caps.blendMinMax=!0,this._gl.MAX=l.MAX_EXT,this._gl.MIN=l.MIN_EXT)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var h=0;h<this._maxSimultaneousTextures;h++)this._nextFreeTextureSlots.push(h)},Object.defineProperty(e.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"ThinEngine"},Object.defineProperty(e.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!1,configurable:!0}),e.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=zr.CreateCanvas(1,1);var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}},e.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)this._boundTexturesCache.hasOwnProperty(e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1},e.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},e.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},e.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},e.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},e.prototype.getCaps=function(){return this._caps},e.prototype.stopRenderLoop=function(e){if(e){var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}else this._activeRenderLoops=[]},e.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++)(0,this._activeRenderLoops[t])();this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype.getRenderingCanvas=function(){return this._renderingCanvas},e.prototype.getHostWindow=function(){return br.IsWindowObjectExist()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null},e.prototype.getRenderWidth=function(e){return void 0===e&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth},e.prototype.getRenderHeight=function(e){return void 0===e&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight},e.prototype._queueNewFrame=function(t,i){return e.QueueNewFrame(t,i)},e.prototype.runRenderLoop=function(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))},e.prototype.clear=function(e,t,i,r){void 0===r&&(r=!1),this.applyStates();var s=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),s|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GREATER,this._gl.clearDepth(0)):this._gl.clearDepth(1),s|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),s|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(s)},e.prototype._viewport=function(e,t,i,r){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&r===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))},e.prototype.setViewport=function(e,t,i){var r=t||this.getRenderWidth(),s=i||this.getRenderHeight(),n=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(n*r,o*s,r*e.width,s*e.height)},e.prototype.beginFrame=function(){},e.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer()},e.prototype.resize=function(){var e,t;br.IsWindowObjectExist()?(e=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,t=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(e=this._renderingCanvas?this._renderingCanvas.width:100,t=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(e/this._hardwareScalingLevel,t/this._hardwareScalingLevel)},e.prototype.setSize=function(e,t){return!(!this._renderingCanvas||(e|=0,t|=0,this._renderingCanvas.width===e&&this._renderingCanvas.height===t||(this._renderingCanvas.width=e,this._renderingCanvas.height=t,0)))},e.prototype.bindFramebuffer=function(e,t,i,r,s,n,o){void 0===t&&(t=0),void 0===n&&(n=0),void 0===o&&(o=0),this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(e._MSAAFramebuffer?e._MSAAFramebuffer:e._framebuffer);var a=this._gl;e.is2DArray?a.framebufferTextureLayer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,e._webGLTexture,n,o):e.isCube&&a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,e._webGLTexture,n);var l=e._depthStencilTexture;if(l){var h=l._generateStencilBuffer?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT;e.is2DArray?a.framebufferTextureLayer(a.FRAMEBUFFER,h,l._webGLTexture,n,o):e.isCube?a.framebufferTexture2D(a.FRAMEBUFFER,h,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,l._webGLTexture,n):a.framebufferTexture2D(a.FRAMEBUFFER,h,a.TEXTURE_2D,l._webGLTexture,n)}this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,n&&(i/=Math.pow(2,n))),r||(r=e.height,n&&(r/=Math.pow(2,n))),this._viewport(0,0,i,r)),this.wipeCaches()},e.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},e.prototype.unBindFramebuffer=function(e,t,i){void 0===t&&(t=!1),this._currentRenderTarget=null;var r=this._gl;if(e._MSAAFramebuffer){if(e._textureArray)return void this.unBindMultiColorAttachmentFramebuffer(e._textureArray,t,i);r.bindFramebuffer(r.READ_FRAMEBUFFER,e._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e._framebuffer),r.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r.COLOR_BUFFER_BIT,r.NEAREST)}!e.generateMipMaps||t||e.isCube||(this._bindTextureDirectly(r.TEXTURE_2D,e,!0),r.generateMipmap(r.TEXTURE_2D),this._bindTextureDirectly(r.TEXTURE_2D,null)),i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},e.prototype.flushFramebuffer=function(){this._gl.flush()},e.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},e.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},e.prototype.createVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)},e.prototype._createVertexBuffer=function(e,t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");var r=new Nr(i);return this.bindArrayBuffer(r),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),r.references=1,r},e.prototype.createDynamicVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)},e.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},e.prototype.createIndexBuffer=function(e,t){var i=this._gl.createBuffer(),r=new Nr(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);var s=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=4===s.BYTES_PER_ELEMENT,r},e.prototype._normalizeIndexData=function(e){if(e instanceof Uint16Array)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)},e.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(e,this._gl.ARRAY_BUFFER)},e.prototype.bindUniformBlock=function(e,t,i){var r=e.program,s=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,s,i)},e.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},e.prototype.bindBuffer=function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)},e.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},e.prototype._vertexAttribPointer=function(e,t,i,r,s,n,o){var a=this._currentBufferPointers[t];if(a){var l=!1;a.active?(a.buffer!==e&&(a.buffer=e,l=!0),a.size!==i&&(a.size=i,l=!0),a.type!==r&&(a.type=r,l=!0),a.normalized!==s&&(a.normalized=s,l=!0),a.stride!==n&&(a.stride=n,l=!0),a.offset!==o&&(a.offset=o,l=!0)):(l=!0,a.active=!0,a.index=t,a.size=i,a.type=r,a.normalized=s,a.stride=n,a.offset=o,a.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),this._gl.vertexAttribPointer(t,i,r,s,n,o))}},e.prototype._bindIndexBufferWithCache=function(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},e.prototype._bindVertexBuffersAttributes=function(e,t){var i=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var r=0;r<i.length;r++){var s=t.getAttributeLocation(r);if(s>=0){var n=e[i[r]];if(!n)continue;this._gl.enableVertexAttribArray(s),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[s]=!0);var o=n.getBuffer();o&&(this._vertexAttribPointer(o,s,n.getSize(),n.type,n.normalized,n.byteStride,n.byteOffset),n.getIsInstanced()&&(this._gl.vertexAttribDivisor(s,n.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(o))))}}},e.prototype.recordVertexArrayObject=function(e,t,i){var r=this._gl.createVertexArray();return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r},e.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)},e.prototype.bindBuffersDirectly=function(e,t,i,r,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;var n=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0,a=0;a<n;a++)if(a<i.length){var l=s.getAttributeLocation(a);l>=0&&(this._gl.enableVertexAttribArray(l),this._vertexAttribArraysEnabled[l]=!0,this._vertexAttribPointer(e,l,i[a],this._gl.FLOAT,!1,r,o)),o+=4*i[a]}}this._bindIndexBufferWithCache(t)},e.prototype._unbindVertexArrayObject=function(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},e.prototype.bindBuffers=function(e,t,i){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i)),this._bindIndexBufferWithCache(t)},e.prototype.unbindInstanceAttributes=function(){for(var e,t=0,i=this._currentInstanceLocations.length;t<i;t++){var r=this._currentInstanceBuffers[t];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));var s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},e.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},e.prototype._releaseBuffer=function(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)},e.prototype._deleteBuffer=function(e){this._gl.deleteBuffer(e.underlyingResource)},e.prototype.updateAndBindInstancesBuffer=function(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(var r=0;r<4;r++){var s=i[r];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,16*r),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}},e.prototype.bindInstancesBuffer=function(e,t,i){void 0===i&&(i=!0),this.bindArrayBuffer(e);var r=0;if(i)for(var s=0;s<t.length;s++)r+=4*(n=t[s]).attributeSize;for(s=0;s<t.length;s++){var n;void 0===(n=t[s]).index&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),n.index<0||(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,r,n.offset),this._gl.vertexAttribDivisor(n.index,void 0===n.divisor?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}},e.prototype.disableInstanceAttributeByName=function(e){if(this._currentEffect){var t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}},e.prototype.disableInstanceAttribute=function(e){for(var t,i=!1;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))},e.prototype.disableAttributeByIndex=function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1},e.prototype.draw=function(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)},e.prototype.drawPointClouds=function(e,t,i){this.drawArraysType(2,e,t,i)},e.prototype.drawUnIndexed=function(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)},e.prototype.drawElementsType=function(e,t,i,r){this.applyStates(),this._reportDrawCall();var s=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(s,i,n,t*o,r):this._gl.drawElements(s,i,n,t*o)},e.prototype.drawArraysType=function(e,t,i,r){this.applyStates(),this._reportDrawCall();var s=this._drawMode(e);r?this._gl.drawArraysInstanced(s,t,i,r):this._gl.drawArrays(s,t,i)},e.prototype._drawMode=function(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}},e.prototype._reportDrawCall=function(){},e.prototype._releaseEffect=function(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))},e.prototype._deletePipelineContext=function(e){var t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))},e.prototype.createEffect=function(e,t,i,r,s,n,o,a,l){var h=(e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e)+"+"+(e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e)+"@"+(s||t.defines);if(this._compiledEffects[h]){var c=this._compiledEffects[h];return o&&c.isReady()&&o(c),c}var d=new kr(e,t,i,r,this,s,n,o,a,l);return d._key=h,this._compiledEffects[h]=d,d},e._ConcatenateShader=function(e,t,i){return void 0===i&&(i=""),i+(t?t+"\n":"")+e},e.prototype._compileShader=function(t,i,r,s){return this._compileRawShader(e._ConcatenateShader(t,r,s),i)},e.prototype._compileRawShader=function(e,t){var i=this._gl,r=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!r)throw new Error("Something went wrong while compile the shader.");return i.shaderSource(r,e),i.compileShader(r),r},e.prototype._getShaderSource=function(e){return this._gl.getShaderSource(e)},e.prototype.createRawShaderProgram=function(e,t,i,r,s){void 0===s&&(s=null),r=r||this._gl;var n=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,n,o,r,s)},e.prototype.createShaderProgram=function(e,t,i,r,s,n){void 0===n&&(n=null),s=s||this._gl;var o=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",a=this._compileShader(t,"vertex",r,o),l=this._compileShader(i,"fragment",r,o);return this._createShaderProgram(e,a,l,s,n)},e.prototype.createPipelineContext=function(){var e=new Gr;return e.engine=this,this._caps.parallelShaderCompile&&(e.isParallelCompiled=!0),e},e.prototype._createShaderProgram=function(e,t,i,r,s){void 0===s&&(s=null);var n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");return r.attachShader(n,t),r.attachShader(n,i),r.linkProgram(n),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n},e.prototype._finalizePipelineContext=function(e){var t=e.context,i=e.vertexShader,r=e.fragmentShader,s=e.program;if(!t.getProgramParameter(s,t.LINK_STATUS)){var n,o;if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)&&(n=this._gl.getShaderInfoLog(i)))throw e.vertexCompilationError=n,new Error("VERTEX SHADER "+n);if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)&&(n=this._gl.getShaderInfoLog(r)))throw e.fragmentCompilationError=n,new Error("FRAGMENT SHADER "+n);if(o=t.getProgramInfoLog(s))throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(t.validateProgram(s),!t.getProgramParameter(s,t.VALIDATE_STATUS)&&(o=t.getProgramInfoLog(s))))throw e.programValidationError=o,new Error(o);t.deleteShader(i),t.deleteShader(r),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)},e.prototype._preparePipelineContext=function(e,t,i,r,s,n,o){var a=e;a.program=r?this.createRawShaderProgram(a,t,i,void 0,o):this.createShaderProgram(a,t,i,n,void 0,o),a.program.__SPECTOR_rebuildProgram=s},e.prototype._isRenderingStateCompiled=function(e){var t=e;return!!this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(t),!0)},e.prototype._executeWhenRenderingStateIsCompiled=function(e,t){var i=e;if(i.isParallelCompiled){var r=i.onCompiled;i.onCompiled=r?function(){r(),t()}:t}else t()},e.prototype.getUniforms=function(e,t){for(var i=new Array,r=e,s=0;s<t.length;s++)i.push(this._gl.getUniformLocation(r.program,t[s]));return i},e.prototype.getAttributes=function(e,t){for(var i=[],r=e,s=0;s<t.length;s++)try{i.push(this._gl.getAttribLocation(r.program,t[s]))}catch(e){i.push(-1)}return i},e.prototype.enableEffect=function(e){e&&e!==this._currentEffect&&(this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},e.prototype.setInt=function(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)},e.prototype.setIntArray=function(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)},e.prototype.setIntArray2=function(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2iv(e,t),0))},e.prototype.setIntArray3=function(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3iv(e,t),0))},e.prototype.setIntArray4=function(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4iv(e,t),0))},e.prototype.setArray=function(e,t){return!!e&&(this._gl.uniform1fv(e,t),!0)},e.prototype.setArray2=function(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2fv(e,t),0))},e.prototype.setArray3=function(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3fv(e,t),0))},e.prototype.setArray4=function(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4fv(e,t),0))},e.prototype.setMatrices=function(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)},e.prototype.setMatrix3x3=function(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)},e.prototype.setMatrix2x2=function(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)},e.prototype.setFloat=function(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)},e.prototype.setFloat2=function(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)},e.prototype.setFloat3=function(e,t,i,r){return!!e&&(this._gl.uniform3f(e,t,i,r),!0)},e.prototype.setFloat4=function(e,t,i,r,s){return!!e&&(this._gl.uniform4f(e,t,i,r,s),!0)},e.prototype.applyStates=function(){if(this._depthCullingState.apply(this._gl),this._stencilState.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;var e=this._colorWrite;this._gl.colorMask(e,e,e,e)}},e.prototype.setColorWrite=function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)},e.prototype.getColorWrite=function(){return this._colorWrite},Object.defineProperty(e.prototype,"depthCullingState",{get:function(){return this._depthCullingState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaState",{get:function(){return this._alphaState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilState",{get:function(){return this._stencilState},enumerable:!1,configurable:!0}),e.prototype.clearInternalTexturesCache=function(){this._internalTexturesCache=[]},e.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilState.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))},e.prototype._getSamplingParameters=function(e,t){var i=this._gl,r=i.NEAREST,s=i.NEAREST;switch(e){case 11:r=i.LINEAR,s=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:r=i.LINEAR,s=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:r=i.NEAREST,s=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:r=i.NEAREST,s=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:r=i.NEAREST,s=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:r=i.NEAREST,s=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:r=i.NEAREST,s=i.LINEAR;break;case 1:r=i.NEAREST,s=i.NEAREST;break;case 9:r=i.LINEAR,s=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:r=i.LINEAR,s=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:r=i.LINEAR,s=i.LINEAR;break;case 12:r=i.LINEAR,s=i.NEAREST}return{min:s,mag:r}},e.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e},e.prototype.createTexture=function(t,i,r,s,n,o,a,l,h,c,d,u,f){var p=this;void 0===n&&(n=3),void 0===o&&(o=null),void 0===a&&(a=null),void 0===l&&(l=null),void 0===h&&(h=null),void 0===c&&(c=null),void 0===d&&(d=null);var m="data:"===(t=t||"").substr(0,5),g="blob:"===t.substr(0,5),v=m&&-1!==t.indexOf(";base64,"),_=h||new qt(this,Nt.Url),y=t;!this._transformTextureUrl||v||h||l||(t=this._transformTextureUrl(t)),y!==t&&(_._originalUrl=y);var b=t.lastIndexOf("."),w=d||(b>-1?t.substring(b).toLowerCase():""),T=null;w.indexOf("?")>-1&&(w=w.split("?")[0]);for(var x=0,C=e._TextureLoaders;x<C.length;x++){var P=C[x];if(P.canLoad(w,u)){T=P;break}}s&&s._addPendingData(_),_.url=t,_.generateMipMaps=!i,_.samplingMode=n,_.invertY=r,this._doNotHandleContextLost||(_._buffer=l);var S=null;o&&!h&&(S=_.onLoadedObservable.add(o)),h||this._internalTexturesCache.push(_);var E=function(e,r){s&&s._removePendingData(_),t===y?(S&&_.onLoadedObservable.remove(S),yr.UseFallbackTexture&&p.createTexture(yr.FallbackTexture,i,_.invertY,s,n,null,a,l,_),a&&a((e||"Unknown error")+(yr.UseFallbackTexture?" - Fallback texture was used":""),r)):(_r.Warn("Failed to load "+t+", falling back to "+y),p.createTexture(y,i,_.invertY,s,n,o,a,l,_,c,d,u,f))};if(T){var M=function(e){T.loadData(e,_,(function(e,t,i,r,o,a){a?E("TextureLoader failed to load data"):p._prepareWebGLTexture(_,s,e,t,_.invertY,!i,r,(function(){return o(),!1}),n)}),f)};l?l instanceof ArrayBuffer?M(new Uint8Array(l)):ArrayBuffer.isView(l)?M(l):a&&a("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,(function(e){return M(new Uint8Array(e))}),void 0,s?s.offlineProvider:void 0,!0,(function(e,t){E("Unable to load "+(e&&e.responseURL,t))}))}else{var R=function(e){g&&!p._doNotHandleContextLost&&(_._buffer=e),p._prepareWebGLTexture(_,s,e.width,e.height,_.invertY,i,!1,(function(t,i,r){var n=p._gl,o=e.width===t&&e.height===i,a=c?p._getInternalFormat(c):".jpg"===w?n.RGB:n.RGBA;if(o)return n.texImage2D(n.TEXTURE_2D,0,a,a,n.UNSIGNED_BYTE,e),!1;var l=p._caps.maxTextureSize;if(e.width>l||e.height>l||!p._supportsHardwareTextureRescaling)return p._prepareWorkingCanvas(),!(!p._workingCanvas||!p._workingContext||(p._workingCanvas.width=t,p._workingCanvas.height=i,p._workingContext.drawImage(e,0,0,e.width,e.height,0,0,t,i),n.texImage2D(n.TEXTURE_2D,0,a,a,n.UNSIGNED_BYTE,p._workingCanvas),_.width=t,_.height=i,1));var h=new qt(p,Nt.Temp);return p._bindTextureDirectly(n.TEXTURE_2D,h,!0),n.texImage2D(n.TEXTURE_2D,0,a,a,n.UNSIGNED_BYTE,e),p._rescaleTexture(h,_,s,a,(function(){p._releaseTexture(h),p._bindTextureDirectly(n.TEXTURE_2D,_,!0),r()})),!0}),n)};!m||v?l&&(l.decoding||l.close)?R(l):e._FileToolsLoadImage(t,R,E,s?s.offlineProvider:null,u):"string"==typeof l||l instanceof ArrayBuffer||ArrayBuffer.isView(l)||l instanceof Blob?e._FileToolsLoadImage(l,R,E,s?s.offlineProvider:null,u):l&&R(l)}return _},e._FileToolsLoadImage=function(e,t,i,r,s){throw $t.WarnImport("FileTools")},e.prototype._rescaleTexture=function(e,t,i,r,s){},e.prototype.createRawTexture=function(e,t,i,r,s,n,o,a,l){throw void 0===a&&(a=null),void 0===l&&(l=0),$t.WarnImport("Engine.RawTexture")},e.prototype.createRawCubeTexture=function(e,t,i,r,s,n,o,a){throw void 0===a&&(a=null),$t.WarnImport("Engine.RawTexture")},e.prototype.createRawTexture3D=function(e,t,i,r,s,n,o,a,l,h){throw void 0===l&&(l=null),void 0===h&&(h=0),$t.WarnImport("Engine.RawTexture")},e.prototype.createRawTexture2DArray=function(e,t,i,r,s,n,o,a,l,h){throw void 0===l&&(l=null),void 0===h&&(h=0),$t.WarnImport("Engine.RawTexture")},e.prototype._unpackFlipY=function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))},e.prototype._getUnpackAlignement=function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)},e.prototype._getTextureTarget=function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D},e.prototype.updateTextureSamplingMode=function(e,t,i){void 0===i&&(i=!1);var r=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,s.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e},e.prototype.updateTextureWrappingMode=function(e,t,i,r){void 0===i&&(i=null),void 0===r&&(r=null);var s=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==r&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(s,null)},e.prototype._setupDepthStencilTexture=function(e,t,i,r,s){var n=t.width||t,o=t.height||t,a=t.layers||0;e.baseWidth=n,e.baseHeight=o,e.width=n,e.height=o,e.is2DArray=a>0,e.depth=a,e.isReady=!0,e.samples=1,e.generateMipMaps=!1,e._generateDepthBuffer=!0,e._generateStencilBuffer=i,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=s;var l=this._gl,h=this._getTextureTarget(e),c=this._getSamplingParameters(e.samplingMode,!1);l.texParameteri(h,l.TEXTURE_MAG_FILTER,c.mag),l.texParameteri(h,l.TEXTURE_MIN_FILTER,c.min),l.texParameteri(h,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(h,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),0===s?(l.texParameteri(h,l.TEXTURE_COMPARE_FUNC,515),l.texParameteri(h,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(h,l.TEXTURE_COMPARE_FUNC,s),l.texParameteri(h,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE))},e.prototype._uploadCompressedDataToTextureDirectly=function(e,t,i,r,s,n,o){void 0===n&&(n=0),void 0===o&&(o=0);var a=this._gl,l=a.TEXTURE_2D;e.isCube&&(l=a.TEXTURE_CUBE_MAP_POSITIVE_X+n),this._gl.compressedTexImage2D(l,o,t,i,r,0,s)},e.prototype._uploadDataToTextureDirectly=function(e,t,i,r,s,n){void 0===i&&(i=0),void 0===r&&(r=0),void 0===n&&(n=!1);var o=this._gl,a=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),h=void 0===s?this._getRGBABufferInternalSizedFormat(e.type,e.format):this._getInternalFormat(s);this._unpackFlipY(e.invertY);var c=o.TEXTURE_2D;e.isCube&&(c=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);var d=Math.round(Math.log(e.width)*Math.LOG2E),u=Math.round(Math.log(e.height)*Math.LOG2E),f=n?e.width:Math.pow(2,Math.max(d-r,0)),p=n?e.height:Math.pow(2,Math.max(u-r,0));o.texImage2D(c,r,h,f,p,0,l,a,t)},e.prototype.updateTextureData=function(e,t,i,r,s,n,o,a){void 0===o&&(o=0),void 0===a&&(a=0);var l=this._gl,h=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);var d=l.TEXTURE_2D;e.isCube&&(d=l.TEXTURE_CUBE_MAP_POSITIVE_X+o),l.texSubImage2D(d,a,i,r,s,n,c,h,t)},e.prototype._uploadArrayBufferViewToTexture=function(e,t,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var s=this._gl,n=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(n,null,!0)},e.prototype._prepareWebGLTextureContinuation=function(e,t,i,r,s){var n=this._gl;if(n){var o=this._getSamplingParameters(s,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o.min),i||r||n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t._removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}},e.prototype._prepareWebGLTexture=function(t,i,r,s,n,o,a,l,h){var c=this;void 0===h&&(h=3);var d=this.getCaps().maxTextureSize,u=Math.min(d,this.needPOTTextures?e.GetExponentOfTwo(r,d):r),f=Math.min(d,this.needPOTTextures?e.GetExponentOfTwo(s,d):s),p=this._gl;p&&(t._webGLTexture?(this._bindTextureDirectly(p.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===n||!!n),t.baseWidth=r,t.baseHeight=s,t.width=u,t.height=f,t.isReady=!0,l(u,f,(function(){c._prepareWebGLTextureContinuation(t,i,o,a,h)}))||this._prepareWebGLTextureContinuation(t,i,o,a,h)):i&&i._removePendingData(t))},e.prototype._setupFramebufferDepthAttachments=function(e,t,i,r,s){void 0===s&&(s=1);var n=this._gl;if(e&&t)return this._getDepthStencilBuffer(i,r,s,n.DEPTH_STENCIL,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT);if(t){var o=n.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=n.DEPTH_COMPONENT32F),this._getDepthStencilBuffer(i,r,s,o,o,n.DEPTH_ATTACHMENT)}return e?this._getDepthStencilBuffer(i,r,s,n.STENCIL_INDEX8,n.STENCIL_INDEX8,n.STENCIL_ATTACHMENT):null},e.prototype._releaseFramebufferObjects=function(e){var t=this._gl;e._framebuffer&&(t.deleteFramebuffer(e._framebuffer),e._framebuffer=null),e._depthStencilBuffer&&(t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(t.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),e._MSAARenderBuffer&&(t.deleteRenderbuffer(e._MSAARenderBuffer),e._MSAARenderBuffer=null)},e.prototype._releaseTexture=function(e){this._releaseFramebufferObjects(e),this._deleteTexture(e._webGLTexture),this.unbindAllTextures();var t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()},e.prototype._deleteTexture=function(e){this._gl.deleteTexture(e)},e.prototype._setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},e.prototype.bindSamplers=function(e){var t=e.getPipelineContext();this._setProgram(t.program);for(var i=e.getSamplers(),r=0;r<i.length;r++){var s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null},e.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},e.prototype._bindTextureDirectly=function(e,t,i,r){void 0===i&&(i=!1),void 0===r&&(r=!1);var s=!1,n=t&&t._associatedChannel>-1;return i&&n&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r?(this._activateCurrentTexture(),t&&t.isMultiview?this._gl.bindTexture(e,t?t._colorTextureArray:null):this._gl.bindTexture(e,t?t._webGLTexture:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)):i&&(s=!0,this._activateCurrentTexture()),n&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),s},e.prototype._bindTexture=function(e,t){if(void 0!==e){t&&(t._associatedChannel=e),this._activeChannel=e;var i=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(i,t)}},e.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))},e.prototype.setTexture=function(e,t,i){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))},e.prototype._bindSamplerUniformToChannel=function(e,t){var i=this._boundUniforms[e];i&&i._currentState!==t&&(this._gl.uniform1i(i,t),i._currentState=t)},e.prototype._getTextureWrapMode=function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},e.prototype._setTexture=function(e,t,i,r){if(void 0===i&&(i=!1),void 0===r&&(r=!1),!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;var s;s=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!i&&s&&(s._associatedChannel=e);var n=!0;this._boundTexturesCache[e]===s&&(i||this._bindSamplerUniformToChannel(s._associatedChannel,e),n=!1),this._activeChannel=e;var o=this._getTextureTarget(s);if(n&&this._bindTextureDirectly(o,s,i),s&&!s.isMultiview){if(s.isCube&&s._cachedCoordinatesMode!==t.coordinatesMode){s._cachedCoordinatesMode=t.coordinatesMode;var a=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=a,t.wrapV=a}s._cachedWrapU!==t.wrapU&&(s._cachedWrapU=t.wrapU,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),s)),s._cachedWrapV!==t.wrapV&&(s._cachedWrapV=t.wrapV,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),s)),s.is3D&&s._cachedWrapR!==t.wrapR&&(s._cachedWrapR=t.wrapR,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),s)),this._setAnisotropicLevel(o,s,t.anisotropicFilteringLevel)}return!0},e.prototype.setTextureArray=function(e,t,i){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(var r=0;r<i.length;r++){var s=i[r].getInternalTexture();s?(this._textureUnits[r]=e+r,s._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var n=0;n<i.length;n++)this._setTexture(this._textureUnits[n],i[n],!0)}},e.prototype._setAnisotropicLevel=function(e,t,i){var r=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)},e.prototype._setTextureParameterFloat=function(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)},e.prototype._setTextureParameterInteger=function(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)},e.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else{e=0;for(var t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}},e.prototype.releaseEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}},e.prototype.dispose=function(){this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),this.unbindAllAttributes(),this._boundUniforms=[],br.IsWindowObjectExist()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers=[],this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,kr.ResetCache();for(var e=0,t=this._activeRequests;e<t.length;e++)t[e].abort()},e.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},e.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},e.prototype.getError=function(){return this._gl.getError()},e.prototype._canRenderToFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)},e.prototype._canRenderToHalfFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)},e.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var i=!0,r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);var n=t.checkFramebufferStatus(t.FRAMEBUFFER);if((i=(i=i&&n===t.FRAMEBUFFER_COMPLETE)&&t.getError()===t.NO_ERROR)&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);var o=t.RGBA,a=t.UNSIGNED_BYTE,l=new Uint8Array(4);t.readPixels(0,0,1,1,o,a,l),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i},e.prototype._getWebGLTextureType=function(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE},e.prototype._getInternalFormat=function(e){var t=this._gl.RGBA;switch(e){case 0:t=this._gl.ALPHA;break;case 1:t=this._gl.LUMINANCE;break;case 2:t=this._gl.LUMINANCE_ALPHA;break;case 6:t=this._gl.RED;break;case 7:t=this._gl.RG;break;case 4:t=this._gl.RGB;break;case 5:t=this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:t=this._gl.RED_INTEGER;break;case 9:t=this._gl.RG_INTEGER;break;case 10:t=this._gl.RGB_INTEGER;break;case 11:t=this._gl.RGBA_INTEGER}return t},e.prototype._getRGBABufferInternalSizedFormat=function(e,t){if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return this._gl.RGB8;case 5:default:return this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return this._gl.RGBA8},e.prototype._getRGBAMultiSampleBufferFormat=function(e){return 1===e?this._gl.RGBA32F:2===e?this._gl.RGBA16F:this._gl.RGBA8},e.prototype._loadFile=function(t,i,r,s,n,o){var a=this,l=e._FileToolsLoadFile(t,i,r,s,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),l},e._FileToolsLoadFile=function(e,t,i,r,s,n){throw $t.WarnImport("FileTools")},e.prototype.readPixels=function(e,t,i,r,s){void 0===s&&(s=!0);var n=s?4:3,o=s?this._gl.RGBA:this._gl.RGB,a=new Uint8Array(r*i*n);return this._gl.readPixels(e,t,i,r,o,this._gl.UNSIGNED_BYTE,a),a},Object.defineProperty(e,"IsSupported",{get:function(){return this.isSupported()},enumerable:!1,configurable:!0}),e.isSupported=function(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{var e=zr.CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported},Object.defineProperty(e,"HasMajorPerformanceCaveat",{get:function(){if(null===this._HasMajorPerformanceCaveat)try{var e=zr.CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat},enumerable:!1,configurable:!0}),e.CeilingPOT=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},e.FloorPOT=function(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)},e.NearestPOT=function(t){var i=e.CeilingPOT(t),r=e.FloorPOT(t);return i-t>t-r?r:i},e.GetExponentOfTwo=function(t,i,r){var s;switch(void 0===r&&(r=2),r){case 1:s=e.FloorPOT(t);break;case 2:s=e.NearestPOT(t);break;default:s=e.CeilingPOT(t)}return Math.min(s,i)},e.QueueNewFrame=function(e,t){return br.IsWindowObjectExist()?(t||(t=window),t.requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):t.msRequestAnimationFrame?t.msRequestAnimationFrame(e):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(e):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(e):t.oRequestAnimationFrame?t.oRequestAnimationFrame(e):window.setTimeout(e,16)):"undefined"!=typeof requestAnimationFrame?requestAnimationFrame(e):setTimeout(e,16)},e.prototype.getHostDocument=function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:document},e.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]}],e._TextureLoaders=[],e.CollisionsEpsilon=.001,e._IsSupported=null,e._HasMajorPerformanceCaveat=null,e}();$r.prototype.createRenderTargetTexture=function(e,t){var i=new Wt;void 0!==t&&"object"==typeof t?(i.generateMipMaps=t.generateMipMaps,i.generateDepthBuffer=!!t.generateDepthBuffer,i.generateStencilBuffer=!!t.generateStencilBuffer,i.type=void 0===t.type?0:t.type,i.samplingMode=void 0===t.samplingMode?3:t.samplingMode,i.format=void 0===t.format?5:t.format):(i.generateMipMaps=t,i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.type=0,i.samplingMode=3,i.format=5),(1!==i.type||this._caps.textureFloatLinearFiltering)&&(2!==i.type||this._caps.textureHalfFloatLinearFiltering)||(i.samplingMode=1),1!==i.type||this._caps.textureFloat||(i.type=0,_r.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var r=this._gl,s=new qt(this,Nt.RenderTarget),n=e.width||e,o=e.height||e,a=e.layers||0,l=this._getSamplingParameters(i.samplingMode,!!i.generateMipMaps),h=0!==a?r.TEXTURE_2D_ARRAY:r.TEXTURE_2D,c=this._getRGBABufferInternalSizedFormat(i.type,i.format),d=this._getInternalFormat(i.format),u=this._getWebGLTextureType(i.type);this._bindTextureDirectly(h,s),0!==a?(s.is2DArray=!0,r.texImage3D(h,0,c,n,o,a,0,d,u,null)):r.texImage2D(h,0,c,n,o,0,d,u,null),r.texParameteri(h,r.TEXTURE_MAG_FILTER,l.mag),r.texParameteri(h,r.TEXTURE_MIN_FILTER,l.min),r.texParameteri(h,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(h,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),i.generateMipMaps&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null);var f=this._currentFramebuffer,p=r.createFramebuffer();return this._bindUnboundFramebuffer(p),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!i.generateStencilBuffer,i.generateDepthBuffer,n,o),s.is2DArray||r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,s._webGLTexture,0),this._bindUnboundFramebuffer(f),s._framebuffer=p,s.baseWidth=n,s.baseHeight=o,s.width=n,s.height=o,s.depth=a,s.isReady=!0,s.samples=1,s.generateMipMaps=!!i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,s._generateDepthBuffer=i.generateDepthBuffer,s._generateStencilBuffer=!!i.generateStencilBuffer,this._internalTexturesCache.push(s),s},$r.prototype.createDepthStencilTexture=function(e,t){if(t.isCube){var i=e.width||e;return this._createDepthStencilCubeTexture(i,t)}return this._createDepthStencilTexture(e,t)},$r.prototype._createDepthStencilTexture=function(e,t){var i=this._gl,r=e.layers||0,s=0!==r?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,n=new qt(this,Nt.Depth);if(!this._caps.depthTextureExtension)return _r.Error("Depth texture is not supported by your browser or hardware."),n;var o=(0,kt.pi)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t);this._bindTextureDirectly(s,n,!0),this._setupDepthStencilTexture(n,e,o.generateStencil,o.bilinearFiltering,o.comparisonFunction);var a=o.generateStencil?i.UNSIGNED_INT_24_8:i.UNSIGNED_INT,l=o.generateStencil?i.DEPTH_STENCIL:i.DEPTH_COMPONENT,h=l;return this.webGLVersion>1&&(h=o.generateStencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24),n.is2DArray?i.texImage3D(s,0,h,n.width,n.height,r,0,l,a,null):i.texImage2D(s,0,h,n.width,n.height,0,l,a,null),this._bindTextureDirectly(s,null),n};function qr(e){const t=[e.ACTIVE_TEXTURE,e.ARRAY_BUFFER_BINDING,e.BLEND,e.BLEND_COLOR,e.BLEND_DST_ALPHA,e.BLEND_DST_RGB,e.BLEND_EQUATION_ALPHA,e.BLEND_EQUATION_RGB,e.BLEND_SRC_ALPHA,e.BLEND_SRC_RGB,e.COLOR_CLEAR_VALUE,e.COLOR_WRITEMASK,e.CULL_FACE,e.CULL_FACE_MODE,e.CURRENT_PROGRAM,e.DEPTH_CLEAR_VALUE,e.DEPTH_FUNC,e.DEPTH_RANGE,e.DEPTH_TEST,e.DEPTH_WRITEMASK,e.DITHER,e.ELEMENT_ARRAY_BUFFER_BINDING,e.FRAMEBUFFER_BINDING,e.FRONT_FACE,e.GENERATE_MIPMAP_HINT,e.LINE_WIDTH,e.PACK_ALIGNMENT,e.POLYGON_OFFSET_FACTOR,e.POLYGON_OFFSET_FILL,e.POLYGON_OFFSET_UNITS,e.RENDERBUFFER_BINDING,e.SAMPLE_COVERAGE_INVERT,e.SAMPLE_COVERAGE_VALUE,e.SCISSOR_BOX,e.SCISSOR_TEST,e.STENCIL_BACK_FAIL,e.STENCIL_BACK_FUNC,e.STENCIL_BACK_PASS_DEPTH_FAIL,e.STENCIL_BACK_PASS_DEPTH_PASS,e.STENCIL_BACK_REF,e.STENCIL_BACK_VALUE_MASK,e.STENCIL_BACK_WRITEMASK,e.STENCIL_CLEAR_VALUE,e.STENCIL_FAIL,e.STENCIL_FUNC,e.STENCIL_PASS_DEPTH_FAIL,e.STENCIL_PASS_DEPTH_PASS,e.STENCIL_REF,e.STENCIL_TEST,e.STENCIL_VALUE_MASK,e.STENCIL_WRITEMASK,e.TEXTURE_BINDING_2D,e.TEXTURE_BINDING_CUBE_MAP,e.UNPACK_ALIGNMENT,e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.UNPACK_FLIP_Y_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL];let i=e.getParameter(e.VIEWPORT),r=new Array(57);for(let i=0;i<57;i++)r[i]=e.getParameter(t[i]);let s=new Array(2);for(let t=0;t<2;t++)s[t]=e.getVertexAttrib(t,e.VERTEX_ATTRIB_ARRAY_ENABLED);return{viewport:i,params:r,VERTEX_ATTRIB_ARRAY_ENABLED:s}}class jr{constructor(e){this.webGLRestoreToDefault=!1,this.old=new Array(57),this.old_VERTEX_ATTRIB_ARRAY_ENABLED=new Array(2),this.webGLRestoreToDefault=e}init(e){if(this.gl&&O.Error(591663577,"Previous Init has not been Restored"),this.gl=e,this.webGLRestoreToDefault)this.old_VIEWPORT=e.getParameter(e.VIEWPORT);else{let{viewport:t,params:i,VERTEX_ATTRIB_ARRAY_ENABLED:r}=qr(e);this.old_VIEWPORT=t,this.old=i,this.old_VERTEX_ATTRIB_ARRAY_ENABLED=r}}setDefaults(){const e=this.gl;if(e){e.activeTexture(e.TEXTURE0),e.bindBuffer(e.ARRAY_BUFFER,null),e.disable(e.BLEND),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.disable(e.CULL_FACE),e.cullFace(e.BACK),e.useProgram(null),e.clearDepth(1),e.depthFunc(e.LESS),e.depthRange(0,1),e.disable(e.DEPTH_TEST),e.depthMask(!0),e.disable(e.DITHER),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.frontFace(e.CCW),e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE),e.lineWidth(1),e.polygonOffset(0,0),e.disable(e.POLYGON_OFFSET_FILL),e.bindRenderbuffer(e.RENDERBUFFER,null),e.sampleCoverage(1,!1),e.scissor(0,0,this.old_VIEWPORT[2],this.old_VIEWPORT[3]),e.disable(e.SCISSOR_TEST),e.stencilFunc(e.ALWAYS,0,1),e.stencilMask(255),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.disable(e.STENCIL_TEST),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.pixelStorei(e.PACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),e.viewport(this.old_VIEWPORT[0],this.old_VIEWPORT[1],this.old_VIEWPORT[2],this.old_VIEWPORT[3]);for(let t=0;t<2;t++)e.disableVertexAttribArray(t)}else O.Error(591663578,"Trying to set default without Init")}restore(){const e=this.gl;if(!e)return void O.Error(591663579,"Trying to Restore without Init");const t=this.old;if(this.webGLRestoreToDefault)this.setDefaults();else{e.activeTexture(t[0]),e.bindBuffer(e.ARRAY_BUFFER,t[1]),t[2]?e.enable(e.BLEND):e.disable(e.BLEND);const i=t[3];e.blendColor(i[0],i[1],i[2],i[3]),e.blendEquationSeparate(t[7],t[6]),e.blendFuncSeparate(t[9],t[5],t[8],t[4]);const r=t[10];e.clearColor(r[0],r[1],r[2],r[3]);const s=t[11];e.colorMask(s[0],s[1],s[2],s[3]),t[12]?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.cullFace(t[13]),e.useProgram(t[14]),e.clearDepth(t[15]),e.depthFunc(t[16]),e.depthRange(t[17][0],t[17][1]),t[18]?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(t[19]),t[20]?e.enable(e.DITHER):e.disable(e.DITHER),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t[21]),e.bindFramebuffer(e.FRAMEBUFFER,t[22]),e.frontFace(t[23]),e.hint(e.GENERATE_MIPMAP_HINT,t[24]),e.lineWidth(t[25]),e.pixelStorei(e.PACK_ALIGNMENT,t[26]),e.polygonOffset(t[27],t[29]),t[28]?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.bindRenderbuffer(e.RENDERBUFFER,t[30]),e.sampleCoverage(t[32],t[31]);const n=t[33];e.scissor(n[0],n[1],n[2],n[3]),t[34]?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFuncSeparate(e.FRONT,t[44],t[47],t[49]),e.stencilFuncSeparate(e.BACK,t[36],t[39],t[40]),e.stencilMaskSeparate(e.FRONT,t[50]),e.stencilMaskSeparate(e.BACK,t[41]),e.stencilOpSeparate(e.FRONT,t[43],t[45],t[46]),e.stencilOpSeparate(e.BACK,t[35],t[37],t[38]),e.clearStencil(t[42]),t[48]?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.bindTexture(e.TEXTURE_2D,t[51]),e.bindTexture(e.TEXTURE_CUBE_MAP,t[52]),e.pixelStorei(e.UNPACK_ALIGNMENT,t[53]),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,t[54]),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t[55]),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t[56]),e.viewport(this.old_VIEWPORT[0],this.old_VIEWPORT[1],this.old_VIEWPORT[2],this.old_VIEWPORT[3]);for(let t=0;t<2;t++)this.old_VERTEX_ATTRIB_ARRAY_ENABLED[t]?e.enableVertexAttribArray(t):e.disableVertexAttribArray(t)}this.gl=void 0}}let Xr=1;const Yr=[{v:"precision highp float;const int pc=0,qc=1,rc=2,sc=3,tc=-1;const int k=0,l=1,m=2,n=3;const int uc=0,vc=1,wc=2;uniform vec2 u_0;uniform vec2 u_1;uniform vec2 u_2;uniform float u_3;uniform int u_4;uniform float u_5;uniform int u_6;uniform int u_7;uniform mat3 u_8;uniform float u_12;uniform int u_13;uniform float u_14;uniform int u_15;uniform vec2 u_17;uniform int u_18;uniform int u_19;attribute vec2 a_v;attribute vec4 a_p0;attribute vec4 a_p1;attribute vec4 a_p2;attribute vec4 a_p3;attribute vec4 a_p4;attribute float a_d1;attribute float a_d2;const float o=0.0,p=1.0,q=3.0,s=4.0,t=5.0,u=6.0,v=7.0;const float xc=0.001;const float yc=0.001;varying float frag_type;varying vec3 frag_geoUVS;varying vec2 frag_geoRange;varying vec4 frag_specialParam1;varying vec4 frag_specialParam2;varying vec4 frag_specialParam3;varying vec3 frag_specialParam4;varying vec2 frag_specialParam5;const int zc=2,Ac=5;const int Bc=0,Cc=1,Dc=2,Ec=3;vec2 Fc(vec4 Gc){mat3 Hc=u_8;vec2 Ic=u_0;vec2 Jc=u_1;vec2 Kc=u_17;return((Hc*vec3(Gc.xy,1.0)).xy*Jc-Ic)/Kc;}vec2 Lc(vec2 wb){return vec2(-wb.y,wb.x);}void main(){vec2 Mc=a_v;int Y=u_7;vec2 Nc=u_2;float Oc=u_3;int Z=u_4;float Pc=u_5;float Qc=u_12;int fb=u_13;float Rc=u_14;int Sc=u_15;vec2 Kc=u_17;bool Tc=u_18 !=0;bool Uc=u_19 !=0;frag_type=0.0;frag_geoRange=frag_specialParam5=vec2(0.0,0.0);frag_geoUVS=frag_specialParam4=vec3(0.0,0.0,0.0);frag_specialParam1=frag_specialParam2=frag_specialParam3=vec4(0.0,0.0,0.0,0.0);if(Y==rc || Y==sc){gl_Position=vec4(Mc,0.0,1.0);frag_type=p;}else{vec2 Vc=Fc(a_p0),Wc=Fc(a_p1),Xc=Fc(a_p2),Yc=Fc(a_p3),Zc=Fc(a_p4);int ad=int(a_p0.z),bd=int(a_p1.z),cd=int(a_p2.z),dd=int(a_p3.z),ed=int(a_p4.z);float fd=Uc ? 0.0 : a_d1,gd=Uc ? 0.0 : a_d2;float hd=a_p1.w,id=a_p2.w,jd=a_p3.w;bool kd=bd==wc;bool ld=cd==wc;vec2 md,nd,od;int pd,qd;if(ld){md=Wc;nd=Xc;od=Yc;pd=bd;qd=dd;}else if(kd){md=Vc;nd=Wc;od=Xc;pd=ad;qd=cd;}else{md=Wc;nd=(Wc+Xc)*0.5;od=Xc;pd=bd;qd=cd;}vec2 rd=od-md,sd=nd-md,td=od-nd;float ud=length(rd),vd=length(sd),wd=length(td);vec2 xd=rd/ud,yd=sd/vd,zd=td/wd;vec2 Ad=Lc(xd),Bd=Lc(yd),Cd=Lc(zd);float Dd=dot(Bd,zd);mat2 Ed;vec2 Fd,Gd;float Hd;bool Id=false;vec2 Jd;if(ld || kd){vec2 Kd=td-sd;float Ld=(dot(-sd,td)+dot(-sd,-sd))/dot(Kd,Kd);vec2 Md=mix(md,nd,Ld),Nd=mix(nd,od,Ld),Od=normalize(Nd-Md);float Pd=sign(Dd);mat2 Qd=mat2(Od,vec2(-Od.y,Od.x)*Pd);vec2 Rd=mix(Md,Nd,Ld);vec2 Sd=(md-Rd)*Qd,Td=(od-Rd)*Qd;float Ud=abs(Sd.x)> abs(Td.x)?(Sd.x*Sd.x)/Sd.y :(Td.x*Td.x)/Td.y;Ed=Qd/Ud;Fd=Rd;Gd=vec2(Sd.x,Td.x)/Ud;Hd=Ud*Pd;Id=Tc || abs(Dd)< xc || min(abs(ud),min(abs(vd/ud),abs(wd/ud)))< Oc*yc;if(Id){nd=(md+od)*0.5;sd=nd-md;td=od-nd;vd=wd=ud*0.5;yd=zd=xd;Bd=Cd=Ad;Dd=1.0;}}bool Vd=ld || kd;vec2 Wd=Vc;int Xd=ad;vec2 Yd=Vd ? Zc : Yc;int Zd=Vd ? ed : dd;bool ae=(Xd==0),be=(Zd==0),ce=(qd==0);if(Xd==0)Wd=md-(nd-md);if(Zd==0)Yd=od-(od-nd);vec2 de=md-Wd,ee=-de,fe=Yd-od,ge=-fe;float he=length(de),ie=length(fe);vec2 je=de/he,ke=fe/ie;vec2 le=Lc(je),me=Lc(ke);if(! Vd || Id){if(vd < yc){yd=je;Bd=le;}if(wd < yc){zd=ke;Cd=me;}if(ud < yc){xd=normalize(Yd-Wd);Ad=Lc(xd);}if(ud < yc){xd=vec2(1.0,0.0);Ad=vec2(0.0,-1.0);ud=yc;}if(vd < yc){yd=xd;Bd=Ad;}if(wd < yc){zd=xd;Cd=Ad;}if(he < yc){je=yd;le=Bd;}if(ie < yc){ke=zd;me=Cd;}Ed=mat2(xd/ud,Ad/ud);Fd=md;Gd=vec2(0.0,1.0);Hd=ud;}vec2 ne=vec2(0.0,0.0);if(Y==pc &&(! Vd || ld)){if(Tc){bool ce=(qd==0);if(ce || abs(ud)< Oc*yc)frag_type=o;else{float oe=clamp(hd,0.0,1.0);float pe=clamp((Vd ? jd : id),0.0,1.0);float qe=Vd ? fd+(gd-fd)*2.0 : gd;float re=Qc*0.5;vec4 se=vec4(min(md.x,od.x)-Oc*Kc.x,min(md.y,od.y)-Oc*Kc.y,max(md.x,od.x)+Oc*Kc.x,max(md.y,od.y)+Oc*Kc.y);ne=Mc*vec2(se [ 2 ]-se [ 0 ],se [ 3 ]-se [ 1 ])/2.0+vec2(se [ 2 ]+se [ 0 ],se [ 3 ]+se [ 1 ])/2.0;vec2 te=vec2(xd.x==0.0 ? 1.0 : sign(xd.x),xd.y==0.0 ? 1.0 : sign(xd.y));float ue=re*(1.0-oe),ve=re*(1.0-pe);float we=re*oe,xe=re*pe;vec2 ye=md-te*we,ze=od+te*xe;vec2 Ae=ye+vec2(te.x*2.0*we,0.0),Be=ze-vec2(te.x*2.0*xe,0.0);vec2 Ce=ye+vec2(0.0,te.y*2.0*we),De=ze-vec2(0.0,te.y*2.0*xe);bool Ee=dot(Ad,Ae-md)>=0.0,Fe=dot(Ad,Be-md)>=0.0;vec2 Ge=Ee ? Ae : Ce,He=Fe ? Be : De;vec2 Ie=Ee ? Ce : Ae,Je=Fe ? De : Be;float Ke=max(abs(xd.x),abs(xd.y));float Le=dot(ne-Ge,Lc(normalize(He-Ge)))*Ke+re;float Me=dot(ne-Ie,-Lc(normalize(Je-Ie)))*Ke+re;float Ne=dot(ne-md,Ad);float Oe=dot(ne-md,(oe > xc)? Lc(Ie-Ge): xd);float Pe=dot(ne-od,(pe > xc)? Lc(He-Je):-xd);frag_specialParam1=vec4(ne-md,ne-od)*0.5/Oc;frag_specialParam2=vec4(Le,Me,ue,ve)*0.5/Oc;frag_specialParam3=vec4(gd-fd,fd,0.0,0.0);frag_specialParam4=vec3(Ne,Oe,Pe);frag_type=v;}}else{float Qe=dot(le,yd),Re=dot(Cd,ke),Se=dot(le,xd),Te=dot(Ad,ke);bool Ue=abs(Qe)< xc,Ve=abs(Re)< xc;bool We=Ue && dot(je,yd)< 0.0,Xe=Ve && dot(zd,ke)< 0.0;float Ye=(! Ue)? sign(Qe):(Se !=0.0)? sign(Se): sign(Te);float Ze=(! Ve)? sign(Re):(Te !=0.0)? sign(Te): sign(Se);vec2 af=normalize(le+Bd)*-Ye;float bf=abs(dot(af,Bd));float cf=(Z==k)? bf :(Z==l)? 1.0/max(bf,xc): 1.0;vec2 df=We ? yd*Ye : af*cf;vec2 ef=normalize(Cd+me)*-Ze;float ff=abs(dot(ef,Cd));float gf=(Z==k)? ff :(Z==l)? 1.0/max(ff,xc): 1.0;vec2 hf=Xe ?-zd*Ze : ef*gf;vec4 se=vec4(min(min(min(min(md.x,od.x),nd.x),md.x+df.x*Oc),od.x+hf.x*Oc)-Oc,min(min(min(min(md.y,od.y),nd.y),md.y+df.y*Oc),od.y+hf.y*Oc)-Oc,max(max(max(max(md.x,od.x),nd.x),md.x+df.x*Oc),od.x+hf.x*Oc)+Oc,max(max(max(max(md.y,od.y),nd.y),md.y+df.y*Oc),od.y+hf.y*Oc)+Oc);ne=Mc*vec2(se [ 2 ]-se [ 0 ],se [ 3 ]-se [ 1 ])/2.0+vec2(se [ 2 ]+se [ 0 ],se [ 3 ]+se [ 1 ])/2.0;vec2 jf=normalize(Bd+df*Ye);vec2 kf=-normalize(le+df*Ye);bool lf=ce || We || Ue || cf > vd*10.0 || cf > he*10.0;vec2 mf=ne-md;vec2 nf=normalize(df);float Cb=-dot(mf,(vd < xc || We)? xd : yd);float Db=lf ? Cb :-dot(mf,Lc(nf))*Ye;float Eb=lf ?-dot(mf,Bd)*Ye : dot(mf,Lc(jf))/(2.0*Oc*length(df+jf*dot(-df,jf)));float Fb=lf ? 0.5 :(dot(mf,nf)/Oc-Pc)/abs(dot(nf,Bd));float Gb=lf ? 1.0 : dot(mf,Lc(kf))/(2.0*Oc*length(df+kf*dot(-df,kf)));vec2 of=-normalize(Cd+hf*Ze);vec2 pf=normalize(me+hf*Ze);bool qf=ce || Xe || Ve || gf > wd*10.0 || gf > ie*10.0;vec2 rf=ne-od;vec2 sf=normalize(hf);float Hb=dot(rf,(wd < xc || Xe)? xd : zd);float Ib=qf ? Hb : dot(rf,Lc(sf))*Ze;float Jb=qf ?-dot(rf,Cd)*Ze : dot(rf,Lc(of))/(2.0*Oc*length(hf+of*dot(-hf,of)));float Kb=qf ? 0.5 :(dot(rf,sf)/Oc-Pc)/abs(dot(sf,Cd));float Lb=qf ? 1.0 : dot(rf,Lc(pf))/(2.0*Oc*length(hf+pf*dot(-hf,pf)));float tf=(1.0-Rc)*Qc/(4.0*Oc);if(ae)Gb=-dot(mf,yd)/(2.0*Oc)+tf;if(be)Lb=dot(rf,zd)/(2.0*Oc)+tf;float uf,vf;if(Vd && ! Id){float wf=fd,qe=fd+(gd-fd)*2.0;float xf=sqrt(1.0+4.0*Gd [ 0 ]*Gd [ 0 ]),yf=sqrt(1.0+4.0*Gd [ 1 ]*Gd [ 1 ]);float zf=sign(Gd [ 0 ])*0.5*(abs(Gd [ 0 ])*xf+0.5*log(2.0*abs(Gd [ 0 ])+xf));float Af=sign(Gd [ 1 ])*0.5*(abs(Gd [ 1 ])*yf+0.5*log(2.0*abs(Gd [ 1 ])+yf));uf=(qe-wf)/abs(Af-zf);vf=wf-zf*uf;}else{float wf=fd;float qe=gd;uf=qe-wf;vf=wf;}float oe=hd;float pe=Vd ? jd : id;vec2 Bf=(vec2(1.0,1.0)-clamp(vec2(oe,pe),0.0,1.0))*Qc/(4.0*Oc);frag_specialParam1=vec4(vec2(Cb,Db)/Qc,Eb,Fb);frag_specialParam2=vec4(vec2(Hb,Ib)/Qc,Jb,Kb);frag_specialParam3=vec4(uf,vf,Bf.x,Bf.y);if(Sc==0 || Rc > 0.0)frag_specialParam4=vec3(ae ? 0.0 : 1.0,be ? 0.0 : 1.0,ce ? 0.0 : 1.0);else frag_specialParam4=vec3(1.0,1.0,ce ? 0.0 : 1.0);frag_specialParam5=vec2(Gb,Lb);frag_type=(Vd && ! Id)? s : q;}}else if(Y==qc &&(! Id || ld)){float Cf=(Mc.y)/(Kc.x*Nc.x);if(! Vd || Id){vec2 Df=(Mc.x < 0.0)? md : od;ne=Df+vec2(Cf,0.0);frag_type=t;}else{float Ef=clamp((md.y-nd.y)/(md.y+od.y-2.0*nd.y),0.0,1.0);vec2 Ff=mix(mix(md,nd,Ef),mix(nd,od,Ef),Ef);vec2 Gf=ld ? md : Ff;vec2 Hf=ld ? Ff : od;vec2 Df=(Mc.x < 0.0)? Gf : Hf;vec2 If=(Ff-Fd)*Ed;vec2 Jf=(Df+vec2(Cf,0.0)-Fd)*Ed;vec2 Kf=((ld ? md : od)-Fd)*Ed;float Lf=Jf.x-If.x;float Mf=sign(Kf.x-If.x);float fc=Lf*Mf;float gc=sign(dot(Bd,zd));ne=Df+vec2(Cf,0.0);frag_specialParam1.x=dot(ne-md,Bd*sign(dot(Bd,xd)));frag_specialParam1.y=dot(ne-nd,Cd*sign(dot(Cd,-yd)));frag_specialParam1.z=dot(ne-od,Ad*sign(dot(Ad,-zd)));frag_specialParam1.w=dot(ne-Gf,vec2(Gf.y-Hf.y,Hf.x-Gf.x));frag_specialParam2.x=fc;frag_specialParam2.y=gc;frag_type=u;}}else{gl_Position=vec4(0.0,0.0,0.0,0.0);frag_type=o;}gl_Position=vec4(ne.x*Nc.x*2.0*Kc.x,-ne.y*Nc.y*2.0*Kc.y,0.0,1.0);frag_geoRange=Gd;frag_geoUVS.xy=(ne-Fd)*Ed;frag_geoUVS.z=Hd*0.5/Oc;if(fb==2)frag_specialParam3=vec4(Mc.x*0.5+0.5,Mc.y*0.5+0.5,rd.x+rd.y,0.0);}}",f:"precision highp float;const int c=0,d=1,e=2,f=3,h=4,i=5,j=6;const int k=0,l=1,m=2,n=3;uniform int ufrag_0;uniform int ufrag_1;uniform float ufrag_2;uniform float ufrag_3;uniform float ufrag_4;uniform float ufrag_5;uniform float ufrag_6;uniform int ufrag_7;uniform float ufrag_8;uniform float ufrag_10;uniform float ufrag_11;uniform float ufrag_12;uniform vec4 ufrag_13;uniform float ufrag_15;uniform vec2 ufrag_16;uniform int ufrag_17;uniform float ufrag_18;uniform float ufrag_19;varying float frag_type;const float o=0.0,p=1.0,q=3.0,s=4.0,t=5.0,u=6.0,v=7.0;varying vec3 frag_geoUVS;varying vec2 frag_geoRange;varying vec4 frag_specialParam1;varying vec4 frag_specialParam2;varying vec4 frag_specialParam3;varying vec3 frag_specialParam4;varying vec2 frag_specialParam5;float A(vec2 B,vec2 C){float a=0.5-B.y;float b=-0.5*B.x;float D=b*0.5;float E=(b*b)*0.25;float F=(a*a*a)/27.0;if(E+F > 0.0){float G=sqrt(E+F);float H=G-D;float I=sign(H)*pow(abs(H),1.0/3.0);float J=G+D;float K=-sign(J)*pow(abs(J),1.0/3.0);float x=I+K;return clamp(x,C [ 0 ],C [ 1 ]);}else{const float L=0.333333333;const vec3 M=vec3(0.0,2.094395102,4.188790205);float N=1.0/a;vec3 O=2.0*sqrt(-a*L)*cos(L*acos(sqrt(-6.75*N)*b*N)-M);vec3 x=clamp(O,C [ 0 ],C [ 1 ]);vec3 P=B.x-x,Q=B.y-x*x,R=P*P+Q*Q;return(R [ 0 ] < R [ 1 ] && R [ 0 ] < R [ 2 ])? x [ 0 ] :(R [ 1 ] < R [ 2 ])? x [ 1 ] : x [ 2 ];}}bool S(float T){return T-0.4 < frag_type && frag_type < T+0.4;}float U(float V,float a,float b,float W,float X){return clamp((abs(V*2.0-a-b)+a-b)*W*0.5+X,0.0,1.0);}void main(){int Y=ufrag_0;int Z=ufrag_1;float ab=ufrag_2;float bb=ufrag_3;float cb=ufrag_4;float db=ufrag_5;float eb=ufrag_6;int fb=ufrag_7;float gb=ufrag_8;float hb=ufrag_10;float ib=ufrag_11;float jb=ufrag_12;vec4 kb=ufrag_13;float lb=ufrag_15;vec2 mb=ufrag_16;bool nb=(ufrag_17==1);float ob=ufrag_18;float pb=ufrag_19;const float qb=1.0;float F=qb;float rb;float sb=0.0;float tb=0.0;if(Y==0 && ! S(v)){float V=0.0;float ub=0.0;vec2 vb;if(S(s)){float x=A(frag_geoUVS.xy,frag_geoRange);vb=frag_geoUVS.xy-vec2(x,x*x);vec2 wb=normalize(vec2(1.0,2.0*x));sb=dot(vb,vec2(-wb.y,wb.x))*frag_geoUVS.z;float xb=2.0*abs(x),yb=sqrt(1.0+xb*xb);float zb=sign(x)*(xb*yb+log(xb+yb))*0.25;float Ab=1.0-abs(sign((x-frag_geoRange [ 0 ])*(x-frag_geoRange [ 1 ])));V=zb+Ab*dot(vb,wb);ub=(x-frag_geoRange [ 0 ])/(frag_geoRange [ 1 ]-frag_geoRange [ 0 ]);}else{vb=frag_geoUVS.xy-vec2(clamp(frag_geoUVS.x,0.0,1.0),0.0);V=ub=frag_geoUVS.x;sb=frag_geoUVS.y;}F=length(vb)*abs(frag_geoUVS.z);ub=clamp(ub,0.0,1.0);const float Bb=0.01;float Cb=frag_specialParam1 [ 0 ],Db=frag_specialParam1 [ 1 ],Eb=frag_specialParam1 [ 2 ],Fb=frag_specialParam1 [ 3 ],Gb=frag_specialParam5 [ 0 ];float Hb=frag_specialParam2 [ 0 ],Ib=frag_specialParam2 [ 1 ],Jb=frag_specialParam2 [ 2 ],Kb=frag_specialParam2 [ 3 ],Lb=frag_specialParam5 [ 1 ];float Mb=frag_specialParam4.x,Nb=frag_specialParam4.y,Ob=frag_specialParam4.z;bool Pb=ub < 0.5 ?(Mb !=0.0 &&(Db > Bb || Fb > 1.0)):(Nb !=0.0 &&(Ib > Bb || Kb > 1.0));if(Z !=m){if(Pb)F=qb;else{const float Qb=0.001;if(ub < 0.5 && Cb > Bb && Mb !=0.0)F=(Db <=Qb)? Eb :(Fb >=0.0)? Gb : qb;if(ub > 0.5 && Hb > Bb && Nb !=0.0)F=(Ib <=Qb)? Jb :(Kb >=0.0)? Lb : qb;}}float Rb=F;if(Mb==0.0)Rb=max(Rb,Gb);if(Nb==0.0)Rb=max(Rb,Lb);tb=V*frag_specialParam3.x+frag_specialParam3.y;bool Sb=(mb==vec2(0.0,0.0))||(mb [ 0 ] <=tb && tb <=mb [ 1 ]);bb=Sb ? bb*Ob : 0.0;float Tb=(F <=lb && Sb)? bb : 0.0;float Ub=Pb ? 0.0 : Tb;const float Vb=0.2;const float Wb=(1.0-2.0*Vb)*2.0;float Xb=abs(fract(db+tb*cb)*2.0-1.0)*jb;float Yb=U(Xb,kb [ 0 ],kb [ 1 ],Wb,Vb)*U(Xb,kb [ 2 ],kb [ 3 ],Wb,Vb)*Tb;float Zb=clamp(0.5-F*sign(sb)*ib,0.0,1.0)*Ub;rb=sign(Rb)*max(0.0,abs(Rb)+mix(frag_specialParam3.z,frag_specialParam3.w,ub));float ac=(0.5-rb+pb)*bb;float bc=(0.5-F)*ab;vec4 cc=vec4(bc,ac,Zb,Yb);vec4 dc=vec4(ac,bc,0.0,0.0);vec4 ec=mix(cc,dc,ob);gl_FragColor=clamp(ec,0.0,1.0);}else if(S(t)){gl_FragColor=vec4(0.0,0.0,0.0,1.0);if(eb==sign(frag_geoUVS.y))discard;}else if(S(u)){gl_FragColor=vec4(0.0,0.0,0.0,0.0);if(frag_specialParam1.x > 0.0 && frag_specialParam1.y > 0.0 && frag_specialParam1.z > 0.0){float fc=frag_specialParam2.x,gc=frag_specialParam2.y;float hc=((fc >=0.0)? sign((frag_geoUVS.y-frag_geoUVS.x*frag_geoUVS.x)): 1.0)*gc;if(eb==hc)discard;}else if(eb==sign(frag_specialParam1.w))discard;}else if(S(v)){tb=frag_geoUVS.x*frag_specialParam3.x+frag_specialParam3.y;float ic=max(abs(frag_specialParam1.x),abs(frag_specialParam1.y))+frag_specialParam2.z;float jc=max(abs(frag_specialParam1.z),abs(frag_specialParam1.w))+frag_specialParam2.w;rb=min(ic,jc);if(frag_specialParam4.y >=0.0 && frag_specialParam4.z >=0.0)rb=min(rb,frag_specialParam4.x >=0.0 ? frag_specialParam2.x : frag_specialParam2.y);float kc=0.5-clamp(rb,0.0,0.5);gl_FragColor=vec4(kc*ab,kc*bb,0.0,1.0);}else gl_FragColor=vec4(frag_type*(1.0-gb),0.0,0.0,frag_type*gb);if(Y==0 && nb){float lc=smoothstep(lb,lb*1.5,rb);float mc=(tb+32.0*rb/lb)*jb;float nc=1.0-(mc+lc);gl_FragColor=vec4(nc,nc,nc,1.0);}if(fb==e){gl_FragColor.rgb=clamp(vec3(1.0-F*2.0,1.0-F*4.0,1.0-F*8.0),0.0,1.0);float oc=0.25+clamp((abs(frag_specialParam3.x+frag_specialParam3.y-1.0)+abs(frag_specialParam3.x-frag_specialParam3.y))*4.0-2.75,0.0,1.0);gl_FragColor+=vec4(oc*(1.0+sin(frag_specialParam3.z))/2.0,oc*(1.0+cos(frag_specialParam3.z))/2.0,oc*frag_specialParam3.z/18.0,1.0);}}",a:["a_v","a_p0","a_p1","a_p2","a_p3","a_p4","a_d1","a_d2"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4","ufrag_5","ufrag_6","ufrag_7","ufrag_8","ufrag_10","ufrag_11","ufrag_12","ufrag_13","ufrag_15","ufrag_16","ufrag_17","ufrag_18","ufrag_19","u_0","u_1","u_2","u_3","u_4","u_5","u_6","u_7","u_8","u_12","u_13","u_14","u_15","u_17","u_18","u_19"],s:[]},{v:"precision highp float;uniform mat3 u_0;uniform mat3 u_1;uniform vec2 u_2;uniform mat3 u_3;uniform mat3 u_4;uniform mat3 u_5;uniform mat3 u_6;uniform mat3 u_7;uniform mat3 u_8;uniform mat3 u_10;uniform mat3 u_11;uniform int u_13;uniform int u_14;uniform vec2 u_15;uniform int u_16;uniform float u_17;uniform float u_18;uniform float u_19;uniform vec2 u_20;uniform vec2 u_21;attribute vec2 a_v;attribute vec2 a_0;attribute vec2 a_1;varying vec2 l,m,n,o,p,q,s,t;varying float u;mat2 id(float jd){return mat2(cos(jd),-sin(jd),sin(jd),cos(jd));}vec2 kd(vec2 ld){return vec2(ld.x/2.0,ld.y/-2.0)+vec2(0.5,0.5);}vec2 md(vec2 ld,mat3 nd){return(nd*vec3(vec2(ld.x/2.0,ld.y/2.0),1.0)).xy*vec2(1.0,-1.0)+vec2(0.5,0.5);}mat4 od(float pd,float qd,float rd,float sd){float a=1.0/tan(pd*0.5),b=1.0/(rd-sd);return mat4(a/qd,0.0,0.0,0.0,0.0,-a,0.0,0.0,0.0,0.0,(rd+sd)*b,-1.0,0.0,0.0,2.0*rd*sd*b,0.0);}mat4 td(float jd){float ud=cos(jd),vd=sin(jd);return mat4(1.0,0.0,0.0,0.0,0.0,ud,-vd,0.0,0.0,vd,ud,0.0,0.0,0.0,0.0,1.0);}mat4 wd(float jd){float ud=cos(jd),vd=sin(jd);return mat4(ud,0.0,vd,0.0,0.0,1.0,0.0,0.0,-vd,0.0,ud,0.0,0.0,0.0,0.0,1.0);}void main(){vec2 xd=a_v;mat3 yd=u_0;vec2 zd=u_15;mat3 Ad=u_1;vec2 Bd=u_2;mat3 Cd=u_3;mat3 Dd=u_4;mat3 Ed=u_5;mat3 Fd=u_6;mat3 Gd=u_7;mat3 Hd=u_8;mat3 Id=u_10;mat3 Jd=u_11;vec2 Kd=u_20;vec2 Ld=u_21;int Md=u_13;int Nd=u_14;float Od=u_18;float Pd=u_19;vec2 Qd=xd;vec2 Rd=xd;if(u_16 !=0){Qd=xd+a_0*2.0;Rd=xd+a_1*2.0;xd=mix(Qd,Rd,u_17);}vec2 Sd=(yd*vec3(xd.xy/2.0,1.0)).xy;vec2 Td;if(zd !=vec2(1.0,1.0)){const float Ud=1.57079632679;mat4 Vd=wd((1.0-zd.x)*Ud),Wd=td((1.0-zd.y)*Ud);mat4 Xd=mat4(mat2(Ad));Xd [ 3 ] [ 0 ]=Ad [ 2 ] [ 0 ];Xd [ 3 ] [ 1 ]=Ad [ 2 ] [ 1 ];vec4 Yd=Xd*Wd*Vd*vec4(Sd,0.0,1.0)-vec4(Bd*0.5,0.0,0.0);gl_Position=vec4((Yd.xy/Bd)*vec2(2.0,-2.0),0.0,1.0);const float Zd=0.78539816339;float ae=Bd.y/(2.0*tan(Zd*0.5));Yd.z-=ae;vec4 be=od(Zd,Bd.x/Bd.y,ae/2.0,ae*2.0)*Yd;gl_Position=be/be.w;}else{vec2 Td=(Ad*vec3(Sd,1.0)).xy;gl_Position=vec4((Td/Bd-vec2(0.5,0.5))*vec2(2.0,-2.0),0.0,1.0);}gl_Position.z=mix(Od,Pd,xd.y*0.5+0.5);l=md(Qd.xy,Cd);t=md(Qd.xy,Jd);m=md((Md !=0)? gl_Position.xy : Rd.xy,Dd);o=md((Nd !=0)? gl_Position.xy : xd.xy,Fd);n=md(xd.xy,Ed);q=md(xd.xy,Gd);s=md(xd.xy,Hd);p=md(xd.xy,Id);if(Kd==Ld){u=1.0;}else{vec2 ce=Ld-Kd;u=dot(Sd-Kd,ce)/dot(ce,ce);}}",f:"precision highp float;uniform sampler2D t_0;uniform sampler2D t_1;uniform sampler2D t_2;uniform sampler2D t_3;uniform sampler2D t_4;uniform sampler2D t_5;uniform sampler2D t_6;uniform sampler2D t_7;uniform float ufrag_0;uniform float ufrag_1;uniform float ufrag_2;uniform vec4 ufrag_3;uniform vec4 ufrag_4;uniform float ufrag_6;uniform vec3 ufrag_8;uniform vec3 ufrag_9;uniform int ufrag_10;uniform int ufrag_11;uniform vec2 ufrag_12;uniform vec4 ufrag_13;uniform int ufrag_14;uniform int ufrag_15;uniform int ufrag_16;uniform vec2 ufrag_17;uniform int ufrag_18;uniform int ufrag_19;uniform float ufrag_20;uniform float ufrag_21;uniform vec4 ufrag_22;uniform vec4 ufrag_23;uniform int ufrag_24;uniform int ufrag_25;uniform vec4 ufrag_26;uniform float ufrag_27;uniform float ufrag_28;uniform float ufrag_29;uniform int ufrag_30;uniform int ufrag_31;uniform float ufrag_32;uniform int ufrag_34;uniform int ufrag_35;uniform float ufrag_36;uniform int ufrag_37;uniform int ufrag_38;uniform int ufrag_39;uniform float ufrag_40;uniform float ufrag_41;uniform mat3 ufrag_42;uniform vec3 ufrag_43;uniform vec4 ufrag_44;const int c=0,d=1,e=2,f=3,h=10,i=11,j=14,k=16;varying vec2 l,m,n,o,p,q,s,t;varying float u;float v(float A){return clamp(A,0.0,1.0);}const vec2 B=vec2(.5,.5);vec4 C(vec4 D,vec4 E){float F=E.a+D.a*(1.0-E.a);return vec4((E.rgb*E.a+D.rgb*D.a*(1.0-E.a))/F,F);}float G(float H,vec3 I,vec3 J){float K=clamp(H,I [ 0 ],I [ 2 ]);vec3 L=abs((K-I)*J);return min(L [ 0 ],min(L [ 1 ],L [ 2 ]));}float M(vec2 N){vec2 O=sign(B-abs(N-B));return max(0.0,O.x+O.y)*.5;}float P(float Q,float R,float S){const float T=-0.5;const float U=0.16;const float V=0.5;float W=mix(U,T,v(S*V));float X=min(S,R);float Y=1.0-v((Q-W)/X);return Y*Y;}vec2 Z(vec4 ab,float bb,float cb,float db,vec3 eb,vec3 fb,float S,float gb){bool hb=ufrag_38 !=0;float ib=max(cb,S)*0.5;float jb=ab.r-0.5;float kb=P(-jb/bb,0.5/bb,S);float lb=clamp(0.5-mix(ab.g,min(1.0-ab.r,ab.g),ufrag_29),0.0,0.5);float mb=(hb && gb==0.0)? lb : 0.5-ab.b;float H=lb*sign(mb)/bb;bool nb=fb [ 0 ]==fb [ 2 ];if(! nb && abs(H)< cb*0.5-S*2.0)H=mb/bb;H+=gb;const float ob=0.2;const float pb=1.0/(1.0-ob*2.0);const float qb=0.5-0.5*pb;float rb=ab.a;float sb=rb*pb+qb;float tb=(1.0-sb)*ib;float ub=abs(H);if(rb <(1.0-ob)&& ! hb)ub=mix(max(tb,ub),length(vec2(tb,ub)),db);const float vb=0.49;float wb=min(ib,vb/bb);float xb=P(ub-wb,0.5/bb-wb,S);if(rb < ob && ! hb){xb=0.0;}if(sb >=db && ! hb){float yb=G(H,eb*ib,fb);float zb=min(min(fb [ 0 ],fb [ 1 ]),fb [ 2 ]);float Ab=S*zb;float Bb=P(yb-wb,0.5/bb-wb,Ab);xb=min(xb,Bb);}if(ufrag_37==0)return vec2(clamp(kb,0.0,1.0),clamp(xb,0.0,1.0));else return vec2(0.0,clamp(max(kb,xb),0.0,1.0));}const int Cb=0,Db=1,Eb=2,Fb=3,Gb=4,Hb=5,Ib=6,Jb=7,Kb=8,Lb=9;vec2 Mb(int Nb,vec4 Ob,vec2 N,float bb){if(Nb==Gb)return vec2(1.0-min(min(Ob [ 0 ]*N.x,Ob [ 3 ]*N.y),min(Ob [ 2 ]*(1.0-N.x),Ob [ 1 ]*(1.0-N.y))),0.0);if(Nb==Eb){float Pb=N.x,Qb=floor(Pb),K=Pb-Qb;Pb=(fract(Qb*0.5)==0.0)? K : 1.0-K;return vec2(Pb,0.0);}else return N;}vec4 Rb(int Nb,vec4 Ob,vec4 Sb,vec2 N,sampler2D Tb,int Ub,vec4 ab,float bb){if(Nb==Cb)return vec4(0.0,0.0,0.0,0.0);else if(Nb==Db)return Ob;else if(Ub !=0 && Nb !=0 && Nb > 1 &&(N.x < 0.0 || N.x > 1.0 || N.y < 0.0 || N.y > 1.0))return vec4(0.0,0.0,0.0,0.0);vec4 Y=texture2D(Tb,Mb(Nb,Ob,N,bb));if(Nb==Jb)return mix(Ob,Sb,Y.r);else{if(Nb==Ib && Y.a > 0.0)Y.rgb/=Y.a;return Y;}}void main(){float bb=ufrag_0;float cb=ufrag_1;float Vb=ufrag_2;vec4 Wb=ufrag_3;vec4 Xb=ufrag_4;float db=ufrag_6;vec3 eb=ufrag_8;vec3 fb=ufrag_9;int Yb=ufrag_10;int Zb=ufrag_11;vec2 ac=ufrag_12;vec4 bc=ufrag_13;int cc=ufrag_15;int dc=ufrag_16;vec2 ec=ufrag_17;int fc=ufrag_18;int gc=ufrag_19;float hc=ufrag_20;float ic=ufrag_21;vec4 jc=ufrag_22;vec4 kc=ufrag_23;int lc=ufrag_24;int mc=ufrag_25;vec4 nc=ufrag_26;float gb=ufrag_27;float oc=ufrag_28;int pc=ufrag_30;int qc=ufrag_31;float rc=ufrag_32;bool sc=ufrag_34 !=0;float tc=ufrag_36;int uc=ufrag_39;float vc=ufrag_40;float wc=ufrag_41;mat3 xc=ufrag_42;vec3 yc=ufrag_43;vec4 zc=ufrag_44;vec4 Ac=sc ? vec4(0.0,0.0,0.0,0.0): texture2D(t_0,l);if(cc==e || cc==f){float Bc=M(l);float Cc=M(m);Ac*=Bc;if(tc > 0.0){vec4 Dc=texture2D(t_1,m)*Cc;Ac=mix(Ac,Dc,v(tc));}if(cc==f){vec4 Ec=texture2D(t_2,l)*Bc;vec4 Fc=texture2D(t_4,m)*Cc;vec4 Gc=mix(Ec,Fc,v(tc));vec4 Hc=vec4(0.0,0.0,0.0,0.0);if(n.x >=0.0 && n.x <=1.0 && n.y >=0.0 && n.y <=1.0){Hc=mix(texture2D(t_5,n),texture2D(t_6,n),tc);}float Ic=Gc.a > 0.0 ? Gc.r/Gc.a : 0.0;float Jc=Ac.a > 0.0 ? Ac.r/Ac.a : 0.0;float Kc=abs(Ic-Jc);Ac=mix(Ac*0.5+Gc*0.5,Hc,Kc);}gl_FragColor=Ac;if(gl_FragColor.a > 0.0){gl_FragColor.rgb/=gl_FragColor.a;}}else if(cc <=d){vec2 Lc=sc ? vec2(1.0,0.0): Z(Ac,bb,cb,db,eb,fb,Vb,gb);if(uc !=0 && ufrag_37==0){vec4 Mc=texture2D(t_7,t)*M(t);vec2 Nc=Z(Mc,bb,cb,db,eb,fb,Vb,gb);Lc=(uc==2)? vec2(v(Lc.x-Nc.x),v(Lc.y*(1.0-Nc.x)+Lc.x*Nc.y)):(uc==1)? vec2(Nc.x*Lc.x,v(Nc.y*Lc.x+Lc.y*Nc.x)): Nc;}vec4 Oc=Rb(Yb,Wb,jc,m,t_1,fc,Ac,bb);Oc.a*=hc;vec4 Pc=vec4(Oc.rgb,0.0);if(pc !=0){vec4 Qc=Rb(Ib,vec4(0.0,0.0,0.0,0.0),vec4(0.0,0.0,0.0,0.0),n,t_6,qc,Ac,bb);Qc.a*=rc;if(Qc.a > 0.0)Oc=C(Oc,Qc);Pc=vec4(Qc.rgb,Qc.a*vc*M(n));}Oc.rgb=clamp(mix(Oc.rgb,vec3(0.5)*sign(oc)+0.5,abs(oc)),0.0,1.0);if(mc !=0){float Rc=texture2D(t_5,s).a;Oc.rgb=mix(Oc.rgb,nc.rgb,(1.0-Rc)*nc.a);}vec4 Sc=mix(Pc,Oc,Lc [ 0 ]);vec4 Tc=Rb(Zb,Xb,kc,o,t_2,gc,Ac,bb);vec4 Uc=vec4(Tc.rgb,Tc.a*Lc [ 1 ]*ic);gl_FragColor=C(Sc,Uc);}else if(cc==h){float Vc=(Ac.r-0.5);float Wc=v(1.0-2.0*abs(sin(Vc*64.0)))*0.5;if(Vc < 0.0)gl_FragColor=vec4(0.0,Wc*(1.0+Vc),1.0+Vc,1.0+Vc);else gl_FragColor=vec4(1.0-Vc,Wc*(1.0-Vc),0.0,1.0);}else{if(cc==i)gl_FragColor=vec4(Ac.r,Ac.g*2.0,0.0,1.0);else if(cc==j)gl_FragColor=vec4(Ac.r,0.0,0.0,1.0);else if(cc==k)gl_FragColor=vec4(Ac.b,Ac.b > 0.95 ?(Ac.b-0.95)*20.0 : 0.0,Ac.a,1.0);else gl_FragColor=vec4(Ac.r,Ac.g,Ac.b,1.0);}float Xc=ac [ 0 ]+(ac [ 1 ]-ac [ 0 ])*v(u);if(lc !=0)Xc-=1.0-texture2D(t_4,q).a;if(dc !=0 &&(cc==0 || cc==2)){if(dc==1){Xc-=1.0-ec [ 1 ];}else{vec4 Yc=texture2D(t_3,p);if(dc==2){float Zc=1.0-Yc.r;Xc-=1.0-v(Zc*ec [ 0 ]+ec [ 1 ]);}else if(dc==3){float ad=1.0-ec [ 0 ];float bd=ec [ 1 ]/ad;if(Yc.r > 0.0){Xc-=1.0-v(6.0*bd);vec3 cd=clamp(vec3((1.0-Yc.a)*ec [ 0 ]+ec [ 1 ]*3.0)-vec3(0.0,1.0-Yc.b,2.0-Yc.b)*(1.0-ec [ 0 ]),0.0,1.0);gl_FragColor.rgb=mix(mix(vec3(Yc.r),vec3(Yc.g),cd [ 1 ]),mix(vec3(Yc.g),gl_FragColor.rgb,bd),cd [ 2 ]);}else{Xc-=1.0-v(2.0*bd-1.0);}}}}if(zc.a > 0.0){float dd=max(gl_FragColor.r,max(gl_FragColor.g,gl_FragColor.b));float ed=min(gl_FragColor.r,min(gl_FragColor.g,gl_FragColor.b));float fd=(dd+ed)*0.5;vec3 gd=fd < 0.5 ? zc.rgb*fd*2.0 : mix(zc.rgb,vec3(1.0,1.0,1.0),fd*2.0-1.0);gl_FragColor.rgb=mix(gl_FragColor.rgb,gd,zc.a);}gl_FragColor.rgb=xc*gl_FragColor.rgb+yc;gl_FragColor.a=v(gl_FragColor.a)*v(Xc)*wc;if(cc !=d && bc.a > 0.0)gl_FragColor.rgb=bc.rgb;gl_FragColor.rgb*=gl_FragColor.a;gl_FragColor.rgb=clamp(gl_FragColor.rgb,0.0,1.0);if(cc==d){if(gl_FragColor.a > 0.0)gl_FragColor=bc;else gl_FragColor=vec4(0.0,0.0,0.0,0.0);}if(ufrag_35==1){float hd=1.0-gl_FragColor.a;gl_FragColor=vec4(hd+gl_FragColor.rgb,gl_FragColor.a);}else if(gl_FragColor.a==0.0){gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}",a:["a_v","a_0","a_1"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4","ufrag_6","ufrag_8","ufrag_9","ufrag_10","ufrag_11","ufrag_12","ufrag_13","ufrag_14","ufrag_15","ufrag_16","ufrag_17","ufrag_18","ufrag_19","ufrag_20","ufrag_21","ufrag_22","ufrag_23","ufrag_24","ufrag_25","ufrag_26","ufrag_27","ufrag_28","ufrag_29","ufrag_30","ufrag_31","ufrag_32","ufrag_34","ufrag_35","ufrag_36","ufrag_37","ufrag_38","ufrag_39","ufrag_40","ufrag_41","ufrag_42","ufrag_43","ufrag_44","u_0","u_1","u_2","u_3","u_4","u_5","u_6","u_7","u_8","u_10","u_11","u_13","u_14","u_15","u_16","u_17","u_18","u_19","u_20","u_21"],s:["t_0","t_1","t_2","t_3","t_4","t_5","t_6","t_7"]},{v:"precision highp float;uniform int u_0;uniform vec2 u_1;uniform vec2 u_2;uniform mat3 u_3;attribute vec2 a_v;attribute vec4 a_p1;attribute vec4 a_p2;varying vec2 c;void main(){if(u_0==0){gl_Position=vec4(a_v,0.0,1.0);}else{vec2 s;if(a_v.x > 0.0){vec2 N=(a_v.y < 0.0)? a_p1.xy : a_p2.xy;gl_Position=vec4((((u_3*vec3(N,1.0)).xy-u_1)*u_2)*vec2(2.0,-2.0),0.0,1.0);}else gl_Position=vec4(0.0,0.0,0.0,1.0);}c=a_v*vec2(0.5,-0.5)+vec2(0.5,0.5);}",f:"precision highp float;uniform float bfrag_0 [ 11 ];uniform vec4 bfrag_1 [ 11 ];uniform int ufrag_0;uniform vec2 ufrag_2;uniform int ufrag_4;uniform vec2 ufrag_5;uniform float ufrag_6;uniform float ufrag_7;varying vec2 c;vec4 d(vec4 e,float f,float h){return vec4(pow(e.r,f),pow(e.g,f),pow(e.b,f),pow(e.a,h));}vec4 i(float j){float k=ufrag_6;float h=ufrag_7;float l=1.0/k;float m=1.0/h;for(int n=0;n < 10;n++){if(j <=bfrag_0 [ n+1 ]){vec4 o=d(bfrag_1 [ n ],k,h);vec4 p=d(bfrag_1 [ n+1 ],k,h);return d(mix(o,p,(j-bfrag_0 [ n ])/(bfrag_0 [ n+1 ]-bfrag_0 [ n ])),l,m);}}return bfrag_1 [ 10 ];}float q(vec2 s,vec2 t){vec2 u=s-t;float v=dot(u,u);float A=t.x*s.y-s.x*t.y;vec2 B=u*A;float C=sqrt(v-A*A);vec2 D=u*C;vec2 E=vec2((B.y+sign(D.y)*D.x),(-B.x+abs(D.y)))/v;vec2 F=vec2((B.y-sign(D.y)*D.x),(-B.x-abs(D.y)))/v;vec2 G=sign(length(E-t)-length(F-t))==sign(dot(t-s,t))? E : F;float j=length(s-t)/length(G-t);return clamp(j,0.0,1.0);}float H(float x){return x < 0.5 ? 2.0*x*x : 2.0*x*(2.0-x)-1.0;}float I(float x,float J){return x < J ? H(x/J): H((1.0-x)/(1.0-J));}float K(float x,float J){return x < J ? x/J :(1.0-x)/(1.0-J);}void main(){float j=c.x;if(ufrag_0==1){vec2 t=ufrag_2;j=q(c*2.0-1.0,t*2.0-1.0);}if(ufrag_4 !=0){float L=I(j,ufrag_5.x)*ufrag_5.y;float M=K(j,ufrag_5.x)*ufrag_5.y;gl_FragColor=vec4(i(L).rgb,i(M).a);}else{gl_FragColor=i(j);}}",a:["a_v","a_p1","a_p2"],u:["bfrag_0","bfrag_1","ufrag_0","ufrag_2","ufrag_4","ufrag_5","ufrag_6","ufrag_7","u_0","u_1","u_2","u_3"],s:[]},{v:"precision highp float;uniform float u_0;uniform vec2 u_1;uniform vec2 u_2;uniform vec2 u_3;uniform int u_4;attribute vec2 a_v;varying vec2 c,d,e,f,h,i,j,k,l;void main(){vec2 G=a_v;float H=u_0;vec2 I=u_1;vec2 J=u_2;vec2 K=u_3;int p=u_4;gl_Position=vec4(G.x,-G.y,0.0,1.0);vec2 L=(vec2(G.x,-G.y)*I/2.0)+vec2(0.5,0.5);if(p==1){vec2 M=J*vec2(2.0*H/(K.x*8.0),2.0*H/(K.y*8.0));vec2 N=L-J*vec2(H/K.x,H/K.y);c=N;d=N+M;e=N+M*2.0;f=N+M*3.0;h=N+M*4.0;i=N+M*5.0;j=N+M*6.0;k=N+M*7.0;l=N+M*8.0;}else{vec2 r=vec2(H/K.x,H/K.y);c=L+r*vec2(-0.7,-0.7);d=L+r*vec2(0.0,-1.0);e=L+r*vec2(0.7,-0.7);f=L+r*vec2(-1.0,0.0);h=L;i=L+r*vec2(1.0,0.0);j=L+r*vec2(-0.7,0.7);k=L+r*vec2(0.0,1.0);l=L+r*vec2(0.7,0.7);}}",f:"precision highp float;uniform sampler2D tex_0;uniform vec4 ufrag_0;uniform float ufrag_2;uniform int ufrag_3;uniform int ufrag_4;varying vec2 c,d,e,f,h,i,j,k,l;void main(){vec4 m=ufrag_0;int n=ufrag_3;float o=ufrag_2;int p=ufrag_4;vec4 q=p==1 ? vec4(1.20,1.15,1.10,1.05)*o : vec4(1.20,1.20,1.20,1.20)*o;vec4 s=texture2D(tex_0,c,q [ 0 ]);vec4 t=texture2D(tex_0,d,q [ 1 ]);vec4 u=texture2D(tex_0,e,q [ 2 ]);vec4 v=texture2D(tex_0,f,q [ 3 ]);vec4 A=texture2D(tex_0,h,o);vec4 B=texture2D(tex_0,i,q [ 3 ]);vec4 C=texture2D(tex_0,j,q [ 2 ]);vec4 D=texture2D(tex_0,k,q [ 1 ]);vec4 E=texture2D(tex_0,l,q [ 0 ]);if(n==0){vec4 F=s*0.000229+t*0.005977+u*0.060598+v*0.241732+A*0.382928+B*0.241732+C*0.060598+D*0.005977+E*0.000229;gl_FragColor=clamp(F,0.0,1.0);}else if(n==1){float F=s.a*0.000229+t.a*0.005977+u.a*0.060598+v.a*0.241732+A.a*0.382928+B.a*0.241732+C.a*0.060598+D.a*0.005977+E.a*0.000229;gl_FragColor=vec4(m.rgb,1.0)*m.a*F;}else if(n==2){float F=min(min(min(min(s.a,t.a),min(u.a,v.a)),min(min(A.a,B.a),min(C.a,D.a))),E.a);gl_FragColor=vec4(m.rgb,1.0)*m.a*F;}else if(n==3){float F=max(max(max(max(s.a,t.a),max(u.a,v.a)),max(max(A.a,B.a),max(C.a,D.a))),E.a);gl_FragColor=vec4(m.rgb,1.0)*m.a*F;}}",a:["a_v"],u:["ufrag_0","ufrag_2","ufrag_3","ufrag_4","u_0","u_1","u_2","u_3","u_4"],s:["tex_0"]},{v:"precision highp float;attribute vec2 a_v;varying vec2 c;void main(){vec2 v=a_v;gl_Position=vec4(v.x,-v.y,0.0,1.0);c=(vec2(v.x,v.y)/2.0)+vec2(0.5,0.5);}",f:"precision highp float;varying vec2 c;const int d=1,e=2,f=3,h=4,i=5,j=6,k=7,l=8,m=9,n=10,o=11,p=12;uniform int ufrag_0;uniform float ufrag_1;void main(){const float PI=3.141592653;const float q=0.707106781;int s=ufrag_0;float t=ufrag_1;float u=0.0,x=c.x,y=c.y;if(s==d)u=1.0-x*t;else if(s==e)u=max(abs(x*2.0-1.0),abs(y*2.0-1.0));else if(s==f)u=1.0-(x*t+floor(y*t)/2.0);else if(s==h)u=length(c*2.0-vec2(1.0,1.0))*q;else if(s==i)u=(abs(x*2.0-1.0)+abs(y*2.0-1.0))*0.5;else if(s==j)u=fract(sin(dot(c,vec2(12.9898,78.233)))*43758.5453);else if(s==k)u=min(abs(x*2.0-1.0),abs(y*2.0-1.0));else if(s==l)u=fract(sin(x*12.9898)*43758.5453);else if(s==m)u=abs(x*2.0-1.0);else if(s==n)u=1.0-(ceil(x*t)+ceil(y*t))/(2.0*t);else if(s==o)u=1.0-atan(abs(x-0.5),0.5-y)/PI;else if(s==p)u=1.0-atan(x-0.5,0.5-y)*t/(2.0*PI);gl_FragColor=vec4(mod(u,1.0),0.0,0.0,1.0);}",a:["a_v"],u:["ufrag_0","ufrag_1"],s:[]},{v:"precision highp float;attribute vec2 a_v;attribute vec4 a_0;attribute vec4 a_1;varying vec2 c;const int i=0,j=1,k=2,l=3;void main(){vec2 m=a_v;vec4 n=a_0,o=a_1;vec2 p=m*0.5+0.5;c=vec2(n [ i ]+(n [ k ]-n [ i ])*p.x,1.0-(n [ j ]+(n [ l ]-n [ j ])*p.y));gl_Position=vec4((o [ i ]+(o [ k ]-o [ i ])*p.x)*2.0-1.0,1.0-((o [ j ]+(o [ l ]-o [ j ])*p.y)*2.0),0.0,1.0);}",f:"precision highp float;uniform sampler2D t_0;uniform float ufrag_0;varying vec2 c;float d(float e){return clamp(e,0.0,1.0);}void main(){float f=ufrag_0;vec4 h=texture2D(t_0,c);h.rgb=(h.rgb-0.5)*f+0.5;gl_FragColor=h;}",a:["a_v","a_0","a_1"],u:["ufrag_0"],s:["t_0"]},{v:"precision highp float;attribute vec2 a_v;attribute vec4 a_0;attribute vec4 a_1;varying vec2 c;const int ec=0,fc=1,gc=2,hc=3;void main(){vec2 ic=a_v;vec4 jc=a_0,kc=a_1;vec2 lc=ic*0.5+0.5;c=vec2(jc [ ec ]+(jc [ gc ]-jc [ ec ])*lc.x,1.0-(jc [ fc ]+(jc [ hc ]-jc [ fc ])*lc.y));gl_Position=vec4((kc [ ec ]+(kc [ gc ]-kc [ ec ])*lc.x)*2.0-1.0,1.0-((kc [ fc ]+(kc [ hc ]-kc [ fc ])*lc.y)*2.0),0.0,1.0);}",f:"precision highp float;uniform sampler2D t_0;uniform sampler2D t_1;uniform sampler2D t_2;uniform sampler2D t_3;uniform float ufrag_0;uniform int ufrag_1;varying vec2 c;uniform int ufrag_3;uniform vec2 ufrag_4;uniform vec4 ufrag_5;uniform int ufrag_6;uniform float ufrag_7;uniform float ufrag_8;uniform float ufrag_9;uniform int ufrag_10;uniform float ufrag_11;uniform float ufrag_12;uniform vec3 ufrag_13;uniform vec3 ufrag_14;uniform int ufrag_15;uniform float ufrag_16;uniform float ufrag_17;uniform float ufrag_18;uniform vec4 ufrag_19;uniform int ufrag_20;uniform float ufrag_21;uniform vec2 ufrag_22;uniform vec4 ufrag_23;uniform int ufrag_24;uniform int ufrag_25;uniform vec4 ufrag_26;uniform vec4 ufrag_27;uniform vec4 ufrag_28;const int d=0;const int e=1;const int f=2;const int h=3;const int i=4;float j(float k){return clamp(k,0.0,1.0);}vec3 l(vec3 rgb){float m=max(rgb.r,max(rgb.g,rgb.b));float n=min(rgb.r,min(rgb.g,rgb.b));float o=(m+n)*0.5;if(m==n)return vec3(0.0,0.0,o);float p=(m-n)*2.0;float q=m+n;float s=0.5*p/((o <=0.5)? q : 2.0-q);float t=(rgb.r==m)?((rgb.g-rgb.b)/p)/3.0 :(rgb.g==m)?(1.0+(rgb.b-rgb.r)/p)/3.0 :(2.0+(rgb.r-rgb.g)/p)/3.0;return vec3(fract(t),s,o);}float u(float v,float A,float B){float C=fract(B);return(C*6.0 < 1.0)? v+(A-v)*C*6.0 :(C*2.0 < 1.0)? A :(C*3.0 < 2.0)? v+(A-v)*(4.0-C*6.0): v;}vec3 D(vec3 E){float A=(E.z <=0.5)? E.z+E.z*E.y : E.z+E.y-E.z*E.y;float v=2.0*E.z-A;return vec3(u(v,A,E.x+1.0/3.0),u(v,A,E.x),u(v,A,E.x-1.0/3.0));}const vec3 F=vec3(2.2,2.2,2.2);const vec3 G=vec3(1.0/2.2,1.0/2.2,1.0/2.2);const vec2 H=vec2(.5,.5);vec4 I(vec4 J,vec3 K){return vec4(pow(J.rgb,K),J.a);}vec4 L(vec4 M){const int N=7;const int O=(N-1)/2;float P [ N ];float Q=ufrag_21 < 0.0 ?-1.0*ufrag_21*5.0 : 5.0;float R=1.0/Q;float S=R*R;float T=0.0;for(int U=0;U < O;U++){float V=float(U);float W=0.39894*R*exp(-0.5*V*V*S);P [ O+U ]=W;P [ O-U ]=W;T+=2.0*W;}T-=P [ O ];vec4 X=vec4(0.0);for(int U=-O;U <=O;U++){for(int Y=-O;Y <=O;Y++){vec4 Z=texture2D(t_0,c+3.0*vec2(float(U),float(Y))/ufrag_22);X+=P [ O+Y ]*P [ O+U ]*Z;}}X/=T*T;if(ufrag_21 < 0.0){return X;}else{vec4 ab=M-X;vec4 bb=M+ab*ufrag_21*4.0;return clamp(bb,0.0,1.0);}}vec3 cb(vec3 rgb,vec4 q){return clamp(q [ 0 ]*rgb*rgb*rgb+q [ 1 ]*rgb*rgb+q [ 2 ]*rgb+q [ 3 ],0.0,1.0);}vec2 db(float eb,vec3 fb,float gb,vec2 hb){float ib=floor(eb/gb);float jb=eb-ib*gb;return vec2(jb,ib)*fb.rg+hb;}vec3 kb(vec3 J,vec3 fb,float gb){vec2 lb=fb.rg*vec2(gb,ceil(fb.b/gb));vec3 mb=clamp(J,0.0,1.0)*(fb-vec3(1.0));vec2 hb=mb.rg+vec2(0.5);float nb=floor(mb.b);float ob=min(nb+1.0,fb.b-1.0);vec3 a=texture2D(t_2,db(nb,fb,gb,hb)/lb).rgb;vec3 b=texture2D(t_2,db(ob,fb,gb,hb)/lb).rgb;return mix(a,b,mb.b-nb);}const int pb=8;const int qb=16;const float rb=float(qb)*sqrt(3.0);vec3 sb(int U){return texture2D(t_3,vec2(float(U)/255.0,0.0)).rgb;}vec4 tb(vec3 ub,int vb [ pb ]){float wb=rb;int xb=0;vec3 yb=vec3(0.0);for(int U=0;U < pb;U++){int zb=vb [ U ];vec3 J=sb(zb);float V=length(J-ub);if(V < wb){xb=zb;yb=J;wb=V;}}return vec4(yb,float(xb));}int Ab(vec3 M,int vb [ pb ]){vec3 ub=M;int xb=0;float Bb=fract(sin(dot(c,vec2(12.9898,78.233)))*43758.5453);int Cb=int(Bb*float(qb-1));for(int Db=0;Db < qb;Db++){vec4 Eb=tb(ub,vb);vec3 yb=Eb.rgb;xb=int(Eb.a);if(Db==Cb){return xb;}ub=((ub+(ub-yb))+M)*0.5;}return xb;}int Fb(vec3 M){int vb [ pb ];float Gb [ pb ];for(int zb=0;zb < pb;zb++){vb [ zb ]=zb;Gb [ zb ]=length(sb(zb)-M);}for(int zb=pb;zb < 256;zb++){int Hb=0;float Ib=0.0;for(int Jb=0;Jb < pb;Jb++){float Kb=Gb [ Jb ];if(Kb > Ib){Hb=Jb;Ib=Kb;}}vec3 J=sb(zb);float V=length(J-M);if(V < Ib){for(int Jb=0;Jb < pb;Jb++){if(Jb==Hb){vb [ Jb ]=zb;Gb [ Jb ]=V;}}}}return Ab(M,vb);}vec3 Lb(vec3 M){vec4 Mb=ufrag_26;vec4 Nb=ufrag_27;vec4 Ob=ufrag_28;float Pb=j(dot(M,vec3(0.2126,0.7152,0.0722)));vec4 Qb=Mb+Nb*j(Pb*3.0-1.5)-Ob*j(Pb*-3.0+1.5);return mix(vec3(Pb),M*Qb.rgb,Qb.a);}vec4 Rb(vec4 M){if(ufrag_3+ufrag_6+ufrag_10+ufrag_15+ufrag_20+ufrag_25==0 &&(ufrag_23.x <=1.0)){return M;}vec4 Sb=vec4(M);if(ufrag_20==1){Sb=L(Sb);}Sb.rgb=Sb.a==0.0 ? vec3(0.0,0.0,0.0): Sb.rgb/Sb.a;if(ufrag_15==1){Sb.r*=ufrag_16;Sb.b*=ufrag_17;Sb.g*=ufrag_18;}if(ufrag_6==1){vec3 E=l(Sb.rgb);E=vec3(fract(E.x+ufrag_7),E.yz*vec2(ufrag_8,ufrag_9));Sb.rgb=clamp(D(E),0.0,1.0);}if(ufrag_3==1){Sb.rgb=ufrag_4 [ 0 ]*Sb.rgb+ufrag_4 [ 1 ];if(ufrag_5 [ 0 ] < 0.0){Sb.rgb=clamp(Sb.rgb,0.0,1.0);}Sb.rgb=cb(Sb.rgb,ufrag_5);}if(ufrag_25==1){Sb.rgb=Lb(Sb.rgb);}if(ufrag_10==1){const vec3 Tb=vec3(0.2125,0.7154,0.0721);float Ub=clamp(dot(Sb.rgb,Tb)*ufrag_11+ufrag_12,0.0,1.0);Sb.rgb=mix(ufrag_13,ufrag_14,Ub);}if(ufrag_23.x > 1.0){Sb.rgb=kb(Sb.rgb,ufrag_23.xyz,ufrag_23.w);}Sb.rgb*=Sb.a;return Sb;}void main(){float Vb=ufrag_0;int Wb=ufrag_1;vec4 Xb=ufrag_19;vec4 Yb=texture2D(t_0,c);Yb.rgb=(Yb.rgb-0.5)*Vb+0.5;Yb.rgb=(Wb==f)? vec3(Yb.b,Yb.g,Yb.r): Yb.rgb;if(Wb==h || Wb==i){vec4 Zb=texture2D(t_1,c);if(Wb==h){vec4 ac=Zb;vec3 bc=vec3(Yb.r,ac.r,ac.a)*255.0-vec3(16.0,128.0,128.0);vec3 rgb=bc*mat3(1.164383,0.0,1.596027,1.164383,-0.391762,-0.812968,1.164383,2.017232,0.0);Yb.rgb=clamp(rgb/255.0,0.0,1.0);}else if(Wb==i){Yb*=Zb.r;}}else if(Wb==e){Yb=Rb(Yb);}if(Xb.a !=0.0){float cc=Xb.a*Yb.a;Yb=vec4(Xb.rgb*cc,cc);}if(ufrag_24==1){int dc=Fb(Yb.rgb);Yb=vec4(sb(dc),1.0);}gl_FragColor=Yb;}",a:["a_v","a_0","a_1"],u:["ufrag_0","ufrag_1","ufrag_3","ufrag_4","ufrag_5","ufrag_6","ufrag_7","ufrag_8","ufrag_9","ufrag_10","ufrag_11","ufrag_12","ufrag_13","ufrag_14","ufrag_15","ufrag_16","ufrag_17","ufrag_18","ufrag_19","ufrag_20","ufrag_21","ufrag_22","ufrag_23","ufrag_24","ufrag_25","ufrag_26","ufrag_27","ufrag_28"],s:["t_0","t_1","t_2","t_3"]},{v:"precision highp float;uniform mat3 u_0;uniform mat3 u_1;uniform mat3 u_2;uniform mat3 u_3;uniform vec2 u_4;attribute vec2 a_v;varying vec2 c;varying vec2 d;vec2 Kb(vec2 Lb,mat3 Mb){return(Mb*vec3(vec2(Lb.x/2.0,Lb.y/2.0),1.0)).xy*vec2(1.0,-1.0)+vec2(0.5,0.5);}void main(){vec2 Nb=a_v;mat3 Ob=u_0;mat3 Pb=u_1;mat3 Qb=u_2;mat3 Rb=u_3;vec2 Sb=u_4;c=Kb(Nb.xy,Qb);d=Kb(Nb.xy,Rb);vec2 Tb=(Ob*vec3(Nb.xy/2.0,1.0)).xy;vec2 Ub=(Pb*vec3(Tb,1.0)).xy;gl_Position=vec4((Ub/Sb-vec2(0.5,0.5))*vec2(2.0,-2.0),0.0,1.0);}",f:"precision highp float;uniform sampler2D t_0;uniform sampler2D t_1;uniform sampler2D t_2;varying vec2 c;varying vec2 d;uniform int ufrag_0;uniform vec2 ufrag_1;uniform float ufrag_2;uniform float ufrag_3;uniform vec2 ufrag_4;uniform vec4 ufrag_5;uniform vec4 ufrag_6 [ 4 ];uniform vec3 ufrag_7 [ 4 ];uniform vec4 ufrag_8 [ 4 ];uniform vec4 ufrag_9;uniform vec4 ufrag_10;uniform vec4 ufrag_11;uniform vec4 ufrag_12;uniform vec4 ufrag_13;uniform int ufrag_14;uniform float ufrag_15;uniform vec4 ufrag_16;uniform float ufrag_17;const int e=0;const int f=1;const int h=2;float i(vec2 j,float k,float l){vec2 m=ufrag_1;float n=ufrag_2;float o=ufrag_3;vec2 p=ufrag_4;float q=texture2D(t_1,j+m*vec2(k,l)).r;float s=clamp((q*n+o)/p.x,0.0,1.0);return texture2D(t_2,vec2(s,1.0)).r*p.y;}vec3 t(vec2 j){float u=i(j,-1.0,-1.0);float v=i(j,0.0,-1.0);float A=i(j,1.0,-1.0);float B=i(j,-1.0,0.0);float C=i(j,0.0,0.0);float D=i(j,1.0,0.0);float E=i(j,-1.0,1.0);float F=i(j,0.0,1.0);float G=i(j,1.0,1.0);vec3 H=normalize(vec3(1.0,0.0,v-u));vec3 I=normalize(vec3(1.0,0.0,A-v));vec3 J=normalize(vec3(1.0,0.0,C-B));vec3 K=normalize(vec3(1.0,0.0,D-C));vec3 L=normalize(vec3(1.0,0.0,F-E));vec3 M=normalize(vec3(1.0,0.0,G-F));vec3 N=normalize(vec3(0.0,1.0,B-u));vec3 O=normalize(vec3(0.0,1.0,C-v));vec3 P=normalize(vec3(0.0,1.0,D-A));vec3 Q=normalize(vec3(0.0,1.0,E-B));vec3 R=normalize(vec3(0.0,1.0,F-C));vec3 S=normalize(vec3(0.0,1.0,G-D));return normalize(cross(H,N)+cross(H,O)+cross(I,O)+cross(I,P)+cross(J,N)+cross(J,O)+cross(K,O)+cross(K,P)+cross(J,Q)+cross(J,R)+cross(K,R)+cross(K,S)+cross(L,Q)+cross(L,R)+cross(M,R)+cross(M,S));}vec4 T(vec4 U,vec4 V){float W=V.a+U.a*(1.0-V.a);return vec4((V.rgb*V.a+U.rgb*U.a*(1.0-V.a))/W,W);}void main(){int X=ufrag_0;vec4 Y=texture2D(t_0,c);if(X !=0){vec4 Z=vec4(Y.rgb/Y.a,Y.a);int ab=ufrag_14;if(ab==f){Z=vec4(0.0,0.0,0.0,0.0);}else{vec3 bb=t(d);vec4 cb=ufrag_5;vec4 db=ufrag_9;vec4 eb=ufrag_10;vec4 fb=ufrag_11;vec4 gb=ufrag_12;vec4 hb=ufrag_13;vec3 ib=gb.rgb+cb.rgb*fb.rgb;vec3 jb=vec3(0.0,0.0,-1.0);float kb=hb.x;bool lb=hb.y !=0.0;;vec3 mb=vec3(0.0,0.0,0.0);vec3 nb=vec3(0.0,0.0,0.0);for(int ob=0;ob < 4;ob++){vec3 pb=ufrag_6 [ ob ].rgb;vec3 qb=ufrag_7 [ ob ];float rb=ufrag_8 [ ob ].x;float sb=ufrag_8 [ ob ].y;float tb=ufrag_8 [ ob ].z;float ub=ufrag_8 [ ob ].w;float vb=-dot(bb,qb);vb=vb*rb+sb;mb+=clamp(vb,0.0,1.0)*tb*pb;float wb=0.0;if(lb){vec3 xb=-normalize(jb+qb);wb=dot(xb,bb);}else{vec3 yb=jb-2.0*bb*dot(bb,jb);wb=-dot(yb,qb);}wb=pow(max(0.0,wb),kb);nb+=clamp(wb,0.0,1.0)*ub*pb;}mb*=db.rgb;nb*=eb.rgb;float zb=Z.a*db.a;float Ab=hb.z;float Bb=hb.w;float Cb=1.0-abs(dot(jb,bb));if(Bb > 0.0){zb+=(1.0-zb)*pow(Cb,Bb);}else if(Bb < 0.0){zb-=zb*pow(Cb,-Bb);}if(Ab > 0.0){mb+=(vec3(1.0,1.0,1.0)-mb)*pow(Cb,Ab);}else if(Ab < 0.0){mb-=mb*pow(Cb,-Ab);}if(ab==h){const float Db=0.5;mb+=nb*Db;nb*=(1.0-Db);}Z.rgb=clamp(Z.rgb*(ib+mb)+nb,0.0,1.0);Z.a=clamp(zb,0.0,1.0);}float Eb=ufrag_15;if(Eb > 0.0){float n=ufrag_2;float o=ufrag_3;vec4 Fb=ufrag_16;float Gb=ufrag_17;float Hb=max(Eb,Gb)*0.5;float Ib=abs(texture2D(t_1,d).r*n+o);float Jb=clamp(Hb-Ib,0.0,1.0);Z=T(Z,Fb*vec4(1.0,1.0,1.0,Jb));}Y=vec4(Z.rgb*Z.a,Z.a);}gl_FragColor=Y;}",a:["a_v"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4","ufrag_5","ufrag_6","ufrag_7","ufrag_8","ufrag_9","ufrag_10","ufrag_11","ufrag_12","ufrag_13","ufrag_14","ufrag_15","ufrag_16","ufrag_17","u_0","u_1","u_2","u_3","u_4"],s:["t_0","t_1","t_2"]},{v:"precision highp float;attribute vec2 a_v;attribute vec4 a_0;attribute vec4 a_1;varying vec2 c;uniform mat3 u_1;const int rb=0,sb=1,tb=2,ub=3;void main(){vec2 vb=a_v;vec4 wb=a_0,xb=a_1;vec2 yb=vb*0.5+0.5;c=vec2(wb [ rb ]+(wb [ tb ]-wb [ rb ])*yb.x,1.0-(wb [ sb ]+(wb [ ub ]-wb [ sb ])*yb.y));c=(u_1*vec3(c.x,c.y,1.0)).xy;gl_Position=vec4((xb [ rb ]+(xb [ tb ]-xb [ rb ])*yb.x)*2.0-1.0,1.0-((xb [ sb ]+(xb [ ub ]-xb [ sb ])*yb.y)*2.0),0.0,1.0);}",f:"precision highp float;uniform sampler2D t_0;uniform float ufrag_0;uniform int ufrag_1;uniform float ufrag_2;uniform vec2 ufrag_3;uniform int ufrag_4;uniform int ufrag_5;uniform vec2 ufrag_22;varying vec2 c;const float PI=3.141592653;float d(float e){return clamp(e,0.0,1.0);}vec3 f(vec3 rgb){float h=max(rgb.r,max(rgb.g,rgb.b));float i=min(rgb.r,min(rgb.g,rgb.b));float j=(h+i)*0.5;if(h==i)return vec3(0.0,0.0,j);float k=(h-i)*2.0;float l=h+i;float m=0.5*k/((j <=0.5)? l : 2.0-l);float n=(rgb.r==h)?((rgb.g-rgb.b)/k)/3.0 :(rgb.g==h)?(1.0+(rgb.b-rgb.r)/k)/3.0 :(2.0+(rgb.r-rgb.g)/k)/3.0;return vec3(fract(n),m,j);}float o(float x){return fract(sin(x*12.9898)*43758.5453);}float p(vec2 q){float s=ufrag_2;const float t=1.0;const float u=0.7;vec2 v=vec2(q.x,(1.0-q.y-(1.0-cos(q.x*PI/4.0))*t)*(1.0+t*0.5));float A=(v.x+v.y)*0.5;float B=d(((v.x-v.y)*0.5)/(1.0-abs(A-0.5)*2.0)*u+0.5);float C=floor(A*s);return d(1.0-1.0*(fract(C/2.0)==0.0 ?(C+B)/s :(C+1.0-B)/s));}float D(vec2 q,bool E){float s=ufrag_2;float F=p(q);float G=1.0-floor(q.x*s)/s;return mix(E ? o(G): G,F,E ? 0.3 : 0.1);}float H(vec2 q,vec2 I){float J=ufrag_2;float K=1.0-atan(q.x-I.x,q.y-I.y);float L=1.0+J*(sin(K*3.0)*0.1+sin(K*7.0)*0.05+sin(K*11.0)*0.03);return max(0.0,1.0-length(q-I)*L);}float M(vec2 q,vec2 I){bool N=ufrag_5 !=0;float O=N ? ufrag_22.y/ufrag_22.x : ufrag_22.x/ufrag_22.y;float s=ufrag_2;vec2 e=q-I;e*=O > 1.0 ? vec2(O,1.0): vec2(1.0,1.0/O);float P=length(e)*sqrt(2.0);if(P < 0.01/s){return 1.0;}float K=0.5+atan(e.y,e.x)/(2.0*PI);return(floor((1.0-P)*s-K)+K)/s;}void main(){const int Q=2;const float R=float((Q*2+1)*(Q*2+1));const float S=1.0;const float T=3.0;const float U=1.0;const float V=1.0;const vec3 W=vec3(0.0,0.0,-1.0);const float s=15.0;const vec2 X=vec2(1.0,1.0);bool N=ufrag_5 !=0;bool Y=c.x < 0.0 || c.y < 0.0 || c.x > 1.0 || c.y > 1.0;vec4 Z=texture2D(t_0,c);float ab=0.0;float bb=0.0;float cb=0.0;for(int db=-Q;db <=Q;db++){for(int eb=-Q;eb <=Q;eb++){vec2 fb=c+vec2(float(eb),float(db))*S/ufrag_22;vec4 gb=texture2D(t_0,fb);ab+=abs(Z.r-gb.r)+abs(Z.g-gb.g)+abs(Z.b-gb.b);vec2 hb=ufrag_3.xy;vec2 ib=N ? vec2(1.0-fb.y,1.0-fb.x): fb;ib=vec2(hb.x > 0.0 ? ib.x : 1.0-ib.x,hb.y > 0.0 ? ib.y : 1.0-ib.y);float jb=0.5;if(ufrag_1==1){jb=p(ib);}else if(ufrag_1==2){jb=H(ib,vec2(0.0,0.0));}else if(ufrag_1==3){jb=H(ib,vec2(0.5,0.5));}else if(ufrag_1==4){jb=D(ib,false);}else if(ufrag_1==5){jb=D(ib,true);}else if(ufrag_1==6){jb=M(ib,vec2(0.5,0.5));}bb+=jb;if(ufrag_4==0){cb+=0.5;}else{vec3 kb=f(Z.rgb);if(ufrag_4==1){cb+=1.0-smoothstep(0.4,0.6,kb [ 2 ]);}if(ufrag_4==2){cb+=smoothstep(0.4,0.6,kb [ 2 ]);}}}}ab=U*T*ab/R;bb=V*bb/R;cb=cb/R;vec3 lb=f(Z.rgb);vec3 mb=vec3(W.x < 0.0 ? 1.0 : 0.0,W.y < 0.0 ? 1.0 : 0.0,W.z < 0.0 ? 1.0 : 0.0)+f(Z.rgb)*W;float L=d((ab+bb+mb.x+mb.y+mb.z)/(U+V+abs(W.x)+abs(W.y)+abs(W.z)));float nb=fract(sin(dot(c,vec2(12.9898,78.233)))*43758.5453);float ob=1.0-nb*0.2;float pb=d(min(d((ab-0.5)*1.5+0.5)*nb,0.5));float qb=d(min((ab-0.75)*4.0+0.5,0.5));if(Y){gl_FragColor=vec4(0.0,ob,0.0,bb);}else{gl_FragColor=vec4(ob,ob-pb-qb,cb,bb);}}",a:["a_v","a_0","a_1"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4","ufrag_5","ufrag_22","u_1"],s:["t_0"]},{v:"precision highp float;attribute vec2 a_v;attribute vec4 a_0;attribute vec4 a_1;varying vec2 d;const int u=0,v=1,A=2,B=3;void main(){vec2 C=a_v;vec4 D=a_0,E=a_1;vec2 F=C*0.5+0.5;d=vec2(D [ u ]+(D [ A ]-D [ u ])*F.x,1.0-(D [ v ]+(D [ B ]-D [ v ])*F.y));gl_Position=vec4((E [ u ]+(E [ A ]-E [ u ])*F.x)*2.0-1.0,1.0-((E [ v ]+(E [ B ]-E [ v ])*F.y)*2.0),0.0,1.0);}",f:"precision highp float;uniform sampler2D t_0;uniform sampler2D t_1;uniform float ufrag_0;uniform float ufrag_1;uniform float ufrag_2;uniform int ufrag_3;uniform bool ufrag_4;const int c=22;varying vec2 d;void main(){vec2 e=ufrag_3==0 ? vec2(1.0/512.0,0.0): vec2(0.0,1.0/512.0);e*=ufrag_1;if(ufrag_2 > 1.0 && ufrag_3==0){e/=ufrag_2;}else if(ufrag_2 < 1.0 && ufrag_3==1){e*=ufrag_2;}float f=1.0/ufrag_0;float h=f*f;float i=-0.5*h;float j=0.39894*f;float k=j;vec4 l=k*texture2D(t_0,d);float m=0.0;m+=k;for(int n=1;n < c;n++){float o=float(n);float p=j*exp(o*o*i);l+=p*texture2D(t_0,d+(o*e));l+=p*texture2D(t_0,d+(-o*e));m+=2.0*p;}vec4 q=l/m;if(ufrag_4){vec4 s=texture2D(t_1,d);vec4 t=s-q;q=s+t*ufrag_0*9.0;q=clamp(q,0.0,1.0);}gl_FragColor=q;}",a:["a_v","a_0","a_1"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4"],s:["t_0","t_1"]}],Kr={x:0,y:0,width:1,height:1},Zr=[{attributeName:"",index:0,attributeSize:2,offset:0,divisor:0}];class Jr{constructor(e,t,i,r){this.m_shaderPrograms=new Array(10),this.m_isInitializeReady=!0,this.m_isInScope=!1,this.m_stateRestorer=r,this.m_wipeStateBetweenScopes=t,this.m_disableParallelShaderCompile=i,this.setWebGLContextOrBabylonEngine(e)}getBabylonEngine(){return this.m_engine}get quadMesh(){return this.m_quadMesh}get emptyTexture(){return this.m_emptyTexture}get whiteTexture(){return this.m_whiteTexture}needPowerOf2TexturesForTilingOrMipMap(){return this.m_needPowerOf2TexturesForTilingOrMipMap}isCurrentWebGLContext(e){return this.m_gl==e}isValid(){return this.m_gl&&!this.m_gl.isContextLost()}setWebGLContextOrBabylonEngine(e){const t=e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext?e:e._gl;if(this.m_gl!=t){this.m_engine&&(this.m_emptyTexture&&this.m_engine._releaseTexture(this.m_emptyTexture),this.m_whiteTexture&&this.m_engine._releaseTexture(this.m_whiteTexture),this.m_quadMesh&&this.m_quadMesh.discard()),this.m_gl=t;const i=t.canvas.width,r=t.canvas.height;this.m_canvasRenderSize=new P(i,r),e instanceof $r?this.m_engine=e:(this.m_engine=new $r(t),this.m_engine.preventCacheWipeBetweenFrames=!0,this.m_engine.doNotHandleContextLost=!0,this.m_engine.setSize(i,r),this.m_engine.setViewport(Kr));const s=this.m_engine.getCaps();this.m_parallelShaderCompilationExtension=s.parallelShaderCompile,s.parallelShaderCompile=void 0,this.m_renderToFilteredFloat=s.textureFloatRender&&s.textureFloatLinearFiltering,this.m_renderToFilteredHalfFloat=s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering,this.m_needPowerOf2TexturesForTilingOrMipMap=this.m_engine.needPOTTextures,this.m_uniqueGraphicsProcessorId=Xr,Xr++;for(let e=0;e<10;e++)this.m_shaderPrograms[e]=void 0}}updateViewportSize(){const e=this.m_gl.canvas.width,t=this.m_gl.canvas.height;this.m_canvasRenderSize=new P(e,t),this.m_engine.setSize(e,t),this.m_engine.setViewport(Kr)}onWebGLContextLost(){for(let e=0;e<10;e++)this.m_shaderPrograms[e]=void 0}initializeProgramsAsync(){return(0,kt.mG)(this,void 0,void 0,(function*(){this.m_isInitializeReady=!1;const e=this.m_engine.getCaps();this.m_disableParallelShaderCompile||(e.parallelShaderCompile=this.m_parallelShaderCompilationExtension);const t=[];if(!this.beginRenderScopeInternal(!1))throw O.Error(592328457,"Failed to enter render scope.");for(let e=0;e<10;e++){const i=this.getProgramInWebGlScope(e);t.push(i.enureDoneAsync())}this.endRenderScopeInternal(!1),yield Promise.all(t),this.m_isInitializeReady=!0}))}isInRenderScope(){return this.m_isInScope}beginRenderScope(){if(!this.m_isInitializeReady)throw O.Error(592525269,"Please, wait for onDone to be called in initialize.");return this.beginRenderScopeInternal(!0)}endRenderScope(){this.endRenderScopeInternal(!0)}beginRenderScopeInternal(e){const t=this.m_gl.isContextLost();return this.m_isInScope&&O.Error(592525270,"already in glContext scope"),t&&O.Error(592525271,"Invalnew glContext context is lostid"),!this.m_gl||t?this.m_isInScope=!1:(this.m_isInScope=!0,e&&(this.m_stateRestorer?(this.m_stateRestorer.init(this.m_gl),this.m_stateRestorer.setDefaults(),this.m_engine.wipeCaches(!0),this.m_engine.depthCullingState.cull=!1):this.m_wipeStateBetweenScopes&&(this.m_engine.wipeCaches(!0),this.m_engine.depthCullingState.cull=!1)),this.ensureVertexBufferAndMaxTapeInitialized()),this.m_isInScope}endRenderScopeInternal(e){this.m_isInScope?this.m_gl.isContextLost()?O.Error(592525273,"leaving glContext context is lost"):this.m_stateRestorer&&e&&this.m_stateRestorer.restore():O.Error(592525272,"leaving glContext not in scope"),this.m_isInScope=!1}ensureVertexBufferAndMaxTapeInitialized(){this.m_emptyTexture||(this.m_emptyTexture=this.createTextureGraphicsResource(P.One,new Uint8Array([0,0,0,0]),5,!1,!1,!1,4,!1,!1)),this.m_whiteTexture||(this.m_whiteTexture=this.createTextureGraphicsResource(P.One,new Uint8Array([1,1,1,1]),5,!1,!1,!1,4,!1,!1)),this.m_quadMesh||(this.m_quadMesh=ui.CreateGridXY(this,2,2,new R(-1,-1,1,1)))}getProgramInWebGlScope(e){let t=this.m_shaderPrograms[e];return t||(t=this.m_shaderPrograms[e]=new Qr(this,e)),t}createTextureGraphicsResourceFromExternalWebGLTexture(e,t,i,r){let s=i instanceof WebGLTexture?i:null;if(i instanceof qt&&(s=i._webGLTexture),!s)throw O.Error(592525275,"wrong texture type");const n=new qt(this.m_engine,0,!0);return n._webGLTexture=s,r&&(n._framebuffer=r),n.width=e.x,n.height=e.y,n.baseWidth=e.x,n.baseHeight=e.y,n.type=0,n.format=t,n}updateTextureGraphicsResourceFromHTMLElement(e,t,i){if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement){const r=this.m_gl,s=e._webGLTexture;s&&(r.bindTexture(r.TEXTURE_2D,s),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,i),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),r.bindTexture(r.TEXTURE_2D,null))}}updateTextureGraphicsResourceFromByteBuffer(e,t,i,r){const s=this.m_engine;if(t instanceof Uint8Array||t instanceof Float32Array){let n=t,o=this.getTypeFromData(t,i);if(!(t instanceof Uint8Array&&0==o||t instanceof Float32Array&&1==o)){O.Error(572867294,"Wrong buffer data type: needs conversion");const e=0==o?new Uint8Array(t.length):new Float32Array(t.length),i=0==o?255:1/255;for(let r=0;r<t.length;r++)e[r]=t[r]*i;n=e}s._bindTextureDirectly(3553,e,!0,!0),this.m_gl.pixelStorei(this.m_gl.UNPACK_ALIGNMENT,r),s._uploadDataToTextureDirectly(e,n,0,0,void 0,!0),this.m_gl.pixelStorei(this.m_gl.UNPACK_ALIGNMENT,4),s._bindTextureDirectly(3553,null,!0,!0)}}createTextureGraphicsResource(e,t,i,r,s,n,o,a,l,h){if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement){const r=this.m_gl;let s;if(s=r.createTexture(),s){r.bindTexture(r.TEXTURE_2D,s),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,l),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null);const n=this.createTextureGraphicsResourceFromExternalWebGLTexture(e,i,s,void 0);return n&&this.setWrapMode(n,o),n}}const c=this.m_engine;let d,u=this.getTypeFromData(t,r);const f=a?2:1;if(s)d=c.createRenderTargetTexture({width:e.x,height:e.y},{generateDepthBuffer:!1,generateStencilBuffer:n,format:i,type:u,samplingMode:f,generateMipMaps:!1});else{const s=new qt(c,Nt.Unknown);s.updateSize(e.x,e.y),s.type=u,s.format=i,s.invertY=l,c.updateTextureSamplingMode(f,s),(t instanceof Uint8Array||t instanceof Float32Array)&&this.updateTextureGraphicsResourceFromByteBuffer(s,t,r,h||4),d=s}return this.setWrapMode(d,o),d}getTypeFromData(e,t){let i=0;return t&&(e instanceof Float32Array&&this.m_renderToFilteredFloat?i=1:e||(this.m_renderToFilteredHalfFloat?i=2:this.m_renderToFilteredFloat&&(i=1))),i}setRenderTarget(e){e?(this.m_engine.bindFramebuffer(e),this.m_currentRenderTarget=e):(this.m_engine.restoreDefaultFramebuffer(),this.m_currentRenderTarget=void 0)}generateMipMap(e){this.m_engine.updateTextureSamplingMode(3,e,!0)}setWrapMode(e,t){const i=4==t?0:1==t||3==t?2:1,r=4==t?0:2==t||3==t?2:1;this.m_engine.updateTextureWrappingMode(e,i,r)}copyTexturePixelsToArray(e,t,i){const r=Math.floor(t.left),s=Math.floor(t.top),n=Math.floor(t.width),o=Math.floor(t.height);this.setRenderTarget(e);const a=this.m_engine.readPixels(r,s,n,o,i);return this.setRenderTarget(void 0),a}getCurrentViewportSize(){return this.m_currentRenderTarget?new P(this.m_currentRenderTarget.width,this.m_currentRenderTarget.height):this.m_canvasRenderSize}setScissorRect(e,t){if(t||!L(e,this.m_currentScissorRect)){const t=this.m_gl,i=this.getCurrentViewportSize();e?(t.enable(t.SCISSOR_TEST),t.scissor(e.left,i.y-e.bottom,e.width,e.height)):(t.disable(t.SCISSOR_TEST),t.scissor(0,0,i.x,i.y))}this.m_currentScissorRect=e}getUniqueGraphicsProcessorId(){return this.m_uniqueGraphicsProcessorId}isFloatTextureSupported(){return this.m_renderToFilteredFloat||this.m_renderToFilteredHalfFloat}activateShaderProgram(e){const t=this.getProgramInWebGlScope(e);return t.activate(),t}getWebGLState(){return qr(this.m_gl)}preCompileShaderAsync(e){this.beginRenderScopeInternal(!1)&&(this.getProgramInWebGlScope(e),this.endRenderScopeInternal(!1))}preLinkShaderAsync(e){this.preCompileShaderAsync(e)}tryPrepareProgramResourcesInWebGlScope(e){for(let e=0;e<2;e++)this.m_shaderPrograms[e]||this.getProgramInWebGlScope(e);return!0}}class Qr{constructor(e,t){this.graphicsProcessor=e,this.m_engine=e.getBabylonEngine(),this.programId=t,this.m_effect=this.createEffect()}getBabylonEngine(){return this.m_engine}getBabylonEffect(){return this.m_effect}done(){return void 0!==this.effectErrors||this.m_effect.isReady()}enureDoneAsync(){return new Promise(((e,t)=>{this.done()?e(void 0):(this.m_effect.onCompileObservable.add((()=>e(void 0))),this.m_effect.onErrorObservable.add(t))}))}createEffect(){return O.Message(592525280,"Compiling shader "+this.programId),new kr({vertexSource:Yr[this.programId].v,fragmentSource:Yr[this.programId].f,spectorName:this.programId},Yr[this.programId].a,Yr[this.programId].u,Yr[this.programId].s,this.m_engine,void 0,void 0,void 0,((e,t)=>{this.effectErrors=t}))}activate(){this.handleActivationErrors(),this.m_engine.enableEffect(this.m_effect),this.m_currentMesh=void 0,this.bindMesh(void 0)}bindMesh(e){const t=e||this.graphicsProcessor.quadMesh;t&&t.isValid(this.graphicsProcessor)?this.m_currentMesh!=t&&(t.vertexBuffer&&t.indexBuffer&&t.isValid(this.graphicsProcessor)&&(this.m_engine._bindIndexBufferWithCache(t.indexBuffer),Zr[0].index=this.m_effect.getAttributeLocationByName("a_v"),this.m_engine.bindInstancesBuffer(t.vertexBuffer,Zr,!1)),this.m_currentMesh=t):O.Error(592525281,"Invalid Mesh")}handleActivationErrors(){if(!this.effectErrors&&this.m_effect.isReady())return;const e="Program "+this.programId+" ";if(this.effectErrors){const t=this.m_effect.getPipelineContext();if(t.vertexCompilationError)throw O.Error(592525282,e+"V compile failed: "+t.vertexCompilationError);if(t.fragmentCompilationError)throw O.Error(592525283,e+"V compile failed: "+t.fragmentCompilationError);if(t.programLinkError)throw O.Error(592525312,e+"link failed: "+t.programLinkError);if(t.programValidationError)throw O.Error(592525313,e+"validation failed: "+t.programValidationError);throw O.Error(592525314,e+"preparation failed:"+this.effectErrors)}if(!this.m_effect.isReady())throw O.Error(592525315,e+"Effect not ready yet.")}setTexture(e,t){const i=t||this.graphicsProcessor.emptyTexture;this.m_effect._bindTexture(e,i||null)}clearAndEnbaleDepthBuffer(){this.m_engine.depthCullingState.depthFunc=513,this.m_engine.depthCullingState.depthMask=!0,this.m_engine.depthCullingState.depthTest=!0,this.m_engine.clear(null,!1,!0,!1)}setDistanceFieldStencilSumIncrement(e){const t=e?34055:34056,i=this.m_engine;i.stencilState.stencilOpStencilFail=t,i.stencilState.stencilOpDepthFail=t,i.stencilState.stencilOpStencilDepthPass=t}setBlendingMode(e){const t=this.m_engine;t.alphaState.alphaBlend=!0,0==e?(t.alphaState.setAlphaBlendFunctionParameters(1,771,1,771),t.alphaState.setAlphaEquationParameters(32774,32774)):1==e?(t.alphaState.setAlphaBlendFunctionParameters(1,1,0,1),t.alphaState.setAlphaEquationParameters(32775,32774)):2==e?(t.alphaState.setAlphaBlendFunctionParameters(775,769,0,1),t.alphaState.setAlphaEquationParameters(32774,32774)):3==e?(t.alphaState.setAlphaBlendFunctionParameters(1,1,1,1),t.alphaState.setAlphaEquationParameters(32779,32779)):4==e?(t.alphaState.setAlphaBlendFunctionParameters(1,1,1,1),t.alphaState.setAlphaEquationParameters(32774,32774)):5==e?(t.alphaState.setAlphaBlendFunctionParameters(774,0,0,1),t.alphaState.setAlphaEquationParameters(32774,32774)):O.Error(592525318,"Wrong blending mode")}begin(e,t,i){const r=this.m_engine;this.graphicsProcessor.setRenderTarget(e),this.m_engine.setViewport(Kr),t&&r.clear(t,!0,!1,!1),i?this.setBlendingMode(0):r.alphaState.alphaBlend=!1,r.depthCullingState.depthTest=!1,r.depthCullingState.depthMask=!0,r.stencilState.stencilTest=!1,r.stencilState.stencilMask=255,r.setColorWrite(!0)}end(){this.graphicsProcessor.setRenderTarget(void 0),this.m_engine.unbindInstanceAttributes(),this.m_engine.setViewport(Kr)}drawQuads(e){this.bindMesh(void 0),this.m_engine.drawElementsType(0,0,6*e)}drawQuadInstances(e){this.bindMesh(void 0),this.m_engine.drawElementsType(0,0,6,e)}drawMesh(e){this.bindMesh(e),this.m_engine.drawElementsType(0,0,3*e.triangleCount)}setDummyPointerAttribute(e){if(this.graphicsProcessor.quadMesh&&this.graphicsProcessor.quadMesh.vertexBuffer){const t=this.graphicsProcessor.quadMesh.vertexBuffer,i=this.m_engine,r=[{attributeName:e,attributeSize:1,offset:0,divisor:0,index:this.m_effect.getAttributeLocationByName(e)}];i.bindInstancesBuffer(t,r,!1)}else O.Error(592525319,"Quad not initialized")}disableInstanceAttribute(e){this.m_engine.disableInstanceAttributeByName(e)}}const es={itemHit:void 0,itemStack:void 0,textHit:void 0};let ts=0;class is{constructor(e){this.cache=new ur,this.isGroup=e}releaseGeneratedResources(){this.cache.releaseGeneratedResources()}onFinalization(){false}}class rs{constructor(){this.index=0}get color(){const e=this.index%256,t=(this.index-e)/256%256,i=(this.index-e-256*t)/65536%256;return new _e(e/255,t/255,i/255,1)}next(){this.index++}}class ss{constructor(e,t,i,r){var s,n;this.scene3D=null!==(s=null==e?void 0:e.scene3D)&&void 0!==s?s:t.scene3D;const o=null!==(n=null==e?void 0:e.fade)&&void 0!==n?n:t.fade;if(o){if(this.fade=o.clone(),o.isDistributedByLength&&(null==e?void 0:e.drawDistribution)&&r+1<e.drawDistribution.length){const t=e.drawDistribution[r],i=e.drawDistribution[r+1];this.fade.progress=(o.progress-t)/(i-t)}else o.isDistributedByLength&&e&&O.Error(592525086,"Unable to distribute by length"),this.fade.progress=o.progress;if(2==t.getType()&&o.isDistributedByLength){if(!i.cache.drawDistribution){let e=0;const r=t=>{for(const i of t.paths||[])e+=i.measureLength(E.FromTransforms(i.transform,t.transform));return!0};Tt(t,r);const s=e;let n=0;const o=t;i.cache.drawDistribution=[];for(let t=0;t<o.items.length;t++)i.cache.drawDistribution.push(n/s),e=0,Tt(o.items.getAt(t),r),n+=e;i.cache.drawDistribution.push(1)}this.drawDistribution=i.cache.drawDistribution}}}}let ns=1;class os{constructor(e){this.m_babylonWipeStateBetweenScopes=!0,this.m_babylonDisableParallelShaderCompile=!1,this.m_currentFramePerformanceSummary=new Ot,this.m_textureManager=new Jt,this.m_glyphCachePreviouslyFailed=!1,this.m_verboseRenderLogging=!1,this.fixedMemoryLeakAmounts=new Vt,this.m_babylonWipeStateBetweenScopes=!!e.stateRestorer,this.m_babylonDisableParallelShaderCompile=1==e.babylonDisableParallelShaderCompile,this.m_stateRestorer=e.stateRestorer,this.m_morphPlayer=e.morphPlayer,this.m_debugStringProvider=e.debugStringProvider,this.m_perfSummary=new Ut,this.m_rendererId="🦆"+ns++}getTextureManager(){return this.m_textureManager}hasMorphPlayer(){return!!this.m_morphPlayer}setMorphPlayer(e){this.m_morphPlayer=e}hasDebugStringProvider(){return!!this.m_debugStringProvider}setDebugStringProvider(e){this.m_debugStringProvider=e}initializeAsync(e){return(0,kt.mG)(this,void 0,void 0,(function*(){if(this.setWebGLContextOrBabylonEngine(e),!this.m_graphicsProcessor)throw O.Error(592328459,"Failed to initialize graphics processor.");yield this.m_graphicsProcessor.initializeProgramsAsync()}))}setBabylonEngine(e){this.setWebGLContextOrBabylonEngine(e)}setWebGLContext(e){this.setWebGLContextOrBabylonEngine(e)}setWebGLContextOrBabylonEngine(e){const t=e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext?e:e._gl;this.m_graphicsProcessor&&!this.m_graphicsProcessor.isCurrentWebGLContext(t)&&this.onWebGLContextLost(),this.m_graphicsProcessor?this.m_graphicsProcessor.setWebGLContextOrBabylonEngine(e):this.m_graphicsProcessor=new Jr(e,this.m_babylonWipeStateBetweenScopes,this.m_babylonDisableParallelShaderCompile,this.m_stateRestorer)}onWebGLContextLost(){if(this.m_scratchBuffers){for(let e of this.m_scratchBuffers)e.release();this.m_scratchBuffers=void 0}Ni(),this.m_graphicsProcessor&&(this.m_graphicsProcessor.onWebGLContextLost(),this.m_graphicsProcessor=void 0)}verifyGlyphCacheIntegrityAndTryRecover(){return!function(){let e=0,t=0,i=0,r=0,s=0,n=0;for(let o=0;o<Ui.length;o++){let a=0,l=0;const h=Li&&o<Li.length?Li[o].texture:void 0,c=h?h.tryConvertToBufferRGBA():void 0;for(let s=0;s<Ui[o].length;s++){const d=Ui[o][s];if(d.ready){if(!h||!c)return O.Error(555782370,"Glyph ready but texture missing"),!0;{let s=0;for(let e=Math.ceil(d.bounds.top);e<d.bounds.bottom;e++){const t=h.size.y-1-e;for(let e=Math.ceil(d.bounds.left);e<d.bounds.right;e++)s+=c[4*(e+t*h.size.x)]}if(void 0===d.checksum){if(0==s&&d.path.figures.length>0){const t=$(d.path.figures);t&&t.isValid()&&!t.isEmpty()&&e++}}else a+=s,l+=d.checksum,s>d.checksum&&t++,s<d.checksum&&(0==s?i++:(O.Error(555782402,`Glyph was ready but got partially erased (-${100*(d.checksum-s)/d.checksum}%)`),r++));d.checksum=s}n++}}0==a&&l>0&&s++}return e>0&&O.Error(555782371,`Glyph(s) with figures look empty: glyphCount=${e}, totalGlyphCount=${n}`),t>0&&O.Error(555782400,`Glyph(s) ready but additional pixels rendered on top: glyphCount=${t}, totalGlyphCount=${n}`),(i>0||r>0)&&O.Error(555782401,`Glyph(s) ready but erased from cache: glyphCountErased=${i}, glyphCountPartiallyErased=${r}, totalGlyphCount=${n}, pageCountErased=${s}, totalPageCount=${Ui.length}`),e>0||i>0||r>0}()||(this.m_glyphCachePreviouslyFailed?(O.Error(555782369,"GlyphCache failed for the second time: disable glyph cache"),ti(!1)):this.m_glyphCachePreviouslyFailed=!0,Ni(),!1)}isValid(){return!!this.m_graphicsProcessor&&this.m_graphicsProcessor.isValid()}getGraphicsProcessor(){return this.m_graphicsProcessor}getBabylonEngine(){return this.m_graphicsProcessor?this.m_graphicsProcessor.getBabylonEngine():void 0}getPerformanceSummary(){const e=e=>{if(!e)return;const t=e;for(const e in t)e.endsWith("Ms")&&(t[e]=ps(t[e]))};return this.m_perfSummary.averageFrameCost&&(this.m_perfSummary.averageFrameCost=ps(this.m_perfSummary.averageFrameCost)),e(this.m_perfSummary.perfInfoCurrentFrame),e(this.m_perfSummary.perfInfoFirstFrame),e(this.m_perfSummary.perfInfoSumOfAllFrames),this.m_perfSummary}resetPerformanceSummary(){this.m_perfSummary=new Ut}getCurrentFramePerformanceSummary(){return this.m_currentFramePerformanceSummary}getDebugStringProvider(){return this.m_debugStringProvider}ensureScratchBuffers(){if(!this.m_scratchBuffers){this.m_scratchBuffers=[];for(let e=0;e<2;e++)this.m_scratchBuffers.push(new si("ScratchBuffer",this,new P(Zt,Zt),0))}return this.m_scratchBuffers}ensureRenderNode(e){let t=e.renderDataMap[this.m_rendererId];return t||(t=new is(2==e.getType()),e.renderDataMap[this.m_rendererId]=t),t}ensurePathRenderData(e){let t=e.renderDataMap[this.m_rendererId];return t||(t=new rr,e.renderDataMap[this.m_rendererId]=t),t}ensureImageRenderData(e){let t=e.renderDataMap[this.m_rendererId];return t||(t=new nr,e.renderDataMap[this.m_rendererId]=t),t}ensureMorphKeyFrameRenderData(e){let t=e.renderDataMap[this.m_rendererId];return t||(t=new fr,e.renderDataMap[this.m_rendererId]=t),t}ensureMorphElementRenderData(e){let t=e.renderDataMap[this.m_rendererId];return t||(t=new pr,e.renderDataMap[this.m_rendererId]=t),t}attachTextureToImage(e,t){const i=this.ensureImageRenderData(e);e.changeTracker.replaceListener(i.texture,t),i.texture=t}attachLoaderToImage(e,t){const i=this.ensureImageRenderData(e);e.changeTracker.replaceListener(i.texture,t),i.loader=t}getTextureFromImage(e){if(!e)return;const t=this.ensureImageRenderData(e);return t.loader?(O.Error(520663959,"getTextureFromImage may return the wrong wrap mode for ImageTextureLoader"),t.loader.getTexture(4)):t.texture}getTextureFromImageBrush(e){var t;if(!e.image)return;const i=this.ensureImageRenderData(e.image);return i.loader?i.loader.getTexture(null!==(t=e.wrapMode)&&void 0!==t?t:4):i.texture}deleteAllTextures(e){e.releaseGeneratedResources()}tryGetImageDebugData(e){const t=this.ensureImageRenderData(e);return new sr(t.state,t.texture)}getDebugGlyphCacheInfo(e){return function(e){const t=Di(e);if(t){const e=Oi[t];if(e)return e.page}}(e)}generateTextureMemoryReport(e,t){let i={externalImages:0,managedImages:0,scratchBuffers:this.hasHitTestTexture()?4:0,glyphPages:0,shapeDistanceFields:0,textDistanceFields:0,otherBrushes:0,effects:0,rasterizedItems:0,fadeMasks:0,morphTextures:0,totalTarget:0,totalTargetExpected:this.getTextureManager().textureMemoryAllocated};for(let e of this.m_scratchBuffers||[])i.scratchBuffers+=e.memoryUsage;for(let e of Li||[])i.glyphPages+=e.texture?e.texture.memoryUsage:0;for(let t of e)ds(this,t,i);for(let e of t||[])us(this,e,i);return i.totalTarget=i.scratchBuffers+i.glyphPages+i.shapeDistanceFields+i.textDistanceFields+i.otherBrushes+i.effects+i.rasterizedItems+i.fadeMasks+i.morphTextures,i}initOutOfTime(){return this.m_initDeadline&&this.m_initDeadline<performance.now()}updateSettingsBeforeRender(){const e=jt.readNumberOrDefault("debugMode",-1);-1!=e&&(he=e);const t=jt.readBooleanOrDefault("debugTextLines",!1);t&&(ce=t);const i=jt.readNumberOrDefault("quality",0);0!=i&&Qt(i),jt.readBooleanOrDefault("disableGlyphTable",!1)&&ti(!1);const r=jt.readNumberOrDefault("hitTestSlop",0);0!=r&&function(e){re=e}(r);const s=jt.readNumberOrDefault("minLineWidth",0),n=jt.readNumberOrDefault("minLineWidthForArrowHead",0);0==s&&0==n||ne(s||te,n||ie);const o=jt.readNumberOrDefault("hitTestCache",0);var a,l,h;0!=o&&function(e){se=e}(o),a=jt.readBooleanOrDefault("useLegacyBrightness",oe),oe=a,l=jt.readBooleanOrDefault("useLegacyContrast",ae),ae=l,h=jt.readBooleanOrDefault("useLegacySharpness",le),le=h;const c=jt.readNumberOrDefault("glyphCacheTextureResolution",0);0!=c&&(de=c);const d=jt.readNumberOrDefault("glyphCacheMaxFactor",0);0!=d&&(ue=d)}fillRenderRectMap(e,t,i,r,s,n,o,a,l){const h=t.changeTracker.currentUniqueId+","+t.animationChangeTracker.currentUniqueId+","+n.index+(o?"+"+o:"")+(l?"*":""),c=t.instances?t.instances.length:1;for(let d=0;d<c;d++){const c=t.instances?t.instances[d].transform.toMatrix3().multiply(r):r,u=t.instances?h+","+d:h;if(t instanceof bt||t.effects.hasEffects){let r=t.getBounds(!a,!0,!0,c);if(t instanceof bt&&t.style.pictureOverflow&&t.style.pictureBrush){const e=t.fillBoundsOverride?t.fillBoundsOverride:Ct(t,!1),i=this.getTextureFromImageBrush(t.style.pictureBrush);if(e&&i){const s=t.animationTransform?E.FromTransforms(t.transform,c,t.animationTransform):E.FromTransforms(t.transform,c),n=Si(e,t.style.pictureBrush,i,s);n&&(r=R.UnionRect(r,n))}}a&&(r=r?r.transformedBounds(a):r),r=r?r.transformedBounds(s):r,r=i?R.IntersectRect(i,r):r,r&&(e[u]=r)}if(t instanceof wt){const r=(t.animationTransform||t.fade?t.animationChangeTracker.currentUniqueId:"")+":"+t.opacity+"/"+o,h=a||t.animationTransform;for(let o of t.items.elements)n.next(),this.fillRenderRectMap(e,o,i,t.transform.toMatrix3().multiply(c),s,n,r,h,l||t.isHidden)}}}calculateDirtyRect(e,t){let i,r=r=>{const s=e[r],n=t[r];L(s,n)||(i=R.UnionRect(i,s),i=R.UnionRect(i,n))};for(let t in e)r(t);for(let e in t)r(e);return i?i.inflate(2):void 0}getLastRenderRectMap(){return this.m_lastRenderRectMap}render(e,t,i,r){this.renderBatch([{item:e,eraseBackground:t,options:i}],r)}renderBatch(e,t){var i,r,s,n,o,a;if(!this.isValid())return void O.Message(512297154,"renderer context not valid in renderBatch");this.m_lastRenderRectMap=void 0,this.m_verboseRenderLogging&&O.Message(538208403,"RenderBatch begin");const l=null===(i=t)||void 0===i?void 0:i.enableDirtyRect,h=null===(r=t)||void 0===r?void 0:r.previousRenderRectMap;let c,d;const u=this.m_graphicsProcessor;if(!u)return void O.Error(592525091,"glContext must be provided");this.updateSettingsBeforeRender();const f=performance.now();if(l){c={};for(let t of e){const e=new rs;this.fillRenderRectMap(c,t.item,null===(s=t.options)||void 0===s?void 0:s.scissor,E.Identity,(null===(o=null===(n=t.options)||void 0===n?void 0:n.transform)||void 0===o?void 0:o.toMatrix3())||E.Identity,e,void 0,void 0,!1)}h&&(d=this.calculateDirtyRect(h,c))}if(this.m_verboseRenderLogging&&O.Message(525960788,"RenderBatch computed RenderRectMap"),!u.beginRenderScope())return;this.m_verboseRenderLogging&&O.Message(538208404,"RenderBatch entered render scope");const p=new Ot;p.glResetCostMs+=performance.now()-f,p.beginTime=(new Date).getTime(),this.m_currentFramePerformanceSummary=p,p.totalCostMs=-performance.now();for(let t of e)this.tryPrepareItemInWebGlScope(t.item,u,!0,void 0)||O.Error(592525120,"could not fully prepare scene");if(p.shapeRenderCostMs=-performance.now(),this.m_verboseRenderLogging&&O.Message(538208405,"RenderBatch Items prepared"),d||!l||!h)for(let t of e)this.renderItemInWebGLRenderScope(t.item,t.eraseBackground,t.options,d);this.m_verboseRenderLogging&&O.Message(538208406,"RenderBatch Items rendered");const m=e.length>0&&(null===(a=e[0].options)||void 0===a?void 0:a.target)instanceof si?e[0].options.target.size:u.getCurrentViewportSize();if(p.shapeRenderCostMs+=performance.now(),p.glRestoreCostMs=-performance.now(),d&&jt.readBooleanOrDefault("debugDirtyRects",!1)){const e=bt.CreateRectangle(d,new Me(new we(new _e(Math.random(),Math.random(),Math.random(),.25))));this.renderItemInWebGLRenderScope(e,void 0)}if(u.endRenderScope(),p.glRestoreCostMs+=performance.now(),p.totalCostMs+=performance.now(),p.endTime=(new Date).getTime(),this.m_perfSummary.perfInfoCurrentFrame=p,this.m_perfSummary.perfInfoFirstFrame||(this.m_perfSummary.perfInfoFirstFrame=p),this.m_perfSummary.perfInfoSumOfAllFrames||(this.m_perfSummary.perfInfoSumOfAllFrames=new Ot),this.m_perfSummary.perfInfoSumOfAllFrames.add(p),this.m_perfSummary.frameCount++,this.m_perfSummary.averageFrameCost=this.m_perfSummary.perfInfoSumOfAllFrames.totalCostMs/this.m_perfSummary.frameCount,this.m_perfSummary.viewWidth=m.x,this.m_perfSummary.viewHeight=m.y,this.m_perfSummary.frameCount>1){const e=(this.m_perfSummary.perfInfoSumOfAllFrames.totalCostMs-this.m_perfSummary.perfInfoFirstFrame.totalCostMs)/(this.m_perfSummary.frameCount-1);this.m_perfSummary.estimatedFps=Math.floor(Math.min(1e3/e,60))}else this.m_perfSummary.estimatedFps=Math.floor(Math.min(1e3/this.m_perfSummary.perfInfoCurrentFrame.shapeRenderCostMs,60));this.m_currentFramePerformanceSummary=new Ot,mr.OnRender(this,e),this.m_verboseRenderLogging&&O.Message(538208407,"RenderBatch finished"),this.m_lastRenderRectMap=c}renderItemInWebGLRenderScope(e,t,i,r){const s=this.m_graphicsProcessor;if(!s)return void O.Error(592525121,"glContext must be provided");s.updateViewportSize();const n=i?i.target:void 0,o=n?n.size:s.getCurrentViewportSize(),a=i?i.transform:void 0,l=(null==i?void 0:i.scissor)&&r?R.IntersectRect(null==i?void 0:i.scissor,r):(null==i?void 0:i.scissor)||r;if(((null==i?void 0:i.scissor)||r)&&!l)return;s.setScissorRect(null==l?void 0:l.inflateToInteger(),!0);const h=performance.now(),c=s.activateShaderProgram(1);if(this.isVerboseRenderLoggingEnabled()){const e=ps(performance.now()-h);O.Message(529077967,`RenderBatch shapeRender shader activation cost ${e}ms`)}c.begin(n?n.tryGetBabylonTextureForRenderToTexture(s):void 0,t,!0),this.drawItem(31,c,e,o,E.Identity,void 0,a?a.toMatrix3():E.Identity,0,void 0,!1,i,l,void 0),c.end(),s.setScissorRect(void 0)}renderMorph(e,t,i,r,s){if(!this.m_morphPlayer)throw O.Error(591667344,"Morph not available for this renderer");this.m_morphPlayer.renderMorph(this,e,t,i,r,s)}tryPrepareMorph(e,t){if(!this.m_morphPlayer)throw O.Error(591667345,"Morph not available for this renderer");return this.m_morphPlayer.tryPrepareMorph(this,e,t)}tryGetImageDebugDataForMorphKeyFrame(e){const t=this.ensureMorphKeyFrameRenderData(e);return t.texture?new sr(1,t.texture):void 0}renderLayers(e,t,i){const r=this.m_graphicsProcessor;if(!r)return void O.Error(592525125,"glContext must be provided");if(r&&!r.beginRenderScope())return;const s=this.m_targetTexture?this.m_targetTexture.size:r.getCurrentViewportSize(),n=r.activateShaderProgram(1);n.begin(this.m_targetTexture?this.m_targetTexture.tryGetBabylonTextureForRenderToTexture(r):void 0,t,!0);for(let t=0;t<e.length;t++)Ei(r,e[t],n,s,i?i.toMatrix3():void 0,void 0);n.end(),r.endRenderScope()}retrieveHitTestResult(e,t,i,r){if(t==i.index){const t={itemHit:e,itemStack:[e],textHit:void 0};if(e instanceof bt){const i=e.text;if(i){const s=r.transformPoint(E.FromTransforms(new M(e.transform.translation.negate()),i.frameToShape.toInverseMatrix3(),i.layoutToFrame.toInverseMatrix3()));t.textHit=i.hitTest(s)?i.getSelectionFromLayoutPosition(s):void 0}}return t}if(e instanceof wt)for(const s of e.items.elements){i.next();const n=this.retrieveHitTestResult(s,t,i,r.transformPoint(e.transform.toInverseMatrix3()));if(null==n?void 0:n.itemStack)return n.itemStack.splice(0,0,e),n}}renderHitTestBuffer(e,t,i,r,s){const n=performance.now();this.m_hitTestCache=void 0;const o=this.m_graphicsProcessor;if(!o)return void O.Error(592525129,"glContext must be provided");if(!o.beginRenderScope())return;this.tryPrepareItemInWebGlScope(e,o,!0,void 0)||O.Error(592525131,"could not fully prepare"),this.m_hitTestTexture&&this.m_hitTestTexture.isValid(this)&&this.m_hitTestTexture.size.equals(i)||(this.m_hitTestTexture&&this.m_hitTestTexture.release(),this.m_hitTestTexture=new si("HitTestPixel",this,i,0));const a=new rs,l=o.activateShaderProgram(1);l.begin(this.m_hitTestTexture.tryGetBabylonTextureForRenderToTexture(o),_e.Transparent,!0);const h=t.negate(),c=r?r.toMatrix3().multiply(E.Translation2D(h)):E.Translation2D(h);this.drawItem(0,l,e,this.m_hitTestTexture.size,E.Identity,void 0,c,7,a,!1,{filter:s},void 0,void 0),l.end(),this.m_hitTestTexture.renderCost=performance.now()-n;const d=this.m_hitTestTexture.tryUseBabylonTexture(o,void 0,"hitTest"),u=d?o.copyTexturePixelsToArray(d,new R(0,0,this.m_hitTestTexture.size.x,this.m_hitTestTexture.size.y),!0):void 0;o.endRenderScope(),u&&(this.m_hitTestCache={buffer:u,uniqueId:e.changeTracker.currentUniqueId,origin:t,renderTransform:r})}isHitTestBufferValid(e,t,i,r,s){if(s||0==se||!this.m_hitTestCache||this.m_hitTestCache.uniqueId!=e.changeTracker.currentUniqueId)return!1;if(!this.m_hitTestCache.renderTransform&&!r||this.m_hitTestCache.renderTransform&&r&&!this.m_hitTestCache.renderTransform.toMatrix3().equals(r.toMatrix3()))return!1;const n=this.m_hitTestCache.origin?new R(this.m_hitTestCache.origin.x,this.m_hitTestCache.origin.y,this.m_hitTestCache.origin.x+i.x-1,this.m_hitTestCache.origin.y+i.y-1):void 0;return!(!n||!n.isPointInRect(t))}hitTestScene(e,t,i,r){if(!this.isValid())return O.Message(512297153,"renderer context not valid in hitTestScene"),es;const s=se&&!r?new P(se,se):P.One;if(!this.isHitTestBufferValid(e,t,s,i,r)){const n=t.floor().subtract(new P(Math.floor(s.x/2),Math.floor(s.y/2)));this.renderHitTestBuffer(e,n,s,i,r)}if(!this.m_hitTestCache)return es;const n=t.subtract(this.m_hitTestCache.origin).floor(),o=4*(n.x+(s.y-1-n.y)*s.x);if(o<0||o+3>=this.m_hitTestCache.buffer.length||0==this.m_hitTestCache.buffer[o+3])return es;const a=this.m_hitTestCache.buffer[o+0]+256*this.m_hitTestCache.buffer[o+1]+65536*this.m_hitTestCache.buffer[o+2],l=new rs,h=i instanceof E?i.tryGetTransform(P.Zero):i,c=h?h.toInverseMatrix3():void 0;return this.retrieveHitTestResult(e,a,l,c?t.transformPoint(c):t)||(ts++,ts<=100&&O.Error(592525132,`Unable to retrieve hit shape ${a}`),100==ts&&O.Error(520119570,"Hit test failed too many times, not reporting anymore"),es)}hasHitTestTexture(){return null!=this.m_hitTestTexture}tryInitTextures(e,t,i,r,s){var n,o,a;if(t.isHidden)return!0;const l=this.ensureRenderNode(t);l.cache.beforeInitTextures(t,e);const h=new ss(r,t,l,s),c=t instanceof bt&&void 0!==t.shape3D;if(t instanceof bt){const r=t;if(r.incrementalPath&&(l.cache.initTextureStage=dr.fromBegining),l.cache.initTextureStage<dr.distanceFieldsReady){if(r.incrementalPath)l.cache.distanceFields&&1==l.cache.distanceFields.length||(l.cache.distanceFields=[new ki("DistanceField/incremental",this,void 0,0,0,0,1,!1)]);else if(r.paths&&!l.cache.distanceFields&&!r.isSolidRect()){let e=-performance.now();if(l.cache.distanceFields=[],(null===(n=r.paths)||void 0===n?void 0:n.length)>0){let e=0,t=0,i=r.paths[0].fillMode;for(let s=0;s<r.paths.length;s++){const n=s==r.paths.length-1,o=n?0:r.paths[s+1].fillMode;(n||o!=i)&&(!r.style.hasLine||0==r.style.pen.headEnd.end&&0==r.style.pen.tailEnd.end?l.cache.distanceFields.push(new ki("DistanceField/fillAndLine",this,Ue.FromFirstLast(e,t),i,r.mergeMode,0,1,!1)):(0!=i&&null!=r.style.fillBrush&&l.cache.distanceFields.push(new ki("DistanceField/fillOnly",this,Ue.FromFirstLast(e,t),i,r.mergeMode,1,1,!1)),l.cache.distanceFields.push(new ki("DistanceField/arrowAndLine",this,Ue.FromFirstLast(e,t),i,r.mergeMode,2,1,!1))),i=o,e=s+1),t=s+1}c&&l.cache.distanceFields.push(new ki("DistanceField/displacement",this,void 0,i,r.mergeMode,0,1,!0))}if(e+=performance.now(),3==r.role?this.m_currentFramePerformanceSummary.distanceFieldForTextCostMs+=e:this.m_currentFramePerformanceSummary.distanceFieldForShapeCostMs+=e,this.initOutOfTime())return!1}for(const e of l.cache.distanceFields||[]){let t=-performance.now();const i=null!=r.incrementalPath;let s=e.refresh(this,r,i);if(!s&&i&&(s=e.refresh(this,r,!1)),s||O.Error(592525133,"error in distanceField refresh"),t+=performance.now(),3==r.role?this.m_currentFramePerformanceSummary.distanceFieldForTextCostMs+=t:this.m_currentFramePerformanceSummary.distanceFieldForShapeCostMs+=t,this.initOutOfTime())return!1}l.cache.initTextureStage=dr.distanceFieldsReady}if(l.cache.initTextureStage<dr.brushTexturesReady||r.instances){if(l.cache.initBrushTexture(this,t,0),this.initOutOfTime())return!1;if(l.cache.initBrushTexture(this,t,1),this.initOutOfTime())return!1;if(l.cache.initBrushTexture(this,t,2),this.initOutOfTime())return!1;l.cache.initTextureStage=dr.brushTexturesReady}if(r.text&&r.text.cache)if(0==r.text.renderMode){let t=0;for(const s of r.text.cache.textShapes||[]){if(r.text.animationProps)if(s.textRange){const e=r.text.animationProps.getAt(s.textRange.start);s.fade=e.fade,s.animationTransform=e.animationTransform,s.isHidden=e.isHidden}else O.Error(592525134,"no range");else s.fade=void 0,s.animationTransform=E.Identity,s.isHidden=!1;if(!this.tryInitTextures(e,s,i,h,t))return!1;t++}for(const t of r.text.cache.selectionShapes||[])if(!this.tryInitTextures(e,t,i,h,0))return!1}else l.cache.initTextCutoutLayer(this,r.text.cache.cutoutLayerPaths,r)}else{if(!(t instanceof wt))throw O.Error(592525135,"Unknown Item type");{l.cache.initTextureStage<dr.brushTexturesReady&&(l.cache.initBrushTexture(this,t,0),l.cache.initTextureStage=dr.brushTexturesReady);const r=t;for(let t=0;t<r.items.length;t++){const s=r.items.getAt(t);if(s&&!this.tryInitTextures(e,s,i,h,t))return!1;if(this.initOutOfTime())return!1}}}let d=-performance.now();if(l.cache.fade=h.fade,l.cache.initFadeTexture(this,t,h.fade),d+=performance.now(),t.fade&&(this.m_currentFramePerformanceSummary.fadeTextureCostMs+=d),this.initOutOfTime())return!1;if(i&&l.cache.initTextureStage<dr.effectsReady){if(t.effects){if(t.effects.innerShadow&&t.effects.innerShadow.color.a>0&&!l.cache.innerShadowTexture&&(l.cache.innerShadowTexture=this.createTextureRasterizedItem("Effect/InnerShadow",t,0,l.cache.innerShadowTexture,_e.Black,t.effects.innerShadow.radius,8,2,Yt,1),this.initOutOfTime()))return!1;if(t.effects.softEdges&&t.effects.softEdges.radius>0&&!l.cache.softEdgesTexture&&(l.cache.softEdgesTexture=this.createTextureRasterizedItem("Effect/SoftEdges",t,0,l.cache.softEdgesTexture,_e.Black,t.effects.softEdges.radius,16,5,Yt,1),this.initOutOfTime()))return!1;if(t.effects.glow&&t.effects.glow.radius>0&&t.effects.glow.color.a>0&&!l.cache.glowTexture&&(l.cache.glowTexture=this.createTextureRasterizedItem("Effect/Glow",t,16,l.cache.glowTexture,t.effects.glow.color,t.effects.glow.radius?2*t.effects.glow.radius:0,1,t.effects.glow.isSharp?4:3,Yt,1),this.initOutOfTime()))return!1;if(t.effects.shadow&&t.effects.shadow.color.a>0&&!l.cache.shadowTexture&&(l.cache.shadowTexture=this.createTextureRasterizedItem("Effect/Shadow",t,17,l.cache.shadowTexture,t.effects.shadow.color,t.effects.shadow.radius?t.effects.shadow.radius:0,2,6,Yt,1),this.initOutOfTime()))return!1;if(t.effects.reflection&&!l.cache.reflectionTexture&&(l.cache.reflectionTexture=this.createTextureRasterizedItem("Effect/Reflection",t,27,l.cache.reflectionTexture,void 0,t.effects.reflection.radius,4,6,Yt,1),this.initOutOfTime()))return!1}l.cache.initTextureStage=dr.effectsReady}if(i)if(c||t.fade&&13!=t.fade.preset||t instanceof wt&&t.opacity<1){l.cache.spriteHitTest=c||void 0!==t.fade&&13!=t.fade.preset;const e=t.animationTransform?t.animationTransform.transformVector(P.One.scale(Math.sqrt(2)/2)).length():1,i=Math.max(.1,Xt*e);if((!l.cache.spriteTexture||l.cache.spriteTexture.tag!=t.changeTracker.currentUniqueId||l.cache.spriteQuality<i)&&(l.cache.spriteTexture&&(this.fixedMemoryLeakAmounts.recreatingSprites+=l.cache.spriteTexture.memoryUsage),null===(a=l.cache.spriteTexture)||void 0===a||a.release(),l.cache.spriteTexture=c?function(e,t,i,r){const s=e.getGraphicsProcessor();if(!s)return void O.Error(572867290,"failed to get graphicsProcessor");const n=e.ensureRenderNode(t),o=Pt(t,!0,31,31,t.transform.toInverseMatrix3().multiply(E.Scale2D(t.transform.scale))),a=ls(t),l=e.createTextureRasterizedItem("RasterizeFor3D/Item",t,24,n.cache.spriteTexture,void 0,0,0,1,r,1),h=n.cache.glowTexture||n.cache.shadowTexture||n.cache.reflectionTexture?e.createTextureRasterizedItem("RasterizeFor3D/Effects",t,31,n.cache.spriteTexture,void 0,0,0,8,r,1):void 0,c=n.cache.getBevelDistanceField();let d;if(o&&a&&l&&(null==c?void 0:c.texture)){const n=Math.min(r,Kt/o.size.x,Kt/o.size.y),u=new P(Math.min(Kt,Math.ceil(o.size.x*n)),Math.min(Kt,Math.ceil(o.size.y*n)));d=new si("rasterized3D",e,u,1),d.tag=t.changeTracker.currentUniqueId,d.contentLocation={logicalCenter:a.center.subtract(o.leftTop).scale(n),logicalSize:a.size.scale(n),physicalCenter:d.size.scale(.5),physicalSize:d.size,rotation:0,flipX:!1,flipY:!1};const f=d.tryGetBabylonTextureForRenderToTexture(s);if(f){let r,n=P.Zero;t instanceof bt&&t.shape3D&&t.shape3D.topBevel&&(r=function(e,t,i,r){function s(e,t,i){for(let r=Math.floor(t.x);r<=Math.floor(i.x);r++)r>=0&&r<e.length&&(e[r]=Math.max(e[r],t.y+(r-t.x)*(i.y-t.y)/(i.x-t.x)))}const n=new Array(t);n.fill(0),i.forEachSegment(((e,t,i)=>{if(t){const r=Math.max(8,i.x-e.x);for(let o=0;o<r;o++)s(n,P.InterpolateQuadratic(e,t,i,o/r),P.InterpolateQuadratic(e,t,i,(o+1)/r))}else s(n,e,i);return!0}),E.Scale2D(r));const o=new Float32Array(768);for(let e=0;e<t;e++)o[3*e]=o[3*e+1]=o[3*e+2]=n[e];return ri.CreateFromByteBuffer("PathProfile",e,new P(t,1),o,4,4,!0)}(e,256,t.shape3D.topBevel.profile,new P(255,1)),n=t.shape3D.topBevel.size);const o=s.activateShaderProgram(7);o.begin(f,_e.Transparent,!0),h&&fs(s,o,h,void 0,void 0,d.size,d.contentLocation.logicalSize,d.contentLocation.logicalCenter,P.Zero,0,void 0,void 0,_e.Transparent,0),fs(s,o,l,c,r,d.size,d.contentLocation.logicalSize,d.contentLocation.logicalCenter,n,t instanceof bt?t.style.pen.lineWidth:0,i,t instanceof bt&&t.shape3D?t.shape3D.material:void 0,t instanceof bt&&t.shape3D&&t.shape3D.contourColor?t.shape3D.contourColor:_e.Transparent,t instanceof bt&&t.shape3D?t.shape3D.adjustedContourWidth:0),o.end(),r&&r.release()}else O.Error(572867291,"failed to get textureTarget")}else O.Error(572867292,"failed to get textures for 3D rendering");return l&&l.release(),h&&h.release(),d}(this,t,h.scene3D,i):this.createTextureRasterizedItem("SpriteCache",t,31,l.cache.spriteTexture,void 0,0,0,1,i,1),l.cache.spriteTexture&&(l.cache.spriteTexture.tag=t.changeTracker.currentUniqueId,l.cache.spriteQuality=i),this.initOutOfTime()))return!1}else null===(o=l.cache.spriteTexture)||void 0===o||o.release(),l.cache.spriteTexture=void 0,l.cache.spriteQuality=0,l.cache.spriteHitTest=!1;return!0}tryPreparePaths(e){for(const t of e)if(this.ensurePathRenderData(t).refreshCachedTapeBuffers(t),this.initOutOfTime())return!1;return!0}tryPrepareGeneratedShapes(e){const t=this;return Tt(e,(e=>(Rt(e),!t.initOutOfTime())))}tryPrepareTapes(e){const t=this;return Tt(e,(e=>{if(e.paths){if(!t.tryPreparePaths(e.paths))return!1;if(e.shapeBoundsCache&&e.shapeBoundsCache.geometryVersion==e.geometryTracker.version||(e.shapeBoundsCache={geometryVersion:e.geometryTracker.version}),e.shapeBoundsCache.pathsBounds||e.style.hasLine||(e.shapeBoundsCache.pathsBounds=ee(e.paths)),t.initOutOfTime())return!1}return!0}))}tryPrepareItemInWebGlScope(e,t,i,r){const s=performance.now();if(this.m_initDeadline=r?s+r:void 0,t&&!t.tryPrepareProgramResourcesInWebGlScope(this.m_initDeadline))return!1;if(!this.tryPrepareGeneratedShapes(e))return!1;if(!this.tryPrepareTapes(e))return!1;if(t){let r=!1;return function(e,t){if(!ei)return;if(!e.getGraphicsProcessor())return;const i=performance.now();Vi!=de&&(Ni(),Vi=de);let r=Li;var s;Li=void 0,r||(r=[]),s=e=>(function(e){const t=Di(e.glyphCacheId);if(!t||null!=Oi[t])return;const i=new V(e,M.Identity),r=ee([i]);if(!r)return;if(ue&&Math.max(r.width,r.height)>ue*Gi)return;0!=Ui.length&&256!=Ui[Ui.length-1].length||Ui.push([]);const s=Ui.length-1,n=Ui[s],o=r.size,a=Wi()/Math.max(Gi,Math.max(o.x,o.y)),l=new P(a,a),h=n.length,c=.5+h%16,d=.5+(h-c)/16,u=r.center.scale(-a).add(new P(c*Hi(),d*Hi())),f=M.fromScaleAndTranslation(l,u),p={page:s,scale:a,offset:u,bounds:r.multiply(l).translate(u).inflate($i()),path:new V(i,f),ready:!1};n.push(p),Oi[t]=p}(e),!0),Tt(t,(e=>{for(const t of e.paths||[])if(!s(t))return!1;return!0}));for(let t=0;t<Ui.length;t++){let i=!0,s=t<r.length?r[t]:void 0;if(s)s.texture&&s.texture.isValid(e)||(O.Error(592525085,"invalid glyph table texture. recreating."),i=!1);else{for(;r.length<t+1;)r.push(new ki("DistanceField/glyphPage",e,void 0,1,0,0,1,!1));s=r[t],s.contentBoundsOverride=new R(0,0,zi(),zi()),s.paddingOverride=8,s.qualityOverride=1,s.isGlyphCache=!0,i=!1}let n=!1;i&&(n=er(e,t,s,!0)),n||er(e,t,s,!1)}Li=r,e.getCurrentFramePerformanceSummary().distanceFieldForGlyphTableCostMs+=performance.now()-i}(this,e),this.initOutOfTime()||(r=this.tryInitTextures(t,e,i,void 0,0)),r}return!0}tryPrepareItem(e,t,i){if(!this.isValid())return O.Message(512297152,"renderer context not valid in tryPrepareItem"),!1;const r=this.m_graphicsProcessor;if(!r)return O.Error(592525136,"glContext must be provided"),!1;if(this.updateSettingsBeforeRender(),!r.beginRenderScope())return!1;const s=this.tryPrepareItemInWebGlScope(e,r,t,i);return r.endRenderScope(),s}drawItem(e,t,i,r,s,n,o,a,l,h,c,d,u){var f,p,m,g,v,_,y,b,w;const T=i.instances||_t.DefaultArray;for(let x of T){let T=i;if(i instanceof wt&&void 0!==x.groupIndex&&i.items.length>0){const e=x.groupIndex;e>=0&&e<i.items.length?T=i.items.getAt(e):(T=void 0,O.Error(509617671,`Instance index out of range: ${e}, count: ${i.items.length}`))}if(T){const i=null!==(f=x.transform.toMatrix3().multiply(s))&&void 0!==f?f:s,C={opacity:null!==(m=null!==(p=x.opacity)&&void 0!==p?p:null==u?void 0:u.opacity)&&void 0!==m?m:1,colorMatrix:null!==(v=null!==(g=x.colorMatrix)&&void 0!==g?g:null==u?void 0:u.colorMatrix)&&void 0!==v?v:void 0,colorOffset:null!==(y=null!==(_=x.colorOffset)&&void 0!==_?_:null==u?void 0:u.colorOffset)&&void 0!==y?y:void 0,colorize:null!==(w=null!==(b=x.colorize)&&void 0!==b?b:null==u?void 0:u.colorize)&&void 0!==w?w:void 0};this.drawItemOnce(e,t,T,r,i,n,o,a,l,h,c,d,C)}}}drawItemOnce(e,t,i,r,s,n,o,a,l,h,c,d,u){var f,p,m,g;const v=0==a||7==a,_=n||i.animationTransform,y=i instanceof bt?3==i.role?"text":"shape":"group",b=v&&_?s.multiply(_.multiply(o)):s.multiply(o);if(!this.m_graphicsProcessor||i.isHidden||c&&c.filter&&!c.filter(i)||i instanceof wt&&0==i.opacity)return;this.m_graphicsProcessor.setScissorRect(null==d?void 0:d.inflateToInteger(),!0);const w=this.ensureRenderNode(i);let T=null===(f=w.cache)||void 0===f?void 0:f.fade,x=null!==(m=null===(p=w.cache)||void 0===p?void 0:p.fadeMode)&&void 0!==m?m:0;const C=7==a?1:(null!==(g=null==u?void 0:u.opacity)&&void 0!==g?g:1)*(i instanceof wt?i.opacity:1),S=ls(i);let B,I=!1;if(i instanceof bt&&i.clipBounds&&S&&(B=i.getBounds(),B=B?B.transformedBounds(i.transform.toInverseMatrix3()):void 0,B=B?i.clipBounds.clip(B):void 0,B=B?B.translate(S.center.negate()).multiply(i.transform.scale):void 0,I=!B),v&&w.cache.spriteTexture&&(7!=a||w.cache.spriteHitTest)){if(S&&!I){const e=new bi(w.cache.spriteTexture,ii(S,i.transform));e.fadeInfo=v&&T?{fade:T,fadeTexture:w.cache.fadeTexture,fadeMode:x}:void 0,e.localClipRect=B,e.clientObject=w.cache,e.overallOpacity=C,e.colorMatrix=null==u?void 0:u.colorMatrix,e.colorOffset=null==u?void 0:u.colorOffset,e.colorize=null==u?void 0:u.colorize;const s=performance.now();Ei(this.m_graphicsProcessor,e,t,r,b,l?l.color:void 0),this.onLayerRendered(y,"SpriteCache",s,e)}}else{if(0!=e&&i.effects&&(i.effects.glow||i.effects.shadow||i.effects.reflection)&&0==he&&7!=a&&(!c||!c.textRange)&&S&&!I){const s=S.center.transformPoint(i.transform);let n;if(4&e&&i.effects.reflection||2&e&&i.effects.shadow){const e=new M(s.negate(),P.One,i.effects.direction,s);n=i.effectsBoundsOverride?i.effectsBoundsOverride.transformedBounds(e):Pt(i,!1,0,1,e.toMatrix3())}const o=S?ii(S,i.transform):void 0,a=o?new M(P.Zero,P.Flip(o.flipX,o.flipY),o.rotation+i.effects.direction,o.center):void 0,h=a?a.toInverseMatrix3():void 0;if(4&e&&i.effects.reflection&&w.cache.reflectionTexture&&n&&S&&o&&a&&h&&!I){let e=i.effects.reflection,s=n.bottom+e.distance/2;i instanceof bt&&i.textEffectMetrics&&(s-=i.textEffectMetrics.descent);const c=E.Translation2D(new P(0,-s)).multiply(E.Scale2D(new P(1,-1))).multiply(E.Translation2D(new P(0,s)));let d=new P(n.center.x,s),f=new P(n.center.x,s+n.height);const p={opacity0:e.startAlpha,opacity1:e.endAlpha,pos0:P.InterpolateLinear(d,f,e.startPosition).transformPoint(h),pos1:P.InterpolateLinear(d,f,e.endPosition).transformPoint(h)},m=new bi(w.cache.reflectionTexture,o);m.fadeInfo=v&&T?{fade:T,fadeTexture:w.cache.fadeTexture,fadeMode:x}:void 0,m.effectTransform=E.FromTransforms(a,c,h),m.localClipRect=B,m.reflectionGradient=p,m.clientObject=w.cache,m.overallOpacity=C,m.colorMatrix=null==u?void 0:u.colorMatrix,m.colorOffset=null==u?void 0:u.colorOffset,m.colorize=null==u?void 0:u.colorize;const g=performance.now();Ei(this.m_graphicsProcessor,m,t,r,b,l?l.color:void 0),this.onLayerRendered(y,"Reflection",g,m)}if(2&e&&i.effects.shadow&&w.cache.shadowTexture&&n&&S&&o&&a&&h&&!I){const e=Et(i.effects.shadow.alignment,n),s=Mt(i.effects.shadow.angle,i.effects.shadow.distance,i.effects.shadow.scale,i.effects.shadow.skew,e),c=new bi(w.cache.shadowTexture,o);c.fadeInfo=v&&T?{fade:T,fadeTexture:w.cache.fadeTexture,fadeMode:x}:void 0,c.effectTransform=E.FromTransforms(a,s,h),c.localClipRect=B,c.clientObject=w.cache,c.overallOpacity=C,c.colorMatrix=null==u?void 0:u.colorMatrix,c.colorOffset=null==u?void 0:u.colorOffset,c.colorize=null==u?void 0:u.colorize;const d=performance.now();Ei(this.m_graphicsProcessor,c,t,r,b,l?l.color:void 0),this.onLayerRendered(y,"Shadow",d,c)}if(1&e&&i.effects.glow&&w.cache.glowTexture&&S&&o&&a&&h&&!I){const e=new bi(w.cache.glowTexture,o);e.fadeInfo=v&&T?{fade:T,fadeTexture:w.cache.fadeTexture,fadeMode:x}:void 0,e.localClipRect=B,e.clientObject=w.cache,e.overallOpacity=C,e.colorMatrix=null==u?void 0:u.colorMatrix,e.colorOffset=null==u?void 0:u.colorOffset,e.colorize=null==u?void 0:u.colorize;const i=performance.now();Ei(this.m_graphicsProcessor,e,t,r,b,l?l.color:void 0),this.onLayerRendered(y,"Glow",i,e)}}if(8!=a)if(1==i.getType()){const n=i;if(!(c&&c.textRange||I))if(n.isSolidRect())vr(this,w.cache,void 0,e,t,n,r,b,a,l?l.color:void 0,B,C,null==u?void 0:u.colorMatrix,null==u?void 0:u.colorOffset,null==u?void 0:u.colorize);else for(const i of w.cache.distanceFields||[])i.isDisplacementMap||vr(this,w.cache,i,e,t,n,r,b,a,l?l.color:void 0,B,C,null==u?void 0:u.colorMatrix,null==u?void 0:u.colorOffset,null==u?void 0:u.colorize);if(n.text&&n.text.cache&&(!c||!c.noSubtree||c.textRange)){const e=new M(P.Zero,P.One,n.transform.rotation,n.transform.translation),i=e.toMatrix3().multiply(s),f=n.text.animationProps?void 0:_,p=o;if(l)for(const e of n.text.cache.hitTestLineShapes||[])(!c||!c.textRange||e.textRange&&c.textRange.includes(e.textRange.start))&&this.drawItem(31,t,e,r,i,f,p,a,l,h,void 0,d,u);else if(0==n.text.renderMode){for(const e of n.text.cache.textShapes||[])(!c||!c.textRange||e.textRange&&c.textRange.includes(e.textRange.start))&&this.drawItem(31,t,e,r,i,f,p,a,l,h,void 0,d,u);if(0==a)for(const e of n.text.cache.selectionShapes||[])this.drawItem(31,t,e,r,i,f,p,a,l,h,void 0,d,u)}}}else if(2==i.getType()&&(!c||!c.noSubtree&&!c.textRange)){const e=i;if(e)for(let i=0;i<e.items.length;i++){const n=e.items.getAt(i);{l&&l.next();const i=e.transform.toMatrix3().multiply(s),f=_,p=o;let m=d,g=!1;if(e.clipBounds){let t=d||new R(0,0,r.x,r.y);const s=f?E.FromTransforms(i,f,p):i.multiply(p),n=null==s?void 0:s.inverse(),o=n?t.transformedBounds(n):void 0,a=o?e.clipBounds.clip(o):void 0,l=null==a?void 0:a.transformedBounds(s);m=l?R.IntersectRect(l,t):void 0,g=null==m}g||this.drawItem(31,t,n,r,i,f,p,a,l,h,c,m,u)}}}}this.m_graphicsProcessor.setScissorRect(void 0)}renderToTexture(e,t,i,r,s,n,o,a,l){s&&s.size.equals(n)||(s=new si(e,this,n,l));const h=t.activateShaderProgram(1);h.begin(s.tryGetBabylonTextureForRenderToTexture(t),_e.Transparent,!0);const c={noSubtree:(3==a||4==a)&&i instanceof bt};return this.drawItemOnce(r,h,i,n,E.Identity,void 0,o.toMatrix3(),a,void 0,!1,c,void 0,void 0),h.end(),s}drawTextureToTexture(e,t,i,r){const s=this.m_graphicsProcessor;if(!s)throw O.Error(592525137,"No Graphics Processor");const n=0==i?5:5==i?8:6,o=s.isInRenderScope();if(!o&&!s.beginRenderScope())throw O.Error(591541203,"Failed to begin RenderScope");{const a=s.activateShaderProgram(n);a.begin(e.tryGetBabylonTextureForRenderToTexture(s),_e.Transparent,!0),hi(s,a,t,[new R(0,0,t.size.x,t.size.y)],[new R(0,0,e.size.x,e.size.y)],e.size,i,1,void 0,r),a.end(),o||s.endRenderScope()}}createTextureRasterizedItem(e,t,i,r,s,n,o,a,l,h){const c=this.m_graphicsProcessor;if(!c)throw O.Error(591541204,"No Graphics Processor");l<=0&&O.Error(509698625,`Quality is ${l}`);const d=performance.now(),u=4==a,f=!u&&n?l*Math.min(1,4/Math.sqrt(n)):l,p=!!(4&o),m=!!(24&o),g=!(2==t.getType()&&t.isDocumentShape);let v=Pt(t,p||g&&!m,i,31,t.transform.toInverseMatrix3().multiply(E.Scale2D(t.transform.scale)));if(!v)return;v=v.inflate(Math.max(2/f,n));const _=v.size,y=v.center.divide(t.transform.scale).transformPoint(t.transform);if(!_||!y)return;const b=Math.min(f,Zt/Math.max(_.x,_.y)),w=_.scale(b),T=n||s,x=new P(F(T?I(w.x):w.x,16,Zt),F(T?I(w.y):w.y,16,Zt)),C=Math.min(b,Math.min(x.x/_.x,x.y/_.y)),S=new M(y.negate(),new P(C,C),-t.transform.rotation,new P(x.x/2,x.y/2)),B=ls(t);if(!B)return;if(u){const o=this.renderToTexture(e,c,t,i,void 0,x,S,a,0);r=function(e,t,i,r,s,n){const o=i.size,a=new Array(32),l=new Array(32);for(let e=0;e<32;e++){const t=2*Math.PI*e/32,i=new P(Math.cos(t)*r,Math.sin(t)*r);a[e]=new R(0,0,o.x,o.y),l[e]=new R(0+i.x,i.y,o.x+i.x,o.y+i.y)}const h=new si("SharpGlow",e,o,n),c=t.activateShaderProgram(6);return c.begin(h.tryGetBabylonTextureForRenderToTexture(t),_e.Transparent,!0),hi(t,c,i,a,l,o,0,1,s),c.end(),h}(this,c,o,n*C,s||_e.Black,h),o.release()}else r=this.renderToTexture(e,c,t,i,r,x,S,a,h),T&&(r.generateMipMap(),function(e,t,i,r,s,n){const o=e.getGraphicsProcessor();if(!o)return void O.Error(592525249,"No GraphicsProcessor");const a=e.ensureScratchBuffers(),l=a[0],h=a[1],c=1==r?.12*i:16==r?.47*i:i,d=1==r?.3*i:i,u=1==r?3:16==r?2:s?1:0,f=s?1:0,p=1!=r&&16!=r;gi(o,h.size.divide(t.size),t,h,s?_e.Black:void 0,c,u,new P(1,0),p,n),gi(o,P.One,h,l,s?_e.Black:void 0,c,u,new P(0,1),p,void 0),gi(o,P.One,l,h,s?_e.Black:void 0,d,f,new P(1,0),!0,void 0),gi(o,t.size.divide(l.size),h,t,s,d,f,new P(0,1),!0,void 0)}(this,r,n*C,o,s,this.ensureRenderNode(t).cache));r.contentLocation={logicalCenter:B.center.transformPoint(t.transform).transformPoint(S),logicalSize:B.size.multiply(t.transform.scale).scale(C),physicalCenter:r.size.scale(.5),physicalSize:_.scale(C),rotation:0,flipX:!1,flipY:!1};const A=performance.now()-d;return 6==a||3==a||4==a||2==a||5==a?this.m_currentFramePerformanceSummary.effectsCostMs+=A:1==a&&(this.m_currentFramePerformanceSummary.cacheToSpriteCostMs+=A),r.renderCost=A,r}preCompileShaderAsync(e){this.m_graphicsProcessor?this.m_graphicsProcessor.preCompileShaderAsync(e):O.Error(592525138,"Graphics Processor not initialized")}preLinkShaderAsync(e){this.m_graphicsProcessor?this.m_graphicsProcessor.preLinkShaderAsync(e):O.Error(592525139,"Graphics Processor not initialized")}getDebugString(e){return this.m_debugStringProvider?e instanceof yt?this.m_debugStringProvider.getDebugStringForItem(e,this):e instanceof Dt?this.m_debugStringProvider.getDebugStringForMorph(e,this):"unsupported object":"no debug string provider"}getTexturesUsedByObject(e,t){if(e instanceof ri&&t.push(e),e instanceof yt){const i=e.getBrushImages();t.push(...i.map((e=>this.ensureImageRenderData(e).texture))),this.getTexturesUsedItemCacheGL(e,t)}if(e instanceof Dt)for(let i of e.elements)for(let e of i.keyFrames)if(e){const i=this.ensureMorphKeyFrameRenderData(e);i.texture&&t.push(i.texture),i.textureDeltaWhite&&t.push(i.textureDeltaWhite),i.texturePicture&&t.push(i.texturePicture)}}getTexturesUsedItemCacheGL(e,t){const i=this.ensureRenderNode(e).cache;if(t.push(...i.getFulltextureList()),e instanceof wt)for(let i of e.items.elements)this.getTexturesUsedItemCacheGL(i,t);if(e instanceof bt&&e.text&&e.text.cache){for(const i of e.text.cache.getTextShapes())this.getTexturesUsedItemCacheGL(i,t);for(const i of e.text.cache.getSelectionShapes())this.getTexturesUsedItemCacheGL(i,t)}}getAllocatedTextures(e){const t=new Array;for(let i of e||[])this.getTexturesUsedByObject(i,t);return this.getTextureManager().allocatedTextures.filter((e=>!t.includes(e)))}getAllocatedTexturesDebugTable(e,t){const i=this.getAllocatedTextures(t),r=[],s=["✅ Valid","❌ Empty","⚠️ Sneaky","⁉️ WrongR","⁉️ WrongC"],n=["Keep","Dispose","External"];for(let t of i){const i=t.lastUsage?performance.now()-t.lastUsage:void 0,o=t.lastRenderTime?performance.now()-t.lastRenderTime:void 0,a=t.scenario,l=s[t.getState(this)],h=n[t.releasePolicy],c=t.size.x,d=t.size.y,u=t.memoryUsage,f=t.renderCost;let p="[ ";if(t.usageRecord.length>0)for(let i=0;i<t.usageRecord.length;i++){const r=t.usageRecord[i];p+=0==i?"":", ",p+='{"id":"'+as(r.clientObject,e)+'", "scenario":"'+r.lastScenario+'", "lastRead":'+(performance.now()-r.lastUsage)+"}"}p+="]",r.push({lastRead:i,lastWrite:o,scenario:a,state:l,policy:h,width:c,height:d,memory:u,cost:f,clients:p})}return r}enableVerboseRenderLogging(e){this.m_verboseRenderLogging=e}isVerboseRenderLoggingEnabled(){return this.m_verboseRenderLogging}onLayerRendered(e,t,i,r){const s=Math.ceil(r.contentSize.x)*Math.ceil(r.contentSize.y);if(this.getCurrentFramePerformanceSummary().pixelCountShapeRender+=s,"text"==e&&this.getCurrentFramePerformanceSummary().shapeLayerCountText++,this.isVerboseRenderLoggingEnabled()){const r=ps(performance.now()-i);O.Message(529077968,`RenderBatch ${e} layer ${t} rendered ${s} pixels, cost ${r}ms`)}}testRenderFidelity(){const e=new bt([V.CreateFromFigure(new z([0,10,1,10,0,1,10,10,1]))],new Me(new we(_e.Blue))),t=new bt([V.CreateFromFigure(new z([0,0,1,0,10,1,10,10,1]))],new Me(new we(_e.Red))),i=new bt([V.CreateFromFigure(new z([0,10,1,5,5,1,10,10,1]))],new Me(new we(new _e(1,1,0,.5)))),r=new wt([e,t,i]),s=new si("RenderTest",this,new P(9,9),0);this.render(r,_e.Green,{target:s});const n=s.tryConvertToBufferRGBA();s.release();let o=!0,a=[];if(n){const e=[{x:1,y:4,r:255,g:0,b:0,a:255,tolerence:1},{x:4,y:1,r:0,g:255,b:0,a:255,tolerence:1},{x:7,y:4,r:0,g:0,b:255,a:255,tolerence:1},{x:4,y:7,r:255,g:128,b:0,a:255,tolerence:2}];for(let t of e){const e=4*(t.x+9*(8-t.y));(Math.abs(n[e]-t.r)>t.tolerence||Math.abs(n[e+1]-t.g)>t.tolerence||Math.abs(n[e+2]-t.b)>t.tolerence||Math.abs(n[e+3]-t.a)>t.tolerence)&&(o=!1,a.push({expectedValues:t,actualValues:{r:n[e],g:n[e+1],b:n[e+2],a:n[e+3]}}))}}return{fSucceeded:o,triangleTestDifferences:a}}getWebGLState(){var e;return null===(e=this.m_graphicsProcessor)||void 0===e?void 0:e.getWebGLState()}}function as(e,t){if(!e)return;const i=e&&e.constructor?e.constructor.name:void 0,r=t.split(".");let s=e;for(let e of r)s=s?s[e]:void 0;return(i||"")+(s?" "+s:"")}function ls(e){return 1==e.getType()?Ct(e,!1):Pt(e,!1,0,0,e.transform.toInverseMatrix3())}function hs(e){return e?e.memoryUsage:0}function cs(e,t){e&&(e instanceof si&&e.tag?t.otherBrushes+=hs(e):2!=e.releasePolicy?t.managedImages+=hs(e):t.externalImages+=hs(e))}function ds(e,t,i,r=!1){var s;const n=e.ensureRenderNode(t);if(n.cache){for(let e of n.cache.distanceFields||[])e.texture&&(r?i.textDistanceFields+=hs(e.texture):i.shapeDistanceFields+=hs(e.texture));cs(n.cache.resolvedFillTexture,i),cs(n.cache.resolvedLineTexture,i),cs(n.cache.resolvedPictureTexture,i),i.effects+=hs(n.cache.innerShadowTexture),i.effects+=hs(n.cache.softEdgesTexture),i.effects+=hs(n.cache.glowTexture),i.effects+=hs(n.cache.shadowTexture),i.effects+=hs(n.cache.reflectionTexture),i.fadeMasks+=hs(n.cache.fadeTexture),i.rasterizedItems+=hs(n.cache.spriteTexture)}if(t instanceof bt&&(null===(s=t.text)||void 0===s?void 0:s.cache)){const r=t.text.cache;r.textShapes.forEach((t=>{ds(e,t,i,!0)})),r.hitTestLineShapes.forEach((t=>{ds(e,t,i,!0)})),r.selectionShapes&&r.selectionShapes.forEach((t=>{ds(e,t,i,!0)}))}t instanceof wt&&t.items.elements.forEach((t=>{ds(e,t,i)}))}function us(e,t,i){for(let r of t.elements)for(let t of r.keyFrames)if(t){const r=e.ensureMorphKeyFrameRenderData(t);r.texture&&(i.morphTextures+=hs(r.texture))}}function fs(e,t,i,r,s,n,o,a,l,h,c,d,u,f){const p=r?r.texture:void 0,m=E.ScaleTranslation2D(n,n.scale(.5).subtract(a)),g=m,v=E.Translation2D(a),_=m.multiply(vi(i,o)),y=p?m.multiply(vi(p,o)):E.Identity,b=t.getBabylonEffect();b.setMatrix3x3("u_0",g.m),b.setMatrix3x3("u_1",v.m),b.setMatrix3x3("u_2",_.m),b.setMatrix3x3("u_3",y.m),b.setVector2("u_4",n),b.setInt("ufrag_0",r?1:0),b.setVector2("ufrag_1",r?r.size.inverse().scale(r.contentQuality):P.Zero),b.setFloat("ufrag_2",r?2*r.distRangeSize:0),b.setFloat("ufrag_3",r?-r.distRangeSize+.5*h:0),b.setVector2("ufrag_4",l);const w=new Array(16);w.fill(0);const T=new Array(12);T.fill(0);const x=new Array(16);if(x.fill(0),c)for(let e=0;e<Math.min(c.lights.length,4);e++){const t=c.lights[e],i=Math.sqrt(t.direction.x*t.direction.x+t.direction.y*t.direction.y+t.direction.z*t.direction.z);w[4*e]=Math.abs(t.color.r),w[4*e+1]=Math.abs(t.color.g),w[4*e+2]=Math.abs(t.color.b),w[4*e+3]=Math.abs(t.color.a),T[3*e]=t.direction.x/i,T[3*e+1]=t.direction.y/i,T[3*e+2]=t.direction.z/i,x[4*e]=t.wrapScale,x[4*e+1]=t.wrapOffset,x[4*e+2]=t.diffuse,x[4*e+3]=t.specular}b.setDirectColor4("ufrag_5",c?c.ambientColor:_e.Black),b.setArray4("ufrag_6",w),b.setArray3("ufrag_7",T),b.setArray4("ufrag_8",x),b.setDirectColor4("ufrag_9",d?d.diffuseColor:_e.Black),b.setDirectColor4("ufrag_10",d?d.specularColor:_e.Black),b.setDirectColor4("ufrag_11",d?d.ambientColor:_e.Black),b.setDirectColor4("ufrag_12",d?d.emissiveColor:_e.Black),d?b.setFloat4("ufrag_13",d.specularPower,d.useBlinnHighlight?1:0,d.diffuseFresnel,d.alphaFresnel):b.setFloat4("ufrag_13",0,0,0,0),b.setInt("ufrag_14",d?d.materialType:0),b.setFloat("ufrag_15",f),b.setDirectColor4("ufrag_16",u);const C=v?v.transformVector(P.One.scale(Math.sqrt(2)/2)).length():1;b.setFloat("ufrag_17",1/C),t.setTexture("t_0",i.tryUseBabylonTexture(e,void 0,"draw3D:T")),t.setTexture("t_1",p?p.tryUseBabylonTexture(e,void 0,"draw3D:D"):void 0),t.setTexture("t_2",s?s.tryUseBabylonTexture(e,void 0,"draw3D:P"):void 0),t.drawQuadInstances(1)}function ps(e){return Math.round(1e3*(e+100*Number.EPSILON))/1e3}class ms{sendTraceTag(e,t,i,r){10===i?(0,T.H)(e,r):(0,T.PN)(e,r)}shipAssertTag(e,t,i,r){i&&(0,T.H)(e,r)}debugAssertTag(e,t,i,r){i&&(0,T.H)(e,r)}}class gs{get webGLContext(){return this._webGLContext}constructor(e){var t;this._isRendererReady=!1,this._webGLContextRestoredStartTime=0,this._webGLContextLostStartTime=0,this.handleContextNotRestored=()=>{this._webGLContextLostStartTime>this._webGLContextRestoredStartTime&&(0,T.H)(0,"webglcontext not restored after 3seconds")},(0,T.PN)(0,"ShapeBuilderContext ctor"),t=new ms,O.setLogger(t),this._shapeBuilderConfig=e,this._renderer=function(e={}){return function(e={}){return new os(e)}(e)}({stateRestorer:(!0,new jr(!0))})}async setupWebGLContext(){const e=this.shapeBuilderConfig.webGLCanvas,t={preserveDrawingBuffer:this.shapeBuilderConfig.preserveDrawingBuffer};let i=e.getContext("webgl",t);return i=void 0!==i?i:e.getContext("experimental-webgl",t),this._webGLContext=i,this._webGLContextRestoredStartTime=performance.now(),this.preloadShaders(i)}handleContextLost(){this._webGLContextLostStartTime=performance.now(),(0,T.PN)(0,"webgl context is lost."),this._isRendererReady=!1,this._renderer.onWebGLContextLost(),this._webGLContext=void 0,window.setTimeout(this.handleContextNotRestored,3e3),this._shapeBuilderConfig.webGLContextLostHandler.onWebGLContextLost()}async handleContextRestored(){this._webGLContextRestoredStartTime=performance.now();const e=this._webGLContextRestoredStartTime-this._webGLContextLostStartTime;(0,T.PN)(0,`webgl context is being restored. ${e}MS`),await this.setupWebGLContext(),void 0===this._webGLContext?(0,T.H)(0,"unable to restore webGLContext"):this._shapeBuilderConfig.webGLContextLostHandler.onWebGLContextRestored();const t=performance.now();(0,T.PN)(0,`webglcontext restored successfully. ${t-this._webGLContextRestoredStartTime}MS`)}getScenePerformanceSummaryAsMap(){var e;const t=(null===(e=this.renderer)||void 0===e?void 0:e.getPerformanceSummary()).perfInfoCurrentFrame;return new Map(Object.entries(null!=t?t:{}))}async preloadShaders(e){void 0===e&&(0,T.H)(0,"webglcontext is undefined");const t=new x("ShapeBuilderContext.preloadShaders"),i=performance.now();try{await this._renderer.initializeAsync(e),this._isRendererReady=!0}catch(e){(0,T.H)(0,`exception in preloadshaders: ${e.message}`)}finally{t.setProp("shaderCompilationDurationMilliseconds",performance.now()-i).complete()}}get shapeBuilderConfig(){return this._shapeBuilderConfig}get renderer(){return this._renderer}get isRendererReady(){return this._isRendererReady}get activeMultiplexRenderTarget(){return this._activeMultiplexRenderTarget}set activeMultiplexRenderTarget(e){if(void 0===e)throw new Error("Cannot set an undefined render target");this._activeMultiplexRenderTarget=e}}var vs=s(4874);let _s={logKpiUsage(){},logKpiSuccess(){},logKpiFailure(){}};function ys(e,t=new Map,i="gc2kpi"){_s.logKpiUsage(e,0,t,i)}var bs=s(3849),ws=s(4016),Ts=s(3331),xs=s(4591);class Cs{constructor(e){this.pptLogger=e}logOperation(e){this.pptLogger.logTrace(0,ws.r.Operation,Ts.G.Info,function(e){const t={name:e.name,durationMs:e.durationMs.toString()};if(void 0!==e.props)for(const i of e.props)t[i[0]]=i[1];return JSON.stringify(t)}(e))}logTrace(e){this.pptLogger.logTrace(e.id,ws.r.General,function(e){switch(e){case 0:return Ts.G.Error;case 1:return Ts.G.Warning;case 2:return Ts.G.Info;case 3:return Ts.G.Verbose;default:(0,xs.t)(e)}}(e.level),e.message)}}let Ps,Ss=[],Es=[];async function Ms(e,i){var r;await async function(e){const i=t();if(void 0===i)throw new Error("Augloop session manager is undefined.");await Promise.all(e.map((e=>i.activateAnnotation(e))))}(e),r=i,void 0!==Ps?r.forEach((e=>null==Ps?void 0:Ps.set(e[0],e[1]))):Ps=new Map(r)}async function Rs(e,i){await async function(e){const i=t();if(void 0===i)throw new Error("Augloop session manager is undefined.");await Promise.all(e.map((e=>i.deactivateAnnotation(e))))}(e),void 0!==Ps&&i.forEach((e=>null==Ps?void 0:Ps.delete(e[0])))}class Bs{constructor(e,t,i){this.succeeded=e,this.result=t,this.error=i}}class Is{constructor(e){this.supportedOpTypes=e.supportedOpTypes,this.client=e}async executeOp(e,t){if(!this.supportedOpTypes.includes(e.opType))return new Bs(!1,void 0,{message:`Operation ${e.opType} not supported by client`});let i;const r=performance.now();let s;try{const r=new Promise(((e,i)=>{s=setTimeout((()=>{i(new Error(`Timeout: Picture AI Operation execution exceeded ${t}ms`))}),t)}));i=await Promise.race([this.client.execute(e),r])}catch(e){i=new Bs(!1,void 0,{message:e.message})}finally{clearTimeout(s)}const n=performance.now()-r;return i.opExecutionTimeInMs=n,i}}const As="BackgroundRemoval";class Fs{constructor(e,t,i,r){this.opType=e,this.params=t,this.opParamsProcessor=i,this.opResultProcessor=r}}async function ks(e){return new Promise(((t,i)=>{const r=new FileReader;r.onload=()=>{t(new URL(r.result))},r.onerror=()=>{i(new Error("FileReader failed to read blob"))},r.readAsDataURL(e)}))}class Ds{constructor(e){this.kind=0,this.url=e}async toDataURL(){return async function(e){if("data:"===e.protocol)return e;const t=await fetch(e.href);return t.ok||(0,y._)(0,`urlToDataURL: Failed to fetch url. Response status [${t.status}] | Protocol [${e.protocol}] `),ks(await t.blob())}(this.url)}}async function Ls(e,t){return new Promise(((i,r)=>{e.onload=i,e.onerror=()=>{r("image.onerror")},e.src=t}))}async function Os(e,t,i,r,s){try{const n=document.createElement("img");await Ls(n,e.href);const[o,a]=function(e,t,i){let r,s;if(t>0){if(!i)return[t,t];const n=e.naturalWidth/e.naturalHeight;[r,s]=n>1?[t,t/n]:[t*n,t]}else[r,s]=[e.naturalWidth,e.naturalHeight];return[r,s]}(n,t,i),l=function(e,t,i){const r=document.createElement("canvas");[r.width,r.height]=[t,i];const s=r.getContext("2d");return null==s||s.drawImage(e,0,0,t,i),r}(n,o,a);return Us(l,r,s)}catch(e){(0,y._)(0,`downsampleImage: Error - ${e.message}`)}}async function Us(e,t,i){return new Promise(((r,s)=>{switch(t){case 0:return void e.toBlob((e=>{null===e?s("no blob received"):r(e)}),i);case 1:const n=e.toDataURL(i);return void r(new URL(n));default:(0,y._)(0,`renderCanvasToBlob: Error - unknown outputResultRepresentation: ${t}`)}}))}async function Vs(e){const t=document.createElement("canvas"),i=t.getContext("2d");if(null===i)throw new Error("getImageData: canvas context is null");const r=new Image;r.crossOrigin="",await Ls(r,e.href),t.height=r.height,t.width=r.width,i.drawImage(r,0,0);const s=i.getImageData(0,0,r.width,r.height),n=s.data,o=n.length;for(let e=0;e<o;e+=4)n[e+3]=n[e];return i.putImageData(s,0,0),t}async function Ns(e,t,i,r,s){let n,o;const a=await e.toDataURL();return i&&(n=async e=>Object.assign(Object.assign({},e),{picture:new Ds(await Os(a,512,!1,1,"image/png"))})),r&&"RemoveBackground"===t&&(o=async e=>{const t=await async function(e,t,i,r="image/jpeg"){try{const s=document.createElement("canvas"),n=s.getContext("2d");if(null===n)throw new Error("applyBackgroudRemovedMaskToImage: canvas context is null");const o=new Image;await Ls(o,e.href),s.width=o.width,s.height=o.height,n.drawImage(o,0,0,s.width,s.height);const a=await Vs(t);return n.globalCompositeOperation="destination-in",n.drawImage(a,0,0,s.width,s.height),Us(s,i,r)}catch(e){(0,y._)(0,`applyBackgroudRemovedMaskToImage: Error -  ${e.message}`)}}(a,await e.picture.toDataURL(),1,"image/png");return Object.assign(Object.assign({},e),{picture:new Ds(t)})}),r&&"BlurBackground"===t&&(o=async e=>{const t=await async function(e,t,i,r,s="image/jpeg"){try{const n=document.createElement("canvas"),o=n.getContext("2d");if(null===o)throw new Error("applyBackgroundRemovedMaskAndBlurredImageToImage: canvas context is null");const a=new Image;await Ls(a,e.href),n.width=a.width,n.height=a.height,o.drawImage(a,0,0,n.width,n.height);const l=await Vs(t);o.globalCompositeOperation="destination-in",o.drawImage(l,0,0,n.width,n.height);const h=function(e,t){const i=document.createElement("canvas"),r=i.getContext("2d");if(null===r)throw new Error("getImageData: canvas context is null");return i.width=e.width,i.height=e.height,r.filter=`blur(${t}px)`,r.drawImage(e,0,0,i.width,i.height),i}(a,i);return o.globalCompositeOperation="destination-over",o.drawImage(h,0,0,n.width,n.height),Us(n,r,s)}catch(e){(0,y._)(0,`applyBackgroundRemovedMaskAndBlurredImageToImage: Error -  ${e.message}`)}}(a,await e.picture.toDataURL(),null!=s?s:8,1,"image/png");return Object.assign(Object.assign({},e),{picture:new Ds(t)})}),new Fs(As,{picture:e,useMask:r},n,o)}class Gs{constructor(e){Gs.assign(Gs,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}static getAllTypesFor(e){const t=Gs.getTypeNameFor(e);return t?[t,...Gs.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,t){if(!Array.isArray(t)||0===t.length)return!0;const i=Gs.getTypeNameFor(e),r=Gs.getBaseTypesFor(e);for(const e of t){if(e===i)return!0;if(r.indexOf(e)>=0)return!0}return!1}static assign(e,t,i){if(i)for(const e of Object.keys(i))t[e]=i[e];return t.H_=e.H_,t}}Gs.H_={T_:Gs.getTypeName(),B_:Gs.getBaseTypes()};class zs{constructor(e){Gs.assign(zs,this,e)}static getTypeName(){return"AugLoop_AcsImageTransform_BaseSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return Gs.matchesTypesFor(e,[zs.getTypeName()])}}zs.H_={T_:zs.getTypeName(),B_:zs.getBaseTypes()};class Hs{constructor(e){Gs.assign(Hs,this,e)}static getTypeName(){return"AugLoop_AcsImageTransform_ACSBackgroundRemovalSignal"}static getBaseTypes(){return["AugLoop_AcsImageTransform_BaseSignal","AugLoop_Signals_Signal"]}static typeGuard(e){return Gs.matchesTypesFor(e,[Hs.getTypeName()])}}var Ws,$s,qs;Hs.H_={T_:Hs.getTypeName(),B_:Hs.getBaseTypes()},function(e){e.BackgroundRemoval="backgroundRemoval",e.ForegroundMatting="foregroundMatting"}(Ws||(Ws={}));class js{constructor(e){Gs.assign(js,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_AcsImageTransform_BaseAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return Gs.matchesTypesFor(e,[js.getTypeName()])}}js.H_={T_:js.getTypeName(),B_:js.getBaseTypes()};class Xs{constructor(e){Gs.assign(Xs,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_AcsImageTransform_ACSBackgroundRemovalAnnotation"}static getBaseTypes(){return["AugLoop_AcsImageTransform_BaseAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return Gs.matchesTypesFor(e,[Xs.getTypeName()])}}Xs.H_={T_:Xs.getTypeName(),B_:Xs.getBaseTypes()},function(e){e.BlobDataUndefined="BLOB_DATA_UNDEFINED",e.GetBlobFailed="GET_BLOB_FAILED",e.SessionMangerUndefined="SESSION_MANAGER_UNDEFINED",e.SubmitSignalFailed="SUBMIT_SIGNAL_FAILED"}($s||($s={}));class Ys extends Error{constructor(e,t,i){super(e),this.message=e,this.errorType=t,this.httpStatusCode=i}}async function Ks(e,t){if(void 0===e)throw new Ys("Blob is undefined",$s.BlobDataUndefined);return ks(await async function(e,t){if(void 0!==e.data)return new Blob([Zs(e.data)]);if(void 0===e.dataPointer)throw new Ys("Blob is empty",$s.BlobDataUndefined);if(l("useALBlobAPI")&&void 0!==t.requestBinaryDataForBlob)return new Blob([await t.requestBinaryDataForBlob(e)]);if(void 0!==t.getBlob)return t.getBlob(e.dataPointer.value);throw new Ys("IAugLoopSessionManager not implemented",$s.BlobDataUndefined)}(e,t))}function Zs(e){const t=e;if("Buffer"!==t.type||!Array.isArray(t.data))throw new Ys("Invalid buffer",$s.BlobDataUndefined);return new Uint8Array(t.data)}function Js(e,t,i){return r=>{const s=r,n=s.errorDetails;void 0===n?Ks(s.blob,i).then(e).catch(t):t(new Ys(n.message,n.errorType,n.httpStatusCode))}}class Qs{constructor(e){Gs.assign(Qs,this,e)}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static getBaseTypes(){return[]}static typeGuard(e){return Gs.matchesTypesFor(e,[Qs.getTypeName()])}}Qs.H_={T_:Qs.getTypeName(),B_:Qs.getBaseTypes()};class en{constructor(e){Gs.assign(en,this,e)}static getTypeName(){return"AugLoop_Image_ImageContent"}static getBaseTypes(){return["AugLoop_Core_Blob"]}static typeGuard(e){return Gs.matchesTypesFor(e,[en.getTypeName()])}}en.H_={T_:en.getTypeName(),B_:en.getBaseTypes()};class tn{constructor(e){Gs.assign(tn,this,e)}static getTypeName(){return"AugLoop_Image_ImageTile"}static getBaseTypes(){return["AugLoop_Image_ImageTileMetadata"]}static typeGuard(e){return Gs.matchesTypesFor(e,[tn.getTypeName()])}}function rn(e){return function(e){return"image/gif"===(null==e?void 0:e.toLowerCase())}(e)||function(e){return"image/apng"===(null==e?void 0:e.toLowerCase())}(e)}function sn(e){return"image/svg+xml"===(null==e?void 0:e.toLowerCase())}function nn(e){let t="";if("data:"===e.protocol){const i=/.*:(.*);.*/,r=e.href.substring(0,50).match(i);null!==r&&r.length>=2&&(t=r[1])}else t=e.pathname.substring(e.pathname.lastIndexOf(".")+1);return on(t)}function on(e){switch(null==e?void 0:e.toLowerCase()){case"image/bmp":case"bmp":return"image/bmp";case"image/gif":case"gif":return"image/gif";case"image/jpeg":case"image/jpg":case"jpeg":case"jpg":return"image/jpeg";case"image/png":case"png":return"image/png";case"image/apng":case"apng":return"image/apng";case"image/svg+xml":case"svg":return"image/svg+xml";case"image/tiff":case"tiff":return"image/tiff";default:return void(0,T.PN)(0,`Unknown extension or mimeType ${e}`)}}tn.H_={T_:tn.getTypeName(),B_:tn.getBaseTypes()};var an=new Uint8Array(16);function ln(){if(!qs&&!(qs="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return qs(an)}const hn=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,cn=function(e){return"string"==typeof e&&hn.test(e)};for(var dn=[],un=0;un<256;++un)dn.push((un+256).toString(16).substr(1));const fn=function(e,t,i){var r=(e=e||{}).random||(e.rng||ln)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(var s=0;s<16;++s)t[i+s]=r[s];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(dn[e[t+0]]+dn[e[t+1]]+dn[e[t+2]]+dn[e[t+3]]+"-"+dn[e[t+4]]+dn[e[t+5]]+"-"+dn[e[t+6]]+dn[e[t+7]]+"-"+dn[e[t+8]]+dn[e[t+9]]+"-"+dn[e[t+10]]+dn[e[t+11]]+dn[e[t+12]]+dn[e[t+13]]+dn[e[t+14]]+dn[e[t+15]]).toLowerCase();if(!cn(i))throw TypeError("Stringified UUID is invalid");return i}(r)};var pn,mn;!function(e){e[e.Unspecified=0]="Unspecified",e[e.Other=1]="Other",e[e.Jpg=2]="Jpg",e[e.Png=3]="Png",e[e.Bmp=4]="Bmp"}(pn||(pn={})),function(e){e[e.Unspecified=0]="Unspecified",e[e.Other=1]="Other",e[e.Small=2]="Small",e[e.Medium=3]="Medium",e[e.Large=4]="Large"}(mn||(mn={}));const gn=new Map([["image/bmp",pn.Bmp],["image/jpeg",pn.Jpg],["image/png",pn.Png]]);function vn(e){var t;return void 0===e?pn.Unspecified:null!==(t=gn.get(e))&&void 0!==t?t:pn.Other}function _n(e,t,i){const r=e.split(",")[1],s=Uint8Array.from(atob(r),(e=>e.charCodeAt(0))),n=nn(new URL(e));return new tn({widthPx:null!=t?t:0,heightPx:null!=i?i:0,contents:[{format:vn(n),size:0,id:fn(),sizeBytes:s.length,data:s}]})}async function yn(e,t,i,r,s){return l("useALBlobAPI")?new Promise(((s,n)=>{var o;null===(o=e.submitLargeBinaryDataMessageWithCallback)||void 0===o||o.call(e,t,i,r(s,n,e),fn()).catch((e=>{n(e)}))})):new Promise(((n,o)=>{var a;null===(a=e.submitBinarySignal)||void 0===a||a.call(e,t,i,r(n,o,e),fn(),s).catch((e=>{o(e)}))}))}var bn;!function(e){e[e.SuperResolution=0]="SuperResolution",e[e.ImageStylizer=1]="ImageStylizer",e[e.BackgroundRemover=2]="BackgroundRemover",e[e.OneClickEnhancer=3]="OneClickEnhancer",e[e.AutoFocus=4]="AutoFocus",e[e.StyleReference=5]="StyleReference"}(bn||(bn={}));class wn{constructor(e){Gs.assign(wn,this,e)}static getTypeName(){return"AugLoop_ImageTransform_ImageTransformSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return Gs.matchesTypesFor(e,[wn.getTypeName()])}}wn.H_={T_:wn.getTypeName(),B_:wn.getBaseTypes()};class Tn{constructor(e){Gs.assign(Tn,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ImageTransform_ImageTransformAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return Gs.matchesTypesFor(e,[Tn.getTypeName()])}}function xn(e,t,i){return r=>{const s=r;void 0===s.error?Ks(s.blob,i).then(e).catch(t):t(new Error(s.error))}}Tn.H_={T_:Tn.getTypeName(),B_:Tn.getBaseTypes()};class Cn{constructor(){this.useAugloopCogSciForBGR=!0}static getInstance(){return void 0===Cn.instance&&(Cn.instance=new Cn),Cn.instance}}async function Pn(e){const i=void 0!==e.opParamsProcessor?await e.opParamsProcessor(e.params):e.params,r=Cn.getInstance().useAugloopCogSciForBGR?await async function(e,i,r,s,n){const o=t();void 0===o&&(0,y._)(0,"Augloop session manager undefined");const a=_n(e,void 0,void 0);return yn(o,new Hs({image:a,mode:!0===i?Ws.ForegroundMatting:Ws.BackgroundRemoval,apiVersion:"2023-02-01-preview"}),Xs.getTypeName(),Js)}((await i.picture.toDataURL()).href,i.useMask):await async function(e,i=!0,r,s,n){return async function(e,i){const r=t();return void 0===r&&(0,y._)(0,`getIASImageTransformSignalResult: ImageTransformScenario[${e.scenario}] - Augloop session manager undefined`),yn(r,e,Tn.getTypeName(),xn,i)}(function(e,t,i,r,s,n){return new wn({sourceCorrelationId:fn(),imageTile:_n(t,i,r),scenario:e,endpointName:"GC2",sendMaskAsResponse:s,filter:void 0})}(bn.BackgroundRemover,e,r,s,i),n)}((await i.picture.toDataURL()).href,e.params.useMask);return void 0===e.opResultProcessor?{succeeded:!0,result:{picture:new Ds(r)}}:{succeeded:!0,result:await e.opResultProcessor({picture:new Ds(r)})}}class Sn{constructor(){this.name="AugloopPPTClient",this.supportedOpTypes=[As]}static getInstance(){return void 0===Sn.instance&&(Sn.instance=new Sn),Sn.instance}async execute(e){if(function(e){return e.opType===As}(e))return Pn(e);throw new Error("Not yet implemented")}}const En=[[As,()=>{return e=Sn.getInstance(),new Is(e);var e}]];class Mn{}class Rn{constructor(e=[],t=[],i=[]){this.type=Mn,this.added=e,this.removed=t,this.changed=i}}class Bn{}class In{constructor(e){this.type=Bn,this.modelUpdated=new c,this.graphics=[],this._backIndex=0,this.idToGraphic=new Map,this.hostContext=e}get length(){return this.graphics.length}get backIndex(){return this._backIndex}set backIndex(e){this._backIndex=e}getGraphic(e){return this.idToGraphic.get(e)}getGraphicAt(e){return this.graphics[e]}addGraphicsAt(e){const t=[];for(const[i,r]of e)this.idToGraphic.has(i.id)||(this.graphics.splice(r,0,i),this.idToGraphic.set(i.id,i),t.push(i));this.modelUpdated.emit(new Rn(t))}addGraphics(e){const t=e.filter((e=>!this.idToGraphic.has(e.id)));if(!(t.length<=0)){for(const e of t)this.graphics.push(e),this.idToGraphic.set(e.id,e);this.modelUpdated.emit(new Rn(t))}}removeGraphics(e){const t=e.filter((e=>this.idToGraphic.delete(e.id)));if(t.length<=0)return;const i=new Set(t);this.graphics=this.graphics.filter((e=>!i.has(e))),this.modelUpdated.emit(new Rn([],t))}setGraphics(e){const t=this.graphics;this.graphics=[],this.idToGraphic.clear();for(const t of e)this.graphics.push(t),this.idToGraphic.set(t.id,t);return(t.length>0||e.length>0)&&this.modelUpdated.emit(new Rn([...e],t)),t}changeGraphicOrder(e,t){const i=this.getGraphicOrder(e);if(void 0===i)return;let r;switch(t){case 0:r=Math.min(i+1,this.graphics.length-1);break;case 1:r=this.graphics.length-1;break;case 2:r=Math.max(i-1,this._backIndex);break;case 3:r=this._backIndex;break;default:(0,xs.t)(t)}return i!==r&&(this.graphics.splice(i,1),this.graphics.splice(r,0,e),this.modelUpdated.emit(new Rn([],[],[e]))),i}getGraphicOrder(e){if(this.idToGraphic.has(e.id))return this.graphics.indexOf(e)}setGraphicOrder(e,t){const i=this.getGraphicOrder(e);if(void 0!==i)return i!==t&&(this.graphics.splice(i,1),this.graphics.splice(t,0,e),this.modelUpdated.emit(new Rn([],[],[e]))),i}[Symbol.iterator](){return this.graphics[Symbol.iterator]()}clone(e=(e=>e.id)){const t=new In(this.hostContext);return t.graphics=this.graphics.map((t=>t.clone(e(t)))),t._backIndex=this._backIndex,t.graphics.forEach((e=>{t.idToGraphic.set(e.id,e)})),t}}var An,Fn=s(2082);!function(e){e[e.Base64Image=0]="Base64Image",e[e.ShapeBuilderJson=1]="ShapeBuilderJson",e[e.ChartPlayerJson=2]="ChartPlayerJson"}(An||(An={}));class kn{get themeInfo(){return this._themeInfo}set themeInfo(e){this._themeInfo=e,this.modelHostContextUpdated.emit([0])}constructor(e){this.modelHostContextUpdated=new c,this.themeInfo=e}}class Dn{}class Ln{constructor(e=new _){this.type=Dn,this.anchorUpdated=new c,this._transform=e}get transform(){return this._transform}set transform(e){this._transform=e,this.anchorUpdated.emit()}setTransform(e,t){this._transform=e,this.anchorUpdated.emit(t)}clone(){const e=new Ln(this._transform.clone());return e.locks=void 0!==this.locks?Object.assign({},this.locks):void 0,e}}var On=s(2661);class Un extends On.B{createRenderDataPresenter(e,t,i){void 0===e.model.fallbackRenderData&&(0,y._)(0,"Trying to create RenderDataPresenter without fallback RenderData.");const r=this.get(e.model.fallbackRenderData.type);return void 0===r&&(0,y._)(0,`No RenderDataPresenterCreator for render data type: ${e.model.fallbackRenderData.type}`),r(e,t,i)}}class Vn{constructor(){this.viewReady=new c,this.pendingPresenters=new Set}addPending(e){const t=0===this.pendingPresenters.size;this.pendingPresenters.add(e),t&&this.viewReady.emit(!1)}removePending(e){this.pendingPresenters.delete(e),0===this.pendingPresenters.size&&this.viewReady.emit(!0)}teardown(){this.pendingPresenters.clear()}}class Nn extends On.B{createPresenter(e,t,i){const r=this.get(e.model.type);return void 0===r&&(0,y._)(0,`No PresenterCreator for modeltype: ${e.model.type}`),r(e,t,i)}}class Gn extends On.B{createAnchorPresenter(e){const t=this.get(e.anchor.type);return void 0===t&&(0,y._)(0,`No AnchorPresenterCreator for AnchorType: ${e.anchor.type}`),t(e)}}class zn extends On.o{beginRender(){for(const e of this)e.beginRender()}endRender(){for(const e of this)e.endRender()}addViewModel(e,t){var i;if(null===(i=this.filter)||void 0===i?void 0:i.filter(e))return;const r=this.get(e.type);void 0===r&&(0,y._)(0,`No registered RenderTarget for ViewModel type: ${e.type}`),r.addViewModel(e,t)}beginGroup(e){for(const t of this)t.beginGroup(e)}endGroup(){for(const e of this)e.endGroup()}hitTest(e,t){for(const i of this){const r=i.hitTest(e,t);if(void 0!==r)return r}}}class Hn extends On.B{createSelection(e){const t=this.get(e.model.type);if(void 0===t)throw new Error(`Can't create selection for graphic: ${e.model.type}`);return t(e)}registerForType(e,t){this.register(e,t)}}class Wn extends On.B{createSelectionPresenter(e,t,i){const r=this.get(e.type);if(void 0===r)throw new Error(`Can't create presenter for selection: ${e.type}`);return r(e,t,i)}}class $n{constructor(e,t=[]){this.performed=e,this.editOps=t}}class qn extends On.B{constructor(){super(...arguments),this.defaultDispatcher=new jn}register(e,t){return super.register(e,t)}processKeyboardEvent(e,t,i){var r;const s=this.get(t.type);return void 0===s?{isHandled:!1}:(null!==(r=s.dispatcher)&&void 0!==r?r:this.defaultDispatcher).dispatchKeyboardEvent(e,t,i,s.keyboardShortcuts)}performAction(e,t,i){var r;const s=this.get(t.type);return void 0===s?new $n(!1):(null!==(r=s.dispatcher)&&void 0!==r?r:this.defaultDispatcher).dispatchAction(e,t,i,s.actions)}}class jn{dispatchAction(e,t,i,r){return r.performAction(e,t,i)}dispatchKeyboardEvent(e,t,i,r){return"keydown"===e.type?r.performShortcut(e,t,i):{isHandled:!1}}}class Xn extends On.B{createAriaLabel(e){const t=this.get(e.model.type);if(void 0!==t)return t(e)}}class Yn extends On.B{createAccessibleNode(e){const t=this.get(e.model.type);if(void 0!==t)return t(e)}}class Kn{constructor(){this.combinedScaleChanged=new c,this.viewTransformChanged=new c,this._zoomFactor=1,this._lastCombinedScale=1,this._lastViewTransform=new _}set zoomFactor(e){const t=e*this.deviceScaleFactor;this._zoomFactor=e,this._lastCombinedScale!==t&&(this._lastCombinedScale=t,this.combinedScaleChanged.emit())}get zoomFactor(){return this._zoomFactor}get combinedScale(){return this.zoomFactor*this.deviceScaleFactor}get deviceScaleFactor(){return 1/window.devicePixelRatio}get viewTransform(){return this._lastViewTransform}set viewTransform(e){this._lastViewTransform.equals(e)||(this._lastViewTransform=e.clone(),this.viewTransformChanged.emit())}}class Zn{constructor(e,t,i){this.id=e,this.model=t,this.anchor=i}clone(e){return new Zn(e,this.model.clone(),this.anchor.clone())}}function Jn(e){const t=[];for(const i of e){const e=i.perform().undoOp;void 0!==e&&t.push(e)}return t.reverse()}class Qn{}class eo{constructor(){this.type=Qn}}class to{constructor(e,t,i){this.onKeyboardEvent=(e,t)=>{let i=this.editContext.editorRegistry.processKeyboardEvent(e,this.selection,this.editContext).isHandled;i||void 0===this.keyboardEventProcessor||(i=this.keyboardEventProcessor(e,this.selection,this.editContext).isHandled),t.isHandled=i,t.isHandled&&(e.preventDefault(),e.stopPropagation())},this.editContext=e,this.keyboardEventProcessor=i,this.keyboardEventNotifiers=t,this.keyboardEventNotifiers.keydown.on(this.onKeyboardEvent),this.keyboardEventNotifiers.keyup.on(this.onKeyboardEvent)}teardown(){this.selection.teardown(),this.keyboardEventNotifiers.keydown.off(this.onKeyboardEvent),this.keyboardEventNotifiers.keyup.off(this.onKeyboardEvent)}performAction(e){return function(e,t,i,r){var s;const n=t.save(),o=function(e){return"acLst"===e.actionType}(e)?e.actions:[e],a=[];for(const e of o)a.push(...r(e,t,i).editOps);const l=Jn(a),h=t.save();return{editOps:l,savedSelectionBefore:null!=n?n:new eo,savedSelectionAfter:null!=h?h:new eo,mergePolicy:null===(s=a[0])||void 0===s?void 0:s.mergePolicy}}(e,this.selection,this.editContext,this.editContext.editorRegistry.performAction.bind(this.editContext.editorRegistry))}performUndoEntry(e){const t={editOps:Jn(e.editOps),savedSelectionBefore:e.savedSelectionAfter,savedSelectionAfter:e.savedSelectionBefore};return this.selection.restore(e.savedSelectionBefore),t}resetSelection(e){this.selection=e}}function io(e,t){e.forEach((e=>{e.addTimePoint(t)}))}class ro{constructor(e,t){this.startTimeMs=0,this.causation=e,this.trackers=t,this.startTimeMs=performance.now()}complete(){const e=Math.max(performance.now()-this.startTimeMs,0);this.trackers.forEach((t=>{t.addEventContext(this.causation,e)}))}}const so="View.Render";class no{constructor(){this.registry=new Map}registerPerformer(e,t,i){const r=JSON.stringify([e.name,t.name]);return this.registry.set(r,i),this}performReplacePreview(e,t,i,r){const s=JSON.stringify([e.type.name,t.model.type.name]),n=this.registry.get(s);if(void 0===n)throw new Error(`No performer registered to preview replace ${t.model.type.name} with ${e.type.name}`);n(e,t,i,r)}}class oo{constructor(){this.registry=new Map}registerPerformer(e,t,i){const r=JSON.stringify([e.name,t.name]);return this.registry.set(r,i),this}get(e,t){return this.registry.get(JSON.stringify([e.name,t.name]))}performReplace(e,t){const i=JSON.stringify([e.type.name,t.model.type.name]),r=this.registry.get(i);if(void 0===r)throw new Error(`No performer registered to replace ${t.model.type.name} with ${e.type.name}`);r(e,t)}}class ao{constructor(e){this.looping=!1,this.loopingId=-1,this.onceId=-1,this.window=null!=e?e:window}start(e){const t=()=>{e(),this.looping?this.loopingId=this.window.requestAnimationFrame(t):this.loopingId=-1};this.looping=!0,-1!==this.loopingId&&this.window.cancelAnimationFrame(this.loopingId),this.loopingId=this.window.requestAnimationFrame(t)}stop(){this.looping=!1}runOnce(e){-1!==this.onceId||this.looping||(this.onceId=this.window.requestAnimationFrame((()=>{e(),this.onceId=-1})))}stopOnce(){-1!==this.onceId&&(this.window.cancelAnimationFrame(this.onceId),this.onceId=-1)}}class lo{constructor(e,t,i,r,s,n,o,a,l,h,c={createAriaLabel:()=>{}},d,u,f,p){this.eventChainTrackersList=[],this.createPresenter=e=>{const t=this.anchorPresenterCreator.createAnchorPresenter(e);return this.presenterCreator.createPresenter(e,Object.assign(Object.assign({},this.presenterContext),{anchorPresenter:t}),this.editContext)},this.onViewModelUpdated=e=>{null==e||e.addTimePoint("ViewModelUpdatedEventReceivedTime"),this.invalidate((()=>{this.render()}),e)},this.renderTargetRegistry=s,this.viewScale=n,this.viewReadyTracker=o,this.frameRendered=a,this.registerViewModelUpdatedListener=l,this.renderLoop=new ao(null!=f?f:window),this.graphic=e,this.anchorPresenterCreator=r,this.anchorPresenter=this.anchorPresenterCreator.createAnchorPresenter(this.graphic),this.presenterContext={anchorPresenter:this.anchorPresenter,viewScale:this.viewScale,viewReadyTracker:this.viewReadyTracker,renderDataPresenterCreator:i,ariaLabelCreator:c,accessibleNodeCreator:d,highContrastModeInfo:u},this.presenterCreator=t,this.editContext=h,this.presenter=this.presenterCreator.createPresenter(this.graphic,this.presenterContext,this.editContext),this.registerViewModelUpdatedListener&&this.presenter.viewModelUpdated.on(this.onViewModelUpdated),p&&void 0!==this.editContext&&void 0!==this.editContext.previewInfo&&(this.editContext.previewInfo.replacePreviewInfo={context:{presenterCreator:this.createPresenter},previewRegistry:new no,replaceRegistry:new oo})}start(){this.renderLoop.runOnce((()=>{this.render()}))}teardown(){this.renderLoop.stopOnce(),this.registerViewModelUpdatedListener&&this.presenter.viewModelUpdated.off(this.onViewModelUpdated),this.presenter.teardown(),this.anchorPresenter.teardown(),this.clear()}render(e){void 0!==e&&(this.eventChainTrackersList.push(e),e.addTimePoint("ViewControllerRenderStartTime")),this.renderViewModels((()=>{const e=this.presenter.viewModel;this.renderTargetRegistry.addViewModel(e)})),null==e||e.addTimePoint("ViewControllerRenderEndTime")}clear(){this.renderViewModels((()=>{}))}invalidate(e,t){this.renderLoop.runOnce(e),void 0!==t&&this.eventChainTrackersList.push(t)}recreatePresenter(e){this.graphic=e,this.presenter=this.presenterCreator.createPresenter(this.graphic,this.presenterContext,this.editContext)}resetPresenter(e,t){this.graphic=e,this.presenter=t}renderViewModels(e){io(this.eventChainTrackersList,"ViewControllerRenderViewModelsStartTime");const t=new x(so);try{const i=new ro("ViewController_Render",this.eventChainTrackersList);try{this.renderTargetRegistry.beginRender(),e(),this.renderTargetRegistry.endRender()}catch(e){throw(0,T.H)(0,`Exception: ${e.message}`),e}finally{i.complete()}io(this.eventChainTrackersList,"FrameRenderedEventEmittedTime"),this.frameRendered.emit(this.eventChainTrackersList.slice()),io(this.eventChainTrackersList,"ViewControllerRenderViewModelsEndTime"),this.eventChainTrackersList.splice(0)}finally{t.complete()}}}class ho{constructor(){this.viewModels=[]}filter(e){return-1!==this.viewModels.indexOf(e)}}class co{constructor(e,t,i,r,s,n,o,a,l,h,c,d,u,f,p,m,g,v){this.viewDirty=!0,this.onViewModelUpdated=e=>{null==e||e.addTimePoint("ViewModelUpdatedEventReceivedTime"),this.invalidate(e)},this.onEditPreviewEvent=e=>{0===e?(this.showSelectionInPreview||this.editPreviewFilter.viewModels.push(this.selectionPresenter.viewModel),this.viewController.renderLoop.start((()=>{this.render()}))):(this.editPreviewFilter.viewModels.splice(0),this.viewController.renderLoop.stop())},this.frameRendered=l,this.viewController=new lo(e,t,i,r,s,n,o,l,!1,a.editContext,d,u,f,m,g),this.viewController.presenter.viewModelUpdated.on(this.onViewModelUpdated),this.editController=a,this.renderOnlyWhenDirty=!0===p,this.editPreviewFilter=new ho,this.viewController.renderTargetRegistry.filter=this.editPreviewFilter,this.editController.selection=h.createSelection(e),this.selectionPresenter=c.createSelectionPresenter(this.editController.selection,{anchorPresenter:this.viewController.anchorPresenter,viewScale:this.viewController.viewScale,viewReadyTracker:this.viewController.viewReadyTracker,renderDataPresenterCreator:i,ariaLabelCreator:d,modelPresenter:this.viewController.presenter,selectionPresenterCreator:c},this.editController.editContext),this.selectionPresenter.viewModelUpdated.on(this.onViewModelUpdated),void 0!==this.editController.editContext.previewInfo?(this.editController.editContext.previewInfo.presenter.notifier.on(this.onEditPreviewEvent),this.renderOnlyWhenDirty&&this.editController.editContext.previewInfo.presenter.viewModelUpdated.on(this.onViewModelUpdated),this.editPreviewRenderTargetRegistry=this.editController.editContext.previewInfo.renderTargetRegistry):this.editPreviewRenderTargetRegistry=new zn([]),this.showSelectionInPreview=!0===v}start(){this.viewController.renderLoop.runOnce((()=>{this.render()}))}teardown(){this.viewController.presenter.viewModelUpdated.off(this.onViewModelUpdated),this.selectionPresenter.viewModelUpdated.off(this.onViewModelUpdated),this.selectionPresenter.teardown(),void 0!==this.editController.editContext.previewInfo&&(this.renderOnlyWhenDirty&&this.editController.editContext.previewInfo.presenter.viewModelUpdated.off(this.onViewModelUpdated),this.editController.editContext.previewInfo.presenter.notifier.off(this.onEditPreviewEvent)),this.viewController.renderTargetRegistry.filter=void 0,this.viewController.teardown(),this.clear(),this.editController.teardown()}render(e){this.renderOnlyWhenDirty&&!this.viewDirty||(void 0!==e&&(this.viewController.eventChainTrackersList.push(e),e.addTimePoint("EditViewControllerRenderStartTime")),this.renderViewModels((()=>{const e=this.viewController.presenter.viewModel;if(this.viewController.renderTargetRegistry.addViewModel(e,1),!this.editController.editContext.isInLivePreview){const e=this.selectionPresenter.viewModel;this.viewController.renderTargetRegistry.addViewModel(e,0);const t=this.editController.editContext.previewInfo;void 0!==t&&this.editPreviewRenderTargetRegistry.addViewModel(t.presenter.viewModel,2)}})),void 0!==e&&e.addTimePoint("EditViewControllerRenderEndTime"),this.viewDirty=!1)}invalidate(e){this.viewDirty=!0,this.viewController.invalidate((()=>{this.render()}),e)}prepareForLivePreview(){this.savedRootInfo={graphic:this.viewController.graphic,presenter:this.viewController.presenter,selection:this.editController.selection};const e=this.savedRootInfo.graphic.clone(this.savedRootInfo.graphic.id);this.editController.resetSelection(this.editController.selection.clone(e)),this.viewController.recreatePresenter(e),this.viewController.presenter.viewModelUpdated.on(this.onViewModelUpdated),this.invalidate()}restoreFromLivePreview(){void 0!==this.savedRootInfo&&(this.viewController.presenter.viewModelUpdated.off(this.onViewModelUpdated),this.viewController.presenter.teardown(),this.editController.selection.teardown(),this.editController.resetSelection(this.savedRootInfo.selection),this.viewController.resetPresenter(this.savedRootInfo.graphic,this.savedRootInfo.presenter),this.invalidate(),this.savedRootInfo=void 0)}renderViewModels(e){const t=new x(so);try{io(this.viewController.eventChainTrackersList,"EditViewControllerRenderViewModelsStartTime");const i=new ro("EditViewController_Render",this.viewController.eventChainTrackersList);try{this.viewController.renderTargetRegistry.beginRender(),this.editPreviewRenderTargetRegistry.beginRender(),e(),this.viewController.renderTargetRegistry.endRender(),this.editPreviewRenderTargetRegistry.endRender()}catch(e){throw(0,T.H)(0,`Exception: ${e.message}`),e}finally{i.complete()}io(this.viewController.eventChainTrackersList,"FrameRenderedEventEmittedTime"),this.frameRendered.emit(this.viewController.eventChainTrackersList.slice()),io(this.viewController.eventChainTrackersList,"EditViewControllerRenderViewModelsEndTime"),this.viewController.eventChainTrackersList.splice(0)}finally{t.complete()}}clear(){this.renderViewModels((()=>{}))}}class uo{get presenter(){return this.editViewController.viewController.presenter}get editContext(){return this.editController.editContext}get selection(){return this.editController.selection}get selectionPresenter(){return this.editViewController.selectionPresenter}get isInLivePreview(){return!0===this.editContext.isInLivePreview}constructor(e){var t,i,r,s,n;this.frameRendered=new c,this.renderDataPresenterCreatorRegistry=new Un([]),this.viewReadyTracker=new Vn,this.presenterCreatorRegistry=new Nn(null!==(t=e.presenterCreatorEntries)&&void 0!==t?t:[]),this.anchorPresenterCreatorRegistry=new Gn(null!==(i=e.anchorPresenterCreatorEntries)&&void 0!==i?i:[]),this.renderTargetRegistry=new zn([]),this.editPreviewInfo=e.editPreviewInfo,this.actionInvoker=e.actionInvoker,this.selectionCreatorRegistry=new Hn([]),null===(r=e.selectionCreatorRegistrars)||void 0===r||r.forEach((e=>{e(this.selectionCreatorRegistry)})),this.selectionPresenterCreatorRegistry=new Wn(null!==(s=e.selectionPresenterCreatorEntries)&&void 0!==s?s:[]),this.editorRegistry=new qn([]),this.keyboardEventNotifiers=e.keyboardEventNotifiers,this.keyboardEventProcessor=e.keyboardEventProcessor,this.ariaLabelCreatorRegistry=new Xn([]),this.accessibleNodeCreatorRegistry=new Yn([]),this.highContrastModeInfo=e.highContrastModeInfo,this.renderOnlyWhenDirty=e.renderOnlyWhenDirty,this.window=null!==(n=e.window)&&void 0!==n?n:window,this.viewScale=new Kn,this.enableReplacePreview=e.enableReplacePreview,this.showSelectionInPreview=e.showSelectionInPreview}start(e,t){const i=new Zn("root",e,t);this.editController=new to({editorRegistry:this.editorRegistry,actionInvoker:this.actionInvoker,previewInfo:this.editPreviewInfo},this.keyboardEventNotifiers,this.keyboardEventProcessor),this.editViewController=new co(i,this.presenterCreatorRegistry,this.renderDataPresenterCreatorRegistry,this.anchorPresenterCreatorRegistry,this.renderTargetRegistry,this.viewScale,this.viewReadyTracker,this.editController,this.frameRendered,this.selectionCreatorRegistry,this.selectionPresenterCreatorRegistry,this.ariaLabelCreatorRegistry,this.accessibleNodeCreatorRegistry,this.highContrastModeInfo,this.renderOnlyWhenDirty,this.window,this.enableReplacePreview,this.showSelectionInPreview),this.editViewController.start()}teardown(){void 0!==this.editViewController&&this.editViewController.teardown()}performAction(e){return this.editController.performAction(e)}performUndoEntry(e){return this.editController.performUndoEntry(e)}invalidate(e){this.editViewController.invalidate(e)}startLivePreview(){l("LivePreview")&&(this.editContext.isInLivePreview||(this.editContext.isInLivePreview=!0,this.editViewController.prepareForLivePreview()))}endLivePreview(){l("LivePreview")&&this.editContext.isInLivePreview&&(this.editContext.isInLivePreview=!1,this.editViewController.restoreFromLivePreview())}}class fo{constructor(e){this.endTimeMs=0,this.startTimeMs=0,this.durationMs=0,this.eventContextHistoryMap=new Map,this.timePoints=[],this.name=e}start(){this.startTimeMs=performance.now()}end(){this.endTimeMs=performance.now(),this.durationMs=Math.max(this.endTimeMs-this.startTimeMs,0)}addEventContext(e,t){this.eventContextHistoryMap.set(e,t)}addTimePoint(e){this.timePoints.push({name:e,timestamp:performance.now()})}addEventToContextHistoryMap(e,t){void 0!==t?this.eventContextHistoryMap.set(e,t):this.eventContextHistoryMap.set(e,NaN)}getEventDurationStringsMap(e){const t=new Map;return this.eventContextHistoryMap.set(`${this.name}DurationMs`,this.durationMs),this.eventContextHistoryMap.forEach(((i,r)=>{t.set(r,i.toFixed(e))})),t}getTimePointCollectionString(e){if(this.timePoints.length>0){const t=this.timePoints[0].timestamp;this.timePoints.forEach((i=>{i.timestamp-=t,i.timestamp=parseFloat(i.timestamp.toFixed(e))}))}return JSON.stringify(this.timePoints)}}class po{constructor(){this.map=new Map}set(e,t){const i=this.map.get(e);return void 0===i?this.map.set(e,{value:t,refCount:1}):this.map.set(e,{value:t,refCount:i.refCount+1}),this}get(e,t=!1){const i=this.map.get(e);return void 0!==i&&t&&(i.refCount+=1),null==i?void 0:i.value}has(e){return this.map.has(e)}delete(e){const t=this.map.get(e);if(void 0!==t)return t.refCount-=1,0===t.refCount?(this.map.delete(e),t.value):void 0}size(){return this.map.size}isEmpty(){return 0===this.map.size}getRefCount(e){const t=this.map.get(e);return null==t?void 0:t.refCount}}class mo{constructor(){this.totalCount=0,this.countDownloadNotStarted=0,this.countDownloadInProgress=0,this.countDownloadSucceeded=0,this.countDownloadFailed=0}}class go{constructor(e,t,i,r){this.url=e,this.blobType=t,this.blob=i,this.stats=r}teardown(){URL.revokeObjectURL(this.url.href)}}class vo{constructor(){this.onDataStoreChange=new c,this.urlStore=new po,this.dataStore=new Map}static getInstance(){return void 0===vo.instance&&(vo.instance=new vo),vo.instance}add(e){var t;const i=e.downloadDetails.id,r=null===(t=this.dataStore.get(i))||void 0===t?void 0:t.downloader;return void 0===r?(this.enforceSizeContraintForEntriesToAdd(1),this.dataStore.set(i,{lastAccessed:performance.now(),downloader:e}),this.onDataStoreChange.emit(this.stats),e):(r.downloadDetails.originalUrl.href!==e.downloadDetails.originalUrl.href&&(0,y._)(0,`DataStore: Found conflicting entry with id - ${i}`),this.onDataStoreChange.emit(this.stats),e)}get(e){const t=this.dataStore.get(e);return void 0!==t&&(t.lastAccessed=performance.now()),null==t?void 0:t.downloader}getDownloadDetails(e){var t;const i=null===(t=this.dataStore.get(e))||void 0===t?void 0:t.downloader;return null==i?void 0:i.downloadDetails}clearEntry(e){var t;const i=null===(t=this.dataStore.get(e))||void 0===t?void 0:t.downloader;void 0!==i&&(i.teardown(),this.dataStore.delete(e)),this.onDataStoreChange.emit(this.stats)}clear(){const e=this.dataStore;this.dataStore=new Map;for(const[t,i]of e)i.downloader.teardown();e.clear(),this.onDataStoreChange.emit(this.stats)}get size(){return this.dataStore.size}get stats(){return this.makeStats()}setConfigAndEnforce(e){this.config=e,this.enforceSizeContraintForEntriesToAdd(0)}makeStats(){const e=new mo;e.totalCount=this.dataStore.size;for(const[t,i]of this.dataStore){const t=i.downloader.downloadDetails.stats;if(void 0===t)e.countDownloadNotStarted+=1;else switch(t.downloadState){case 0:e.countDownloadNotStarted+=1;break;case 1:e.countDownloadInProgress+=1;break;case 2:e.countDownloadSucceeded+=1;break;case 3:e.countDownloadFailed+=1;break;default:(0,xs.t)(t.downloadState)}}return e}enforceSizeContraintForEntriesToAdd(e){var t;if(void 0===(null===(t=this.config)||void 0===t?void 0:t.sizeConstraint))return;const i=this.dataStore.size+e-this.config.sizeConstraint.maxLimit;i>0&&this.config.sizeConstraint.evict(i,Array.from(this.dataStore.entries())).forEach((e=>{this.clearEntry(e)}))}}class _o{constructor(e,t,i,r,s,n){this.downloadCompleted=new c,this.id=e,this.originalUrl=t,this.isUrlFinal=i,this.downloadPlaceholder=s,this.pictureProvider=r,this.options=n,this.isUrlFinal&&(this._mimeType=nn(this.originalUrl))}get mimeType(){var e;return void 0!==this._mimeType||(this._mimeType=null===(e=vo.getInstance().getDownloadDetails(this.id))||void 0===e?void 0:e.mimeType),this._mimeType}set mimeType(e){this._mimeType=e}equals(e){return this.id===e.id&&this.originalUrl===e.originalUrl}}function yo(e,t,i,r){return new _o(`${bo+=1,bo}`,e,!0,t,i,r)}let bo=0;class wo{constructor(e,t,i){this.canvasElement=e,this.renderer=t,this.backgroundColor=i;const r=this.canvasElement.getContext("2d");null===r&&(0,y._)(0,"No 2D context"),this.renderingContext=r}beginRender(){this.renderingContext.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),void 0!==this.backgroundColor&&(this.renderingContext.fillStyle=this.backgroundColor,this.renderingContext.fillRect(0,0,this.canvasElement.width,this.canvasElement.height))}addViewModel(e){this.displayCanvasElement(),this.renderer.renderViewModel(e,this)}endRender(){}hitTest(e){}beginGroup(e){}endGroup(){}displayCanvasElement(){this.canvasElement.style.display=""}}function To(e,t,i,r,s){const n=i.size.width/e.width(),o=i.size.height/e.height(),a=t.width()*n*r,l=t.height()*o*r,h=(t.left-e.left)*n,c=(t.top-e.top)*o,d=(h+i.pos.x)*r,u=(c+i.pos.y)*r;return void 0!==s&&s.setProp("left",d).setProp("top",u).setProp("width",a).setProp("height",l).setProp("scaleFactor",r).setProp("scaleX",n).setProp("scaleY",o),new p(d,u,d+a,u+l)}function xo(e,t,i){const r=t.getContext("2d");null===r&&(0,y._)(0,"No 2D context"),t.width=Co(e.width),t.height=Co(e.height),t.style.position="relative";let s="",n="",o="",a="";if(void 0!==i)s=`${i.width()}px`,n=`${i.height()}px`,o=`${i.left}px`,a=`${i.top}px`;else{const t=e;s=t.style.width,n=t.style.height,o=t.style.left,a=t.style.top}t.style.width=s,t.style.height=n,t.style.left=o,t.style.top=a,0!==t.width&&0!==t.height&&(r.drawImage(e,0,0),(0,T._v)(0,"drawCanvasImageSourceToCanvas: Image drawn"))}function Co(e){if("number"==typeof e)return e;(0,y._)(0,"SVGAnimatedLength not supported")}var Po=s(1459);function So(e,t,i,r,s,n){let o=e.transform.size.width/e.sourceAnchorBounds.width();o=isNaN(o)?1:o;let a=e.transform.size.height/e.sourceAnchorBounds.height();a=isNaN(a)?1:a;const l=new P(o,a).scale(e.scaleFactor*window.devicePixelRatio),h=t.size.multiply(l),c=new P(Math.min(h.x,i),Math.min(h.y,i)),d=l.multiply(new P(c.x/h.x,c.y/h.y));r.width=Math.ceil(c.x),r.height=Math.ceil(c.y);const u=new M(t.center.negate(),d,void 0,c.divide(new P(2,2))),f=window.screen.width*devicePixelRatio*window.screen.height*devicePixelRatio;var p;(function(e,t=2073600,i=2){Qt(function(e,t=2073600,i=2){if(0===e)return 1;let r=Math.sqrt(t/e);return e>t&&(r=Math.sqrt(r)),r=Math.min(r,i),0!==window.devicePixelRatio&&(r*=window.devicePixelRatio),r}(e,t,i))})(f),p=e.emuToSourceScale,ne(function(e){const t=0===e.x?1:1/e.x,i=0===e.y?1:1/e.y;return Math.max(t,i)}(d),function(e){return 2*Po.AF*e}(p));try{s.render(e.scene,_e.Transparent,{transform:u})}catch(e){(0,T.H)(0,`Error rendering scene: ${e}`)}return function(e,t,i,r,s,n,o,a,l,h,c,d){void 0!==d&&d.setProp("anchorScaleX",e).setProp("anchorScaleY",t).setProp("scaleFactor",i).setProp("devicePixelRatio",window.devicePixelRatio).setProp("sceneWidth",s.x).setProp("sceneHeight",s.y).setProp("maxCanvasDimensionPhyPx",r).setProp("cappedSceneWidth",n.x).setProp("cappedSceneHeight",n.y).setProp("combinedScaleX",o.x).setProp("combinedScaleY",o.y).setProp("cappedCombinedScaleX",a.x).setProp("cappedCombinedScaleY",a.y).setProp("totalPhysicalPixels",l).setProp("emuToSourceScale",h).setProp("renderTransformPreTranslationX",c.preTranslation.x).setProp("renderTransformPreTranslationY",c.preTranslation.y).setProp("renderTransformRotation",c.rotation).setProp("renderTransformScaleX",c.scale.x).setProp("renderTransformScaleY",c.scale.y).setProp("renderTransformTranslationX",c.translation.x).setProp("renderTransformTranslationY",c.translation.y)}(o,a,e.scaleFactor,i,h,c,l,d,f,e.emuToSourceScale,u,n),new P(Math.ceil(h.x)/window.devicePixelRatio,Math.ceil(h.y)/window.devicePixelRatio)}class Eo{constructor(){this.elementToViewModel=new Map}setViewModel(e,t){this.elementToViewModel.set(e,t)}getViewModel(e){return this.elementToViewModel.get(e)}clear(){this.elementToViewModel.clear()}}function Mo(e,t){e.target.style.cursor=t}class Ro{constructor(e,t,i){this.activePointerEvents=new Map,this.onPointerDown=(e,t)=>{var i,r,s,n,o,a;if(this.activePointerEvents.set(e.pointerId,e),void 0!==this.inDrag&&!(null===(i=this.options)||void 0===i?void 0:i.shouldSupportMultiPointer))return;if((null===(r=this.options)||void 0===r?void 0:r.shouldSupportMultiPointer)&&this.activePointerEvents.size>1){const i=this.viewModelHitTester.hitTest(e);return void 0!==i&&!0===this.options.supportActiveElementSwitch&&function(e,t){var i,r,s;const n=null===(i=e.source)||void 0===i?void 0:i.editElement;return void 0!==n&&void 0!==n.priority&&(void 0===(null===(s=null===(r=null==t?void 0:t.source)||void 0===r?void 0:r.editElement)||void 0===s?void 0:s.priority)||n.priority<t.source.editElement.priority)}(i,null===(s=this.inDrag)||void 0===s?void 0:s.viewModel)?void this.performActiveEditElementSwitch(i,t):void(void 0!==(null===(n=this.inDrag)||void 0===n?void 0:n.viewModel)?this.inDrag.viewModel.pointerEventNotifiers.pointerdown.value.emit(e,t):this.unHitPointerEventNotifiers.pointerdown.value.emit(e,t))}const l=this.viewModelHitTester.hitTest(e);void 0!==l?(this.inDrag={viewModel:l},l.pointerEventNotifiers.pointerdown.value.emit(e,t)):(this.inDrag={},Mo(e,null!==(a=null===(o=this.options)||void 0===o?void 0:o.cursor)&&void 0!==a?a:"auto"),this.unHitPointerEventNotifiers.pointerdown.value.emit(e,t))},this.onPointerMove=(e,t)=>{var i,r;const s=void 0!==this.inDrag?this.inDrag.viewModel:this.viewModelHitTester.hitTest(e);this.generateOverOutEvent(e,s),void 0!==s?s.pointerEventNotifiers.pointermove.value.emit(e,t):(Mo(e,null!==(r=null===(i=this.options)||void 0===i?void 0:i.cursor)&&void 0!==r?r:"auto"),this.unHitPointerEventNotifiers.pointermove.value.emit(e,t))},this.onPointerUp=(e,t)=>{var i,r,s;this.activePointerEvents.delete(e.pointerId);const n=void 0!==this.inDrag?this.inDrag.viewModel:this.viewModelHitTester.hitTest(e);void 0!==n?n.pointerEventNotifiers.pointerup.value.emit(e,t):(Mo(e,null!==(r=null===(i=this.options)||void 0===i?void 0:i.cursor)&&void 0!==r?r:"auto"),this.unHitPointerEventNotifiers.pointerup.value.emit(e,t)),(null===(s=this.options)||void 0===s?void 0:s.shouldSupportMultiPointer)&&0!==this.activePointerEvents.size||(this.inDrag=void 0)},this.onPointerCancel=(e,t)=>{var i,r,s;this.activePointerEvents.delete(e.pointerId);const n=void 0!==this.inDrag?this.inDrag.viewModel:this.viewModelHitTester.hitTest(e);void 0!==n?n.pointerEventNotifiers.pointercancel.value.emit(e,t):(Mo(e,null!==(r=null===(i=this.options)||void 0===i?void 0:i.cursor)&&void 0!==r?r:"auto"),this.unHitPointerEventNotifiers.pointercancel.value.emit(e,t)),(null===(s=this.options)||void 0===s?void 0:s.shouldSupportMultiPointer)&&0!==this.activePointerEvents.size||(this.inDrag=void 0)},this.viewModelHitTester=e,this.unHitPointerEventNotifiers=t,this.options=i}addEventListeners(e){e.pointerdown.value.on(this.onPointerDown),e.pointermove.value.on(this.onPointerMove),e.pointerup.value.on(this.onPointerUp),e.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerdown.value.off(this.onPointerDown),e.pointermove.value.off(this.onPointerMove),e.pointerup.value.off(this.onPointerUp),e.pointercancel.value.off(this.onPointerCancel)}generateOverOutEvent(e,t){var i,r,s;if(this.lastPointerMoveViewModel===t)return;const n=null!==(r=null===(i=this.lastPointerMoveViewModel)||void 0===i?void 0:i.pointerEventNotifiers)&&void 0!==r?r:this.unHitPointerEventNotifiers;n.pointerout.valid&&n.pointerout.value.emit(e,{isHandled:!1});const o=null!==(s=null==t?void 0:t.pointerEventNotifiers)&&void 0!==s?s:this.unHitPointerEventNotifiers;o.pointerover.valid&&o.pointerover.value.emit(e,{isHandled:!1}),this.lastPointerMoveViewModel=t}performActiveEditElementSwitch(e,t){var i;for(const r of this.activePointerEvents.values())void 0!==(null===(i=this.inDrag)||void 0===i?void 0:i.viewModel)&&this.inDrag.viewModel!==e?this.inDrag.viewModel.pointerEventNotifiers.pointercancel.value.emit(r,t):this.unHitPointerEventNotifiers.pointercancel.value.emit(r,t);this.inDrag={viewModel:e};for(const e of this.activePointerEvents.values())void 0!==this.inDrag.viewModel&&this.inDrag.viewModel.pointerEventNotifiers.pointerdown.value.emit(e,t)}}function Bo(e,t,i){return Math.min(Math.max(e,t),i)}class Io{constructor(e){this.pointerEventNotifiers=d(),this.imageViewModelUpdated=new c,this.hitTestSlop=0,this.bounds=new p(0,0,0,0),this.sourceAnchorBounds=new p(0,0,0,0),this.scaleFactor=1/window.devicePixelRatio,this.transform=new _,this.topLeftOffset=new f(0,0),this.scaleVector=new f(1,1),this.inCropMode=!1,this._data=e}get imageData(){return this._data}async setImageData(e){this._data=e}get opacity(){return this._opacity}set opacity(e){this._opacity=void 0===e?e:Bo(e,0,100)}}function Ao(e){return new p(e.pos.x,e.pos.y,e.pos.x+e.size.width,e.pos.y+e.size.height)}class Fo{constructor(e,t,i,r,s,n,o,a,l){this.hitTestMap=new Eo,this.shapeBuilderVM=new At,this.renderers=new On.B([]),this.renderScope=0,this.groupRenderers=new On.B([]),this.groupScope=[],this.animations=[],this.animateLoopId=-1,this.animationsDisabled=!1,this.animationLoop=()=>{if(-1!==this.animateLoopId&&!this.animationsDisabled&&(this.animateLoopId=-1,0!==this.animations.length)){for(const e of this.animations)e();this.shapeBuilderRenderer.renderViewModel(this.shapeBuilderVM,this),this.animateLoopId=window.requestAnimationFrame(this.animationLoop)}},this.hitTestViewModel=e=>this.shapeBuilderRenderer.hitTest(e,this,this.shapeBuilderVM.scaleFactor),this.canvas=e,this.shapeBuilderRenderer=t,this.webglRenderingContext=function(e,t,i){let r;if(i||(r=e.getContext("webgl2",t)),null!=r)return r;if(r=e.getContext("webgl",t),null===r)throw new Error("No WebGL Rendering Context");return r}(e,n,o),this.scene=new wt,this.graphicsScene=new wt,this.selectionScene=new wt,this.previewScene=new wt,this.rootScene=new wt([this.graphicsScene,this.selectionScene,this.previewScene]),this.pointerEventNotifiers=i,this.separateSelectionSceneFromGraphic=s,this.accessibilityRenderTarget=a,t.setWebGLContext(this.webglRenderingContext),new Ro({hitTest:this.hitTestViewModel},r,l).addEventListeners(this.pointerEventNotifiers)}registerRenderer(e,t){return this.renderers.register(e,t),this}registerGroupRenderer(e,t){return this.groupRenderers.register(e,t),this}beginRender(){var e;0===this.renderScope&&(this.shapeBuilderVM.clear(),this.hitTestMap.clear(),this.selectionScene.items.removeAll(),this.previewScene.items.removeAll(),this.animations=[],null===(e=this.accessibilityRenderTarget)||void 0===e||e.beginRender()),this.renderScope+=1}addViewModel(e,t=1){var i;const r=this.renderers.get(e.type);void 0!==r?r(e,this,t):function(e){return e.type===class{}}(e)?this.addShapeBuilderShapeViewModel(e,t):Ft(e)?this.addShapeBuilderViewModel(e,t):function(e){return e.type===class{}}(e)?this.addShapeBuilderGeometryViewModel(e):e instanceof Io&&this.addImageViewModel(e),null===(i=this.accessibilityRenderTarget)||void 0===i||i.addViewModel(e)}addItem(e){0===this.groupScope.length?this.shapeBuilderVM.addItem(e):this.groupScope[this.groupScope.length-1].items.push(e)}endRender(){var e;if(this.renderScope-=1,0===this.renderScope){const t=new x("ShapeBuilderRenderTarget.Render");try{this.shapeBuilderRenderer.renderViewModel(this.shapeBuilderVM,this),this.startAnimationLoop()}finally{t.complete()}null===(e=this.accessibilityRenderTarget)||void 0===e||e.endRender()}}hitTestText(e,t){return this.shapeBuilderRenderer.hitTestText(e,this,this.shapeBuilderVM.scaleFactor,t)}hitTest(e,t){return this.shapeBuilderRenderer.hitTest(e,this,this.shapeBuilderVM.scaleFactor,t)}beginGroup(e){const t=this.groupRenderers.get(e.type);if(void 0===t)throw new Error("Failed to find GroupRenderer to render group");const i=t(e,this);this.shapeBuilderRenderer.registerItem(e,i),this.groupScope.length>0&&this.groupScope[this.groupScope.length-1].items.push(i),this.groupScope.push(i)}endGroup(){const e=this.groupScope.pop();if(void 0===e)throw new Error("Mismatched begin/end group");0===this.groupScope.length&&this.addItem(e)}getScene(){return this.separateSelectionSceneFromGraphic?this.rootScene:this.scene}getGraphicsScene(){return this.graphicsScene}getSelectionScene(){return this.selectionScene}getPreviewScene(){return this.previewScene}getWebGLContext(){return this.webglRenderingContext}addAnimation(e){this.animations.push(e)}enableAnimations(e){this.animationsDisabled=!e,e?this.startAnimationLoop():this.stopAnimationLoop()}addShapeBuilderShapeViewModel(e,t){if(this.shapeBuilderRenderer.registerItem(e,e.shape),this.hitTestMap.setViewModel(e.shape,e),this.separateSelectionSceneFromGraphic)switch(t){case 1:this.addItem(e.shape);break;case 0:this.selectionScene.items.push(e.shape);break;case 2:this.previewScene.items.push(e.shape);break;default:(0,xs.t)(t)}else this.addItem(e.shape),0===t?this.selectionScene.items.push(e.shape):2===t&&this.previewScene.items.push(e.shape)}addShapeBuilderViewModel(e,t){const i=new wt;if(e.isHitTestOnly)e.scene.items.elements.forEach((t=>{this.shapeBuilderRenderer.registerItem(e,t),this.hitTestMap.setViewModel(t,e)}));else{if(e.scene.items.elements.forEach((t=>{this.shapeBuilderRenderer.registerItem(e,t),this.hitTestMap.setViewModel(t,e),i.items.push(t)})),i.transform=function(e){const t=e.sourceAnchorBounds.center(),i=new P(-t.x,-t.y);let r=1,s=0;0!==e.sourceAnchorBounds.width()&&(r=e.transform.size.width/e.sourceAnchorBounds.width(),s=e.transform.size.width/2);let n=1,o=0;return 0!==e.sourceAnchorBounds.height()&&(n=e.transform.size.height/e.sourceAnchorBounds.height(),o=e.transform.size.height/2),new M(i,new P(r,n),void 0,new P(s,o))}(e),this.separateSelectionSceneFromGraphic)switch(t){case 1:this.addItem(i),this.shapeBuilderVM.addTeardown((()=>{Bt(i)}));break;case 0:this.selectionScene.items.push(e.scene);break;case 2:this.previewScene.items.push(e.scene);break;default:(0,xs.t)(t)}else this.addItem(i),this.shapeBuilderVM.addTeardown((()=>{Bt(i)})),0===t?this.selectionScene.items.push(e.scene):2===t&&this.previewScene.items.push(e.scene);this.shapeBuilderVM.transform=e.transform,this.shapeBuilderVM.sourceAnchorBounds=new p(0,0,e.transform.size.width,e.transform.size.height),this.shapeBuilderVM.scaleFactor=e.scaleFactor,0!==e.emuToSourceScale&&(this.shapeBuilderVM.emuToSourceScale=e.emuToSourceScale)}this.shapeBuilderRenderer.registerItem(e,i)}addShapeBuilderGeometryViewModel(e){var t;this.shapeBuilderRenderer.registerItem(e,e.shape),this.hitTestMap.setViewModel(e.shape,e),this.addItem(e.shape);for(const{pictureDataViewModel:i,imageBrush:r}of e.pictureFillImageData){const e=null!==(t=i.imageData)&&void 0!==t?t:"";this.shapeBuilderRenderer.getOrGenerateImageTexture(e,(e=>{r.image=e}))}}addImageViewModel(e){const t=Ao(e.transform),i=bt.CreateRectangle(new R(t.left,t.top,t.right,t.bottom));this.shapeBuilderRenderer.registerItem(e,i),this.shapeBuilderRenderer.attachImageViewModelTextureToItem(e,i),this.hitTestMap.setViewModel(i,e),this.addItem(i),this.shapeBuilderVM.addTeardown((()=>{i.clearCache()}))}startAnimationLoop(){this.animations.length>0&&-1===this.animateLoopId&&(this.animateLoopId=window.requestAnimationFrame(this.animationLoop))}stopAnimationLoop(){-1!==this.animateLoopId&&(window.cancelAnimationFrame(this.animateLoopId),this.animateLoopId=-1)}}class ko{get webGLCanvas(){return this.shapeBuilderContext.shapeBuilderConfig.webGLCanvas}constructor(e){this.shapeBuilderContext=e}renderViewModel(e,t){var i;const r=new x("ShapeBuilderCanvas2DRenderer.renderViewModel");try{if(r.setProp("isRendererReady",`${this.shapeBuilderContext.isRendererReady}`),!this.shapeBuilderContext.isRendererReady)return;!function(e){if(!Ft(e))throw new Error(`Expected ShapeBuilderViewModel but received type:${e.type}`)}(e);const s=e.scene.getBounds();if(void 0===s||s.isEmpty())return;t instanceof Fo&&(t.separateSelectionSceneFromGraphic?t.getGraphicsScene().setItems(e.scene.items):t.getScene().setItems(e.scene.items));const n=So(e,s,null!==(i=this.shapeBuilderContext.shapeBuilderConfig.maxWebGLCanvasDimensionPhyPx)&&void 0!==i?i:4096,this.webGLCanvas,this.shapeBuilderContext.renderer,r),o=function(e,t,i){const r=To(e.sourceAnchorBounds,void 0===(s=e.scene.getBounds())?new p(0,0,0,0):new p(s.left,s.top,s.right,s.bottom),e.transform,e.scaleFactor,i);var s;return r.right=r.left+t.width/window.devicePixelRatio,r.bottom=r.top+t.height/window.devicePixelRatio,r}(e,this.webGLCanvas,r);o.right=o.left+n.x,o.bottom=o.top+n.y,this.webGLCanvas.style.position="relative",this.webGLCanvas.style.width=`${o.width()}px`,this.webGLCanvas.style.height=`${o.height()}px`,this.webGLCanvas.style.left=`${o.left}px`,this.webGLCanvas.style.top=`${o.top}px`,t instanceof wo&&xo(this.webGLCanvas,t.canvasElement,o)}finally{r.complete()}}hitTestText(e,t,i){}hitTest(e,t,i){if(t instanceof Fo){const r=new P(e.offsetX,e.offsetY);let s;void 0!==i&&(s=new M(void 0,new P(i,i)));const n=this.shapeBuilderContext.renderer.hitTestScene(t.getScene(),r,s);if(void 0===n.itemHit)return;let o=t.hitTestMap.getViewModel(n.itemHit);if(void 0===o&&void 0!==n.itemStack)for(const e of n.itemStack.reverse())if(o=t.hitTestMap.getViewModel(e),void 0!==o)break;return o}}registerItem(){}attachImageViewModelTextureToItem(){}getOrGenerateImageTexture(){}setWebGLContext(e){this.shapeBuilderContext.renderer.setWebGLContext(e)}updateTextureFromHTMLElement(){}}class Do{constructor(e,t,i,r,s,n,o){this._renderTargetMode=0,this._skipPrepareWebGLCanvas=!0,this.shouldInvokeRenderTargetChangedCallback=!0,this.modeToRenderTargetMap=new Map,this.shapeBuilderContext=e,this.viewCanvas2D=r,this.pointerEventNotifiers=s,this.viewDiv=t,this.editDiv=i,this.shapeBuilderCanvas2DRenderer=new ko(e),this.modeToRenderTargetMap.set(0,new wo(this.viewCanvas2D,this.shapeBuilderCanvas2DRenderer)),this.modeToRenderTargetMap.set(1,new Fo(this.shapeBuilderContext.shapeBuilderConfig.webGLCanvas,this.shapeBuilderCanvas2DRenderer,this.pointerEventNotifiers,n,o))}get renderTargetMode(){return this._renderTargetMode}set renderTargetMode(e){this._renderTargetMode!==e&&(this._renderTargetMode=e,this.shouldInvokeRenderTargetChangedCallback=!0)}get skipPrepareWebGLCanvas(){return this._skipPrepareWebGLCanvas}set skipPrepareWebGLCanvas(e){this._skipPrepareWebGLCanvas!==e&&(this._skipPrepareWebGLCanvas=e)}beginRender(){this.prepareWebGLCanvas();const e=this.modeToRenderTargetMap.get(this.renderTargetMode);void 0!==e&&e.beginRender()}addViewModel(e){if(!Ft(e))return;const t=this.modeToRenderTargetMap.get(this.renderTargetMode);void 0!==t&&t.addViewModel(e)}endRender(){const e=this.modeToRenderTargetMap.get(this.renderTargetMode);void 0!==e&&e.endRender(),this.renderTargetChangedCallback()}hitTest(e){}beginGroup(e){}endGroup(){}renderTargetChangedCallback(){var e;this.shouldInvokeRenderTargetChangedCallback&&(0===this.renderTargetMode?this.showViewDivOnly():1===this.renderTargetMode&&(this.editDiv.appendChild(null===(e=this.shapeBuilderContext)||void 0===e?void 0:e.shapeBuilderConfig.webGLCanvas),this.showEditDivOnly(),this.shapeBuilderContext.activeMultiplexRenderTarget=this),this.shouldInvokeRenderTargetChangedCallback=!1)}getEditDivGraphicIdAttribute(){return this.editDiv.getAttribute("graphicId")}prepareWebGLCanvas(){if(this.skipPrepareWebGLCanvas)return;this.renderTargetMode=1;const e=this.shapeBuilderContext.activeMultiplexRenderTarget;void 0!==e&&e!==this&&e.tryChangeToCanvas2DRenderTargetMode(this.getEditDivGraphicIdAttribute())}tryChangeToCanvas2DRenderTargetMode(e){if(0===this.renderTargetMode)return;const t=new x("ShapeBuilderMultiplexRenderTarget.tryChangeToCanvas2DRenderTargetMode");try{null!==e&&t.setProp("pendingEditDivGraphicId",e);const i=this.getEditDivGraphicIdAttribute();null!==i&&t.setProp("editDivGraphicId",i);const r=this.modeToRenderTargetMap.get(1),s=this.modeToRenderTargetMap.get(0);r instanceof Fo&&s instanceof wo&&(this.renderTargetMode=0,xo(r.canvas,s.canvasElement),this.renderTargetChangedCallback())}finally{t.complete()}}showViewDivOnly(){this.viewDiv.style.display="inherit",this.editDiv.style.display="none"}showEditDivOnly(){this.editDiv.style.display="inherit",this.viewDiv.style.display="none"}}class Lo{get length(){return this.idCollection.length}constructor(e,t){this.idCollection=e,this.readOnlyItemCollection=t}addItems(e){return this.idCollection.addIds(this.getIds(e))}removeItems(e){return this.idCollection.removeIds(e.map((e=>e.id)))}removeItemIds(e){return this.idCollection.removeIds(e)}setItems(e){return this.idCollection.setIds(this.getIds(e))}clear(){return this.idCollection.clear()}getItemById(e){if(this.idCollection.has(e))return this.readOnlyItemCollection.getItemById(e)}getItemByIndex(e){if(e>=this.idCollection.length)return;const t=this.idCollection.getIdByIndex(e);return this.readOnlyItemCollection.getItemById(t)}[Symbol.iterator](){const e=this.idCollection[Symbol.iterator]();return{next:()=>{const t=e.next();if(void 0!==t.done&&!t.done){const e=this.getItemById(t.value);if(void 0!==e)return{done:!1,value:e}}return{done:!0,value:void 0}}}}getIds(e){return e.map((e=>e.id)).filter((e=>this.readOnlyItemCollection.getIndexById(e)>-1))}}class Oo{constructor(e){this.elementList=e}get length(){return this.elementList.elementCount}getItemById(e){return this.elementList.getElementById(e)}getIndexById(e){return this.elementList.getIndexById(e)}getItemByIndex(e){return this.elementList.getElementByIndex(e)}[Symbol.iterator](){return this.elementList[Symbol.iterator]()}}function Uo(e){return new Oo(e)}class Vo{constructor(){this.ids=[]}addId(e){return!this.has(e)&&(this.ids.push(e),!0)}addIds(e){return e.reduce(((e,t)=>this.addId(t)||e),!1)}removeId(e){const t=this.getIndexById(e);return t>-1&&(this.ids.splice(t,1),!0)}removeIds(e){return e.reduce(((e,t)=>this.removeId(t)||e),!1)}setIds(e){return!this.sameIds(e)&&(this.ids=e,!0)}clone(){const e=new Vo;return e.ids=[...this.ids],e}clear(){return 0!==this.ids.length&&(this.ids.length=0,!0)}has(e){return this.getIndexById(e)>-1}hasAll(e){return!e.some((e=>!this.has(e)))}sameIds(e){return this.ids.length===e.length&&!e.some(((e,t)=>e!==this.getIdByIndex(t)))}get length(){return this.ids.length}getIdByIndex(e){if(e>=this.ids.length)throw new RangeError(`Invalid index: ${e}, len: ${this.ids.length}`);return this.ids[e]}getIndexById(e){return this.ids.findIndex((t=>e===t))}[Symbol.iterator](){let e=0;const t=this.ids;return{next(){if(e<t.length){const i={done:!1,value:t[e]};return e+=1,i}return{done:!0,value:void 0}}}}}class No{}function Go(e,t){return t.reduce(((e,t,i)=>e.replace(`{${i}}`,t)),e)}class zo{}class Ho{constructor(e,t){this.type=zo,this.selectionUpdated=new c,this.graphic=e,this.filteredElementCollection=t}addElements(e){this.filteredElementCollection.addItems(e)&&this.onSelectionChanged()}removeElements(e){this.filteredElementCollection.removeItems(e)&&this.onSelectionChanged()}setElements(e){this.filteredElementCollection.setItems(e)&&this.onSelectionChanged()}clear(){this.filteredElementCollection.clear()&&this.onSelectionChanged()}hasSubSelection(){return this.length>0}get length(){return this.filteredElementCollection.length}getElementById(e){return this.filteredElementCollection.getItemById(e)}getElementByIndex(e){return this.filteredElementCollection.getItemByIndex(e)}[Symbol.iterator](){return this.filteredElementCollection[Symbol.iterator]()}teardown(){}save(){}restore(e){}clone(e){throw new Error("SmartArtSelection clone not implemented")}getAriaMessageForSelection(e){let t="";const i=this.filteredElementCollection.length;let r;return 1===i?r=this.filteredElementCollection.getItemByIndex(0):i>1&&(r=this.filteredElementCollection.getItemByIndex(i-1)),void 0!==r&&(t=this.constructFullAriaMessage(r,e)),t}constructFullAriaMessage(e,t){let i=e.shapeTypeString;return""===i&&(i=t.defaultShapeType),""!==e.alt?Go(e.hasText?t.shapeHasTextAltTemplate:t.shapeWithNoTextAltTemplate,[i,e.altTitle,e.alt]):Go(e.hasText?t.shapeHasTextTemplate:t.shapeNoTextTemplate,[i,e.altTitle])}onSelectionChanged(){this.selectionUpdated.emit()}}function Wo(e){return e.type===zo}class $o{constructor(e){this.selection=e}}const qo="enterExitCropMode";class jo{constructor(e){this.actionType=qo,this.cropMode=e}isCropActive(){return 0===this.cropMode}}function Xo(e,t){return t.cropState.inCropMode!==e.isCropActive()&&(t.cropState.setInCropMode(e.cropMode),!0)}class Yo extends On.B{createAction(e,t,i){const r=this.get(e);if(void 0!==r&&void 0!==r[0])return r[0](t,i)}query(e,t){const i=this.get(e);if(void 0!==i&&void 0!==i[1])return i[1](t)}}const Ko="DeleteSelectionAction";class Zo{constructor(){this.actionType=Ko}}class Jo{constructor(e,t,i){this.leftTop=new f(e.left,e.top),this.leftTop.rotate(t,i),this.rightBottom=new f(e.right,e.bottom),this.rightBottom.rotate(t,i),this.rotInDegrees=t}getUnrotatedRectAtPoint(e){const[t,i]=function(e,t,i){return e.map((e=>{const r=new f(e.x,e.y);return r.rotate(t,i),r}))}([this.leftTop,this.rightBottom],-this.rotInDegrees,e);return new p(t.x,t.y,i.x,i.y)}getUnRotatedAtCenterRect(){const{x:e,y:t}=this.leftTop,{x:i,y:r}=this.rightBottom,s=new f((e+i)/2,(t+r)/2);return this.getUnrotatedRectAtPoint(s)}}function Qo(e,t,i,r){const s=new Jo(e,t,i).getUnRotatedAtCenterRect();return new _(new g(s.left,s.top),new v(s.width(),s.height()),new m(r.x,r.y),t)}class ea{constructor(e,t,i,r){this.left=e,this.top=t,this.right=i,this.bottom=r}equals(e){return ia(this.left,e.left)&&ia(this.top,e.top)&&ia(this.right,e.right)&&ia(this.bottom,e.bottom)}getSrcRectTransformFromParent(e,t){const i=Ao(e),r=function(e,t,i){const[r,s]=[e.width(),e.height()],n=e.left+r*(i.x?t.right:t.left)/100,o=e.top+s*(i.y?t.bottom:t.top)/100,a=e.right-r*(i.x?t.left:t.right)/100,l=e.bottom-s*(i.y?t.top:t.bottom)/100;return new p(n,o,a,l)}(i,this,e.flip),s=Qo(r,e.rot,i.center(),e.flip);return void 0!==(null==t?void 0:t.rotation)&&(s.rot=t.rotation),s}getParentTransform(e,t){var i;const r=Ao(e),s=function(e,t,i){const r=100*e.width()/(100-t.left-t.right),s=100*e.height()/(100-t.top-t.bottom),n=e.left-r*(i.x?t.right:t.left)/100,o=e.top-s*(i.y?t.bottom:t.top)/100,a=e.right+r*(i.x?t.left:t.right)/100,l=e.bottom+s*(i.y?t.top:t.bottom)/100;return new p(n,o,a,l)}(r,this,e.flip),n=Qo(s,null!==(i=null==t?void 0:t.rotation)&&void 0!==i?i:e.rot,r.center(),e.flip);return void 0!==(null==t?void 0:t.rotation)&&(n.rot=t.rotation),n}isDefault(){return 0===this.left&&0===this.top&&0===this.right&&0===this.bottom}}function ta(e,t){return void 0===t?e:t.getParentTransform(e)}function ia(e,t){return Math.abs(e-t)<.01}class ra{constructor(e,t){this.anchor=e,this.transform=t}perform(){const e=new ra(this.anchor,this.anchor.transform);return this.anchor.transform=this.transform,{undoOp:e}}}function sa(e,t,i,r){const s=e.clone();switch(t.type){case 0:(null==r?void 0:r.move)||(s.pos.x+=t.x,s.pos.y+=t.y);break;case 1:(null==r?void 0:r.resize)||function(e,t,i){const{width:r,height:s}=e.size;let{scaleX:n,scaleY:o}=t;const{originX:a,originY:l}=t;if((i||t.lockAspectRatio)&&0!==a&&0!==l){const e=Math.max(Math.abs(n),Math.abs(o));n=Math.sign(n)*e,o=Math.sign(o)*e}const h=n*r,c=o*s;e.size.width=Math.abs(h),e.size.height=Math.abs(c);const d=new f((h-r)*a/2,(c-s)*l/2);d.rotate(e.rot),e.pos.x+=r/2+d.x-h/2,e.pos.y+=s/2+d.y-c/2,h<0&&(e.pos.x+=h,e.flip.x=!e.flip.x),c<0&&(e.pos.y+=c,e.flip.y=!e.flip.y)}(s,t,i||!0===(null==r?void 0:r.aspectRatio));break;case 2:(null==r?void 0:r.rotate)||(s.rot+=t.rotation);break;case 3:t.x&&(s.flip.x=!s.flip.x),t.y&&(s.flip.y=!s.flip.y),t.mirrorRotation&&(s.rot=(0,u.LW)(-s.rot));break;case 4:void 0!==t.offset&&s.pos.add(t.offset),void 0!==t.scale&&s.size.scale(t.scale.width,t.scale.height),void 0!==t.flip&&(t.flip.x&&(s.flip.x=!s.flip.x),t.flip.y&&(s.flip.y=!s.flip.y)),void 0!==t.rotation&&(s.rot+=t.rotation);break;default:(0,xs.t)(t)}return s}class na{constructor(e){this.actionType="modXfrmAct",this.transform=e}}function oa(e,t,i=!1,r){return sa(e,t.transform,i,r)}class aa{constructor(e,t,i,r){this.type=4,this.offset=e,this.scale=t,this.flip=i,this.rotation=r}}function la(e,t){return new aa(new g(t.pos.x-e.pos.x,t.pos.y-e.pos.y),new v(t.size.width/e.size.width,t.size.height/e.size.height),new m(t.flip.x!==e.flip.x,t.flip.y!==e.flip.y),t.rot-e.rot)}class ha{}class ca{constructor(){this.type=ha}shouldMergeWithPrevious(e){return!0}}class da{constructor(e,t,i=!1){this.croppable=e,this.crop=t,i&&(this.mergePolicy=new ca)}perform(){const e=new da(this.croppable,this.croppable.crop);return this.croppable.crop=this.crop,{undoOp:e}}}const ua="crop";class fa{constructor(e,t,i){this.actionType=ua,this.crop=e,this.transform=t,this.graphic=i}}function pa(e,t){var i;const{model:r,anchor:s}=null!==(i=e.graphic)&&void 0!==i?i:t.graphic;ys("GC2Crop");const n=new da(r,e.crop),o=s.transform;let a=e.transform;if(void 0!==a&&a.equals(o))return[n];if(void 0===a){l=ta(o,r.crop),a=void 0===(h=e.crop)?l:h.getSrcRectTransformFromParent(l)}var l,h;return[n,new ra(s,oa(o,new na(la(o,a))))]}class ma{constructor(){this.cropEventNotifier=new c,this.keyboardEvent=new c,this.outCropping=!1,this._inCropMode=!1}setInCropMode(e){const t=0===e;this._inCropMode!==t&&(this._inCropMode=t,this.cropEventNotifier.emit(e))}get inCropMode(){return this._inCropMode}}class ga{constructor(){this.stateUpdated=new c,this._mode=0}get mode(){return this._mode}start(e,t){this._mode=e,this.stateUpdated.emit(t)}stop(e){this._mode=0,this.stateUpdated.emit(e)}dispatchAction(e){this.stateUpdated.emit(e)}}class va{}class _a{}class ya{constructor(e){this.type=_a,this.selectionUpdated=new c,this.cropState=new ma,this.paintState=new ga,this.graphic=e}teardown(){}save(){}restore(e){}clone(e){return new ya(e)}}function ba(e){return e.type===_a}const wa="removeBackgroundAction";class Ta extends class{constructor(e,t,i,r,s,n,o=!0){this.actionType=e,this.graphic=t,this.pictureContent=i,this.preAction=r,this.postAction=s,this.resultHandler=n,this.updatePicture=o}}{constructor(e,t,i,r,s,n=!0,o,a,l,h){super(wa,e,t,i,r,s,n),this.useMask=o,this.downsample=a,this.bgrOpType=l,this.blurRadiusInPixel=h}}const xa="setPicturePlaceholder";class Ca{constructor(e,t,i=!1){this.actionType=xa,this.placeholder=e,this.graphic=t,this.isUndoable=i}}class Pa{constructor(e,t=!1,i=!1,r=!1){this.url=e,this.renderAsSvg=t,this.overlay=i,this.cropToGeometry=r}equals(e){return this.url.href===e.url.href}}class Sa{constructor(e,t,i,r,s,n){this.radius=e,this.startAlpha=t,this.startPosition=i,this.endAlpha=r,this.endPosition=s,this.distance=n}clone(){return new Sa(this.radius,this.startAlpha,this.startPosition,this.endAlpha,this.endPosition,this.distance)}equals(e){return this.radius===e.radius&&this.startAlpha===e.startAlpha&&this.startPosition===e.startPosition&&this.endAlpha===e.endAlpha&&this.endPosition===e.endPosition&&this.distance===e.distance}}const Ea="changeEffects";class Ma{constructor(e,t,i,r,s){this.actionType=Ea,this.glow=e,this.shadow=t,this.innerShadow=i,this.reflection=r,this.softEdges=s}}class Ra{constructor(e,t,i,r,s=1,n=1,o=0,a=0,l=4,h=!0){this.color=e,this.radius=t,this.angle=i,this.distance=r,this.scaleX=s,this.scaleY=n,this.skewX=o,this.skewY=a,this.alignment=l,this.rotateWithShape=h}clone(){return new Ra(this.color.clone(),this.radius,this.angle,this.distance,this.scaleX,this.scaleY,this.skewX,this.skewY,this.alignment,this.rotateWithShape)}equals(e){return this.color.equals(e.color)&&this.radius===e.radius&&this.angle===e.angle&&this.distance===e.distance&&this.scaleX===e.scaleX&&this.scaleY===e.scaleY&&this.skewX===e.skewX&&this.skewY===e.skewY&&this.alignment===e.alignment&&this.rotateWithShape===e.rotateWithShape}}function Ba(e){return Math.round(e)}function Ia(e,t){return e.equals(t)}function Aa(e,t){return void 0===e&&void 0===t||void 0!==e&&void 0!==t&&e.equals(t)}function Fa(e){return e.map((e=>e))}class ka{constructor(e,t,i,r,s=[]){this.type=0,this.r=e,this.g=t,this.b=i,this.a=r,this.transforms=s}clone(){return new ka(this.r,this.g,this.b,this.a,Fa(this.transforms))}equals(e){return Da(e)&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a&&function(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i+=1)if(!Ia(e[i],t[i]))return!1;return!0}(this.transforms,e.transforms)}}function Da(e){return 0===e.type}function La(e){return`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function Oa(e){const t=function(e){if(e.startsWith("rgb(")){const[t,i,r]=e.slice(4).split(",").map(parseFloat);return new ka(t,i,r,1)}if(e.startsWith("rgba(")){const[t,i,r,s]=e.slice(5).split(",").map(parseFloat);return new ka(t,i,r,s)}if(e.startsWith("#")){const t=parseInt(e.slice(1),16);if(7===e.length)return new ka(t>>16&255,t>>8&255,255&t,1);if(9===e.length)return new ka(t>>24&255,t>>16&255,t>>8&255,(255&t)/255)}}(e);if(void 0!==t)return t;throw new Error(`Unsupported CSS color: ${e}`)}const Ua=new ka(0,0,0,1),Va="SetFillColorAction";class Na{constructor(e){this.actionType=Va,this.color=e}}const Ga="changePictureBrightness";class za{constructor(e,t=!1){this.actionType=Ga,this.brightness=e,this.mergeUndo=t}}const Ha="changePictureContrast";class Wa{constructor(e,t=!1){this.actionType=Ha,this.contrast=e,this.mergeUndo=t}}const $a="changePictureSaturation";class qa{constructor(e,t=!1){this.actionType=$a,this.saturation=e,this.mergeUndo=t}}class ja{constructor(e,t){this.brightness=e,this.contrast=t}equals(e){return this.brightness===e.brightness&&this.contrast===e.contrast}clone(){return new ja(this.brightness,this.contrast)}}class Xa{constructor(e,t,i){this.hueRotation=e,this.saturationFactor=t,this.luminanceFactor=i}equals(e){return this.hueRotation===e.hueRotation&&this.saturationFactor===e.saturationFactor&&this.luminanceFactor===e.luminanceFactor}clone(){return new Xa(this.hueRotation,this.saturationFactor,this.luminanceFactor)}}const Ya="changePictureEffects";class Ka{constructor(e,t,i,r,s,n,o=!1){this.actionType=Ya,this.brightnessContrast=e,this.hueSaturationLuminance=t,this.colorTemperature=i,this.recolor=r,this.sharpness=s,this.pictureEffectProperties=n,this.mergeUndo=o}}const Za="setPictureTransparency";class Ja{constructor(e,t=!1){this.actionType=Za,this.transparency=e,this.mergeUndo=t}}function Qa(e){const t=e.selection.selections[0];return 1!==e.selection.selections.length||void 0===t?{enabled:!1}:{enabled:ba(t)}}function el(e){const t=e.selection.selections[0];return 1!==e.selection.selections.length||void 0===t?{enabled:!1}:{enabled:Wo(t)&&t.hasSubSelection()}}const tl=new Yo([["ApplyShapeFillColor",[function(e){const t=e.color;if(void 0!==t)return new Na(t)},el]],["ChangeEffects",[function(e){const t=e,i=void 0!==t.shadow?function(e){const t=e.color;return new Ra(new ka(t.r,t.g,t.b,t.a),e.radius,e.angle,e.distance)}(t.shadow):void 0,r=void 0!==t.reflection?new Sa(t.reflection.radius,t.reflection.startAlpha,0,0,t.reflection.endPosition/100,t.reflection.distance):void 0;return new Ma(void 0,i,void 0,r)},Qa]],["ChangePictureBrightness",[function(e){const t=e.value;return new za(t/100,!0)},function(e){var t,i,r;const s=e.selection;if(0!==s.selections.length&&ba(s.selections[0]))return{enabled:!0,value:Ba(100*(null!==(r=null===(i=null===(t=s.selections[0].graphic.model.pictureEffects)||void 0===t?void 0:t.brightnessContrast)||void 0===i?void 0:i.brightness)&&void 0!==r?r:0))}}]],["ChangePictureContrast",[function(e){const t=e.value;return new Wa(t/100,!0)},function(e){var t,i,r;const s=e.selection;if(0!==s.selections.length&&ba(s.selections[0]))return{enabled:!0,value:Ba(100*(null!==(r=null===(i=null===(t=s.selections[0].graphic.model.pictureEffects)||void 0===t?void 0:t.brightnessContrast)||void 0===i?void 0:i.contrast)&&void 0!==r?r:0))}}]],["ChangePictureEffects",[function(e){const t=e,i=void 0!==t.brightnessContrast?new ja(void 0!==t.brightnessContrast.brightness?t.brightnessContrast.brightness/100:0,void 0!==t.brightnessContrast.contrast?t.brightnessContrast.contrast/100:0):void 0,r=void 0!==t.hueSaturationLuminance?new Xa(0,void 0!==t.hueSaturationLuminance.saturationFactor?t.hueSaturationLuminance.saturationFactor/100:1,1):void 0;return new Ka(i,r)},Qa]],["ChangePictureSaturation",[function(e){const t=e.value;return new qa(t/100,!0)},function(e){var t,i,r;const s=e.selection;if(0!==s.selections.length&&ba(s.selections[0]))return{enabled:!0,value:Ba(100*((null!==(r=null===(i=null===(t=s.selections[0].graphic.model.pictureEffects)||void 0===t?void 0:t.hueSaturationLuminance)||void 0===i?void 0:i.saturationFactor)&&void 0!==r?r:1)-1))}}]],["ChangePictureTransparency",[function(e){const t=e.value;return new Ja(t,!0)},function(e){var t;const i=e.selection;if(0!==i.selections.length&&ba(i.selections[0]))return{enabled:!0,value:null!==(t=i.selections[0].graphic.model.opacity)&&void 0!==t?t:0}}]],["ClearPlaceholders",[()=>new Zo,el]],["EnterCrop",[()=>new jo(0),Qa]],["ExitCrop",[()=>new jo(2),Qa]],["RemoveBackgroundAction",[function(e,t){if(!ba(t.selection.selections[0])||void 0===e)return;const i=e,r=t.selection.selections[0].graphic,s=void 0!==i.placeholder?new Ca(new Pa(i.placeholder.url,i.placeholder.renderAsSvg,i.placeholder.overlay,i.placeholder.cropToGeometry),r):void 0,n=void 0!==i.placeholder&&i.updatePicture?new Ca(void 0,r):void 0,o=void 0!==i.originalUrl?new Ds(i.originalUrl):void 0;return new Ta(t.selection.selections[0].graphic,o,s,n,i.resultHandler,i.updatePicture,i.useMask,i.downsample,"RemoveBackground")},Qa]],["UpdateCrop",[function(e,t){if(!ba(t.selection.selections[0])||void 0===e)return;const i=e;if(void 0===i.crop)return;const r=new ea(100*i.crop.left,100*i.crop.top,100*i.crop.right,100*i.crop.bottom);return new fa(r)},Qa]]]);class il{}class rl{set fallbackRenderData(e){this._fallbackRenderData=e,this.modelUpdated.emit()}get fallbackRenderData(){return this._fallbackRenderData}constructor(e){this.type=il,this.modelUpdated=new c,this.hostContext=e}clone(){throw Error("Not implemented")}}class sl{}class nl{constructor(e){this.anchorUpdated=new c,this.type=sl,this.graphicElement=e}get transform(){return this.getTransformInformation()}clone(){(0,y._)(0,"Not implemented")}getTransformInformation(){const e=new g(this.graphicElement.get_xPersisted(),this.graphicElement.get_yPersisted()),t=new v(this.graphicElement.get_widthPersisted(),this.graphicElement.get_heightPersisted()),i=new m(this.graphicElement.get_isHorizontallyFlipped(),this.graphicElement.get_isVerticallyFlipped());return new _(e,t,i,this.graphicElement.get_shapeRotation())}}var ol=s(3774);class al{}class ll{constructor(e){this.type=al,this.updates=e}}class hl{constructor(e,t,i,r,s){this.glow=e,this.shadow=t,this.innerShadow=i,this.reflection=r,this.softEdges=s}clone(){var e,t,i,r,s;return new hl(null===(e=this.glow)||void 0===e?void 0:e.clone(),null===(t=this.shadow)||void 0===t?void 0:t.clone(),null===(i=this.innerShadow)||void 0===i?void 0:i.clone(),null===(r=this.reflection)||void 0===r?void 0:r.clone(),null===(s=this.softEdges)||void 0===s?void 0:s.clone())}equals(e){return Aa(this.glow,e.glow)&&Aa(this.shadow,e.shadow)&&Aa(this.innerShadow,e.innerShadow)&&Aa(this.reflection,e.reflection)&&Aa(this.softEdges,e.softEdges)}}class cl{constructor(e,t,i,r,s,n){this.hueSaturationLuminance=e,this.brightnessContrast=t,this.recolor=i,this.colorTemperature=r,this.sharpness=s,this.pictureEffectProperties=n}clone(){var e,t,i,r,s,n;return new cl(null===(e=this.hueSaturationLuminance)||void 0===e?void 0:e.clone(),null===(t=this.brightnessContrast)||void 0===t?void 0:t.clone(),null===(i=this.recolor)||void 0===i?void 0:i.clone(),null===(r=this.colorTemperature)||void 0===r?void 0:r.clone(),null===(s=this.sharpness)||void 0===s?void 0:s.clone(),null===(n=this.pictureEffectProperties)||void 0===n?void 0:n.clone())}equals(e){return Aa(this.hueSaturationLuminance,e.hueSaturationLuminance)&&Aa(this.brightnessContrast,e.brightnessContrast)&&Aa(this.recolor,e.recolor)&&Aa(this.colorTemperature,e.colorTemperature)&&Aa(this.sharpness,e.sharpness)&&Aa(this.pictureEffectProperties,e.pictureEffectProperties)}}function dl(e){return e/100}class ul{constructor(e,t,i){this.type=va,this.modelUpdated=new c,this.hostContext=e,this._pptPictureData=t,this._data=i}get data(){return this._data}set data(e){this._data.equals(e)||(this._data=e,this.modelUpdated.emit(new ll(1)))}get geometry(){return this._geometry}set geometry(e){this._geometry!==e&&(this._geometry=e,this.modelUpdated.emit(new ll(2)))}get description(){return this._description=this._pptPictureData.get_alt(),this._description}set description(e){this._description!==e&&(this._description=e,this.modelUpdated.emit(new ll(16)))}get placeholder(){return this._placeholder}set placeholder(e){Aa(this.placeholder,e)||(this._placeholder=e,this.modelUpdated.emit(new ll(256)))}get pictureEffects(){if(void 0===this._pictureEffects||!l("PictureEffectsUndoFix")){if(void 0===this._pptPictureData.get_pictureEffectProperties())return;this._pictureEffects=function(e){var t,i,r,s,n,o,a,l,h;if(void 0===e||0===(null===(t=e.getBrightness)||void 0===t?void 0:t.call(e))&&0===(null===(i=e.getContrast)||void 0===i?void 0:i.call(e))&&100===(null===(r=e.getSaturation)||void 0===r?void 0:r.call(e)))return;let c;const d=function(e,t){if(void 0!==e||void 0!==t)return new ja(dl(null!=e?e:0),dl(null!=t?t:0))}(null!==(n=null===(s=e.getBrightness)||void 0===s?void 0:s.call(e))&&void 0!==n?n:void 0,null!==(a=null===(o=e.getContrast)||void 0===o?void 0:o.call(e))&&void 0!==a?a:void 0),u=function(e){if(void 0!==e)return new Xa(0,dl(null!=e?e:100),100)}(null!==(h=null===(l=e.getSaturation)||void 0===l?void 0:l.call(e))&&void 0!==h?h:void 0);return void 0===d&&void 0===u||(c=new cl,c.brightnessContrast=d,c.hueSaturationLuminance=u),c}(this._pptPictureData.get_pictureEffectProperties())}return this._pictureEffects}set pictureEffects(e){Aa(this._pictureEffects,e)||(this._pictureEffects=e,this.modelUpdated.emit(new ll(128)))}get effects(){if(void 0===this._effects||!l("ShadowReflectionUndoFix")){if(void 0===this._pptPictureData.get_shadowEffectProperties()&&void 0===this._pptPictureData.get_reflectionEffectProperties())return;this._effects=function(e,t){let i;const r=function(e){if(void 0===e||!e.getShadowToggle())return;let t=function(e){if(void 0!==e)return function(e){if(void 0!==e)return 100-e}(e.getTransparency())}(e);return void 0!==t&&(t/=100),new Ra(new ka(e.getColor()[0],e.getColor()[1],e.getColor()[2],null!=t?t:0),e.getBlur(),e.getAngle(),e.getDistance(),e.getSize())}(e),s=function(e){if(void 0!==e&&e.getReflectionToggle())return new Sa(e.getBlur(),e.getTransparency(),0,0,e.getSize()/100,e.getDistance())}(t);return void 0===r&&void 0===s||(i=new hl,i.shadow=r,i.reflection=s),i}(this._pptPictureData.get_shadowEffectProperties(),this._pptPictureData.get_reflectionEffectProperties())}return this._effects}set effects(e){Aa(this._effects,e)||(this._effects=e,this.modelUpdated.emit(new ll(64)))}get crop(){if(void 0===this._crop||!l("CropUndoFix")){if(void 0===this._pptPictureData.get_crop)return;this._crop=function(e){let t;if(void 0!==e)return t=new ea(100*e.Left,100*e.Top,100*e.Right,100*e.Bottom),t}(this._pptPictureData.get_crop())}return this._crop}set crop(e){Aa(this._crop,e)||(this._crop=e,this.modelUpdated.emit(new ll(2)))}get opacity(){return void 0!==this._opacity&&l("PictureEffectsUndoFix")||(this._opacity=function(e){var t,i;if(void 0!==e&&0!==(null===(t=null==e?void 0:e.getTransparency)||void 0===t?void 0:t.call(e)))return function(e){if(void 0!==e)return 100-e}(null===(i=e.getTransparency)||void 0===i?void 0:i.call(e))}(this._pptPictureData.get_pictureEffectProperties())),this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=e,this.modelUpdated.emit(new ll(32)))}clone(){const e=new ul(this.hostContext,this._pptPictureData,this._data);return e._geometry=this._geometry,e._description=this._description,e._pictureEffects=this._pictureEffects,e._effects=this._effects,e._opacity=this._opacity,e._crop=this._crop,e}}class fl{constructor(){}static getInstance(){return void 0===fl.instance&&(fl.instance=new fl),fl.instance}async getPictureBlobDataFromHostPictureMetadata(e){throw new Error("Method not implemented.")}isHostPictureMetadata(e){throw new Error("Method not implemented.")}getPlaceholderIcon(e){throw new Error("Method not implemented.")}createPictureData(e,t){throw new Error("Method not implemented.")}}class pl{constructor(e,t,i){this.type=No,this.layoutUpdated=new c,this.onModelUpdated=()=>{this.updateLayout().catch((()=>{}))},this.hostContext=e,this.smartArtData=t,this.smartArtLayoutCreator=i,this.modelUpdated=this.smartArtData.modelUpdated,this.updateLayout().catch((()=>{})),this.modelUpdated.on(this.onModelUpdated)}teardown(){this.modelUpdated.off(this.onModelUpdated)}get layout(){return this.smartArtLayout}deleteSubShapes(e){return this.smartArtData.deleteSubShapes(e)}setSubShapeFillColor(e,t){return this.smartArtData.setSubShapeFillColor(e,t)}clone(){throw Error("Not implemented")}setLayout(e){this.smartArtLayout=e,this.layoutUpdated.emit()}async updateLayout(){return this.smartArtLayoutCreator(this.smartArtData).then((e=>{this.setLayout(e)}))}}class ml{constructor(){this.diagramType="",this.diagramCategory="",this.styleType="",this.styleCategory="",this.colorTransformType="",this.colorTransformCategory="",this.typographicalEmphasis="",this.isPlaceholder=!1}}class gl{constructor(e){this.text="",this.elementType=2,this.elementProps=new ml,this._modelId=e}get modelId(){return this._modelId}get id(){return this._modelId}get hasText(){return!1}get alt(){return""}get altTitle(){return""}get shapeTypeString(){return""}}class vl{constructor(){this.itemsMap=new Map,this.idArray=[]}addItem(e,t){this.itemsMap.has(e.id)||(this.itemsMap.set(e.id,e),this.idArray.splice(null!=t?t:this.idArray.length,0,e.id))}addItems(e){for(const t of e)this.addItem(t)}removeItem(e){this.removeItemById(e.id)}removeItems(e){for(const t of e)this.removeItem(t)}removeItemById(e){this.itemsMap.delete(e);const t=this.getIndexById(e);-1!==t&&this.idArray.splice(t,1)}removeItemsByIds(e){for(const t of e)this.removeItemById(t)}get length(){return this.itemsMap.size}getItemById(e){return this.itemsMap.get(e)}getItemByIndex(e){if(!(e<0||e>=this.idArray.length))return this.itemsMap.get(this.idArray[e])}getItemByCondition(e){for(const[,t]of this.itemsMap)if(e(t))return t}getIndexById(e){return this.idArray.indexOf(e)}changeItemIndex(e,t){if(t>=this.idArray.length||t<0)return;const i=this.getIndexById(e);return-1!==i&&i!==t?(this.idArray.splice(i,1),this.idArray.splice(t,0,e),i):void 0}[Symbol.iterator](){let e=0;return{next:()=>{if(e>=this.idArray.length)return{done:!0,value:void 0};const t=this.idArray[e];e+=1;const i=this.getItemById(t);if(void 0===i)throw new Error(`Invalid item ID ${t}`);return{done:!1,value:i}}}}}var _l=s(943);class yl{constructor(e){this._elementProps=new ml,this._text="",this._smartArtElement=e}get modelId(){return(0,_l.n)(this._smartArtElement.get_smartArtModelId())}get id(){return this.modelId}get elementType(){return this._smartArtElement.get_smartArtElementType()}get elementProps(){return this._elementProps}get text(){return this._text}get hasText(){return 3!==this.elementType||this._smartArtElement.get_associatedIds().length>0}get alt(){return this._smartArtElement.get_alt()}get altTitle(){return this._smartArtElement.get_altTitle()}get shapeTypeString(){return 3===this.elementType&&null!==this._smartArtElement.get_shapeTypeString?this._smartArtElement.get_shapeTypeString():""}}class bl{constructor(e){this.documentElement=new gl(""),this._elementCollection=e}get elements(){const e=new vl;return this._elementCollection.get_items().map((t=>{t.get_isSVGBlipFilled()||e.addItem(new yl(t))})),e}get elementCount(){return this.elements.length}getElements(e,t){const i=[];for(let r=e;r<(null!=t?t:this.elementCount);r+=1)i.push(this.getElementByIndex(r));return i}getElementById(e){return this.elements.getItemById(e)}getElementByIndex(e){return this.elements.getItemByIndex(e)}getIndexById(e){return this.elements.getIndexById(e)}[Symbol.iterator](){return this.elements[Symbol.iterator]()}addElement(e){return new gl("")}addElementWithModelId(e,t){return new gl(t)}deleteElement(e){}}class wl{constructor(e){this.modelUpdated=new c,this._pptSmartArtData=e,this._elementList=new bl(this._pptSmartArtData.get_elementCollection())}get elementList(){return this._elementList}deleteSubShapes(e){return this._pptSmartArtData.deleteSubShapes(e)}setSubShapeFillColor(e,t){return this._pptSmartArtData.setSubShapeFillColor(e,t)}}class Tl{constructor(e){this._transform=e}get transform(){return this._transform}set transform(e){this._transform=e}}class xl{constructor(e,t){this._pptSmartArtElement=e,this._parentSmartArt=t}get modelId(){return(0,_l.n)(this._pptSmartArtElement.get_smartArtModelId())}get shapeProps(){return new Tl(this.createSmartArtShapeTransform())}get semanticModelId(){return this._semanticModelId}createSmartArtShapeTransform(){const e=this._pptSmartArtElement.get_xPersisted()-this._parentSmartArt.get_xPersisted(),t=this._pptSmartArtElement.get_yPersisted()-this._parentSmartArt.get_yPersisted(),i=new g(e,t),r=new v(this._pptSmartArtElement.get_widthPersisted(),this._pptSmartArtElement.get_heightPersisted()),s=new m(this._pptSmartArtElement.get_isHorizontallyFlipped(),this._pptSmartArtElement.get_isVerticallyFlipped());return new _(i,r,s,this._pptSmartArtElement.get_shapeRotation())}}class Cl{constructor(e){this._parentSmartArt=e}get shapes(){return this._parentSmartArt.ensureModelData().get_elementCollection().get_items().map((e=>new xl(e,this._parentSmartArt)))}}class Pl{}class Sl{constructor(e,t,i,r,s=!1,n=""){this.type=Pl,this.modelUpdated=new c,this.hostContext=e,this._source=t,this._imageSource=i,this._geometry=r,this._looping=s,this._altText=n}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.modelUpdated.emit()}get source(){return this._source}set source(e){this._source=e,this.modelUpdated.emit()}get imageSource(){return this._imageSource}set imageSource(e){this._imageSource=e,this.modelUpdated.emit()}get fallbackRenderData(){return this._fallbackRenderData}set fallbackRenderData(e){this._fallbackRenderData=e,this.modelUpdated.emit()}get looping(){return this._looping}set looping(e){this._looping=e,this.modelUpdated.emit()}get altText(){return this._altText}set altText(e){this._altText=e,this.modelUpdated.emit()}clone(){throw Error("Not implemented")}}function El(e,t){switch(e.getGraphicType()){case Fn.O.SmartArt:return function(e,t){const i=e.getGraphicElement();(0,T.PN)(0,`PptGraphicElement info: sid=${i.get_sid()}, cid=${i.get_cid()}, shapeId=${i.get_shapeId()}}`);const r=i,s=new wl(r.ensureModelData()),n=new pl(t,s,(o=r,async e=>Promise.resolve(new Cl(o))));var o;return new Zn(e.getId(),n,new nl(i))}(e,t);case Fn.O.Chart:return function(e,t){return new Zn(e.getId(),new rl(t),new nl(e.getGraphicElement()))}(e,t);case Fn.O.Video:return function(e,t){const i=e.getVideoData();if(null===i)throw new Error("Missing video data");const r=new Sl(t,{isNative:i.getIsNative(),url:i.getSource()},void 0,void 0,void 0!==i.getIsDesignerVideo&&i.getIsDesignerVideo(),void 0!==i.getAltText?i.getAltText():""),s=i.getShapeType();return null!==s&&(0,ol.J)(r,s),new Zn(e.getId(),r,new nl(e.getGraphicElement()))}(e,t);case Fn.O.Picture:return function(e,t){const i=e.getPictureData(),r=e.getGraphicElement();if(null===i)throw new Error("Missing picture data");const s=yo(new URL(i.getPlaceholderImage()),fl.getInstance()),n=new ul(t,r,s),o=i.getShapeType();return null!==o&&(0,ol.J)(n,o),new Zn(e.getId(),n,new nl(e.getGraphicElement()))}(e,t);default:throw new Error("Cannot create Graphic for given IGraphicData")}}function Ml(e){return(t,i,r)=>new $n(e(t,i,r))}function Rl(e){return(t,i,r)=>new $n(!0,e(t,i,r))}function Bl(e){return(t,i,r)=>new $n(!0,[e(t,i.graphic.model,r)])}function Il(e){return(t,i,r)=>new $n(!0,e(t,i.graphic.model,r))}async function Al(e,t,i){var r,s;const n=await(null!==(r=null==e?void 0:e.toDataURL())&&void 0!==r?r:null===(s=function(e){const t=vo.getInstance().getDownloadDetails(e.data.id),i=null==t?void 0:t.renderUrl;if(void 0!==i)return new Ds(i)}(t))||void 0===s?void 0:s.toDataURL());if(void 0===n)throw new Error(`getPictureInput: ${i} failed - Input picture is not available`);return n}async function Fl(e,t,i,r,s=2e4){var n;void 0!==e.preAction&&r.actionInvoker.invoke(e.preAction);const o=await t(e),a=await function(e){var t;const i=null===(t=Ps)||void 0===t?void 0:t.get(e);if(void 0===i)throw new Error(`No executor found for operation ${e}`);return i()}(o.opType).executeOp(o,s);if(void 0!==e.resultHandler)try{await e.resultHandler(a)}catch(e){(0,T.KE)(0,`handlePictureAIActionAsync: ${o.opType} resultHandler failed - ${e.message}`)}if(void 0!==a.result)if(e.updatePicture){const e=await i(a.result);void 0!==e&&r.actionInvoker.invoke(e)}else(0,T.PN)(0,`handlePictureAIActionAsync: ${o.opType} Picture model not updated with result`);else(0,T.H)(0,`handlePictureAIActionAsync: ${o.opType} failed - ${null===(n=a.error)||void 0===n?void 0:n.message}`);void 0!==e.postAction&&r.actionInvoker.invoke(e.postAction)}async function kl(e,t,i){await Fl(e,(async e=>async function(e,t){let i;const r=await e.toDataURL();return t&&(i=async e=>Object.assign(Object.assign({},e),{picture:new Ds(await Os(r,512,!0,1,"image/png"))})),new Fs("SmartCrop",{picture:e},i)}(new Ds(await Al(e.pictureContent,t,e.actionType)),e.downsample)),(t=>Promise.resolve(new fa(t.srcRect,void 0,e.graphic))),i)}const Dl="setPictureData";class Ll{constructor(e,t){this.actionType=Dl,this.data=e,this.graphic=t}}class Ol{async getPictureBlobDataFromHostPictureMetadata(e){throw new Error("Method not implemented.")}isHostPictureMetadata(e){throw new Error("Method not implemented.")}getPlaceholderIcon(e){throw new Error("Method not implemented.")}createPictureData(e,t){throw new Error("Method not implemented.")}}async function Ul(e,t,i){await Fl(e,(async e=>async function(e){return new Fs("AutoFocus",{picture:e})}(new Ds(await Al(e.pictureContent,t,e.actionType)))),(async t=>new Ll(yo(await t.picture.toDataURL(),new Ol),e.graphic)),i)}async function Vl(e,t,i){await Fl(e,(async e=>async function(e,t){return new Fs("Filter",{picture:e,filterType:t})}(new Ds(await Al(e.pictureContent,t,e.actionType)),e.filterType)),(async t=>new Ll(yo(await t.picture.toDataURL(),new Ol),e.graphic)),i)}class Nl{constructor(e){this.actionType="SetAltText",this.altText=e}}async function Gl(e,t,i){await Fl(e,(async e=>async function(e){let t;const i=await e.toDataURL();return t=async e=>Object.assign(Object.assign({},e),{picture:new Ds(await Os(i,350,!0,1,"image/png"))}),new Fs("AltText",{picture:e},t)}(new Ds(await Al(e.pictureContent,t,e.actionType)))),(e=>Promise.resolve(new Nl(e.altText))),i)}async function zl(e,t,i){await Fl(e,(async e=>async function(e){return new Fs("OneClickEnhancer",{picture:e})}(new Ds(await Al(e.pictureContent,t,e.actionType)))),(async t=>new Ll(yo(await t.picture.toDataURL(),new Ol),e.graphic)),i)}async function Hl(e,t,i){await Fl(e,(async i=>Ns(new Ds(await Al(i.pictureContent,t,i.actionType)),e.bgrOpType,e.downsample,e.useMask,e.blurRadiusInPixel)),(async t=>new Ll(yo(await t.picture.toDataURL(),new Ol),e.graphic)),i)}async function Wl(e,t,i){await Fl(e,(async e=>async function(e){return new Fs("SuperResolution",{picture:e})}(new Ds(await Al(e.pictureContent,t,e.actionType)))),(async t=>new Ll(yo(await t.picture.toDataURL(),new Ol),e.graphic)),i)}function $l(e){return(t,i,r)=>(e(t,i,r).then((()=>{})).catch((()=>{})),[])}class ql{constructor(e){this.type=jl,this.graphics=[],this.selections=[];for(const t of e)this.graphics.push(t);for(const t of e.selections)this.selections.push(t.save())}restore(e){e.setGraphics(this.graphics);for(let t=0;t<this.selections.length;t+=1){const i=this.selections[t];void 0!==i&&e.selections[t].restore(i)}}}class jl{}class Xl{get selections(){return this._selections}constructor(e,t){this.type=jl,this.selectionUpdated=new c,this.childSelectionUpdated=new c,this._selections=[],this.graphics=[],this.idsToSelections=new Map,this.onGraphicCollectionChanged=e=>{(function(e){return void 0!==e&&e.type===Mn})(e)&&this.removeGraphics(e.removed)},this.onChildSelectionUpdated=()=>{this.childSelectionUpdated.emit()},this.graphic=e,this.selectionCreator=t,this.graphic.model.modelUpdated.on(this.onGraphicCollectionChanged)}teardown(){this.graphic.model.modelUpdated.off(this.onGraphicCollectionChanged),this.clear()}hasGraphic(e){return void 0!==this.idsToSelections.get(e.id)}addGraphics(e){for(const t of e){if(this.idsToSelections.has(t.id))continue;const e=this.graphic.model.getGraphic(t.id);if(void 0===e)continue;const i=this.createSelection(e);this.graphics.push(e),this._selections.push(i),this.idsToSelections.set(e.id,i)}this.selectionUpdated.emit()}removeGraphics(e){const[t,i]=[new Set,new Set];for(const r of e){const e=r.id,s=this.idsToSelections.get(e);void 0!==s&&(t.add(e),i.add(s),this.idsToSelections.delete(e))}if(!(t.size<=0)){for(const e of i)this.removeSelection(e);this.graphics=this.graphics.filter((e=>!t.has(e.id))),this._selections=this._selections.filter((e=>!i.has(e))),this.selectionUpdated.emit()}}setGraphics(e){if(0===e.length)return void this.clear();const t=[],i=[];for(const r of e){const e=r.id,s=this.graphic.model.getGraphic(e);if(void 0===s)continue;const n=this.idsToSelections.get(e);void 0!==n?(this.idsToSelections.delete(e),t.push(n)):t.push(this.createSelection(s)),i.push(s)}this.idsToSelections.forEach((e=>{this.removeSelection(e)})),this._selections=t,this.graphics=i,this.idsToSelections.clear();for(const e of this._selections)this.idsToSelections.set(e.graphic.id,e);this.selectionUpdated.emit()}clear(){this.selections.length<=0||(this._selections.forEach((e=>{this.removeSelection(e)})),this._selections=[],this.graphics=[],this.idsToSelections.clear(),this.selectionUpdated.emit())}get length(){return this.graphics.length}[Symbol.iterator](){return this.graphics[Symbol.iterator]()}save(){return new ql(this)}restore(e){(function(e){return e.type===jl})(e)&&e.restore(this)}clone(e){const t=new Xl(e,this.selectionCreator);for(const[i,r]of this.idsToSelections){const s=e.model.getGraphic(i);if(void 0!==s){const e=r.clone(s);t.graphics.push(s),t._selections.push(e),t.idsToSelections.set(s.id,e)}}return t}createSelection(e){const t=this.selectionCreator.createSelection(e);return t.selectionUpdated.on(this.onChildSelectionUpdated),t}removeSelection(e){var t;null===(t=e.deselected)||void 0===t||t.emit(),e.selectionUpdated.off(this.onChildSelectionUpdated),e.teardown()}}class Yl extends On.B{performAction(e,t,i){const r=this.get(e.actionType);return void 0===r?new $n(!1):r(e,t,i)}}const Kl="toggleGraphicSel";class Zl{constructor(e){this.actionType=Kl,this.graphic=e}}const Jl="clrSel";class Ql{constructor(){this.actionType=Jl}}const eh="selGrphAct";class th{constructor(e,t=!1){this.actionType=eh,this.graphics=[],this.isFirstTimeSelect=!1,this.graphics=e,this.clearExisting=t}}const ih="removeGraphics";class rh{constructor(e){this.actionType=ih,this.graphics=e}}const sh="changeZOrder";class nh{constructor(e){this.actionType=sh,this.changeOrderType=e}}class oh{constructor(e,t){this.collection=e,this.graphics=t}perform(){return this.collection.addGraphics(this.graphics),{undoOp:new ah(this.collection,this.graphics)}}}class ah{constructor(e,t){this.collection=e,this.graphics=t}perform(){return this.collection.removeGraphics(this.graphics),{undoOp:new oh(this.collection,this.graphics)}}}class lh{perform(){return{undoOp:new lh}}}class hh{constructor(e,t,i){this.graphicCollection=e,this.graphic=t,this.index=i}perform(){const e=this.graphicCollection.setGraphicOrder(this.graphic,this.index);return void 0===e?{undoOp:new lh}:{undoOp:new hh(this.graphicCollection,this.graphic,e)}}}class ch{constructor(e,t,i){this.graphicCollection=e,this.graphic=t,this.changeOrderType=i}perform(){const e=this.graphicCollection.changeGraphicOrder(this.graphic,this.changeOrderType);return void 0===e?{undoOp:new lh}:{undoOp:new hh(this.graphicCollection,this.graphic,e)}}}class dh{constructor(e=1,t=0,i=0,r=1,s=0,n=0){this.m11=e,this.m12=t,this.m21=i,this.m22=r,this.m31=s,this.m32=n}apply(e){const t=this.m11*e.m11+this.m12*e.m21,i=this.m11*e.m12+this.m12*e.m22,r=this.m21*e.m11+this.m22*e.m21,s=this.m21*e.m12+this.m22*e.m22,n=this.m31*e.m11+this.m32*e.m21+e.m31,o=this.m31*e.m12+this.m32*e.m22+e.m32;return this.m11=t,this.m12=i,this.m21=r,this.m22=s,this.m31=n,this.m32=o,this}translate(e,t){return this.apply(uh(e,t))}scale(e,t){return this.apply(fh(e,t))}rotate(e){return this.apply(function(e){const t=Math.cos(e),i=Math.sin(e);return new dh(t,i,-i,t,0,0)}(e))}}function uh(e,t){return new dh(1,0,0,1,e,t)}function fh(e,t){return new dh(e,0,0,t,0,0)}function ph(e){const{pos:t,size:i,flip:r,rot:s}=e;if(0===s&&!r.x&&!r.y)return new p(t.x,t.y,t.x+i.width,t.y+i.height);const n=new f(t.x,t.y),o=new f(t.x+i.width,t.y),a=new f(t.x,t.y+i.height),l=new f(t.x+i.width,t.y+i.height),h=e.getCenter(),c=uh(-h.x,-h.y).scale(r.x?-1:1,r.y?-1:1).rotate((0,u.Yr)(s)).translate(h.x,h.y);n.multiply(c),o.multiply(c),a.multiply(c),l.multiply(c);const d=Math.min(n.x,o.x,a.x,l.x),m=Math.min(n.y,o.y,a.y,l.y),g=Math.max(n.x,o.x,a.x,l.x),v=Math.max(n.y,o.y,a.y,l.y);return new p(d,m,g,v)}class mh{constructor(e,t){this.type=0,this.x=e,this.y=t}}class gh{constructor(e,t,i,r,s=!1){this.type=1,this.scaleX=e,this.scaleY=t,this.originX=i,this.originY=r,this.lockAspectRatio=s}}class vh{constructor(e){this.type=2,this.rotation=e}}function _h(e,t){const i=[...t],r=i.map((e=>ph(e.anchor.transform)));let s;return s=void 0!==e.alignToBounds?e.alignToBounds:r.reduce(((e,t)=>new p(Math.min(e.left,t.left),Math.min(e.top,t.top),Math.max(e.right,t.right),Math.max(e.bottom,t.bottom))),new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE)),ys("GC2Align",new Map([["AlignType",e.alignType.toString()]])),i.map(((t,i)=>new ra(t.anchor,sa(t.anchor.transform,function(e,t,i){switch(e){case 0:return new mh(t.left-i.left,0);case 1:return new mh(t.center().x-i.center().x,0);case 2:return new mh(t.right-i.right,0);case 3:return new mh(0,t.top-i.top);case 4:return new mh(0,t.center().y-i.center().y);case 5:return new mh(0,t.bottom-i.bottom);default:(0,xs.t)(e)}}(e.alignType,s,r[i]),!0))))}function yh(e,t){const i=[];for(const e of t)i.push({graphic:e,bounds:ph(e.anchor.transform)});if(i.length<3)return[];const{closestGraphicToBounds:r,furthestGraphicToBounds:s,closestBoundToOrigin:n,furthestBoundToOrigin:o}=function(e,t){let i,r,s=Number.MIN_VALUE,n=Number.MAX_VALUE;if(void 0!==t.distributeToBounds)n=0===t.distributeType?t.distributeToBounds.left:t.distributeToBounds.top,s=0===t.distributeType?t.distributeToBounds.right:t.distributeToBounds.bottom;else for(const o of e){const e=o.bounds,a=0===t.distributeType?e.right:e.bottom,l=0===t.distributeType?e.left:e.top;a<n&&(i=o.graphic,n=a),l>s&&(r=o.graphic,s=l)}return{closestGraphicToBounds:i,furthestGraphicToBounds:r,closestBoundToOrigin:n,furthestBoundToOrigin:s}}(i,e),a=i.filter((({graphic:e})=>e!==r&&e!==s)),l=function(e,t){let i=0;if(0===t)for(const t of e)i+=t.bounds.width();else for(const t of e)i+=t.bounds.height();return i}(a,e.distributeType);0===e.distributeType?a.sort(bh):a.sort(wh);const h=void 0===e.distributeToBounds?i.length-1:i.length+1;let c=n;const d=(o-n-l)/h;return a.map((t=>{const i=c+d;return c=0===e.distributeType?i+t.bounds.width():i+t.bounds.height(),new ra(t.graphic.anchor,sa(t.graphic.anchor.transform,function(e,t,i){switch(e){case 0:return new mh(t-i.left,0);case 1:return new mh(0,t-i.top);default:(0,xs.t)(e)}}(e.distributeType,i,t.bounds),!0))}))}function bh(e,t){return e.bounds.left+e.bounds.width()/2-(t.bounds.left+t.bounds.width()/2)}function wh(e,t){return e.bounds.top+e.bounds.height()/2-(t.bounds.top+t.bounds.height()/2)}class Th{constructor(e,t){this.collection=e,this.graphics=t}perform(){const e=this.graphics.map((e=>[e,this.collection.getGraphicOrder(e)])).filter((e=>void 0!==e[1]));return this.collection.removeGraphics(this.graphics),{undoOp:new xh(this.collection,e)}}}class xh{constructor(e,t){this.collection=e,this.graphics=t}perform(){return this.collection.addGraphicsAt(this.graphics.sort(((e,t)=>e[1]-t[1]))),{undoOp:new Th(this.collection,this.graphics.map((([e])=>e)))}}}class Ch{constructor(e,t,i){this.collection=e,this.source=t,this.target=i}perform(){const e=this.collection.getGraphicOrder(this.source);return void 0===e?{undoOp:new lh}:(this.collection.removeGraphics([this.source]),this.collection.addGraphicsAt([[this.target,e]]),{undoOp:new Ch(this.collection,this.target,this.source)})}}class Ph{constructor(e,t){this.graphicCollectionSelection=e,this.graphics=t}perform(){return this.graphicCollectionSelection.setGraphics(this.graphics),{undoOp:new lh}}}function Sh(e,t){return t.hasGraphic(e.graphic)?t.removeGraphics([e.graphic]):t.addGraphics([e.graphic]),!0}function Eh(e,t){const i=[];for(const e of t.graphic.model)i.push(e);return t.setGraphics(i),!0}function Mh(e,t){return t.clear(),!0}function Rh(e,t,i){let r=e.clearExisting;return e.graphics.forEach((e=>{r=r||!t.hasGraphic(e)})),r&&(t.setGraphics(e.graphics),l("QuillSelectionRefactor")||(e.isFirstTimeSelect=!0,i.actionInvoker.invoke(e))),!0}function Bh(e,t){const i=e.graphics,r=[new oh(t.graphic.model,i)];return e.selectGraphics&&r.push(new Ph(t,i)),r}function Ih(e,t){var i;return[new Th(t.graphic.model,null!==(i=e.graphics)&&void 0!==i?i:[...t])]}function Ah(e,t){return[new Ch(t.graphic.model,e.source,e.target)]}function Fh(e,t){const i=[],r=e.changeOrderType,s=[];for(const e of t)s.push(e);switch(r){case 0:case 3:s.reverse().forEach((e=>{i.push(new ch(t.graphic.model,e,r))}));break;case 1:case 2:s.forEach((e=>{i.push(new ch(t.graphic.model,e,r))}));break;default:(0,xs.t)(r)}return i}function kh(e,t,i){var r,s;const n=[],o=e.source.type===e.target.model.type?e.target.clone(e.id):new Zn(e.id,e.source,e.target.anchor),a=null===(s=null===(r=i.previewInfo)||void 0===r?void 0:r.replacePreviewInfo)||void 0===s?void 0:s.replaceRegistry;if(void 0!==a){const t=e.source.type===e.target.model.type?e.source:e.target.model;a.performReplace(t,o)}return n.push(new Ch(t.graphic.model,e.target,o)),n}var Dh;!function(e){e[e.None=0]="None",e[e.Alt=1]="Alt",e[e.Ctrl=2]="Ctrl",e[e.Shift=4]="Shift",e[e.CtrlAlt=3]="CtrlAlt",e[e.CtrlShift=6]="CtrlShift",e[e.CtrlAltShift=7]="CtrlAltShift"}(Dh||(Dh={}));class Lh extends On.B{constructor(e){super([]);for(const t of e)this.registerShortcut(t)}registerShortcut(e){const t=this.get(e.key);void 0!==t?t[e.modifiers]=e.performer:this.register(e.key,{[e.modifiers]:e.performer})}performShortcut(e,t,i){const r=this.get(function(e){const t=e.key;return 1===t.length&&(e.shiftKey||e.getModifierState("CapsLock"))?t.toLocaleLowerCase():t}(e));if(void 0!==r){const s=r[function(e){let t=Dh.None;return e.altKey&&(t|=Dh.Alt),(window.navigator.userAgent.indexOf("Macintosh")>=0?e.metaKey:e.ctrlKey)&&(t|=Dh.Ctrl),e.shiftKey&&(t|=Dh.Shift),t}(e)];if(void 0!==s)return s(e,t,i)}return{isHandled:!1}}}function Oh(e,t){return Nh(new mh(e,t))}function Uh(e,t){return Nh(new gh(e,t,0,0))}function Vh(e){return Nh(new vh(e))}function Nh(e){return(t,i,r)=>(r.actionInvoker.invoke(new na(e)),{isHandled:!0})}function Gh(e,t,i){return i.actionInvoker.invoke(new rh),{isHandled:!0}}function zh(e,t,i){return t.length>0?(i.actionInvoker.invoke(new Ql),{isHandled:!0}):{isHandled:!1}}function Hh(e,t){return function(e,t){const i=e.graphic.model,r=i.length;if(0===r)return!1;let s;if(0===e.length)s=0===t?0:r-1;else{const n=e.selections[e.length-1],o=i.getGraphicOrder(n.graphic);if(void 0===o)return!1;s=(o+(1===t?-1:1))%r}const n=i.getGraphicAt(s);void 0!==n&&e.setGraphics([n])}(t,e.shiftKey?1:0),{isHandled:!0}}function Wh(e){return(t,i,r)=>(r.actionInvoker.invoke(new nh(e)),{isHandled:!0})}class $h{dispatchAction(e,t,i,r){let s=!1;const n=[];for(const r of t.selections){const t=i.editorRegistry.performAction(e,r,i);t.performed&&(s=!0,t.editOps.length>0&&n.push(...t.editOps))}return s?new $n(!0,n):r.performAction(e,t,i)}dispatchKeyboardEvent(e,t,i,r){if(1===t.selections.length){const r=i.editorRegistry.processKeyboardEvent(e,t.selections[0],i);if(r.isHandled)return r}return"keydown"===e.type?r.performShortcut(e,t,i):{isHandled:!1}}}function qh(e,t){const i=t.graphic.anchor;return[new da(t.graphic.model,e.crop),new ra(i,oa(i.transform,new na(e.scale)))]}class jh{constructor(e,t,i,r=!1){this.model=e,this.prop=t,this.value=i,r&&(this.mergePolicy=new Yh(e,t))}perform(){const e=this.model[this.prop];return this.model[this.prop]=this.value,{undoOp:new jh(this.model,this.prop,e)}}}class Xh{}class Yh{constructor(e,t){this.type=Xh,this.model=e,this.prop=t}shouldMergeWithPrevious(e){return void 0!==e&&e.type===Xh&&e.model===this.model&&e.prop===this.prop}}function Kh(e){return 2===e.type}class Zh{constructor(e,t,i,r,s,n,o,a){this.fill=e,this.weight=t,this.dash=i,this.headEnd=r,this.tailEnd=s,this.join=n,this.compound=o,this.cap=a}clone(){var e,t,i,r,s;return new Zh(null===(e=this.fill)||void 0===e?void 0:e.clone(),this.weight,null===(t=this.dash)||void 0===t?void 0:t.clone(),null===(i=this.headEnd)||void 0===i?void 0:i.clone(),null===(r=this.tailEnd)||void 0===r?void 0:r.clone(),null===(s=this.join)||void 0===s?void 0:s.clone(),this.compound,this.cap)}equals(e){return Aa(this.fill,e.fill)&&this.weight===e.weight&&Aa(this.dash,e.dash)&&Aa(this.headEnd,e.headEnd)&&Aa(this.tailEnd,e.tailEnd)&&Aa(this.join,e.join)&&this.compound===e.compound&&this.cap===e.cap}resolveFrom(e){void 0!==this.fill&&!Kh(this.fill)||void 0===e.fill||(this.fill=e.fill.clone()),void 0===this.weight&&void 0!==e.weight&&(this.weight=e.weight),void 0===this.dash&&void 0!==e.dash&&(this.dash=e.dash.clone()),void 0===this.headEnd&&void 0!==e.headEnd&&(this.headEnd=e.headEnd.clone()),void 0===this.tailEnd&&void 0!==e.tailEnd&&(this.tailEnd=e.tailEnd.clone()),void 0===this.join&&void 0!==e.join&&(this.join=e.join.clone()),void 0===this.compound&&void 0!==e.compound&&(this.compound=e.compound),void 0===this.cap&&void 0!==e.cap&&(this.cap=e.cap)}}function Jh(e){return e<0?0:e<=.798354?12.92*e:e<255?269.025*Math.pow(e/255,1/2.4)-14.025:255}function Qh(e,t,i){const r=function(e){return e<0?e+360:e>=360?e-360:e}(i);return r<60?e+(t-e)*r/60:r<180?t:r<240?e+(t-e)*(240-r)/60:e}function ec(e){return e.transforms.length>0?function(e){return new ka(Ba(e.r),Ba(e.g),Ba(e.b),e.a)}(function(e){return function(e){return 4===e.type}(e)?function(e){const t=e.h,i=e.s,r=e.l,s=r<=.5?r*(i+1):r+i-r*i,n=2*r-s;return new ka(255*Qh(n,s,t+120),255*Qh(n,s,t),255*Qh(n,s,t-120),e.a)}(e):function(e){return 3===e.type}(e)?function(e){return new ka(Jh(e.r),Jh(e.g),Jh(e.b),e.a)}(e):e}(e.transforms.reduce(((e,t)=>t.transform(e)),e))):e}function tc(e,t){if(Da(e))return ec(e);if(function(e){return 1===e.type}(e)){if(void 0===t)throw new Error("ThemeInfo should be provided to resolve SchemeColors.");return ec(function(e,t){const i=e.theme.colorScheme.presets[e.schemeMapping[t.presetColorType]];return new ka(i.r,i.g,i.b,i.a,[...t.transforms])}(t,e))}throw new Error(`Unsupported color type to resolve: ${e.type}.`)}class ic{constructor(e,t,i){this.picture=e,this.placeholder=t,this.isUndoable=i}perform(){const e=this.isUndoable?new ic(this.picture,this.picture.placeholder,this.isUndoable):void 0;return this.picture.placeholder=this.placeholder,{undoOp:e}}}const rc="GC2PictureModification";function sc(e,t){return new jh(t,"fill",e.fill)}function nc(e,t){return new jh(t,"line",function(e,t){const i=void 0!==e?e.clone():new Zh;return void 0!==t.fill&&(i.fill=t.fill),void 0!==t.weight&&(i.weight=t.weight),void 0!==t.dash&&(i.dash=t.dash),void 0!==t.headEnd&&(i.headEnd=t.headEnd),void 0!==t.tailEnd&&(i.tailEnd=t.tailEnd),void 0!==t.join&&(i.join=t.join),void 0!==t.compound&&(i.compound=t.compound),i}(t.line,e))}function oc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new hl;return void 0!==t.glow&&(r.glow=t.glow),void 0!==t.shadow&&(r.shadow=t.shadow),void 0!==t.innerShadow&&(r.innerShadow=t.innerShadow),void 0!==t.reflection&&(r.reflection=t.reflection),void 0!==t.softEdges&&(r.softEdges=t.softEdges),r}(t.effects,e);return new jh(t,"effects",i)}function ac(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new cl;return void 0!==t.brightnessContrast&&(r.brightnessContrast=t.brightnessContrast),void 0!==t.colorTemperature&&(r.colorTemperature=t.colorTemperature),void 0!==t.hueSaturationLuminance&&(r.hueSaturationLuminance=t.hueSaturationLuminance),void 0!==t.pictureEffectProperties&&(r.pictureEffectProperties=t.pictureEffectProperties),void 0!==t.recolor&&(r.recolor=t.recolor),void 0!==t.sharpness&&(r.sharpness=t.sharpness),r}(t.pictureEffects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"pictureEffects",i,e.mergeUndo)}function lc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new hl;return void 0!==r.shadow?r.shadow.radius=t.blur:r.shadow=new Ra(Ua,t.blur,90,0),r}(t.effects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"effects",i,e.mergeUndo)}function hc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new hl;return void 0!==r.shadow?r.shadow.distance=t.distance:r.shadow=new Ra(Ua,0,90,t.distance),r}(t.effects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"effects",i,e.mergeUndo)}function cc(e,t){const i=function(e,t,i){var r;const s=null!==(r=null==e?void 0:e.clone())&&void 0!==r?r:new hl;if(void 0!==s.shadow){const e=tc(s.shadow.color,i);s.shadow.color=new ka(e.r,e.g,e.b,t.opacity)}else s.shadow=new Ra(new ka(0,0,0,t.opacity),0,90,0);return s}(t.effects,e,t.hostContext.themeInfo);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"effects",i,e.mergeUndo)}function dc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new hl;return void 0!==r.shadow?r.shadow.angle=t.angle:r.shadow=new Ra(Ua,0,t.angle,0),r}(t.effects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"effects",i,e.mergeUndo)}function uc(e,t){const i=function(e,t,i){var r;const s=null!==(r=null==e?void 0:e.clone())&&void 0!==r?r:new hl,n=t.color;if(void 0!==s.shadow){const e=tc(s.shadow.color,i);s.shadow.color=new ka(n.r,n.g,n.b,e.a)}else s.shadow=new Ra(n,0,90,0);return s}(t.effects,e,t.hostContext.themeInfo);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"effects",i,e.mergeUndo)}function fc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new cl;return void 0!==r.brightnessContrast?r.brightnessContrast.brightness=t.brightness:r.brightnessContrast=new ja(t.brightness,0),r}(t.pictureEffects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"pictureEffects",i,e.mergeUndo)}function pc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new cl;return void 0!==r.brightnessContrast?r.brightnessContrast.contrast=t.contrast:r.brightnessContrast=new ja(0,t.contrast),r}(t.pictureEffects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"pictureEffects",i,e.mergeUndo)}function mc(e,t){const i=function(e,t){var i;const r=null!==(i=null==e?void 0:e.clone())&&void 0!==i?i:new cl;return void 0!==r.hueSaturationLuminance?r.hueSaturationLuminance.saturationFactor=t.saturation:r.hueSaturationLuminance=new Xa(0,t.saturation,1),r}(t.pictureEffects,e);return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"pictureEffects",i,e.mergeUndo)}function gc(e,t){var i;return new jh(t.graphic.anchor,"locks",Object.assign(Object.assign({},null!==(i=t.graphic.anchor.locks)&&void 0!==i?i:{}),{aspectRatio:e.lockAspectRatio}))}function vc(e,t){return new jh(t,"geometry",e.geometry)}function _c(e,t){return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"opacity",100-e.transparency,e.mergeUndo)}function yc(e,t){return ys(rc,new Map([["ActionName",e.actionType]])),new jh(t,"opacity",e.opacity,e.mergeUndo)}function bc(e,t){var i,r;return new ic(null!==(r=null===(i=e.graphic)||void 0===i?void 0:i.model)&&void 0!==r?r:t,e.placeholder,e.isUndoable)}function wc(e,t){var i,r;return new jh(null!==(r=null===(i=e.graphic)||void 0===i?void 0:i.model)&&void 0!==r?r:t,"data",e.data)}function Tc(e,t){return new jh(t,"rotation",e.rotation,e.mergeUndo)}function xc(){const e=new Yl([["changeFillColor",Bl(sc)],["changeLineProps",Bl(nc)],[Ea,Bl(oc)],["ChangeShadowBlur",Bl(lc)],["ChangeShadowDistance",Bl(hc)],["ChangeShadowTransparency",Bl(cc)],["ChangeShadowAngle",Bl(dc)],["ChangeShadowColor",Bl(uc)],[Ga,Bl(fc)],[Ha,Bl(pc)],[$a,Bl(mc)],[Ya,Bl(ac)],["SetLockAspectRatio",(t=gc,(e,i,r)=>new $n(!0,[t(e,i,r)]))],["cropToGeometry",Bl(vc)],["setOpacity",Bl(yc)],[Za,Bl(_c)],[xa,Bl(bc)],[Dl,Bl(wc)],["setPictureRotation",Bl(Tc)]]);var t;return function(e){e.register(ua,Rl(pa)).register("cropAndScale",Rl(qh)).register(qo,Ml(Xo))}(e),e}class Cc{dispatchAction(e,t,i,r){return r.performAction(e,t,i)}dispatchKeyboardEvent(e,t){const i={isHandled:!1};return t.cropState.keyboardEvent.emit(e,i),i}}const Pc="tabSel";class Sc{constructor(e=0){this.actionType=Pc,this.tabOrder=0,this.tabOrder=e}}const Ec="selectAllElements";class Mc{constructor(){this.actionType=Ec}}const Rc="setElementsToSel";class Bc{constructor(e){this.actionType=Rc,this.elementIds=e}}const Ic="toggleElementsInSel";class Ac{constructor(e){this.actionType=Ic,this.elementIds=e}}function Fc(e,t){return t.clear(),!0}function kc(e,t){const i=t.graphic.model.smartArtData.elementList,r=[];for(const e of i)r.push(e);return t.setElements(r),!0}function Dc(e,t){const i=[];return e.elementIds.forEach((e=>{const r=t.graphic.model.smartArtData.elementList.getElementById(e);void 0!==r&&i.push(r)})),t.setElements(i),!0}function Lc(e,t){const i=[];for(const e of t)i.push(e.modelId);return t.graphic.model.deleteSubShapes(i)}function Oc(e,t){const i=[];for(const e of t)i.push(e.modelId);return t.graphic.model.setSubShapeFillColor(i,e.color)}function Uc(e,t){return function(e,t,i){if(0===e.length)return!1;const r=function(e,t,i){if(0===t.length)return-1;const r=0===i?0:t.length-1;if(0===e.length)return r;const s=e.getElementByIndex(e.length-1);if(void 0===s)return r;let n=t.getIndexById(s.id);return-1===n?r:(0===i?(n+=1,n>=t.length&&(n=0)):(n-=1,n<0&&(n=t.length-1)),n)}(e,t,i);if(-1===r)return!1;const s=t.getItemByIndex(r);return void 0!==s&&(e.setElements([s]),!0)}(t,Uo(t.graphic.model.smartArtData.elementList),e.tabOrder)}function Vc(e,t){const i=[],r=[];return e.elementIds.forEach((e=>{const s=t.graphic.model.smartArtData.elementList.getElementById(e);void 0!==s&&(void 0!==t.getElementById(e)?r.push(s):i.push(s))})),r.length>0&&t.removeElements(r),i.length>0&&t.addElements(i),!0}function Nc(e,t,i){return{isHandled:i.editorRegistry.performAction(new Mc,t,i).performed}}function Gc(e,t,i){let r=!1;if(0===t.length){const e=t.graphic.model.smartArtData.elementList.getElementByIndex(0);void 0!==e&&(t.setElements([e]),r=!0)}return{isHandled:r}}function zc(e,t,i){return t.hasSubSelection()?{isHandled:i.editorRegistry.performAction(new Ql,t,i).performed}:{isHandled:!1}}function Hc(e,t,i){return t.hasSubSelection()?{isHandled:i.editorRegistry.performAction(new Sc(e.shiftKey?1:0),t,i).performed}:{isHandled:!1}}const Wc="playVideo";class $c{constructor(){this.actionType=Wc}}const qc="toggleCaptionsMenu";class jc{constructor(){this.actionType=qc}}class Xc{}class Yc{constructor(e){this.type=Xc,this.selectionUpdated=new c,this.graphic=e}teardown(){}save(){}restore(e){}clone(e){return new Yc(e)}}function Kc(e,t){return t.selectionUpdated.emit(0),new $n(!0)}function Zc(e,t){return t.selectionUpdated.emit(1),new $n(!0)}class Jc{dispatchAction(e,t,i,r){return r.performAction(e,t,i)}dispatchKeyboardEvent(e,t,i){switch(e.key){case" ":return i.actionInvoker.invoke(new $c),{isHandled:!0};case"j":case"∆":return e.altKey?(i.actionInvoker.invoke(new jc),{isHandled:!0}):{isHandled:!1};default:return{isHandled:!1}}}}class Qc{}class ed extends class{constructor(e,t,i,r,s){this.data=e,this.sourceAnchorBounds=t,this.targetBounds=i,this.rotation=r,this.flip=s}}{constructor(e,t,i,r=0,s=new m){super(e,t,i,r,s),this.type=Qc}}function td(e){return e.type===Qc}function id(e){if(!td(e))throw new Error(`Invalid renderData type: ${e.type}`)}class rd{}class sd{constructor(e,t,i){this.type=rd,this.sceneGraphJson=e,this.interactivityJson=t,this.targetBounds=i}}class nd{}class od{constructor(e,t,i,r){this.type=nd,this.shapeBuilderRenderData=e,this.sourceAnchorBounds=t,this.targetBounds=i,this.embeddedImageList=r}}function ad(e){return e.type===nd}function ld(e){return new p(e.pos.x,e.pos.y,e.pos.x+e.size.width,e.pos.y+e.size.height)}function hd(e,t){const i=e;switch(i.renderDataType){case An.Base64Image:return function(e,t){return new ed(e.base64Data,ld(t),ld(e.targetBounds),e.rotation,new m(e.flip.x,e.flip.y))}(i,t);case An.ChartPlayerJson:return function(e,t){const{x:i,y:r}=t.pos,{width:s,height:n}=t.size;return new sd(e.sceneGraphJson,e.interactivityJson,new p(i+s,r+n,s,n))}(i,t);case An.ShapeBuilderJson:return function(e,t){const i=function(e){let t=e;const i=t.indexOf("{");return i>0&&(t=t.substring(i)),JSON.parse(t)}(e.shapeBuilderJson);return function(e){return void 0!==e.shapeRenderData}(i)?new od(i.shapeRenderData,ld(t),ld(e.targetBounds),i.imageList):new od(i,ld(t),ld(e.targetBounds),void 0)}(i,t);default:return}}class cd{constructor(e){this._isHandled=e}get_isHandled(){return this._isHandled}}class dd{constructor(e){this._eventProcessResult=e}get_isHandled(){return this._eventProcessResult.isHandled}}const ud="GC2RenderVeto";class fd{constructor(e,t,i){this.trackerToAppInfo=new Map,this.brsConfig=e,this.shapeBuilderContext=t,this.ownerAlias=(Fn.O.SmartArt,"gc2smartart")}logSetRenderData(e,t){const i=pd(t,this.brsConfig);!function(e,t=new Map,i="gc2kpi"){_s.logKpiUsage(e,1,t,i)}(e.name,i,this.ownerAlias),ys(ud,i,this.ownerAlias),this.trackerToAppInfo.set(e,t)}logSetTransform(e,t){this.trackerToAppInfo.set(e,t)}logFrameRendered(e){const t=this.brsConfig.gc2FidelityResponsivenessRenderVetoMs;e.forEach((e=>{var i;const r=this.trackerToAppInfo.get(e);if(void 0!==r&&r.size>0){this.trackerToAppInfo.delete(e),e.end(),r.forEach(((t,i)=>{if(i.toLowerCase().indexOf("starttime")>0){const s=i.replace(/starttime.*/gi,"DurationMs"),n=parseFloat(t),o=!isNaN(n)&&n>=0?(e.endTimeMs-n).toFixed(3):"";""!==o&&r.set(s,o),r.delete(i)}}));const s=null===(i=this.shapeBuilderContext)||void 0===i?void 0:i.getScenePerformanceSummaryAsMap();null==s||s.forEach(((t,i)=>{e.addEventToContextHistoryMap(i,t)}));const n=new Map([...r.entries(),...e.getEventDurationStringsMap(3).entries()]),o=new vs.A;o.extendedProperties=pd(n,this.brsConfig);const a=function(e,t){const i=new Set;return e.forEach(((e,r)=>{if(r.toLowerCase().indexOf("actionname")>-1&&parseFloat(e)>t){const e=r.match(/ActionName_([a-zA-Z0-9]+)_ActionId_([a-zA-Z0-9\-]+)_([a-zA-Z]+)/),t=null!==e&&4===e.length?e[1]:"";i.add(t)}})),[...i]}(r,t);if(a.length>0){const e=new vs.A;e.extendedProperties=o.extendedProperties,e.extendedProperties.set("ActionsVetoed",a.toString()),e.extendedProperties.set("VetoCategory","Responsiveness"),function(e,t,i=!1,r=!0,s=new vs.A){_s.logKpiFailure(e,t,i,r,s)}(ud,"FidelityResp",!1,!1,e)}e.addTimePoint("OnFrameRenderedEndTime"),o.extendedProperties.set("TimePoints",e.getTimePointCollectionString(3)),function(e,t=new vs.A){_s.logKpiSuccess(e,t)}(e.name,o),(0,T.PN)(0,`${md(n)}`)}}))}}function pd(e,t){const i=new Map,r=[];let s="";try{e.set("isGC2WebGLRenderTargetEnabled",t.isGC2WebGLRenderTargetEnabled.toString()),e.forEach(((e,t)=>{if(t.toLowerCase().indexOf("actionname")>-1){const i=t.match(/ActionName_([a-zA-Z0-9]+)_ActionId_([a-zA-Z0-9\-]+)_([a-zA-Z]+)/);if(null!==i&&4===i.length){const t=new Map;t.set("ActionName",i[1]),t.set("ActionId",i[2]),s=i[3],t.set(s,e),r.push(md(t))}}else i.set(t,e)})),i.set(`ActionMetadataWith${s}`,r.toString())}catch(e){(0,T.PN)(0,`Exception: ${e.message}`)}return i}function md(e){const t={};return e.forEach(((e,i)=>{t[i]=e})),JSON.stringify(t)}class gd{get viewModel(){return void 0===this.currentPresenter&&(0,y._)(0,"CurrentPresenter not resolved."),this.currentPresenter.viewModel}constructor(e,t,i,r){this.viewModelUpdated=new c,this.isFallbackRenderDataPresenter=!1,this.onModelUpdated=(e,t)=>{this.updateViewModel(t,!1)},this.onViewModelUpdated=e=>{this.updateViewModel(e,!0)},this.graphic=e,this.context=t,this.editContext=r,this.modelPresenterCreator=i,this.graphic.model.modelUpdated.on(this.onModelUpdated),this.updateViewModel()}teardown(){this.graphic.model.modelUpdated.off(this.onModelUpdated),this.teardownCurrentPresenter()}teardownCurrentPresenter(){void 0!==this.currentPresenter&&(this.currentPresenter.viewModelUpdated.off(this.onViewModelUpdated),this.currentPresenter.teardown())}updateViewModel(e,t){this.ensureCurrentPresenter(e),this.viewModelUpdated.emit(t?e:void 0)}ensureCurrentPresenter(e){(void 0===this.currentPresenter||void 0===this.graphic.model.fallbackRenderData&&this.isFallbackRenderDataPresenter||void 0!==this.graphic.model.fallbackRenderData&&!this.isFallbackRenderDataPresenter||void 0!==this.graphic.model.fallbackRenderData&&this.isFallbackRenderDataPresenter&&this.currentPresenter.renderDataType!==this.graphic.model.fallbackRenderData.type)&&this.recreatePresenter(e)}recreatePresenter(e){if(this.teardownCurrentPresenter(),void 0!==this.graphic.model.fallbackRenderData){void 0===this.context.renderDataPresenterCreator&&(0,y._)(0,"RenderDataPresenterCreator not provided");const t=this.context.renderDataPresenterCreator.createRenderDataPresenter(this.graphic,this.context,this.editContext);this.currentPresenter=t,this.isFallbackRenderDataPresenter=!0,t.init(this.onViewModelUpdated,e)}else this.currentPresenter=this.modelPresenterCreator(this.graphic,this.context,this.editContext),this.isFallbackRenderDataPresenter=!1,this.currentPresenter.viewModelUpdated.on(this.onViewModelUpdated)}}class vd{}class _d{get scaleFactor(){return this._scaleFactor}set scaleFactor(e){this._scaleFactor=e,this.fixSVGElementTransform()}get position(){return this._position}set position(e){this._position=e,this.fixSVGElementTransform()}get size(){return this._size}set size(e){this._size=e,this.fixSVGElementTransform()}constructor(e,t){this.type=vd,this.pointerEventNotifiers=d(),this.hitTestSlop=0,this._scaleFactor=1/window.devicePixelRatio,this._position=new g,this._size=new v,this.position=e,this.size=t,this.htmlDiv=document.createElement("div"),this.chartPlayerWrapper=async function(e){return(new((await s.e(357).then(s.bind(s,313))).ChartPlayerFactory)).getChartPlayerWrapper(e,void 0)}(this.htmlDiv)}async setLayout(e){const t=await this.chartPlayerWrapper;null!=t&&(t.renderChart(e.sceneGraphJson,e.interactivityJson),this.element=this.htmlDiv.firstChild,this.fixSVGElementTransform())}teardown(){}fixSVGElementTransform(){if(void 0===this.element||null===this.element)return;const e=`position: absolute; display: inherit; z-index: 1;left:${this.position.x*this.scaleFactor}px;top:${this.position.y*this.scaleFactor}px;width:${this.size.width*this.scaleFactor}px;height:${this.size.height*this.scaleFactor}px;`;this.element.setAttribute("style",`${e}`)}}class yd{get viewModel(){return this.chartRenderDataPresenter.viewModel}get viewModelUpdated(){return this.chartRenderDataPresenter.viewModelUpdated}constructor(e,t){this.chartModelPresenterCreator=(e,t,i)=>this.chartInnerPresenter,this.graphic=e,this.chartInnerPresenter=new bd(this.graphic,t),this.chartRenderDataPresenter=new gd(this.graphic,t,this.chartModelPresenterCreator,void 0)}teardown(){this.chartRenderDataPresenter.teardown(),this.chartInnerPresenter.teardown()}}class bd{constructor(e,t){this.viewModelUpdated=new c,this.onAnchorTransformUpdated=async()=>{this.chart.modelUpdated.emit()},this.onViewTransformChanged=async()=>{this.chart.modelUpdated.emit()},this.onCombinedScaleChanged=async()=>{this.chart.modelUpdated.emit()},this.chart=e.model,this.context=t,this.chartPlayerViewModel=new _d(t.anchorPresenter.transform.pos,t.anchorPresenter.transform.size),this.layout(),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onViewTransformChanged),this.context.viewScale.combinedScaleChanged.on(this.onCombinedScaleChanged)}get viewModel(){return this.chartPlayerViewModel}teardown(){this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.off(this.onViewTransformChanged),this.context.viewScale.combinedScaleChanged.off(this.onCombinedScaleChanged)}async layout(){this.viewModelUpdated.emit()}}class wd{constructor(e,t,i){this.renderDataType=rd,this.viewModelUpdated=new c,this.onModelUpdated=async(e,t)=>{null==t||t.addTimePoint("ModelUpdatedEventReceivedTime"),await this.layout(1,t)},this.onAnchorTransformUpdated=async()=>{await this.layout(2)},this.onViewTransformChanged=async()=>{await this.layout(8)},this.onCombinedScaleChanged=async()=>{await this.layout(4)},this.chart=e.model,this.context=t,this.layoutProvider=i,this.chartPlayerViewModel=new _d(t.anchorPresenter.transform.pos,t.anchorPresenter.transform.size),this.layout(15),this.chart.modelUpdated.on(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onViewTransformChanged),this.context.viewScale.combinedScaleChanged.on(this.onCombinedScaleChanged)}init(e,t){void 0!==e&&this.viewModelUpdated.on(e),this.updateViewModelProperties(15,t).catch((e=>{(0,T.H)(0,`${e}`)}))}get viewModel(){return this.chartPlayerViewModel}teardown(){this.chart.modelUpdated.off(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.off(this.onViewTransformChanged),this.context.viewScale.combinedScaleChanged.off(this.onCombinedScaleChanged)}async layout(e,t){let i;null==t||t.addTimePoint("ChartPlayerRenderDataPresenterStartTime"),i=new ro("ChartPlayerRenderDataPresenter_Layout",void 0!==t?[t]:[]);let r=!1;try{0!=(2&e)&&(r=this.updateViewModelAnchorTransform()||r),0!=(4&e)&&(r=this.updateViewModelScaleFactor()||r),0!=(1&e)&&(r=await this.updateViewModelRenderData()||r),0!=(8&e)&&(r=this.updateViewModelViewTransform()||r)}finally{null==i||i.complete()}r&&(null==t||t.addTimePoint("ViewModelUpdatedEventEmittedTime"),this.viewModelUpdated.emit(t)),null==t||t.addTimePoint("ChartPlayerRenderDataPresenterEndTime")}async updateViewModelProperties(e,t){let i=!1;const r=new ro("ChartPlayerRenderDataPresenter_UpdateViewModel",void 0!==t?[t]:[]);try{0!=(8&e)&&(i=this.updateViewModelViewTransform()||i),0!=(2&e)&&(i=this.updateViewModelAnchorTransform()||i),0!=(4&e)&&(i=this.updateViewModelScaleFactor()||i),0!=(1&e)&&(i=await this.updateViewModelRenderData()||i)}catch(e){throw(0,T.H)(0,`Exception: ${e.message}`),e}finally{r.complete()}}async updateViewModelRenderData(){const e=this.context.anchorPresenter.transform;if(void 0!==this.chart.fallbackRenderData){const e=this.chart.fallbackRenderData;try{await this.chartPlayerViewModel.setLayout({sceneGraphJson:e.sceneGraphJson,interactivityJson:e.interactivityJson})}catch(e){throw(0,T.H)(0,`Exception: ${e.message}`),e}}else{const t=await this.layoutProvider.getLayout(this.chart,e);await this.chartPlayerViewModel.setLayout(t)}return!0}updateViewModelAnchorTransform(){let e=!1;const t=this.context.anchorPresenter.transform;return this.chartPlayerViewModel.position.equals(t.pos)||(this.chartPlayerViewModel.position=t.pos.clone(),e=!0),this.chartPlayerViewModel.size.equals(t.size)||(this.chartPlayerViewModel.size=t.size.clone(),e=!0),e}updateViewModelViewTransform(){let e=!1;const t=this.context.viewScale.viewTransform;return this.chartPlayerViewModel.position.equals(t.pos)||(this.chartPlayerViewModel.position=t.pos.clone(),e=!0),this.chartPlayerViewModel.size.equals(t.size)||(this.chartPlayerViewModel.size=t.size.clone(),e=!0),e}updateViewModelScaleFactor(){return this.chartPlayerViewModel.scaleFactor!==this.context.viewScale.zoomFactor&&(this.chartPlayerViewModel.scaleFactor=this.context.viewScale.zoomFactor,!0)}}function Td(...e){return()=>{for(let t=e.pop();void 0!==t;t=e.pop())t()}}class xd{get transform(){var e;return null!==(e=this.previewTransform)&&void 0!==e?e:this.presenter.transform}constructor(e,t){this.transformUpdated=new c,this.onTransformUpdated=(...e)=>{this.previewTransform=void 0,this.transformUpdated.emit(...e)},this.anchor=e.anchor,this.presenter=t,this.teardown=Td(this.presenter.transformUpdated.use(this.onTransformUpdated))}applyTransform(e,t=!0){const i=sa(this.presenter.transform,e,!1,t?this.anchor.locks:void 0);Aa(i,this.previewTransform)||(this.previewTransform=i,this.transformUpdated.emit())}setTransform(e){Aa(e,this.previewTransform)||(this.previewTransform=e,this.transformUpdated.emit())}}class Cd{}class Pd{constructor(e=[],t,i){this.type=Cd,this.pointerEventNotifiers=d(),this.hitTestSlop=0,this.children=e,this.nodeId=t,this.setSourceOnChildren=i}teardown(){}}function Sd(e){return e.type===Cd}class Ed{constructor(e,t,i,r,s,n){this.viewModelUpdated=new c,this.childPresenters=new Map,this.updateViewModel=(e,t)=>{const i=this.childPresenters;this.childPresenters=new Map;const r=[];for(const e of this.graphicCollection){const t=i.get(e);if(void 0!==t){i.delete(e),this.childPresenters.set(e,t),t.update(),r.push(t.container);continue}const s=this.createChildPresenter(e);this.childPresenters.set(e,s),r.push(s.container)}for(const[e,t]of i)t.teardown();this.viewModel.children=r,this.viewModelUpdated.emit(t)},this.graphicCollection=e.model,this.presenterCreator=t,this.anchorPresenterCreator=void 0!==(null==n?void 0:n.previewInfo)?function(e){return{createAnchorPresenter:t=>{const i=e.createAnchorPresenter(t);return new xd(t,i)}}}(i):i,this.site=r,this.presenterContext=s,this.editContext=n,this.viewModel=new Pd([],{nodeType:this.site.rootNodeType}),this.updateViewModel(),this.graphicCollection.modelUpdated.on(this.updateViewModel)}getPresenters(e){const t=this.childPresenters.get(e);return void 0===t&&(0,y._)(0,`Child presenters not found for graphic: ${e.id}`),[t.presenter,t.anchorPresenter]}reset(){this.clearChildPresenters(),this.updateViewModel()}teardown(){this.graphicCollection.modelUpdated.off(this.updateViewModel),this.clearChildPresenters()}clearChildPresenters(){for(const[e,t]of this.childPresenters)t.teardown();this.childPresenters.clear()}createChildPresenter(e){const t=this.anchorPresenterCreator.createAnchorPresenter(e),i=this.presenterCreator.createPresenter(e,Object.assign(Object.assign({},this.presenterContext),{anchorPresenter:t}),this.editContext);return new Md(i,t,this.site.graphicNodeType,e.id,this)}}class Md{constructor(e,t,i,r,s){this.onViewModelUpdated=(...e)=>{this.update(),this.parent.viewModelUpdated.emit(...e)},this.presenter=e,this.anchorPresenter=t,this.container=new Pd([e.viewModel],{nodeType:i,nodeKey:r}),this.parent=s,this.presenter.viewModelUpdated.on(this.onViewModelUpdated)}update(){this.container.children=[this.presenter.viewModel]}teardown(){this.presenter.viewModelUpdated.off(this.onViewModelUpdated),this.presenter.teardown(),this.anchorPresenter.teardown()}}class Rd{constructor(){this.rootNodeType="grCollR",this.graphicNodeType="grCollCh"}}class Bd{constructor(e){this.transformUpdated=new c,this.onAnchorUpdated=e=>{this.transformUpdated.emit(e)},this.anchor=e,this.anchor.anchorUpdated.on(this.onAnchorUpdated)}get transform(){return this.anchor.transform}teardown(){this.anchor.anchorUpdated.off(this.onAnchorUpdated)}}function Id(e){return new Bd(e.anchor)}class Ad{teardown(){}setSelected(){}setHovered(){}}class Fd{constructor(e,t){this.paths=[],this.size=new v(e,t)}}const kd={b:e=>e.bottom,h:e=>e.height(),hc:e=>e.left+e.width()/2,hd2:e=>e.height()/2,hd3:e=>e.height()/3,hd4:e=>e.height()/4,hd5:e=>e.height()/5,hd6:e=>e.height()/6,hd8:e=>e.height()/8,hd10:e=>e.height()/10,l:e=>e.left,ls:e=>Math.max(e.width(),e.height()),r:e=>e.right,ss:e=>Math.min(e.width(),e.height()),ssd2:e=>kd.ss(e)/2,ssd4:e=>kd.ss(e)/4,ssd6:e=>kd.ss(e)/6,ssd8:e=>kd.ss(e)/8,ssd16:e=>kd.ss(e)/16,ssd32:e=>kd.ss(e)/32,t:e=>e.top,vc:e=>e.top+e.height()/2,w:e=>e.width(),wd2:e=>e.width()/2,wd3:e=>e.width()/3,wd4:e=>e.width()/4,wd5:e=>e.width()/5,wd6:e=>e.width()/6,wd8:e=>e.width()/8,wd10:e=>e.width()/10,wd12:e=>e.width()/12,wd32:e=>e.width()/32};function Dd(e,t,i){return"number"==typeof e?e:e in t?t[e]:function(e,t){if(e in kd)return kd[e](t);throw new Error(`Invalid formula: ${e}`)}(e,i)}const Ld=100;function Od(e,t,i){const r=new Fd(Ld,Ld);let s,n;if(void 0!==e.u&&e.u)s=new _(new g(0,0),new v(1,1)),n=new _(new g(0,0),new v(Ld,Ld));else{const e=t.size.width/t.size.height;s=new _(new g(0,0),new v(e*Ld,Ld)),r.size.width=e*Ld}const o=function(e,t,i){const r={},s=e=>Dd(e,r,i);return void 0!==e&&e.forEach((e=>{const[t,i]=e;r[t]=i})),void 0!==t&&t.forEach((e=>{const[t,...i]=e;r[t]=function(e,t){switch(e[0]){case 0:return Math.abs(t(e[1]));case 1:return Math.sqrt(Math.abs(t(e[1])));case 2:return t(e[1]);case 3:return-t(e[1]);case 4:return Math.atan2(t(e[2]),t(e[1]));case 5:return t(e[1])*Math.cos(t(e[2]));case 6:return Math.max(t(e[1]),t(e[2]));case 7:return Math.min(t(e[1]),t(e[2]));case 8:return t(e[1])*Math.sin(t(e[2]));case 9:return t(e[1])*Math.tan(t(e[2]));case 10:return t(e[1])+t(e[2]);case 11:return t(e[1])-t(e[2]);case 12:return i=t(e[1]),r=t(e[2]),Math.sqrt(i*i+r*r);case 13:return t(e[1])*t(e[2]);case 14:return function(e,t){return 0===t?e:e/t}(t(e[1]),t(e[2]));case 15:return function(e,t,i){return 0===i?e*t:e*t/i}(t(e[1]),t(e[2]),t(e[3]));case 16:return t(e[1])+(t(e[2])-t(e[3]));case 17:return function(e,t,i){return 0===i?e+t:(e+t)/i}(t(e[1]),t(e[2]),t(e[3]));case 18:return t(e[1])>0?t(e[2]):t(e[3]);case 19:return t(e[1])*Math.cos(Math.atan2(t(e[3]),t(e[2])));case 20:return Math.min(Math.max(t(e[1]),t(e[2])),t(e[3]));case 21:return t(e[1])*Math.sin(Math.atan2(t(e[3]),t(e[2])));default:(0,xs.t)(e)}var i,r}(i,s)})),r}(void 0!==i&&i.length>0?i:e.a,e.g,Ao(s));return e.p.forEach((e=>{r.paths.push(function(e,t,i,r){const s=Ao(i),n=new f(s.left+s.width()/2,s.top+s.height()/2),o=(0,u.Yr)(i.rot),a=uh(-n.x,-n.y).scale(i.flip.x?-1:1,i.flip.y?-1:1).rotate(o).translate(n.x,n.y),l=(e,i)=>{const n=new f(Dd(e,t,s),Dd(i,t,s));if(n.multiply(a),void 0!==r){const e=fh(r.size.width,r.size.height).translate(r.pos.x,r.pos.y);n.multiply(e)}return n},h=void 0!==r?r.size.width:1,c=void 0!==r?r.size.height:1;return{fillMode:void 0===e.f?1:e.f,lineEnabled:void 0===e.l||e.l,segments:e.s.map((e=>{switch(e[0]){case 0:return{segmentType:0,beginPoint:l(e[1],e[2])};case 1:return{segmentType:1,endPoint:l(e[1],e[2])};case 2:return{segmentType:2,xRadius:Dd(e[1],t,s)*h,yRadius:Dd(e[2],t,s)*c,startAngle:Dd(e[3],t,s),sweepAngle:Dd(e[4],t,s)};case 3:return{segmentType:3,controlPoint:l(e[1],e[2]),endPoint:l(e[3],e[4])};case 4:return{segmentType:4,controlPoint1:l(e[1],e[2]),controlPoint2:l(e[3],e[4]),endPoint:l(e[5],e[6])};case 5:return{segmentType:5};default:(0,xs.t)(e)}}))}}(e,o,s,n))})),r}var Ud=s(5735);function Vd(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}class Nd{constructor(e){this.type=1,this.color=e}clone(){return new Nd(this.color)}equals(e){return Gd(e)&&this.color.equals(e.color)}}function Gd(e){return 1===e.type}const zd=new ka(255,255,255,1),Hd=new ka(0,0,0,0);class Wd{constructor(){this.type=0}clone(){return new Wd}equals(e){return 0===e.type}}function $d(e){return 2===e.type}class qd{constructor(e,t){this.position=e,this.color=t}clone(){return new qd(this.position,this.color)}equals(e){return this.position===e.position&&this.color.equals(e.color)}}class jd{constructor(e,t,i,r,s,n=!0){this.type=3,this.gradientType=e,this.stops=t,this.fromRect=i,this.toRect=r,this.angle=s,this.rotateWithShape=n}clone(){var e,t;return new jd(this.gradientType,this.stops.map((e=>e.clone())),null===(e=this.fromRect)||void 0===e?void 0:e.clone(),null===(t=this.toRect)||void 0===t?void 0:t.clone(),this.angle,this.rotateWithShape)}equals(e){return!!Xd(e)&&this.gradientType===e.gradientType&&function(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i+=1)if(!Ia(e[i],t[i]))return!1;return!0}(this.stops,e.stops)&&Aa(this.fromRect,e.fromRect)&&Aa(this.toRect,e.toRect)&&this.angle===e.angle&&this.rotateWithShape===e.rotateWithShape}}function Xd(e){return 3===e.type}function Yd(e,t){if(Gd(e)){if($d(e.color)){const i=t.clone();return i.transforms.push(...Fa(e.color.transforms)),new Nd(i)}}else if(Xd(e)){if(function(e){for(const t of e.stops)if($d(t.color))return!0;return!1}(e))return function(e,t){const i=e.stops.map((e=>{if($d(e.color)){const i=t.clone();return i.transforms.push(...Fa(e.color.transforms)),new qd(e.position,i)}return e}));return new jd(e.gradientType,i,e.fromRect,e.toRect,e.angle,e.rotateWithShape)}(e,t)}else if(Kh(e))throw new Error("Resolve style fillprops before making a call to replace placeholder color.");return e}function Kd(e,t,i){if(0===t.index)return i;const r=Math.min(t.index,e.length)-1;if(r<0)throw new Error(`StyleMatrixReference index ${t.index} is negative.`);return e[r]}const Zd=new Wd;function Jd(e,t,i){if(Gd(e))return tc(e.color,i);if(Kh(e)){if(void 0===t||void 0===i)throw new Error("Style reference and theme info needed to resolve StyleFillProps.");return Jd((r=t,Yd(Kd(i.theme.styles.fills,r,Zd),r.color)),t,i)}var r}const Qd=new Zh(new Wd);function eu(e){return 96*e/72}function tu(e){return void 0===e?"none":La(e)}function iu(e,t,i,r,s,n){const o=0===t||0===i,a=o?r:Math.atan2(t*Math.sin(r),i*Math.cos(r)),l=s<0?-1:1;let h=Math.abs(s);if(h>=Po.uo)h=Po.uo;else{let e=r+h*l;e=o?e:Math.atan2(t*Math.sin(e),i*Math.cos(e)),h=(e-a)*l,h<0&&(h+=Po.uo)}const c=e.x-Math.cos(a)*t,d=e.y-Math.sin(a)*i,u=Math.ceil(8*Math.abs(h)/Po.uo);for(let e=0;e<u;e+=1){const r=l*Po.uo/8,s=a+e*r,o=e===u-1?l*h-e*r:r,p=s+o,m=s+o/2,g=1/Math.cos(o/2),v=new f(c+Math.cos(m)*g*t,d+Math.sin(m)*g*i),_=new f(c+Math.cos(p)*t,d+Math.sin(p)*i);Math.abs(o)>0?n.quadraticBezierTo(v,_):n.lineTo(_)}}class ru{constructor(e){this.path="",this.transform=e}moveTo(e){const t=e.transform(this.transform);this.path+=`M${t.x},${t.y}`,this.last=e}lineTo(e){const t=e.transform(this.transform);this.path+=`L${t.x},${t.y}`,this.last=e}arcTo(e,t,i,r){iu(this.last,e,t,i,r,this)}quadraticBezierTo(e,t){const i=e.transform(this.transform),r=t.transform(this.transform);this.path+=`Q${i.x},${i.y},${r.x},${r.y}`,this.last=t}cubicBezierTo(e,t,i){const r=e.transform(this.transform),s=t.transform(this.transform),n=i.transform(this.transform);this.path+=`C${r.x},${r.y},${s.x},${s.y},${n.x},${n.y}`,this.last=i}close(){this.path+="Z"}}function su(e,t){e.segments.forEach((e=>{switch(e.segmentType){case 0:t.moveTo(e.beginPoint);break;case 1:t.lineTo(e.endPoint);break;case 2:t.arcTo(e.xRadius,e.yRadius,e.startAngle,e.sweepAngle);break;case 4:t.cubicBezierTo(e.controlPoint1,e.controlPoint2,e.endPoint);break;case 3:t.quadraticBezierTo(e.controlPoint,e.endPoint);break;case 5:t.close();break;default:(0,xs.t)(e)}}))}function nu(e,t,i){const r=Vd("path");return r.setAttribute("d",e),[r,t,!i]}function ou(e,t,i,r,s,n,o){var a;const l=function(e,t){const i=new f(t*function(e,t){switch(t){case 0:return 5===e?2.5:2;case 1:return 5===e?3.5:3;case 2:return 5;default:(0,xs.t)(t)}}(e.type,e.width),t*function(e,t){switch(t){case 0:return 2;case 1:return 3;case 2:return 5===e?4.5:5;default:(0,xs.t)(t)}}(e.type,e.length));switch(e.type){case 1:case 5:const t=5===e.type,r=[{segmentType:0,beginPoint:new f(-i.x/2,-i.y)},{segmentType:1,endPoint:new f(0,0)},{segmentType:1,endPoint:new f(i.x/2,-i.y)}];return{fillMode:t?0:1,lineEnabled:t,segments:t?r:r.concat([{segmentType:5}])};case 2:return{fillMode:1,lineEnabled:!1,segments:[{segmentType:0,beginPoint:new f(-i.x/2,-i.y)},{segmentType:1,endPoint:new f(0,0)},{segmentType:1,endPoint:new f(i.x/2,-i.y)},{segmentType:1,endPoint:new f(0,-i.y/2)},{segmentType:5}]};case 3:return{fillMode:1,lineEnabled:!1,segments:[{segmentType:0,beginPoint:new f(0,i.y/2)},{segmentType:1,endPoint:new f(i.x/2,0)},{segmentType:1,endPoint:new f(0,-i.y/2)},{segmentType:1,endPoint:new f(-i.x/2,0)},{segmentType:5}]};case 4:return{fillMode:1,lineEnabled:!1,segments:[{segmentType:0,beginPoint:new f(i.x/2,0)},{segmentType:2,xRadius:i.x/2,yRadius:i.y/2,startAngle:0,sweepAngle:Po.uo},{segmentType:5}]};default:throw Error("Unexpected line end type")}}(e,(a=t,Math.max(2,a))),h=function(e,t,i){const[r,s]=function(e,t,i){const r=function(e){const t=[];for(const i of e.segments)switch(i.segmentType){case 0:t.push(i.beginPoint);break;case 1:t.push(i.endPoint);break;case 2:iu(t[t.length-1],i.xRadius,i.yRadius,i.startAngle,i.sweepAngle,{lineTo(e){t.push(e)},quadraticBezierTo(e,i){t.push(e,i)}});break;case 4:t.push(i.controlPoint1,i.controlPoint2,i.endPoint);break;case 3:t.push(i.controlPoint,i.endPoint);break;case 5:t.push(t[0]);break;default:(0,xs.t)(i)}return t}(e);let s,n;t?(n=r[r.length-2],s=r[r.length-1]):(s=r[0],n=r[1]),s=s.transform(i),n=n.transform(i);const o=new f(s.x-n.x,s.y-n.y);return o.normalize(),[s,o]}(e,t,i);return new dh(-s.y,s.x,s.x,s.y,r.x,r.y)}(s,r,n),c=new ru(h);su(l,c);const d=nu(c.path,l.fillMode,l.lineEnabled);return void 0!==i&&0!==i.dashType&&d[0].setAttribute("stroke-dasharray","none"),5===e.type&&d[0].setAttribute("stroke-linecap","round"),function(e){switch(e){case 3:case 4:case 2:case 1:return!0;case 0:case 5:return!1;default:(0,xs.t)(e)}}(e.type)&&d[0].setAttribute("fill",o),d}class au{}class lu{constructor(){this.type=au,this.pointerEventNotifiers=d(),this.update=new c,this.hitTestSlop=0,this.group=Vd("g"),this.paths=[]}setGeometry(e,t){this.geometry=e,this.geometryTransform=uh(-e.size.width/2,-e.size.height/2).scale(t.size.width/e.size.width*(t.flip.x?-1:1),t.size.height/e.size.height*(t.flip.y?-1:1)).rotate((0,u.Yr)(t.rot)),this.paths=function(e,t){const i=[],r=new ru(t);let s=0,n=!0;return e.paths.forEach((e=>{(""!==r.path&&s!==e.fillMode||!n)&&(i.push(nu(r.path,s,n)),r.path=""),su(e,r),s=e.fillMode,n=e.lineEnabled})),i.push(nu(r.path,s,n)),i}(e,this.geometryTransform),this.setCenter(t.getCenter())}setProps(e,t,i,r,s,n,o,a){var l,h;(null==a?void 0:a.isInHighContrastMode)?this.fillColor=function(e){return void 0!==e.highContrastColors?Oa(e.highContrastColors.backgroundColor):Hd}(a):this.fillColor=void 0!==e?Jd(e,null==i?void 0:i.fillRef,r):void 0,this.effects=s,this.pictureEffects=n,this.group.setAttribute("fill",tu(this.fillColor));const c=function(e,t){if(!(null==t?void 0:t.isInHighContrastMode))return e;const i=new Nd(function(e){return void 0!==e.highContrastColors?Oa(e.highContrastColors.foregroundTextColor):zd}(t));if(void 0!==e){const t=e.clone();return t.fill=i,t}return new Zh(i)}(t,a);if(void 0!==c){const e=function(e,t,i){if(void 0!==i&&void 0!==t&&void 0!==t.lineRef){const r=e.clone();return r.resolveFrom(function(e,t){var i;const r=Kd(e.lines,t,Qd),s=r.clone();return s.fill=Yd(null!==(i=r.fill)&&void 0!==i?i:new Wd,t.color),s}(i.theme.styles,t.lineRef)),r}return e}(c,i,r),t=null!==(l=e.weight)&&void 0!==l?l:1,s=tu(Jd(null!==(h=e.fill)&&void 0!==h?h:new Wd,void 0,r));this.group.setAttribute("stroke",s),this.group.setAttribute("stroke-width",`${t}pt`),void 0!==e.dash&&0!==e.dash.dashType?this.group.setAttribute("stroke-dasharray",(d=e.dash.dashType,u=eu(t),function(e){switch(e){case 1:return[1,3];case 2:return[4,3];case 4:return[4,3,1,3];case 3:return[8,3];case 5:return[8,3,1,3];case 6:return[8,3,1,3,1,3];case 7:return[3,1];case 8:return[1,1];case 9:return[3,1,1,1];case 10:return[3,1,1,1,1,1];case 0:return[];default:(0,xs.t)(e)}}(d).map((e=>e*u)).join(" "))):this.group.removeAttribute("stroke-dasharray"),void 0!==e.join&&0!==e.join.joinType?this.group.setAttribute("stroke-linejoin",function(e){switch(e){case 1:return"bevel";case 0:return"miter";case 2:return"round";default:(0,xs.t)(e)}}(e.join.joinType)):(this.group.removeAttribute("stroke-linejoin"),this.group.setAttribute("stroke-miterlimit","8"));const n=e.headEnd;void 0!==n&&0!==n.type&&this.geometry.paths.forEach((i=>{0===i.fillMode&&i.lineEnabled&&this.paths.push(ou(n,t,e.dash,!1,i,this.geometryTransform,s))}));const o=e.tailEnd;void 0!==o&&0!==o.type&&this.geometry.paths.forEach((i=>{0===i.fillMode&&i.lineEnabled&&this.paths.push(ou(o,t,e.dash,!0,i,this.geometryTransform,s))}))}else this.group.setAttribute("stroke","none");var d,u}setCenter(e){this.group.setAttribute("transform",`translate(${e.x} ${e.y})`)}teardown(){}}function hu(e,t){if(void 0===t)return{scale:new f(1,1),offset:new f(0,0)};const{width:i,height:r}=ta(e,t).size;return{scale:new f(i/e.size.width,r/e.size.height),offset:new f(t.left*i/100,t.top*r/100)}}class cu{}class du extends Io{constructor(e,t,i,r,s,n){super(),this.type=cu,this.geometryVM=r,this.placeholderContainer=n,this.nonCropGeometry=t,this.update(e,i,s).then((()=>{})).catch((()=>{}))}async update(e,t,i){void 0!==i&&(this.geometry=e,this.geometryVM.setGeometry(i.cropToGeometry?e:this.nonCropGeometry,t),this.transform!==t&&(this.transform=t.clone()),await this.updatePlaceholder(i))}teardown(){var e;this.geometryVM.teardown(),null===(e=this.placeholderContainer)||void 0===e||e.teardown()}async updatePlaceholder(e){Aa(e,this.placeholder)||(this.placeholder=e,await this.updateImageData())}async updateImageData(){if(void 0!==this.placeholder&&this.imageData!==this.placeholder.url.href)return await this.setImageData(this.placeholder.url.href),void this.imageViewModelUpdated.emit([0],!1)}}const uu="MissingACTL";Error;async function fu(e){return new Promise((t=>window.setTimeout(t,e)))}class pu{constructor(e,t,i,r,s){this.fetchTimeInMs=0,this.convertToBlobUrlTimeInMs=0,this.totalTimeInMs=0,this.sizeInBytes=0,this.mimeType="",this.fetchTimeInMs=e,this.convertToBlobUrlTimeInMs=t,this.totalTimeInMs=i,this.sizeInBytes=r,this.mimeType=s}}async function mu(e,t,i){if(!0===i&&"data:"===e.protocol){const t=nn(e);return Promise.resolve(new go(e,t,new Blob([e.href],{type:t})))}let r=null==t?void 0:t.get(e.href,!0);return void 0!==r||(r=async function(e){var t,i,r,s;const n={},o=void 0;if(void 0!==o){const t=await o.getAdditionalRequestHeaders(e);void 0!==t&&(n.headers=t)}const a=l("EnableDownloadFailedPictureSrcLogging")?e.href.substring(0,500):"",h=performance.now();let c;try{c=l("FetchWithRetryForConvertUrlToBlobUrl")?await async function(e,t,i,r,s,n){let o,a;for(let t=0;t<=2;t+=1){try{if(a=await fetch(e,s),a.ok)return a;o=a}catch(e){o=e}await fu(1e3*2**t)}if(o instanceof Response)throw new Error(`fetchWithRetryOnResponseCheck: Response status [${o.status}]`);throw o}(e.href,0,0,0,n):await fetch(e.href,n)}catch(r){(0,y._)(0,`convertUrlToBlobUrl: Network error during fetch. Protocol [${e.protocol}] | NetworkError [${r}] | RequestHeadersLength [${null!==(i=null===(t=n.headers)||void 0===t?void 0:t.keys.length)&&void 0!==i?i:0}] | Url[${a}]]`)}const d=performance.now();c.ok||(0,y._)(0,`convertUrlToBlobUrl: Fetch response not ok. Protocol [${e.protocol}] | Response status [${c.status}] | ResponseText [${await c.text()}]] | RequestHeadersLength [${null!==(s=null===(r=n.headers)||void 0===r?void 0:r.keys.length)&&void 0!==s?s:0}]  | Url[${a}]]`);const u=await c.blob(),f=u.type,p=new URL(URL.createObjectURL(u)),m=performance.now();return new go(p,f,u,new pu(d-h,m-d,m-h,u.size,f))}(e),null==t||t.set(e.href,r)),r}class gu{constructor(){this.downloadState=0,this.totalTimeInMs=0}}class vu{constructor(e,t,i,r,s,n,o,a,l,h){this.stateUpdated=new c,this._state=1,this._stats=new gu,this.id=e,this.originalUrl=t,this.downloadPlaceholder=i,this.pictureProvider=s,this.isUrlFinal=r,this._downloadCompleted=n,this._framesProviders=o,this.storeDownloadCompletedBlobText=null!=a?a:e=>!1,this._urlStore=l,this._options=h}get originalBlobUrl(){return this._originalBlobUrl}get providerDownloadedUrl(){return this._providerDownloadedUrl}get providerDownloadedBlobUrl(){return this._providerDownloadedBlobUrl}get isRenderUrlPlaceHolder(){return void 0!==this.placeholder}get state(){return this._state}set state(e){this.setStateAndNotify(e,!0)}get downloadDetails(){return this}async triggerDownload(){await this.triggerOriginalDownload(),await this.triggerDownloadFromProvider()}get renderUrl(){switch(this._state){case 1:case 2:if(this.isUrlFinal&&void 0===this.downloadPlaceholder)return;return this.getPlaceholderUrlOrDefault();case 4:case 6:return this.getPlaceholderUrlOrDefault();case 3:return this.isUrlFinal?(void 0===this.originalBlobUrl&&(0,y.H)("Picture","OriginalBlobUrlUndefined","renderUrl: originalBlobUrl not expected to be undefined for DownloadedOriginal state"),this.originalBlobUrl):this.getPlaceholderUrlOrDefault();case 5:return void 0===this.providerDownloadedBlobUrl&&(0,y.H)("Picture","ProviderDownloadedBlobUrlUndefined","renderUrl: providerDownloadedBlobUrl not expected to be undefined for DownloadedFromProvider state"),this.providerDownloadedBlobUrl;case 7:return;default:(0,y.H)("Picture","PictureDataStateInvalid",`renderUrl: Unhandled PictureDataState ${this._state}`)}}get stats(){return this._stats}get mimeType(){return this._mimeType}get downloadDone(){return 6===this.state||(this.isUrlFinal?3===this.state:5===this.state)}teardown(){var e,t;void 0!==this._originalBlobUrl&&this._originalBlobUrl!==this.originalUrl&&(void 0===this._urlStore?URL.revokeObjectURL(this._originalBlobUrl.href):null===(e=this._urlStore.delete(this.originalUrl.href))||void 0===e||e.then((e=>{e.teardown()}))),void 0!==this._providerDownloadedUrl&&void 0!==this._providerDownloadedBlobUrl&&this._providerDownloadedBlobUrl!==this._providerDownloadedUrl&&(void 0===this._urlStore?URL.revokeObjectURL(this._providerDownloadedBlobUrl.href):null===(t=this._urlStore.delete(this._providerDownloadedUrl.href))||void 0===t||t.then((e=>{e.teardown()}))),this._originalBlobUrl=void 0,this._providerDownloadedBlobUrl=void 0,this._providerDownloadedUrl=void 0,this._start=void 0,this._stats=new gu,this._downloadCompleted=void 0,this.frames=void 0,this.setStateAndNotify(7,!0)}get downloadCompletedBlobText(){return this._downloadCompletedBlobText}get placeholder(){let e=0;switch(this._state){case 1:case 2:if(this.isUrlFinal&&void 0===this.downloadPlaceholder)return;break;case 3:if(this.isUrlFinal)return;break;case 4:break;case 5:case 7:return;case 6:e=1;break;default:(0,y.H)("Picture","PictureDataStateInvalid",`placeholder: Unhandled PictureDataState ${this._state}`)}return 0===e&&void 0!==this.downloadPlaceholder?this.downloadPlaceholder:this.pictureProvider.getPlaceholderIcon(e)}async triggerOriginalDownload(){var e,t,i,r;if(void 0!==this._originalBlobUrl)return;this.state=2;const s=[];let n;try{this._stats.downloadState=1,this._start=performance.now();const r=await mu(this.originalUrl,this._urlStore,null===(e=this._options)||void 0===e?void 0:e.preferDataUrl);this._originalBlobUrl=r.url,this._stats.originalUrlStats=r.stats,n=r.blobType,s.push("ConvertUrlToBlobUrl"),await this.setMimeType(r.blob,void 0!==(null===(t=this._framesProviders)||void 0===t?void 0:t.get("image/apng"))),s.push("SetMimeType");const o=on(this._mimeType);void 0!==o&&(this._framesProvider=null===(i=this._framesProviders)||void 0===i?void 0:i.get(o)),rn(this._mimeType)&&void 0!==this._framesProvider&&(this.frames=this._framesProvider.getFrames(this._originalBlobUrl.href),s.push("GetFrames")),void 0!==r.blobType&&this.storeDownloadCompletedBlobText(r.blobType)&&this.isUrlFinal&&void 0!==r.blob&&(this._downloadCompletedBlobText=await r.blob.text(),s.push("SetBlobText")),this._stats.totalTimeInMs=performance.now()-this._start,this.isUrlFinal&&(this._stats.downloadState=2),this.state=3,s.push("SetStateDownloadedOriginal")}catch(e){const t=new vs.A;t.extendedProperties.set("message",`Failed to download original url. Protocol[${this.originalUrl.protocol}] Error[${e}}] BlobType[${n}] MimeType[${this._mimeType}] Stages[${s.join("|")}]`),(0,bs.R)("Picture","DownloadOriginalUrlFailed",t),this._stats.downloadState=3,this.setStateAndNotify(6,this.isUrlFinal)}this.isUrlFinal&&(null===(r=this._downloadCompleted)||void 0===r||r.emit(this._stats))}async setMimeType(e,t=!1){void 0!==e&&(this._mimeType=e.type,t&&"image/png"===e.type.toLowerCase()&&function(e){let t;try{let i=!1,r=!0,s=-1,n=0,o=0,a="";const l=new DataView(e),h=new TextDecoder("ascii");let c=8,d=!1;for(;void 0===t&&!d&&c<l.byteLength;){const u=l.getUint32(c),f=h.decode(new DataView(e,c+4,4));switch(f){case"acTL":if(i){t="MultipleACTL";break}i=!0,n=l.getUint32(c+8);break;case"fcTL":{if(!i||!r){t="FCTLSeenBeforeDataForPreviousFCTL";break}const e=l.getUint32(c+8);if(e!==s+1){t="FCTLSequenceInvalid";break}s=e,r=!1,o+=1;break}case"IDAT":if(!i){t="iDATSeenBeforeACTL";break}if("IDAT"!==a&&r){t="InvalidIDAT";break}r=!0;break;case"fdAT":{if(!i){t="FDATSeenBeforeACTL";break}if("fdAT"!==a&&r){t="InvalidFDAT";break}const e=l.getUint32(c+8);if(e!==s+1){t="InvalidFDATSequence";break}s=e,r=!0;break}case"IEND":d=!0}a=f,c+=8+u+4}i?n<=1?t="NumFramesNotMoreThanOne":n!==o&&(t="NumFramesNotEqualToFCTLCount"):t=uu}catch(e){t=`Exception. ${e}`}return void 0!==t&&t!==uu&&(0,T.PN)(0,`Not apng. Reason: ${t}`),void 0===t}(await e.arrayBuffer())&&(this._mimeType="image/apng"))}async triggerDownloadFromProvider(){var e,t,i,r;if(this.isUrlFinal)return;if(void 0!==this._providerDownloadedUrl||void 0!==this._providerDownloadedBlobUrl)return;if(!this.pictureProvider.isHostPictureMetadata(this.id))return;const s=[];let n;try{this.state=4;const r=performance.now(),o=new URL(await this.pictureProvider.getPictureBlobDataFromHostPictureMetadata(this.id));s.push("GetPictureBlobDataFromHost"),this._providerDownloadedUrl=o,void 0===this._start&&(this._start=performance.now()),this._stats.getPictureDataFromHostTimeInMs=performance.now()-r;const a=await mu(o,this._urlStore,null===(e=this._options)||void 0===e?void 0:e.preferDataUrl);this._providerDownloadedBlobUrl=a.url,this._stats.delayDownloadedUrlStats=a.stats,n=a.blobType,s.push("ConvertUrlToBlobUrl"),await this.setMimeType(a.blob,void 0!==(null===(t=this._framesProviders)||void 0===t?void 0:t.get("image/apng"))),s.push("SetMimeType");const l=on(this._mimeType);void 0!==l&&(this._framesProvider=null===(i=this._framesProviders)||void 0===i?void 0:i.get(l)),rn(this._mimeType)&&void 0!==this._framesProvider&&(this.frames=this._framesProvider.getFrames(this._providerDownloadedBlobUrl.href),s.push("GetFrames")),void 0!==a.blobType&&this.storeDownloadCompletedBlobText(a.blobType)&&void 0!==a.blob&&(this._downloadCompletedBlobText=await a.blob.text(),s.push("SetBlobText")),this._stats.downloadState=2,this._stats.totalTimeInMs=performance.now()-this._start,this.state=5,s.push("SetStateDownloadedFromProvider")}catch(e){const t=new vs.A;t.extendedProperties.set("message",`Failed to download picture from host. Protocol[${this.originalUrl.protocol}] Error[${e}] BlobType[${n}] MimeType[${this._mimeType}] Stages[${s.join("|")}]`),(0,bs.R)("Picture","DownloadPictureFromHostFailed",t),this._stats.downloadState=3,this.state=6}null===(r=this._downloadCompleted)||void 0===r||r.emit(this._stats)}getPlaceholderUrlOrDefault(){var e,t,i;return null!==(i=null!==(t=null===(e=this.placeholder)||void 0===e?void 0:e.url)&&void 0!==t?t:this.originalBlobUrl)&&void 0!==i?i:this.originalUrl}setStateAndNotify(e,t){this.state!==e&&((0,T._v)(0,`setState: [${this.id}] State change ${this.state} -> ${e} | notify ${t}`),this._state=e,t&&this.stateUpdated.emit(this.state))}}class _u{}class yu extends Io{constructor(e,t,i,r,s,n,o,a){super(),this.type=_u,this.teardownTracker=new w("PictureViewModel"),this.onPictureDataStateUpdated=async e=>{var t;if(7===e)return await this.setPictureData(null===(t=this.model)||void 0===t?void 0:t.data),void this.imageViewModelUpdated.emit([0],!1);await this.setImageDataAndPopulateFramesIfNeeded()},this.framesProviders=o,this.pictureDataStore=vo.getInstance(),this.geometryVM=n(),this.placeholderVM=new du(e,t,i,n(),s.placeholder,a),this.teardownTracker.onTeardown((()=>{this.placeholderVM.teardown()})),this.fallbackRenderData=s.fallbackRenderData,this.update(e,i,s,r).then((()=>{})).catch((()=>{}))}async update(e,t,i,r,s,n){this.geometry=e,this.model=i,this.geometryVM.setGeometry(e,t),this.geometryVM.setProps(i.fill,i.line,void 0,i.hostContext.themeInfo,i.effects,i.pictureEffects,2),this.transform.equals(t)||(this.transform=t.clone()),this.opacity=i.opacity,this.fallbackRenderData=i.fallbackRenderData,this.ariaLabel=s,this.accessibleNode=n,this.setCrop(r,t,i.rotation),this.cachedImageData=this.imageData,await this.updatePictureData(i),await this.updatePlaceholder(i.placeholder)}async updateTransform(e,t,i,r){this.geometry=e,this.geometryVM.setGeometry(e,t),this.transform.equals(t)||(this.transform=t.clone()),this.setCrop(r,t),await this.updatePlaceholder(i)}setCrop(e,t,i){var r,s;const{scale:n,offset:o}=hu(t,e);this.scaleVector=n,this.topLeftOffset=o,this.setRotation(null!==(r=this.scaleVector)&&void 0!==r?r:new f(1,1),null!==(s=this.topLeftOffset)&&void 0!==s?s:new f(0,0),t,i)}isPlaceHolder(){var e,t,i;if(void 0!==this.placeholder)return!0;const r=null===(i=this.pictureDataStore.getDownloadDetails(null!==(t=null===(e=this.data)||void 0===e?void 0:e.id)&&void 0!==t?t:""))||void 0===i?void 0:i.isRenderUrlPlaceHolder;return void 0!==r&&r}getPlaceHolder(){var e,t,i;return void 0!==this.placeholder?this.placeholder:null===(i=this.pictureDataStore.get(null!==(t=null===(e=this.data)||void 0===e?void 0:e.id)&&void 0!==t?t:""))||void 0===i?void 0:i.downloadDetails.placeholder}async replacePictureData(e){var t;e.id!==(null===(t=this.data)||void 0===t?void 0:t.id)&&(this.data=e,await this.setPictureData(e))}async resetPictureData(){if(void 0!==this.model){const e=this.model;await this.updatePictureData(e)}}get mimeType(){var e;return null===(e=this.data)||void 0===e?void 0:e.mimeType}get downloadedBlobText(){var e,t,i;return null===(i=this.pictureDataStore.getDownloadDetails(null!==(t=null===(e=this.data)||void 0===e?void 0:e.id)&&void 0!==t?t:""))||void 0===i?void 0:i.downloadCompletedBlobText}get rotation(){return this._rotation}get rotationPoint(){return this._rotationPoint}teardown(){this.geometryVM.teardown(),this.teardownTracker.teardown()}async updatePictureData(e){var t;(null===(t=this.data)||void 0===t?void 0:t.id)!==e.data.id&&(this.data=e.data,await this.setPictureData(e.data))}async updatePlaceholder(e){Aa(e,this.placeholder)||(this.placeholder=e,await this.setImageDataAndPopulateFramesIfNeeded()),await this.placeholderVM.update(this.geometry,this.transform,this.placeholder)}async populateFrames(e){rn(this.mimeType)&&void 0!==this.framesProviders&&(void 0===e.frames&&(0,y.H)("Picture","AnimatedFrames","Frames not expected to be undefined"),await e.frames.populate(),this.frames=e.frames)}async setPictureData(e){var t,i;let r=this.pictureDataStore.get(null!==(i=null===(t=this.data)||void 0===t?void 0:t.id)&&void 0!==i?i:"");if(void 0!==r&&7!==r.downloadDetails.state)return await this.setImageDataAndPopulateFramesIfNeeded(),void this.teardownTracker.onTeardown(r.stateUpdated.use(this.onPictureDataStateUpdated));var s,n,o,a,h,c,d,u,f,p;7===(null==r?void 0:r.downloadDetails.state)&&r.stateUpdated.off(this.onPictureDataStateUpdated),s=e.id,n=e.originalUrl,o=e.downloadPlaceholder,a=e.isUrlFinal,h=e.pictureProvider,c=e.downloadCompleted,d=this.framesProviders,u=sn,f=l("UseUrlStore")?this.pictureDataStore.urlStore:void 0,p=e.options,r=new vu(s,n,o,a,h,c,d,u,f,p),this.teardownTracker.onTeardown(r.stateUpdated.use(this.onPictureDataStateUpdated)),this.pictureDataStore.add(r),await r.triggerDownload()}async setImageDataAndPopulateFramesIfNeeded(){var e,t;const i=this.getPlaceHolder();if(void 0!==i){if(i.overlay||i.renderAsSvg)return await this.placeholderVM.update(this.geometry,this.transform,i),void this.imageViewModelUpdated.emit([0],!1);if(this.imageData!==i.url.href)return await this.setImageData(i.url.href),void this.imageViewModelUpdated.emit([0],!1)}const r=this.pictureDataStore.getDownloadDetails(null!==(t=null===(e=this.data)||void 0===e?void 0:e.id)&&void 0!==t?t:""),s=null==r?void 0:r.renderUrl;void 0!==r&&void 0!==s&&s.href!==this.imageData&&(await this.setImageData(s.href),void 0===this.data&&(0,y.H)("Picture","PictureDataUndefined","Picture data not expected to be undefined"),this.data.mimeType=r.mimeType,r.downloadDone&&6!==r.state&&await this.populateFrames(r),this.imageViewModelUpdated.emit([0],null==r?void 0:r.downloadDone))}setRotation(e,t,i,r){const{width:s,height:n}=i.size,{fullWidth:o,fullHeight:a}={fullWidth:s*e.x,fullHeight:n*e.y},{x:l,y:h}=i.getCenter(),{x:c,y:d}=i.pos,u=new f((l-c+t.x)/o,(h-d+t.y)/a);this._rotation=null!=r?r:0,this._rotationPoint=u}}class bu{constructor(e,t,i,r,s,n=(()=>new Ad),o){var a;this.viewModelUpdated=new c,this.onModelUpdated=async()=>{let e=this.context.anchorPresenter.transform;const t=this.context.viewScale;t.viewTransform.size.equals(new v(0,0))||(e=t.viewTransform.clone(),e.size.width*=t.zoomFactor,e.size.height*=t.zoomFactor),await this.updateViewModel(e)},this.onAnchorTransformUpdated=async()=>{let e=this.context.anchorPresenter.transform;const t=this.context.viewScale;var i,r;t.viewTransform.size.equals(new v(0,0))||(e=t.viewTransform.clone(),e.size.width*=t.zoomFactor,e.size.height*=t.zoomFactor),i=e,r=this.pictureViewModel.transform,!i.pos.equals(r.pos)&&i.size.equals(r.size)&&i.rot===r.rot&&i.flip.equals(r.flip)?(this.pictureViewModel.transform=e.clone(),this.pictureViewModel.geometryVM.setCenter(e.getCenter()),this.pictureViewModel.placeholderVM.geometryVM.setCenter(e.getCenter()),this.pictureViewModel.cachedImageData=this.pictureViewModel.imageData,this.viewModelUpdated.emit()):l("PicturePresenterUseUpdateTransform")?(await this.pictureViewModel.updateTransform(this.getGeometry(),e,this.pictureModel.placeholder,this.pictureModel.crop),this.viewModelUpdated.emit()):await this.updateViewModel(e)},this.onImageViewModelUpdated=(e,t)=>{this.viewModelUpdated.emit(),e.includes(0)&&(!0===t?this.context.viewReadyTracker.removePending(this):this.context.viewReadyTracker.addPending(this)),void 0!==this.pictureViewModel.frames&&void 0===this.animatedPicturePlayControl&&(this.animatedPicturePlayControl=this.animatedPlayControlCreator(this.pictureViewModel.frames,this.context),this.pictureViewModel.pointerEventNotifiers.pointerover.value.on(this.onPointerOver),this.pictureViewModel.pointerEventNotifiers.pointerout.value.on(this.onPointerOut))},this.onPointerOver=()=>{void 0!==this.animatedPicturePlayControl&&this.animatedPicturePlayControl.setHovered(!0)},this.onPointerOut=()=>{void 0!==this.animatedPicturePlayControl&&this.animatedPicturePlayControl.setHovered(!1)},this.graphic=e,this.pictureModel=e.model,this.context=t,this.geometryRegistry=i,this.framesProviders=s,this.context.viewReadyTracker.addPending(this),this.animatedPlayControlCreator=n;const h=this.context.anchorPresenter.transform;this.pictureViewModel=new yu(this.getGeometry(),Od(Ud.D,this.context.anchorPresenter.transform),h,this.pictureModel.crop,this.pictureModel,r,this.framesProviders,void 0!==o?o():void 0),this.pictureViewModel.accessibleNode=null===(a=this.context.accessibleNodeCreator)||void 0===a?void 0:a.createAccessibleNode(this.graphic),this.pictureViewModel.source={graphic:e},this.pictureViewModel.imageViewModelUpdated.on(this.onImageViewModelUpdated),this.pictureModel.modelUpdated.on(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onAnchorTransformUpdated),this.context.viewScale.combinedScaleChanged.on(this.onAnchorTransformUpdated)}get viewModel(){return this.pictureViewModel}teardown(){this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.pictureModel.modelUpdated.off(this.onModelUpdated),this.pictureViewModel.imageViewModelUpdated.off(this.onImageViewModelUpdated),this.pictureViewModel.teardown(),void 0!==this.animatedPicturePlayControl&&(this.pictureViewModel.pointerEventNotifiers.pointerover.value.off(this.onPointerOver),this.pictureViewModel.pointerEventNotifiers.pointerout.value.off(this.onPointerOut),this.animatedPicturePlayControl.teardown()),this.context.viewScale.viewTransformChanged.off(this.onAnchorTransformUpdated),this.context.viewScale.combinedScaleChanged.off(this.onAnchorTransformUpdated)}setCrop(e){this.pictureViewModel.setCrop(e,this.context.anchorPresenter.transform,this.pictureModel.rotation),this.viewModelUpdated.emit()}setInCropMode(e){this.pictureViewModel.inCropMode!==e&&(this.pictureViewModel.inCropMode=e,this.viewModelUpdated.emit())}setSelected(e){void 0!==this.animatedPicturePlayControl&&this.animatedPicturePlayControl.setSelected(e)}async setPicturePreview(e,t){if(await this.pictureViewModel.replacePictureData(e),void 0!==t&&!this.context.anchorPresenter.transform.equals(t)){const e=la(this.context.anchorPresenter.transform,t);this.context.anchorPresenter.applyTransform(e)}}async resetPicturePreview(){await this.pictureViewModel.resetPictureData()}async updateViewModel(e){var t;await this.pictureViewModel.update(this.getGeometry(),e,this.pictureModel,this.pictureModel.crop,this.context.ariaLabelCreator.createAriaLabel(this.graphic),null===(t=this.context.accessibleNodeCreator)||void 0===t?void 0:t.createAccessibleNode(this.graphic)),this.viewModelUpdated.emit()}getGeometry(){var e;return Od(void 0!==this.pictureModel.geometry?this.geometryRegistry.getGeometry(this.pictureModel.geometry):Ud.D,this.context.anchorPresenter.transform,null===(e=this.pictureModel.geometry)||void 0===e?void 0:e.adjustValues)}}class wu extends class{constructor(e,t,i,r){this.viewModelUpdated=new c,this.onModelUpdated=(e,t)=>{this.refreshViewModel(1,t).catch((e=>{this.logCatchReason(e)}))},this.onAnchorTransformUpdated=e=>{this.refreshViewModel(2,e).catch((e=>{this.logCatchReason(e)}))},this.onViewTransformUpdated=e=>{this.refreshViewModel(8,e).catch((e=>{this.logCatchReason(e)}))},this.onCombinedScaleChanged=()=>{this.refreshViewModel(4).catch((e=>{this.logCatchReason(e)}))},this.graphic=e,this.context=t,this.viewModel=i(),this.imageTypeChecker=r,this.teardown=Td(this.graphic.model.modelUpdated.use(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.use(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.use(this.onViewTransformUpdated),this.context.viewScale.combinedScaleChanged.use(this.onCombinedScaleChanged))}init(e,t){void 0!==e&&this.viewModelUpdated.on(e),this.updateViewModelProperties(15,t).catch((e=>{this.logCatchReason(e)}))}async updateViewModelProperties(e,t){let i=!1;const r=new ro(`${this.presenterClassName}_UpdateViewModel`,void 0!==t?[t]:[]);try{0!=(8&e)&&(i=this.updateViewModelViewTransform()||i),0!=(2&e)&&(i=this.updateViewModelAnchorTransform()||i),0!=(4&e)&&(i=this.updateViewModelScaleFactor()||i),0!=(1&e)&&(i=await this.updateViewModelRenderData()||i)}catch(e){throw(0,T.H)(0,`Exception: ${e.message}`),e}finally{r.complete()}i&&(this.viewModelUpdated.emit(t),this.viewModel.imageViewModelUpdated.emit(function(e){const t=[];return 0!=(1&e)&&t.push(0),0!=(6&e)&&t.push(1),t}(e)))}async updateViewModelRenderData(){const e=this.graphic.model.fallbackRenderData;return void 0!==e&&(this.imageTypeChecker(e),this.viewModel.sourceAnchorBounds=e.sourceAnchorBounds.clone(),this.viewModel.bounds=e.targetBounds.clone(),await this.viewModel.setImageData(e.data),!0)}updateViewModelAnchorTransform(){return 0!==this.context.viewScale.viewTransform.size.width||0!==this.context.viewScale.viewTransform.size.height?this.updateViewModelViewTransform():!this.viewModel.transform.equals(this.context.anchorPresenter.transform)&&(this.viewModel.transform=this.context.anchorPresenter.transform.clone(),!0)}updateViewModelViewTransform(){return!this.viewModel.transform.equals(this.context.viewScale.viewTransform)&&(this.viewModel.transform=this.context.viewScale.viewTransform.clone(),!0)}updateViewModelScaleFactor(){return this.viewModel.scaleFactor!==this.context.viewScale.zoomFactor&&(this.viewModel.scaleFactor=this.context.viewScale.zoomFactor,!0)}logCatchReason(e){(0,T.H)(0,`${e}`)}async refreshViewModel(e,t){return this.updateViewModelProperties(e,t)}}{constructor(e,t,i){super(e,t,i,id),this.renderDataType=Qc,this.presenterClassName="Base64ImagePresenter"}}class Tu{}class xu{get imageData(){return this._imageData}constructor(e){this.type=Tu,this.imageViewModelUpdated=new c,this.pointerEventNotifiers=d(),this.sourceAnchorBounds=new p(0,0,0,0),this.bounds=new p(0,0,0,0),this.scaleFactor=1/window.devicePixelRatio,this.transform=new _,this.hitTestSlop=0,this.inCropMode=!1,this._imageData="",this.canvasImageSource=e}async setImageData(e){if(this._imageData=e,this.canvasImageSource instanceof HTMLImageElement)return Ls(this.canvasImageSource,e);(0,y._)(0,"Not yet supported")}teardown(){}}const Cu="data:",Pu="text/plain",Su="image/svg+xml";class Eu{constructor(e,t,i,r,s,n){this.color=e,this.direction=t,this.wrapScale=i,this.wrapOffset=r,this.diffuse=s,this.specular=n}}class Mu{constructor(e,t){this.ambientColor=e,this.lights=t}}class Ru{constructor(e,t){this.profile=e,this.size=t}}class Bu{constructor(e,t,i,r,s,n,o,a,l){this.materialType=e,this.diffuseColor=t,this.specularColor=i,this.ambientColor=r,this.emissiveColor=s,this.specularPower=n,this.useBlinnHighlight=o,this.diffuseFresnel=a,this.alphaFresnel=l}}class Iu{constructor(e,t,i,r,s,n,o,a){this.topBevel=e,this.bottomBevel=t,this.material=i,this.extrusionColor=r,this.extrusionHeight=s,this.contourColor=n,this.contourWidth=o,this.zPosition=a}get adjustedContourWidth(){return Math.max(te,this.contourWidth)}}var Au;!function(e){function t(t,s){if(!t)return M.Identity;const n=t.pt?i(t.pt).scale(s):void 0,o=t.s?r(t.s):new P(1,1),a=t.rSpecified?t.r*e.c_internalAngleToRadianFactor:void 0,l=t.t?i(t.t).scale(s):void 0;return new M(n,o,a,l)}function i(e){return new P(e.x,e.y)}function r(e,t=0){return new P(e.x||t,e.y||t)}function s(e){return new _e(e[0]/255,e[1]/255,e[2]/255,e[3]/255)}function n(e,t=1){return new R(e.l*t,e.t*t,e.r*t,e.b*t)}function o(e){let t=[];for(let i of e){const e=i.pos,r=s(i.clr);t.push(new Te(e,r))}return t.sort(((e,t)=>e.position-t.position)),t}function a(e,t){if(e.gradientStops=t,e.isGammaCorrected=!1,2==t.length||3==t.length){const i=t[0],r=t[t.length-1];if(0==Math.min(i.position,r.position)&&1==Math.max(i.position,r.position))if(2==t.length)e.isGammaCorrected=!0,e.blendBellShape=P.One;else if(3==t.length&&i.color.equals(r.color)){const r=t[1];e.gradientStops=[new Te(0,i.color),new Te(1,r.color)],e.isGammaCorrected=!0,e.blendBellShape=new P(r.position,1)}}}function l(t,i,r){switch(t.bt){case 0:return new we(_e.Transparent);case 1:{let e=s(t.Item.clr);return new we(e)}case 2:{const i=t.Item;let r=new xe(2);return r.isStretched=i.isStretched,r.rotateWithShape=i.rtSp,r.angle=i.ang*e.c_internalAngleToRadianFactor,i.ftrct&&(r.fillToRect=n(i.ftrct)),i.ffrct&&(r.fillFromRect=n(i.ffrct)),i.stops&&a(r,o(i.stops)),r}case 3:{const i=t.Item;let r=new xe(3);return r.isStretched=i.isStretched,r.rotateWithShape=i.rtSp,r.angle=i.ang*e.c_internalAngleToRadianFactor,i.ftrct&&(r.fillToRect=n(i.ftrct)),i.ffrct&&(r.fillFromRect=n(i.ffrct)),i.stops&&a(r,o(i.stops)),r}case 4:{const i=t.Item;let r=new xe(4);return r.isStretched=i.isStretched,r.rotateWithShape=i.rtSp,r.angle=i.ang*e.c_internalAngleToRadianFactor,i.ftrct&&(r.fillToRect=n(i.ftrct)),i.ffrct&&(r.fillFromRect=n(i.ffrct)),i.stops&&a(r,o(i.stops)),r}case 5:{const i=t.Item;let r=new xe(5);return r.isStretched=i.isStretched,r.rotateWithShape=i.rtSp,r.angle=i.ang*e.c_internalAngleToRadianFactor,i.ftrct&&(r.fillToRect=n(i.ftrct)),i.ffrct&&(r.fillFromRect=n(i.ffrct)),i.stops&&a(r,o(i.stops)),r}case 7:{const e=t.Item;return new Pe(e.type,s(e.clrFg),s(e.clrBg))}case 6:return h(t.Item,i);case 8:case 9:r.Message(39084627,`unsupported Brush ${JSON.stringify(t)}`)}return new we(_e.Transparent)}function h(e,t){if(!e.id)return;let i=new ye;i.id=e.id;let r=new Ce(i);return r.wrapMode=e.wrpmd,r.alignment=e.algn,r.isStretched=e.isStretched,r.offset=new P(e.off.x,e.off.y),r.scale=new P(e.scale.x,e.scale.y),r.opacity=e.opcty,r.rotateWithShape=e.rotWShp,r.isStretched||(r.scale=r.scale.divide(new P(e.dpi.x,e.dpi.y)).scale(t.fromInch),r.offset=r.offset.scale(t.fromHighPrecisionUnit)),r}function c(e){return{cap:e.capType,end:e.type,length:e.len,width:e.width,widthMin:e.widthMin}}function d(e,t,i){if(!e)return new Me;let r,s;e.fillBrsh&&(r=l(e.fillBrsh,t,i)),e.outlnBrsh&&(s=l(e.outlnBrsh,t,i));const n=function(e,t,i,r){let s=new Ee(t*r);return s.lineHeight=i*r,e?(e.dtSpecified&&(s.dashType=e.dt),e.jtSpecified&&(s.lineJoin=e.jt),e.mlSpecified&&(s.miterLimit=e.ml),e.ctSpecified&&(s.compoundType=e.ct),e.atSpecified&&(s.alignment=e.at),e.doffSpecified&&(s.dashOffset=e.doff),e.dctSpecified&&(s.useRoundDash=1==e.dct),e.headEnd&&(s.headEnd=c(e.headEnd)),e.tailEnd&&(s.tailEnd=c(e.tailEnd)),e.tip&&(s.tipType=e.tip),s):s}(e.pen,e.lnWdth,e.lnHgth,t.fromHighPrecisionUnit);let o=new Me(r,s,n);return e.pctBrush&&(o.pictureBrush=h(e.pctBrush,t)),e.blend&&(o.blendingMode=e.blend),o}function u(t,i,r){let n,o,a,l,h;if(t.glw){let e=t.glw.blrRd*i,r=s(t.glw.clr);n=new Ie(r,e)}if(t.otrSdw){let n=t.otrSdw;o=new Ae(s(n.clr),n.blrRd*i,n.ang*e.c_internalAngleToRadianFactor,n.dst*i,new P(n.sx*r,n.sy*r),new P(n.kx,n.ky)),o.alignment=n.algn,o.shadowType=n.tp}if(t.inrSdw){let r=t.inrSdw;a=new Fe(s(r.clr),r.blrRd*i,r.ang*e.c_internalAngleToRadianFactor,r.dst*i)}if(t.rflctn){let e=t.rflctn;l=new ke(e.blrRd*i,e.sAlph,e.sPos,e.eAlph,e.ePos,e.dst*i)}return t.sftEdg&&(h=new De(t.sftEdg.blrRd*i)),new Le(n,o,a,l,h)}function f(e,i,r){let s=e.pts;if(!s)return;const n=null==(o=e.f)?1:0==o?0:2==o?2:3==o?3:4==o?4:5==o?5:1;var o;let a;if(e.h>0){let t=JSON.parse("["+s+"]");a={figures:[new z(t,!1,e.h)]}}else a={figures:W(s)};return a.fillMode=n,a.lineEnabled=e.s,e.xfrm?a.transform=t(e.xfrm,r):a.transform=M.Identity,a.transform=a.transform.applyScaleAndTranslationBefore(new P(i,i),P.Zero),a.extrusionEnabled=e.e,a}function p(e,i,s){let n=[];const o=e.xfrm?t(e.xfrm,i.fromHighPrecisionUnit):M.Identity,a=e.fontInfo;for(const t of e.glyphInstance)if(t.glyph&&s){const e=s.getGlyph(a,t.glyph);if(!e)continue;if(!e.clientData){let i=f(e.p,1,1);i&&(i.lineEnabled=!0,i.fillMode=1,i.glyphCacheId={fontId:a,glyphId:t.glyph},e.clientData=new V(i))}if(!e.clientData)continue;let l=r(t.scale,1).scale(i.fromHighPrecisionUnit);l=l.scale(.000244140625);let h=r(t.off).scale(i.fromHighPrecisionUnit);const c=new V(e.clientData,o.applyScaleAndTranslationBefore(l,h));n.push(c)}return n}function m(e){return new Ue(e.cp,e.len)}function g(e,t){const i=f(e,1,1);if(i){const e=i.figures.length?i.figures[0]:void 0;if(e){const i=e instanceof z?e:e.createFigure();if(1==t)return i;{const e=i.points.slice(0);for(let r=0;r<i.getPointCount();r++)e[r*i.pointDataSize]*=t,e[r*i.pointDataSize+1]*=t;return new z(e,i.isClosed,i.format)}}}}function v(e,t){if(!e)return 0;switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;case 7:return 7;case 8:return 8;case 9:return 9;case 10:return 10;case 11:return 11;case 12:return 12;case 13:return 13;case 14:return 14;case 15:return 15;case 16:return 16}return t.Error(595637021,"Incorrect ShapeBuilder.TextStrokeType"),1}function _(e,t,i){const r=new fe;for(const s of e){const e=d(s.style,t,i);r.push(new Ge(v(s.type,i),s.verticalCenter*t.fromLowPrecisionUnit,s.thickness*t.fromLowPrecisionUnit,e))}return r}function y(e,t,i,r,s,n){const o=n.getGlyph(s,e);if(o){if(!o.clientData){let t=f(o.p,1,1);t&&(t.lineEnabled=!0,t.fillMode=1,t.glyphCacheId={fontId:s,glyphId:e},o.clientData=new V(t))}if(o.clientData)return new V(o.clientData,new M(P.Zero,t,r,i))}}function b(t,i,s,n,o,a){let l=[];const h=t.fi?t.fi.v:i;for(const i of t.gi||[])if(i.g&&o){const t=i.s?r(i.s,1).scale(n.fromHighPrecisionUnit/4096):s||P.Zero;t.equals(P.Zero)&&a.Error(0,"No glyph scale");const c=r(i.o).scale(n.fromHighPrecisionUnit),d=i.r?i.r.v*e.c_internalAngleToRadianFactor:0,u=y(i.g,t,c,d,h,o);u&&l.push(u)}return l}function w(e,t,i,r,s,o,a){let l=[];for(let n of e.g||[])l=l.concat(b(n,t,i,r,s,a));for(let t of e.p||[]){const e=f(t,r.fromHighPrecisionUnit,r.fromHighPrecisionUnit);e&&l.push(new V(e))}let c,d=n(e.lb,r.fromLowPrecisionUnit);if(e.i){const t=h(e.i.i,r),i=n(e.i.b,r.fromLowPrecisionUnit);(null==t?void 0:t.image)&&i&&(c=new je(t.image,i,o))}return new Xe(d,l,e.f?e.f.v:void 0,e.w?e.w.v:void 0,c)}function T(e,t,i,r,s,o,a){var l;let h=m(e.rng),c=n(e.lbnd,r.fromLowPrecisionUnit),d=new Ze(h,c),u=[];if(e.c)for(let n=0;n<e.c.length;n++){let l=w(e.c[n],t.getAt(d.localRange.start+n),i.getAt(d.localRange.start+n),r,s,o,a);l&&u.push(l)}else(null===(l=e.s)||void 0===l?void 0:l.v)&&(u=function(e,t,i,r,s,n,o,a){const l=[],h=e.split(";");for(let e=0;e<h.length;e++){const c=h[e].split(/([A-VXYZ])/),d=c.length>0?c[0]:void 0;let u,f;for(let e=1;e<c.length-1;e+=2){const t=c[e];"L"==t&&(u=c[e+1]),"R"==t&&(f=c[e+1])}if(d&&u&&f){const a=parseFloat(u)*o.fromLowPrecisionUnit,h=parseFloat(f)*o.fromLowPrecisionUnit,c="W"==d;let p;if(!c){const t=y(parseInt(d),s.getAt(n+e),new P(a,0),0,r.getAt(n+e),i);t&&(p=[t])}const m=new R(a,t.top,h,t.bottom);l.push(new Xe(m,p,!1,c))}else a.Error(0,"Wrong SimplifiedCharacterString: 0:"+d+", L:"+u+", R:"+f)}return l}(e.s.v,c,s,t,i,d.localRange.start,r,a));return d.characters=u,e.b&&(d.bender=function(e,t){return e.wenv?function(e,t){const i=g(e.tpp,t.fromLowPrecisionUnit),r=g(e.btp,t.fromLowPrecisionUnit);if(i&&r)return new qe(n(e.rct,t.fromLowPrecisionUnit),i,r,e.vrt)}(e.wenv,t):e.plin?function(e,t){const i=g(e.pth,t.fromLowPrecisionUnit);if(i){const r=0==e.algn?0:2==e.algn?1:.5;return new We(n(e.rct,t.fromLowPrecisionUnit),i,r,e.s,e.pvt,e.vrt)}}(e.plin,t):void 0}(e.b,r)),e.o&&(d.offset=new P(e.o.x*r.fromLowPrecisionUnit,e.o.y*r.fromLowPrecisionUnit)),d.fillBounds=n(e.fb,r.fromLowPrecisionUnit),d.textEffectMetrics=new Ke(e.ea*r.fromLowPrecisionUnit,e.ed*r.fromLowPrecisionUnit,e.eh*r.fromLowPrecisionUnit),d}function x(e,t,i,s,n){let o=new Je(m(e.gr),new Me(new Pe(27,_e.Blue,_e.Yellow)));e.o&&(o.offset=new P(e.o.x*i.fromLowPrecisionUnit,e.o.y*i.fromLowPrecisionUnit));let a=new Ve("");for(let t of e.fipr||[])a.set(t.fontInfo,m(t.range));let l=new Ve(P.Zero);for(let t of e.gspr||[])l.set(r(t.s,1).scale(i.fromHighPrecisionUnit/4096),m(t.rng));e.blt&&(o.bullet=function(e,t,i,r,s,n){var o;if(!e.c)return;const a=w(e.c,t,void 0,i,r,s,n),l=d(e.style,i,n),h=e.fx?u(e.fx,i.fromHighPrecisionUnit,1):void 0,c=(null===(o=e.stks)||void 0===o?void 0:o.length)>0?_(e.stks,i,n):void 0;return new Ye(a,l,h,c)}(e.blt,e.blt.fi,i,t,s,n));const h=new Array;for(let r of e.l||[]){const e=T(r,a,l,i,t,s,n);e&&h.push(e)}for(let t of e.spr||[]){const e=d(t.style,i,n);o.stylePerLocalRange.set(e,m(t.range))}for(let t of e.stkspr||[]){const e=_(t.textStrokeList,i,n);e?o.strokesPerLocalRange.set(e,m(t.range)):n.Error(39084627,"Unable to convert stroke")}for(let t of e.lwrng||[])o.addLocalWordRange(m(t));for(let t of e.fxpr||[])o.effectsPerLocalRange.set(u(t.fx,i.fromHighPrecisionUnit,1),m(t.range));return o.lines=h,o}function C(e,t){return e?new B(e.l?e.l.v*t:void 0,e.t?e.t.v*t:void 0,e.r?e.r.v*t:void 0,e.b?e.b.v*t:void 0):void 0}e.c_internalAngleToRadianFactor=2*Math.PI/216e5,e.getPresWidthAndHeightJson=function(e){return new P(e.w,e.h)};const I=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0];function A(e){let t=I[e];if(t)return t;const i=new H;switch(i.moveTo(0,0),e){case 0:i.cubicBezierTo(0,.367,.124605,.82,.507899,1),i.cubicBezierTo(.724115,.737,.790455,.64,1,.64);break;case 1:i.cubicBezierTo(0,.55627,.44373,1,1,1);break;case 2:i.quadBezierTo(0,.125,.025,.25),i.lineTo(.125,.75),i.cubicBezierTo(.175,1,.25,1,.375,1),i.lineTo(.5,1),i.cubicBezierTo(.625,1,.7,1,.75,.75),i.lineTo(.875,.125),i.cubicBezierTo(.9,.01,.98,.01,1,.01);break;case 3:i.cubicBezierTo(0,.05563,.04437,.1,.1,.1),i.lineTo(.4,.1),i.cubicBezierTo(.45563,.1,.5,.14437,.5,.2),i.lineTo(.5,.9),i.cubicBezierTo(.5,.95563,.54437,1,.6,1);break;case 4:i.lineTo(1,1);break;case 5:i.cubicBezierTo(0,.4775,.0968736,1,.156301,1),i.cubicBezierTo(.264179,1,.376919,.33333,1,.33333);break;case 6:i.cubicBezierTo(0,.07082,.0297458,.1,.101416,.1),i.cubicBezierTo(.501416,.1,.9,.7,.901416,.899999),i.cubicBezierTo(.9,.97167,.93343,1,1,1);break;case 7:i.cubicBezierTo(0,.138122,0,.2,.271356,.775535),i.cubicBezierTo(.377654,1,.519455,1,.583589,1);break;case 8:i.cubicBezierTo(0,.236604,.119276,.607024,.263046,.760235),i.cubicBezierTo(.361098,.864726,.457934,.909567,.537806,.925082),i.cubicBezierTo(.559245,.929246,.567625,.89793,.542066,.845567),i.cubicBezierTo(.484073,.726757,.477103,.393693,.551651,.393693),i.lineTo(.899894,.393693),i.cubicBezierTo(.99148,.393693,.958466,.746659,.907348,.779629),i.lineTo(.879394,.797658),i.cubicBezierTo(.845545,.819489,.848775,.954172,.874334,.971627),i.quadBezierTo(.915883,1,1,1);break;case 9:i.cubicBezierTo(0,.238519,.132047,.500741,.357567,.731852),i.cubicBezierTo(.513167,.891311,.563798,.912593,.735905,.912593),i.lineTo(.873887,.912593),i.cubicBezierTo(.956973,.912593,.878338,1,1,1);break;case 10:i.quadBezierTo(0,.092437,.042353,.305322),i.lineTo(.170124,.947558),i.cubicBezierTo(.177203,.983142,.2,1,.268235,.998599),i.lineTo(.614118,.998599),i.cubicBezierTo(.647059,.998599,.656471,.987395,.663529,.969188),i.cubicBezierTo(.687006,.908633,.802353,.822129,1,.822129);break;case 11:i.cubicBezierTo(0,.184095,.149238,.333333,.333333,.333333),i.cubicBezierTo(.333333,.701523,.63181,1,1,1);break;default:i.lineTo(1,0)}return t=i.createFigure(),I[e]=t,t}function F(e,i,r,s,n){const o=new Qe,a=new M(s.translation.negate(),P.One,-s.rotation,P.Zero);return o.paragraphs=function(e,t,i,r,s){let n=[];for(let o of e||[])n.push(x(o,t,i,r,s));return n}(e.p,i,r,a,n),o.layoutToFrame=t(e.ltfxfrm,r.fromHighPrecisionUnit),o.frameToShape=t(e.ftsxfrm,r.fromHighPrecisionUnit),o.clipBounds=C(e.c,r.fromLowPrecisionUnit),o.applyEffectsPerCharacter=!!e.s&&e.s.v,o}function k(e){return e.clientData||(e.clientData={}),e.clientData}function D(e,i,r,n,o){var a;if(!e)return;const l=(null===(a=e.bapi)||void 0===a?void 0:a.v)||"";let h;if(e.Items){let t=[];for(const s of e.Items){const e=D(s,i,r,n,o);e&&t.push(e)}const s=e.fx?u(e.fx,r.fromHighPrecisionUnit,.01):void 0;h=new wt(t,s)}else h=function(e,i,r,n,o){try{if(!e)return;let a=[];const l=t(e.xfrm,n.fromHighPrecisionUnit);let h=new Array;if(i)for(let e of i){if(!e)continue;let t=f(e,n.fromHighPrecisionUnit,n.fromHighPrecisionUnit);t&&h.push(new V(t))}e.tx&&function(e,{},i,r,s,n){var o;for(let a of e){if(!a.primitives)continue;let e=new Array;for(const t of a.primitives)if(null===(o=null==t?void 0:t.p)||void 0===o?void 0:o.pts.length){let i=f(t.p,r.fromHighPrecisionUnit,r.fromHighPrecisionUnit);if(!i)continue;i.lineEnabled=!0,i.fillMode=1,e.push(new V(i))}else if(t.r){const s=p(t.r,r,i);e.push(...s)}const l={fromLowPrecisionUnit:r.fromLowPrecisionUnit,fromHighPrecisionUnit:r.fromLowPrecisionUnit,fromInch:r.fromInch};let h=d(a.style,l,n);const c=t(a.xfrm,r.fromHighPrecisionUnit);let u=new bt(e,h,void 0,c);u.overlapMode=1,u.mergeMode=a.union?1:0,u.role=3,s.push(u)}}(e.tx,l,r,n,a,o);let c=d(e.style,n,o);const m=e.fx?u(e.fx,n.fromHighPrecisionUnit,.01):void 0;if(e.tx){let t=m?new Le(void 0,void 0,m.innerShadow,void 0,m.softEdges):void 0,i=m?new Le(m.glow,m.shadow,void 0,m.reflection,void 0):void 0;const s=new bt(h,c,t,l);return e.tl&&(s.text=F(e.tl,r,n,l,o)),new wt([s,...a],i)}const g=new bt(h,c,m,l);if(e.tl&&(g.text=F(e.tl,r,n,l,o)),void 0!==e.ioff){let t=[];for(const i of e.ioff){const e=new P(i.x*n.fromHighPrecisionUnit,i.y*n.fromHighPrecisionUnit);t.push(e)}t.length>0&&(g.instances=t.map((e=>new _t(E.Translation2D(e)))))}if(e.s3d){const t=e.s3d.tb?new Ru(A(e.s3d.tb.p),new P(e.s3d.tb.w*n.fromLowPrecisionUnit,e.s3d.tb.h*n.fromLowPrecisionUnit)):void 0,i=e.s3d.bb?new Ru(A(e.s3d.bb.p),new P(e.s3d.bb.w*n.fromLowPrecisionUnit,e.s3d.bb.h*n.fromLowPrecisionUnit)):void 0,r=function(e,t,i,r){let s=t,n=0,o=_e.Black,a=_e.Black,l=_e.Black,h=0,c=!1,d=0,u=0;switch(e){case 0:a=t,c=!0;break;case 1:o=_e.White,a=t,h=32,c=!0;break;case 2:const e=_e.InterpolateLinear(t,_e.Black,1/3);s=e,o=t,a=e,h=32,c=!0,n=2;break;case 3:n=1;break;case 4:a=t;break;case 5:o=_e.Gray(.6),a=t,h=12;break;case 6:let i=_e.InterpolateLinear(t,_e.White,.2);i=_e.InterpolateLinear(i,_e.White,1.4),o=i,a=t,h=12,d=4,n=2;break;case 7:o=_e.Gray(.3),a=t,h=8;break;case 8:{const e=new _e(t.r,t.g,t.b,.7);s=e,o=_e.Gray(.3),a=e,h=10,c=!0,d=2,u=-1;break}case 9:s=_e.InterpolateLinear(t,_e.White,.5),o=_e.Gray(.3),a=_e.InterpolateLinear(t,_e.White,.5),h=10,c=!0,d=2;break;case 10:o=_e.White,a=t,h=35,d=-2;break;case 11:o=_e.White,a=t,h=35,d=4,u=-10;break;case 12:{const e=new _e(t.r,t.g,t.b,.1);s=e,o=_e.Gray(.6),a=e,h=20,d=-8,u=1;break}case 13:s=new _e(0,0,0,t.a),o=_e.Gray(.8),l=t,h=50,d=-4,u=1;break;case 14:s=_e.InterpolateLinear(t,_e.White,.5),a=t,h=8,n=2;break;default:o=_e.White,a=t,h=40}return i||0!=e&&1!=e&&2!=e||(s=new _e(0,0,0,t.a),o=_e.Gray(.8),a=_e.Black,l=t,h=50,c=!1,d=-4,u=0),new Bu(n,s,o,a,l,h,c,d,u)}(e.s3d.mt,_e.White,c.fillBrush instanceof we&&c.lineBrush instanceof we),o=e.s3d.cc?s(e.s3d.cc.v):1==r.materialType?_e.Black:void 0,a=e.s3d.cc?e.s3d.cw*n.fromLowPrecisionUnit:0,l=e.s3d.xc?s(e.s3d.xc.v):void 0,h=new Iu(t,i,r,l,e.s3d.h*n.fromLowPrecisionUnit,o,a,e.s3d.z*n.fromLowPrecisionUnit);g.shape3D=h}return g}catch(e){o.Error(595637020,"Unexpected exception parsing shape")}}(e,e.pthLst||[],i,r,n),h&&e.c&&(h=new wt([h]),h.clipBounds=C(e.c,r.fromLowPrecisionUnit));return h&&(h.scene3D=e.scn?function(e){const t=[];for(let i of e.l||[])t.push(new Eu(new _e(i.cr,i.cg,i.cb,1),new S(i.dx,i.dy,i.dz),i.ws,i.wo,i.d,i.s));return new Mu(s(e.a),t)}(e.scn):void 0,k(h).partId=l,k(h).renderDataId=e.id,(null==o?void 0:o.defaultClientData)&&function(e,t){const i=k(e);for(const e of Object.keys(t))i[e]=t[e]}(h,o.defaultClientData)),h}e.convertDocShapeOrGroup=function(e,t,i,r,s){if(!e)return;const n=12700*i;return D(e,t,{fromLowPrecisionUnit:e.lpu?e.lpu.v*n:1,fromHighPrecisionUnit:e.hpu?e.hpu.v*n:i,fromInch:914400*i},r,s)},e.convertShapeOrGroupRenderData=D}(Au||(Au={}));const Fu=new class{Error(e,t){(0,T.H)(e,t)}Message(e,t){(0,T.PN)(e,t)}};function ku(e,t){let i=0;return 0!==t&&(i=e/t),i}class Du{constructor(e,t,i,r){var s,n;this.renderDataType=nd,this.viewModel=new Pd,this.childViewModels=new Map,this.viewModelUpdated=new c,this.sbViewModel=new At,this.onModelUpdated=(e,t)=>{null==t||t.addTimePoint("ModelUpdatedEventReceivedTime"),this.refreshViewModel(1,t).catch((e=>{this.logCatchReason("onModelUpdated",e)}))},this.onAnchorTransformUpdated=e=>{this.refreshViewModel(2,e).catch((e=>{this.logCatchReason("onAnchorTransformUpdated",e)}))},this.onViewTransformUpdated=e=>{this.refreshViewModel(8,e).catch((e=>{this.logCatchReason("onViewTransformUpdated",e)}))},this.onCombinedScaleChanged=()=>{this.refreshViewModel(4).catch((e=>{this.logCatchReason("onCombinedScaleChanged",e)}))},this.graphic=e,this.glyphStore=t,this.context=i,this.shapeBuilderContext=r,this.viewModel.children=[this.sbViewModel],this.viewModel.model=this.graphic.model,s=this.viewModel,n={graphic:this.graphic},void 0!==s.source?s.source=Object.assign(Object.assign({},s.source),n):s.source=n,this.graphic.model.modelUpdated.on(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onViewTransformUpdated),this.context.viewScale.combinedScaleChanged.on(this.onCombinedScaleChanged)}init(e,t){void 0!==e&&this.viewModelUpdated.on(e),this.updateViewModelProperties(15,t).catch((e=>{this.logCatchReason("constructor",e)}))}teardown(){this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.off(this.onViewTransformUpdated),this.graphic.model.modelUpdated.off(this.onModelUpdated)}async updateViewModelProperties(e,t){null==t||t.addTimePoint("ShapeBuilderRenderDataPresenterStartTime");let i=!1;const r=new ro("ShapeBuilderRenderDataPresenter_UpdateViewModel",void 0!==t?[t]:[]);try{0!=(8&e)&&(i=this.updateViewModelViewTransform()||i),0!=(2&e)&&(i=this.updateViewModelAnchorTransform()||i),0!=(4&e)&&(i=this.updateViewModelZoomFactor()||i),0!=(1&e)&&(i=await this.updateViewModelRenderData(t)||i)}catch(e){throw(0,T.H)(0,`Exception: ${e.message}`),e}finally{r.complete()}i&&(null==t||t.addTimePoint("ViewModelUpdatedEventEmittedTime"),this.viewModelUpdated.emit(t)),null==t||t.addTimePoint("ShapeBuilderRenderDataPresenterEndTime")}async updateViewModelRenderData(e){const t=this.graphic.model.fallbackRenderData;if(void 0===t)return!1;!function(e){if(!ad(e))throw new Error(`Invalid renderData type: ${e.type}`)}(t);let i=1,r=1;i=0!==this.context.viewScale.viewTransform.size.width?ku(this.context.viewScale.viewTransform.size.width,t.sourceAnchorBounds.width()):ku(this.context.anchorPresenter.transform.size.width,t.sourceAnchorBounds.width()),r=0!==this.context.viewScale.viewTransform.size.height?ku(this.context.viewScale.viewTransform.size.height,t.sourceAnchorBounds.height()):ku(this.context.anchorPresenter.transform.size.height,t.sourceAnchorBounds.height());const s=Math.max(i,r),n=t.sourceAnchorBounds.clone();if(n.scale(s,s),n.isEmpty())return this.sbViewModel.setItems([]),!0;const o=Au.convertDocShapeOrGroup(t.shapeBuilderRenderData,this.glyphStore,s,Fu,{});if(void 0===o)this.sbViewModel.setItems([]);else{this.createViewModelsForChild(o,n,s);const i=new ro("ShapeBuilderRenderDataPresenter_SetImageList",void 0!==e?[e]:[]);try{await this.setImageListIntoShapeBuilderDataAsync(t.embeddedImageList,o)}finally{i.complete()}this.sbViewModel.setItems([o])}return this.sbViewModel.sourceAnchorBounds=n,this.sbViewModel.emuToSourceScale=s,!0}createViewModelsForChild(e,t,i){if(this.childViewModels.clear(),2===e.getType()){const r=e;if(void 0!==r.clientData.renderDataId){const e=r.items;e.length>0&&2===e.elements[0].getType()&&(e.elements[0].items.elements.forEach((e=>{const r=new At;r.setItems([e]),r.isHitTestOnly=!0,r.sourceAnchorBounds=t,r.emuToSourceScale=i;const s=e.clientData.renderDataId,n=this.getRenderDataIdForItemWithKey(s,"creation"),o=this.getRenderDataIdForItemWithKey(s,"type");this.childViewModels.set(n,new Pd([r],{nodeType:o,nodeKey:n}))})),this.viewModel.children.push(...this.childViewModels.values()))}}}getRenderDataIdForItemWithKey(e,t){let i="";return e.forEach((e=>{e.k===t&&(i=e.v)})),i}async setImageListIntoShapeBuilderDataAsync(e,t){if(void 0===e||0===e.length)return;const i=this.attachTexturesForImagesAsync(e,t);0===this.sbViewModel.scene.items.length?i.then((()=>{this.viewModelUpdated.emit()})).catch((e=>{this.logCatchReason("attachTexturesForImagesAsync continuation",e)})):await i}async attachTexturesForImagesAsync(e,t){const i=t.getBrushImages(),r=[];for(const t of e)for(const e of i)t.imageIdField.toString()===e.id&&r.push(this.attachTextureForImageAsync(t.imageDataField,e));await Promise.all(r)}async attachTextureForImageAsync(e,t){const i=new window.Image;await Ls(i,e),function(e){if(0!==e.width||0!==e.height)return;const t=function(e){try{const t=function(e){if(!e.startsWith(Cu))return;const t=e.indexOf(",",Cu.length);if(-1===t)return;const i=e.substring(Cu.length,t);if(i.length<=0)return Pu;const r=i.indexOf(";"),s=-1===r?i:i.substring(0,r);return s.length<=0?Pu:s.toLowerCase()}(e);if(t!==Su)return;const i=e.indexOf(",",Cu.length);if(-1===i)return;const r=e.substring(i+1);if(0===r.length)return;const s=decodeURIComponent(r),n=(new DOMParser).parseFromString(s,Su).documentElement,o=function(e,t){if(e.unitType===t.unitType)return e.value/t.value}(n.width.baseVal,n.height.baseVal);return void 0===o?new v(300,150):isFinite(o)?new v(150*o,150):new v(300,0)}catch(e){return}}(e.src);void 0!==t&&(e.width=t.width,e.height=t.height)}(i);const r=this.shapeBuilderContext.renderer,s=ri.CreateFromHTMLImageElement("ShapeBuilderRenderDataPresenter",r,i);r.attachTextureToImage(t,s)}updateViewModelAnchorTransform(){return 0!==this.context.viewScale.viewTransform.size.width||0!==this.context.viewScale.viewTransform.size.height?this.updateViewModelViewTransform():!this.sbViewModel.transform.equals(this.context.anchorPresenter.transform)&&(this.sbViewModel.transform=this.context.anchorPresenter.transform.clone(),!0)}updateViewModelViewTransform(){return!this.sbViewModel.transform.equals(this.context.viewScale.viewTransform)&&(this.sbViewModel.transform=this.context.viewScale.viewTransform.clone(),!0)}updateViewModelZoomFactor(){return this.sbViewModel.scaleFactor!==this.context.viewScale.zoomFactor&&(this.sbViewModel.scaleFactor=this.context.viewScale.zoomFactor,!0)}logCatchReason(e,t){(0,T.H)(0,`ShapeBuilderRenderDataPresenter.${e}: ${t}`)}async refreshViewModel(e,t){return this.updateViewModelProperties(e,t)}}function Lu(e,t){try{e.setPointerCapture(t.pointerId)}catch(e){}}class Ou{constructor(){this.zoomPanUpdated=new c,this._zoom=1,this._pan=new f(0,0)}static getInstance(){return void 0===Ou.instance&&(Ou.instance=new Ou),Ou.instance}set zoom(e){this._zoom!==e&&(this._zoom=e,this.zoomPanUpdated.emit())}get zoom(){return this._zoom}set pan(e){this._pan.x===e.x&&this._pan.y===e.y||(this._pan=new f(e.x,e.y),this.zoomPanUpdated.emit())}get pan(){return new f(this._pan.x,this._pan.y)}setZoomAndPan(e,t){this._zoom===e&&this._pan.x===t.x&&this._pan.y===t.y||(this._zoom=e,this._pan=new f(t.x,t.y),this.zoomPanUpdated.emit())}getRelativePosition(e){return new f((e.x-this._pan.x)/this._zoom,(e.y-this._pan.y)/this._zoom)}getRelativeSize(e){return new v(e.width/this._zoom,e.height/this._zoom)}getAbsolutePosition(e){return new f(e.x*this._zoom+this._pan.x,e.y*this._zoom+this._pan.y)}getAbsoluteSize(e){return new v(e.width*this._zoom,e.height*this._zoom)}}function Uu(){return Ou.getInstance()}function Vu(e){if(null!==e.currentTarget){const t=e.currentTarget.getBoundingClientRect();return Uu().getRelativePosition(new f(e.clientX-t.left,e.clientY-t.top))}return new f(0,0)}class Nu{}class Gu{constructor(e,t,i){this.type=Nu,this.onPointerDown=(e,t)=>{Lu(e.currentTarget,e),this.dragStartPosition=Vu(e),e.ctrlKey||e.shiftKey?this.editContext.actionInvoker.invoke(new Ac([this.elementModelId])):(this.editContext.actionInvoker.invoke(new th([this.graphic])),this.editContext.actionInvoker.invoke(new Bc([this.elementModelId]))),t.isHandled=!0},this.onPointerMove=(e,t)=>{void 0!==this.dragStartPosition?t.isHandled=!0:t.isHandled=!1},this.onPointerUp=(e,t)=>{void 0!==this.dragStartPosition?(this.dragStartPosition=void 0,t.isHandled=!0):t.isHandled=!1},this.onPointerCancel=(e,t)=>{void 0!==this.dragStartPosition?(this.dragStartPosition=void 0,t.isHandled=!0):t.isHandled=!1},this.graphic=e,this.elementModelId=t,this.editContext=i}addEventListeners(e){e.pointerEventNotifiers.pointerdown.value.on(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.on(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.on(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerEventNotifiers.pointerdown.value.off(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.off(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.off(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.off(this.onPointerCancel)}}class zu{constructor(e,t,i){this.elements=new Map,this.updateElements=()=>{const e=this.elements;this.elements=new Map;const t=this.presenter.viewModel;Sd(t)&&t.children.forEach((t=>{var i;if(Sd(t)&&void 0!==(null===(i=t.nodeId)||void 0===i?void 0:i.nodeKey)&&1===t.children.length){const i=t.nodeId.nodeKey,r=e.get(i);void 0!==r?(e.delete(i),this.elements.set(i,r),r.setViewModel(t.children[0])):this.elements.set(i,new Hu(new Gu(this.graphic,i,this.editContext),t.children[0]))}}));for(const[t,i]of e)i.teardown()},this.graphic=e,this.presenter=t,this.editContext=i,this.updateElements(),this.presenter.viewModelUpdated.on(this.updateElements)}teardown(){this.presenter.viewModelUpdated.off(this.updateElements);for(const[e,t]of this.elements)t.teardown()}}class Hu{constructor(e,t){this.element=e,this.viewModel=t,this.element.addEventListeners(this.viewModel)}teardown(){this.element.removeEventListeners(this.viewModel)}setViewModel(e){this.viewModel!==e&&(this.element.removeEventListeners(this.viewModel),this.viewModel=e,this.element.addEventListeners(this.viewModel))}}const Wu={nodeType:"root"};class $u{get viewModel(){return this.smartArtRenderDataPresenter.viewModel}get viewModelUpdated(){return this.smartArtRenderDataPresenter.viewModelUpdated}constructor(e,t,i,r){this.smartArtModelPresenterCreator=(e,t,i)=>this.smartArtInnerPresenter,this.graphic=e,this.smartArtInnerPresenter=new qu(this.graphic,t,i),this.smartArtRenderDataPresenter=new gd(this.graphic,t,this.smartArtModelPresenterCreator,r),void 0!==r&&(this.editElements=new zu(this.graphic,this,r))}teardown(){var e;null===(e=this.editElements)||void 0===e||e.teardown(),this.smartArtRenderDataPresenter.teardown(),this.smartArtInnerPresenter.teardown()}}class qu{constructor(e,t,i){this.viewModel=new Pd([],Wu),this.viewModelUpdated=new c,this.onLayoutUpdated=()=>{this.updateViewModel().catch((()=>{}))},this.onAnchorTransformUpdated=()=>{this.smartArt.modelUpdated.emit()},this.graphic=e,this.smartArt=this.graphic.model,this.anchorPresenter=t.anchorPresenter,this.presenterSite=i,this.smartArt.layoutUpdated.on(this.onLayoutUpdated),this.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated)}teardown(){this.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.smartArt.layoutUpdated.off(this.onLayoutUpdated)}async updateViewModel(){const e=await this.presenterSite.getViewModel();this.viewModel.children=e.children,this.viewModelUpdated.emit()}}class ju{constructor(e){this.transformUpdated=new c,this.onAnchorUpdated=e=>{this.transformUpdated.emit(e)},this.anchor=e,this.anchor.anchorUpdated.on(this.onAnchorUpdated)}get transform(){return this.anchor.transform}teardown(){this.anchor.anchorUpdated.off(this.onAnchorUpdated)}}function Xu(e){return new ju(e.anchor)}class Yu{constructor(){this.containerViewModel=new Pd}async getViewModel(){return this.containerViewModel}}function Ku(){return new Yu}function Zu(e){for(;null!==e.firstChild;)e.removeChild(e.firstChild)}function Ju(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}class Qu{constructor(e,t){this.element=e,this.name=t}set transform(e){this.element.set(this.name,e)}setRotate(e,t=0,i=0,r=2){this.transform=ef(e,t,i,r)}setScale(e,t,i=2){this.transform=tf(e,t,i)}setTranslate(e,t,i=2){this.transform=rf(e,t,i)}set(e,t,i,r,s=2){var n,o;0!==i||t.x||t.y?this.transform=`${rf(r.x,r.y,s)}${ef(i,0,0,s)}${n=t.x,o=t.y,tf(n?-1:1,o?-1:1,0)}${rf(e.x,e.y,s)}`:this.transform=`${rf(r.x+e.x,r.y+e.y,s)}`}}function ef(e,t,i,r){return 0===e?"":0!==t||0!==i?`rotate(${e.toFixed(r)},${t.toFixed(r)},${i.toFixed(r)})`:`rotate(${e.toFixed(r)})`}function tf(e,t,i){return 1===e&&1===t?"":`scale(${e.toFixed(i)},${t.toFixed(i)})`}function rf(e,t,i){return 0===e&&0===t?"":`translate(${e.toFixed(i)},${t.toFixed(i)})`}class sf extends class{constructor(e){this.element=e}get id(){return this.element.id}set id(e){this.element.id=e}get style(){return this.element.style}set(e,t){this.element.setAttribute(e,`${t}`)}appendChild(e){this.element.appendChild(e.element)}}{constructor(e){super(e),this.transform=new Qu(this,"transform")}set opacity(e){this.set("opacity",e)}}class nf extends sf{constructor(e){super(e)}set fill(e){this.set("fill",`${e}`)}set stroke(e){this.set("stroke",`${e}`)}set strokeDasharray(e){this.set("stroke-dasharray",`${e}`)}set strokeDashoffset(e){this.set("stroke-dashoffset",`${e}`)}set strokeLinecap(e){this.set("stroke-linecap",`${e}`)}set strokeLinejoin(e){this.set("stroke-linejoin",`${e}`)}set strokeMiterlimit(e){this.set("stroke-miterlimit",`${e}`)}set strokeWidth(e){this.set("stroke-width",`${e}`)}set shapeRendering(e){this.set("shape-rendering",`${e}`)}}class of extends nf{constructor(e=Ju("rect")){super(e)}set x(e){this.set("x",`${e}`)}set y(e){this.set("y",`${e}`)}set rx(e){this.set("rx",`${e}`)}set ry(e){this.set("ry",`${e}`)}set width(e){this.set("width",`${e}`)}set height(e){this.set("height",`${e}`)}clone(){return new of(this.element.cloneNode())}}function af(e,t,i,r,s,n){const o=Vd("mask");if(o.id=`gc2-crop-${performance.now()}${Math.random()}`,e.forEach((([e,t])=>{if(0===t)return;const i=e.cloneNode();i.setAttribute("fill","white"),o.append(i)})),s){const{size:e,flip:s,rot:a}=t,{width:l,height:h}=e,c=new of;c.width=l*r.x,c.height=h*r.y,c.fill="rgba(255,255,255,0.3)",c.transform.set({x:-l/2-i.x,y:-h/2-i.y},s,a+(null!=n?n:0),{x:0,y:0}),o.prepend(c.element)}return o}function lf(e){const t=[];if(e.forEach((([e,i])=>{switch(i){case 4:case 5:case 2:case 3:const r=e.cloneNode();r.setAttribute("fill",function(e){switch(e){case 4:return"rgba(0,0,0,0.4)";case 5:return"rgba(0,0,0,0.2)";case 2:return"rgba(255,255,255,0.4)";case 3:return"rgba(255,255,255,0.2)";default:(0,xs.t)(e)}}(i)),t.push(r)}})),0===t.length)return;const i=Vd("g");return i.setAttribute("pointer-events","none"),i.append(...t),i}function hf(e,t,i,r){const s=Vd(e);return s.setAttribute("type",t),s.setAttribute("slope",`${i}`),s.setAttribute("intercept",`${r}`),s}let cf={getBoolean:e=>!1,getNumber(e){},getString(e){}},df={info(e,t){},warn(e,t){},error(e,t){}};const uf=[2,1.75,1.5,1.25,1,.5],ff="CaptionsLang",pf="CaptionsLabel",mf={YouTube:["https://(\\w+\\.)?youtube(-nocookie)?\\.[a-zA-Z]{2,3}/(watch|playlist|v|embed)/.*","https://(\\w+\\.)?youtube(-nocookie)?\\.com\\.br/(watch|playlist|v|embed)/.*","https://(\\w+\\.)?youtube(-nocookie)?\\.co\\.uk/(watch|playlist|v|embed)/.*","https://([\\-\\w]+\\.)?youtube(-nocookie)?\\.[a-zA-Z]{2,3}/(watch|playlist)\\?.*","https://([\\-\\w]+\\.)?youtube(-nocookie)?\\.com\\.br/(watch|playlist)\\?.*","https://([\\-\\w]+\\.)?youtube(-nocookie)?\\.co\\.uk/(watch|playlist)\\?.*","https://youtu\\.be/.*","https://youtube(-nocookie)?\\.com/gif.*","https://www\\.youtube(-nocookie)?\\.com/gif.*","https://www\\.youtube(-nocookie)?\\.com/shorts.*"],Vimeo:["https://(\\w+\\.)?(player\\.)?vimeo\\.com/.*"],Flip:["https://(\\w+\\.)?flipgrid\\.com/s/.*","https://(\\w+\\.)?flip\\.com/s/.*","https://(\\w+\\.)?shorts\\.flipgrid\\.com/watch/.*","https://(\\w+\\.)?shorts\\.flip\\.com/watch/.*"],StreamClassic:["https://(\\w+\\.)?microsoftstream\\.com/embed/video/.*","https://(\\w+\\.)?microsoftstream\\.com/video/.*"],Ted:["https://embed\\.ted\\.com/talks/.*","https://www\\.ted\\.com/talks/.*","https://www\\.ted\\.com/index\\.php/talks/.*\\.html.*"],SlideShare:["https://(\\w+\\.)?slideshare\\.net/.*"]},gf="aria-checked",vf="aria-expanded",_f="aria-haspopup",yf="aria-label",bf='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">',wf='<path d="M12.4014 13.2403C13.222 12.83 14.2039 12.9967 14.8536 13.6464C15.0488 13.8417 15.0488 14.1583 14.8535 14.3536C14.6583 14.5488 14.3417 14.5488 14.1464 14.3535C13.7961 14.0032 13.278 13.92 12.8486 14.1347C12.4366 14.3407 12 14.8852 12 16C12 17.1148 12.4366 17.6593 12.8486 17.8653C13.278 18.08 13.7961 17.9967 14.1464 17.6464C14.3417 17.4512 14.6583 17.4512 14.8536 17.6464C15.0488 17.8417 15.0488 18.1583 14.8536 18.3535C14.2039 19.0032 13.222 19.17 12.4014 18.7597C11.5634 18.3407 11 17.3852 11 16C11 14.6149 11.5634 13.6593 12.4014 13.2403ZM20.3536 13.6465C19.7039 12.9968 18.722 12.83 17.9014 13.2403C17.0634 13.6593 16.5 14.6149 16.5 16C16.5 17.3852 17.0634 18.3407 17.9014 18.7597C18.722 19.17 19.7039 19.0033 20.3536 18.3536C20.5488 18.1583 20.5488 17.8417 20.3536 17.6465C20.1583 17.4512 19.8417 17.4512 19.6464 17.6465C19.2961 17.9968 18.778 18.08 18.3486 17.8653C17.9366 17.6593 17.5 17.1148 17.5 16C17.5 14.8852 17.9366 14.3408 18.3486 14.1347C18.778 13.9201 19.2961 14.0033 19.6464 14.3536C19.8417 14.5488 20.1583 14.5488 20.3535 14.3536C20.5488 14.1583 20.5488 13.8417 20.3536 13.6465ZM8 13C8 11.3431 9.34315 10 11 10H21C22.6569 10 24 11.3431 24 13V19C24 20.6569 22.6569 22 21 22H11C9.34315 22 8 20.6569 8 19V13ZM11 11C9.89543 11 9 11.8954 9 13V19C9 20.1046 9.89543 21 11 21H21C22.1046 21 23 20.1046 23 19V13C23 11.8954 22.1046 11 21 11H11Z" fill="white"/>',Tf=`${bf}<path id="volume-low-gfxicon" class="invisible" fill="#FFFFFF" fill-opacity="1.000" d="M17.9971 9.00613C17.9971 8.13311 16.9568 7.67928 16.3168 8.27313L12.4447 11.8665C12.3522 11.9523 12.2307 12 12.1046 12H9.49707C8.66864 12 7.99707 12.6716 7.99707 13.5V18.5C7.99707 19.3284 8.66864 20 9.49707 20H12.1046C12.2307 20 12.3522 20.0477 12.4447 20.1335L16.3168 23.7269C16.9568 24.3207 17.9971 23.8669 17.9971 22.9939V9.00613ZM13.1249 12.5995L16.9971 9.00613V22.9939L13.1249 19.4005C12.8475 19.1431 12.483 19 12.1046 19H9.49707C9.22093 19 8.99707 18.7761 8.99707 18.5V13.5C8.99707 13.2239 9.22093 13 9.49707 13H12.1046C12.483 13 12.8475 12.8569 13.1249 12.5995Z"/><path id="volume-medium-gfxicon" class="invisible" fill="#FFFFFF" fill-opacity="1.000" d="M17.9971 9.00613C17.9971 8.13311 16.9568 7.67928 16.3168 8.27313L12.4447 11.8665C12.3522 11.9523 12.2307 12 12.1046 12H9.49707C8.66864 12 7.99707 12.6716 7.99707 13.5V18.5C7.99707 19.3284 8.66864 20 9.49707 20H12.1046C12.2307 20 12.3522 20.0477 12.4447 20.1335L16.3168 23.7269C16.9568 24.3207 17.9971 23.8669 17.9971 22.9939V9.00613ZM13.1249 12.5995L16.9971 9.00613V22.9939L13.1249 19.4005C12.8475 19.1431 12.483 19 12.1046 19H9.49707C9.22093 19 8.99707 18.7761 8.99707 18.5V13.5C8.99707 13.2239 9.22093 13 9.49707 13H12.1046C12.483 13 12.8475 12.8569 13.1249 12.5995ZM20.0814 18.9332C19.8421 18.7954 19.7599 18.4897 19.8977 18.2504C20.6739 16.9028 20.7294 15.1916 19.897 13.7499C19.759 13.5108 19.8409 13.205 20.08 13.0669C20.3192 12.9288 20.625 13.0108 20.7631 13.2499C21.7811 15.0132 21.7112 17.1054 20.7642 18.7495C20.6264 18.9888 20.3207 19.0711 20.0814 18.9332Z"/><path id="volume-high-gfxicon" class="invisible" fill="#FFFFFF" fill-opacity="1.000" d="M17.9971 9.00613C17.9971 8.13311 16.9568 7.67928 16.3168 8.27313L12.4447 11.8665C12.3522 11.9523 12.2307 12 12.1046 12H9.49707C8.66864 12 7.99707 12.6716 7.99707 13.5V18.5C7.99707 19.3284 8.66864 20 9.49707 20H12.1046C12.2307 20 12.3522 20.0477 12.4447 20.1335L16.3168 23.7269C16.9568 24.3207 17.9971 23.8669 17.9971 22.9939V9.00613ZM13.1249 12.5995L16.9971 9.00613V22.9939L13.1249 19.4005C12.8475 19.1431 12.483 19 12.1046 19H9.49707C9.22093 19 8.99707 18.7761 8.99707 18.5V13.5C8.99707 13.2239 9.22093 13 9.49707 13H12.1046C12.483 13 12.8475 12.8569 13.1249 12.5995ZM22.1422 10.7746C22.3478 10.5903 22.6639 10.6076 22.8482 10.8133C25.5644 13.8449 25.5645 18.449 22.8483 21.4806C22.664 21.6863 22.3479 21.7036 22.1422 21.5194C21.9365 21.3351 21.9192 21.019 22.1035 20.8133C24.4794 18.1615 24.4794 14.1324 22.1034 11.4806C21.9192 11.2749 21.9365 10.9588 22.1422 10.7746ZM20.0814 18.9332C19.8421 18.7954 19.7599 18.4897 19.8977 18.2504C20.6739 16.9028 20.7294 15.1916 19.897 13.7499C19.759 13.5108 19.8409 13.205 20.08 13.0669C20.3192 12.9288 20.625 13.0108 20.7631 13.2499C21.7811 15.0132 21.7112 17.1054 20.7642 18.7495C20.6264 18.9888 20.3207 19.0711 20.0814 18.9332Z"/><path id="volume-muted-gfxicon" class="invisible" fill="#FFFFFF" fill-opacity="1.000" d="M17.9971 9.00613C17.9971 8.13311 16.9568 7.67928 16.3168 8.27313L12.4447 11.8665C12.3522 11.9523 12.2307 12 12.1046 12H9.49707C8.66864 12 7.99707 12.6716 7.99707 13.5V18.5C7.99707 19.3284 8.66864 20 9.49707 20H12.1046C12.2307 20 12.3522 20.0477 12.4447 20.1335L16.3168 23.7269C16.9568 24.3207 17.9971 23.8669 17.9971 22.9939V9.00613ZM13.1249 12.5995L16.9971 9.00613V22.9939L13.1249 19.4005C12.8475 19.1431 12.483 19 12.1046 19H9.49707C9.22093 19 8.99707 18.7761 8.99707 18.5V13.5C8.99707 13.2239 9.22093 13 9.49707 13H12.1046C12.483 13 12.8475 12.8569 13.1249 12.5995ZM20.029 14.1665C20.2243 13.9712 20.5409 13.9712 20.7361 14.1665L22.3826 15.8129L24.029 14.1665C24.2243 13.9712 24.5409 13.9712 24.7361 14.1665C24.9314 14.3617 24.9314 14.6783 24.7361 14.8736L23.0897 16.52L24.7361 18.1665C24.9314 18.3617 24.9314 18.6783 24.7361 18.8736C24.5409 19.0688 24.2243 19.0688 24.029 18.8736L22.3826 17.2271L20.7361 18.8736C20.5409 19.0688 20.2243 19.0688 20.029 18.8736C19.8338 18.6783 19.8338 18.3617 20.029 18.1665L21.6755 16.52L20.029 14.8736C19.8338 14.6783 19.8338 14.3617 20.029 14.1665Z"/></svg>`,xf=`${bf}<path id="play-gfxicon" class="invisible" fill="#FFFFFF" fill-opacity="1.000" d="M24.1059 15.0879C25.1413 15.6575 25.1413 17.1443 24.1059 17.7139L14.1089 23.2129C13.1092 23.7628 11.8855 23.0402 11.8855 21.9L11.8855 10.9018C11.8855 9.76156 13.1092 9.03893 14.1089 9.58883L24.1059 15.0879ZM23.6236 16.8385C23.9688 16.6487 23.9688 16.1531 23.6236 15.9632L13.6266 10.4641C13.2934 10.2808 12.8855 10.5217 12.8855 10.9018L12.8855 21.9C12.8855 22.28 13.2934 22.5209 13.6266 22.3376L23.6236 16.8385Z"/><path  id="pause-gfxicon" fill="#FFFFFF" fill-opacity="1.000" d="M11.8855 8.77393C10.7809 8.77393 9.8855 9.66936 9.8855 10.7739V22.7739C9.8855 23.8785 10.7809 24.7739 11.8855 24.7739H13.8855C14.9901 24.7739 15.8855 23.8785 15.8855 22.7739V10.7739C15.8855 9.66936 14.9901 8.77393 13.8855 8.77393H11.8855ZM10.8855 10.7739C10.8855 10.2216 11.3332 9.77393 11.8855 9.77393H13.8855C14.4378 9.77393 14.8855 10.2216 14.8855 10.7739V22.7739C14.8855 23.3262 14.4378 23.7739 13.8855 23.7739H11.8855C11.3332 23.7739 10.8855 23.3262 10.8855 22.7739V10.7739ZM19.8855 8.77393C18.7809 8.77393 17.8855 9.66936 17.8855 10.7739V22.7739C17.8855 23.8785 18.7809 24.7739 19.8855 24.7739H21.8855C22.9901 24.7739 23.8855 23.8785 23.8855 22.7739V10.7739C23.8855 9.66936 22.9901 8.77393 21.8855 8.77393H19.8855ZM18.8855 10.7739C18.8855 10.2216 19.3332 9.77393 19.8855 9.77393H21.8855C22.4378 9.77393 22.8855 10.2216 22.8855 10.7739V22.7739C22.8855 23.3262 22.4378 23.7739 21.8855 23.7739H19.8855C19.3332 23.7739 18.8855 23.3262 18.8855 22.7739V10.7739Z"/></svg>`,Cf=`${bf}${wf}</svg>`,Pf=`${bf}${wf}<rect y="31.885" width="2" height="32" transform="rotate(-90 0 31.885)" fill="white"/></svg>`,Sf=`${bf}<path id="fullscreen-enter-gfxicon" d="M9.8855 11.8931C9.8855 10.7885 10.7809 9.89307 11.8855 9.89307H13.8855C14.1616 9.89307 14.3855 10.1169 14.3855 10.3931C14.3855 10.6692 14.1616 10.8931 13.8855 10.8931H11.8855C11.3332 10.8931 10.8855 11.3408 10.8855 11.8931V13.8931C10.8855 14.1692 10.6616 14.3931 10.3855 14.3931C10.1094 14.3931 9.8855 14.1692 9.8855 13.8931V11.8931ZM19.3855 10.3931C19.3855 10.1169 19.6094 9.89307 19.8855 9.89307H21.8855C22.9901 9.89307 23.8855 10.7885 23.8855 11.8931V13.8931C23.8855 14.1692 23.6616 14.3931 23.3855 14.3931C23.1094 14.3931 22.8855 14.1692 22.8855 13.8931V11.8931C22.8855 11.3408 22.4378 10.8931 21.8855 10.8931H19.8855C19.6094 10.8931 19.3855 10.6692 19.3855 10.3931ZM10.3855 19.3931C10.6616 19.3931 10.8855 19.6169 10.8855 19.8931V21.8931C10.8855 22.4454 11.3332 22.8931 11.8855 22.8931H13.8855C14.1616 22.8931 14.3855 23.1169 14.3855 23.3931C14.3855 23.6692 14.1616 23.8931 13.8855 23.8931H11.8855C10.7809 23.8931 9.8855 22.9976 9.8855 21.8931V19.8931C9.8855 19.6169 10.1094 19.3931 10.3855 19.3931ZM23.3855 19.3931C23.6616 19.3931 23.8855 19.6169 23.8855 19.8931V21.8931C23.8855 22.9976 22.9901 23.8931 21.8855 23.8931H19.8855C19.6094 23.8931 19.3855 23.6692 19.3855 23.3931C19.3855 23.1169 19.6094 22.8931 19.8855 22.8931H21.8855C22.4378 22.8931 22.8855 22.4454 22.8855 21.8931V19.8931C22.8855 19.6169 23.1094 19.3931 23.3855 19.3931Z" fill="white"/><path id="fullscreen-exit-gfxicon" d="M20.8855 11.2661C20.8855 11.8184 21.3332 12.2661 21.8855 12.2661L23.8855 12.2661C24.1616 12.2661 24.3855 12.49 24.3855 12.7661C24.3855 13.0423 24.1616 13.2661 23.8855 13.2661H21.8855C20.7809 13.2661 19.8855 12.3707 19.8855 11.2661V9.26611C19.8855 8.98997 20.1094 8.76611 20.3855 8.76611C20.6616 8.76611 20.8855 8.98997 20.8855 9.26611V11.2661ZM12.8855 21.2661C12.8855 20.7138 12.4378 20.2661 11.8855 20.2661H9.8855C9.60936 20.2661 9.3855 20.0423 9.3855 19.7661C9.3855 19.49 9.60936 19.2661 9.8855 19.2661H11.8855C12.9901 19.2661 13.8855 20.1615 13.8855 21.2661V23.2661C13.8855 23.5423 13.6616 23.7661 13.3855 23.7661C13.1094 23.7661 12.8855 23.5423 12.8855 23.2661V21.2661ZM20.8855 21.2661C20.8855 20.7138 21.3332 20.2661 21.8855 20.2661H23.8855C24.1616 20.2661 24.3855 20.0423 24.3855 19.7661C24.3855 19.49 24.1616 19.2661 23.8855 19.2661H21.8855C20.7809 19.2661 19.8855 20.1615 19.8855 21.2661V23.2661C19.8855 23.5423 20.1094 23.7661 20.3855 23.7661C20.6616 23.7661 20.8855 23.5423 20.8855 23.2661V21.2661ZM11.8855 12.2661C12.4378 12.2661 12.8855 11.8184 12.8855 11.2661L12.8855 9.26611C12.8855 8.98997 13.1094 8.76611 13.3855 8.76611C13.6616 8.76611 13.8855 8.98997 13.8855 9.26611V11.2661C13.8855 12.3707 12.9901 13.2661 11.8855 13.2661H9.8855C9.60936 13.2661 9.3855 13.0423 9.3855 12.7661C9.3855 12.49 9.60936 12.2661 9.8855 12.2661L11.8855 12.2661Z" fill="white"/></svg>`;function Ef(e){let t="";switch(e){case"play-pause-gfxicon":t=xf;break;case"volume-gfxicon":t=Tf;break;case"captions-gfxicon":t=Cf;break;case"captions-active-gfxicon":t=Pf;break;case"checkmark-gfxicon":t='<svg width="14" height="10" viewBox="0 0 14 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.3516 1.35156L5 9.71094L0.648438 5.35156L1.35156 4.64844L5 8.28906L12.6484 0.648438L13.3516 1.35156Z" fill="white"/></svg>';break;case"fullscreen-gfxicon":t=Sf}const i=(new DOMParser).parseFromString(t,"image/svg+xml"),r=document.importNode(i.documentElement,!0);return r.classList.add(e),r.setAttribute("aria-hidden","true"),r}const Mf=new Map([["ar","العربية"],["ar-sa","العربية"],["bn","বাংলা"],["bn-bd","বাংলা"],["bn-in","বাংলা"],["cs","Česky"],["cs-cz","Česky"],["da","Dansk"],["da-dk","Dansk"],["de","Deutsch"],["de-at","Deutsch"],["de-ch","Deutsch"],["de-de","Deutsch"],["el","Ελληνικά"],["el-gr","Ελληνικά"],["en","English"],["en-au","English"],["en-ca","English"],["en-gb","English"],["en-ie","English"],["en-in","English"],["en-nz","English"],["en-us","English"],["en-za","English"],["es","Español"],["es-ar","Español"],["es-cl","Español"],["es-co","Español"],["es-es","Español"],["es-mx","Español"],["es-us","Español"],["fi","Suomi"],["fi-fi","Suomi"],["fr","Français"],["fr-be","Français"],["fr-ca","Français"],["fr-ch","Français"],["fr-fr","Français"],["he","עברית"],["he-il","עברית"],["hi","हिन्दी"],["hi-in","हिन्दी"],["hu","Magyar"],["hu-hu","Magyar"],["id","Bahasa Indonesia"],["id-id","Bahasa Indonesia"],["it","Italiano"],["it-ch","Italiano"],["it-it","Italiano"],["ja","日本語"],["jp","日本語"],["jp-jp","日本語"],["ko","한국어"],["ko-kr","한국어"],["nl","Nederlands"],["nl-be","Nederlands"],["nl-nl","Nederlands"],["no","Norsk (bokmål / riksmål)"],["no-no","Norsk (bokmål / riksmål)"],["pl","Polski"],["pl-pl","Polski"],["pt","Português"],["pt-br","Português"],["pt-pt","Português"],["ro","Română"],["ro-ro","Română"],["ru","Русский"],["ru-ru","Русский"],["sk","Slovenčina"],["sk-sk","Slovenčina"],["sv","Svenska"],["sv-se","Svenska"],["ta","தமிழ்"],["ta-in","தமிழ்"],["ta-lk","தமிழ்"],["th","ไทย / Phasa Thai"],["th-yh","ไทย / Phasa Thai"],["tr","Türkçe"],["tr-tr","Türkçe"],["zh","中文"],["zh-cn","中文 (简体)"],["zh-hans","中文 (简体)"],["zh-hant","中文 (繁體)"],["zh-hk","中文 (繁體)"],["zh-tw","中文 (繁體)"],["unknown","Unknown"]]);function Rf(e){const t=Mf.get(e.toLowerCase());return void 0===t?e:t}function Bf(e,t){return null!==e&&null!==t&&e.toLowerCase().startsWith(t.toLowerCase())&&e.length>t.length&&"-"===e.charAt(t.length)}function If(){return window.matchMedia("screen and (forced-colors: active)").matches}function Af(e,t,i){let r;try{r=JSON.stringify({value:t,expiration:i.toISOString()})}catch(e){return}window.localStorage.setItem(e,r)}function Ff(e){const t=localStorage.getItem(e);if(null===t)return null;let i;try{i=JSON.parse(t)}catch(t){return localStorage.removeItem(e),null}return!Number.isInteger(i.expiration)&&Number.isNaN(Date.parse(i.expiration))||new Date(i.expiration)<=new Date?(localStorage.removeItem(e),null):i.value}const kf=["B","I","U"];function Df(e){for(const t of e.childNodes)if(t.nodeType===Node.ELEMENT_NODE){Df(t);const e=t;kf.indexOf(t.nodeName.toUpperCase())>=0?[...e.attributes].forEach((t=>e.removeAttribute(t.name))):e.replaceWith(...e.childNodes)}}function Lf(e,t){const i=new DOMParser;t.replaceChildren(i.parseFromString(e,"text/html").body),Df(t)}function Of(e,t){Object.assign(e.style,t)}class Uf{constructor(e,t){this.visibleOpacity=".8",this.reducedOpacity=".1",this.updateDelay=.1,this.minCueMargin=.5,this.textTimeout=5,this.boxHeight=94,this.maxCharacterWidth=400,this.fontSize=24,this.lastUpdate=0,this.activeTextTrackIndex=0,this.activeCueIndex=0,this.currentOpacity=this.visibleOpacity,this.defaultLang="",this.activeCues=[],this.onResize=()=>{var e;setTimeout((()=>{this.setHorizontalPosition(void 0),this.setVerticalPosition(!0)}),0),1===(null===(e=this.activeControls)||void 0===e?void 0:e.getPositioningStrategy)&&this.resetHorizontalPosition()},this.onPlay=()=>{},this.onSeeked=()=>{this.setInitialCue()},this.onTimeUpdate=()=>{if(0===this.activeCues.length&&this.cloneCues(),void 0!==this.activeControls&&this.updateContainer(this.activeControls.getZIndex()-1),void 0===this.activeVideoEl||this.activeVideoEl.paused||this.visible()||this.show(),-2===this.activeCueIndex||!this.visible()||0===this.activeCues.length||void 0===this.activeVideoEl||this.activeVideoEl.paused)return;if(this.activeVideoEl.currentTime-this.lastUpdate<this.updateDelay)return;this.lastUpdate=this.activeVideoEl.currentTime;const e=this.activeCueIndex+1>=this.activeCues.length;this.activeCueIndex>=0&&(this.activeCues[this.activeCueIndex].endTime<=this.activeVideoEl.currentTime||this.activeVideoEl.currentTime-this.activeCues[this.activeCueIndex].startTime>=this.textTimeout)&&(this.clearText(),e&&(this.activeCueIndex=-2)),e||this.activeCues[this.activeCueIndex+1].startTime<=this.activeVideoEl.currentTime&&(this.activeCueIndex+=1,this.setTextById(this.activeCueIndex))},this.container=sp("div","captions-render-container"),this.container.id="video-captions-render-window",this.hide(),Of(this.container,{alignSelf:"center",background:"solid",backgroundColor:"#292827",borderRadius:"2px",fontFamily:'"Segoe UI", "Segoe UI Web (West European)", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serif',fontSize:`${this.fontSize}px`,color:"#F3F2F1",padding:"6px",pointerEvents:"none",position:"absolute",opacity:"0",overflow:"hidden",overflowWrap:"break-word",textAlign:"center",webkitLineClamp:"3",fontSizeAdjust:"100%"}),this.screenCoords=t,this.screenCoordsProvided=null!=t,this.parentName=e,""===this.parentName&&df.warn(509726802,"CaptionsRenderer constructor: parentName is empty")}get getDefaultLang(){return this.defaultLang}set setDefaultLang(e){this.defaultLang=e}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}visible(){return"block"===this.container.style.display}onNavigatingFrom(){this.stopCaptionTrack()}setScreenCoords(e){this.screenCoords=e,this.screenCoordsProvided=null!=e}renderCaptionTrack(e,t,i){Of(this.container,{fontSize:this.fontSize*t.getCaptionsScalingFactor()+"px"}),void 0!==this.activeVideoEl&&void 0!==this.activeControls&&this.activeVideoEl.id!==e.id&&(this.activeControls.disableCaptionsInPlayer(),this.stopRendering(),this.screenCoordsProvided||(this.screenCoords=e)),this.activeVideoEl=e,this.activeControls=t,this.activeTextTrackIndex=i,this.activeCues=[],this.cloneCues(),this.activeVideoEl.addEventListener("timeupdate",this.onTimeUpdate),this.activeVideoEl.addEventListener("seeked",this.onSeeked),this.activeVideoEl.addEventListener("play",this.onPlay),df.info(508155723,JSON.stringify({Description:"CaptionsRenderer.renderCaptionTrack: Info",Font:this.container.style.font,FontOpticalSizing:this.container.style.fontOpticalSizing,FontSize:this.container.style.fontSize,FontSizeAdjust:this.container.style.fontSizeAdjust,FontStretch:this.container.style.fontStretch,Height:this.container.style.height,Scale:this.container.style.scale})),this.startRendering()}stopCaptionTrack(){var e;0!==(null===(e=this.activeControls)||void 0===e?void 0:e.getCaptionSelection)&&(void 0!==this.activeVideoEl&&(this.activeVideoEl.removeEventListener("timeupdate",this.onTimeUpdate),this.activeVideoEl.removeEventListener("seeked",this.onSeeked),this.activeVideoEl.removeEventListener("play",this.onPlay)),this.stopRendering())}updateContainer(e){null===this.container.parentElement&&this.setParent(),this.setZIndex(e)}reduceOpacity(){this.currentOpacity=this.reducedOpacity,this.container.style.opacity=this.currentOpacity}resetOpacity(){this.currentOpacity=this.visibleOpacity,this.container.style.opacity=this.currentOpacity}setHorizontalPosition(e){if(null===this.container.parentElement)return void df.warn(508954693,"CaptionsRenderer.setHorizontalPosition: Parent element is null");if(null===this.screenCoords.parentElement)return void df.warn(508954692,"CaptionsRenderer.setHorizontalPosition: screenCoords parent element is null");const t=this.screenCoords.getBoundingClientRect().width,i=Math.min(.6*t,this.maxCharacterWidth),r=.5*(this.container.parentElement.getBoundingClientRect().width-i);if(this.container.style.left=`${r}px`,this.container.style.right=`${r}px`,void 0!==e&&void 0!==this.activeControls&&this.activeControls.isVisible()&&void 0!==e&&this.boxIntersects(e)){const i=t/2<(e.left+e.right)/2;this.container.style.transform=i?`translateX(-${this.maxCharacterWidth}px)`:`translateX(${this.maxCharacterWidth}px)`,df.info(508954691,"CaptionsRenderer.setHorizontalPosition: Box overlaps controls, adjusting position: "+(i?"left":"right"))}}resetHorizontalPosition(){var e;1===(null===(e=this.activeControls)||void 0===e?void 0:e.getPositioningStrategy)&&(this.container.style.transform="")}setVerticalPosition(e){if(null===this.container.parentElement)return void df.warn(510252311,"CaptionsRenderer.setVerticalPosition: Parent element is null");if(null===this.screenCoords.parentElement)return void df.warn(509691528,"CaptionsRenderer.setVerticalPosition: screenCoords parent element is null");if(void 0===this.activeControls)return;if(!e&&1===this.activeControls.getPositioningStrategy&&!this.activeControls.isVisible())return;const t=.6*rp(this.screenCoords.style.width);this.container.style.maxWidth=`${Math.min(t,this.maxCharacterWidth)}px`,this.container.style.maxHeight=`${this.boxHeight}px`;const i=this.screenCoords.getBoundingClientRect(),r=i.height,s=.04*r,n=this.container.parentElement.getBoundingClientRect().bottom,o=n-i.bottom+s,a=n-this.activeControls.getBounds.top+s;df.info(510252309,`CaptionsRenderer.setVerticalPosition: Current bottom: ${this.container.style.bottom}, new bottom: ${o}, pageHeight: ${r}, boxHeight: ${this.boxHeight}, bottomOffset: ${s}, maxBoxWidth: ${t}, maxCharacterWidth: ${this.maxCharacterWidth}`),this.container.style.bottom=`${o}px`,2!==this.activeControls.getPositioningStrategy&&3!==this.activeControls.getPositioningStrategy&&this.boxIntersects(this.activeControls.getBounds)&&(this.container.style.bottom=`${a}px`,df.info(509691529,`CaptionsRenderer.setVerticalPosition: Box overlaps main controls, adjusting position upwards - old bottom: ${this.container.style.bottom}, new bottom: ${this.container.style.bottom} controls top: ${this.activeControls.getBounds.top}`))}boxIntersects(e){if(void 0===this.activeControls)return!1;const t=this.container.getBoundingClientRect(),i=t.right-t.left,r=rp(this.container.style.maxWidth)/2-i/2,s=t.left-r,n=t.right+r,o=t.bottom,a=o-this.boxHeight;return!(e.right<s||e.left>n||e.bottom<a||e.top>o)}cloneCues(){var e;const t=null===(e=this.activeVideoEl)||void 0===e?void 0:e.textTracks[this.activeTextTrackIndex].cues;if(null!=t){const e=[];for(const i of t)e.push(new VTTCue(i.startTime,i.endTime,i.text));this.activeCues=e,this.setInitialCue()}}setParent(){const e=document.getElementById(this.parentName);null!==e?(this.container.addEventListener("resize",this.onResize),e.appendChild(this.container)):df.warn(510252312,`CaptionsRenderer.setParent: Parent was null, parentName: ${this.parentName}`)}setZIndex(e){this.container.style.zIndex=`${e}`}setInitialCue(){if(0!==this.activeCues.length){this.lastUpdate=0,this.clearText();for(let e=0;e<this.activeCues.length;e+=1){const t=this.activeCues[e];if(void 0===this.activeVideoEl)return;if(t.startTime>this.activeVideoEl.currentTime)return void(e>0?this.setTextById(e-1):this.activeCueIndex=-1);if(this.activeCueIndex=e,this.activeVideoEl.currentTime-t.startTime<=this.minCueMargin)return void this.setText(t.text)}}else this.activeCueIndex=0}startRendering(){this.visible()||void 0===this.activeVideoEl||this.activeVideoEl.paused||this.show(),this.setHorizontalPosition(void 0),this.setVerticalPosition(!0),0!==this.activeCues.length?this.setInitialCue():df.warn(509670627,"CaptionsRenderer.startRendering: activeCues is empty")}stopRendering(){this.visible()&&this.hide(),this.clearText()}clearText(){this.container.style.opacity="0",this.container.textContent=""}setText(e){this.container.style.opacity=this.currentOpacity,Lf(e,this.container)}setTextById(e){if(0===this.activeCues.length)return void(this.container.textContent="");const t=this.activeCues[e];void 0!==t?(this.container.style.opacity=this.currentOpacity,Lf(t.text,this.container)):this.container.textContent=""}}function Vf(e){return e/1e3}function Nf(e){const t=Math.floor(e/3600),i=Math.floor((e-3600*t)/60);return[t,i,Math.floor(e-3600*t-60*i)]}function Gf(e){const[t,i,r]=Nf(e);return t>0?`${t}:${i<10?"0":""}${i}:${i<10?"0":""}${r}`:`${i}:${r<10?"0":""}${r}`}function zf(e,t){const[i,r,s]=Nf(e);return t.localizedTimeStr.replace("{0}",`${i>0?i.toFixed(0):""}`).replace("{1}",`${i>0?(a=i,1===a?t.localizedLabelsStr[0]:t.localizedLabelsStr[1]):""}`).replace("{2}",`${r>0?r.toFixed(0):""}`).replace("{3}",`${r>0?(o=r,1===o?t.localizedLabelsStr[2]:t.localizedLabelsStr[3]):""}`).replace("{4}",(n=s,0===e?"0":n>0?n.toFixed(0):"")).replace("{5}",(i=>e>0&&0===i?"":1===i?t.localizedLabelsStr[4]:t.localizedLabelsStr[5])(s));var n,o,a}const Hf="visible";function Wf(e){e.classList.add(Hf)}function $f(e){e.classList.remove(Hf)}const qf="invisible";function jf(e){return e.classList.contains(qf)}function Xf(e){e.classList.add(qf)}function Yf(e){e.classList.remove(qf)}function Kf(e){e.classList.toggle(qf)}function Zf(e,t){void 0!==e&&(e.style.display=t)}function Jf(e,t){void 0!==t&&e.appendChild(t)}class Qf{constructor(e,t,i,r,s,n,o,a,l){this.leftControls=e,this.rightControls=t,this.progressBar=i,this.timeContainer=r,this.volumeContainer=s,this.volumeSliderContainer=n,this.speedButton=o,this.captionsButton=a,this.fullscreenButton=l;let h=0;for(const e of[this.speedButton,this.captionsButton,this.fullscreenButton])void 0!==e&&(h+=32);const c=166+h;this.breakPoints=[c],this.breakPoints.push(c-86);for(const e of[this.speedButton,this.captionsButton,this.fullscreenButton])void 0!==e&&this.breakPoints.push(this.breakPoints[this.breakPoints.length-1]-32)}onHeightChanged(e){if(void 0===this.volumeSliderContainer)return;const t=e>=165;this.volumeSliderFitsInVideoRect!==t&&(t?this.volumeContainer.appendChild(this.volumeSliderContainer):this.volumeSliderContainer.remove(),this.volumeSliderFitsInVideoRect=t)}onWidthChanged(e){if(0===e)return;let t=0;for(;t<this.breakPoints.length&&!(e>=this.breakPoints[t]);)t++;if(this.breakPointsIdx===t)return;let i=!0,r=!0,s=!0,n=void 0!==this.captionsButton,o=void 0!==this.speedButton,a=void 0!==this.fullscreenButton,l=!1;switch(t){case this.breakPoints.length:case 5:i=!1,r=!1,s=!1,n=!1,o=!1,a=!1,l=!0;break;case 4:i=!1,s=!1,n=!1,o=!1,a=!1,l=!0;break;case 3:i=!1,s=!1;for(let e=0;e<2;e+=1)o?o=!1:a?a=!1:n&&(n=!1);l=!0;break;case 2:i=!1,s=!1,o?o=!1:a?a=!1:n&&(n=!1),l=!0;break;case 1:i=!1,s=!1}this.organize(i,s,r,o,n,a,l),this.breakPointsIdx=t}organize(e,t,i,r,s,n,o){Zf(this.progressBar,e?"":"none"),Zf(this.timeContainer,t?"":"none"),Zf(this.volumeContainer,i?"":"none"),Zf(this.speedButton,r?"":"none"),Zf(this.captionsButton,s?"":"none"),Zf(this.fullscreenButton,n?"":"none"),o?(Jf(this.leftControls,this.speedButton),Jf(this.leftControls,this.captionsButton),Jf(this.leftControls,this.fullscreenButton),this.leftControls.style.width="100%",this.leftControls.style.justifyContent="space-between"):(Jf(this.rightControls,this.speedButton),Jf(this.rightControls,this.captionsButton),Jf(this.rightControls,this.fullscreenButton),this.leftControls.style.width="",this.leftControls.style.justifyContent="")}}class ep{constructor(e,t,i){this.presenter=e,this.attendee=t,this.noRole=i}}function tp(e,t,i){e.style.background=If()?`linear-gradient(to right, Highlight ${t}%, ButtonText ${t}% ${i}%, ButtonFace ${i}% 100%`:`linear-gradient(to right, #FFFFFF ${t}%, #FFFFFFB2 ${t}% ${i}%, #FFFFFF59 ${i}% 100%`}function ip(e,t){e.style.background=If()?`linear-gradient(to right, Highlight ${t}%, ButtonFace ${t}% 100%`:`linear-gradient(to right, #FFFFFF ${t}%, #FFFFFF59 ${t}% 100%`}function rp(e){return Number(e.replace(/px$/,""))}function sp(e,t){const i=document.createElement(e);return i.classList.add(t),i}class np{constructor(e,t,i){this.captionsMinUIDelay=250,this.captionsButtonVisible=!1,this.captionsButtonEnabled=!1,this.captionsPlaybackInPlayer=!1,this.captionsMenuShown=!1,this.captionsScaleFactor=1,this.positioningStrategy=0,this.volumeSliderEnabled=!0,this.speedButtonEnabled=!1,this.fullscreenButtonEnabled=!1,this.nestedTabbingEnabled=!1,this.textTracks=[],this.captionSelection=0,this.captionFocus=0,this.speedSelection=0,this.speedFocus=0,this.lastToggleTime=0,this.defaultCaptionsTrackSet=!1,this.defaultSpeedSet=!1,this.isFullscreenMode=!1,this.lastScrollTime=Date.now(),this.refreshControls=()=>{this.mediaInfo=this.getMediaInfo(),this.progressBar.max=`${this.mediaInfo.max}`,this.setProgressForScreenReader();const e=Vf(this.mediaInfo.trimStartMs);tp(this.progressBar,(this.progressBar.valueAsNumber-e)/(this.mediaInfo.max-e)*100,(this.getBufferedSec()-e)/(this.mediaInfo.max-e)*100),this.updateTimeControl()},this.dispose=()=>{void 0!==this.videoElement&&null!==this.videoElement&&(this.videoElement.removeEventListener("fullscreenchange",this.onFullScreenChange),this.videoElement.removeEventListener("play",this.onPlay),this.videoElement.removeEventListener("timeupdate",this.onTimeUpdate),this.videoElement.removeEventListener("loadedmetadata",this.refreshControls),this.videoElement.removeEventListener("canplay",this.refreshControls),null!==this.videoElement.textTracks&&void 0!==this.videoElement.textTracks&&this.videoElement.textTracks.removeEventListener("change",this.hideCaptionsInPlayer),this.videoElement.removeEventListener("play",this.togglePlayPauseIcon),this.videoElement.removeEventListener("pause",this.togglePlayPauseIcon),this.videoElement.removeEventListener("keydown",this.onVideoKeyDown),this.videoElement.removeEventListener("volumechange",this.onVideoVolumeChange)),void 0!==this.container&&null!==this.container&&this.container.remove()},this.togglePlayPauseIcon=()=>{this.setPlayPauseIcon(!this.videoElement.paused)},this.onVideoKeyDown=e=>{this.handleCaptionsKeyboardEvent(e)},this.onVideoVolumeChange=()=>{const e=this.videoElement.muted?0:this.videoElement.volume;this.setVolumeIcon(e,this.videoElement.muted||0===this.videoElement.volume),this.volumeSliderEnabled&&(this.volumeSlider.value=""+100*e,ip(this.volumeSlider,this.volumeSlider.valueAsNumber))},this.onTimeUpdate=()=>{this.videoElement.currentTime<=this.mediaInfo.max?cf.getBoolean("CorrectTrimmedVideoTimeControlDuration")&&this.mediaInfo.trimStartMs>0?this.currentTime.innerText=Gf(Math.max(0,this.videoElement.currentTime-Vf(this.mediaInfo.trimStartMs))):this.currentTime.innerText=Gf(this.videoElement.currentTime):(cf.getBoolean("CorrectTrimmedVideoTimeControlDuration")&&this.mediaInfo.max>0&&this.currentTime.innerText!==this.formattedEndTime&&(this.currentTime.innerText=this.formattedEndTime),this.setPlayPauseIcon(!1));const e=Vf(this.mediaInfo.trimStartMs);this.progressBar.value=`${this.videoElement.currentTime}`,tp(this.progressBar,(this.progressBar.valueAsNumber-e)/(this.mediaInfo.max-e)*100,(this.getBufferedSec()-e)/(this.mediaInfo.max-e)*100)},this.onPlay=()=>{this.setDefaultCaptionTrack()},this.hideCaptionsInPlayer=()=>{if(!this.captionsPlaybackInPlayer)for(const e of this.videoElement.textTracks)"showing"===e.mode&&(e.mode="hidden")},this.onFullScreenChange=()=>{if(!this.captionsButtonEnabled||void 0!==this.mediaControlInfo.transferCaptionsFullScreen&&!this.mediaControlInfo.transferCaptionsFullScreen)return;const e=document.fullscreenElement===this.videoElement;this.videoElement.controls=e,e?this.transferCaptionsToPlayer():(this.transferCaptionsToRenderer(),this.setPlaybackSpeedFromElement())},this.videoElement=e,this.mediaControlInfo=t,this.mediaCallbacks=i,this.zIndex=t.zIndex,this.mediaInfo=this.getMediaInfo(),void 0!==t.playPauseOnly&&t.playPauseOnly?(df.info(509109908,"PlaybackControls: Creating only play and pause controls"),this.createControlsPlayPause()):this.createControls(),this.focusableElements=[this.progressBar,this.playButton,this.volumeButton,this.volumeSlider,this.captionsButton,this.speedButton,this.fullscreenButton],isNaN(this.videoElement.duration)&&(df.warn(541882010,"PlaybackControls: Video duration not set."),void 0!==this.mediaCallbacks&&this.mediaCallbacks.logVetoCallback("IncorrectProgressAndTiming"))}get getCaptionSelection(){return this.captionSelection}get getPositioningStrategy(){return this.positioningStrategy}get getBounds(){return this.container.getBoundingClientRect()}isFullScreen(){return this.isFullscreenMode}isVisible(){return"flex"===this.container.style.display}getCaptionsScalingFactor(){return this.captionsScaleFactor}show(){this.container.style.display="flex",this.fixCaptionsOverlap(this.getBounds)}hide(){this.updatePopOuts(),this.container.style.display="none",this.resetCaptionsOverlap()}onKeyDown(e){if(this.nestedTabbingEnabled&&void 0!==e){if("ArrowRight"===e.key&&("none"===this.progressBar.style.display?this.playButton.focus():this.progressBar.focus()),"ArrowLeft"===e.key)for(let e=this.focusableElements.length-1;e>=0;e--){const t=this.focusableElements[e];if((t!==this.captionsButton||this.captionsButtonEnabled)&&(t!==this.volumeButton||"none"!==this.volumeContainer.style.display)&&void 0!==t&&"none"!==t.style.display&&this.container.contains(t)){t.focus();break}}e.stopPropagation()}}setParent(e){try{null===e.shadowRoot?this.root=e.attachShadow({mode:"open"}):this.root=e.shadowRoot,this.root.appendChild(this.container),this.addCssRef(this.root),this.setPlayPauseIcon(!this.videoElement.paused),void 0!==this.captionsRenderer&&(this.captionsRenderer.updateContainer(this.zIndex-1),this.defaultCaptionsTrackSet=!1,this.setDefaultCaptionTrack()),void 0!==this.currentTimeContainer&&(this.controlsOrganizer=new Qf(this.leftControls,this.rightControls,this.progressBar,this.currentTimeContainer,this.volumeContainer,this.volumeSliderContainer,this.speedButton,this.captionsButton,this.fullscreenButton),this.resizeObserver=new ResizeObserver((e=>{var t,i;for(const r of e){const e=r.contentRect;null===(t=this.controlsOrganizer)||void 0===t||t.onWidthChanged(e.width),null===(i=this.controlsOrganizer)||void 0===i||i.onHeightChanged(e.height)}})),this.container.style.justifyContent="flex-end",this.resizeObserver.observe(e))}catch(e){df.error(526485603,`Exception in setParent: ${e.message}`)}}enableCaptionTrack(e,t){void 0!==this.captionsRenderer&&(e<0||void 0===this.captionsMenu||e>=this.captionsMenu.children.length-1||(this.captionSelection=e,this.captionsMenu.children[e].setAttribute(gf,"true"),0===e?(this.hideCaptionsUnderlineIcon(),this.captionsPlaybackInPlayer?t&&this.disableCaptionsInPlayer():this.captionsRenderer.stopCaptionTrack()):("hidden"!==this.videoElement.textTracks[e-1].mode&&(this.videoElement.textTracks[e-1].mode="hidden"),this.showCaptionsUnderlineIcon(),this.captionsPlaybackInPlayer?(this.videoElement.textTracks[e-1].mode="showing",this.captionsPlaybackInPlayer=!1):(this.captionsRenderer.renderCaptionTrack(this.videoElement,this,e-1),2!==this.positioningStrategy&&3!==this.positioningStrategy||!this.isVisible()||this.fixCaptionsOverlap(this.getBounds)))))}disableCaptionsInPlayer(){this.captionsPlaybackInPlayer=!1;for(let e=0;e<this.videoElement.textTracks.length;e+=1)if("showing"===this.videoElement.textTracks[e].mode)return this.videoElement.textTracks[e].mode="hidden",e}getZIndex(){return this.zIndex}focusPlayButton(){this.isVisible()||this.show(),this.playButton.focus()}toggleCaptionsMenu(e){this.isVisible()||this.show(),this.captionsButtonEnabled?this.toggleCaptionsMenuInternal(e):this.focusPlayButton()}onProgressSliderInput(){if(this.videoElement.currentTime!==this.progressBar.valueAsNumber){void 0!==this.mediaCallbacks?this.mediaCallbacks.seekMediaCallback(this.progressBar.valueAsNumber):this.videoElement.currentTime=this.progressBar.valueAsNumber,this.progressBar.value=`${this.videoElement.currentTime}`,this.setProgressForScreenReader();const e=Vf(this.mediaInfo.trimStartMs);tp(this.progressBar,(this.progressBar.valueAsNumber-e)/(this.mediaInfo.max-e)*100,(this.getBufferedSec()-e)/(this.mediaInfo.max-e)*100)}}onVolumeSliderInput(){this.videoElement.volume=this.volumeSlider.valueAsNumber/100,this.videoElement.volume>0&&this.videoElement.muted&&(this.videoElement.muted=!1),ip(this.volumeSlider,this.volumeSlider.valueAsNumber),void 0!==this.mediaCallbacks&&this.mediaCallbacks.volumeChangedCallback()}onVolumeClick(){this.videoElement.muted=!this.videoElement.muted;const e=this.videoElement.muted,t=e?0:this.videoElement.volume;this.setVolumeIcon(t,e),this.volumeSliderEnabled&&(this.volumeSlider.value=""+100*t,ip(this.volumeSlider,this.volumeSlider.valueAsNumber)),void 0!==this.mediaCallbacks&&this.mediaCallbacks.muteUnmuteCallback()}onPlayPauseClick(){return(0,kt.mG)(this,void 0,void 0,(function*(){this.updatePopOuts(),this.videoElement.paused?void 0!==this.mediaCallbacks?this.mediaCallbacks.playMediaCallback():yield this.videoElement.play():void 0!==this.mediaCallbacks?this.mediaCallbacks.pauseMediaCallback():this.videoElement.pause()}))}onPlaybackSpeedClick(){this.setDefaultPlaybackSpeed(),jf(this.speedMenuDiv)?(this.hideCaptionsMenu("Programmatic"),this.ensureMenuPosition(1),this.speedButton.setAttribute(vf,"true")):this.speedButton.setAttribute(vf,"false"),Kf(this.speedMenuDiv),Kf(this.speedCheckmark),jf(this.speedMenuDiv)?2!==this.positioningStrategy&&3!==this.positioningStrategy&&this.resetCaptionsOverlap():this.fixCaptionsOverlap(this.speedMenuDiv.getBoundingClientRect())}hidePlaybackSpeedMenu(e){this.speedButtonEnabled&&(jf(this.speedMenuDiv)||(Xf(this.speedMenuDiv),Xf(this.speedCheckmark),this.speedButton.setAttribute(vf,"false"),"Programmatic"!==e&&this.speedButton.focus(),2!==this.positioningStrategy&&3!==this.positioningStrategy&&this.resetCaptionsOverlap()))}setDefaultPlaybackSpeed(){this.defaultSpeedSet||(this.defaultSpeedSet=!0,this.speedSelection=uf.indexOf(this.mediaInfo.playbackSpeed),-1===this.speedSelection?df.warn(509670626,"PlaybackControls.setDefaultPlaybackSpeed: default video speed not in list of playback speed options"):this.setPlaybackSpeed(this.speedSelection))}setPlaybackSpeedFromElement(){const e=uf.indexOf(this.videoElement.playbackRate);e!==this.speedSelection&&this.setPlaybackSpeed(e)}setPlaybackSpeed(e){this.speedMenu.children[this.speedSelection].setAttribute(gf,"false"),this.speedSelection=e,this.mediaInfo.playbackSpeed=uf[e],this.videoElement.playbackRate=this.mediaInfo.playbackSpeed,this.speedButton.innerText=this.mediaInfo.playbackSpeed.toString()+"x",this.speedMenu.children[this.speedSelection].setAttribute(gf,"true"),this.speedCheckmark.style.top=`${this.speedMenu.children[e].offsetTop+14}px`,Xf(this.speedMenuDiv),Xf(this.speedCheckmark),this.speedButton.setAttribute(vf,"false")}onFullscreenClick(){this.isFullscreenMode?this.isFullscreenMode=!1:(this.isFullscreenMode=!0,this.videoElement.requestFullscreen().catch((e=>{df.warn(509346562,`PlayerControls.onFullscreenClick: unable to fullscreen video - ${e.message}`),this.isFullscreenMode=!1})))}getMediaInfo(){const e=isNaN(this.mediaControlInfo.trimInfo.trimEndMs)?0:this.mediaControlInfo.trimInfo.trimEndMs,t=isNaN(this.videoElement.duration)?0:1e3*this.videoElement.duration-e;return{trimStartMs:isNaN(this.mediaControlInfo.trimInfo.trimStartMs)?0:this.mediaControlInfo.trimInfo.trimStartMs,trimEndMs:e,max:Vf(t),autoplay:this.videoElement.autoplay,playbackSpeed:this.videoElement.playbackRate,screenReaderInfo:this.mediaControlInfo.screenReaderInfo}}addCssRef(e){if(null==e||e.styleSheets.length>0)return;const t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",this.mediaControlInfo.cssUrl),t.addEventListener("error",(()=>{df.error(508864334,"PlaybackControls.css failed to load")})),e.appendChild(t)}getBufferedSec(){let e=Vf(this.mediaInfo.trimStartMs);if(this.videoElement.buffered.length>0)try{e=this.videoElement.buffered.end(0)}catch(e){}return e}createControls(){this.setControlFlags(),this.createContainer(!0),this.createTopControls(this.container),this.createBottomControls(this.container),this.speedButtonEnabled&&this.createPlaybackSpeedMenu(this.container),this.videoElement.addEventListener("fullscreenchange",this.onFullScreenChange),this.videoElement.addEventListener("play",this.onPlay),this.videoElement.addEventListener("timeupdate",this.onTimeUpdate),this.videoElement.addEventListener("loadedmetadata",this.refreshControls),this.videoElement.addEventListener("canplay",this.refreshControls),null!==this.videoElement.textTracks&&void 0!==this.videoElement.textTracks&&(this.hideCaptionsInPlayer(),this.videoElement.textTracks.addEventListener("change",this.hideCaptionsInPlayer)),this.nestedTabbingEnabled?this.initTabIndex():this.setTabOrder(),this.setVolumeIcon(this.videoElement.volume,this.videoElement.muted),this.fullscreenButtonEnabled&&this.setFullscreenIcon(this.isFullscreenMode),this.textTracks=function(e){const t=[];for(const i of e)t.push({language:i.language,label:i.label,cues:[]});return t}(this.videoElement.textTracks),this.setDefaultCaptionTrack()}setControlFlags(){if(this.captionsButtonVisible=void 0!==this.mediaControlInfo.captionsEnabled&&this.mediaControlInfo.captionsEnabled,this.captionsButtonVisible&&this.videoElement.textTracks.length>0&&(this.captionsButtonEnabled=!0),void 0!==this.mediaControlInfo.captionsPositioningStrategy&&(this.positioningStrategy=this.mediaControlInfo.captionsPositioningStrategy),df.info(509163655,JSON.stringify({Description:"PlaybackControls - Captions settings",captionsButtonVisible:this.captionsButtonVisible,captionsButtonEnabled:this.captionsButtonEnabled,textTracks:this.videoElement.textTracks.length,children:this.videoElement.children.length})),this.captionsRenderer=this.mediaControlInfo.captionsRenderer,this.volumeSliderEnabled=void 0===this.mediaControlInfo.volumeSliderEnabled||this.mediaControlInfo.volumeSliderEnabled,this.speedButtonEnabled=void 0!==this.mediaControlInfo.speedEnabled&&this.mediaControlInfo.speedEnabled,this.fullscreenButtonEnabled=void 0!==this.mediaControlInfo.fullscreenEnabled&&this.mediaControlInfo.fullscreenEnabled,this.nestedTabbingEnabled=void 0!==this.mediaControlInfo.nestedTabbingEnabled&&this.mediaControlInfo.nestedTabbingEnabled,!this.volumeSliderEnabled){const e=cf.getNumber("captionsScaleFactor");this.captionsScaleFactor=void 0===e||0===e?.6:e}}setNextArrowFocus(e,t){let i=e;switch(e){case this.progressBar:i=this.playButton;break;case this.playButton:i=this.volumeButton;break;case this.volumeButton:this.volumeSliderEnabled?(Wf(this.volumeSliderContainer),i=this.volumeSlider):this.captionsButtonEnabled?i=this.captionsButton:this.speedButtonEnabled?i=this.speedButton:this.fullscreenButtonEnabled&&(i=this.fullscreenButton);break;case this.volumeSlider:this.captionsButtonEnabled?i=this.captionsButton:this.speedButtonEnabled?i=this.speedButton:this.fullscreenButtonEnabled&&(i=this.fullscreenButton);break;case this.captionsButton:this.speedButtonEnabled?i=this.speedButton:this.fullscreenButtonEnabled&&(i=this.fullscreenButton);break;case this.speedButton:this.fullscreenButtonEnabled&&(i=this.fullscreenButton);break;default:if(!cf.getBoolean("showHideControlsOnResize"))return}if(cf.getBoolean("showHideControlsOnResize")){if(i===e)return void t.stopImmediatePropagation();if("none"===i.style.display||!this.container.contains(i))return void this.setNextArrowFocus(i,t)}t.stopImmediatePropagation(),i.focus()}setPreviousArrowFocus(e,t){let i=e;switch(e){case this.playButton:i=this.progressBar;break;case this.volumeButton:i=this.playButton;break;case this.volumeSlider:i=this.volumeButton;break;case this.captionsButton:this.volumeSliderEnabled?(Wf(this.volumeSliderContainer),i=this.volumeSlider):i=this.volumeButton;break;case this.speedButton:this.captionsButtonEnabled?i=this.captionsButton:this.volumeSliderEnabled?(Wf(this.volumeSliderContainer),i=this.volumeSlider):i=this.volumeButton;break;case this.fullscreenButton:this.speedButtonEnabled?i=this.speedButton:this.captionsButtonEnabled?i=this.captionsButton:this.volumeSliderEnabled?(Wf(this.volumeSliderContainer),i=this.volumeSlider):i=this.volumeButton;break;default:if(!cf.getBoolean("showHideControlsOnResize"))return}if(cf.getBoolean("showHideControlsOnResize")){if(i===e)return void t.stopImmediatePropagation();if("none"===i.style.display||!this.container.contains(i))return void this.setPreviousArrowFocus(i,t)}t.stopImmediatePropagation(),i.focus()}createControlsPlayPause(){this.createContainer(!1),this.setContainerStyle();const e=sp("div","controls-left");Of(e,{left:this.container.style.left}),this.createPlayButton(e),this.container.appendChild(e)}setContainerStyle(){const e=this.mediaControlInfo;cf.getBoolean("resizeMediaOnSlideScaling")?Of(this.container,{bottom:"0px",width:"100%",height:`${e.size.y}px`,zIndex:`${e.zIndex}`,direction:"ltr",display:"none"}):Of(this.container,{left:`${e.position.x}px`,top:`${e.position.y}px`,width:`${e.size.x}px`,minHeight:`${e.size.y}px`,zIndex:`${e.zIndex}`,direction:"ltr",display:"none"})}createContainer(e){const t=sp("div",e?"control-container":"control-container-no-background");t.id="video-controls-container",this.container=t,this.setContainerStyle(),void 0!==this.mediaControlInfo.cssPositionOverride&&(t.style.position=this.mediaControlInfo.cssPositionOverride),t.addEventListener("mousedown",(()=>{t.classList.add("no-outline")})),t.addEventListener("click",(e=>{e.stopPropagation(),1===e.button&&this.updatePopOuts()})),t.addEventListener("keydown",(e=>{this.updatePopOuts(e),t.classList.remove("no-outline")}))}createTopControls(e){const t=sp("div","controls-top");this.createProgressBar(t),e.appendChild(t)}createBottomControls(e){const t=sp("div","controls-bottom");this.createLeftControls(t),this.createRightControls(t),e.appendChild(t)}createLeftControls(e){this.leftControls=sp("div","controls-left"),this.createPlayButton(this.leftControls),this.createVolumeControls(this.leftControls),this.createTimeControl(this.leftControls),e.appendChild(this.leftControls)}createRightControls(e){this.rightControls=sp("div","controls-right"),this.createCaptionsControls(this.rightControls),this.speedButtonEnabled&&this.createPlaybackSpeedControl(this.rightControls),this.fullscreenButtonEnabled&&this.createFullscreenControl(this.rightControls),e.appendChild(this.rightControls)}initTabIndex(){if(this.progressBar.tabIndex=-1,this.playButton.tabIndex=-1,this.volumeButton.tabIndex=-1,this.volumeSliderEnabled&&(this.volumeSlider.tabIndex=-1),this.captionsButtonVisible&&(this.captionsButton.tabIndex=-1,this.captionsButtonEnabled))for(const e of this.captionsMenu.children)e.tabIndex=-1;if(this.speedButtonEnabled){this.speedButton.tabIndex=-1;for(const e of this.speedMenu.children)e.tabIndex=-1}this.fullscreenButtonEnabled&&(this.fullscreenButton.tabIndex=-1)}setTabOrder(){this.progressBar.tabIndex=1,this.playButton.tabIndex=2,this.volumeButton.tabIndex=3;let e=this.volumeButton.tabIndex+1;if(this.volumeSliderEnabled&&(this.volumeSlider.tabIndex=e,e+=1),this.captionsButtonVisible&&(this.captionsButton.tabIndex=e,e+=1),this.captionsButtonEnabled)for(const t of this.captionsMenu.children)t instanceof SVGSVGElement||(t.tabIndex=e,e+=1);if(this.speedButtonEnabled){this.speedButton.tabIndex=e,e+=1;for(const t of this.speedMenu.children)t.tabIndex=e,e+=1}this.fullscreenButtonEnabled&&(this.fullscreenButton.tabIndex=e,e+=1)}updatePopOuts(e){(this.nestedTabbingEnabled||void 0===e||"Tab"!==e.key&&"Shift"!==e.key)&&(void 0!==e&&e.getModifierState(e.key)||this.handleCaptionsKeyboardEvent(e)||(this.captionsButtonEnabled&&this.isCaptionsMenuVisible()&&this.hideCaptionsMenu(void 0===e?"Programmatic":"Keyboard"),this.handleSpeedKeyboardEvent(e)||this.speedButtonEnabled&&void 0!==this.speedMenuDiv&&!jf(this.speedMenuDiv)&&this.hidePlaybackSpeedMenu(void 0===e?"Programmatic":"Keyboard")))}handleCaptionsKeyboardEvent(e){if(!this.captionsButtonEnabled||void 0===e)return!1;if(("j"===e.key||"∆"===e.key)&&e.altKey)return this.toggleCaptionsMenuInternal("Shortcut"),e.stopPropagation(),!0;if(this.isCaptionsMenuVisible())switch(e.key){case"ArrowUp":case"PageUp":e.preventDefault(),this.captionFocus>0&&(this.captionFocus-=1,this.captionsMenu.children[this.captionFocus].focus());break;case"ArrowDown":case"PageDown":e.preventDefault(),this.captionFocus>=0&&this.captionFocus<this.captionsMenu.children.length-2&&(this.captionFocus+=1,this.captionsMenu.children[this.captionFocus].focus());break;case"ArrowLeft":case"ArrowRight":break;case"Escape":this.hideCaptionsMenu("Keyboard");break;default:return!1}else{if("c"!==e.key)return!1;"none"===this.container.style.display&&this.show(),this.toggleCaptionsMenuInternal("Shortcut"),this.showOptionFocus(this.captionsMenu.children[this.captionSelection],0)}return e.stopPropagation(),!0}handleSpeedKeyboardEvent(e){if(!this.speedButtonEnabled||void 0===e)return!1;if(!jf(this.speedMenuDiv)){switch(e.key){case"ArrowUp":case"PageUp":e.preventDefault(),this.speedFocus>0&&(this.speedFocus-=1,this.speedMenu.children[this.speedFocus].focus());break;case"ArrowDown":case"PageDown":e.preventDefault(),this.speedFocus>=0&&this.speedFocus<this.speedMenu.children.length-1&&(this.speedFocus+=1,this.speedMenu.children[this.speedFocus].focus());break;case"ArrowLeft":case"ArrowRight":break;case"Escape":this.hidePlaybackSpeedMenu("Keyboard");break;default:return!1}return e.stopPropagation(),!0}return!1}getProgressStep(){const e=this.mediaInfo.max-Vf(this.mediaInfo.trimStartMs);return Math.max(e/100,.01)}createProgressBar(e){const t=document.createElement("input");this.progressBar=t,t.type="range",t.classList.add("progress-slider"),t.min=`${Vf(this.mediaInfo.trimStartMs)}`,t.max=`${this.mediaInfo.max}`,t.value=t.min,t.step=`${this.getProgressStep()}`,t.addEventListener("input",(()=>this.onProgressSliderInput())),void 0!==this.mediaInfo.screenReaderInfo&&t.setAttribute(yf,this.mediaInfo.screenReaderInfo.progressBarStr),t.addEventListener("focus",(()=>this.setProgressForScreenReader())),t.addEventListener("click",(()=>this.updatePopOuts())),!0===this.mediaControlInfo.stopPropagateMouseDownOnSlider&&t.addEventListener("mousedown",(e=>{e.stopPropagation()})),t.addEventListener("keydown",(e=>{this.updatePopOuts(e),this.nestedTabbingEnabled?"ArrowRight"===e.key?(e.preventDefault(),this.setNextArrowFocus(t,e)):"ArrowLeft"===e.key?(e.preventDefault(),e.stopImmediatePropagation()):"ArrowDown"!==e.key&&"ArrowUp"!==e.key||e.stopPropagation():"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowUp"!==e.key&&"ArrowRight"!==e.key&&"PageDown"!==e.key&&"PageUp"!==e.key||e.stopPropagation()})),void 0!==this.mediaControlInfo.tooltipMap&&t.addEventListener("mouseenter",(()=>{t.title=this.getTooltip("Seek")}));const i=Vf(this.mediaInfo.trimStartMs);tp(this.progressBar,(this.progressBar.valueAsNumber-i)/(this.mediaInfo.max-i)*100,(this.getBufferedSec()-i)/(this.mediaInfo.max-i)*100),e.appendChild(t)}createPlayButton(e){const t=sp("button","playpause");this.playButton=t,t.type="button";const i=Ef("play-pause-gfxicon");t.appendChild(i),void 0!==this.mediaInfo.screenReaderInfo&&t.setAttribute(yf,this.videoElement.paused?this.mediaInfo.screenReaderInfo.playButtonStr:this.mediaInfo.screenReaderInfo.pauseButtonStr),this.videoElement.addEventListener("play",this.togglePlayPauseIcon),this.videoElement.addEventListener("pause",this.togglePlayPauseIcon),this.videoElement.addEventListener("keydown",this.onVideoKeyDown),t.addEventListener("click",(()=>{this.onPlayPauseClick().catch((e=>df.warn(508413404,`PlayerControls.onPlayPauseClick: unable to play/pause video - ${e.message}`)))})),t.addEventListener("keydown",(e=>{if(this.updatePopOuts(e),void 0!==e.key)switch(e.key){case"Enter":case" ":e.preventDefault(),e.stopPropagation(),this.onPlayPauseClick().catch((e=>df.warn(526952129,`PlayerControls.onPlayPauseClick: unable to play/pause video - ${e.message}`)));break;case"ArrowRight":this.nestedTabbingEnabled&&this.setNextArrowFocus(t,e);break;case"ArrowLeft":this.nestedTabbingEnabled&&this.setPreviousArrowFocus(t,e);break;case"ArrowUp":case"ArrowDown":this.nestedTabbingEnabled&&e.stopImmediatePropagation()}})),e.appendChild(t)}setPlayPauseIcon(e){const t=this.playButton.querySelector("#play-gfxicon"),i=this.playButton.querySelector("#pause-gfxicon");null!==t&&null!==i?e?(Yf(i),Xf(t),void 0!==this.mediaInfo.screenReaderInfo&&this.playButton.setAttribute(yf,this.mediaInfo.screenReaderInfo.pauseButtonStr),void 0!==this.mediaControlInfo.tooltipMap&&(this.playButton.title=this.getTooltip("Pause"))):(Yf(t),Xf(i),void 0!==this.mediaInfo.screenReaderInfo&&this.playButton.setAttribute(yf,this.mediaInfo.screenReaderInfo.playButtonStr),void 0!==this.mediaControlInfo.tooltipMap&&(this.playButton.title=this.getTooltip("Play"))):(df.warn(541882011,"PlayerControls.setPlayPauseIcon: querySelector returned null."),void 0!==this.mediaCallbacks&&this.mediaCallbacks.logVetoCallback("IncorrectPlayPauseIcon"))}createVolumeControls(e){this.volumeContainer=sp("div","volume-container"),this.createVolumeButton(this.volumeContainer),this.volumeSliderEnabled&&(this.createVolumeSlider(this.volumeContainer),this.volumeContainer.addEventListener("focusin",(()=>{Wf(this.volumeSliderContainer)})),this.volumeContainer.addEventListener("mouseleave",(()=>{$f(this.volumeSliderContainer)}))),this.volumeContainer.addEventListener("click",(()=>this.updatePopOuts())),this.volumeContainer.addEventListener("keydown",(e=>this.updatePopOuts(e))),e.appendChild(this.volumeContainer)}createVolumeButton(e){const t=sp("button","volume");this.volumeButton=t,t.type="button";const i=Ef("volume-gfxicon");t.appendChild(i),this.videoElement.addEventListener("volumechange",this.onVideoVolumeChange),void 0!==this.mediaInfo.screenReaderInfo&&(t.setAttribute(yf,this.videoElement.muted?this.mediaInfo.screenReaderInfo.unmuteButtonStr:this.mediaInfo.screenReaderInfo.muteButtonStr),t.addEventListener("keydown",(e=>{if(this.updatePopOuts(e),void 0!==e.key)switch(e.key){case"Enter":case" ":e.preventDefault(),e.stopPropagation(),this.onVolumeClick()}}))),t.addEventListener("click",(()=>{this.updatePopOuts(),this.onVolumeClick()})),t.addEventListener("keydown",(e=>{this.updatePopOuts(e),this.nestedTabbingEnabled&&("ArrowLeft"===e.key?this.setPreviousArrowFocus(t,e):"ArrowRight"===e.key?this.setNextArrowFocus(t,e):"ArrowUp"!==e.key&&"ArrowDown"!==e.key||e.stopImmediatePropagation())})),this.volumeSliderEnabled&&t.addEventListener("mouseenter",(()=>{Wf(this.volumeSliderContainer)})),e.appendChild(t)}createVolumeSlider(e){this.volumeSlider=sp("input","volume-slider"),this.volumeSlider.type="range",this.volumeSlider.min="0",this.volumeSlider.max="100",this.volumeSlider.value=this.videoElement.muted?"0":""+100*this.videoElement.volume,void 0!==this.mediaInfo.screenReaderInfo&&this.volumeSlider.setAttribute(yf,this.mediaInfo.screenReaderInfo.volumeSliderStr),ip(this.volumeSlider,this.volumeSlider.valueAsNumber),this.volumeSlider.addEventListener("input",(()=>this.onVolumeSliderInput())),!0===this.mediaControlInfo.stopPropagateMouseDownOnSlider&&this.volumeSlider.addEventListener("mousedown",(e=>{e.stopPropagation()})),this.volumeSlider.addEventListener("click",(()=>this.updatePopOuts())),this.volumeSlider.addEventListener("keydown",(e=>{this.updatePopOuts(e),this.nestedTabbingEnabled?"ArrowLeft"===e.key?(e.preventDefault(),this.setPreviousArrowFocus(this.volumeSlider,e)):"ArrowRight"===e.key?(e.preventDefault(),this.setNextArrowFocus(this.volumeSlider,e)):"ArrowDown"!==e.key&&"ArrowUp"!==e.key||e.stopPropagation():"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowUp"!==e.key&&"ArrowRight"!==e.key&&"PageDown"!==e.key&&"PageUp"!==e.key||e.stopPropagation()})),this.volumeSlider.addEventListener("focusout",(e=>{$f(this.volumeSlider),e.stopPropagation()})),this.volumeSlider.style.display="block",this.volumeSlider.style.margin="auto",this.volumeSlider.style.width="75%",this.volumeSliderContainer=sp("div","volume-slider-container"),this.volumeSliderContainer.appendChild(this.volumeSlider),e.style.position="relative",e.appendChild(this.volumeSliderContainer),ip(this.volumeSlider,this.volumeSlider.valueAsNumber)}setVolumeIcon(e,t){const i=this.volumeButton.querySelector("#volume-low-gfxicon"),r=this.volumeButton.querySelector("#volume-medium-gfxicon"),s=this.volumeButton.querySelector("#volume-high-gfxicon"),n=this.volumeButton.querySelector("#volume-muted-gfxicon");if(null===i||null===r||null===s||null===n)return df.warn(541882012,"PlayerControls.setVolumeIcon: querySelector returned null, unable to set volume button icon"),void(void 0!==this.mediaCallbacks&&this.mediaCallbacks.logVetoCallback("IncorrectVolumeIndicator"));Xf(n),Xf(i),Xf(r),Xf(s),void 0!==this.mediaControlInfo.tooltipMap&&(this.volumeButton.title=t?this.getTooltip("Unmute"):this.getTooltip("Mute")),Yf(t?n:e<.33?i:e<.67?r:s),void 0!==this.mediaInfo.screenReaderInfo&&this.volumeButton.setAttribute(yf,t?this.mediaInfo.screenReaderInfo.unmuteButtonStr:this.mediaInfo.screenReaderInfo.muteButtonStr)}getTextTracks(){return this.textTracks}findMatchingCaptionTrack(e,t){if(null===e&&null===t)return-1;if(0===(null==e?void 0:e.length)&&0===(null==t?void 0:t.length))return 0;const i=this.getTextTracks();let r=-1,s=-1;for(let n=0;n<i.length;n+=1){let o=i[n].language.toLowerCase();"unknown"===o&&(o="");const a=0!==(null==e?void 0:e.length)&&o===(null==e?void 0:e.toLowerCase()),l=0!==(null==t?void 0:t.length)&&i[n].label.toLowerCase()===(null==t?void 0:t.toLowerCase());if(s<0&&l&&(s=n+1),a){if(l)return n+1;r=n+1}r<0&&(Bf(i[n].language,e)||Bf(e,i[n].language))&&(r=n+1)}return r>0?r:s>0?s:-1}getLastSelectedCaptionTrack(){return[Ff(ff),Ff(pf)]}setLastSelectedCaptionTrack(e){const t=this.getTextTracks().length;if(e<0||e>t)return;let i="",r="";if(e>0){const t=this.getTextTracks()[e-1];i="unknown"===t.language.toLowerCase()?"":t.language,r=t.label}const s=new Date((new Date).setFullYear((new Date).getFullYear()+1));Af(ff,i,s),Af(pf,r,s)}setDefaultCaptionTrack(){if(!this.captionsButtonEnabled)return;if(this.getTextTracks().length<=0)return;if(this.captionSelection>0)return this.enableCaptionTrack(this.captionSelection,!1),void(this.defaultCaptionsTrackSet=!0);if(this.defaultCaptionsTrackSet)return;this.defaultCaptionsTrackSet=!0;let e=null,t=null;[e,t]=this.getLastSelectedCaptionTrack();const i=this.findMatchingCaptionTrack(e,t);if(i>=0)this.enableCaptionTrack(i,!1);else{if(void 0!==this.captionsRenderer&&""!==this.captionsRenderer.getDefaultLang)for(let e=0;e<this.getTextTracks().length;e+=1)if(this.getTextTracks()[e].language.toLowerCase()===this.captionsRenderer.getDefaultLang)return void this.enableCaptionTrack(e+1,!1);null===e&&null===t?this.captionsMenu.children[0].setAttribute(gf,"true"):this.enableCaptionTrack(1,!1)}}disableCaptionTrack(e){var t;e<0||(this.captionsMenu.children[e].setAttribute(gf,"false"),0!==e&&(void 0!==this.captionsRenderer?null===(t=this.captionsRenderer)||void 0===t||t.stopCaptionTrack():(this.videoElement.textTracks[e-1].mode="hidden",this.captionsPlaybackInPlayer=!1)))}updateCaptionTrack(e){df.info(512550666,`PlaybackControls - Captions: Updating selected caption track new selection: ${e}, previous selection: ${this.captionSelection}`),this.setLastSelectedCaptionTrack(e),e!==this.captionSelection&&(this.disableCaptionTrack(this.captionSelection),this.enableCaptionTrack(e,!1))}showCaptionsUnderlineIcon(){Yf(this.captionsButton.children[1]),this.captionsButton.children[1].style.position="",Xf(this.captionsButton.children[0]),this.captionsButton.children[0].style.position="absolute"}hideCaptionsUnderlineIcon(){Yf(this.captionsButton.children[0]),this.captionsButton.children[0].style.position="",Xf(this.captionsButton.children[1]),this.captionsButton.children[1].style.position="absolute"}isCaptionsMenuVisible(){return!jf(this.captionsMenu)}showCaptionsMenu(e){try{if(!this.captionsButtonEnabled)return;this.setDefaultCaptionTrack(),df.info(512521174,JSON.stringify({Description:"PlaybackControls - Showing captions menu",Source:e})),this.hidePlaybackSpeedMenu("Programmatic");const t=14*(1===this.captionsScaleFactor?1:this.captionsScaleFactor/2);if(this.ensureMenuPosition(0),Yf(this.captionsMenu),this.captionsCheckmark.style.top=`${this.captionsMenu.children[this.captionSelection].offsetTop+t}px`,this.captionsCheckmark.style.display="block",this.captionsButton.setAttribute(vf,"true"),!this.volumeSliderEnabled&&0===this.captionsMenu.offsetWidth){const e="75px",t="50px";df.info(508867395,JSON.stringify({Description:"PlaybackControls - Captions menu has no dimensions, setting minimums",PreviousWidth:this.captionsMenu.style.width,PreviousHeight:this.captionsMenu.style.height,NewWidth:e,NewHeight:t})),this.captionsMenu.style.width=e,this.captionsMenu.style.height=t}this.captionsMenuShown||(this.captionsMenuShown=!0,this.logCaptionsMenuInfo()),"Keyboard"===e||"Shortcut"===e?this.showOptionFocus(this.captionsMenu.children[this.captionSelection],0):"Click"===e&&this.captionsMenu.children[this.captionSelection].focus(),this.fixCaptionsOverlap(this.captionsMenu.getBoundingClientRect())}catch(e){throw df.error(509130720,`PlaybackControls.showCaptionsMenu - Exception caught: ${e.message}`),e}}logCaptionsMenuInfo(){const e=this.captionsMenu.getBoundingClientRect(),t=this.container.getBoundingClientRect();df.info(508942554,JSON.stringify({MenuClassList:this.captionsMenu.classList,MenuDisplay:this.captionsMenu.style.display,MenuHidden:this.captionsMenu.hidden,MenuOpacity:this.captionsMenu.style.opacity,MenuVisibility:this.captionsMenu.style.visibility,MenuTop:e.top,MenuBottom:e.bottom,MenuLeft:e.left,MenuRight:e.right,MenuWidth:this.captionsMenu.style.width,MenuHeight:this.captionsMenu.style.height,MenuOffsetHeight:this.captionsMenu.offsetHeight,MenuOffsetTop:this.captionsMenu.offsetTop,MenuOffsetLeft:this.captionsMenu.offsetLeft,MenuOffsetWidth:this.captionsMenu.offsetWidth,ContainerTop:t.top,ContainerBottom:t.bottom,ContainerLeft:t.left,ContainerRight:t.right}));for(const e of this.captionsMenu.children)this.logOptionInfo("Showing menu - option info",e)}fixCaptionsOverlap(e){0!==this.captionSelection&&void 0!==this.captionsRenderer&&0!==this.positioningStrategy&&this.captionsRenderer.boxIntersects(e)&&(1===this.positioningStrategy&&(this.captionsRenderer.setHorizontalPosition(this.getMenuBoxRect()),this.captionsRenderer.setVerticalPosition(!1)),2===this.positioningStrategy&&this.transferCaptionsToPlayer(),3===this.positioningStrategy&&this.captionsRenderer.reduceOpacity())}getMenuBoxRect(){return void 0!==this.captionsMenu&&this.isCaptionsMenuVisible()?this.captionsMenu.getBoundingClientRect():void 0===this.speedMenuDiv||jf(this.speedMenuDiv)?void 0:this.speedMenuDiv.getBoundingClientRect()}resetCaptionsOverlap(){void 0!==this.captionsRenderer&&0!==this.positioningStrategy&&(2===this.positioningStrategy&&this.transferCaptionsToRenderer(),0!==this.captionSelection&&(1===this.positioningStrategy&&(this.captionsRenderer.resetHorizontalPosition(),this.captionsRenderer.setVerticalPosition(!0)),3===this.positioningStrategy&&this.captionsRenderer.resetOpacity()))}hideCaptionsMenu(e){this.captionsButtonEnabled&&(df.info(512521173,JSON.stringify({Description:"PlaybackControls - Hiding captions menu",Source:e})),this.captionsCheckmark.style.display="none",Xf(this.captionsMenu),this.captionsButton.setAttribute(vf,"false"),"Programmatic"!==e&&this.captionsButton.focus(),2!==this.positioningStrategy&&3!==this.positioningStrategy&&this.resetCaptionsOverlap())}toggleCaptionsMenuInternal(e){if(!this.captionsButtonEnabled)return void df.info(509162691,JSON.stringify({Description:"PlaybackControls - Captions button is not enabled, skipping menu toggle",Source:e}));this.isVisible()||this.show();const t=Date.now()-this.lastToggleTime;t<=this.captionsMinUIDelay?df.info(509162690,JSON.stringify({Description:"PlaybackControls - Suppressing duplicate captions menu toggle",Source:e,LastClickDelay:t,MinDelay:this.captionsMinUIDelay})):(df.info(512521172,JSON.stringify({Description:"PlaybackControls - Toggling captions menu",Source:e})),this.lastToggleTime=Date.now(),this.isCaptionsMenuVisible()?this.hideCaptionsMenu(e):this.showCaptionsMenu(e))}showOptionFocus(e,t){switch(e.style.backgroundColor="#000000",e.style.background="solid",e.focus(),e.scrollIntoView({behavior:"smooth",block:"nearest"}),t){case 0:this.captionFocus=parseInt(e.id,10);break;case 1:this.speedFocus=parseInt(e.id,10)}}hideOptionFocus(e){e.style.background="none"}createCaptionsControls(e){this.captionsButtonVisible&&void 0===this.captionsButton&&(this.captionsButtonEnabled&&(df.info(512550661,"PlaybackControls - Captions: Creating captions menu"),this.createCaptionsMenu()),this.createCaptionsButton(),e.appendChild(this.captionsButton),this.captionsButtonEnabled&&this.hideCaptionsMenu("Programmatic"))}createCaptionsMenu(){this.captionsMenu=sp("div","closed-captions-menu"),this.captionsMenu.setAttribute(yf,this.mediaInfo.screenReaderInfo?this.mediaInfo.screenReaderInfo.captionsMenuStr:"Closed captions menu"),this.captionsMenu.setAttribute("role","menu"),Of(this.captionsMenu,{display:"block",opacity:".8",position:"absolute",right:"0px",borderRadius:"2px"}),this.container.appendChild(this.captionsMenu);const e=this.mediaInfo.screenReaderInfo?this.mediaInfo.screenReaderInfo.captionsMenuOffOptionStr:"Off";if(this.captionsMenu.appendChild(this.createOptionElement(0,"",e)),this.captionsButtonEnabled)for(let e=0;e<this.videoElement.textTracks.length;e+=1){const t=this.videoElement.textTracks[e];df.info(512550665,`PlaybackControls - Captions: Adding track index: ${e}, language: ${t.language}`);const i=Rf(t.language);let r;i===t.language&&df.info(512550664,`PlaybackControls - Captions: Unknown language code: ${t.language}`),r="Unknown"!==i?""!==t.label&&t.label.toLowerCase()!==i.toLowerCase()?`${t.label} - ${i}`:i:""!==t.label?t.label:`Track ${e+1}`,this.captionsMenu.addEventListener("focusout",(e=>{e.stopImmediatePropagation()})),this.captionsMenu.addEventListener("wheel",(e=>{e.preventDefault();const t=Date.now();this.lastScrollTime+35<t&&(this.captionsMenu.scrollTop+=e.deltaY>0?Math.min(e.deltaY,35):Math.max(e.deltaY,-35),this.lastScrollTime=t)}));const s=this.createOptionElement(e+1,t.language,r);this.captionsMenu.appendChild(s),this.logOptionInfo("Finished adding option to menu",s)}this.createMenuCheckmark(0),this.captionsMenu.appendChild(this.captionsCheckmark)}logOptionInfo(e,t){df.info(508905682,JSON.stringify({Description:`PlaybackControls - Captions: ${e}`,Index:t.id,Font:t.style.font,FontFamily:t.style.fontFamily,FontSize:t.style.fontSize,FillOpacity:t.style.fillOpacity,Opacity:t.style.opacity,OptionOffsetHeight:t.offsetHeight,OptionOffsetTop:t.offsetTop,OptionOffsetLeft:t.offsetLeft,OptionOffsetWidth:t.offsetWidth}))}createOptionElement(e,t,i){df.info(512550663,`PlaybackControls - Captions: Creating option index: ${e}`);const r=sp("div","closed-captions-menu-item");return t.length>0&&(r.lang=t),r.innerText=i,r.textContent=i,r.id=`${e}`,r.setAttribute(yf,i),r.setAttribute("role","menuitemradio"),r.setAttribute(gf,"false"),this.setOptionStyle(r),r.addEventListener("click",(t=>{0===t.button&&(this.logOptionActivation(r,"Click"),this.updateCaptionTrack(e),this.hideCaptionsMenu("Click"),t.stopImmediatePropagation())})),r.addEventListener("touchend",(()=>{this.logOptionActivation(r,"Touch")})),r.addEventListener("keydown",(t=>{"Spacebar"!==t.key&&" "!==t.key&&"Enter"!==t.key||(this.logOptionActivation(r,"Keyboard"),this.updateCaptionTrack(e),this.hideCaptionsMenu("Keyboard"),this.captionsButton.focus(),t.preventDefault(),t.stopImmediatePropagation())})),r.addEventListener("mouseenter",(()=>{this.showOptionFocus(r,0)})),r.addEventListener("focusin",(()=>{this.showOptionFocus(r,0)})),r.addEventListener("mouseleave",(()=>{this.hideOptionFocus(r)})),r.addEventListener("focusout",(()=>{this.hideOptionFocus(r)})),r}logOptionActivation(e,t){df.info(509162655,JSON.stringify({Description:"PlaybackControls - Captions option activation",Source:t,Index:e.id,InnerText:e.innerText,TextContent:e.textContent}))}setOptionStyle(e){const t=8*this.captionsScaleFactor+"px";Of(e,{paddingTop:t,paddingBottom:t,paddingLeft:32*this.captionsScaleFactor+"px",paddingRight:40*this.captionsScaleFactor+"px",color:"#F3F2F1",fontFamily:'"Segoe UI", "Segoe UI Web (West European)", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serif',fontSize:14*this.captionsScaleFactor+"px",textAlign:"left",fillOpacity:".8",background:"none"})}createCaptionsButton(){df.info(512550662,"PlaybackControls - Captions: Creating captions button");const e=this.mediaInfo.screenReaderInfo?this.mediaInfo.screenReaderInfo.captionsButtonStr:"Closed captions",t=sp("button","closed-captions-button");this.captionsButton=t,t.type="button",t.name=e,t.setAttribute(yf,e),t.setAttribute(_f,"menu"),t.disabled=!1,this.addCaptionbuttonIcons(),this.captionsButtonEnabled?(t.addEventListener("click",(e=>{this.logCaptionsButtonEvent("Click"),this.toggleCaptionsMenuInternal("Click"),e.stopImmediatePropagation()})),t.addEventListener("touchend",(()=>{this.logCaptionsButtonEvent("Touch")})),t.addEventListener("keydown",(e=>{"Spacebar"===e.key||" "===e.key||"Enter"===e.key?(this.logCaptionsButtonEvent("Keyboard"),this.toggleCaptionsMenuInternal("Keyboard"),e.preventDefault(),e.stopImmediatePropagation()):this.nestedTabbingEnabled&&("ArrowLeft"===e.key?this.setPreviousArrowFocus(this.captionsButton,e):"ArrowRight"===e.key?this.setNextArrowFocus(this.captionsButton,e):"ArrowUp"!==e.key&&"ArrowDown"!==e.key||e.stopImmediatePropagation())})),void 0!==this.mediaControlInfo.tooltipMap&&t.addEventListener("mouseenter",(()=>{t.title=this.getTooltip("Captions")}))):void 0!==this.mediaControlInfo.tooltipMap&&(t.title=this.getTooltip("Captions disabled"))}logCaptionsButtonEvent(e){df.info(509163653,JSON.stringify({Description:"PlaybackControls - Captions button event received",Source:e}))}addCaptionbuttonIcons(){const e=Ef("captions-gfxicon");this.captionsButtonEnabled||(e.style.opacity=".40"),this.captionsButton.appendChild(e);const t=Ef("captions-active-gfxicon");Xf(t),this.captionsButton.appendChild(t)}ensureMenuPosition(e){if(null!==this.progressBar.offsetParent){const t=this.progressBar.offsetParent;if(null!==t)switch(e){case 0:this.ensureMenuDivPosition(t,this.captionsMenu.offsetHeight,this.captionsMenu.offsetWidth,this.captionsMenu);break;case 1:this.ensureMenuDivPosition(t,this.speedMenu.offsetHeight,this.speedMenu.offsetWidth,this.speedMenuDiv)}}}ensureMenuDivPosition(e,t,i,r){const s=null!==this.root&&void 0!==this.root&&null!==this.root.host&&void 0!==this.root.host&&this.root.host.offsetHeight>0?this.root.host.offsetHeight:this.videoElement.offsetHeight,n=Math.min(t,s-e.offsetHeight-2);Of(r,{bottom:e.offsetHeight-2+"px",width:`${i}px`,height:`${n}px`})}createMenuCheckmark(e){const t=Ef("checkmark-gfxicon");switch(e){case 0:this.captionsCheckmark=t,this.captionsCheckmark.style.scale=`${this.captionsScaleFactor}`;break;case 1:this.speedCheckmark=t,this.speedCheckmark.style.display="block"}Of(t,{position:"absolute",left:10*(1===this.captionsScaleFactor?1:this.captionsScaleFactor/2.5)+"px",zIndex:"5"})}createTimeControl(e){this.currentTime=document.createElement("span"),this.currentTime.classList.add("text-formatting"),this.currentTime.style.marginLeft="4px",this.currentTime.innerText="0:00";const t=document.createElement("span");t.classList.add("text-formatting"),t.textContent=" / ",this.endTime=document.createElement("span"),this.endTime.classList.add("text-formatting"),this.endTime.id="video-end-time",this.updateTimeControl(),this.currentTime.style.alignSelf="center",t.style.alignSelf="center",this.endTime.style.alignSelf="center",this.shouldHideTimeControls()&&(this.currentTime.style.display="none",t.style.display="none",this.endTime.style.display="none"),cf.getBoolean("showHideControlsOnResize")?(this.currentTimeContainer=sp("div","current-time-container"),this.currentTime.style.marginLeft="",this.shouldHideTimeControls()&&(this.currentTimeContainer.style.display="none"),this.currentTimeContainer.appendChild(this.currentTime),this.currentTimeContainer.appendChild(t),this.currentTimeContainer.appendChild(this.endTime),e.appendChild(this.currentTimeContainer)):(e.appendChild(this.currentTime),e.appendChild(t),e.appendChild(this.endTime))}updateTimeControl(){let e=new Date(1e3*this.mediaInfo.max).toISOString();cf.getBoolean("CorrectTrimmedVideoTimeControlDuration")&&this.mediaInfo.max>0&&(e=new Date(1e3*this.mediaInfo.max-this.mediaInfo.trimStartMs).toISOString());const t="00"===e.substring(11,13)?e.substring(14,19):e.substring(11,19);this.endTime.innerText=t,this.formattedEndTime=t}transferCaptionsToPlayer(){this.captionsPlaybackInPlayer||(this.captionsPlaybackInPlayer=!0,this.captionSelection<1||void 0===this.videoElement.textTracks[this.captionSelection-1]||(this.videoElement.textTracks[this.captionSelection-1].mode="showing",this.disableCaptionTrack(this.captionSelection)))}transferCaptionsToRenderer(){if(!this.captionsPlaybackInPlayer)return;const e=this.disableCaptionsInPlayer();void 0!==e&&this.enableCaptionTrack(e+1,!1)}createPlaybackSpeedControl(e){const t=sp("button","speed");this.speedButton=t,t.type="button",t.classList.add("text-formatting"),t.innerText=this.mediaInfo.playbackSpeed.toString()+"x",t.setAttribute(yf,this.mediaInfo.screenReaderInfo?this.mediaInfo.screenReaderInfo.speedButtonStr:"Playback speed"),t.setAttribute(_f,"menu"),t.setAttribute(vf,"false"),t.addEventListener("click",(e=>{this.onPlaybackSpeedClick(),e.stopImmediatePropagation(),jf(this.speedMenuDiv)||this.speedMenu.children[this.speedSelection].focus()})),t.addEventListener("keydown",(e=>{"Spacebar"===e.key||" "===e.key||"Enter"===e.key?(this.onPlaybackSpeedClick(),e.preventDefault(),e.stopImmediatePropagation(),jf(this.speedMenuDiv)||this.showOptionFocus(this.speedMenu.children[this.speedSelection],1)):this.nestedTabbingEnabled&&("ArrowLeft"===e.key?this.setPreviousArrowFocus(this.speedButton,e):"ArrowRight"===e.key?this.setNextArrowFocus(this.speedButton,e):"ArrowUp"!==e.key&&"ArrowDown"!==e.key||e.stopImmediatePropagation())})),e.appendChild(this.speedButton)}createPlaybackSpeedMenu(e){this.speedMenuDiv=sp("div","speed-menu-div"),this.speedMenuDiv.classList.add("text-formatting","invisible"),this.speedMenuDiv.style.display="block",this.speedMenu=sp("div","speed-menu"),this.speedMenu.style.display="block",this.speedMenu.setAttribute("role","menu");for(let e=0;e<uf.length;e+=1){const t=sp("div","speed-menu-option");t.classList.add("text-formatting");let i="";i=this.mediaInfo.screenReaderInfo?this.mediaInfo.screenReaderInfo.speedMenuOptionStr.replace("{0}",uf[e].toString()):uf[e].toString()+"x",t.innerText=i,t.id=`${e}`,t.setAttribute(yf,i),t.setAttribute("role","menuitemradio"),t.setAttribute(gf,"false"),t.addEventListener("click",(t=>{this.setPlaybackSpeed(e),t.stopImmediatePropagation(),2!==this.positioningStrategy&&3!==this.positioningStrategy&&this.resetCaptionsOverlap(),this.speedButton.focus()})),t.addEventListener("keydown",(t=>{"Spacebar"!==t.key&&" "!==t.key&&"Enter"!==t.key||(this.setPlaybackSpeed(e),this.speedButton.focus(),t.preventDefault(),t.stopImmediatePropagation())})),t.addEventListener("mouseenter",(()=>{this.showOptionFocus(t,1)})),t.addEventListener("focusin",(()=>{this.showOptionFocus(t,1)})),t.addEventListener("mouseleave",(()=>{this.hideOptionFocus(t)})),t.addEventListener("focusout",(e=>{this.hideOptionFocus(t),e.stopImmediatePropagation()})),this.speedMenu.appendChild(t)}this.speedMenu.addEventListener("focusout",(e=>{e.stopImmediatePropagation()})),this.speedMenuDiv.addEventListener("wheel",(e=>{e.preventDefault();const t=Date.now();this.lastScrollTime+35<t&&(this.speedMenuDiv.scrollTop+=e.deltaY>0?Math.min(e.deltaY,35):Math.max(e.deltaY,-35),this.lastScrollTime=t)})),e.appendChild(this.speedMenuDiv),this.speedMenuDiv.appendChild(this.speedMenu),this.createMenuCheckmark(1),Xf(this.speedCheckmark),this.speedMenu.appendChild(this.speedCheckmark)}createFullscreenControl(e){this.fullscreenButton=sp("button","fullscreen"),this.fullscreenButton.type="button",this.fullscreenButton.setAttribute(yf,this.mediaInfo.screenReaderInfo?this.mediaInfo.screenReaderInfo.fullScreenButtonStr:"Full screen");const t=Ef("fullscreen-gfxicon");this.fullscreenButton.appendChild(t),this.fullscreenButton.addEventListener("click",(()=>this.onFullscreenClick())),this.fullscreenButton.addEventListener("keydown",(e=>{"Spacebar"===e.key||" "===e.key||"Enter"===e.key?this.onFullscreenClick():this.nestedTabbingEnabled&&("ArrowLeft"===e.key?this.setPreviousArrowFocus(this.fullscreenButton,e):"ArrowRight"!==e.key&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key||e.stopImmediatePropagation())})),e.appendChild(this.fullscreenButton)}setFullscreenIcon(e){const t=this.fullscreenButton.querySelector("#fullscreen-enter-gfxicon"),i=this.fullscreenButton.querySelector("#fullscreen-exit-gfxicon");null!==t&&null!==i?e?(Yf(i),Xf(t)):(Yf(t),Xf(i)):(df.warn(509346561,"PlayerControls.setFullscreenIcon: querySelector returned null."),void 0!==this.mediaCallbacks&&this.mediaCallbacks.logVetoCallback("IncorrectFullscreenIcon"))}getTooltip(e){if(void 0===this.mediaControlInfo.tooltipMap)return e.toString();const t=this.mediaControlInfo.tooltipMap.get(e);if(void 0===t||void 0===this.mediaCallbacks)return e.toString();const i=this.mediaCallbacks.isPresenterCallback();return void 0===i?t.noRole:i?t.presenter:t.attendee}setProgressForScreenReader(){if(void 0!==this.mediaInfo.screenReaderInfo){const e=zf(this.videoElement.currentTime,this.mediaInfo.screenReaderInfo),t=zf(this.videoElement.duration,this.mediaInfo.screenReaderInfo),i=this.mediaInfo.screenReaderInfo.progressStr.replace("{0}",e).replace("{1}",t);this.progressBar.setAttribute("aria-valuetext",i)}}shouldHideTimeControls(){if(void 0===this.mediaControlInfo.controlHidingEnabled||!this.mediaControlInfo.controlHidingEnabled||void 0===this.mediaControlInfo.widthThresholdForHidingControls)return!1;let e=!1;return this.volumeSliderEnabled&&(e=this.mediaControlInfo.size.x<this.mediaControlInfo.widthThresholdForHidingControls-(this.speedButtonEnabled?0:36)-(this.captionsButtonVisible?0:36)),e}}function op(e){Of(e,{zIndex:"6",pointerEvents:"all",position:"absolute",objectFit:"fill",height:"100%",width:"100%"})}var ap;function lp(e,t){for(const[i,r]of Object.entries(t))e.setAttribute(i,r)}!function(e){e[e.Audio=0]="Audio",e[e.Video=1]="Video",e[e.GIF=2]="GIF",e[e.StreamClassic=3]="StreamClassic",e[e.YouTube=4]="YouTube",e[e.Vimeo=5]="Vimeo",e[e.Flip=6]="Flip",e[e.Ted=7]="Ted",e[e.Stream2=8]="Stream2",e[e.SlideShare=9]="SlideShare",e[e.Other=10]="Other"}(ap||(ap={}));class hp{constructor(){this.rateChanges=0,this.volumeChanges=0,this.plays=0,this.seeks=0,this.stalls=0,this.totalBufferingTimeMs=0,this.totalPlayingTimeMs=0}}class cp{constructor(e){this.perfSummary=new hp,this.player=e,this.pageLoadingTime=Date.now(),this.registerEventListeners()}registerEventListeners(){this.player.addEventListener("loadstart",(()=>{void 0===this.perfSummary.timeToLoadStartMs&&(this.perfSummary.timeToLoadStartMs=Date.now()-this.pageLoadingTime)})),this.player.addEventListener("canplay",(()=>{void 0===this.perfSummary.timeToInteractivityMs&&(this.perfSummary.timeToInteractivityMs=Date.now()-this.pageLoadingTime)})),this.player.addEventListener("play",(()=>{this.lastPlayTime=Date.now(),this.perfSummary.plays+=1})),this.player.addEventListener("playing",(()=>{this.lastPlayingTime=Date.now(),void 0===this.perfSummary.timeToPlayingMs&&void 0!==this.lastPlayTime&&(this.perfSummary.timeToPlayingMs=this.lastPlayingTime-this.lastPlayTime),this.updateTotalBufferingTime()})),this.player.addEventListener("waiting",(()=>{this.lastWaitingTime=Date.now(),this.updateTotalPlayingTime()})),this.player.addEventListener("pause",(()=>{this.updateTotalBufferingTime(),this.updateTotalPlayingTime()})),this.player.addEventListener("seeking",(()=>{this.perfSummary.seeks+=1})),this.player.addEventListener("stalled",(()=>{this.perfSummary.stalls+=1})),this.player.addEventListener("ended",(()=>{this.perfSummary.isPlayedUntilEnd=!0})),this.player.addEventListener("ratechange",(()=>{this.perfSummary.rateChanges+=1})),this.player.addEventListener("volumechange",(()=>{this.perfSummary.volumeChanges+=1})),this.player.addEventListener("error",(()=>{this.updateTotalBufferingTime(),this.updateTotalPlayingTime(),void 0===this.perfSummary.errorCode&&null!==this.player.error&&(this.perfSummary.errorCode=this.player.error.code)})),this.player.addEventListener("abort",(()=>{this.updateTotalBufferingTime(),this.updateTotalPlayingTime(),this.perfSummary.wasAborted=!0}))}logPerfSummary(){this.updateTotalBufferingTime(),this.updateTotalPlayingTime(),0===this.perfSummary.totalBufferingTimeMs&&0===this.perfSummary.totalPlayingTimeMs&&void 0===this.perfSummary.errorCode||(this.perfSummary.durationMs=Math.round(1e3*this.player.duration),this.perfSummary.width=this.player.videoWidth,this.perfSummary.height=this.player.videoHeight,this.perfSummary.hasControls=this.player.controls,this.perfSummary.isAutoplay=this.player.autoplay,this.perfSummary.isLoop=this.player.loop,this.perfSummary.lastRate=this.player.playbackRate,this.perfSummary.lastVolume=Math.round(100*this.player.volume),this.perfSummary.lastIsMuted=this.player.muted,df.info(508650254,`EmbeddedPlayback ${JSON.stringify(this.perfSummary)}`),this.perfSummary.totalBufferingTimeMs=0,this.perfSummary.totalPlayingTimeMs=0,this.perfSummary.errorCode=void 0)}cleanup(){}updateTotalBufferingTime(){void 0!==this.lastWaitingTime&&(this.perfSummary.totalBufferingTimeMs+=Date.now()-this.lastWaitingTime,this.lastWaitingTime=void 0)}updateTotalPlayingTime(){void 0!==this.lastPlayingTime&&(this.perfSummary.totalPlayingTimeMs+=Date.now()-this.lastPlayingTime,this.lastPlayingTime=void 0)}}class dp{constructor(e,t,i,r){this.player=e,this.playbackTracker=i,this.onMediaEventCallback=r,this.playbackTracker.setIsMuted(this.player.muted),this.playbackTracker.setVolume(this.player.volume),this.registerEventListeners(t)}registerEventListeners(e){this.player.addEventListener("loadstart",(()=>{this.playbackTracker.onLoadStart(),this.sendEvent(0)})),this.player.addEventListener("loadedmetadata",(()=>{this.playbackTracker.onLoadedMetadata(),this.playbackTracker.setDuration(Math.round(1e3*this.player.duration)),this.player instanceof HTMLVideoElement&&this.playbackTracker.setSrcDimensions(this.player.videoWidth,this.player.videoHeight),this.sendEvent(1)})),this.player.addEventListener("loadeddata",(()=>{this.sendEvent(2)})),this.player.addEventListener("canplay",(()=>{this.playbackTracker.onCanPlay(),this.sendEvent(3)})),this.player.addEventListener("canplaythrough",(()=>{this.playbackTracker.onCanPlayThrough()})),this.player.addEventListener("play",(()=>{this.playbackTracker.onPlay(),this.sendEvent(4)})),this.player.addEventListener("playing",(()=>{this.playbackTracker.onPlaying(),this.sendEvent(5)})),this.player.addEventListener("pause",(()=>{this.playbackTracker.onPause(),this.sendEvent(6)})),this.player.addEventListener("seeked",(()=>{this.sendEvent(7)})),this.player.addEventListener("seeking",(()=>{this.sendEvent(8)})),e&&this.player.addEventListener("timeupdate",(()=>{this.sendEvent(9)})),this.player.addEventListener("volumechange",(()=>{this.playbackTracker.onVolumeChanged(this.player.volume),this.playbackTracker.setIsMuted(this.player.muted),this.sendEvent(10)})),this.player.addEventListener("stalled",(()=>{this.playbackTracker.onStalled(),this.sendEvent(8)})),this.player.addEventListener("ended",(()=>{this.playbackTracker.onEnded(),this.sendEvent(11)})),this.player.addEventListener("error",(()=>{const e="Local media error."+(this.player.error?` Code: ${this.player.error.code}, message: ${this.player.error.message}`:"");this.playbackTracker.onError(e),this.sendEvent(12)}))}getPlaybackData(){return this.playbackTracker.getPlaybackData()}cleanup(){this.playbackTracker.cleanup()}sendEvent(e){void 0!==this.onMediaEventCallback&&this.onMediaEventCallback(e)}}class up{constructor(e,t,i,r,s,n,o,a,l,h){this.isDesignerElement=i,this.mediaProperties=r,this.player=this.createLocalPlayer(e,t,i,r.mediaType,n,o,h),this.useLocalMediaEventHandler()&&void 0!==a?this.eventHandler=new dp(this.player,this.mediaProperties.trimEndSec>0,a,l):!0===s&&this.player instanceof HTMLVideoElement&&(this.eventHandler=new cp(this.player)),null==a||a.setTimeOfCreation()}play(){return(0,kt.mG)(this,void 0,void 0,(function*(){try{yield this.player.play()}catch(e){df.info(541882e3,"Error local video play")}df.info(520378572,`Local.play: this.player.paused: ${this.player.paused}`)}))}pause(){this.player.pause()}setVisible(){this.isDesignerElement&&(this.player.loop=!0),this.player.style.visibility="visible",this.setFocus()}setHidden(){this.isDesignerElement&&(this.player.loop=!1,this.player.autoplay=!1),this.player.style.pointerEvents="none",this.player.style.visibility="hidden"}stop(){this.player.pause(),this.player.currentTime=0,void 0!==this.eventHandler&&void 0!==this.eventHandler.logPerfSummary&&this.eventHandler.logPerfSummary()}togglePause(){return(0,kt.mG)(this,void 0,void 0,(function*(){if(df.info(520378573,`Local.togglePause: Before toggle, this.player.paused: ${this.player.paused}`),this.player.paused)try{yield this.play()}catch(e){df.info(541882001,"Error local video play while toggle pause")}else this.pause();df.info(520378574,`Local.togglePause: After toggle, this.player.paused: ${this.player.paused}`)}))}isPaused(){return this.player.paused}getPlayer(){return this.player}setSource(e){this.player.src=e}getCurrentTime(){return this.player.currentTime}getDuration(){return this.player.duration}seekTo(e){this.player.currentTime=e}ensureMediaClient(){}cleanUpMediaClient(){void 0!==this.eventHandler&&void 0!==this.eventHandler.cleanup&&this.eventHandler.cleanup()}setMute(){this.player.muted=!0}setUnMute(){this.player.muted=!1}isMuted(){return this.player.muted}setVolume(e){this.player.volume=e}getVolume(){return this.player.volume}getPlaybackData(){if(void 0!==this.eventHandler&&void 0!==this.eventHandler.getPlaybackData)return this.eventHandler.getPlaybackData()}setFocus(){void 0!==this.player&&this.player.focus()}seekToTrimStartIfNeeded(){void 0!==this.player&&void 0!==this.mediaProperties.trimmedEndTimeSec&&(this.player.currentTime<this.mediaProperties.trimStartSec||this.player.currentTime>=this.mediaProperties.trimmedEndTimeSec)&&(this.player.currentTime=this.mediaProperties.trimStartSec)}onTimeUpdate(){void 0!==this.player&&void 0!==this.mediaProperties.trimmedEndTimeSec&&this.player.currentTime>=this.mediaProperties.trimmedEndTimeSec&&this.player.pause()}isTrimValid(){return void 0!==this.mediaProperties.durationSec&&this.mediaProperties.trimStartSec<=this.mediaProperties.durationSec&&this.mediaProperties.trimEndSec<=this.mediaProperties.durationSec&&this.mediaProperties.trimStartSec+this.mediaProperties.trimEndSec<this.mediaProperties.durationSec}setTrim(e){void 0===e||isNaN(e.duration)||(this.mediaProperties.durationSec=e.duration,this.mediaProperties.trimmedEndTimeSec=this.mediaProperties.durationSec-this.mediaProperties.trimEndSec,this.isTrimValid()?(e.addEventListener("timeupdate",(()=>{this.onTimeUpdate()})),e.addEventListener("play",(()=>{this.seekToTrimStartIfNeeded()}))):(this.mediaProperties.trimStartSec=0,this.mediaProperties.trimEndSec=0,this.mediaProperties.trimmedEndTimeSec=this.mediaProperties.durationSec))}useLocalMediaEventHandler(){return cf.getBoolean("enableLocalMediaEventHandler")||cf.getBoolean("UseSharedTelemetryForLocalMedia")}createLocalPlayer(e,t,i,r,s,n,o){const a=r===ap.Audio?document.createElement("audio"):document.createElement("video");return void 0!==e&&e.appendChild(a),a.style.visibility=i||s||n?"hidden":"visible",a.style.pointerEvents=s||n?"none":"all",this.setProperties(a),void 0!==this.mediaProperties.attributes?lp(a,this.mediaProperties.attributes):lp(a,{disablePictureInPicture:"true",controlsList:"nodownload nofullscreen noremoteplayback"}),void 0!==this.mediaProperties.styles?Of(a,this.mediaProperties.styles):op(a),i?(a.loop=!0,a.muted=!0,a.addEventListener("canplay",(()=>{a.style.visibility="visible"}),{once:!0})):this.setFocus(),(this.mediaProperties.trimStartSec>0||this.mediaProperties.trimEndSec>0)&&a.addEventListener("loadedmetadata",(()=>{this.setTrim(a)}),{once:!0}),null!=o&&o.forEach((e=>{const t=document.createElement("track"),i=e.lang&&""!==e.lang?e.lang:"unknown";t.setAttribute("kind","captions"),t.setAttribute("label",e.label),t.setAttribute("src",decodeURIComponent(e.src)),t.setAttribute("srclang",i),a.appendChild(t)})),a.src=t,a}setProperties(e){e.autoplay=void 0===this.mediaProperties.autoPlay||this.mediaProperties.autoPlay,e.controls=void 0===this.mediaProperties.controls||this.mediaProperties.controls,void 0!==this.mediaProperties.elementId&&(e.id=this.mediaProperties.elementId),void 0!==this.mediaProperties.crossOrigin&&(e.crossOrigin=this.mediaProperties.crossOrigin),void 0!==this.mediaProperties.zIndex&&(e.style.zIndex=this.mediaProperties.zIndex),void 0!==this.mediaProperties.preload&&(e.preload=this.mediaProperties.preload),e instanceof HTMLVideoElement&&(void 0!==this.mediaProperties.playsInline&&(e.playsInline=this.mediaProperties.playsInline),void 0!==this.mediaProperties.width&&(e.width=this.mediaProperties.width),void 0!==this.mediaProperties.height&&(e.height=this.mediaProperties.height))}}class fp{constructor(e,t,i){this.playButton=t,this.parent=e,this.appSettings=i}setPlayButtonVisible(){this.isPlayButtonBiggerThanParent()||(this.playButton.style.display="block",this.playButton.style.pointerEvents="visible")}setPlayButtonHidden(){this.playButton.style.display="none"}updatePlayButtonVisibility(){this.isPlayButtonBiggerThanParent()?this.setPlayButtonHidden():(this.playButton.style.display="block",this.playButton.style.pointerEvents="visible")}onSelectPlayButton(){if(void 0===this.shapeOverlayElement&&this.findShapeSelectionOverlay(),void 0!==this.shapeOverlayElement){let e=0,t=0;!0!==this.appSettings.playButtonHoverOverlayEnabled&&!cf.getBoolean("PlayButtonHoverOverlayEnabled")||!0!==this.appSettings.playButtonIconUpdateEnabled&&!cf.getBoolean("PlayButtonIconUpdateEnabled")?(e=parseFloat(this.parent.style.left)+parseFloat(this.parent.style.width)/2-28.3,t=parseFloat(this.parent.style.top)+parseFloat(this.parent.style.height)/2-28.3):(e=parseFloat(this.parent.style.left)+parseFloat(this.parent.style.width)/2-48,t=parseFloat(this.parent.style.top)+parseFloat(this.parent.style.height)/2-48),this.playButton.style.top=`${t}px`,this.playButton.style.left=`${e}px`,this.shapeOverlayElement.appendChild(this.playButton)}}onDeSelectPlayButton(){!0!==this.appSettings.playButtonHoverOverlayEnabled&&!cf.getBoolean("PlayButtonHoverOverlayEnabled")||!0!==this.appSettings.playButtonIconUpdateEnabled&&!cf.getBoolean("PlayButtonIconUpdateEnabled")?(this.playButton.style.top="calc(50% - 28.3px)",this.playButton.style.left="calc(50% - 28.3px)"):(this.playButton.style.top="calc(50% - 48px)",this.playButton.style.left="calc(50% - 48px)"),this.parent.appendChild(this.playButton)}findShapeSelectionOverlay(){null!==this.parent.parentElement&&void 0!==this.parent.parentElement.getElementsByClassName("ShapeSelectionOverlay")[0]?this.shapeOverlayElement=this.parent.parentElement.getElementsByClassName("ShapeSelectionOverlay")[0]:this.shapeOverlayElement=void 0}isPlayButtonBiggerThanParent(){return 56.6>parseFloat(this.parent.style.width)||56.6>parseFloat(this.parent.style.height)}}function pp(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}Error;class mp{constructor(e,t){this.totalPlayingTime=0,this.providerName="Other",this.correlationId=fn(),this.isPlaying=!1,this.isFirstReady=!0,this.slowPlayVetoThreshold=11500,this.notYetPlayedVetoThreshold=11500,this.creationTime=Date.now(),this.appSettings=e,this.onVetoCallback=t,void 0!==this.appSettings.SlowPlayVetoThreshold&&(this.slowPlayVetoThreshold=this.appSettings.SlowPlayVetoThreshold),void 0!==this.appSettings.NotYetPlayedVetoThreshold&&(this.notYetPlayedVetoThreshold=this.appSettings.NotYetPlayedVetoThreshold)}onReady(){this.logEvent("ready"),this.isFirstReady&&(this.isFirstReady=!1,this.timeToInteractivity=Date.now(),this.timeToFirstPlay=void 0,this.timeToFirstPlaying=void 0)}onPlay(){this.logEvent("play"),this.lastPlayTime=Date.now(),void 0===this.timeToFirstPlay&&(this.timeToFirstPlay=Date.now()),this.lastPlayingTime=void 0}onPlaying(){if(this.logEvent("playing"),void 0===this.timeToFirstPlaying&&(this.timeToFirstPlaying=Date.now(),void 0!==this.timeToFirstPlayIntent)){this.clearVideoNotPlayedTimeout();const e=this.timeToFirstPlaying-this.timeToFirstPlayIntent;e>this.slowPlayVetoThreshold&&this.onSlowPerfError("VideoPlayedSlow",`Video played after ${e} ms`)}this.isPlaying=!0,this.setTimeSincePlay(),this.calculateBufferingTime(),this.lastPlayTime=void 0,void 0===this.lastPlayingTime&&(this.lastPlayingTime=Date.now())}onPause(){this.logEvent("pause"),this.isPlaying=!1,this.setTimeSincePlay(),this.lastPlayTime=void 0,this.calculatePlayingTime()}onEnded(){this.logEvent("ended"),this.isPlaying=!1,this.playedUntilEnd=!0,this.calculatePlayingTime()}onSeeking(){this.logEvent("seeking"),this.setTimeSinceSeek(),this.lastSeekTime=Date.now()}onSeeked(){this.logEvent("seeked"),this.setTimeSinceSeek(),this.lastSeekTime=void 0}onVolumeChanged(e){this.logEvent("volumeChanged"),this.volume=e}onMuteChanged(e){this.logEvent("muteChanged"),this.isMuted=e}onBuffering(){this.logEvent("buffering"),this.isPlaying=!1,this.calculatePlayingTime(),void 0===this.lastBufferTime&&(this.lastBufferTime=Date.now())}onInit(){void 0===this.timeToInit&&(this.timeToInit=Date.now())}onHubbleTokenSet(){void 0===this.timeToHubbleToken&&(this.timeToHubbleToken=Date.now())}onOEmbedResponse(){void 0===this.timeToOEmbedResponse&&(this.timeToOEmbedResponse=Date.now())}onNavigatedToEmbedPage(){void 0===this.timeToNavigatedToEmbedPage&&(this.timeToNavigatedToEmbedPage=Date.now())}onPostMessagingInitialized(){void 0===this.timeToPostMessagingInitialized&&(this.timeToPostMessagingInitialized=Date.now())}onODSPVideoLoad(e){void 0===this.timeToODSPVideoLoadStart&&(this.timeToODSPVideoLoadStart=Date.now()-e)}onError(e,t=!1){this.logEvent("error");const i="Stream2"===this.providerName?"Stream2":"Online";let r=`${i}VideoError`;this.isPlaying?r=`${i}VideoErrorWhilePlaying`:void 0!==this.timeToFirstPlaying?r=`${i}VideoErrorAfterPlaying`:"Stream2"===this.providerName&&(e.indexOf("status: 403")>-1?r="Stream2VideoAuthenticationError":(e.indexOf("status: 429")>-1||e.indexOf("status: 408")>-1||e.indexOf("status: 503")>-1)&&(r="Stream2VideoRedemptionStormError"));const s=e.replace(/(?:https?|ftp):\/\/[\S]+/g,"[URL]");df.error(508843611,`Online video raised error: ${JSON.stringify({isCritical:t,app:this.appSettings.App,hostView:this.appSettings.hostView,name:r,message:s,provider:this.providerName,correlationId:this.correlationId})}`);const n=t?1:3;(void 0===this.error||n<=this.error.severity)&&(this.error={severity:n,name:r,message:s,timestamp:Date.now()}),t&&(this.clearVideoNotPlayedTimeout(),void 0===this.timeToFirstPlayIntent&&void 0===this.timeToInteractivity||this.sendVeto(`${i}MediaPlaybackFailure`,this.error.name,this.error.message))}onPlayCommand(){if(void 0===this.timeToFirstPlaying&&void 0===this.timeToFirstPlayIntent){if(this.timeToFirstPlayIntent=Date.now(),void 0!==this.error&&1===this.error.severity){const e="Stream2"===this.providerName?"Stream2":"Online";return void this.sendVeto(`${e}MediaPlaybackFailure`,this.error.name,this.error.message)}if("Other"===this.providerName||"Ted"===this.providerName||"SlideShare"===this.providerName)return;this.videoNotYetPlayedTimeout=window.setTimeout((()=>{this.videoNotYetPlayedTimeout=void 0,void 0===this.timeToFirstPlaying&&this.onSlowPerfError("VideoNotYetPlayed",`Video hasn't played after ${this.notYetPlayedVetoThreshold} ms`)}),this.notYetPlayedVetoThreshold)}}onPauseCommand(){void 0===this.timeToFirstPlaying&&void 0!==this.timeToFirstPlayIntent&&(this.timeToFirstPlayIntent=void 0,this.clearVideoNotPlayedTimeout())}onStopCommand(){void 0===this.timeToFirstPlaying&&void 0!==this.timeToFirstPlayIntent&&(this.timeToFirstPlayIntent=void 0,this.clearVideoNotPlayedTimeout())}setCreationTime(){this.creationTime=Date.now()}setProviderName(e){this.providerName=e}setDuration(e){this.duration=e}setVolume(e){this.volume=e}setMute(e){this.isMuted=e}cleanup(){this.timeToInit=void 0,this.timeToHubbleToken=void 0,this.timeToOEmbedResponse=void 0,this.timeToNavigatedToEmbedPage=void 0,this.timeToPostMessagingInitialized=void 0,this.timeToODSPVideoLoadStart=void 0,this.timeToInteractivity=void 0,this.timeToFirstPlayIntent=void 0,this.timeToFirstPlay=void 0,this.timeToFirstPlaying=void 0,this.lastBufferTime=void 0,this.lastSeekTime=void 0,this.lastPlayTime=void 0,this.lastPlayingTime=void 0,this.totalPlayingTime=0,this.totalBufferingTime=void 0,this.maxTimeSincePlay=void 0,this.maxTimeSinceSeek=void 0,this.playedUntilEnd=void 0,this.volume=void 0,this.isMuted=void 0,this.isPlaying=!1,this.isFirstReady=!0,this.error=void 0,this.wasVetoLogged=void 0,this.correlationId=fn(),this.clearVideoNotPlayedTimeout()}getCorrelationId(){return this.correlationId}getPerfData(){var e,t,i;return this.calculatePlayingTime(),this.calculateBufferingTime(),{correlationId:this.correlationId,creationTime:this.creationTime,providerName:this.providerName,timeToInit:this.timeToInit,timeToHubbleToken:this.timeToHubbleToken,timeToOEmbedResponse:this.timeToOEmbedResponse,timeToNavigatedToEmbedPage:this.timeToNavigatedToEmbedPage,timeToPostMessagingInitialized:this.timeToPostMessagingInitialized,timeToODSPVideoLoadStart:this.timeToODSPVideoLoadStart,timeToInteractivity:this.timeToInteractivity,timeToFirstPlayIntent:this.timeToFirstPlayIntent,timeToFirstPlay:this.timeToFirstPlay,timeToFirstPlaying:this.timeToFirstPlaying,timeToError:null===(e=this.error)||void 0===e?void 0:e.timestamp,lastBufferTime:this.lastBufferTime,lastSeekTime:this.lastSeekTime,lastPlayTime:this.lastPlayTime,lastPlayingTime:this.lastPlayingTime,totalPlayingTime:this.totalPlayingTime,totalBufferingTime:this.totalBufferingTime,maxTimeSincePlay:this.maxTimeSincePlay,maxTimeSinceSeek:this.maxTimeSinceSeek,currentTimeSincePlay:this.setTimeSincePlay(),currentTimeSinceSeek:this.setTimeSinceSeek(),duration:this.duration,wasPlayedUntilEnd:this.playedUntilEnd,lastVolume:this.volume,lastMuteState:this.isMuted,isPlaying:this.isPlaying,errorName:null===(t=this.error)||void 0===t?void 0:t.name,errorMessage:null===(i=this.error)||void 0===i?void 0:i.message,wasVetoLogged:this.wasVetoLogged}}onSlowPerfError(e,t){const i="Stream2"===this.providerName?"Stream2":"Online",r=i+e;df.error(508699337,`Online video slow perf: ${JSON.stringify({name:r,message:t,app:this.appSettings.App,hostView:this.appSettings.hostView,provider:this.providerName,correlationId:this.correlationId})}`),(void 0===this.error||2<=this.error.severity)&&(this.error={name:r,severity:2,message:t,timestamp:Date.now()}),this.sendVeto(`${i}MediaPerfSlow`,r,t)}clearVideoNotPlayedTimeout(){void 0!==this.videoNotYetPlayedTimeout&&(window.clearTimeout(this.videoNotYetPlayedTimeout),this.videoNotYetPlayedTimeout=void 0)}setTimeSincePlay(){if(void 0===this.lastPlayTime)return;const e=Date.now()-this.lastPlayTime;return this.maxTimeSincePlay=void 0!==this.maxTimeSincePlay?Math.max(this.maxTimeSincePlay,e):e,e}setTimeSinceSeek(){if(void 0===this.lastSeekTime)return;const e=Date.now()-this.lastSeekTime;return this.maxTimeSinceSeek=void 0!==this.maxTimeSinceSeek?Math.max(this.maxTimeSinceSeek,e):e,e}calculateBufferingTime(){if(void 0!==this.lastBufferTime){const e=Date.now()-this.lastBufferTime;void 0===this.totalBufferingTime&&(this.totalBufferingTime=0),this.totalBufferingTime+=e,this.lastBufferTime=void 0}}calculatePlayingTime(){if(void 0!==this.lastPlayingTime){const e=Date.now()-this.lastPlayingTime;this.totalPlayingTime+=e,this.lastPlayingTime=void 0}}sendVeto(e,t,i){this.wasVetoLogged=!0,void 0!==this.onVetoCallback&&this.onVetoCallback(e,t,i,this.correlationId)}logEvent(e){df.info(527983830,`Online video emitted event: ${JSON.stringify({event:e,provider:this.providerName,correlationId:this.correlationId})}`)}}class gp{constructor(e,t,i,r,s){this.providerName="",this.mediaId="",this.vetoLogged=!1,this.slowPlayVetoThreshold=11500,this.notYetPlayedVetoThreshold=11500,this.appSettings=e,this.correlationId=t,void 0!==i&&(this.providerName=i),void 0!==r&&(this.mediaId=r),this.onVetoCallback=s,void 0!==e.SlowPlayVetoThreshold&&(this.slowPlayVetoThreshold=e.SlowPlayVetoThreshold),void 0!==e.NotYetPlayedVetoThreshold&&(this.notYetPlayedVetoThreshold=e.NotYetPlayedVetoThreshold)}get wasVetoLogged(){return this.vetoLogged}getError(){return this.error}setError(e){this.error=e}setProviderName(e){this.providerName=e}setLoggableId(e){this.mediaId=e}onError(e,t,i,r,s,n){const o=this.getPrefix();let a=`${o}VideoError`;i?a=`${o}VideoErrorWhilePlaying`:void 0!==r?a=`${o}VideoErrorAfterPlaying`:"Stream2"===this.providerName&&(e.indexOf("status: 403")>-1?a="Stream2VideoAuthenticationError":(e.indexOf("status: 429")>-1||e.indexOf("status: 408")>-1||e.indexOf("status: 503")>-1)&&(a="Stream2VideoRedemptionStormError"));const l=e.replace(/(?:https?|ftp):\/\/[\S]+/g,"[URL]");df.error(508671629,`Media raised error: ${JSON.stringify({isCritical:t,app:this.appSettings.App,hostView:this.appSettings.hostView,name:a,message:l,provider:this.providerName,correlationId:this.correlationId})}`);const h=t?1:3;(void 0===this.error||h<=this.error.severity)&&(this.error={severity:h,name:a,message:l,timestamp:Date.now()}),t&&(this.clearVideoNotPlayedTimeout(),void 0===s&&void 0===n||this.sendVeto(`${o}MediaPlaybackFailure`,this.error.name,this.error.message))}hasCriticalError(){return void 0!==this.error&&1===this.error.severity}logPlaybackFailure(){if(void 0!==this.error&&1===this.error.severity){const e=this.getPrefix();this.sendVeto(`${e}MediaPlaybackFailure`,this.error.name,this.error.message)}}logIfSlowPlaybackStart(e){this.clearVideoNotPlayedTimeout(),e>this.slowPlayVetoThreshold&&this.onSlowPerfError("VideoPlayedSlow",`Video played after ${e} ms`)}setVideoNotPlayedTimeout(e){this.videoNotYetPlayedTimeout=window.setTimeout((()=>{this.videoNotYetPlayedTimeout=void 0,void 0===e()&&this.onSlowPerfError("VideoNotYetPlayed",`Video hasn't played after ${this.notYetPlayedVetoThreshold} ms`)}),this.notYetPlayedVetoThreshold)}clearVideoNotPlayedTimeout(){void 0!==this.videoNotYetPlayedTimeout&&(window.clearTimeout(this.videoNotYetPlayedTimeout),this.videoNotYetPlayedTimeout=void 0)}cleanup(){this.clearVideoNotPlayedTimeout(),this.error=void 0,this.vetoLogged=!1}onSlowPerfError(e,t){const i=this.getPrefix(),r=i+e;df.error(508671628,`Media slow perf: ${JSON.stringify({name:r,message:t,app:this.appSettings.App,hostView:this.appSettings.hostView,provider:this.providerName,correlationId:this.correlationId})}`),(void 0===this.error||2<=this.error.severity)&&(this.error={name:r,severity:2,message:t,timestamp:Date.now()}),this.sendVeto(`${i}MediaPerfSlow`,r,t)}getPrefix(){return"Local"===this.providerName?"Local":"Stream2"===this.providerName?"Stream2":"Online"}sendVeto(e,t,i){this.vetoLogged=!0,void 0!==this.onVetoCallback&&this.onVetoCallback({vetoName:e,errorName:t,details:i,correlationId:this.correlationId,mediaId:this.mediaId,providerName:this.providerName})}}class vp{constructor(e,t,i,r,s){this.isPlaying=!1;const n=fn();this.baseData={requestGuid:n,providerName:t,loggableMediaId:i,mediaType:r},this.vetoHandler=new gp(e,n,t,i,s)}setLoggableId(e){this.baseData.loggableMediaId=e,this.vetoHandler.setLoggableId(e)}setProviderName(e){this.baseData.providerName=e,this.vetoHandler.setProviderName(e)}setMediaType(e){this.baseData.mediaType=e}setTimeOfCreation(){this.baseData.timeOfCreation=Date.now()}setUiHostType(e){this.baseData.uiHostType=e}setFlights(e){this.baseData.flights=e}onLoadStart(){void 0===this.baseData.timeOfLoadStart&&(this.baseData.timeOfLoadStart=Date.now())}onCanPlay(){this.logEvent("canplay"),void 0===this.baseData.timeOfCanPlay&&(this.baseData.timeOfCanPlay=Date.now(),this.baseData.timeOfPlay=void 0,this.baseData.timeOfPlaying=void 0)}onSourceSet(){void 0===this.baseData.timeOfSourceSet&&(this.baseData.timeOfSourceSet=Date.now())}onPlayRequested(){void 0===this.baseData.timeOfPlayRequest&&(this.baseData.timeOfPlayRequest=Date.now())}onPlay(){this.logEvent("play"),void 0===this.baseData.timeOfPlay&&(this.baseData.timeOfPlay=Date.now(),this.baseData.timeOfPlaying=void 0),this.lastPlayingTime=void 0}onPlaying(){this.logEvent("playing"),void 0===this.baseData.timeOfPlaying&&(this.baseData.timeOfPlaying=Date.now(),void 0!==this.baseData.timeOfPlayRequest&&this.vetoHandler.logIfSlowPlaybackStart(this.baseData.timeOfPlaying-this.baseData.timeOfPlayRequest)),this.isPlaying=!0,this.calculateBufferingTime(),void 0===this.lastPlayingTime&&(this.lastPlayingTime=Date.now())}onPlayCommand(e=!0){if(void 0===this.baseData.timeOfPlaying&&void 0===this.baseData.timeOfPlayRequest){if(this.baseData.timeOfPlayRequest=Date.now(),this.vetoHandler.hasCriticalError())return void this.vetoHandler.logPlaybackFailure();if(e){const e=()=>this.baseData.timeOfPlaying;this.vetoHandler.setVideoNotPlayedTimeout(e)}}}onStopCommand(){void 0===this.baseData.timeOfPlaying&&void 0!==this.baseData.timeOfPlayRequest&&(this.baseData.timeOfPlayRequest=void 0,this.vetoHandler.clearVideoNotPlayedTimeout())}onPause(){this.logEvent("pause"),this.isPlaying=!1,this.calculatePlayingTime()}onEnded(){this.logEvent("ended"),this.isPlaying=!1,this.baseData.wasPlayedUntilEnd=!0,this.calculatePlayingTime()}onVolumeChanged(e){this.logEvent("volumeChanged"),this.baseData.lastVolume=e}onMuteChanged(e){this.logEvent("muteChanged"),this.baseData.lastMuteState=e}onBuffering(){this.logEvent("buffering"),this.isPlaying=!1,this.calculatePlayingTime(),void 0===this.lastBufferTime&&(this.lastBufferTime=Date.now())}onError(e,t=!1){this.logEvent("error"),this.vetoHandler.onError(e,t,this.isPlaying,this.baseData.timeOfPlaying,this.baseData.timeOfPlayRequest,this.baseData.timeOfCanPlay)}cleanup(){this.baseData.timeOfCreation=void 0,this.baseData.timeOfSourceSet=void 0,this.baseData.timeOfLoadStart=void 0,this.baseData.timeOfCanPlay=void 0,this.baseData.timeOfPlayRequest=void 0,this.baseData.timeOfPlay=void 0,this.baseData.timeOfPlaying=void 0,this.baseData.timeOfError=void 0,this.baseData.totalPlayingTime=0,this.baseData.totalBufferingTime=0,this.baseData.lastVolume=void 0,this.baseData.lastMuteState=void 0,this.baseData.wasPlayedUntilEnd=void 0,this.baseData.errorName=void 0,this.baseData.errorMessage=void 0,this.baseData.wasVetoLogged=void 0,this.isPlaying=!1,this.lastBufferTime=void 0,this.lastPlayingTime=void 0,this.vetoHandler.cleanup(),this.baseData.requestGuid=fn()}getPlaybackData(){const e=this.vetoHandler.getError();return this.baseData.errorName=null==e?void 0:e.name,this.baseData.errorMessage=null==e?void 0:e.message,this.baseData.timeOfError=null==e?void 0:e.timestamp,this.baseData.wasVetoLogged=this.vetoHandler.wasVetoLogged,this.calculatePlayingTime(),this.calculateBufferingTime(),this.baseData}setViewDimensions(e,t){this.baseData.viewWidth=e,this.baseData.viewHeight=t}setMediaId(e){this.baseData.loggableMediaId=e}setDuration(e){this.baseData.duration=e}setVolume(e){this.baseData.lastVolume=e}setIsMuted(e){this.baseData.lastMuteState=e}logEvent(e){df.info(508704415,`Media emitted event: ${JSON.stringify({event:e,provider:this.baseData.providerName,requestGuid:this.baseData.requestGuid})}`)}calculateBufferingTime(){if(void 0!==this.lastBufferTime){const e=Date.now()-this.lastBufferTime;void 0===this.baseData.totalBufferingTime&&(this.baseData.totalBufferingTime=0),this.baseData.totalBufferingTime+=e,this.lastBufferTime=void 0}}calculatePlayingTime(){if(void 0!==this.lastPlayingTime){const e=Date.now()-this.lastPlayingTime;void 0===this.baseData.totalPlayingTime&&(this.baseData.totalPlayingTime=0),this.baseData.totalPlayingTime+=e,this.lastPlayingTime=void 0}}}class _p extends vp{constructor(e,t,i,r){super(e,t,i,t,r),this.onlineData={}}getPlaybackData(){return Object.assign(Object.assign({},super.getPlaybackData()),this.onlineData)}onHubbleTokenSet(){void 0===this.onlineData.timeOfHubbleToken&&(this.onlineData.timeOfHubbleToken=Date.now())}onOEmbedResponse(){void 0===this.onlineData.timeOfOEmbedResponse&&(this.onlineData.timeOfOEmbedResponse=Date.now())}onNavigatedToEmbedPage(){void 0===this.onlineData.timeOfNavigatedToEmbedPage&&(this.onlineData.timeOfNavigatedToEmbedPage=Date.now())}onPostMessagingInitialized(){void 0===this.onlineData.timeOfPostMessagingInitialized&&(this.onlineData.timeOfPostMessagingInitialized=Date.now())}onODSPVideoLoad(e){void 0===this.baseData.timeOfLoadStart&&(this.baseData.timeOfLoadStart=Date.now()-e)}onVideoElementStopPlaying(){const e=this.baseData.lastVolume,t=this.baseData.lastMuteState,i=this.vetoHandler.getError();this.cleanup(),void 0!==e&&this.setVolume(e),void 0!==t&&this.setIsMuted(t),void 0!==i&&this.vetoHandler.setError(i)}onPlayCommand(){const e="Other"!==this.baseData.providerName&&"Ted"!==this.baseData.providerName&&"SlideShare"!==this.baseData.providerName;super.onPlayCommand(e)}onPauseCommand(){void 0===this.baseData.timeOfPlaying&&void 0!==this.baseData.timeOfPlayRequest&&(this.baseData.timeOfPlayRequest=void 0,this.vetoHandler.clearVideoNotPlayedTimeout())}cleanup(){this.onlineData.timeOfHubbleToken=void 0,this.onlineData.timeOfOEmbedResponse=void 0,this.onlineData.timeOfPostMessagingInitialized=void 0,super.cleanup()}}class yp extends vp{constructor(e,t,i,r){super(e,"Local",t,i,r),this.isFirstCanPlay=!0,this.isFirstCanPlayThrough=!0,this.isFirstPlay=!0,this.useLoadedMetadataAsInteractivityEvent=!1,this.localData={},this.useLoadedMetadataAsInteractivityEvent=cf.getBoolean("useLoadedMetadataAsInteractivityEvent")}onLoadStart(){this.localData.timeOfLoadedMetadata=void 0,this.localData.timeOfCanPlayThrough=void 0,super.onLoadStart()}onLoadedMetadata(){void 0===this.localData.timeOfLoadedMetadata&&(this.localData.timeOfLoadedMetadata=Date.now(),this.useLoadedMetadataAsInteractivityEvent?this.baseData.timeOfCanPlay=this.localData.timeOfLoadedMetadata:this.baseData.timeOfCanPlay=void 0,this.baseData.timeOfPlay=void 0,this.baseData.timeOfPlaying=void 0)}onCanPlay(){this.isFirstCanPlay&&this.isFirstCanPlayThrough&&(this.useLoadedMetadataAsInteractivityEvent||super.onCanPlay(),this.isFirstCanPlay&&(this.isFirstCanPlay=!1,this.isFirstCanPlayThrough||df.error(508695704,`The 'canplaythrough' event was triggered before triggering the 'canplay' event on media: ${this.baseData.loggableMediaId}`)),super.onCanPlay())}onCanPlayThrough(){this.isFirstCanPlayThrough&&(this.isFirstCanPlayThrough=!1,this.localData.timeOfCanPlayThrough=Date.now(),this.isFirstCanPlay&&df.error(508704418,`No 'canplay' event was triggered before triggering the 'canplaythrough' event on media: ${this.baseData.loggableMediaId}`))}onPlay(){super.onPlay(),this.isFirstPlay&&(this.isFirstPlay=!1,this.isFirstCanPlay&&df.error(508704417,`No 'canplay' event was triggered before triggering the 'play' event on media: ${this.baseData.loggableMediaId}`))}onStalled(){this.isPlaying&&(void 0===this.localData.numberOfStalls?this.localData.numberOfStalls=1:this.localData.numberOfStalls+=1)}cleanup(){this.isFirstCanPlay=!0,this.isFirstCanPlayThrough=!0,this.isFirstPlay=!0,super.cleanup()}getPlaybackData(){return Object.assign(Object.assign({},super.getPlaybackData()),this.localData)}setSrcDimensions(e,t){this.localData.sourceVideoWidth=e,this.localData.sourceVideoHeight=t}setMediaExtension(e){this.localData.mediaExtension=e}setContentType(e){this.localData.contentType=e}setMediaLength(e){this.localData.mediaLength=e}setRetriesLeft(e){this.localData.retriesLeft=e}setIsUsingPlaybackControls(){this.localData.isUsingPlaybackControls=!0}}class bp{constructor(e,t,i,r,s,n,o,a,l,h,c){if(this.playbackStarted=!1,this.appSettings=o,this.isNativeVideo=r,this.isDesignerElement=s,this.parent=e,this.url=t,this.trackList=[],this.videoToolTip=i,this.videoLibraryCallback=n,this.playButton=this.createPlayButton(c),this.playButtonHandler=new fp(this.parent,this.playButton,this.appSettings),this.onTokenRequestCallback=l,this.createOnlineClient=a,df.info(541882006,"Video Element Count"),this.isDesignerElement&&this.startPlaying(!1),void 0!==(null==h?void 0:h.tracksInfo)&&null!==(null==h?void 0:h.tracksInfo)&&(this.trackList=h.tracksInfo.trackList),this.isNativeVideo)this.mediaType="Local",cf.getBoolean("UseSharedTelemetryForLocalMedia")&&(this.localClientPlaybackTracker=new yp(this.appSettings,"","Video",(e=>{this.onClientMediaVeto(e)})));else{const e=function(e){for(const[t,i]of Object.entries(mf))for(const r of i)if(new RegExp(r).test(e))return t;df.error(512271065,"Error getting provider name from URL (scheme not found in ONLINE_PROVIDER_URL_SCHEMES)")}(this.url);this.mediaType=void 0!==e?e:"Stream2",this.onlineClientPerfTracker=new mp(this.appSettings,((e,t,i,r)=>this.onClientVeto(e,t,i,r))),!0===o.useNewOnlineTelemetry&&(this.onlineClientPlaybackTracker=new _p(this.appSettings,e,void 0,(e=>{this.onClientMediaVeto(e)})))}!0===o.preLoadLocalVideo&&this.preLoadLocalVideo()}preLoadLocalVideo(){void 0===this.client&&this.createClient(this.url,!1)}preLoadLocalVideoClient(e,t){this.url=t,void 0!==(null==e?void 0:e.tracksInfo)&&null!==(null==e?void 0:e.tracksInfo)&&(this.trackList=e.tracksInfo.trackList),void 0===this.client&&this.createClient(this.url,!1)}setPlayButtonHidden(){void 0!==this.playButtonHandler&&this.playButtonHandler.setPlayButtonHidden()}updatePlayButtonVisibility(){this.playbackStarted||void 0===this.playButtonHandler||this.playButtonHandler.updatePlayButtonVisibility()}setPlayButtonVisible(){this.playbackStarted||void 0===this.playButtonHandler||this.playButtonHandler.setPlayButtonVisible()}activate(e,t,i){var r;return this.isNativeVideo&&""===this.url?(this.setPlayButtonHidden(),this.playbackStarted=!0,this.videoLibraryCallback.fetchLocalVideoSrc(e,t,i),!1):(void 0===this.client?this.createClient(this.url,e):(!this.playbackStarted||void 0!==this.client.isPaused&&null!==(r=this.client.isPaused())&&void 0!==r&&r)&&(this.client.setVisible(),e&&this.client.play(),this.setDefaultStyles(),e&&this.videoLibraryCallback.onPlaybackStarted()),void 0!==this.client&&(this.playbackStarted=!0),df.info(541882007,"Video Play Count"),this.setPlayButtonHidden(),!0)}startPlaying(e){return this.activate(!0,!1,void 0!==e&&e)}stopPlaying(){void 0!==this.client&&this.playbackStarted&&(this.isNativeVideo||void 0===this.onlineClientPerfTracker||(df.info(509384070,`OnlineVideoPlayback Summary: ${JSON.stringify(this.onlineClientPerfTracker.getPerfData())}`),this.onlineClientPerfTracker.onStopCommand()),this.isNativeVideo||void 0===this.onlineClientPlaybackTracker||(df.info(508360775,`OnlineVideoPlayback Summary: ${JSON.stringify(this.onlineClientPlaybackTracker.getPlaybackData())}`),this.onlineClientPlaybackTracker.onStopCommand()),this.isNativeVideo&&void 0!==this.localClientPlaybackTracker&&(df.info(508118040,`LocalMediaPlayback Summary: ${JSON.stringify(this.localClientPlaybackTracker.getPlaybackData())}`),this.localClientPlaybackTracker.onStopCommand()),this.client.setHidden(),this.client.stop()),this.playbackStarted=!1}hasPlaybackStarted(){return this.playbackStarted}hasClient(){return void 0!==this.client}setLocalVideoSrc(e,t){this.appSettings.preLoadLocalVideo=!1,this.appSettings.preLoadLocalVideoClient=!1,this.url=e,(this.videoLibraryCallback.isSelected()||this.isDesignerElement)&&this.activate(void 0===t||t,!1,!1)}setLocalVideoAndCaptionsSrc(e,t){null!=e&&(void 0!==e.tracksInfo&&null!==e.tracksInfo&&(this.trackList=e.tracksInfo.trackList),this.setLocalVideoSrc(e.src,t))}onSelectPlayButton(){void 0!==this.playButtonHandler&&this.playButtonHandler.onSelectPlayButton()}onDeSelectPlayButton(){void 0!==this.playButtonHandler&&this.playButtonHandler.onDeSelectPlayButton()}dispose(){null!==this.playButton&&void 0!==this.playButton&&null!==this.playButton.parentNode&&void 0!==this.playButton.parentNode&&this.playButton.parentNode.removeChild(this.playButton)}setDefaultStyles(){if(void 0!==this.client){const e=this.client.getPlayer();void 0!==e&&op(e)}}createClient(e,t){if(this.isNativeVideo)try{this.client=new up(this.parent,e,this.isDesignerElement,void 0!==this.videoLibraryCallback&&void 0!==(i=this.videoLibraryCallback.getMediaProperties())?{trimStartSec:void 0!==i.trimStartSec?i.trimStartSec:0,trimEndSec:void 0!==i.trimEndSec?i.trimEndSec:0,volume:void 0!==i.volume?i.volume:.8,mute:void 0!==i.mute&&i.mute,repeat:void 0!==i.repeat&&i.repeat,rewind:void 0!==i.rewind&&i.rewind,playAcrossSlides:void 0!==i.playAcrossSlides&&i.playAcrossSlides,hideDuringShow:void 0!==i.hideDuringShow&&i.hideDuringShow,startOption:void 0!==i.startOption?i.startOption:"NYI",elementId:void 0!==i.elementId?i.elementId:"",trimmedEndTimeSec:void 0,durationSec:void 0,loggableId:void 0,mediaType:void 0,contentType:void 0,autoPlay:void 0===i.autoPlay||i.autoPlay,preload:i.preload,playsInline:void 0,crossOrigin:void 0,useCustomControls:void 0,controls:void 0===i.controls||i.controls,handleTimeUpdate:void 0,zIndex:void 0,height:void 0,width:void 0,styles:void 0,attributes:void 0}:{trimStartSec:0,trimEndSec:0,volume:.8,mute:!1,repeat:!1,rewind:!1,playAcrossSlides:!1,hideDuringShow:!1,startOption:"NYI",trimmedEndTimeSec:void 0,durationSec:void 0,loggableId:void 0,elementId:void 0,mediaType:void 0,contentType:void 0,autoPlay:!1,preload:void 0,playsInline:!1,crossOrigin:"anonymous",controls:!0,useCustomControls:!1,handleTimeUpdate:!1,zIndex:"6",height:void 0,width:void 0,styles:void 0,attributes:void 0},this.appSettings.useNewLocalTelemetry,this.appSettings.preLoadLocalVideo,this.appSettings.preLoadLocalVideoClient,this.localClientPlaybackTracker,void 0,this.trackList),t&&(this.client.play(),this.videoLibraryCallback.onPlaybackStarted()),this.appSettings.preLoadLocalVideoClient||(this.playbackStarted=!0)}catch(e){return df.info(541882008,`Error creating local video client: ${e.message}`),void(void 0!==this.localClientPlaybackTracker&&this.localClientPlaybackTracker.onError(`Error creating local video client: ${e.message}`,!0))}else try{if(void 0===this.createOnlineClient)throw new Error("Non native video not supported.");this.client=this.createOnlineClient(e,this.parent,this.appSettings,void 0,this.onlineClientPerfTracker,this.onlineClientPlaybackTracker,(()=>this.onClientReady()),void 0,this.onTokenRequestCallback)}catch(e){return void 0!==this.onlineClientPerfTracker&&this.onlineClientPerfTracker.onError(`Error creating online video client: ${e.message}`,!0),void(void 0!==this.onlineClientPlaybackTracker&&this.onlineClientPlaybackTracker.onError(`Error creating online video client: ${e.message}`,!0))}var i;const r=this.client.getPlayer();void 0!==r&&r.setAttribute("title",this.videoToolTip),df.info(541882009,"Success VideoManager")}onClientReady(){void 0!==this.client&&this.client.play()}onClientVeto(e,t,i,r){df.error(509202786,`Veto raised for video: ${JSON.stringify({vetoName:e,errorName:t,details:i,correlationId:r,mediaType:this.mediaType})}`)}onClientMediaVeto(e){df.error(508360774,`Veto raised for video: ${JSON.stringify({vetoName:e.vetoName,errorName:e.errorName,details:e.details,correlationId:e.correlationId,mediaType:this.mediaType})}`)}playButtonOnClick(e){void 0!==e&&(e.stopImmediatePropagation(),e.preventDefault()),void 0!==this.onlineClientPerfTracker&&this.onlineClientPerfTracker.onPlayCommand(),void 0!==this.onlineClientPlaybackTracker&&this.onlineClientPlaybackTracker.onPlayCommand(),void 0!==this.localClientPlaybackTracker&&this.localClientPlaybackTracker.onPlayCommand(),this.videoLibraryCallback.selectShape(),this.startPlaying(!1)}createPlayButton(e){let t;return t=!0===this.appSettings.playButtonHoverOverlayEnabled||cf.getBoolean("PlayButtonHoverOverlayEnabled")?function(e,t){const i=pp("svg");!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?i.setAttribute("viewBox","-48 -48 96 96"):i.setAttribute("viewBox","-30 -30 60 60"),i.setAttribute("role","button"),i.setAttribute(yf,null!=t?t:"Play"),!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?Of(i,{height:"96px",width:"96px",position:"absolute",zIndex:"6",top:"calc(50% - 48px)",left:"calc(50% - 48px)",cursor:"pointer",pointerEvents:"all"}):Of(i,{height:"60px",width:"60px",position:"absolute",zIndex:"6",top:"calc(50% - 30px)",left:"calc(50% - 30px)",cursor:"pointer",pointerEvents:"all"}),i.setAttribute("fill","none");const r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("filter","url(#filter0_b_4190_2652)");const s=pp("circle");s.setAttribute("id","circle1"),s.setAttribute("cx","0"),s.setAttribute("cy","0"),!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?s.setAttribute("r","40"):s.setAttribute("r","28.3"),s.setAttribute("fill","black"),s.setAttribute("fill-opacity","0.42");const n=pp("circle");n.setAttribute("id","circle2"),n.setAttribute("cx","0"),n.setAttribute("cy","0"),!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?n.setAttribute("r","39.5"):n.setAttribute("r","27.5"),n.setAttribute("stroke","white"),n.setAttribute("stroke-opacity","0.42");const o=pp("path");!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?o.setAttribute("d","M8 11.2761C8 8.0368 11.4656 5.97709 14.3109 7.52531L37.7709 20.2903C40.743 21.9075 40.743 26.1745 37.7709 27.7918L14.3109 40.5568C11.4656 42.1049 8 40.0452 8 36.806V11.2761Z"):o.setAttribute("d","M5.6 7.85427C5.6 5.62576 8.02512 4.21299 9.99663 5.26774L26.43963 14.20121C28.1361 15.29325 28.1361 17.64875 26.43963 18.74079L9.99663 27.67426C8.02512 28.72901 5.6 27.31624 5.6 25.08773V7.85427Z"),o.setAttribute("fill","white"),!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?o.setAttribute("transform","translate(-20, -24)"):o.setAttribute("transform","translate(-15, -16.5)"),r.appendChild(s),r.appendChild(n),r.appendChild(o);const a=document.createElementNS("http://www.w3.org/2000/svg","defs"),l=document.createElementNS("http://www.w3.org/2000/svg","filter");l.setAttribute("id","filter0_b_4190_2652"),!0===e.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?(l.setAttribute("x","-48"),l.setAttribute("y","-48"),l.setAttribute("width","96"),l.setAttribute("height","96")):(l.setAttribute("x","-30"),l.setAttribute("y","-30"),l.setAttribute("width","60"),l.setAttribute("height","60")),l.setAttribute("filterUnits","userSpaceOnUse"),l.setAttribute("color-interpolation-filters","sRGB");const h=pp("feFlood");h.setAttribute("flood-opacity","0"),h.setAttribute("result","BackgroundImageFix");const c=pp("feGaussianBlur");c.setAttribute("in","BackgroundImageFix"),c.setAttribute("stdDeviation","2");const d=pp("feComposite");d.setAttribute("in2","SourceAlpha"),d.setAttribute("operator","in"),d.setAttribute("result","effect1_backgroundBlur_4204_2652");const u=pp("feBlend");return u.setAttribute("mode","normal"),u.setAttribute("in","SourceGraphic"),u.setAttribute("in2","effect1_backgroundBlur_4204_2652"),u.setAttribute("result","shape"),l.appendChild(h),l.appendChild(c),l.appendChild(d),l.appendChild(u),a.appendChild(l),i.appendChild(r),i.appendChild(a),i}(this.appSettings,e):function(e){const t=pp("svg");t.setAttribute("viewBox","-1 -1 2 2"),t.setAttribute("role","button"),t.setAttribute(yf,null!=e?e:"Play"),Of(t,{height:"56.6px",width:"56.6px",position:"absolute",zIndex:"6",top:"calc(50% - 28.3px)",left:"calc(50% - 28.3px)",cursor:"pointer",pointerEvents:"all"});const i=pp("circle");i.setAttribute("cx","0"),i.setAttribute("cy","0"),i.setAttribute("r","1"),i.setAttribute("fill","#404040");const r=pp("path");return r.setAttribute("d","M.5 0 L-.25 -.5 L-.25 .5 Z"),r.setAttribute("fill","none"),r.setAttribute("stroke","white"),r.setAttribute("stroke-width",".05"),r.setAttribute("opacity",".5"),t.appendChild(i),t.appendChild(r),t}(e),t.addEventListener("click",(e=>this.playButtonOnClick(e)),!1),this.isDesignerElement&&t.setAttribute("visibility","hidden"),(!0===this.appSettings.playButtonHoverOverlayEnabled||cf.getBoolean("PlayButtonHoverOverlayEnabled"))&&function(e,t,i){const r=e.querySelector(".overlay");r&&e.removeChild(r),0===e.offsetWidth&&Of(e,{width:"100%"}),0===e.offsetHeight&&Of(e,{height:"100%"});const s=document.createElement("div");s.className="overlay",s.style.display="none",s.setAttribute("aria-hidden","true");const n=t.querySelector("g");n.addEventListener("mouseover",(()=>{const r=t.getElementById("circle1"),n=t.getElementById("circle2");r.style.transition="r 0.2s ease, fill 0.2s ease, opacity 0.2s ease",r.setAttribute("cx","0"),r.setAttribute("cy","0"),!0===i.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?r.setAttribute("r","48"):r.setAttribute("r","30"),r.setAttribute("fill","black"),r.setAttribute("fill-opacity","0.42"),n.style.transition="r 0.2s ease, fill 0.2s ease, opacity 0.2s ease",n.setAttribute("cx","0"),n.setAttribute("cy","0"),!0===i.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?n.setAttribute("r","47.5"):n.setAttribute("r","29.5"),n.setAttribute("stroke","white"),n.setAttribute("stroke-opacity","0.42"),s.style.position="absolute",s.style.width=`${e.offsetWidth}px`,s.style.height=`${e.offsetHeight}px`,s.style.backgroundColor="rgba(0, 0, 0, 0.4)",s.style.zIndex="5",s.style.display="block"})),n.addEventListener("mouseleave",(()=>{const e=t.getElementById("circle1"),r=t.getElementById("circle2");e.style.transition="r 0.2s ease, fill 0.2s ease, opacity 0.2s ease",e.setAttribute("cx","0"),e.setAttribute("cy","0"),!0===i.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?e.setAttribute("r","40"):e.setAttribute("r","28.3"),e.setAttribute("fill","black"),e.setAttribute("fill-opacity","0.42"),r.style.transition="r 0.2s ease, fill 0.2s ease, opacity 0.2s ease",r.setAttribute("cx","0"),r.setAttribute("cy","0"),!0===i.playButtonIconUpdateEnabled||cf.getBoolean("PlayButtonIconUpdateEnabled")?r.setAttribute("r","39.5"):r.setAttribute("r","27.5"),r.setAttribute("stroke","white"),r.setAttribute("stroke-opacity","0.42"),s.style.display="none"})),e.appendChild(s)}(this.parent,t,this.appSettings),this.parent.appendChild(t),t}}function wp(e,t,i){const{sourceAnchorBounds:r,targetBounds:s,rotation:n,flip:o}=t,a=i.size.width/r.width(),l=i.size.height/r.height(),h=s.width(),c=s.height(),d=i.size.width,u=i.size.height;e.setAttribute("width",`${h}`),e.setAttribute("height",`${c}`);const f=`rotate(${n})scale(${a} ${l})scale(${i.flip.x!==o.x?-1:1} ${i.flip.y!==o.y?-1:1})rotate(${-n})rotate(${i.rot-n})translate(${s.left} ${s.top})translate(${-d/(2*a)} ${-u/(2*l)})`;e.setAttribute("transform",f)}class Tp extends sf{constructor(e=Ju("image")){super(e)}set width(e){this.set("width",`${e}`)}set height(e){this.set("height",`${e}`)}set x(e){this.set("x",`${e}`)}set y(e){this.set("y",`${e}`)}set preserveAspectRatio(e){this.set("preserveAspectRatio",e)}set href(e){this.set("href",e)}}class xp extends sf{constructor(e=Ju("foreignObject")){super(e)}set width(e){this.set("width",`${e}`)}set height(e){this.set("height",`${e}`)}set x(e){this.set("x",`${e}`)}set y(e){this.set("y",`${e}`)}appendChildElement(e){this.element.appendChild(e)}}class Cp extends sf{constructor(e=Ju("g")){super(e)}set width(e){this.set("width",`${e}`)}set height(e){this.set("height",`${e}`)}set x(e){this.set("x",`${e}`)}set y(e){this.set("y",`${e}`)}}function Pp(e,t){if(void 0===t||!td(t))return;const i=new Tp;return wp(i.element,t,e),i.href=t.data,i.preserveAspectRatio="none",i.style.pointerEvents="none",Ep(i.element,e)}function Sp(e,t,i,r,s){const{size:n,flip:o,rot:a}=e,{width:l,height:h}=n,c=new xp;return c.width=l*i.x,c.height=h*i.y,c.transform.set({x:-l/2-r.x,y:-h/2-r.y},o,a,{x:0,y:0}),c.element.appendChild(t),[Ep(c.element,e),Pp(e,s)]}function Ep(e,t){const i=new Cp,{x:r,y:s}=t.getCenter();return i.transform.setTranslate(r,s),i.element.appendChild(e),i.element}class Mp{}class Rp{constructor(){this.type=Mp,this.pointerEventNotifiers=d(),this.hitTestSlop=0,this.video=Vd("svg"),this.control=document.createElement("div"),this.video.style.overflow="visible",this.video.style.pointerEvents="none",this.control.style.position="absolute",this.control.style.top="0",this.control.style.left="0",l("resizeMediaOnSlideScaling")?this.control.style.pointerEvents="none":this.control.style.pointerEvents="auto",this.control.style.zIndex="100"}teardown(){}}function Bp(e,t){t.root.append(e.video),t.root.append(e.control)}let Ip,Ap=!1;class Fp{constructor(e,t,i,r,s,n){if(this.viewModel=new Rp,this.viewModelUpdated=new c,this.shapeViewModel=new lu,this.url="",this.isVideoSelected=!1,this.properties={},this.preLoad=!1,this.shouldPreLoad=!1,this.shouldPreLoadVideoClient=!1,this.select=()=>{void 0!==this.editContext&&this.editContext.actionInvoker.invoke(new th([this.graphic]))},this.fetchSource=(e,t,i)=>{void 0===this.provider&&(0,y._)(0,"Failed to obtain video provider"),this.videoOOBClosedCaptionsPlaybackInEditorEnabled?this.provider.getVideoAndCaptionsSource(this.graphic).then((r=>{var s,n,o;null!=r&&null!==r.src?(this.preLoad=!1,null===(s=this.videoElement)||void 0===s||s.setLocalVideoAndCaptionsSrc(r,e),this.extractHtmlVideo(),this.showControls(),void 0!==i&&i&&(null===(n=this.controls)||void 0===n||n.focusPlayButton()),void 0!==t&&t&&(null===(o=this.controls)||void 0===o||o.toggleCaptionsMenu("Shortcut"))):this.stopPlaying()})).catch((e=>{(0,T.H)(0,"Failed to fetch video source"),this.stopPlaying()})):this.provider.getSource(this.graphic).then((e=>{var t;null!==e?(null===(t=this.videoElement)||void 0===t||t.setLocalVideoSrc(e),this.extractHtmlVideo(),this.showControls()):this.stopPlaying()})).catch((e=>{(0,T.H)(0,"Failed to fetch video source"),this.stopPlaying()}))},this.initializeVideoElement=()=>{if(void 0===this.provider&&(0,y._)(0,"Failed to obtain video provider"),this.shouldPreLoadVideoClient){const e={useNewLocalTelemetry:!0,preLoadLocalVideo:!1,preLoadLocalVideoClient:!0};this.createVideoElement(e)}this.videoOOBClosedCaptionsPlaybackInEditorEnabled?this.provider.getVideoAndCaptionsSource(this.graphic).then((e=>{var t;if(null!=e&&null!==e.src){if(this.url=e.src,this.videoAndCaptionsSource=e,this.shouldPreLoadVideoClient)null===(t=this.videoElement)||void 0===t||t.preLoadLocalVideoClient(this.videoAndCaptionsSource,this.url);else{const e={useNewLocalTelemetry:!0,preLoadLocalVideo:!0,preLoadLocalVideoClient:!1};this.createVideoElement(e)}this.extractHtmlVideo(),this.fixHtmlVideo(),this.shouldPreLoadVideoClient&&this.teardownControls(),this.ensureControl()}else this.stopPlaying()})).catch((e=>{(0,T.H)(0,"Failed to fetch video source"),this.stopPlaying()})):this.provider.getSource(this.graphic).then((e=>{var t;if(null!==e){if(this.url=e,this.videoAndCaptionsSource=void 0,this.shouldPreLoadVideoClient)null===(t=this.videoElement)||void 0===t||t.preLoadLocalVideoClient(void 0,this.url);else{const e={useNewLocalTelemetry:!0,preLoadLocalVideo:!0,preLoadLocalVideoClient:!1};this.createVideoElement(e)}this.extractHtmlVideo(),this.fixHtmlVideo(),this.shouldPreLoadVideoClient&&this.teardownControls(),this.ensureControl()}else this.stopPlaying()})).catch((e=>{(0,T.H)(0,"Failed to fetch video source"),this.stopPlaying()}))},this.onTransformUpdated=()=>{l("CorrectMisalignedVideoControls")&&this.setTransform(),this.stopPlaying(),this.renderVideoToViewModel()},this.onModelUpdated=()=>{this.updateViewModel(),this.videoOOBClosedCaptionsPlaybackInEditorEnabled&&(null==Ip||Ip.hide())},this.stopPlaying=()=>{var e,t,i;null===(e=this.videoElement)||void 0===e||e.stopPlaying(),null===(t=this.videoElement)||void 0===t||t.updatePlayButtonVisibility(),null===(i=this.controls)||void 0===i||i.hide(),this.shouldPreLoad&&this.shouldPreLoadVideoClient&&(this.teardownControls(),this.ensureControl()),this.videoOOBClosedCaptionsPlaybackInEditorEnabled&&(null==Ip||Ip.hide())},this.recreateControls=()=>{this.teardownControls(),this.shouldPreLoad?(this.fixHtmlVideo(),this.ensureControl(),l("DontStopVideo")||this.stopPlaying()):this.showControls()},this.showControls=()=>{var e;this.fixHtmlVideo(),this.shouldPreLoad&&this.preLoad||this.ensureControl(),null===(e=this.controls)||void 0===e||e.show()},this.graphic=e,this.context=t,this.registry=i,this.videoOOBClosedCaptionsPlaybackInEditorEnabled=r,this.editContext=s,this.provider=n,this.model=e.model,this.container=document.createElement("div"),cf={getBoolean:e=>l(e),getNumber:e=>{},getString:e=>{}},this.shouldPreLoad=l("PreLoadLocalVideo"),this.shouldPreLoadVideoClient=!l("DontPreLoadLocalVideoClient"),this.shouldPreLoad&&this.shouldPreLoadVideoClient&&(this.video=[this.container,void 0]),this.model.modelUpdated.on(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.on(this.onTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onTransformUpdated),this.context.viewScale.combinedScaleChanged.on(this.onTransformUpdated),df={info:(e,t)=>{(0,T.PN)(e,t)},warn:(e,t)=>{(0,T.KE)(e,t)},error:(e,t)=>{(0,T.H)(e,t)}},this.shouldPreLoad?(this.preLoad=!0,this.initializeVideoElement()):this.updateViewModel(),!Ap&&this.properties.controlCssUrl){Ap=!0;const e=document.createElement("link");e.rel="stylesheet",e.href=this.properties.controlCssUrl,document.head.appendChild(e)}}static getLocalizedStrings(){return"undefined"!=typeof PowerpointSlideshowStrings?{progressBarStr:PowerpointSlideshowStrings.CustomControlAccessibilityLabelProgressBar,playButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelPlayButton,pauseButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelPauseButton,muteButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelMuteButton,unmuteButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelUnmuteButton,volumeSliderStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelVolumeSlider,localizedLabelsStr:[PowerpointSlideshowStrings.CustomControlsAccessibilityLabelHour,PowerpointSlideshowStrings.CustomControlsAccessibilityLabelHours,PowerpointSlideshowStrings.CustomControlsAccessibilityLabelMinute,PowerpointSlideshowStrings.CustomControlsAccessibilityLabelMinutes,PowerpointSlideshowStrings.CustomControlsAccessibilityLabelSecond,PowerpointSlideshowStrings.CustomControlsAccessibilityLabelSeconds],localizedTimeStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelVideoTime,progressStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelVideoProgress,captionsButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelClosedCaptionsButton,speedButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelPlaybackSpeedButton,fullScreenButtonStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelFullScreenButton,captionsMenuStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelClosedCaptionsMenu,captionsMenuOffOptionStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelClosedCaptionsMenuOffOption,speedMenuOptionStr:PowerpointSlideshowStrings.CustomControlsAccessibilityLabelPlaybackSpeedMenuOption}:{progressBarStr:"Video Progress Bar",playButtonStr:"Video Play",pauseButtonStr:"Video Pause",muteButtonStr:"Video Mute",unmuteButtonStr:"Video Unmute",volumeSliderStr:"Volume Level Slider",localizedLabelsStr:["hour","hours","minute","minutes","second","seconds"],localizedTimeStr:"{0} {1} {2} {3} {4} {5}",progressStr:"{0} of {1}",captionsButtonStr:"Video Closed Captions",speedButtonStr:"Video Playback Speed",fullScreenButtonStr:"Video Full Screen",captionsMenuStr:"Video Closed Captions Menu",captionsMenuOffOptionStr:"Off",speedMenuOptionStr:"{0}x"}}static getTooltipMap(){return"undefined"!=typeof PowerpointSlideshowStrings?new Map([["Play",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelPlay)],["Pause",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelPause)],["Mute",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelMute)],["Unmute",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelUnmute)],["Captions",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelCaptions)],["Captions disabled",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelCaptionsDisabled)],["Seek",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelSeek)],["Playback speed",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelSpeed)],["Volume slider",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelVolumeSlider)],["Full screen",new ep("","",PowerpointSlideshowStrings.CustomControlsTooltipLabelFullScreen)]]):new Map([["Play",new ep("","","Play")],["Pause",new ep("","","Pause")],["Mute",new ep("","","Mute")],["Unmute",new ep("","","Unmute")],["Captions",new ep("","","Show closed captions")],["Captions disabled",new ep("","","Video does not contain closed captions")],["Seek",new ep("","","Play from here")],["Playback speed",new ep("","","Set playback speed")],["Volume slider",new ep("","","Adjust volume")],["Full screen",new ep("","","Full screen")]])}set isSelected(e){this.isVideoSelected=e,e||(this.stopPlaying(),this.viewModelUpdated.emit())}playPause(){var e,t,i,r;!1===(null===(e=this.htmlVideo)||void 0===e?void 0:e.paused)?null===(t=this.videoElement)||void 0===t||t.stopPlaying():(null===(i=this.videoElement)||void 0===i||i.startPlaying(!0),null===(r=this.controls)||void 0===r||r.focusPlayButton())}toggleCaptionsMenu(){var e,t;(null===(e=this.videoElement)||void 0===e?void 0:e.activate(!1,!0,!1))&&(this.showControls(),null===(t=this.controls)||void 0===t||t.toggleCaptionsMenu("Shortcut"))}teardown(){var e;this.model.modelUpdated.off(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.off(this.onTransformUpdated),this.context.viewScale.viewTransformChanged.off(this.onTransformUpdated),this.context.viewScale.combinedScaleChanged.off(this.onTransformUpdated),this.teardownControls(),void 0!==this.video&&(null===(e=this.videoElement)||void 0===e||e.dispose())}createVideoElement(e){var t,i,r;void 0!==this.video&&(null===(t=this.videoElement)||void 0===t||t.dispose(),this.container=document.createElement("div")),this.properties=null!==(r=null===(i=this.provider)||void 0===i?void 0:i.getProperties(this.graphic))&&void 0!==r?r:{};const{source:s,looping:n,altText:o}=this.graphic.model;this.videoElement=new bp(this.container,this.url,o,s.isNative,n,{isSelected:()=>this.isVideoSelected,selectShape:this.select,fetchLocalVideoSrc:this.fetchSource,getMediaProperties:()=>this.properties,onPlaybackStarted:()=>{this.videoOOBClosedCaptionsPlaybackInEditorEnabled&&this.ensureCaptionsRenderer()}},e,void 0,void 0,this.videoAndCaptionsSource,"undefined"!=typeof PowerpointSlideshowStrings?PowerpointSlideshowStrings.CustomControlsTooltipLabelPlay:"Play"),this.teardownControls(),void 0!==this.videoElement&&(this.video=[this.container,this.videoElement]),this.renderVideoToViewModel()}isPropertiesUnmodified(e,t){if(null===e)return null===t;if(null===t)return!1;const i=Object.keys(e);for(const r of i)if("crop"!==r)if("object"==typeof e[r]&&"object"==typeof t[r]){if(!this.isPropertiesUnmodified(e[r],t[r]))return!1}else if(e[r]!==t[r])return!1;return!0}updateViewModel(){var e,t;if(this.shouldPreLoad){const i=null!==(t=null===(e=this.provider)||void 0===e?void 0:e.getProperties(this.graphic))&&void 0!==t?t:{};if(Object.keys(this.properties).length>0&&!this.isPropertiesUnmodified(i,this.properties))return this.properties=i,void this.initializeVideoElement();this.recreateControls(),void 0!==this.videoElement&&(this.video=[this.container,this.videoElement]),this.renderVideoToViewModel()}else{const e={useNewLocalTelemetry:!0,preLoadLocalVideo:!1,preLoadLocalVideoClient:!1};this.createVideoElement(e)}}renderVideoToViewModel(){var e;this.setTransform(),l("resizeMediaOnSlideScaling")&&(this.viewModel.control.style.width=`${this.transform.size.width}px`,this.viewModel.control.style.height=`${this.transform.size.height}px`,this.viewModel.control.style.transform=`rotate(${this.transform.rot}deg)`);const{left:t,right:i,top:r,bottom:s}=null!==(e=this.properties.crop)&&void 0!==e?e:{left:0,right:0,top:0,bottom:0},n=new ea(100*t,100*r,100*i,100*s),{scale:o,offset:a}=hu(this.transform,n);let[h,c]=[void 0,void 0];this.shouldPreLoad&&this.shouldPreLoadVideoClient?void 0!==this.model.fallbackRenderData&&([h,c]=Sp(this.transform,this.video[0],o,a,this.model.fallbackRenderData),Zu(this.viewModel.video)):[h,c]=Sp(this.transform,this.video[0],o,a,this.model.fallbackRenderData);const d=this.graphic.model.geometry;if(void 0!==d)try{this.shapeViewModel.setGeometry(Od(this.registry.getGeometry(d),this.transform,d.adjustValues),this.transform);const e=af(this.shapeViewModel.paths,this.transform,new f(0,0),new f(1,1),!1);void 0!==h&&(h.setAttribute("mask",`url(#${e.id})`),h.appendChild(e))}catch(e){(0,T.H)(0,`Failed to create video crop mask, ${e.message}`)}this.shouldPreLoad&&this.shouldPreLoadVideoClient?(void 0!==c&&this.viewModel.video.append(c),void 0!==h&&this.viewModel.video.append(h),void 0===h&&void 0===c||this.viewModelUpdated.emit()):(Zu(this.viewModel.video),void 0!==c&&void 0!==h&&this.viewModel.video.append(c,h),void 0!==h&&this.viewModel.video.append(h),this.viewModelUpdated.emit())}extractHtmlVideo(){const e=this.videoElement.client;this.htmlVideo=e.getPlayer()}get getCaptionsRenderer(){return this.ensureCaptionsRenderer(),Ip}ensureCaptionsRenderer(){void 0===this.provider&&(0,y._)(0,"Failed to obtain video provider"),void 0===Ip?Ip=new Uf(this.provider.getCaptionsRendererParentName(),this.provider.getCaptionsRendererCoordsElement()):Ip.setScreenCoords(this.provider.getCaptionsRendererCoordsElement())}ensureControl(){var e;if(void 0!==this.controls||void 0===this.htmlVideo)return;const{trimStartSec:t,trimEndSec:i}=this.properties,{size:r,rot:s}=this.transform,{width:n,height:o}=r;this.viewModel.control.style.width="0px",this.viewModel.control.style.height="0px",this.viewModel.control.style.transform=`translate(${n/2}px,${o/2}px)rotate(${s}deg)`;const a={position:{x:-n/2,y:o/2-50},size:{x:n,y:50},trimInfo:{trimStartMs:1e3*t,trimEndMs:1e3*i},zIndex:1e3,cssUrl:null!==(e=this.properties.controlCssUrl)&&void 0!==e?e:"",cssPositionOverride:"relative",stopPropagateMouseDownOnSlider:!0,captionsEnabled:this.videoOOBClosedCaptionsPlaybackInEditorEnabled,captionsRenderer:this.videoOOBClosedCaptionsPlaybackInEditorEnabled?this.getCaptionsRenderer:void 0,nestedTabbingEnabled:!0,screenReaderInfo:Fp.getLocalizedStrings(),tooltipMap:Fp.getTooltipMap()};l("resizeMediaOnSlideScaling")&&(this.viewModel.control.style.width=`${r.width}px`,this.viewModel.control.style.height=`${r.height}px`,this.viewModel.control.style.transform=`rotate(${s}deg)`,a.cssPositionOverride=void 0),this.controls=new np(this.htmlVideo,a),this.controls.setParent(this.viewModel.control),this.htmlVideo.addEventListener("play",this.showControls)}teardownControls(){var e,t;null===(e=this.htmlVideo)||void 0===e||e.removeEventListener("play",this.showControls),Zu(this.viewModel.control),null===(t=this.controls)||void 0===t||t.dispose(),this.controls=void 0}setTransform(){let e=this.context.anchorPresenter.transform;const t=this.context.viewScale;t.viewTransform.size.equals(new v(0,0))||(e=t.viewTransform.clone(),e.size.width*=t.zoomFactor,e.size.height*=t.zoomFactor),this.transform=e}fixHtmlVideo(){void 0!==this.htmlVideo&&(this.htmlVideo.style.pointerEvents="none",this.htmlVideo.controls=!1)}}function kp(e,t,i,r){var s,n,o,a,l,h;(function(e){e.register(Dn,Id)})(s=e.anchorPresenterCreatorRegistry),function(e){e.register(sl,Xu)}(s),e.presenterCreatorRegistry.register(No,(h=Ku,(e,t,i)=>{const r=e.model;return new $u(e,t,h(r,t.anchorPresenter),i)})).register(il,((e,t)=>new yd(e,t))).register(Pl,function(e,t){return function(e,t,i){return(r,s,n)=>new Fp(r,s,e,t,n,i)}(ol.$,t,function(e){var t;if(e.getGraphicType()===Fn.O.Video)return null===(t=e.getVideoData())||void 0===t?void 0:t.getVideoProvider()}(e))}(t,r)).register(va,(l=ol.$,(e,t)=>new bu(e,t,l,(()=>new lu)))).register(Bn,(n=new Rd,o=e.presenterCreatorRegistry,a=e.anchorPresenterCreatorRegistry,(e,t,i)=>new Ed(e,o,a,n,t,i))),function(e,t){(function(e,t){e.register(Qc,((e,i)=>new wu(e,i,t)))})(e,(()=>new xu(document.createElement("img")))),void 0!==t&&void 0!==t.shapeBuilderConfig.glyphStore&&function(e,t,i){e.register(nd,((e,r)=>new Du(e,t,r,i)))}(e,t.shapeBuilderConfig.glyphStore,t),function(e,t){e.register(rd,((e,i)=>new wd(e,i,t)))}(e,{getLayout:async()=>Promise.reject(void 0)})}(e.renderDataPresenterCreatorRegistry,i)}class Dp{constructor(e,t){this.container=e,this.canvas2D=t}beginRender(){Zu(this.container)}endRender(){}hitTest(e){}addViewModel(e){if(function(e){return e.type===vd}(e)){if(void 0===e.element||null===e.element)return;e.element.setAttribute("x",`${e.position.x}`),e.element.setAttribute("y",`${e.position.y}`),this.container.appendChild(e.element),void 0!==this.canvas2D&&(this.canvas2D.style.display="none")}}beginGroup(e){}endGroup(){}}class Lp extends sf{constructor(e=Ju("svg")){super(e)}set width(e){this.set("width",`${e}`)}set height(e){this.set("height",`${e}`)}set x(e){this.set("x",`${e}`)}set y(e){this.set("y",`${e}`)}set viewBox(e){this.set("viewBox",e)}set preserveAspectRatio(e){this.set("preserveAspectRatio",e)}}function Op(e,t,i){var r,s,n;const o=e.transform,a=new xp;a.width=o.size.width,a.height=o.size.height;const l=null!==(r=e.imageData)&&void 0!==r?r:"",h=e.transform.size.clone().scale(e.scaleVector.x,e.scaleVector.y),c=document.createElement("img");return c.src=l,c.width=null!==(s=null==i?void 0:i.width)&&void 0!==s?s:h.width,c.height=null!==(n=null==i?void 0:i.height)&&void 0!==n?n:h.height,c.style.pointerEvents="none",a.width=o.size.width,a.height=o.size.height,a.element.appendChild(c),t.setViewModel(c,e),a}function Up(e,t,i){var r,s;const n=e.transform.size.clone().scale(e.scaleVector.x,e.scaleVector.y),o=new Tp;let a=e.cachedImageData,l=e.imageData;if(i){const{data:t}=e.fallbackRenderData;l=t,a=t}if(o.width=n.width,o.height=n.height,o.x=-e.topLeftOffset.x,o.y=-e.topLeftOffset.y,o.preserveAspectRatio="none",i||(o.opacity=(null!==(r=e.opacity)&&void 0!==r?r:100)/100),o.href=null!==(s=null!=a?a:l)&&void 0!==s?s:"",void 0!==a&&a!==l){const i=new Tp;t.appendChild(i.element);const r=null!=l?l:"";i.element.setAttribute("visibility","hidden"),i.element.addEventListener("load",(()=>{o.href=r,e.cachedImageData=r,i.element.remove()}),{once:!0}),i.href=r}return o}function Vp(e,t,i){var r,s;const n=rn(e.mimeType)?Op(e,t):Up(e,i,!1),o=e.geometryVM,a=e.transform,{size:l,flip:h,rot:c}=a,{width:d,height:u}=l;n.transform.set({x:-d/2,y:-u/2},h,c+(null!==(r=e.rotation)&&void 0!==r?r:0),{x:0,y:0});const f=new Cp;f.element.appendChild(n.element);const p=lf(o.paths);void 0!==p&&f.element.appendChild(p);const m=af(o.paths,a,e.topLeftOffset,e.scaleVector,e.inCropMode,e.rotation);f.set("mask",`url(#${m.id})`),f.element.appendChild(m),t.setViewModel(n.element,e),function(e,t,i){if(void 0!==i.geometryVM.pictureEffects){const r=function(e,t){if(void 0===e&&void 0===t)return;const i=Vd("filter");if(i.id=`gc2-filter-${performance.now()}${Math.random()}`,i.setAttribute("color-interpolation-filters","sRGB"),void 0!==e){if(void 0!==e.brightness){let t,r;e.brightness>=1?(t=0,r=1):(t=e.brightness>0?1/(1-e.brightness):Math.max(0,e.brightness+1),r=0);const s=Vd("feComponentTransfer"),n=hf("feFuncR","linear",t,r),o=hf("feFuncG","linear",t,r),a=hf("feFuncB","linear",t,r);s.appendChild(n),s.appendChild(o),s.appendChild(a),i.appendChild(s)}if(void 0!==e.contrast){const t=Vd("feColorMatrix");t.setAttribute("type","matrix");const r=function(e){const t=Bo(e,-1,1);return t<=0?t+1:1/(1-Math.min(.99999,t))}(e.contrast),s=r,n=-.5*r+.5;t.setAttribute("values",`${s} 0 0 0 ${n} 0 ${s} 0 0 ${n} 0 0 ${s} 0 ${n} 0 0 0 1 0`),i.appendChild(t)}}if(void 0!==t){const e=Vd("feColorMatrix");e.setAttribute("type","saturate"),e.setAttribute("values",`${t.saturationFactor}`),i.appendChild(e)}return i}(i.geometryVM.pictureEffects.brightnessContrast,i.geometryVM.pictureEffects.hueSaturationLuminance);void 0!==r&&(e.element.appendChild(r),t.set("filter",`url(#${r.id})`))}}(f,n,e);const g=new Cp(o.group.cloneNode());let v=null===(s=e.model.line)||void 0===s?void 0:s.weight;void 0!==v&&(v*=2,g.element.setAttribute("stroke-width",`${v}pt`)),g.element.removeAttribute("transform"),g.element.append(...function(e){const t=[];return e.forEach((([e])=>{const i=e.cloneNode();i.setAttribute("fill","none"),t.push(i)})),t}(o.paths));const _=new Cp;_.set("id",`gc2-picture-${performance.now()}${Math.random()}`),_.appendChild(g),_.appendChild(f);const y=function(e,t){var i,r;if(void 0!==t.geometryVM.effects&&void 0!==(null===(i=t.geometryVM.effects)||void 0===i?void 0:i.shadow)){const i=void 0!==t.model?null===(r=t.model)||void 0===r?void 0:r.hostContext.themeInfo:void 0;return function(e,t,i,r){const s=new Cp,n=La(void 0!==e.color?tc(e.color,r):Ua),o=void 0!==(null==e?void 0:e.distance)?e.distance:0;let a=o,l=0;void 0!==(null==e?void 0:e.angle)&&(a=Math.cos(e.angle*(Math.PI/180))*o,l=Math.sin(e.angle*(Math.PI/180))*o),a=eu(a),l=eu(l);const h=eu(e.radius)/3*1.270253,c=Vd("use");c.setAttribute("href",`#${t}`),c.setAttribute("transform",`translate(${a},${l})`),c.setAttribute("visibility","visible");const d=ph(i),u=3*h,f=a-d.width()/2-u,p=l-d.height()/2-u,m=d.width()+2*u,g=d.height()+2*u,v=Vd("filter");v.id=`gc2-shadow-filter-${performance.now()}${Math.random()}`,v.setAttribute("x",`${f}`),v.setAttribute("y",`${p}`),v.setAttribute("filterUnits","userSpaceOnUse"),v.setAttribute("width",`${m}`),v.setAttribute("height",`${g}`);const _=Vd("feGaussianBlur");_.setAttribute("in","SourceAlpha"),_.setAttribute("stdDeviation",`${h}`),_.setAttribute("result","offsetblur");const y=Vd("feFlood");y.setAttribute("flood-color",`${n}`);const b=Vd("feComposite");return b.setAttribute("operator","in"),b.setAttribute("in2","offsetblur"),v.appendChild(_),v.appendChild(y),v.appendChild(b),s.element.appendChild(c),s.element.appendChild(v),s.set("filter",`url(#${v.id})`),s.set("pointer-events","none"),s}(t.geometryVM.effects.shadow,e,t.transform,i)}}(_.id,e),b=new Cp;b.set("id",`gc2-picturewithshadow-${performance.now()}${Math.random()}`),void 0!==y&&b.appendChild(y),b.appendChild(_);const w=function(e,t){var i;if(void 0!==e.geometryVM.effects&&void 0!==(null===(i=e.geometryVM.effects)||void 0===i?void 0:i.reflection))return function(e,t,i){const r=new Cp,s=eu(e.distance),n=100-e.startAlpha,o=function(e,t){const i=Vd("linearGradient");i.id=`gc2-linearGrad-${performance.now()}${Math.random()}`,i.setAttribute("gradientTransform","rotate(90)");const r=Vd("stop");r.setAttribute("offset",100-100*t+"%"),r.setAttribute("stop-color","black");const s=Vd("stop");s.setAttribute("offset",100-100*e+"%"),s.setAttribute("stop-color","white"),i.appendChild(r),i.appendChild(s);const n=new of;n.width="1",n.height="1",n.fill=`url(#${i.id})`;const o=Vd("mask");return o.id=`gc2-mask-${performance.now()}${Math.random()}`,o.setAttribute("maskContentUnits","objectBoundingBox"),o.append(i),o.append(n.element),o}(e.startPosition,e.endPosition),{rot:a,size:l}=i,{width:h,height:c}=l,d=(a+360)%360<=180?h:-h,u=(a+360)%360<=90||(a+360)%360>=270?c:-c,f=`rotate(${a}) translate(${d/2},${u/2})\n  scale(1,-1) rotate(${2*a})\n  translate(${-d/2},${-u/2})rotate(${-a})\n  translate(0,${-s})`;r.element.setAttribute("transform",f);const p=Vd("use");p.setAttribute("href",`#${t}`);const m=new Cp;m.element.appendChild(p),m.element.appendChild(o),m.set("mask",`url(#${o.id})`);const g=1.1429*eu(e.radius)/3,v=Vd("feGaussianBlur");v.setAttribute("stdDeviation",`${g}`);const _=Vd("feComponentTransfer"),y=Vd("feFuncA");y.setAttribute("type","linear"),y.setAttribute("slope",""+n/100),_.appendChild(y);const b=ph(i),w=3*g,T=-b.width()/2-w,x=-b.height()/2-w,C=b.width()+2*w,P=b.height()+2*w,S=Vd("filter");return S.id=`gc2-reflection-filter-${performance.now()}${Math.random()}`,S.setAttribute("filterUnits","userSpaceOnUse"),S.setAttribute("x",`${T}`),S.setAttribute("y",`${x}`),S.setAttribute("width",`${C}`),S.setAttribute("height",`${P}`),S.appendChild(v),S.appendChild(_),r.element.appendChild(m.element),r.element.appendChild(S),r.set("filter",`url(#${S.id})`),r.set("pointer-events","none"),r}(e.geometryVM.effects.reflection,t,e.transform)}(e,_.id),T=new Cp;return void 0!==w&&T.appendChild(w),T.appendChild(b),T}function Np(e,t){var i,r;const s=!0===(null===(i=e.getPlaceHolder())||void 0===i?void 0:i.overlay)||!0===(null===(r=e.getPlaceHolder())||void 0===r?void 0:r.renderAsSvg),n=e.transform,o=new Cp,{x:a,y:l}=n.getCenter();let h;o.transform.setTranslate(a,l),o.set("pointer-events","painted");const c=e.fallbackRenderData;if(h=void 0===c?Vp(e,t.hitTestMap,t.svgRoot):function(e,t,i,r){const{targetBounds:s}=i,n=rn(e.mimeType)?Op(e,t,new v(s.width(),s.height())):Up(e,r,!0);wp(n.element,i,e.transform),n.style.pointerEvents="none";const o=new Cp;return o.element.appendChild(n.element),o}(e,t.hitTestMap,c,t.svgRoot),t.hitTestMap.setViewModel(h.element,e),o.appendChild(h),s){const i=function(e,t,i,r){var s,n,o;const a=e.imageData;if(void 0===a)return;const{size:l,flip:h,rot:c}=t,{width:d,height:u}=l,p=new Lp,m=new Cp;m.appendChild(p),m.transform.set({x:-d/2,y:-u/2},h,c,{x:0,y:0}),i&&(p.x=0,p.y=0,p.height=u,p.width=d);let g=!1;try{const t=new URL(a);if("image/svg+xml"===nn(t)&&"data:"===t.protocol.toLowerCase()){const t=function(e){const t=(new DOMParser).parseFromString(e,"image/svg+xml");if(0!==t.querySelectorAll("parsererror").length)throw Error("The XML could not be read");return t.firstElementChild}(atob(a.substring("data:image/svg+xml;base64,".length).trim()));p.element.appendChild(t);for(const i of t.children){if(i instanceof SVGGElement)for(const t of i.children)null==r||r.setViewModel(t,e);null==r||r.setViewModel(i,e)}g=!0}}catch(e){(0,T.KE)(0,`SVG Placeholder parsing failed. Exception: ${e.message}`)}if(!g){const t=new Tp;t.href=a,t.preserveAspectRatio="none",p.element.appendChild(t.element),null==r||r.setViewModel(t.element,e)}const v=new Cp;if(v.appendChild(m),null===(s=e.placeholder)||void 0===s?void 0:s.cropToGeometry){let i;e.geometryVM instanceof lu?i=e.geometryVM:(i=new lu,i.setGeometry(e.geometry,t));const r=lf(i.paths);void 0!==r&&v.element.appendChild(r);const s=af(i.paths,t,null!==(n=e.topLeftOffset)&&void 0!==n?n:new f(0,0),null!==(o=e.scaleVector)&&void 0!==o?o:new f(1,1),!1);v.set("mask",`url(#${s.id})`),v.element.appendChild(s)}return v}(e.placeholderVM,e.transform,!0,t.hitTestMap);void 0!==i&&(t.hitTestMap.setViewModel(i.element,e),o.appendChild(i))}t.svgRoot.appendChild(o.element)}class Gp{constructor(e){this.renderScope=0,this.inBeginRender=!1,this.inEndRender=!1,this.renderTargetRegistry=e}beginRender(){if(!this.inBeginRender)try{this.inBeginRender=!0,0===this.renderScope&&this.renderTargetRegistry.beginRender(),this.renderScope+=1}finally{this.inBeginRender=!1}}endRender(){if(!this.inEndRender)try{this.inEndRender=!0,this.renderScope-=1,0===this.renderScope&&this.renderTargetRegistry.endRender()}finally{this.inEndRender=!1}}hitTest(e){}addViewModel(e,t){Sd(e)&&e.children.forEach((e=>{this.renderTargetRegistry.addViewModel(e,t)}))}beginGroup(e){}endGroup(){}}function zp(e){e.register(Cd,new Gp(e))}class Hp{constructor(e){this.hitTestMap=new Eo,this.renderers=new On.B([]),this.renderScope=0,this.root=e}registerRenderer(e,t){return this.renderers.register(e,t),this}beginRender(){0===this.renderScope&&(Zu(this.root),this.hitTestMap.clear()),this.renderScope+=1}addViewModel(e){const t=this.renderers.get(e.type);void 0===t&&(0,y._)(0,`Unregistered VM type: ${e.type}`),t(e,this)}endRender(){this.renderScope-=1}hitTest(e){if(void 0!==e.target&&null!==e.target)return this.hitTestMap.getViewModel(e.target)}beginGroup(){}endGroup(){}}class Wp{constructor(){this.renderers=new On.B([])}register(e,t){return this.renderers.register(e,t),this}renderViewModel(e,t){const i=this.renderers.get(e.type);void 0===i&&(0,y._)(0,`Unknown VM type: ${e.type}`),i(e,t)}hitTest(e,t){if(void 0!==e.target&&null!==e.target)return t.hitTestMap.getViewModel(e.target)}}function $p(e,t){for(const i of Object.keys(e)){const r=i,s=e[r];void 0!==s&&t(r,s)}}class qp extends class{constructor(e,t){this.eventSinks=[],this.inputElement=e,this.options=t}on(e){this.findIndex(e)>-1||(this.eventSinks.push(e),$p(e,((e,t)=>{(Array.isArray(this.inputElement)?this.inputElement:[this.inputElement]).forEach((i=>{i.addEventListener(e,t,this.options)}))})))}off(e){const t=this.findIndex(e);-1!==t&&($p(e,((e,t)=>{(Array.isArray(this.inputElement)?this.inputElement:[this.inputElement]).forEach((i=>{i.removeEventListener(e,t,this.options)}))})),this.eventSinks.splice(t,1))}findIndex(e){return this.eventSinks.findIndex((t=>t===e))}}{}class jp{constructor(e){this.pointerdown=e=>{this.pointerEventNotifierMap.pointerdown.valid&&this.pointerEventNotifierMap.pointerdown.value.emit(e,{isHandled:!1})},this.pointermove=e=>{this.pointerEventNotifierMap.pointermove.valid&&this.pointerEventNotifierMap.pointermove.value.emit(e,{isHandled:!1})},this.pointerup=e=>{this.pointerEventNotifierMap.pointerup.valid&&this.pointerEventNotifierMap.pointerup.value.emit(e,{isHandled:!1})},this.pointercancel=e=>{this.pointerEventNotifierMap.pointercancel.valid&&this.pointerEventNotifierMap.pointercancel.value.emit(e,{isHandled:!1})},this.pointerEventNotifierMap=e}}class Xp{constructor(e,t,i){this.hitTestMap=new Eo,this.pointerEventNotifiers=d(),this.renderScope=0,this.svgRoot=e,this.svgRenderer=t,void 0!==i&&(this.pointerEventHandler=new qp(this.svgRoot),this.pointerEventHandler.on(new jp(this.pointerEventNotifiers)),new Ro({hitTest:e=>this.hitTest(e)},i).addEventListeners(this.pointerEventNotifiers))}beginRender(){0===this.renderScope&&(Zu(this.svgRoot),this.svgDefsElement=void 0,this.hitTestMap.clear()),this.renderScope+=1}addViewModel(e){this.svgRenderer.renderViewModel(e,this)}endRender(){this.renderScope-=1}hitTest(e){return this.svgRenderer.hitTest(e,this)}beginGroup(e){}endGroup(){}ensureSvgDefsElement(){return void 0===this.svgDefsElement&&(this.svgDefsElement=Vd("defs"),this.svgRoot.appendChild(this.svgDefsElement)),this.svgDefsElement}}class Yp{}function Kp(e,t){for(const i of e.hitTestElements)i.style.pointerEvents="painted",t.hitTestMap.setViewModel(i,e);t.svgRoot.append(...e.elements)}class Zp{renderViewModel(e,t){const i=new x("ImageCanvas2DRenderer.renderViewModel");try{!function(e){e.type!==Tu&&(0,y._)(0,`Invalid viewModel type ${e.type}`)}(e);const r=To(e.sourceAnchorBounds,e.bounds,e.transform,e.scaleFactor,i);xo(e.canvasImageSource,t.canvasElement,r)}finally{i.complete()}}hitTest(e,t){}}function Jp(e,t){const i=new Zp,r=new wo(e,i);t.register(Tu,r)}function Qp(e,t,i,r,s,n,o,a){e===Fn.O.Chart?function(e,t){if(void 0===t.viewDiv)throw new Error("No viewDiv");const i=document.createElement("canvas");t.viewDiv.appendChild(i),Jp(i,e);const r=document.createElement("div");r.id="ChartPlayerViewDiv",t.viewDiv.appendChild(r);const s=new Dp(r,i);e.register(vd,s),zp(e)}(t,i):e===Fn.O.Video?function(e,t){if(void 0===t.viewDiv||null===t.viewDiv.parentElement)throw new Error("No viewDiv");t.viewDiv.parentElement.style.zIndex="2";const i=document.createElement("div");i.style.overflow="visible",i.style.pointerEvents="none",t.viewDiv.appendChild(i);const r=new Hp(i);r.registerRenderer(Mp,Bp),e.register(Mp,r),zp(e)}(t,i):e===Fn.O.Picture?function(e,t){if(void 0===t.viewDiv||null===t.viewDiv.parentElement)throw new Error("No viewDiv");const i=Vd("svg");i.style.overflow="visible",i.style.pointerEvents="none",t.viewDiv.appendChild(i);const r=new Wp,s=new Xp(i,r);r.register(_u,Np).register(Yp,Kp),e.register(_u,s).register(Yp,s),zp(e)}(t,i):function(e,t,i,r,s,n,o){if(void 0===t.viewDiv)throw new Error("No viewDiv");const a=document.createElement("canvas");a.height=0,a.width=0,t.viewDiv.appendChild(a),Jp(a,e),void 0!==i&&(s?function(e,t,i,r,s,n,o){if(void 0===r.viewDiv)throw new Error("No viewDiv");if(void 0===r.editDiv)throw new Error("No editDiv");const a=d();a.pointerdown.value.on(n);const l=new Do(i,r.viewDiv,r.editDiv,e,s,a,o);t.register(It,l)}(a,e,i,t,r,n,o):function(e,t,i){const r=new ko(t),s=new wo(e,r);i.register(It,s)}(a,i,e)),zp(e)}(t,i,r,s,n,o,a)}function em(){}class tm{constructor(e,t,i,r,s,n,o){this.dragStartPos=new Map,this.doNotUseGetOffsetFromPointerEventForDeltaCalculation=l("DoNotUseGetOffsetFromPointerEventForDeltaCalculation"),this.onPointerDown=e=>{var t,i;im(e,null===(t=this.options)||void 0===t?void 0:t.preventDefault,null===(i=this.options)||void 0===i?void 0:i.stopPropagation),this.dragStartPos.set(e.pointerId,this.doNotUseGetOffsetFromPointerEventForDeltaCalculation?Uu().getRelativePosition(new f(e.clientX,e.clientY)):Vu(e)),Lu(e.currentTarget,e),Mo(e,this.cursor.drag),this.dragStart(e)},this.onPointerMove=e=>{var t,i;im(e,null===(t=this.options)||void 0===t?void 0:t.preventDefault,null===(i=this.options)||void 0===i?void 0:i.stopPropagation);const r=this.dragStartPos.get(e.pointerId);if(void 0===r)return Mo(e,this.cursor.hover),void this.hover(e);Mo(e,this.cursor.drag),this.dragMove(...rm(e,r,this.doNotUseGetOffsetFromPointerEventForDeltaCalculation))},this.onPointerUp=e=>{var t,i;im(e,null===(t=this.options)||void 0===t?void 0:t.preventDefault,null===(i=this.options)||void 0===i?void 0:i.stopPropagation),Mo(e,this.cursor.hover);const r=this.dragStartPos.get(e.pointerId);void 0!==r&&(this.dragEnd(...rm(e,r,this.doNotUseGetOffsetFromPointerEventForDeltaCalculation)),this.dragStartPos.delete(e.pointerId))},this.onPointerCancel=e=>{var t,i;im(e,null===(t=this.options)||void 0===t?void 0:t.preventDefault,null===(i=this.options)||void 0===i?void 0:i.stopPropagation),0!==this.dragStartPos.size&&(this.dragCancel(e),this.dragStartPos.delete(e.pointerId))},this.cursor=e,this.hover=t,this.dragStart=i,this.dragMove=r,this.dragEnd=s,this.dragCancel=n,this.options=o}attach(e){e.pointerdown.value.on(this.onPointerDown),e.pointermove.value.on(this.onPointerMove),e.pointerup.value.on(this.onPointerUp),e.pointercancel.value.on(this.onPointerCancel)}detach(e){e.pointerdown.value.off(this.onPointerDown),e.pointermove.value.off(this.onPointerMove),e.pointerup.value.off(this.onPointerUp),e.pointercancel.value.off(this.onPointerCancel)}}function im(e,t,i){t&&e.preventDefault(),i&&e.stopPropagation()}function rm(e,t,i){const r=Vu(e),s=Uu().getRelativePosition(new f(e.clientX,e.clientY));return[i?new f(s.x-t.x,s.y-t.y):new f(r.x-t.x,r.y-t.y),e,Vu(e)]}class sm{}class nm{constructor(e,t,i={},r){this.type=sm,this.move={allowed:!0,started:!1,previewed:!1,dragging:!1},this.cleanups=[],this.onDragStart=e=>{var t,i;this.move.dragging=!0;const r=!0!==(null===(t=this.graphic.anchor.locks)||void 0===t?void 0:t.select);this.move.allowed=r&&!0!==(null===(i=this.graphic.anchor.locks)||void 0===i?void 0:i.move)&&0===e.button,r&&!this.options.noSelectOnPointerDown&&(e.ctrlKey||e.shiftKey?this.editContext.actionInvoker.invoke(new Zl(this.graphic)):this.editContext.actionInvoker.invoke(new th([this.graphic]))),void 0!==this.options.onPointerDown&&this.options.onPointerDown(e,this.context),this.move.started=!1,this.move.previewed=!1},this.onDragMove=e=>{var t;if(this.move.dragging&&this.move.allowed){if(!this.move.started){const i=null!==(t=this.options.dragSlop)&&void 0!==t?t:.5;(Math.abs(e.x)>i||Math.abs(e.y)>i)&&(this.move.started=!0,void 0!==this.editContext.previewInfo&&(this.editContext.previewInfo.dragEditor.beginEdit(this.editContext.previewInfo,this),this.move.previewed=!0,void 0!==this.previews&&this.editContext.previewInfo.presenter.addPreviewPresenter(...this.previews)))}this.move.previewed&&void 0!==this.editContext.previewInfo&&this.editContext.previewInfo.dragEditor.applyTransform(new mh(e.x,e.y))}},this.onDragEnd=(e,t)=>{if(!this.move.dragging)return;if(this.move.dragging=!1,this.cleanup(),!this.move.started)return void(void 0!==this.options.onPointerUpMoveNotStarted&&this.options.onPointerUpMoveNotStarted(t,this.context));let i=new mh(e.x,e.y);this.move.previewed&&void 0!==this.editContext.previewInfo&&(i=this.editContext.previewInfo.dragEditor.applyTransform(i),this.editContext.previewInfo.dragEditor.endEdit(this.editContext.previewInfo,this)),this.editContext.actionInvoker.invoke(new na(i))},this.onDragCancel=()=>{this.move.dragging&&(this.move.dragging=!1,this.cleanup(),this.move.started&&this.move.previewed&&void 0!==this.editContext.previewInfo&&this.editContext.previewInfo.dragEditor.endEdit(this.editContext.previewInfo))},this.context=e,this.graphic=e.graphic,this.editContext=e.editContext,this.tracker=void 0===r?new tm(t,em,this.onDragStart,this.onDragMove,this.onDragEnd,this.onDragCancel):new tm(t,em,r.dragStart,r.dragMove,r.dragEnd,r.dragCancel),this.options=i}addEventListeners(e){this.tracker.attach(e.pointerEventNotifiers)}removeEventListeners(e){this.cleanups.push((()=>{this.tracker.detach(e.pointerEventNotifiers)})),this.move.dragging||this.cleanup()}setCursor(e){this.tracker.cursor=e}cleanup(){this.cleanups.forEach((e=>{e()})),this.cleanups=[]}}class om{constructor(e,t,i,r){this.elements=new Map,this.updateElements=()=>{const e=this.elements;this.elements=new Map;for(const t of this.selection.graphic.model){if(this.selection.hasGraphic(t))continue;const[i,r]=this.presenter.getPresenters(t),s=e.get(t);if(void 0!==s&&s.presenter===i){e.delete(t),this.elements.set(t,s),s.update();continue}const[n,o]=this.createEditElement({graphic:t,presenter:i,anchorPresenter:r,editContext:this.editContext});this.elements.set(t,new am(n,o,i))}for(const[t,i]of e)i.teardown()},this.selection=e,this.presenter=t,this.editContext=i,this.createEditElement=r,this.updateElements(),this.presenter.viewModelUpdated.on(this.updateElements),this.selection.selectionUpdated.on(this.updateElements)}teardown(){this.selection.selectionUpdated.off(this.updateElements),this.presenter.viewModelUpdated.off(this.updateElements);for(const[e,t]of this.elements)t.teardown()}}class am{constructor(e,t,i){this.update=()=>{this.viewModel!==this.presenter.viewModel&&(this.element.removeEventListeners(this.viewModel),this.viewModel=this.presenter.viewModel,this.element.addEventListeners(this.viewModel))},this.element=e,this.presenter=i,this.viewModel=i.viewModel,this.elementTeardown=t,this.element.addEventListeners(this.viewModel),this.presenter.viewModelUpdated.on(this.update)}teardown(){this.presenter.viewModelUpdated.off(this.update),this.element.removeEventListeners(this.viewModel),this.elementTeardown()}}class lm{constructor(e,t,i,r){this.viewModel=new Pd([],{nodeType:"grCollSelR"}),this.viewModelUpdated=new c,this.underlayPresenters=[],this.childPresenters=new Map,this.updateViewModel=()=>{const e=this.childPresenters;this.childPresenters=new Map;const t=[];for(const i of this.selection.selections){if(this.selection.graphic.model.getGraphic(i.graphic.id)!==i.graphic)continue;const r=e.get(i),[s]=this.modelPresenter.getPresenters(i.graphic);if(void 0!==r&&r.modelPresenter===s){e.delete(i),this.childPresenters.set(i,r),r.update(),t.push(r.container);continue}const n=this.createChildSelectionPresenter(i);this.childPresenters.set(i,n),t.push(n.container)}for(const[t,i]of e)i.teardown();this.viewModel.children=[...this.underlayPresenters.map((e=>e.viewModel)),...t],this.viewModelUpdated.emit()},this.selection=e,this.modelPresenter=t.modelPresenter,this.selectionPresenterCreator=t.selectionPresenterCreator,this.context=t,this.editContext=i,this.editElements=new om(e,this.modelPresenter,i,r),this.updateViewModel(),this.selection.selectionUpdated.on(this.updateViewModel),this.modelPresenter.viewModelUpdated.on(this.updateViewModel)}teardown(){this.editElements.teardown(),this.selection.selectionUpdated.off(this.updateViewModel),this.modelPresenter.viewModelUpdated.off(this.updateViewModel);for(const[e,t]of this.childPresenters)t.teardown();this.childPresenters.clear();for(const e of this.underlayPresenters)e.viewModelUpdated.off(this.updateViewModel),e.teardown()}addUnderlayPresenter(e){this.underlayPresenters.push(e),e.viewModelUpdated.on(this.updateViewModel),this.updateViewModel()}createChildSelectionPresenter(e){const[t,i]=this.modelPresenter.getPresenters(e.graphic),r=Object.assign(Object.assign({},this.context),{anchorPresenter:i,modelPresenter:t}),s=this.selectionPresenterCreator.createSelectionPresenter(e,r,this.editContext);return new hm(t,s,this)}}class hm{constructor(e,t,i){this.onViewModelUpdated=()=>{this.update(),this.parent.viewModelUpdated.emit()},this.modelPresenter=e,this.presenter=t,this.container=new Pd([t.viewModel]),this.parent=i,this.presenter.viewModelUpdated.on(this.onViewModelUpdated)}update(){this.container.children=[this.presenter.viewModel]}teardown(){this.presenter.viewModelUpdated.off(this.onViewModelUpdated),this.presenter.teardown()}}function cm(e){return[new nm(e,{hover:"move",drag:"move"}),em]}function dm(e=cm){return(t,i,r)=>new lm(t,i,r,e)}function um(e){return e/255}function fm(e){return _e.FromRGBA({r:um(e.r),g:um(e.g),b:um(e.b),a:e.a})}function pm(e,t,i){return new bt([V.CreateFromRect(new R(0,0,t,e))],new Me(i))}function mm(e,t,i){return new bt([V.CreateFromRect(new R(0,0,e,t))],new Me(i))}const gm=new we(fm(new ka(255,255,255,1))),vm=new we(fm(new ka(128,128,128,1))),_m=100,ym=new h((()=>pm(2,_m,vm))),bm=new h((()=>mm(2,_m,vm))),wm=new h((()=>pm(2,_m,gm))),Tm=new h((()=>mm(2,_m,gm)));function xm(e,t,i,r,s,n,o,a){return[new wt([r],void 0,new M(new P(-50,-e.size.height/2-o),new P((e.size.width+n)/_m,1),t,i)),new wt([r],void 0,new M(new P(-50,e.size.height/2-a),new P((e.size.width+n)/_m,1),t,i)),new wt([s],void 0,new M(new P(-e.size.width/2-o,-50),new P(1,(e.size.height+n)/_m),t,i)),new wt([s],void 0,new M(new P(e.size.width/2-a,-50),new P(1,(e.size.height+n)/_m),t,i))]}function Cm(e){const t=new At;return t.addItem(function(e){const t=function(e){return new P(e.pos.x+e.size.width/2,e.pos.y+e.size.height/2)}(e),i=(0,u.Yr)(e.rot),r=function(e,t,i){return xm(e,t,i,ym.value,bm.value,4,2,0)}(e,i,t),s=function(e,t,i){return xm(e,t,i,wm.value,Tm.value,0,0,2)}(e,i,t);return new wt(r.concat(s))}(e)),t.hitTestSlop=6,t}class Pm{constructor(e,t){this.viewModelUpdated=new c,this.refreshSelectionViewModel=()=>{try{this.viewModel=this.createSelectionViewModel(),this.viewModelUpdated.emit()}catch(e){const t=e;void 0!==t&&(0,T.KE)(0,`Exception: ${t.message}, Stack Trace: ${t.stack}`)}},this.selection=e,this.context=t,this.refreshSelectionViewModel(),this.selection.selectionUpdated.on(this.refreshSelectionViewModel),this.context.modelPresenter.viewModelUpdated.on(this.refreshSelectionViewModel)}teardown(){this.context.modelPresenter.viewModelUpdated.off(this.refreshSelectionViewModel),this.selection.selectionUpdated.off(this.refreshSelectionViewModel)}createSelectionViewModel(){const e=this.context.anchorPresenter.transform,t=this.context.viewScale.viewTransform;let i=1,r=1;0!==t.size.width&&(i=t.size.width/e.size.width),0!==t.size.height&&(r=t.size.height/e.size.height);const s=[],n=this.selection.graphic.model.fallbackRenderData;if(void 0!==this.selection.graphic.model.layout&&void 0!==n&&ad(n))for(const t of this.selection){const o=this.selection.graphic.model.layout.shapes.find((e=>e.modelId===t.modelId));if(void 0!==o){const t=o.shapeProps.transform.clone();t.size.width*=i,t.size.height*=r,t.pos.x=(t.pos.x+e.pos.x-n.sourceAnchorBounds.left)*i,t.pos.y=(t.pos.y+e.pos.y-n.sourceAnchorBounds.top)*r,s.push(t)}}return new Pd(s.map(((e,i)=>{const r=function(e,t){return new Pd([Cm(e)],{nodeType:"selGraphic",nodeKey:t})}(e,`${i}`);return r.children.forEach((e=>{Ft(e)&&(e.emuToSourceScale=0,e.scaleFactor=this.context.viewScale.zoomFactor,e.transform=t,e.sourceAnchorBounds=new p(0,0,t.size.width,t.size.height))})),r})))}}function Sm(e,t){return new Pm(e,t)}class Em{constructor(e,t){this.viewModel=new Pd,this.viewModelUpdated=new c,this.onSelectionUpdated=e=>{0===e?this.modelPresenter.playPause():1===e&&this.modelPresenter.toggleCaptionsMenu()},this.selection=e,this.modelPresenter=t.modelPresenter,this.modelPresenter.isSelected=!0,this.selection.selectionUpdated.on(this.onSelectionUpdated)}teardown(){this.modelPresenter.isSelected=!1,this.selection.selectionUpdated.off(this.onSelectionUpdated)}}class Mm{constructor(e,t){this.viewModel=new Pd,this.viewModelUpdated=new c,this.onCropEvent=()=>{this.selection.cropState.inCropMode?this.cropPresenter.setInCropMode(!0):this.cropPresenter.setInCropMode(!1),this.viewModelUpdated.emit()},this.selection=e,this.context=t,this.cropPresenter=this.context.modelPresenter,this.selection.cropState.cropEventNotifier.on(this.onCropEvent),this.selection.cropState.inCropMode&&this.cropPresenter.setInCropMode(!0)}teardown(){this.selection.cropState.inCropMode&&this.selection.cropState.setInCropMode(2),this.selection.cropState.cropEventNotifier.off(this.onCropEvent)}}function Rm(e){var t;(function(e){e.registerForType(Bn,(t=>new Xl(t,e)))})(t=e.selectionCreatorRegistry),function(e){e.registerForType(No,(e=>new Ho(e,new Lo(new Vo,Uo(e.model.smartArtData.elementList)))))}(t),function(e){e.registerForType(Pl,(e=>new Yc(e)))}(t),function(e){e.registerForType(va,(e=>new ya(e)))}(t),function(e){e.register(jl,dm()).register(zo,Sm).register(Xc,((e,t)=>new Em(e,t))).register(_a,((e,t)=>new Mm(e,t)))}(e.selectionPresenterCreatorRegistry)}function Bm(e){switch(e){case Fn.O.SmartArt:return"SmartArt";case Fn.O.Chart:return"Chart";case Fn.O.Video:return"Video";case Fn.O.Picture:return"Picture";default:return"Unknown"}}const Im="graphicType";class Am{constructor(e,t){if(this.keyboardEventNotifierMap={keyup:new c,keydown:new c},this.pointerEventNotifierMap=d(),this.hostContext=new kn,this.isSelected=!1,this.onSelectionViewModelUpdated=()=>{this.selection.selections.forEach((e=>{if(Wo(e)&&void 0!==this.accessibilityDiv){const t=e.getAriaMessageForSelection(this.ariaStrings);this.accessibilityDiv.innerHTML===t?this.accessibilityDiv.innerText+=" ":this.accessibilityDiv.innerText=t}}))},this.onFrameRendered=e=>{if(void 0!==e&&0!==e.length){io(e,"OnFrameRenderedStartTime");try{this.pptGraphicType!==Fn.O.Picture&&this.kpiLogger.logFrameRendered(e)}catch(e){(0,T.KE)(0,`Exception: ${e.message}`)}}},this.defaultHitTestPointerDownEventHandler=()=>{this.clearChildSelection()},this.invokeActionCallback=e=>{this.host.performAction(e)},this.onSelectionUpdated=()=>{if(!this.isSelected&&this.selection.length>0){const e=this.config.graphicData.getVideoData();null!==e?e.select():(0,T.H)(0,"Unable to select host")}},this.config=e,void 0===this.config.domRenderTarget.viewDiv)throw new Error("No viewDiv to render to");this.graphic=El(e.graphicData,this.hostContext),this.pptGraphicType=e.graphicData.getGraphicType(),this.kpiLogger=new fd(e.brsConfig,t,this.pptGraphicType),void 0!==this.config.domRenderTarget.editDiv&&(this.editDiv=this.config.domRenderTarget.editDiv,this.editDiv.setAttribute("graphicID",this.graphic.id)),void 0!==this.config.domRenderTarget.accessibilityDiv&&null!==this.config.domRenderTarget.accessibilityDiv&&(this.accessibilityDiv=this.config.domRenderTarget.accessibilityDiv,this.accessibilityDiv.style.width="0",this.accessibilityDiv.style.height="0",this.accessibilityDiv.style.overflow="hidden",this.accessibilityDiv.style.zIndex="-1",this.accessibilityDiv.setAttribute("aria-role","marquee"),this.accessibilityDiv.setAttribute("aria-live","assertive"),this.accessibilityDiv.setAttribute("aria-atomic","true"),this.accessibilityDiv.innerHTML+=""),this.ariaStrings=this.config.ariaStrings,this.graphicCollectionModel=new In(this.hostContext),this.graphicCollectionModel.addGraphics([this.graphic]),this.host=this.createHost(this.config,t,this.keyboardEventNotifierMap,this.pointerEventNotifierMap,this.config.brsConfig.isGC2WebGLRenderTargetEnabled,e.brsConfig.separateSelectionSceneFromGraphic);const i=this.host.renderTargetRegistry.get(It);i instanceof Do&&(this.shapeBuilderMultiplexRenderTarget=i),this.host.frameRendered.on(this.onFrameRendered),this.host.start(this.graphicCollectionModel,new Ln),this.host.selectionPresenter.viewModelUpdated.on(this.onSelectionViewModelUpdated),this.selection=this.host.selection,this.commandContext=new $o(this.selection),this.selection.selectionUpdated.on(this.onSelectionUpdated),this.config.brsConfig.pictureBGREnabled&&this.setup().catch(),(0,T.PN)(0,"The Gc2 host is enabled.")}async setup(){try{e=Ms,t=["AugLoop_AcsImageTransform_ACSBackgroundRemovalAnnotation"],i=En,Ss.push({callbackFunc:e,annotations:t,pictureAIOps:i}),await async function(){await Promise.all(Ss.map((e=>e.callbackFunc(e.annotations,e.pictureAIOps)))),Ss=[]}()}catch(e){(0,T.H)(0,`Error occurred while initializing AI capabilities for PPTO Pictures. ${e.message}`)}var e,t,i}dispose(){this.graphicCollectionModel.removeGraphics([this.graphic]),this.selection.selectionUpdated.off(this.onSelectionUpdated),this.host.selectionPresenter.viewModelUpdated.off(this.onSelectionViewModelUpdated),this.host.frameRendered.off(this.onFrameRendered),this.host.teardown(),this.config.brsConfig.pictureBGREnabled&&this.teardown().catch()}async teardown(){try{e=Rs,t=["AugLoop_AcsImageTransform_ACSBackgroundRemovalAnnotation"],i=En,Es.push({callbackFunc:e,annotations:t,pictureAIOps:i}),await async function(){await Promise.all(Es.map((e=>e.callbackFunc(e.annotations,e.pictureAIOps)))),Es=[]}()}catch(e){(0,T.H)(0,`Error occurred while tearing down AI capabilities for PPTO Pictures. ${e.message}`)}var e,t,i}handleShapeNodeGC2ModelSync(){const e=new fo("GC2ModelShapeNodePerf");e.start(),this.graphic.model.modelUpdated.emit(void 0,e)}setRenderData(e,t,i,r){const s=new x("PowerPointGraphicHost.setRenderData");try{const l=new fo("GC2SetRenderDataPerf");l.start(),l.addTimePoint("SetRenderDataStartTime"),i.set(Im,Bm(this.pptGraphicType)),this.pptGraphicType!==Fn.O.Picture&&this.kpiLogger.logSetRenderData(l,i),s.setProp("x",t.pos.x).setProp("y",t.pos.y).setProp("width",t.size.width).setProp("height",t.size.height);const h=hd(e,t);if(this.pptGraphicType===Fn.O.Picture){const e=this.graphic.model,t=h;if(e.data.originalUrl.href!==t.data){const s=(n=`${i.get("imageId")}-${performance.now()}}`,o=new URL(t.data),a=fl.getInstance(),new _o(n,o,!0,a,void 0,{preferDataUrl:!0}));s.downloadCompleted.on(r),e.data=s}e.placeholder=void 0}const c="true"===i.get("isGC2PicRender");this.graphic.model.fallbackRenderData=c?void 0:h,void 0!==this.shapeBuilderMultiplexRenderTarget&&(e.renderDataType!==An.ShapeBuilderJson?(this.shapeBuilderMultiplexRenderTarget.skipPrepareWebGLCanvas=!0,this.shapeBuilderMultiplexRenderTarget.renderTargetMode=0):this.shapeBuilderMultiplexRenderTarget.skipPrepareWebGLCanvas=!1),l.addTimePoint("ModelUpdatedEventEmittedTime"),this.graphic.model.modelUpdated.emit(void 0,l),l.addTimePoint("SetRenderDataEndTime")}finally{s.complete()}var n,o,a}setPosition(e,t){}setZoomFactor(e){const t=new x("PowerPointGraphicHost.setZoomFactor");try{if(t.setProp("zoomFactor",e),!this.host.viewScale.viewTransform.size.equals(new v(0,0))&&this._lastUpdatedDevicePixelRatio!==window.devicePixelRatio&&0!==window.devicePixelRatio&&void 0!==this._lastUpdatedDevicePixelRatio){const e=this._lastUpdatedDevicePixelRatio/window.devicePixelRatio,t=this.host.viewScale.viewTransform.clone();t.size.width*=e,t.size.height*=e,t.pos.x*=e,t.pos.y*=e,this._lastUpdatedDevicePixelRatio=window.devicePixelRatio,this.host.viewScale.viewTransform=t}this.host.viewScale.zoomFactor=e*window.devicePixelRatio}finally{t.complete()}}setTransform(e,t){const i=new x("PowerPointGraphicHost.setTransform");try{const r=new fo("GC2SetTransformPerf");null!==t&&(t.set(Im,Bm(this.pptGraphicType)),void 0!==this.shapeBuilderMultiplexRenderTarget&&t.set("ShapeBuilderRenderTargetMode",0===this.shapeBuilderMultiplexRenderTarget.renderTargetMode?wo.name:Fo.name),r.start(),this.pptGraphicType!==Fn.O.Picture&&this.kpiLogger.logSetTransform(r,t)),i.setProp("x",e.pos.x).setProp("y",e.pos.y).setProp("width",e.size.width).setProp("height",e.size.height);const s=function(e){return new _(new g(e.pos.x,e.pos.y),new v(e.size.width,e.size.height),new m(e.flip.x,e.flip.y),e.rot)}(e);if(0!==window.devicePixelRatio){const e=1/window.devicePixelRatio;s.size.width*=e,s.size.height*=e,s.pos.x*=e,s.pos.y*=e}this.host.viewScale.viewTransform=s,this._lastUpdatedDevicePixelRatio=window.devicePixelRatio}finally{i.complete()}}setSelected(e){this.isSelected=e,e?this.selection.addGraphics([this.graphic]):this.selection.removeGraphics([this.graphic])}clearChildSelection(){this.selection.selections.forEach((e=>{Wo(e)?e.clear():(0,T.H)(0,"Selection is not of type SmartArtSelection")}))}handleCommand(e,t){const i=t,r=tl.createAction(e,i,this.commandContext);if(void 0!==r){const i=this.handleQueryCommand(e,t);if(void 0!==i&&i.enabled)return this.host.performAction(r),new cd(!0)}return new cd(!1)}handleQueryCommand(e,t){const i=tl.query(e,this.commandContext);return{enabled:void 0!==i&&i.enabled}}processKeyboardEvent(e){const t={isHandled:!1};return"keyup"===e.type?this.keyboardEventNotifierMap.keyup.emit(e,t):"keydown"===e.type&&this.keyboardEventNotifierMap.keydown.emit(e,t),new dd(t)}processPointerEvent(e){const t={isHandled:!1};return"pointerdown"===e.type?this.pointerEventNotifierMap.pointerdown.value.emit(e,t):"pointerup"===e.type?this.pointerEventNotifierMap.pointerup.value.emit(e,t):"pointermove"===e.type&&this.pointerEventNotifierMap.pointermove.value.emit(e,t),new dd(t)}createHost(e,t,i,r,s,n){const o=new uo(this.getHostConfig(i));return kp(o,e.graphicData,t,e.brsConfig.videoOOBClosedCaptionsPlaybackInEditorEnabled),Qp(e.graphicData.getGraphicType(),o.renderTargetRegistry,e.domRenderTarget,t,r,s,this.defaultHitTestPointerDownEventHandler,n),Rm(o),function(e){var t;!function(e,t,i,r){const s={dispatcher:new $h,actions:new Yl([[Kl,Ml(Sh)],[Jl,Ml(Mh)],["selectAllGraphics",Ml(Eh)],[eh,Ml(Rh)],["addGraphics",Rl(Bh)],[ih,Rl(Ih)],["replaceGraphic",Rl(Ah)],[sh,Rl(Fh)],["alignAction",Rl(_h)],["distributeAction",Rl(yh)],["replaceGraphicWithModel",Rl(kh)]]),keyboardShortcuts:null!=i?i:new Lh([{key:"Delete",modifiers:Dh.None,performer:Gh},{key:"Backspace",modifiers:Dh.None,performer:Gh},{key:"Escape",modifiers:Dh.None,performer:zh},{key:"Tab",modifiers:Dh.None,performer:Hh},{key:"Tab",modifiers:Dh.Shift,performer:Hh},{key:"ArrowUp",modifiers:Dh.None,performer:Oh(0,-1)},{key:"ArrowDown",modifiers:Dh.None,performer:Oh(0,1)},{key:"ArrowLeft",modifiers:Dh.None,performer:Oh(-1,0)},{key:"ArrowRight",modifiers:Dh.None,performer:Oh(1,0)},{key:"ArrowUp",modifiers:Dh.Shift,performer:Uh(1,1.1)},{key:"ArrowDown",modifiers:Dh.Shift,performer:Uh(1,.9090909090909091)},{key:"ArrowLeft",modifiers:Dh.Shift,performer:Uh(.9090909090909091,1)},{key:"ArrowRight",modifiers:Dh.Shift,performer:Uh(1.1,1)},{key:"ArrowUp",modifiers:Dh.CtrlShift,performer:Uh(1,1.01)},{key:"ArrowDown",modifiers:Dh.CtrlShift,performer:Uh(1,.9900990099009901)},{key:"ArrowLeft",modifiers:Dh.CtrlShift,performer:Uh(.9900990099009901,1)},{key:"ArrowRight",modifiers:Dh.CtrlShift,performer:Uh(1.01,1)},{key:"ArrowLeft",modifiers:Dh.Alt,performer:Vh(-15)},{key:"ArrowRight",modifiers:Dh.Alt,performer:Vh(15)},{key:"ArrowLeft",modifiers:Dh.CtrlAlt,performer:Vh(-1)},{key:"ArrowRight",modifiers:Dh.CtrlAlt,performer:Vh(1)},{key:"[",modifiers:Dh.Ctrl,performer:Wh(2)},{key:"]",modifiers:Dh.Ctrl,performer:Wh(0)},{key:"{",modifiers:Dh.CtrlShift,performer:Wh(3)},{key:"}",modifiers:Dh.CtrlShift,performer:Wh(1)}])};e.register(jl,s)}(e.editorRegistry,0,new Lh([])),function(e){const t={actions:new Yl([[Jl,Ml(Fc)],[Ec,Ml(kc)],[Rc,Ml(Dc)],[Ko,Ml(Lc)],[Va,Ml(Oc)],[Pc,Ml(Uc)],[Ic,Ml(Vc)]]),keyboardShortcuts:new Lh([{key:"Enter",modifiers:Dh.None,performer:Gc},{key:"Escape",modifiers:Dh.None,performer:zc},{key:"Tab",modifiers:Dh.None,performer:Hc},{key:"Tab",modifiers:Dh.Shift,performer:Hc},{key:"a",modifiers:Dh.Ctrl,performer:Nc}])};e.register(zo,t)}(e.editorRegistry),function(e){const t={dispatcher:new Jc,actions:new Yl([[Wc,Kc],[qc,Zc]]),keyboardShortcuts:new Lh([])};e.register(Xc,t)}(e.editorRegistry),(t=function(e){const t={dispatcher:new Cc,actions:xc(),keyboardShortcuts:new Lh([])};return e.register(_a,t),t}(e.editorRegistry).actions).register(wa,Il($l(Hl))),t.register("smartCropAction",Il($l(kl))),t.register("superResolutionAction",Il($l(Wl))),t.register("oneClickEnhancerAction",Il($l(zl))),t.register("AutoFocusAction",Il($l(Ul))),t.register("FilterAction",Il($l(Vl))),t.register("altTextAction",Il($l(Gl)))}(o),o}getHostConfig(e){return{keyboardEventNotifiers:e,actionInvoker:{invoke:this.invokeActionCallback},renderOnlyWhenDirty:l("RenderOnlyWhenDirty")}}}const Fm=new class{constructor(){this._initStatus=i.Uninitialized,At.setDefaultScaleFactor(1/window.devicePixelRatio)}createGraphicHost(e){if(this._initStatus===i.Uninitialized)throw new Error("Factory isn't initialized");return new Am(e,this.sbContext)}async init(t){if(this._initStatus!==i.Succeeded){var s,n,l;if(this._initStatus=i.Started,(0,T.WD)(new Cs(t.logger)),s=new r(t.health),_s=s,(0,bs.C)(new o(t.health)),n=t.augloopSessionManager,e=n,void 0!==t.isFeatureGateEnabled&&(l=t.isFeatureGateEnabled,a=l),(0,T.PN)(0,"PowerPointGraphicFactory - init started"),void 0!==t.shapeBuilderConfig&&null!==t.shapeBuilderConfig){if(this.sbContext=function(e){return new gs(e)}(t.shapeBuilderConfig),void 0===this.sbContext)return(0,T.KE)(0,"PowerPointGraphicFactory - undefined sbContext"),void(this._initStatus=i.Failed);if(await this.sbContext.setupWebGLContext(),(0,T.PN)(0,`PowerPointGraphicFactory - isRendererReady:${this.sbContext.isRendererReady}`),!this.sbContext.isRendererReady)return void(this._initStatus=i.Failed)}this._initStatus=i.Succeeded,(0,T.PN)(0,`PowerPointGraphicFactory - init ended; initStatus:${this._initStatus}`)}}handleContextLost(){if(this._initStatus===i.Uninitialized)throw new Error("Factory isn't initialized");void 0!==this.sbContext?this.sbContext.handleContextLost():(0,T.PN)(0,"undefined sbContext")}async handleContextRestored(){if(this._initStatus===i.Uninitialized)throw new Error("Factory isn't initialized");void 0!==this.sbContext?await this.sbContext.handleContextRestored():(0,T.PN)(0,"undefined sbContext")}getInitStatus(){return this._initStatus}isShapeBuilderRendererReady(){return void 0!==this.sbContext&&this.sbContext.isRendererReady}}})(),Gc2HostPpt=n})();
//# sourceMappingURL=Gc2HostPpt.js.map